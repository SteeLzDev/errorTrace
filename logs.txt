package com.zetra.econsig.service.servidor;

import java.math.BigDecimal;
import java.security.SecureRandom;
import java.sql.Date;
import java.sql.Timestamp;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.interceptor.TransactionAspectSupport;

import com.zetra.econsig.delegate.LogDelegate;
import com.zetra.econsig.dto.CustomTransferObject;
import com.zetra.econsig.dto.TransferObject;
import com.zetra.econsig.dto.assembler.RegistroServidorDtoAssembler;
import com.zetra.econsig.dto.entidade.MargemTO;
import com.zetra.econsig.dto.entidade.OcorrenciaUsuarioTransferObject;
import com.zetra.econsig.dto.entidade.RegistroServidorTO;
import com.zetra.econsig.dto.entidade.ServidorTransferObject;
import com.zetra.econsig.dto.entidade.UsuarioTransferObject;
import com.zetra.econsig.exception.ArquivoControllerException;
import com.zetra.econsig.exception.AutorizacaoControllerException;
import com.zetra.econsig.exception.BeneficioControllerException;
import com.zetra.econsig.exception.ConsignatariaControllerException;
import com.zetra.econsig.exception.ConvenioControllerException;
import com.zetra.econsig.exception.CreateException;
import com.zetra.econsig.exception.DAOException;
import com.zetra.econsig.exception.FindException;
import com.zetra.econsig.exception.HQueryException;
import com.zetra.econsig.exception.LogControllerException;
import com.zetra.econsig.exception.NotificacaoDispositivoControllerException;
import com.zetra.econsig.exception.ParametroControllerException;
import com.zetra.econsig.exception.RemoveException;
import com.zetra.econsig.exception.ServidorControllerException;
import com.zetra.econsig.exception.UpdateException;
import com.zetra.econsig.exception.UsuarioControllerException;
import com.zetra.econsig.exception.ViewHelperException;
import com.zetra.econsig.exception.ZetraException;
import com.zetra.econsig.helper.email.EnviaEmailHelper;
import com.zetra.econsig.helper.log.Log;
import com.zetra.econsig.helper.margem.MargemHelper;
import com.zetra.econsig.helper.parametro.ParamSist;
import com.zetra.econsig.helper.seguranca.AcessoSistema;
import com.zetra.econsig.helper.seguranca.FuncaoExigeMotivo;
import com.zetra.econsig.helper.servidor.GeradorCpfServidor;
import com.zetra.econsig.helper.sistema.ShowFieldHelper;
import com.zetra.econsig.helper.sms.SMSHelper;
import com.zetra.econsig.helper.texto.ApplicationResourcesHelper;
import com.zetra.econsig.helper.texto.DateHelper;
import com.zetra.econsig.helper.texto.LocaleHelper;
import com.zetra.econsig.helper.texto.TextHelper;
import com.zetra.econsig.helper.web.JspHelper;
import com.zetra.econsig.persistence.dao.DAOFactory;
import com.zetra.econsig.persistence.dao.ParamConvenioRegistroServidorDAO;
import com.zetra.econsig.persistence.dao.ServidorDAO;
import com.zetra.econsig.persistence.entity.*;
import com.zetra.econsig.persistence.query.admin.ListaCapacidadeRegistroServidorQuery;
import com.zetra.econsig.persistence.query.admin.ListaCargoRegistroServidorQuery;
import com.zetra.econsig.persistence.query.admin.ListaPadraoRegistroServidorQuery;
import com.zetra.econsig.persistence.query.admin.ListaPostoRegistroServidorQuery;
import com.zetra.econsig.persistence.query.admin.ListaStatusRegistroServidorQuery;
import com.zetra.econsig.persistence.query.admin.ListaTipoRegistroServidorQuery;
import com.zetra.econsig.persistence.query.admin.ListaVencimentoQuery;
import com.zetra.econsig.persistence.query.admin.ListaVinculoRegistroServidorQuery;
import com.zetra.econsig.persistence.query.basecalc.ListaTipoBaseCalculoQuery;
import com.zetra.econsig.persistence.query.consignacao.ObtemConsignacaoPorCnvSerQuery;
import com.zetra.econsig.persistence.query.convenio.ListaConvenioVinculoRegistroQuery;
import com.zetra.econsig.persistence.query.funcao.FuncoesEnvioEmailSerQuery;
import com.zetra.econsig.persistence.query.historico.ListarHistoricoServidorQuery;
import com.zetra.econsig.persistence.query.margem.ListaHistoricoMargemQuery;
import com.zetra.econsig.persistence.query.margem.ListaHistoricoVariacaoMargemBrutaQuery;
import com.zetra.econsig.persistence.query.margem.ListaHistoricoVariacaoMargemQuery;
import com.zetra.econsig.persistence.query.margem.ListaMargemRegistroServidorQuery;
import com.zetra.econsig.persistence.query.margem.ListaMargemRegistroServidoresQuery;
import com.zetra.econsig.persistence.query.orgao.ListaSubOrgaoQuery;
import com.zetra.econsig.persistence.query.orgao.ListaUnidadeQuery;
import com.zetra.econsig.persistence.query.orgao.ListaUnidadeSubOrgaoQuery;
import com.zetra.econsig.persistence.query.pergunta.ListaPerguntaDadosCadastraisQuery;
import com.zetra.econsig.persistence.query.registroservidor.ObtemRegistroServidorOcultoCsaQuery;
import com.zetra.econsig.persistence.query.registroservidor.ObtemTotalRegistroServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ListaBloqueioConvenioServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ListaComposicaoMargemRseQuery;
import com.zetra.econsig.persistence.query.servidor.ListaConsultaSalarioServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ListaDadosServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ListaEstadoCivilQuery;
import com.zetra.econsig.persistence.query.servidor.ListaNivelEscolaridadeQuery;
import com.zetra.econsig.persistence.query.servidor.ListaOcorrenciaRegistroServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ListaOcorrenciaSerUnionRseQuery;
import com.zetra.econsig.persistence.query.servidor.ListaQtdeServidorPorOrgQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistroServidorAuditoriaTotalQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistroServidorPorCpfEmailQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistroServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistroServidorSerCodigoQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistroServidorUsuarioSerQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistrosServidoresByCsaConvenioQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistrosServidoresExcluidosQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistrosServidoresLikeMatriculaQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistrosServidoresQuery;
import com.zetra.econsig.persistence.query.servidor.ListaRegistrosServidoresTransferidosQuery;
import com.zetra.econsig.persistence.query.servidor.ListaSerParaArquivamentoQuery;
import com.zetra.econsig.persistence.query.servidor.ListaServidorPossuiAdeQuery;
import com.zetra.econsig.persistence.query.servidor.ListaServidorRseCodigoQuery;
import com.zetra.econsig.persistence.query.servidor.ListaTipoDadoAdicionalServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ListaTipoHabitacaoQuery;
import com.zetra.econsig.persistence.query.servidor.ObtemDataOcorrenciaServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ObtemServidorProprietarioAdeQuery;
import com.zetra.econsig.persistence.query.servidor.ObtemTotalServidoresPorEmailCelularQuery;
import com.zetra.econsig.persistence.query.transferencia.ObtemTotalConsignacaoSemConvenioTransfQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemTotalUsuariosPorEmailQuery;
import com.zetra.econsig.service.arquivo.ArquivoController;
import com.zetra.econsig.service.beneficios.BeneficiarioController;
import com.zetra.econsig.service.consignacao.CancelarConsignacaoController;
import com.zetra.econsig.service.consignacao.PesquisarConsignacaoController;
import com.zetra.econsig.service.consignacao.TransferirConsignacaoController;
import com.zetra.econsig.service.consignataria.ConsignatariaController;
import com.zetra.econsig.service.convenio.ConvenioController;
import com.zetra.econsig.service.notificacao.NotificacaoDispositivoController;
import com.zetra.econsig.service.parametro.ParametroController;
import com.zetra.econsig.service.pontuacao.PontuacaoServidorController;
import com.zetra.econsig.service.seguranca.SegurancaController;
import com.zetra.econsig.service.sistema.SistemaController;
import com.zetra.econsig.service.usuario.UsuarioController;
import com.zetra.econsig.values.AcaoTipoDadoAdicionalEnum;
import com.zetra.econsig.values.CodedValues;
import com.zetra.econsig.values.Columns;
import com.zetra.econsig.values.FieldKeysConstants;
import com.zetra.econsig.values.OperacaoHistoricoMargemEnum;
import com.zetra.econsig.values.StatusBeneficiarioEnum;
import com.zetra.econsig.values.StatusProtocoloSenhaAutorizacaoEnum;
import com.zetra.econsig.values.TipoArquivoEnum;
import com.zetra.econsig.values.TipoBeneficiarioEnum;
import com.zetra.econsig.values.TipoNotificacaoEnum;
import com.zetra.econsig.values.VencimentoEnum;
import com.zetra.econsig.values.VisibilidadeTipoDadoAdicionalEnum;

/**
 * <p>Title: ServidorControllerBean</p>
 * <p>Description: Session Bean para a operações relacionada a Servidores.</p>
 * <p>Copyright: Copyright (c) 2007</p>
 * <p>Company: ZetraSoft Ltda.</p>
 * $Author$
 * $Revision$
 * $Date$
 */
@Service
@Transactional
public class ServidorControllerBean implements ServidorController {
    private static final org.apache.commons.logging.Log LOG = org.apache.commons.logging.LogFactory.getLog(ServidorControllerBean.class);

    @Autowired
    private ConsultarMargemController consultarMargemController;

    @Autowired
    private CancelarConsignacaoController cancelarConsignacaoController;

    @Autowired
    private ConvenioController convenioController;

    @Autowired
    private ParametroController parametroController;

    @Autowired
    private PontuacaoServidorController pontuacaoServidorController;

    @Autowired
    private SistemaController sistemaController;

    @Autowired
    private ArquivoController arquivoController;

    @Autowired
    private PesquisarConsignacaoController pesquisarConsignacaoController;

    @Autowired
    private PesquisarServidorController pesquisarServidorController;

    @Autowired
    private TransferirConsignacaoController transferirConsignacaoController;

    @Autowired
    private UsuarioController usuarioController;

    @Autowired
    private BeneficiarioController beneficiarioController;

    @Autowired
    private SegurancaController segurancaController;

    @Autowired
    private NotificacaoDispositivoController notificacaoDispositivoController;

    @Autowired
    private ConsignatariaController consignatariaController;

    /************************ SERVIDOR ******************************************/
    @Override
    public String cadastrarServidor(ServidorTransferObject servidor, RegistroServidorTO registroServidor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            String serCodigo = null;
            String rseCodigo = null;
            // validações
            // CPF
            if (ParamSist.paramEquals(CodedValues.TPC_OMITE_CPF_SERVIDOR, CodedValues.TPC_NAO, responsavel) && TextHelper.isNull(servidor.getSerCpf())) {
                throw new ServidorControllerException("mensagem.erro.campo.nulo", responsavel, ApplicationResourcesHelper.getMessage("rotulo.cpf", responsavel));
            }
            // Matrícula
            if (!TextHelper.isNull(registroServidor.getRseMatricula())) {
                // Verifica se a matrícula é numérica
                try {
                    if (ParamSist.paramEquals(CodedValues.TPC_MATRICULA_NUMERICA, CodedValues.TPC_SIM, responsavel)) {
                        final long matricula = Long.parseLong(registroServidor.getRseMatricula());
                        if (matricula <= 0) {
                            throw new ServidorControllerException("mensagem.erro.matricula.invalida", responsavel);
                        }
                        registroServidor.setRseMatricula(Long.toString(matricula));
                    }
                } catch (final NumberFormatException ex) {
                    throw new ServidorControllerException("mensagem.erro.matricula.invalida", responsavel, ex);
                }

                // Pega o tamanho mínimo da matrícula
                int tamanhoMatricula = 0;
                try {
                    if (ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MATRICULA, responsavel) != null) {
                        tamanhoMatricula = Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MATRICULA, responsavel).toString());
                    }
                } catch (final NumberFormatException ex) {
                }

                if (registroServidor.getRseMatricula().length() < tamanhoMatricula) {
                    throw new ServidorControllerException("mensagem.erro.matricula.invalida", responsavel);
                }
            }
            // Situação do servidor
            if ((registroServidor != null) && !CodedValues.SRS_ATIVO.equals(registroServidor.getSrsCodigo()) && !CodedValues.SRS_PENDENTE.equals(registroServidor.getSrsCodigo())) {
                throw new ServidorControllerException("mensagem.erro.situacao.servidor.invalida", responsavel);
            }
            // Convênio ativo
            if (responsavel.isCsaCor() && (registroServidor != null) && !TextHelper.isNull(registroServidor.getOrgCodigo())) {
                try {
                    final List<TransferObject> convenios = convenioController.lstConvenios(null, responsavel.getCsaCodigo(), null, registroServidor.getOrgCodigo(), true, responsavel);
                    if ((convenios == null) || convenios.isEmpty()) {
                        throw new ServidorControllerException("mensagem.convenioNaoEncontrado", responsavel);
                    }
                } catch (final ConvenioControllerException e) {
                    throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
                }
            }

            // Verifica se o servidor já existe
            if (ParamSist.paramEquals(CodedValues.TPC_OMITE_CPF_SERVIDOR, CodedValues.TPC_NAO, responsavel)) {
                // Pesquisa servidores pelo CPF
                List<Servidor> servidoresMesmoCpf = null;
                try {
                    servidoresMesmoCpf = ServidorHome.findByCPF(servidor.getSerCpf());
                } catch (final FindException ex) {
                    throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
                }
                // Se encontrou, verifica se existe um com mesmo nome
                if ((servidoresMesmoCpf != null) && (servidoresMesmoCpf.size() > 0)) {
                    for (final Servidor ser : servidoresMesmoCpf) {
                        if (ser.getSerNome().equalsIgnoreCase(servidor.getSerNome())) {
                            serCodigo = ser.getSerCodigo();
                            break;
                        }
                    }
                    if (TextHelper.isNull(serCodigo)) {
                        // Se não encontrou um com mesmo nome e CPF, verifica se apenas um
                        // registro existe para o CPF, e caso exista, utiliza este atualizando os dados
                        if (servidoresMesmoCpf.size() == 1) {
                            serCodigo = servidoresMesmoCpf.get(0).getSerCodigo();
                            servidor.setSerCodigo(serCodigo);
                        } else {
                            throw new ServidorControllerException("mensagem.erro.mais.de.um.servidor.encontrado.cpf", responsavel);
                        }
                    }
                }
            } else {
                // Pesquisa servidores pelo nome, sobrenome e data de nascimento
                final TransferObject criterios = new CustomTransferObject();
                criterios.setAttribute("responsavel", responsavel);
                try {
                    // define se pesquisa pelo nome completo ou pelo primeiro e último nome
                    if (ShowFieldHelper.canEdit(FieldKeysConstants.INS_SERVIDOR_PARA_RESERVA_PRIMEIRO_NOME, responsavel)) {
                        criterios.setAttribute("NOME", servidor.getSerPrimeiroNome());
                        criterios.setAttribute("SOBRENOME", servidor.getSerUltimoNome());
                    } else {
                        criterios.setAttribute("NOME", servidor.getSerNome());
                    }
                } catch (final ZetraException e) {
                    throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
                }

                criterios.setAttribute("serDataNascimento", servidor.getSerDataNasc());

                final List<TransferObject> lstServidores = pesquisarServidorController.pesquisaServidor(responsavel.getTipoEntidade(), responsavel.getCodigoEntidade(), null, null, null, null, -1, -1, responsavel, false, null, false, null, criterios);
                if ((lstServidores != null) && (lstServidores.size() == 1)) {
                    serCodigo = (String) lstServidores.get(0).getAttribute(Columns.SER_CODIGO);
                    servidor.setSerCodigo(serCodigo);
                } else if ((lstServidores != null) && (lstServidores.size() > 1)) {
                    /* OBS.: a pesquisa de registro servidor pode retornar mais de um registro nos seguintes casos:
                     * 1. o servidor possui mais de um cadastro funcional, para órgãos diferentes
                     * 2. a pesquisa usando LIKE pode retornar resultados onde o nome não seja idêntico ao pesquisado,
                     *    coincidindo a data de nascimento.
                     *    Ex.: ANA BEATRIZ DA SILVA e ANABELA MARIA DA SILVA
                     * 3. homonimos ou primeiro e último nome iguais com mesma data de nascimento
                     *    Ex.: ANA BEATRIZ DA SILVA e ANA MARIA DA SILVA                     *
                     *
                     * Comportamento para os casos acima:
                     * Caso 1: Retornar o primeiro da lista.
                     * Caso 2: Verificar se possui somente um registro com o nome idêntico ao informado para a pesquisa. Se sim, retornar
                     * o registro. Caso contrário, cai no caso 3.
                     * Caso 3: Retornar erro informando que mais de um servidor foi encontrado para a pesquisa.
                     */

                    List<String> serCodigos = new ArrayList<>();
                    // Verifica caso 1:
                    for (final TransferObject ser : lstServidores) {
                        if (!serCodigos.contains(ser.getAttribute(Columns.SER_CODIGO))) {
                            serCodigos.add(ser.getAttribute(Columns.SER_CODIGO).toString());
                        }
                    }
                    // Verifica caso 2:
                    if (serCodigos.size() > 1) {
                        serCodigos = new ArrayList<>();
                        for (final TransferObject ser : lstServidores) {
                            try {
                                if (ShowFieldHelper.canEdit(FieldKeysConstants.INS_SERVIDOR_PARA_RESERVA_PRIMEIRO_NOME, responsavel)) {
                                    // pesquisa por primeiro e último nome
                                    if (!serCodigos.contains(ser.getAttribute(Columns.SER_CODIGO)) && servidor.getSerPrimeiroNome().equals(ser.getAttribute(Columns.SER_PRIMEIRO_NOME)) && servidor.getSerUltimoNome().equals(ser.getAttribute(Columns.SER_ULTIMO_NOME))) {
                                        serCodigos.add(ser.getAttribute(Columns.SER_CODIGO).toString());
                                    }
                                } else // pesquisa por nome completo
                                if (!serCodigos.contains(ser.getAttribute(Columns.SER_CODIGO)) && servidor.getSerNome().equals(ser.getAttribute(Columns.SER_NOME))) {
                                    serCodigos.add(ser.getAttribute(Columns.SER_CODIGO).toString());
                                }
                            } catch (final ZetraException e) {
                                throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
                            }
                        }
                        // Verifica caso 3:
                        if (serCodigos.size() > 1) {
                            throw new ServidorControllerException("mensagem.erro.mais.de.um.servidor.encontrado.nome.data.nascimento", responsavel);
                        }
                    }

                    // Se o caso 1 e 2 foram resolvidos, preenche o ser_codigo para atualização
                    if (serCodigos.size() == 1) {
                        serCodigo = serCodigos.get(0);
                        servidor.setSerCodigo(serCodigo);
                    }
                }
            }

            if (!TextHelper.isNull(serCodigo)) {
                // se encontrou um servidor, atualiza seus dados
                updateServidor(servidor, responsavel);
            } else {
                // se não encontrou servidor, cria um novo
                if (ParamSist.paramEquals(CodedValues.TPC_OMITE_CPF_SERVIDOR, CodedValues.TPC_SIM, responsavel)) {
                    // gera um CPF para o servidor, necessário pois o campo é chave
                    servidor.setSerCpf(GeradorCpfServidor.getInstance().getNext());
                }
                serCodigo = createServidor(servidor, responsavel);
                criaOcorrenciaSER(serCodigo, CodedValues.TOC_INFORMACAO, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ocs.obs.inclusao.manual", responsavel), null, responsavel);
            }

            // Define o código do servidor no registro servidor
            registroServidor.setSerCodigo(serCodigo);

            // Verifica se a matrícula existe no órgão informado
            try {
                final RegistroServidor rse = RegistroServidorHome.findByMatriculaOrgao(registroServidor.getRseMatricula(), registroServidor.getOrgCodigo());
                rseCodigo = rse.getRseCodigo();

                // Caso a matrícula existe no órgão, verifica se está ligada ao servidor informado
                if (!rse.getServidor().getSerCodigo().equals(serCodigo)) {
                    throw new ServidorControllerException("mensagem.erro.matricula.ja.cadastrada.outro.servidor", responsavel);
                } else {
                    updateRegistroServidorSemHistoricoMargem(registroServidor, responsavel);
                }
            } catch (final FindException ex) {
                // Caso não exista, procede a inclusão
                rseCodigo = createRegistroServidor(registroServidor, responsavel);
                criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_INCLUSAO_MANUAL, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.inclusao.manual", responsavel), null, responsavel);
                // Envia e-mail ao CSE/ORG relativo ao cadastro do servidor
                if (responsavel.isCsaCor() && ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_NOTIFICACAO_CAD_SERVIDOR, CodedValues.TPC_SIM, responsavel) && (registroServidor.getSrsCodigo() != null) && CodedValues.SRS_PENDENTE.equals(registroServidor.getSrsCodigo())) {
                    EnviaEmailHelper.enviarEmailNotificacaoCadastroServidor(rseCodigo, responsavel);
                }
            }

            return serCodigo;
        } catch (final ViewHelperException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException(ex);
        } catch (final ServidorControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw ex;
        }
    }

    protected String createServidor(ServidorTransferObject servidor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final Servidor serBean = ServidorHome.create(servidor.getSerCpf(), servidor.getSerDataNasc(), servidor.getSerNomeMae(), servidor.getSerNomePai(), servidor.getSerNome(), servidor.getSerPrimeiroNome(), servidor.getSerNomeMeio(), servidor.getSerUltimoNome(), servidor.getSerTitulacao(), servidor.getSerSexo(), servidor.getSerEstCivil(), servidor.getSerQtdFilhos(), servidor.getSerNacionalidade(), servidor.getSerNroIdt(), servidor.getSerCartProf(), servidor.getSerPis(), servidor.getSerEnd(), servidor.getSerBairro(), servidor.getSerCidade(), servidor.getSerCompl(), servidor.getSerNro(),
                    servidor.getSerCep(), servidor.getSerUf(), servidor.getSerTel(), servidor.getSerEmail(), servidor.getSerEmissorIdt(), servidor.getSerUfIdt(), servidor.getSerDataIdt(), servidor.getSerCidNasc(), servidor.getSerUfNasc(), servidor.getSerNomeConjuge(), servidor.getSerDeficienteVisual(), servidor.getSerDataAlteracao(), servidor.getSerCelular(), servidor.getSerAcessaHostaHost(), servidor.getNesCodigo(), servidor.getThaCodigo(), servidor.getSseCodigo());

            final LogDelegate logDelegate = new LogDelegate(responsavel, Log.SERVIDOR, Log.CREATE, Log.LOG_INFORMACAO);
            logDelegate.setServidor(serBean.getSerCodigo());
            logDelegate.getUpdatedFields(servidor.getAtributos(), null);
            logDelegate.write();

            return serBean.getSerCodigo();
        } catch (final LogControllerException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
        } catch (final CreateException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
        }
    }

    @Override
    public ServidorTransferObject findServidor(ServidorTransferObject servidor, AcessoSistema responsavel) throws ServidorControllerException {
        return setServidorValues(findServidorBean(servidor));
    }

    @Override
    public ServidorTransferObject findServidor(String serCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        return findServidor(new ServidorTransferObject(serCodigo), responsavel);
    }

    @Override
    public ServidorTransferObject findServidor(String serCpf, String rseMatricula, String serNroIdt, java.sql.Date serDataNasc, AcessoSistema responsavel) throws ServidorControllerException {
        ServidorTransferObject servidor = new ServidorTransferObject();
        servidor.setSerCpf(serCpf);

        servidor = findServidor(servidor, responsavel);
        if (!servidor.getSerNroIdt().equals(serNroIdt) || !servidor.getSerDataNasc().equals(serDataNasc)) {
            throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", responsavel);
        }

        try {
            final List<RegistroServidor> registros = RegistroServidorHome.findBySerCodigo(servidor.getSerCodigo());
            boolean achou = false;
            for (final RegistroServidor rseBean : registros) {
                if (rseBean.getRseMatricula().equals(rseMatricula)) {
                    achou = true;
                    break;
                }
            }
            if (!achou) {
                throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", responsavel);
            }

            return servidor;
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", responsavel);
        }
    }

    /**
     * recupera os dados do cargo do servidor, caso preenchidos
     * @param serCodigos
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public TransferObject findCargoByCrsCodigo(String crsCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final CargoRegistroServidor crsRse = CargoRegistroServidorHome.findByPrimaryKey(crsCodigo);
            final TransferObject cargoSer = new CustomTransferObject();
            cargoSer.setAttribute(Columns.CRS_CODIGO, crsRse.getCrsCodigo());
            cargoSer.setAttribute(Columns.CRS_DESCRICAO, crsRse.getCrsDescricao());
            cargoSer.setAttribute(Columns.CRS_IDENTIFICADOR, crsRse.getCrsIdentificador());
            cargoSer.setAttribute(Columns.CRS_VLR_DESC_MAX, crsRse.getCrsVlrDescMax());

            return cargoSer;
        } catch (final FindException e) {
            return null;
        }
    }

    /**
     * Retorna lista de servidores ativos ordenados pela maior margem restante da natureza de empréstimo.
     *
     * @param serCpf
     * @param orgCodigoList
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public List<TransferObject> lstRegistroServidorPorCpf(String serCpf, List<String> orgCodigoList, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistroServidorPorCpfEmailQuery query = new ListaRegistroServidorPorCpfEmailQuery();

            query.serCpf = serCpf;
            query.orgCodigos = orgCodigoList;
            query.recuperaRseExcluido = false;

            return ordenarRsePorMargemDesc(query.executarDTO(), responsavel);
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Retorna lista de servidores ativos ordenados pela maior margem restante da natureza de empréstimo.
     *
     * @param serEmail
     * @param orgCodigoList
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public List<TransferObject> lstRegistroServidorPorEmail(String serEmail, List<String> orgCodigoList, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistroServidorPorCpfEmailQuery query = new ListaRegistroServidorPorCpfEmailQuery();

            query.serEmail = serEmail;
            query.orgCodigos = orgCodigoList;
            query.recuperaRseExcluido = false;

            return ordenarRsePorMargemDesc(query.executarDTO(), responsavel);
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Retorna lista de servidores passada como parâmetro ordenada pela maior margem restante
     * da natureza de empréstimo
     * @param registroServidores lista de servidores a serem ordenados
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    private List<TransferObject> ordenarRsePorMargemDesc(List<TransferObject> rses, AcessoSistema responsavel) throws ServidorControllerException {
        // Se houver somente um servidor, retorna a lista recebida sem tratamento
        if ((rses == null) || rses.isEmpty() || (rses.size() == 1)) {
            return rses;
        }

        final LinkedList<TransferObject> lstSerOrdenada = new LinkedList<>();

        outer: for (final TransferObject rse : rses) {
            final String rseCodigo = (String) rse.getAttribute(Columns.RSE_CODIGO);

            try {

                //busca código de um serviço de natureza de empréstimo para filtrar consulta de margem
                String svcCodigo = null;

                final List<TransferObject> lstSvcs = parametroController.lstServicoServidor(rseCodigo, null, CodedValues.NSE_EMPRESTIMO, true, responsavel);

                if ((lstSvcs != null) & !lstSvcs.isEmpty()) {
                    for (final TransferObject svcTO : lstSvcs) {
                        svcCodigo = (String) svcTO.getAttribute(Columns.SVC_CODIGO);
                        final List<MargemTO> margens = consultarMargemController.consultarMargem(rseCodigo, null, svcCodigo, null, null, false, null, false, true, null, null, responsavel);
                        if ((margens != null) && !margens.isEmpty()) {
                            final MargemTO margemTO = margens.get(0);
                            final TransferObject margemServidorTO = new CustomTransferObject(margemTO);
                            margemServidorTO.setAtributos(rse.getAtributos());
                            lstSerOrdenada.add(margemServidorTO);
                            continue outer;
                        }
                    }
                } else {
                    continue outer;
                }

            } catch (final ParametroControllerException ex) {
                LOG.error(ex.getMessage(), ex);
                throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
            }
        }

        Collections.sort(lstSerOrdenada, (o1, o2) -> {
            final int compStatus = Short.valueOf((String) o1.getAttribute(Columns.SRS_CODIGO)).compareTo(Short.valueOf((String) o2.getAttribute(Columns.SRS_CODIGO)));

            if (compStatus == 0) {
                return ((BigDecimal) o2.getAttribute(Columns.MRS_MARGEM_REST)).compareTo((BigDecimal) o1.getAttribute(Columns.MRS_MARGEM_REST));
            }

            return compStatus;
        });

        return lstSerOrdenada;
    }

    /**
     * recupera dados do servidor ao qual pertence o contrato
     * @param adeCodigo código do contrato
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public TransferObject findServidorProprietarioAde(String adeCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        final ObtemServidorProprietarioAdeQuery ser = new ObtemServidorProprietarioAdeQuery();
        ser.adeCodigo = adeCodigo;

        try {
            final List<TransferObject> serList = ser.executarDTO();

            if (!serList.isEmpty()) {
                return serList.get(0);
            }

            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * recupera o servidor pelo usuCodigo
     * @param usuCodigo código do usuário do servidor
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public ServidorTransferObject findServidorByUsuCodigo(String usuCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final Servidor servidorBean = ServidorHome.findByUsuCodigo(usuCodigo);

            return setServidorValues(servidorBean);
        } catch (final FindException e) {
            throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", (AcessoSistema) null);
        }
    }

    @Override
    public ServidorTransferObject findServidorByRseCodigo(String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final Servidor servidorBean = ServidorHome.findByRseCodigo(rseCodigo);

            return setServidorValues(servidorBean);
        } catch (final FindException e) {
            throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", (AcessoSistema) null);
        }
    }

    private Servidor findServidorBean(ServidorTransferObject servidor) throws ServidorControllerException {
        Servidor servidorBean = null;
        if (servidor.getSerCodigo() != null) {
            try {
                servidorBean = ServidorHome.findByPrimaryKey(servidor.getSerCodigo());
            } catch (final FindException ex) {
                throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", (AcessoSistema) null);
            }
        } else if ((servidor.getSerCpf() != null) && (servidor.getSerNome() != null)) {
            try {
                servidorBean = ServidorHome.findByCPFNome(servidor.getSerCpf(), servidor.getSerNome());
            } catch (final FindException ex) {
                throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", (AcessoSistema) null);
            }
        } else {
            throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", (AcessoSistema) null);
        }
        return servidorBean;
    }

    private ServidorTransferObject setServidorValues(Servidor servidorBean) {
        final ServidorTransferObject servidor = new ServidorTransferObject(servidorBean.getSerCodigo());

        servidor.setSerCpf(servidorBean.getSerCpf());
        servidor.setSerNomeMae(servidorBean.getSerNomeMae());
        servidor.setSerNomePai(servidorBean.getSerNomePai());
        servidor.setSerNome(servidorBean.getSerNome());
        servidor.setSerPrimeiroNome(servidorBean.getSerPrimeiroNome());
        servidor.setSerTitulacao(servidorBean.getSerTitulacao());
        servidor.setSerNomeMeio(servidorBean.getSerNomeMeio());
        servidor.setSerUltimoNome(servidorBean.getSerUltimoNome());
        servidor.setSerSexo(servidorBean.getSerSexo());
        servidor.setSerEstCivil(servidorBean.getSerEstCivil());
        servidor.setSerNacionalidade(servidorBean.getSerNacionalidade());
        servidor.setSerNroIdt(servidorBean.getSerNroIdt());
        servidor.setSerEmissorIdt(servidorBean.getSerEmissorIdt());
        servidor.setSerUfIdt(servidorBean.getSerUfIdt());
        servidor.setSerCartProf(servidorBean.getSerCartProf());
        servidor.setSerPis(servidorBean.getSerPis());
        servidor.setSerEnd(servidorBean.getSerEnd());
        servidor.setSerBairro(servidorBean.getSerBairro());
        servidor.setSerCidade(servidorBean.getSerCidade());
        servidor.setSerCompl(servidorBean.getSerCompl());
        servidor.setSerNro(servidorBean.getSerNro() == null ? null : servidorBean.getSerNro().toString());
        servidor.setSerCep(servidorBean.getSerCep());
        servidor.setSerUf(servidorBean.getSerUf());
        servidor.setSerTel(servidorBean.getSerTel());
        servidor.setSerCelular(servidorBean.getSerCelular());
        servidor.setSerEmail(servidorBean.getSerEmail());
        servidor.setSerCidNasc(servidorBean.getSerCidNasc());
        servidor.setSerUfNasc(servidorBean.getSerUfNasc());
        servidor.setSerNomeConjuge(servidorBean.getSerNomeConjuge());
        servidor.setSerDeficienteVisual(servidorBean.getSerDeficienteVisual() != null ? servidorBean.getSerDeficienteVisual().toString() : null);
        servidor.setSerAcessaHostaHost(servidorBean.getSerAcessaHostAHost() != null ? servidorBean.getSerAcessaHostAHost().toString() : null);
        servidor.setSerQtdFilhos(servidorBean.getSerQtdFilhos() != null ? servidorBean.getSerQtdFilhos() : null);
        servidor.setSerDispensaDigital(servidorBean.getSerDispensaDigital());
        servidor.setSerDataIdentificacaoPessoal(servidorBean.getSerDataIdentificacaoPessoal());
        servidor.setSerDataValidacaoEmail(servidorBean.getSerDataValidacaoEmail());
        servidor.setSerPermiteAlterarEmail(servidorBean.getSerPermiteAlterarEmail());

        if (servidorBean.getNivelEscolaridade() != null) {
            servidor.setNesCodigo(servidorBean.getNivelEscolaridade().getNesCodigo());
        }
        if (servidorBean.getTipoHabitacao() != null) {
            servidor.setThaCodigo(servidorBean.getTipoHabitacao().getThaCodigo());
        }
        if (servidorBean.getStatusServidor() != null) {
            servidor.setSseCodigo(servidorBean.getStatusServidor().getSseCodigo());
        }
        if (servidorBean.getUsuario() != null) {
            servidor.setUsuCodigo(servidorBean.getUsuario().getUsuCodigo());
        }
        if (servidorBean.getSerDataNasc() != null) {
            servidor.setSerDataNasc(DateHelper.toSQLDate(servidorBean.getSerDataNasc()));
        }
        if (servidorBean.getSerDataIdt() != null) {
            servidor.setSerDataIdt(DateHelper.toSQLDate(servidorBean.getSerDataIdt()));
        }
        if (servidorBean.getSerDataAlteracao() != null) {
            servidor.setSerDataAlteracao(new java.sql.Timestamp(servidorBean.getSerDataAlteracao().getTime()));
        }

        return servidor;
    }

    @Override
    public void updateServidor(ServidorTransferObject servidor, AcessoSistema responsavel) throws ServidorControllerException {
        updateServidor(servidor, CodedValues.TOC_RSE_ALTERACAO_DADOS_CADASTRAIS, true, responsavel);
    }

    @Override
    public void updateServidor(ServidorTransferObject servidor, String tocCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        updateServidor(servidor, tocCodigo, true, responsavel);
    }

    @Override
    public String updateServidor(ServidorTransferObject servidor, boolean enviaEmail, AcessoSistema responsavel) throws ServidorControllerException {
        return updateServidor(servidor, CodedValues.TOC_RSE_ALTERACAO_DADOS_CADASTRAIS, enviaEmail, responsavel);
    }

    private String updateServidor(ServidorTransferObject servidor, String tocCodigo, boolean enviaEmail, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final Servidor servidorBean = findServidorBean(servidor);
            final LogDelegate log = new LogDelegate(responsavel, Log.SERVIDOR, Log.UPDATE, Log.LOG_INFORMACAO);
            log.setServidor(servidorBean.getSerCodigo());

            boolean cpfModificado = false;

            /* Compara a versão do cache com a passada por parâmetro */
            final ServidorTransferObject servidorCache = setServidorValues(servidorBean);
            final CustomTransferObject merge = log.getUpdatedFields(servidor.getAtributos(), servidorCache.getAtributos());

            final StringBuilder msgOcs = new StringBuilder();

            if (merge.getAtributos().containsKey(Columns.SER_CPF)) {
                // Verifica se não existe outro servidor com mesmo nome e CPF
                final ServidorTransferObject teste = new ServidorTransferObject();
                teste.setSerCpf((String) merge.getAttribute(Columns.SER_CPF));
                teste.setSerNome(servidorBean.getSerNome());

                boolean existe = false;
                try {
                    final Servidor serTeste = findServidorBean(teste);
                    existe = (serTeste != null) && !serTeste.getSerCodigo().equals(servidor.getSerCodigo());
                } catch (final ServidorControllerException ex) {
                    LOG.error(ex.getMessage());
                }
                if (existe) {
                    throw new ServidorControllerException("mensagem.erro.nao.possivel.excluir.registro.servidor.pois.existe.outro.mesmo.nome.cpf", responsavel);
                }

                final String cpfOld = servidorBean.getSerCpf() != null ? servidorBean.getSerCpf().toString() : "";
                final String cpfNew = merge.getAttribute(Columns.SER_CPF) != null ? merge.getAttribute(Columns.SER_CPF).toString() : "";
                if (!cpfOld.equals(cpfNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.cpf.alterado.de.arg0.para.arg1", responsavel, cpfOld, cpfNew));
                }
                servidorBean.setSerCpf((String) merge.getAttribute(Columns.SER_CPF));
                cpfModificado = true;
            }

            String primeiroNomeNew = null;
            String nomeMeioNew = null;
            String titulacaoNew = null;
            String ultimoNomeNew = null;
            boolean alterouNome = false;

            if (merge.getAtributos().containsKey(Columns.SER_BAIRRO)) {
                final String bairroOld = servidorBean.getSerBairro() != null ? servidorBean.getSerBairro().toString() : "";
                final String bairroNew = merge.getAttribute(Columns.SER_BAIRRO) != null ? merge.getAttribute(Columns.SER_BAIRRO).toString() : "";
                if (!bairroOld.equals(bairroNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.bairro.alterado.de.arg0.para.arg1", responsavel, bairroOld, bairroNew));
                }
                servidorBean.setSerBairro((String) merge.getAttribute(Columns.SER_BAIRRO));
            }
            if (merge.getAtributos().containsKey(Columns.SER_CART_PROF)) {
                final String cartProfOld = servidorBean.getSerCartProf() != null ? servidorBean.getSerCartProf().toString() : "";
                final String cartProfNew = merge.getAttribute(Columns.SER_CART_PROF) != null ? merge.getAttribute(Columns.SER_CART_PROF).toString() : "";
                if (!cartProfOld.equals(cartProfNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.cart.trabalho.alterada.de.arg0.para.arg1", responsavel, cartProfOld, cartProfNew));
                }
                servidorBean.setSerCartProf((String) merge.getAttribute(Columns.SER_CART_PROF));
            }
            if (merge.getAtributos().containsKey(Columns.SER_CEP)) {
                final String cepOld = servidorBean.getSerCep() != null ? servidorBean.getSerCep().toString() : "";
                final String cepNew = merge.getAttribute(Columns.SER_CEP) != null ? merge.getAttribute(Columns.SER_CEP).toString() : "";
                if (!cepOld.equals(cepNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.cep.alterado.de.arg0.para.arg1", responsavel, cepOld, cepNew));
                }
                servidorBean.setSerCep((String) merge.getAttribute(Columns.SER_CEP));
            }
            if (merge.getAtributos().containsKey(Columns.SER_CIDADE)) {
                final String cidadeOld = servidorBean.getSerCidade() != null ? servidorBean.getSerCidade().toString() : "";
                final String cidadeNew = merge.getAttribute(Columns.SER_CIDADE) != null ? merge.getAttribute(Columns.SER_CIDADE).toString() : "";
                if (!cidadeOld.equals(cidadeNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.cidade.alterada.de.arg0.para.arg1", responsavel, cidadeOld, cidadeNew));
                }
                servidorBean.setSerCidade((String) merge.getAttribute(Columns.SER_CIDADE));
            }
            if (merge.getAtributos().containsKey(Columns.SER_COMPL)) {
                final String complOld = servidorBean.getSerCompl() != null ? servidorBean.getSerCompl().toString() : "";
                final String complNew = merge.getAttribute(Columns.SER_COMPL) != null ? merge.getAttribute(Columns.SER_COMPL).toString() : "";
                if (!complOld.equals(complNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.complemento.alterado.de.arg0.para.arg1", responsavel, complOld, complNew));
                }
                servidorBean.setSerCompl((String) merge.getAttribute(Columns.SER_COMPL));
            }
            if (merge.getAtributos().containsKey(Columns.SER_DATA_NASC)) {
                final String dataOld = servidorBean.getSerDataNasc() != null ? DateHelper.toDateString(servidorBean.getSerDataNasc()) : "";
                final String dataNew = merge.getAttribute(Columns.SER_DATA_NASC) != null ? DateHelper.toDateString((Date) merge.getAttribute(Columns.SER_DATA_NASC)) : "";
                if (!dataOld.equals(dataNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.nascimento.alterada.de.arg0.para.arg1", responsavel, dataOld, dataNew));
                }
                servidorBean.setSerDataNasc((java.sql.Date) merge.getAttribute(Columns.SER_DATA_NASC));
            }
            if (merge.getAtributos().containsKey(Columns.SER_END)) {
                final String endOld = servidorBean.getSerEnd() != null ? servidorBean.getSerEnd().toString() : "";
                final String endNew = merge.getAttribute(Columns.SER_END) != null ? merge.getAttribute(Columns.SER_END).toString() : "";
                if (!endOld.equals(endNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.endereco.alterado.de.arg0.para.arg1", responsavel, endOld, endNew));
                }
                servidorBean.setSerEnd((String) merge.getAttribute(Columns.SER_END));
            }
            if (merge.getAtributos().containsKey(Columns.SER_NRO)) {
                final String nroOld = servidorBean.getSerNro() != null ? servidorBean.getSerNro().toString() : "";
                final String nroNew = merge.getAttribute(Columns.SER_NRO) != null ? merge.getAttribute(Columns.SER_NRO).toString() : "";
                if (!nroOld.equals(nroNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.numero.alterado.de.arg0.para.arg1", responsavel, nroOld, nroNew));
                }
                servidorBean.setSerNro((String) merge.getAttribute(Columns.SER_NRO));
            }
            if (merge.getAtributos().containsKey(Columns.SER_EST_CIVIL)) {
                final String estCivilOld = servidorBean.getSerEstCivil() != null ? servidorBean.getSerEstCivil().toString() : "";
                final String estCivilNew = merge.getAttribute(Columns.SER_EST_CIVIL) != null ? merge.getAttribute(Columns.SER_EST_CIVIL).toString() : "";
                if (!estCivilOld.equals(estCivilNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.estado.civil.alterado.de.arg0.para.arg1", responsavel, estCivilOld, estCivilNew));
                }
                servidorBean.setSerEstCivil((String) merge.getAttribute(Columns.SER_EST_CIVIL));
            }
            if (merge.getAtributos().containsKey(Columns.SER_NACIONALIDADE)) {
                final String nacionalidadeOld = servidorBean.getSerNacionalidade() != null ? servidorBean.getSerNacionalidade().toString() : "";
                final String nacionalidadeNew = merge.getAttribute(Columns.SER_NACIONALIDADE) != null ? merge.getAttribute(Columns.SER_NACIONALIDADE).toString() : "";
                if (!nacionalidadeOld.equals(nacionalidadeNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.nacionalidade.alterada.de.arg0.para.arg1", responsavel, nacionalidadeOld, nacionalidadeNew));
                }
                servidorBean.setSerNacionalidade((String) merge.getAttribute(Columns.SER_NACIONALIDADE));
            }
            if (!TextHelper.isNull(merge.getAttribute(Columns.SER_NOME)) && merge.getAtributos().containsKey(Columns.SER_NOME)) {
                final String nomeOld = servidorBean.getSerNome() != null ? servidorBean.getSerNome().toString() : "";
                titulacaoNew = merge.getAttribute(Columns.SER_NOME) != null ? merge.getAttribute(Columns.SER_NOME).toString() : "";
                if (!nomeOld.equals(titulacaoNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.nome.alterado.de.arg0.para.arg1", responsavel, nomeOld, titulacaoNew));
                }
                servidorBean.setSerNome((String) merge.getAttribute(Columns.SER_NOME));
            }
            if (merge.getAtributos().containsKey(Columns.SER_TITULACAO)) {
                final String nomeOld = servidorBean.getSerTitulacao() != null ? servidorBean.getSerTitulacao().toString() : "";
                titulacaoNew = merge.getAttribute(Columns.SER_TITULACAO) != null ? merge.getAttribute(Columns.SER_TITULACAO).toString() : "";
                if (!nomeOld.equals(titulacaoNew)) {
                    alterouNome = true;
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.titularizacao.alterado.de.arg0.para.arg1", responsavel, nomeOld, titulacaoNew));
                }
                servidorBean.setSerTitulacao((String) merge.getAttribute(Columns.SER_TITULACAO));
            }
            if (merge.getAtributos().containsKey(Columns.SER_PRIMEIRO_NOME)) {
                final String nomeOld = servidorBean.getSerPrimeiroNome() != null ? servidorBean.getSerPrimeiroNome().toString() : "";
                primeiroNomeNew = merge.getAttribute(Columns.SER_PRIMEIRO_NOME) != null ? merge.getAttribute(Columns.SER_PRIMEIRO_NOME).toString() : "";
                if (!nomeOld.equals(primeiroNomeNew)) {
                    alterouNome = true;
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.primeiro.nome.alterado.de.arg0.para.arg1", responsavel, nomeOld, primeiroNomeNew));
                }
                servidorBean.setSerPrimeiroNome((String) merge.getAttribute(Columns.SER_PRIMEIRO_NOME));
            }
            if (merge.getAtributos().containsKey(Columns.SER_NOME_MEIO)) {
                final String nomeOld = servidorBean.getSerNomeMeio() != null ? servidorBean.getSerNomeMeio().toString() : "";
                nomeMeioNew = merge.getAttribute(Columns.SER_NOME_MEIO) != null ? merge.getAttribute(Columns.SER_NOME_MEIO).toString() : "";
                if (!nomeOld.equals(nomeMeioNew)) {
                    alterouNome = true;
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.nome.meio.alterado.de.arg0.para.arg1", responsavel, nomeOld, nomeMeioNew));
                }
                servidorBean.setSerNomeMeio((String) merge.getAttribute(Columns.SER_NOME_MEIO));
            }
            if (merge.getAtributos().containsKey(Columns.SER_ULTIMO_NOME)) {
                final String nomeOld = servidorBean.getSerUltimoNome() != null ? servidorBean.getSerUltimoNome().toString() : "";
                ultimoNomeNew = merge.getAttribute(Columns.SER_ULTIMO_NOME) != null ? merge.getAttribute(Columns.SER_ULTIMO_NOME).toString() : "";
                if (!nomeOld.equals(ultimoNomeNew)) {
                    alterouNome = true;
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.ultimo.nome.alterado.de.arg0.para.arg1", responsavel, nomeOld, ultimoNomeNew));
                }
                servidorBean.setSerUltimoNome((String) merge.getAttribute(Columns.SER_ULTIMO_NOME));
            }

            // Se alterou um dos componentes do nome (em sistemas que os utilizam), altera também o campo com o nome completo
            if (alterouNome) {
                servidorBean.setSerNome(JspHelper.montaSerNome(servidorBean.getSerTitulacao(), servidorBean.getSerPrimeiroNome(), servidorBean.getSerNomeMeio(), servidorBean.getSerUltimoNome()));
            }

            if (merge.getAtributos().containsKey(Columns.SER_NOME_MAE)) {
                final String nomeMaeOld = servidorBean.getSerNomeMae() != null ? servidorBean.getSerNomeMae().toString() : "";
                final String nomeMaeNew = merge.getAttribute(Columns.SER_NOME_MAE) != null ? merge.getAttribute(Columns.SER_NOME_MAE).toString() : "";
                if (!nomeMaeOld.equals(nomeMaeNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.nome.mae.alterado.de.arg0.para.arg1", responsavel, nomeMaeOld, nomeMaeNew));
                }
                servidorBean.setSerNomeMae((String) merge.getAttribute(Columns.SER_NOME_MAE));
            }
            if (merge.getAtributos().containsKey(Columns.SER_NOME_PAI)) {
                final String nomePaiOld = servidorBean.getSerNomePai() != null ? servidorBean.getSerNomePai().toString() : "";
                final String nomePaiNew = merge.getAttribute(Columns.SER_NOME_PAI) != null ? merge.getAttribute(Columns.SER_NOME_PAI).toString() : "";
                if (!nomePaiOld.equals(nomePaiNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.nome.pai.alterado.de.arg0.para.arg1", responsavel, nomePaiOld, nomePaiNew));
                }
                servidorBean.setSerNomePai((String) merge.getAttribute(Columns.SER_NOME_PAI));
            }
            if (merge.getAtributos().containsKey(Columns.SER_NOME_CONJUGE)) {
                final String nomeConjugeOld = servidorBean.getSerNomeConjuge() != null ? servidorBean.getSerNomeConjuge().toString() : "";
                final String nomeConjugeNew = merge.getAttribute(Columns.SER_NOME_CONJUGE) != null ? merge.getAttribute(Columns.SER_NOME_CONJUGE).toString() : "";
                if (!nomeConjugeOld.equals(nomeConjugeNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.nome.conjuge.alterado.de.arg0.para.arg1", responsavel, nomeConjugeOld, nomeConjugeNew));
                }
                servidorBean.setSerNomeConjuge((String) merge.getAttribute(Columns.SER_NOME_CONJUGE));
            }
            if (merge.getAtributos().containsKey(Columns.SER_NRO_IDT)) {
                final String nroIdtOld = servidorBean.getSerNroIdt() != null ? servidorBean.getSerNroIdt().toString() : "";
                final String nroIdtNew = merge.getAttribute(Columns.SER_NRO_IDT) != null ? merge.getAttribute(Columns.SER_NRO_IDT).toString() : "";
                if (!nroIdtOld.equals(nroIdtNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.numero.carteira.identidade.alterado.de.arg0.para.arg1", responsavel, nroIdtOld, nroIdtNew));
                }
                servidorBean.setSerNroIdt((String) merge.getAttribute(Columns.SER_NRO_IDT));
            }
            if (merge.getAtributos().containsKey(Columns.SER_EMISSOR_IDT)) {
                final String emissorIdtOld = servidorBean.getSerEmissorIdt() != null ? servidorBean.getSerEmissorIdt().toString() : "";
                final String emissorIdtNew = merge.getAttribute(Columns.SER_EMISSOR_IDT) != null ? merge.getAttribute(Columns.SER_EMISSOR_IDT).toString() : "";
                if (!emissorIdtOld.equals(emissorIdtNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.emissor.carteira.identidade.alterado.de.arg0.para.arg1", responsavel, emissorIdtOld, emissorIdtNew));
                }
                servidorBean.setSerEmissorIdt((String) merge.getAttribute(Columns.SER_EMISSOR_IDT));
            }
            if (merge.getAtributos().containsKey(Columns.SER_UF_IDT)) {
                final String ufIdtOld = servidorBean.getSerUfIdt() != null ? servidorBean.getSerUfIdt().toString() : "";
                final String ufIdtNew = merge.getAttribute(Columns.SER_UF_IDT) != null ? merge.getAttribute(Columns.SER_UF_IDT).toString() : "";
                if (!ufIdtOld.equals(ufIdtNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.uf.emissao.carteira.identidade.alterado.de.arg0.para.arg1", responsavel, ufIdtOld, ufIdtNew));
                }
                servidorBean.setSerUfIdt((String) merge.getAttribute(Columns.SER_UF_IDT));
            }
            if (merge.getAtributos().containsKey(Columns.SER_DATA_IDT)) {
                final String dataOld = servidorBean.getSerDataIdt() != null ? DateHelper.toDateString(servidorBean.getSerDataIdt()) : "";
                final String dataNew = merge.getAttribute(Columns.SER_DATA_IDT) != null ? DateHelper.toDateString((Date) merge.getAttribute(Columns.SER_DATA_IDT)) : "";
                if (!dataOld.equals(dataNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.emissao.carteira.identidade.alterada.de.arg0.para.arg1", responsavel, dataOld, dataNew));
                }
                servidorBean.setSerDataIdt((java.sql.Date) merge.getAttribute(Columns.SER_DATA_IDT));
            }
            if (merge.getAtributos().containsKey(Columns.SER_PIS)) {
                final String pisOld = servidorBean.getSerPis() != null ? servidorBean.getSerPis().toString() : "";
                final String pisNew = merge.getAttribute(Columns.SER_PIS) != null ? merge.getAttribute(Columns.SER_PIS).toString() : "";
                if (!pisOld.equals(pisNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.numero.pis.alterado.de.arg0.para.arg1", responsavel, pisOld, pisNew));
                }
                servidorBean.setSerPis((String) merge.getAttribute(Columns.SER_PIS));
            }
            if (merge.getAtributos().containsKey(Columns.SER_SEXO)) {
                final String sexoOld = servidorBean.getSerSexo() != null ? servidorBean.getSerSexo().toString() : "";
                final String sexoNew = merge.getAttribute(Columns.SER_SEXO) != null ? merge.getAttribute(Columns.SER_SEXO).toString() : "";
                if (!sexoOld.equals(sexoNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.sexo.alterado.de.arg0.para.arg1", responsavel, sexoOld, sexoNew));
                }
                servidorBean.setSerSexo((String) merge.getAttribute(Columns.SER_SEXO));
            }

            if (merge.getAtributos().containsKey(Columns.SER_QTD_FILHOS)) {
                final String qtdFilhosOld = servidorBean.getSerQtdFilhos() != null ? servidorBean.getSerQtdFilhos().toString() : "";
                final String qtdFilhosnew = merge.getAttribute(Columns.SER_QTD_FILHOS) != null ? merge.getAttribute(Columns.SER_QTD_FILHOS).toString() : "";
                if (!qtdFilhosOld.equals(qtdFilhosnew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.qtd.filhos.alterado.de.arg0.para.arg1", responsavel, qtdFilhosOld, qtdFilhosnew));
                }
                servidorBean.setSerQtdFilhos((Short) merge.getAttribute(Columns.SER_QTD_FILHOS));
            }

            if (merge.getAtributos().containsKey(Columns.SER_NES_CODIGO)) {
                final String getNesOld = servidorBean.getNivelEscolaridade() != null ? servidorBean.getNivelEscolaridade().getNesCodigo().toString() : "";
                final String getNesNew = merge.getAttribute(Columns.SER_NES_CODIGO) != null ? merge.getAttribute(Columns.SER_NES_CODIGO).toString() : "";
                if (!getNesOld.equals(getNesNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.nivel.escolaridade.alterado.de.arg0.para.arg1", responsavel, getNesOld, getNesNew));
                }
                servidorBean.setNivelEscolaridade((merge.getAttribute(Columns.SER_NES_CODIGO) != null) && !"".equals(merge.getAttribute(Columns.SER_NES_CODIGO)) ? NivelEscolaridadeHome.findByPrimaryKey((String) merge.getAttribute(Columns.SER_NES_CODIGO)) : null);
            }

            if (merge.getAtributos().containsKey(Columns.SER_THA_CODIGO)) {
                final String getThaOld = servidorBean.getTipoHabitacao() != null ? servidorBean.getTipoHabitacao().getThaCodigo().toString() : "";
                final String getThaNew = merge.getAttribute(Columns.SER_THA_CODIGO) != null ? merge.getAttribute(Columns.SER_THA_CODIGO).toString() : "";
                if (!getThaOld.equals(getThaNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.tipo.habitacao.alterado.de.arg0.para.arg1", responsavel, getThaOld, getThaNew));
                }
                servidorBean.setTipoHabitacao((merge.getAttribute(Columns.SER_THA_CODIGO) != null) && !"".equals(merge.getAttribute(Columns.SER_THA_CODIGO)) ? TipoHabitacaoHome.findByPrimaryKey((String) merge.getAttribute(Columns.SER_THA_CODIGO)) : null);
            }

            if (merge.getAtributos().containsKey(Columns.SER_TEL)) {
                final String telOld = servidorBean.getSerTel() != null ? servidorBean.getSerTel().toString() : "";
                final String telNew = merge.getAttribute(Columns.SER_TEL) != null ? merge.getAttribute(Columns.SER_TEL).toString() : "";
                if (!telOld.equals(telNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.telefone.alterado.de.arg0.para.arg1", responsavel, telOld, telNew));
                }
                servidorBean.setSerTel((String) merge.getAttribute(Columns.SER_TEL));
            }
            if (merge.getAtributos().containsKey(Columns.SER_CELULAR)) {
                final boolean verificaUnicidadeCelular = ParamSist.paramEquals(CodedValues.TPC_IMPEDE_CELULAR_IGUAL_ENTRE_SER_CPF, CodedValues.TPC_SIM, responsavel);
                if (verificaUnicidadeCelular && !TextHelper.isNull(servidor.getSerCelular())) {
                    // verfica se não existe outro servidor com o mesmo celular
                    final boolean existeCelularCadastrado = existeCelularCadastrado(servidor.getSerCelular().trim(), servidor.getSerCpf(), responsavel);
                    if (existeCelularCadastrado) {
                        throw new ServidorControllerException("mensagem.erro.celular.informado.em.uso.outro.cpf", responsavel);
                    }
                }
                final String celularOld = servidorBean.getSerCelular() != null ? servidorBean.getSerCelular().toString() : "";
                final String celularNew = merge.getAttribute(Columns.SER_CELULAR) != null ? merge.getAttribute(Columns.SER_CELULAR).toString() : "";
                if (!celularOld.equals(celularNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.celular.alterado.de.arg0.para.arg1", responsavel, celularOld, celularNew));
                }
                servidorBean.setSerCelular((String) merge.getAttribute(Columns.SER_CELULAR));
            }
            if (merge.getAtributos().containsKey(Columns.SER_UF)) {
                final String ufOld = servidorBean.getSerUf() != null ? servidorBean.getSerUf().toString() : "";
                final String ufNew = merge.getAttribute(Columns.SER_UF) != null ? merge.getAttribute(Columns.SER_UF).toString() : "";
                if (!ufOld.equals(ufNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.uf.alterado.de.arg0.para.arg1", responsavel, ufOld, ufNew));
                }
                servidorBean.setSerUf((String) merge.getAttribute(Columns.SER_UF));
            }
            if (merge.getAtributos().containsKey(Columns.SER_EMAIL)) {
                if (CodedValues.TPC_NAO.equals(servidorBean.getSerPermiteAlterarEmail())) {
                    throw new ServidorControllerException("mensagem.erro.email.nao.pode.ser.alterado", responsavel);
                }
                final String emailOld = servidorBean.getSerEmail() != null ? servidorBean.getSerEmail().toString() : "";
                final String emailNew = merge.getAttribute(Columns.SER_EMAIL) != null ? merge.getAttribute(Columns.SER_EMAIL).toString() : "";
                if (!TextHelper.isNull(emailNew)) {
                    // Verifica se não existe outro servidor com mesmo email
                    final boolean existeEmailCadastrado = existeEmailCadastrado(emailNew.trim(), servidor.getSerCpf(), responsavel);
                    if (existeEmailCadastrado) {
                        throw new ServidorControllerException("mensagem.erro.email.informado.em.uso.outro.cpf", responsavel);
                    }
                }
                if (!emailOld.equals(emailNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.email.alterado.de.arg0.para.arg1", responsavel, emailOld, emailNew));
                }
                servidorBean.setSerEmail(emailNew);
                // força nova validação do e-mail
                servidorBean.setSerDataValidacaoEmail(null);
            }
            if (merge.getAtributos().containsKey(Columns.SER_CID_NASC)) {
                final String cidNascOld = servidorBean.getSerCidNasc() != null ? servidorBean.getSerCidNasc().toString() : "";
                final String cidNascNew = merge.getAttribute(Columns.SER_CID_NASC) != null ? merge.getAttribute(Columns.SER_CID_NASC).toString() : "";
                if (!cidNascOld.equals(cidNascNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.cidade.nascimento.alterada.de.arg0.para.arg1", responsavel, cidNascOld, cidNascNew));
                }
                servidorBean.setSerCidNasc((String) merge.getAttribute(Columns.SER_CID_NASC));
            }
            if (merge.getAtributos().containsKey(Columns.SER_UF_NASC)) {
                final String ufNascOld = servidorBean.getSerUfNasc() != null ? servidorBean.getSerUfNasc().toString() : "";
                final String ufNascNew = merge.getAttribute(Columns.SER_UF_NASC) != null ? merge.getAttribute(Columns.SER_UF_NASC).toString() : "";
                if (!ufNascOld.equals(ufNascNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.uf.nascimento.alterado.de.arg0.para.arg1", responsavel, ufNascOld, ufNascNew));
                }
                servidorBean.setSerUfNasc((String) merge.getAttribute(Columns.SER_UF_NASC));
            }
            if (merge.getAtributos().containsKey(Columns.SER_DEFICIENTE_VISUAL)) {
                final String serDeficienteVisual = (String) merge.getAttribute(Columns.SER_DEFICIENTE_VISUAL);
                final String deficienteVisualOld = servidorBean.getSerDeficienteVisual() != null ? servidorBean.getSerDeficienteVisual().toString() : "";
                final String deficienteVisualNew = !TextHelper.isNull(serDeficienteVisual) ? serDeficienteVisual.substring(0, 1) : "";
                if (!deficienteVisualOld.equals(deficienteVisualNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.deficiente.visual.alterado.de.arg0.para.arg1", responsavel, deficienteVisualOld, deficienteVisualNew));
                }
                servidorBean.setSerDeficienteVisual(!TextHelper.isNull(serDeficienteVisual) ? serDeficienteVisual.substring(0, 1) : null);
            }
            if (merge.getAtributos().containsKey(Columns.SER_ACESSA_HOST_A_HOST)) {
                final String serAcessaHostaHost = (String) merge.getAttribute(Columns.SER_ACESSA_HOST_A_HOST);
                final String serAcessaHostaHostOld = servidorBean.getSerAcessaHostAHost() != null ? servidorBean.getSerAcessaHostAHost().toString() : "";
                final String serAcessaHostaHostlNew = !TextHelper.isNull(serAcessaHostaHost) ? serAcessaHostaHost.substring(0, 1) : "";
                if (!serAcessaHostaHostOld.equals(serAcessaHostaHostlNew)) {
                    msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.acesso.host.a.host.alterado.de.arg0.para.arg1", responsavel, serAcessaHostaHostOld, serAcessaHostaHostlNew));
                }
                servidorBean.setSerAcessaHostAHost(!TextHelper.isNull(serAcessaHostaHost) ? serAcessaHostaHost.substring(0, 1) : null);
            }
            // Atualiza o usuário modificador do registro servidor
            if (merge.getAtributos().containsKey(Columns.SER_USU_CODIGO)) {
                servidorBean.setUsuario(UsuarioHome.findByPrimaryKey((String) merge.getAttribute(Columns.SER_USU_CODIGO)));
            }
            // Atualiza a data de modificação
            if (merge.getAtributos().containsKey(Columns.SER_DATA_ALTERACAO)) {
                servidorBean.setSerDataAlteracao((Timestamp) merge.getAttribute(Columns.SER_DATA_ALTERACAO));
            }

            if (merge.getAtributos().containsKey(Columns.SER_DATA_VALIDACAO_EMAIL)) {
                final Timestamp dataValidacaoEmail = (Timestamp) merge.getAttribute(Columns.SER_DATA_VALIDACAO_EMAIL);
                servidorBean.setSerDataValidacaoEmail((Timestamp) merge.getAttribute(Columns.SER_DATA_VALIDACAO_EMAIL));
                msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.servidor.data.validacao.email.alterada.para.arg1", responsavel, DateHelper.format(dataValidacaoEmail, LocaleHelper.getDateTimePattern())));
            }

            if (merge.getAtributos().containsKey(Columns.SER_DATA_IDENTIFICACAO_PESSOAL)) {
                final Timestamp dataIdntPessoal = (Timestamp) merge.getAttribute(Columns.SER_DATA_IDENTIFICACAO_PESSOAL);
                servidorBean.setSerDataIdentificacaoPessoal(dataIdntPessoal);
                msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.servidor.data.identificao.pessoal.alterada.para.arg1", responsavel, DateHelper.format(dataIdntPessoal, LocaleHelper.getDateTimePattern())));
            }

            if (merge.getAtributos().containsKey(Columns.SER_PERMITE_ALTERAR_EMAIL)) {
                servidorBean.setSerPermiteAlterarEmail((Boolean) merge.getAttribute(Columns.SER_PERMITE_ALTERAR_EMAIL) ? CodedValues.TPC_SIM : CodedValues.TPC_NAO);
            }

            AbstractEntityHome.update(servidorBean);

            final boolean desabilitarEnvioCadastroEmailMobileSer = servidor.getMobile() && ParamSist.getBoolParamSist(CodedValues.TPC_DESABILITAR_ENVIO_CADASTRO_EMAIL_MOBILE_SER, responsavel);
            final boolean habilitaModuloRecuperarSenhaSer = ParamSist.paramEquals(CodedValues.TPC_HABILITA_MODULO_RECUPERAR_SENHA_SER, CodedValues.TPC_SIM, responsavel);

            // Caso o módulo de recuperação de senha do servidor esteja habilitado e o email do servidor tenha sido alterado, enviar email para o servidor
            if (enviaEmail && !desabilitarEnvioCadastroEmailMobileSer && habilitaModuloRecuperarSenhaSer && merge.getAtributos().containsKey(Columns.SER_EMAIL) && !TextHelper.isNull(merge.getAttribute(Columns.SER_EMAIL)) && !CodedValues.FUN_AUTO_CADASTRO_SENHA_SERVIDOR.equals(responsavel.getFunCodigo())) {
                try {
                    EnviaEmailHelper.enviarEmailCadastroSenhaSer((String) merge.getAttribute(Columns.SER_EMAIL), responsavel);
                } catch (final ViewHelperException e) {
                    LOG.error("Erro ao enviar e-mail na alteração de email de " + ApplicationResourcesHelper.getMessage("rotulo.servidor.singular", responsavel).toLowerCase() + " no módulo de recuperação de senha.", e);
                }
            }

            // Cria ocorrência de alteração dos dados cadastrais
            if (msgOcs.length() > 0) {
                criaOcorrenciaSER(servidorBean.getSerCodigo(), tocCodigo, ApplicationResourcesHelper.getMessage("mensagem.informacao.dados.cadastrais.foram.alterados", responsavel, msgOcs.toString()), null, responsavel);
            }

            if (cpfModificado) {
                bloqueiaUsuarioCsaComCPFServidor(servidorBean.getSerCpf(), responsavel);
            }
            final StringBuilder corpoEmailSer = new StringBuilder();
            // Envia e-mail de notificação à todas CSA/COR que possuem contratos ativos com este servidor
            if (responsavel.isCseOrg() && (CodedValues.FUN_EDT_SERVIDOR.equals(responsavel.getFunCodigo()) || CodedValues.FUN_VALIDAR_SERVIDOR.equals(responsavel.getFunCodigo())) && ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_NOTIFICACAO_EDT_SERVIDOR, CodedValues.TPC_SIM, responsavel) && (((merge.getAtributos().size() == 1) && !merge.getAtributos().containsKey(Columns.SER_DATA_ALTERACAO)) || (merge.getAtributos().size() > 1))) {
                try {
                    if (enviaEmail) {
                        EnviaEmailHelper.enviarEmailCsasAlteracaoSer(servidorCache, servidorBean.getSerCpf(), null, null, msgOcs.toString(), responsavel);
                    }
                    corpoEmailSer.append(msgOcs);
                } catch (final Exception ex) {
                    LOG.error(ex.getMessage(), ex);
                }
            }

            log.write();
            if (enviaEmail) {
                return "";
            } else {
                return corpoEmailSer.toString();
            }
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final FindException | UpdateException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Bloqueia usuarios de consignataria ou correspondente que tenham mesmo CPF de um servidor.
     * @param serCpf CPF do servidor.
     * @param responsavel Responsavel pela operacao.
     * @throws ServidorControllerException Excecao padrao.
     */
    private void bloqueiaUsuarioCsaComCPFServidor(String serCpf, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            if (!TextHelper.isNull(serCpf)) {
                usuarioController.bloqueiaUsuarioCsaComCPFServidor(serCpf, responsavel);
            }
        } catch (final UsuarioControllerException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /*****************************************************************************/

    /************************ REGISTRO SERVIDOR **********************************/

    @Override
    public RegistroServidorTO findRegistroServidor(String rseCodigo, boolean retornaMargem, AcessoSistema responsavel) throws ServidorControllerException {
        return findRegistroServidor(new RegistroServidorTO(rseCodigo), retornaMargem, responsavel);
    }

    @Override
    public RegistroServidorTO findRegistroServidor(RegistroServidorTO registroServidor, AcessoSistema responsavel) throws ServidorControllerException {
        return findRegistroServidor(registroServidor, false, responsavel);
    }

    @Override
    public RegistroServidorTO findRegistroServidor(RegistroServidorTO registroServidor, boolean retornaMargem, AcessoSistema responsavel) throws ServidorControllerException {
        return RegistroServidorDtoAssembler.createDto(findRegistroServidorBean(registroServidor), retornaMargem);
    }

    @Override
    public RegistroServidorTO findRegistroServidor(String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        return findRegistroServidor(new RegistroServidorTO(rseCodigo), true, responsavel);
    }

    private RegistroServidor findRegistroServidorBean(RegistroServidorTO registroServidor) throws ServidorControllerException {
        RegistroServidor rseBean = null;

        if (registroServidor.getRseCodigo() != null) {
            try {
                rseBean = RegistroServidorHome.findByPrimaryKey(registroServidor.getRseCodigo());
            } catch (final FindException ex) {
                throw new ServidorControllerException("mensagem.erro.nenhum.registro.servidor.encontrado", (AcessoSistema) null);
            }
        } else if ((registroServidor.getOrgCodigo() != null) && (registroServidor.getRseMatricula() != null)) {
            try {
                rseBean = RegistroServidorHome.findByMatriculaOrgao(registroServidor.getRseMatricula(), registroServidor.getOrgCodigo());
            } catch (final FindException ex) {
                throw new ServidorControllerException("mensagem.erro.nenhum.registro.servidor.encontrado", (AcessoSistema) null);
            }
        } else {
            throw new ServidorControllerException("mensagem.erro.nenhum.registro.servidor.encontrado", (AcessoSistema) null);
        }

        return rseBean;
    }

    @Override
    public List<RegistroServidorTO> findRegistroServidorBySerCodigo(String serCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final List<RegistroServidor> rseEntities = RegistroServidorHome.findBySerCodigo(serCodigo);
            if ((rseEntities != null) && !rseEntities.isEmpty()) {
                final List<RegistroServidorTO> rseList = new ArrayList<>(rseEntities.size());
                for (final RegistroServidor rseEntity : rseEntities) {
                    rseList.add(RegistroServidorDtoAssembler.createDto(rseEntity, false));
                }
                return rseList;
            }
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
        return null;
    }

    @Override
    public void updateRegistroServidorSemHistoricoMargem(RegistroServidorTO registroServidor, AcessoSistema responsavel) throws ServidorControllerException {
        updateRegistroServidor(registroServidor, null, false, false, false, false, false, true, responsavel);
    }

    @Override
    public void updateRegistroServidorSemHistoricoMargem(RegistroServidorTO registroServidor, boolean importacaoTransferidos, AcessoSistema responsavel) throws ServidorControllerException {
        updateRegistroServidor(registroServidor, null, false, false, false, false, importacaoTransferidos, true, responsavel);
    }

    @Override
    public void updateRegistroServidor(RegistroServidorTO registroServidor, boolean validaMargem, boolean calculaMargem, boolean transferenciaMargem, AcessoSistema responsavel) throws ServidorControllerException {
        updateRegistroServidor(registroServidor, null, validaMargem, calculaMargem, transferenciaMargem, true, responsavel);
    }

    @Override
    public void updateRegistroServidor(RegistroServidorTO registroServidor, List<MargemTO> margens, boolean validaMargem, boolean calculaMargem, boolean transferenciaMargem, AcessoSistema responsavel) throws ServidorControllerException {
        updateRegistroServidor(registroServidor, margens, validaMargem, calculaMargem, transferenciaMargem, true, responsavel);
    }

    @Override
    public void updateRegistroServidor(RegistroServidorTO registroServidor, List<MargemTO> margens, boolean validaMargem, boolean calculaMargem, boolean transferenciaMargem, boolean geraHistoricoMargem, AcessoSistema responsavel) throws ServidorControllerException {
        updateRegistroServidor(registroServidor, margens, validaMargem, calculaMargem, transferenciaMargem, geraHistoricoMargem, false, true, responsavel);
    }

    private String updateRegistroServidor(RegistroServidorTO registroServidor, List<MargemTO> margens, boolean validaMargem, boolean calculaMargem, boolean transferenciaMargem, boolean geraHistoricoMargem, boolean importacaoTransferidos, boolean enviaEmail, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            boolean reativaServidorManualmente = false;
            boolean excluiServidorManualmente = false;
            boolean bloqueiaServidorManualmente = false;
            boolean desbloqueiaServidorManualmente = false;
            boolean falecimentoAutomaticoServidor = false;
            boolean falecimentoManualServidor = false;

            final RegistroServidor rseBean = findRegistroServidorBean(registroServidor);
            final String rseCodigo = rseBean.getRseCodigo();
            final LogDelegate log = new LogDelegate(responsavel, Log.REGISTRO_SERVIDOR, Log.UPDATE, Log.LOG_INFORMACAO);
            log.setRegistroServidor(rseCodigo);

            final AcessoSistema loggerMargem = new AcessoSistema(responsavel.getUsuCodigo(), responsavel.getIpUsuario(), responsavel.getPortaLogicaUsuario());
            loggerMargem.setFunCodigo(CodedValues.FUN_ALT_MARGEM_CONSIGNAVEL);
            final LogDelegate logMargem = new LogDelegate(loggerMargem, Log.REGISTRO_SERVIDOR, Log.UPDATE, Log.LOG_INFORMACAO);
            logMargem.setRegistroServidor(rseCodigo);

            // Guarda os valores originais das margens restantes para gravação do histórico
            final BigDecimal margemRest1Antes = rseBean.getRseMargemRest();
            final BigDecimal margemRest2Antes = rseBean.getRseMargemRest2();
            final BigDecimal margemRest3Antes = rseBean.getRseMargemRest3();

            // Guarda os valores das margens restantes para gravação do histórico
            final HashMap<Short, BigDecimal> margemRestAntes = new HashMap<>();
            final HashMap<Short, BigDecimal> margemRestDepois = new HashMap<>();

            final StringBuilder msgOrs = new StringBuilder();
            final StringBuilder margemAlterada = new StringBuilder();

            final boolean exigeDetalhesExclusao = ParamSist.paramEquals(CodedValues.TPC_EXIGE_DETALHES_EXCL_BLOQ_SER, CodedValues.TPC_SIM, responsavel);

            /* Compara a versão do cache com a passada por parâmetro */
            final RegistroServidorTO rseCache = RegistroServidorDtoAssembler.createDto(rseBean, true);
            final CustomTransferObject merge = log.getUpdatedFields(registroServidor.getAtributos(), rseCache.getAtributos());

            if ((merge.getAttribute(Columns.TMO_CODIGO) != null) && TextHelper.isNull(merge.getAttribute(Columns.TMO_CODIGO).toString().trim())) {
                merge.remove(Columns.TMO_CODIGO);
            }
            if ((merge.getAttribute(Columns.OCA_OBS) != null) && TextHelper.isNull(merge.getAttribute(Columns.OCA_OBS).toString().trim())) {
                merge.remove(Columns.OCA_OBS);
            }

            if (merge.getAtributos().containsKey(Columns.RSE_MATRICULA) || merge.getAtributos().containsKey(Columns.RSE_ORG_CODIGO)) {
                // Verifica se não existe outro registro com a mesma matrícula no mesmo órgão
                final RegistroServidorTO teste = new RegistroServidorTO();

                if (merge.getAtributos().containsKey(Columns.RSE_MATRICULA)) {
                    teste.setRseMatricula((String) merge.getAttribute(Columns.RSE_MATRICULA));
                } else {
                    teste.setRseMatricula(rseBean.getRseMatricula());
                }

                if (merge.getAtributos().containsKey(Columns.RSE_ORG_CODIGO)) {
                    teste.setOrgCodigo((String) merge.getAttribute(Columns.RSE_ORG_CODIGO));
                } else {
                    teste.setOrgCodigo(rseBean.getOrgao().getOrgCodigo());
                }

                boolean existe = false;
                try {
                    findRegistroServidorBean(teste);
                    existe = true;
                } catch (final ServidorControllerException ex) {
                }
                if (existe) {
                    throw new ServidorControllerException("mensagem.erro.nao.possivel.alterar.registro.deste.servidor.pois.existe.outro.com.mesma.matricula.orgao.cadastrado.sistema", responsavel);
                }

                if (merge.getAtributos().containsKey(Columns.RSE_MATRICULA)) {
                    msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.matricula.alterada.de.arg0.para.arg1", responsavel, rseBean.getRseMatricula(), (String) merge.getAttribute(Columns.RSE_MATRICULA)));
                    rseBean.setRseMatricula((String) merge.getAttribute(Columns.RSE_MATRICULA));
                }

                if (merge.getAtributos().containsKey(Columns.RSE_ORG_CODIGO)) {
                    final String orgCodigoOld = rseBean.getOrgao().getOrgCodigo();
                    final String orgCodigoNew = (String) merge.getAttribute(Columns.RSE_ORG_CODIGO);

                    if (ParamSist.paramEquals(CodedValues.TPC_PERMITE_EDITAR_ORGAO_SERVIDOR, CodedValues.TPC_SIM, responsavel)) {
                        // Verificar se o novo órgão possui os mesmos convênios que o órgão atual, inclusive se possui código de verba válido (não nulo, não vazio).
                        final ObtemTotalConsignacaoSemConvenioTransfQuery validaTransferenciaQuery = new ObtemTotalConsignacaoSemConvenioTransfQuery();
                        validaTransferenciaQuery.rseCodigo = rseCodigo;
                        validaTransferenciaQuery.orgCodigo = orgCodigoNew;
                        if (validaTransferenciaQuery.executarContador() > 0) {
                            // Caso não exista algum convênio ou exista, porém sem código de verba, interromper a operação e alertar o usuário
                            // a impossibilidade de alteração em virtude de falta de convênio no órgão novo para as consignações que o servidor possui.
                            throw new ServidorControllerException("mensagem.erro.nao.possivel.alterar.orgao.servidor.convenios.faltantes", responsavel);
                        }

                        // Caso o registro servidor possua um bloqueio de verba ou uma consignação arquivada, interromper a operação
                        // e alertar o usuário a impossibilidade de alteração com a causa do problema.
                        final List<ParamConvenioRegistroSer> bloqueiosCnv = ParamConvenioRegistroServidorHome.findByRseCodigo(rseCodigo);
                        if ((bloqueiosCnv != null) && !bloqueiosCnv.isEmpty()) {
                            throw new ServidorControllerException("mensagem.erro.nao.possivel.alterar.orgao.servidor.possui.bloqueios", responsavel);
                        }

                        final List<HtAutDesconto> consignacoesArquivadas = AutDescontoHome.findArquivadasByRseCodigo(rseCodigo);
                        if ((consignacoesArquivadas != null) && !consignacoesArquivadas.isEmpty()) {
                            throw new ServidorControllerException("mensagem.erro.nao.possivel.alterar.orgao.servidor.possui.consignacoes.arquivadas", responsavel);
                        }

                        // Alterar o órgão do registro servidor
                        final Orgao orgaoOld = OrgaoHome.findByPrimaryKey(orgCodigoOld);
                        final Orgao orgaoNew = OrgaoHome.findByPrimaryKey(orgCodigoNew);
                        rseBean.setOrgao(orgaoNew);

                        // Registra na ocorrência geral de alteração
                        final String mensagemAlteracaoOrgao = ApplicationResourcesHelper.getMessage("mensagem.informacao.orgao.alterado.de.arg0.para.arg1", responsavel, orgaoOld.getOrgIdentificador(), orgaoNew.getOrgIdentificador());
                        msgOrs.append(mensagemAlteracaoOrgao);

                        // Registra no log de auditoria a alteração do órgão
                        log.setOrgao(orgCodigoNew);

                        // Registrar ocorrência específica de alteração de órgão
                        criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_ALTERACAO_ORGAO_SERVIDOR, mensagemAlteracaoOrgao, registroServidor.getTipoMotivo(), responsavel);

                        // Atualizar os convênios das consignações do servidor para o correspondente no novo órgão e criar ocorrência nas consignações
                        transferirConsignacaoController.transfereAdeNovoOrgao(rseCodigo, orgCodigoNew, registroServidor.getTipoMotivo(), mensagemAlteracaoOrgao, responsavel);
                    } else {
                        throw new ServidorControllerException("mensagem.erro.nao.possivel.alterar.orgao.servidor.sistema.nao.permite", responsavel);
                    }
                }
            }

            if (merge.getAtributos().containsKey(Columns.RSE_TIPO)) {
                final String tipoOld = rseBean.getRseTipo() != null ? rseBean.getRseTipo() : "";
                final String tipoNew = merge.getAttribute(Columns.RSE_TIPO) != null ? (String) merge.getAttribute(Columns.RSE_TIPO) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.tipo.alterado.de.arg0.para.arg1", responsavel, tipoOld, tipoNew));
                rseBean.setRseTipo((String) merge.getAttribute(Columns.RSE_TIPO));
            }
            if (merge.getAtributos().containsKey(Columns.SRS_CODIGO)) {
                final StatusRegistroServidor srs = StatusRegistroServidorHome.findByPrimaryKey((String) merge.getAttribute(Columns.SRS_CODIGO));
                final StatusRegistroServidor srsAntigo = StatusRegistroServidorHome.findByPrimaryKey(rseBean.getStatusRegistroServidor().getSrsCodigo());
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.situacao.alterado.de.arg0.para.arg1", responsavel, srsAntigo.getSrsDescricao(), srs.getSrsDescricao()));
                rseBean.setStatusRegistroServidor(srs);
                if (!TextHelper.isNull(merge.getAttribute(Columns.SRS_CODIGO))) {
                    log.setStatusRseCodigo((String) merge.getAttribute(Columns.SRS_CODIGO));
                }
                if (!importacaoTransferidos) {
                    // Se o status foi alterado, e o flag "importacaoTransferidos" não está setado
                    // significa que é uma alteração manual, feita na página de manutenção de servidor
                    if (CodedValues.SRS_INATIVOS.contains(srs.getSrsCodigo())) {
                        // Coloca true no flag "excluiServidorManualmente" para que seja criada a ocorrência de exclusão do servidor.
                        if (CodedValues.SRS_EXCLUIDO.equals(srs.getSrsCodigo())) {
                            excluiServidorManualmente = true;
                        } else if (CodedValues.FUN_IMP_SER_FALECIDO.equals(responsavel.getFunCodigo())) {
                            falecimentoAutomaticoServidor = true;
                        } else {
                            falecimentoManualServidor = true;
                        }
                        // Coloca null na data carga para permitir transferência de servidor
                        rseBean.setRseDataCarga(null);
                    } else if (CodedValues.SRS_ATIVO.equals(srs.getSrsCodigo()) && CodedValues.SRS_INATIVOS.contains(srsAntigo.getSrsCodigo())) {
                        // Se está indo para ativo, mas estava excluído
                        reativaServidorManualmente = true;
                    } else if (CodedValues.SRS_ATIVO.equals(srs.getSrsCodigo()) && CodedValues.SRS_BLOQUEADOS.contains(srsAntigo.getSrsCodigo())) {
                        // Se está indo para ativo, mas estava bloqueado
                        desbloqueiaServidorManualmente = true;
                    } else if (CodedValues.SRS_BLOQUEADO.equals(srs.getSrsCodigo()) && CodedValues.SRS_ATIVOS.contains(srsAntigo.getSrsCodigo())) {
                        // Se está indo para bloqueado, mas estava ativo
                        bloqueiaServidorManualmente = true;
                    }
                }

                // Se está mudando o status do servidor e está bloqueado por segurança, só o suporte pode fazer a operação
                // Não permite alteração do status do servidor caso bloqueado por segurança pela variação de margem
                if ((CodedValues.SRS_BLOQUEADO_AUTOMATICAMENTE_SEGURANCA.equals(srsAntigo.getSrsCodigo()) && !responsavel.isSup()) || CodedValues.SRS_BLOQUEADO_AUTOMATICAMENTE_VARIACAO_MARGEM.equals(srsAntigo.getSrsCodigo())) {
                    throw new ServidorControllerException("mensagem.erro.nao.possivel.desbloquear.servidor.arg0.pois.foi.bloqueado.por.seguranca", responsavel, rseBean.getRseMatricula());
                }

                if (exigeDetalhesExclusao && (excluiServidorManualmente || bloqueiaServidorManualmente) && !CodedValues.FUN_VALIDAR_SERVIDOR.equals(responsavel.getFunCodigo())) {
                    // No caso de servidor/funcionário Desligado (Excluído), o sistema deve obrigar o preenchimento da data de saída e a data do último salário
                    if (CodedValues.SRS_EXCLUIDO.equals(srs.getSrsCodigo()) || CodedValues.SRS_BLOQUEADO.equals(srs.getSrsCodigo())) {
                        if (!merge.getAtributos().containsKey(Columns.RSE_DATA_SAIDA) && (rseBean.getRseDataSaida() == null)) {
                            throw new ServidorControllerException("mensagem.erro.atualizar.data.saida", responsavel);
                        } else if (!merge.getAtributos().containsKey(Columns.RSE_DATA_ULT_SALARIO) && (rseBean.getRseDataUltSalario() == null)) {
                            throw new ServidorControllerException("mensagem.erro.atualizar.data.ultimo.salario", responsavel);
                        }
                    }

                    // No caso de servidor/funcionário Desligado (Excluído), o sistema deve obrigar o preenchimento da data de saída, data de retorno e a data do último salário
                    if (CodedValues.SRS_BLOQUEADO.equals(srs.getSrsCodigo()) && (!merge.getAtributos().containsKey(Columns.RSE_DATA_RETORNO) && (rseBean.getRseDataRetorno() == null))) {
                        throw new ServidorControllerException("mensagem.erro.atualizar.data.retorno", responsavel);
                    }
                }
            }

            //DESENV-16129 - Rio de Janeiro - Mostrar Motivo de Bloqueio do Servidor
            if ((merge.getAtributos().containsKey(Columns.SRS_CODIGO) && CodedValues.SRS_BLOQUEADO.equals(merge.getAttribute(Columns.SRS_CODIGO))) ||  CodedValues.SRS_BLOQUEADO.equals(rseBean.getStatusRegistroServidor().getSrsCodigo())) {
                if (merge.getAtributos().containsKey(Columns.RSE_MOTIVO_BLOQUEIO)) {
                    rseBean.setRseMotivoBloqueio((String) merge.getAttribute(Columns.RSE_MOTIVO_BLOQUEIO));
                } else {
                    rseBean.setRseMotivoBloqueio(null);
                }
            } else if (((merge.getAtributos().containsKey(Columns.SRS_CODIGO) && CodedValues.SRS_ATIVO.equals(merge.getAttribute(Columns.SRS_CODIGO))) || CodedValues.SRS_ATIVO.equals(rseBean.getStatusRegistroServidor().getSrsCodigo())) && !merge.getAtributos().containsKey(Columns.RSE_MOTIVO_BLOQUEIO)) {
                rseBean.setRseMotivoBloqueio(null);
            }

            if (merge.getAtributos().containsKey(Columns.VRS_CODIGO)) {
                final VinculoRegistroServidor vrs = merge.getAttribute(Columns.VRS_CODIGO) != null ? VinculoRegistroServidorHome.findByPrimaryKey((String) merge.getAttribute(Columns.VRS_CODIGO)) : null;
                final String vinculoOld = rseBean.getVinculoRegistroServidor() != null ? rseBean.getVinculoRegistroServidor().getVrsCodigo() : "";
                final String vinculoNew = (vrs != null) && (vrs.getVrsCodigo() != null) ? vrs.getVrsCodigo() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.vinculo.alterado.de.arg0.para.arg1", responsavel, vinculoOld, vinculoNew));
                rseBean.setVinculoRegistroServidor(vrs);
                if (!TextHelper.isNull(merge.getAttribute(Columns.VRS_CODIGO))) {
                    log.setVincRseCodigo((String) merge.getAttribute(Columns.VRS_CODIGO));
                }
            }
            if (merge.getAtributos().containsKey(Columns.RSE_CLT)) {
                final String cltOld = rseBean.getRseClt() != null ? rseBean.getRseClt() : "";
                final String cltNew = merge.getAttribute(Columns.RSE_CLT) != null ? (String) merge.getAttribute(Columns.RSE_CLT) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.sindicalizado.alterado.de.arg0.para.arg1", responsavel, cltOld, cltNew));
                rseBean.setRseClt((String) merge.getAttribute(Columns.RSE_CLT));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_PRAZO)) {
                final String prazoOld = rseBean.getRsePrazo() != null ? rseBean.getRsePrazo().toString() : "";
                final String prazoNew = merge.getAttribute(Columns.RSE_PRAZO) != null ? merge.getAttribute(Columns.RSE_PRAZO).toString() : "";
                msgOrs.append("<BR>").append(ApplicationResourcesHelper.getMessage("mensagem.informacao.prazo.alterado.de.arg0.para.arg1", responsavel, prazoOld, prazoNew));
                rseBean.setRsePrazo((Integer) merge.getAttribute(Columns.RSE_PRAZO));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_DATA_ADMISSAO)) {
                final String dataOld = rseBean.getRseDataAdmissao() != null ? DateHelper.toDateString(rseBean.getRseDataAdmissao()) : "";
                final String dataNew = merge.getAttribute(Columns.RSE_DATA_ADMISSAO) != null ? DateHelper.toDateString((Timestamp) merge.getAttribute(Columns.RSE_DATA_ADMISSAO)) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.admissao.alterada.de.arg0.para.arg1", responsavel, dataOld, dataNew));
                rseBean.setRseDataAdmissao((Timestamp) merge.getAttribute(Columns.RSE_DATA_ADMISSAO));
            }
            if (merge.getAtributos().containsKey(Columns.CRS_CODIGO)) {
                final CargoRegistroServidor crs = merge.getAttribute(Columns.CRS_CODIGO) != null ? CargoRegistroServidorHome.findByPrimaryKey((String) merge.getAttribute(Columns.CRS_CODIGO)) : null;
                final String cargoOld = rseBean.getCargoRegistroServidor() != null ? rseBean.getCargoRegistroServidor().getCrsCodigo() : "";
                final String cargoNew = (crs != null) && (crs.getCrsCodigo() != null) ? crs.getCrsCodigo() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.cargo.alterado.de.arg0.para.arg1", responsavel, cargoOld, cargoNew));
                rseBean.setCargoRegistroServidor(crs);
                if (!TextHelper.isNull(merge.getAttribute(Columns.CRS_CODIGO))) {
                    log.setCargoRseCodigo((String) merge.getAttribute(Columns.CRS_CODIGO));
                }
            }
            if (merge.getAtributos().containsKey(Columns.PRS_CODIGO)) {
                final PadraoRegistroServidor prs = merge.getAttribute(Columns.PRS_CODIGO) != null ? PadraoRegistroServidorHome.findByPrimaryKey((String) merge.getAttribute(Columns.PRS_CODIGO)) : null;
                final String padraoOld = rseBean.getPadraoRegistroServidor() != null ? rseBean.getPadraoRegistroServidor().getPrsCodigo() : "";
                final String padraoNew = (prs != null) && (prs.getPrsCodigo() != null) ? prs.getPrsCodigo() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.padrao.alterado.de.arg0.para.arg1", responsavel, padraoOld, padraoNew));
                rseBean.setPadraoRegistroServidor(prs);
            }
            if (merge.getAtributos().containsKey(Columns.SBO_CODIGO)) {
                final SubOrgao sbo = merge.getAttribute(Columns.SBO_CODIGO) != null ? SubOrgaoHome.findByPrimaryKey((String) merge.getAttribute(Columns.SBO_CODIGO)) : null;
                final String subOrgaoOld = rseBean.getSubOrgao() != null ? rseBean.getSubOrgao().getSboCodigo() : "";
                final String subOrgaoNew = (sbo != null) && (sbo.getSboCodigo() != null) ? sbo.getSboCodigo() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.suborgao.alterado.de.arg0.para.arg1", responsavel, subOrgaoOld, subOrgaoNew));
                rseBean.setSubOrgao(sbo);
            }
            if (merge.getAtributos().containsKey(Columns.UNI_CODIGO)) {
                final Unidade uni = merge.getAttribute(Columns.UNI_CODIGO) != null ? UnidadeHome.findByPrimaryKey((String) merge.getAttribute(Columns.UNI_CODIGO)) : null;
                final String unidadeOld = rseBean.getUnidade() != null ? rseBean.getUnidade().getUniCodigo() : "";
                final String unidadeNew = (uni != null) && (uni.getUniCodigo() != null) ? uni.getUniCodigo() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.unidade.alterada.de.arg0.para.arg1", responsavel, unidadeOld, unidadeNew));
                rseBean.setUnidade(uni);
            }

            final Map<String, Object> margensNew = new HashMap<>();
            final Map<String, Object> margensOld = new HashMap<>();
            if (merge.getAtributos().containsKey(Columns.RSE_MARGEM)) {
                final BigDecimal margem = rseBean.getRseMargem() != null ? rseBean.getRseMargem() : new BigDecimal("0.00");
                final BigDecimal margemUsada = rseBean.getRseMargemUsada() != null ? rseBean.getRseMargemUsada() : new BigDecimal("0.00");
                final BigDecimal nova_margem = (BigDecimal) merge.getAttribute(Columns.RSE_MARGEM);

                margensNew.put(Columns.RSE_MARGEM, nova_margem);
                margensOld.put(Columns.RSE_MARGEM, margem);

                if (validaMargem) {
                    if (margem.compareTo(nova_margem) == -1) {
                        // Se a margem está sendo aumentada
                        throw new ServidorControllerException("mensagem.erro.nova.margem.arg0.nao.pode.ser.maior.arg0.atual", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM, responsavel));
                    } else if (nova_margem.compareTo(margemUsada) == -1) {
                        // Se a nova margem é menor do que a margem usada
                        throw new ServidorControllerException("mensagem.erro.nova.margem.arg0.nao.pode.ser.menor.arg0.usada", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM, responsavel));
                    }
                }
                margemAlterada.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.arg0.alterada.de.arg1.para.arg2", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM, responsavel).toUpperCase(), rseBean.getRseMargem().toString(), nova_margem.toString()));

                // Atribui a nova margem
                rseBean.setRseMargem(nova_margem);

                // Se calculaMargem é igual a true, a margem restante do servidor será o valor
                // da margem informada subtraída do valor da margem usada atual
                if (calculaMargem) {
                    rseBean.setRseMargemRest(((BigDecimal) merge.getAttribute(Columns.RSE_MARGEM)).subtract(margemUsada));

                } else if (transferenciaMargem) { // Na transferencia, a margem restante foi informada no TO registroServidor
                    rseBean.setRseMargemRest((BigDecimal) merge.getAttribute(Columns.RSE_MARGEM_REST));

                } else {
                    rseBean.setRseMargemRest(nova_margem);
                }
            }

            if (merge.getAtributos().containsKey(Columns.RSE_MARGEM_2)) {
                final BigDecimal margem2 = rseBean.getRseMargem2() != null ? rseBean.getRseMargem2() : new BigDecimal("0.00");
                final BigDecimal margemUsada2 = rseBean.getRseMargemUsada2() != null ? rseBean.getRseMargemUsada2() : new BigDecimal("0.00");
                final BigDecimal nova_margem_2 = (BigDecimal) merge.getAttribute(Columns.RSE_MARGEM_2);

                margensNew.put(Columns.RSE_MARGEM_2, nova_margem_2);
                margensOld.put(Columns.RSE_MARGEM_2, margem2);

                if (validaMargem) {
                    if (margem2.compareTo(nova_margem_2) == -1) {
                        // Se a margem está sendo aumentada
                        throw new ServidorControllerException("mensagem.erro.nova.margem.arg0.nao.pode.ser.maior.arg0.atual", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM_2, responsavel));
                    } else if (nova_margem_2.compareTo(margemUsada2) == -1) {
                        // Se a nova margem é menor do que a margem usada
                        throw new ServidorControllerException("mensagem.erro.nova.margem.arg0.nao.pode.ser.menor.arg0.usada", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM_2, responsavel));
                    }
                }
                margemAlterada.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.arg0.alterada.de.arg1.para.arg2", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM_2, responsavel).toUpperCase(), rseBean.getRseMargem2() != null ? rseBean.getRseMargem2().toString() : "0.00", nova_margem_2.toString()));

                // Atribui a nova margem
                rseBean.setRseMargem2(nova_margem_2);

                // Se calculaMargem é igual a true, a margem restante do servidor será o valor
                // da margem informada subtraída do valor da margem usada atual
                if (calculaMargem) {
                    rseBean.setRseMargemRest2(((BigDecimal) merge.getAttribute(Columns.RSE_MARGEM_2)).subtract(margemUsada2));

                } else if (transferenciaMargem) { // Na transferencia, a margem restante foi informada no TO registroServidor
                    rseBean.setRseMargemRest2((BigDecimal) merge.getAttribute(Columns.RSE_MARGEM_REST_2));

                } else {
                    rseBean.setRseMargemRest2(nova_margem_2);
                }
            }

            if (merge.getAtributos().containsKey(Columns.RSE_MARGEM_3)) {
                final BigDecimal margem3 = rseBean.getRseMargem3() != null ? rseBean.getRseMargem3() : new BigDecimal("0.00");
                final BigDecimal margemUsada3 = rseBean.getRseMargemUsada3() != null ? rseBean.getRseMargemUsada3() : new BigDecimal("0.00");
                final BigDecimal nova_margem_3 = (BigDecimal) merge.getAttribute(Columns.RSE_MARGEM_3);

                margensNew.put(Columns.RSE_MARGEM_3, nova_margem_3);
                margensOld.put(Columns.RSE_MARGEM_3, margem3);

                if (validaMargem) {
                    if (margem3.compareTo(nova_margem_3) == -1) {
                        // Se a margem está sendo aumentada
                        throw new ServidorControllerException("mensagem.erro.nova.margem.arg0.nao.pode.ser.maior.arg0.atual", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM_3, responsavel));
                    } else if (nova_margem_3.compareTo(margemUsada3) == -1) {
                        // Se a nova margem é menor do que a margem usada
                        throw new ServidorControllerException("mensagem.erro.nova.margem.arg0.nao.pode.ser.menor.arg0.usada", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM_3, responsavel));
                    }
                }
                margemAlterada.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.arg0.alterada.de.arg1.para.arg2", responsavel, MargemHelper.getInstance().getMarDescricao(CodedValues.INCIDE_MARGEM_SIM_3, responsavel).toUpperCase(), rseBean.getRseMargem3() != null ? rseBean.getRseMargem3().toString() : "0.00", nova_margem_3.toString()));

                // Atribui a nova margem
                rseBean.setRseMargem3(nova_margem_3);

                // Se calculaMargem é igual a true, a margem restante do servidor será o valor
                // da margem informada subtraída do valor da margem usada atual
                if (calculaMargem) {
                    rseBean.setRseMargemRest3(((BigDecimal) merge.getAttribute(Columns.RSE_MARGEM_3)).subtract(margemUsada3));

                } else if (transferenciaMargem) { // Na transferencia, a margem restante foi informada no TO registroServidor
                    rseBean.setRseMargemRest3((BigDecimal) merge.getAttribute(Columns.RSE_MARGEM_REST_3));

                } else {
                    rseBean.setRseMargemRest3(nova_margem_3);
                }
            }

            logMargem.getUpdatedFields(margensNew, margensOld);

            if ((margens != null) && (margens.size() > 0)) {
                for (final MargemTO margemTO : margens) {
                    // Não se aplica se a margem é 1,2 ou 3
                    if (margemTO.getMarCodigo().equals((short) 1) || margemTO.getMarCodigo().equals((short) 2) || margemTO.getMarCodigo().equals((short) 3)) {
                        continue;
                    }

                    final MargemRegistroServidorId mrsPK = new MargemRegistroServidorId(margemTO.getMarCodigo(), rseCodigo);
                    final MargemRegistroServidor mrsBean = MargemRegistroServidorHome.findByPrimaryKeyForUpdate(mrsPK);

                    final BigDecimal margemAntigaFolha = mrsBean.getMrsMargem();
                    final BigDecimal margemAntigaUsada = mrsBean.getMrsMargemUsada() != null ? mrsBean.getMrsMargemUsada() : new BigDecimal("0.00");
                    final BigDecimal margemNovaFolha = margemTO.getMrsMargem() != null ? margemTO.getMrsMargem() : new BigDecimal("0.00");

                    // Se nada mudou, pula para a próxima margem
                    if (margemAntigaFolha.compareTo(margemNovaFolha) == 0) {
                        continue;
                    }

                    if (validaMargem) {
                        if (margemAntigaFolha.compareTo(margemNovaFolha) == -1) {
                            // Se a margem está sendo aumentada
                            throw new ServidorControllerException("mensagem.erro.nova.margem.arg0.nao.pode.ser.maior.arg0.atual", responsavel, MargemHelper.getInstance().getMarDescricao(margemTO.getMarCodigo(), responsavel));
                        } else if (margemNovaFolha.compareTo(margemAntigaUsada) == -1) {
                            // Se a nova margem é menor do que a margem usada
                            throw new ServidorControllerException("mensagem.erro.nova.margem.arg0.nao.pode.ser.menor.arg0.usada", responsavel, MargemHelper.getInstance().getMarDescricao(margemTO.getMarCodigo(), responsavel));
                        }
                    }

                    // Adiciona a alteração ao log
                    logMargem.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.atributo.margem.arg0.folha.alterado.arg1.para.arg2", responsavel, margemTO.getMarCodigo().toString(), logMargem.formatObject(margemAntigaFolha), logMargem.formatObject(margemNovaFolha)));

                    // Se calculaMargem é igual a true, a margem restante do servidor será o valor
                    // da margem informada subtraída do valor da margem usada atual
                    margemRestAntes.put(margemTO.getMarCodigo(), mrsBean.getMrsMargemRest());
                    BigDecimal margemRest = null;
                    if (calculaMargem) {
                        margemRest = margemNovaFolha.subtract(margemAntigaUsada);
                        // Falta tratar transferência
                    } else {
                        margemRest = margemNovaFolha;
                    }
                    margemRestDepois.put(margemTO.getMarCodigo(), margemRest);
                    margemAlterada.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.arg0.alterada.de.arg1.para.arg2", responsavel, MargemHelper.getInstance().getMarDescricao(margemTO.getMarCodigo(), responsavel).toUpperCase(), margemAntigaFolha.toString(), margemNovaFolha.toString()));

                    mrsBean.setMrsMargem(margemNovaFolha);
                    mrsBean.setMrsMargemRest(margemRest);
                    AbstractEntityHome.update(mrsBean);
                }
            }
            // Calcula a pontuação do servidor, pois a margem pode ter sido alterada
            try {
                pontuacaoServidorController.calcularPontuacao(rseCodigo, responsavel);
            } catch (final ZetraException e) {
                // Captura a exceção para não gerar efeitos colaterais indesejados
                LOG.error(e.getMessage(), e);
            }

            // Grava dados sobre a conta salário do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_BCO_CODIGO)) {
                final Banco bct = merge.getAttribute(Columns.RSE_BCO_CODIGO) != null ? BancoHome.findByPrimaryKey((Short) merge.getAttribute(Columns.RSE_BCO_CODIGO)) : null;
                final String bcoCodOld = rseBean.getBanco() != null ? rseBean.getBanco().getBcoCodigo().toString() : "";
                final String bcoCodNew = (bct != null) && (bct.getBcoCodigo() != null) ? bct.getBcoCodigo().toString() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.codigo.banco.alterado.de.arg0.para.arg1", responsavel, bcoCodOld, bcoCodNew));
                rseBean.setBanco(bct);
            }
            if (merge.getAtributos().containsKey(Columns.RSE_MATRICULA_INST)) {
                final String matriculaInstOld = rseBean.getRseMatriculaInst() != null ? rseBean.getRseMatriculaInst() : "";
                final String matriculaInstNew = merge.getAttribute(Columns.RSE_MATRICULA_INST) != null ? (String) merge.getAttribute(Columns.RSE_MATRICULA_INST) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.matricula.inst.alterada.de.arg0.para.arg1", responsavel, matriculaInstOld, matriculaInstNew));
                rseBean.setRseMatriculaInst((String) merge.getAttribute(Columns.RSE_MATRICULA_INST));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_BASE_CALCULO)) {
                final String baseCalculoOld = rseBean.getRseBaseCalculo() != null ? rseBean.getRseBaseCalculo().toString() : "";
                final String baseCalculoNew = merge.getAttribute(Columns.RSE_BASE_CALCULO) != null ? merge.getAttribute(Columns.RSE_BASE_CALCULO).toString() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.base.calculo.alterada.de.arg0.para.arg1", responsavel, baseCalculoOld, baseCalculoNew));
                rseBean.setRseBaseCalculo((BigDecimal) merge.getAttribute(Columns.RSE_BASE_CALCULO));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_DATA_CTC)) {
                final String dataOld = rseBean.getRseDataCtc() != null ? DateHelper.toDateString(rseBean.getRseDataCtc()) : "";
                final String dataNew = merge.getAttribute(Columns.RSE_DATA_CTC) != null ? DateHelper.toDateString((java.util.Date) merge.getAttribute(Columns.RSE_DATA_CTC)) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.ctc.alterada.de.arg0.para.arg1", responsavel, dataOld, dataNew));
                rseBean.setRseDataCtc((java.util.Date) merge.getAttribute(Columns.RSE_DATA_CTC));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_BANCO_SAL)) {
                final String bancoSalOld = rseBean.getRseBancoSal() != null ? rseBean.getRseBancoSal() : "";
                final String bancoSalNew = merge.getAttribute(Columns.RSE_BANCO_SAL) != null ? (String) merge.getAttribute(Columns.RSE_BANCO_SAL) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.banco.alterado.de.arg0.para.arg1", responsavel, bancoSalOld, bancoSalNew));
                rseBean.setRseBancoSal((String) merge.getAttribute(Columns.RSE_BANCO_SAL));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_AGENCIA_SAL)) {
                final String agenciaSalOld = rseBean.getRseAgenciaSal() != null ? rseBean.getRseAgenciaSal() : "";
                final String agenciaSalONew = merge.getAttribute(Columns.RSE_AGENCIA_SAL) != null ? (String) merge.getAttribute(Columns.RSE_AGENCIA_SAL) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.agencia.alterada.de.arg0.para.arg1", responsavel, agenciaSalOld, agenciaSalONew));
                rseBean.setRseAgenciaSal((String) merge.getAttribute(Columns.RSE_AGENCIA_SAL));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_AGENCIA_DV_SAL)) {
                final String agenciaDvSalOld = rseBean.getRseAgenciaDvSal() != null ? rseBean.getRseAgenciaDvSal() : "";
                final String agenciaDvSalNew = merge.getAttribute(Columns.RSE_AGENCIA_DV_SAL) != null ? (String) merge.getAttribute(Columns.RSE_AGENCIA_DV_SAL) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.agencia.dv.alterado.de.arg0.para.arg1", responsavel, agenciaDvSalOld, agenciaDvSalNew));
                rseBean.setRseAgenciaDvSal((String) merge.getAttribute(Columns.RSE_AGENCIA_DV_SAL));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_CONTA_SAL)) {
                final String contaSalOld = rseBean.getRseContaSal() != null ? rseBean.getRseContaSal() : "";
                final String contaSalNew = merge.getAttribute(Columns.RSE_CONTA_SAL) != null ? (String) merge.getAttribute(Columns.RSE_CONTA_SAL) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.conta.alterada.de.arg0.para.arg1", responsavel, contaSalOld, contaSalNew));
                rseBean.setRseContaSal((String) merge.getAttribute(Columns.RSE_CONTA_SAL));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_CONTA_DV_SAL)) {
                final String contaDvSalOld = rseBean.getRseContaDvSal() != null ? rseBean.getRseContaDvSal() : "";
                final String contaDvSalNew = merge.getAttribute(Columns.RSE_CONTA_DV_SAL) != null ? (String) merge.getAttribute(Columns.RSE_CONTA_DV_SAL) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.conta.dv.alterado.de.arg0.para.arg1", responsavel, contaDvSalOld, contaDvSalNew));
                rseBean.setRseContaDvSal((String) merge.getAttribute(Columns.RSE_CONTA_DV_SAL));
            }

            // Grava informações sobre o salário do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_SALARIO)) {
                final String salarioOld = rseBean.getRseSalario() != null ? rseBean.getRseSalario().toString() : "";
                final String salarioNew = merge.getAttribute(Columns.RSE_SALARIO) != null ? merge.getAttribute(Columns.RSE_SALARIO).toString() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.salario.alterado.de.arg0.para.arg1", responsavel, salarioOld, salarioNew));
                rseBean.setRseSalario((BigDecimal) merge.getAttribute(Columns.RSE_SALARIO));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_PROVENTOS)) {
                final String proventosOld = rseBean.getRseProventos() != null ? rseBean.getRseProventos().toString() : "";
                final String proventosNew = merge.getAttribute(Columns.RSE_PROVENTOS) != null ? merge.getAttribute(Columns.RSE_PROVENTOS).toString() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.proventos.alterados.de.arg0.para.arg1", responsavel, proventosOld, proventosNew));
                rseBean.setRseProventos((BigDecimal) merge.getAttribute(Columns.RSE_PROVENTOS));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_DESCONTOS_COMP)) {
                final String descontosCompOld = rseBean.getRseDescontosComp() != null ? rseBean.getRseDescontosComp().toString() : "";
                final String descontosCompNew = merge.getAttribute(Columns.RSE_DESCONTOS_COMP) != null ? merge.getAttribute(Columns.RSE_DESCONTOS_COMP).toString() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.descontos.compulsorios.alterados.de.arg0.para.arg1", responsavel, descontosCompOld, descontosCompNew));
                rseBean.setRseDescontosComp((BigDecimal) merge.getAttribute(Columns.RSE_DESCONTOS_COMP));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_DESCONTOS_FACU)) {
                final String descontosFacuOld = rseBean.getRseDescontosFacu() != null ? rseBean.getRseDescontosFacu().toString() : "";
                final String descontosFacuNew = merge.getAttribute(Columns.RSE_DESCONTOS_FACU) != null ? merge.getAttribute(Columns.RSE_DESCONTOS_FACU).toString() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.descontos.facultativos.alterados.de.arg0.para.arg1", responsavel, descontosFacuOld, descontosFacuNew));
                rseBean.setRseDescontosFacu((BigDecimal) merge.getAttribute(Columns.RSE_DESCONTOS_FACU));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_OUTROS_DESCONTOS)) {
                final String outrosOld = rseBean.getRseOutrosDescontos() != null ? rseBean.getRseOutrosDescontos().toString() : "";
                final String outrosNew = merge.getAttribute(Columns.RSE_OUTROS_DESCONTOS) != null ? merge.getAttribute(Columns.RSE_OUTROS_DESCONTOS).toString() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.outros.descontos.alterados.de.arg0.para.arg1", responsavel, outrosOld, outrosNew));
                rseBean.setRseOutrosDescontos((BigDecimal) merge.getAttribute(Columns.RSE_OUTROS_DESCONTOS));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_ASSOCIADO)) {
                final String associadoOld = rseBean.getRseAssociado() != null ? rseBean.getRseAssociado() : "";
                final String associadoNew = merge.getAttribute(Columns.RSE_ASSOCIADO) != null ? (String) merge.getAttribute(Columns.RSE_ASSOCIADO) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.associado.alterado.de.arg0.para.arg1", responsavel, associadoOld, associadoNew));
                rseBean.setRseAssociado((String) merge.getAttribute(Columns.RSE_ASSOCIADO));
            }
            if (merge.getAtributos().containsKey(Columns.RSE_DATA_CARGA)) {
                final String dataOld = rseBean.getRseDataCarga() != null ? DateHelper.toDateString(rseBean.getRseDataCarga()) : "";
                final String dataNew = merge.getAttribute(Columns.RSE_DATA_CARGA) != null ? DateHelper.toDateString((Timestamp) merge.getAttribute(Columns.RSE_DATA_CARGA)) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.carga.alterada.de.arg0.para.arg1", responsavel, dataOld, dataNew));
                rseBean.setRseDataCarga((Timestamp) merge.getAttribute(Columns.RSE_DATA_CARGA));
            }
            // Grava observações sobre o servidor
            if (merge.getAtributos().containsKey(Columns.RSE_OBS)) {
                final String obsOld = rseBean.getRseObs() != null ? rseBean.getRseObs() : "";
                final String obsNew = merge.getAttribute(Columns.RSE_OBS) != null ? (String) merge.getAttribute(Columns.RSE_OBS) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.observacao.alterada.de.arg0.para.arg1", responsavel, obsOld, obsNew));
                rseBean.setRseObs((String) merge.getAttribute(Columns.RSE_OBS));
            }

            // Grava quantidade default de contratos
            if (merge.getAtributos().containsKey(Columns.RSE_PARAM_QTD_ADE_DEFAULT)) {
                final String qtdeOld = rseBean.getRseParamQtdAdeDefault() != null ? rseBean.getRseParamQtdAdeDefault().toString() : "";
                final String qtdeNew = merge.getAttribute(Columns.RSE_PARAM_QTD_ADE_DEFAULT) != null ? merge.getAttribute(Columns.RSE_PARAM_QTD_ADE_DEFAULT).toString() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.qtde.contratos.alterada.de.arg0.para.arg1", responsavel, qtdeOld, qtdeNew));
                rseBean.setRseParamQtdAdeDefault(merge.getAttribute(Columns.RSE_PARAM_QTD_ADE_DEFAULT) != null ? Short.valueOf(merge.getAttribute(Columns.RSE_PARAM_QTD_ADE_DEFAULT).toString()) : null);
            }

            // Atualiza o posto do registro servidor
            if (merge.getAtributos().containsKey(Columns.RSE_POS_CODIGO)) {
                final PostoRegistroServidor pos = merge.getAttribute(Columns.RSE_POS_CODIGO) != null ? PostoRegistroServidorHome.findByPrimaryKey((String) merge.getAttribute(Columns.RSE_POS_CODIGO)) : null;
                final String postoOld = rseBean.getPostoRegistroServidor() != null ? rseBean.getPostoRegistroServidor().getPosCodigo() : "";
                final String postoNew = (pos != null) && (pos.getPosCodigo() != null) ? pos.getPosCodigo() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.posto.alterado.de.arg0.para.arg1", responsavel, postoOld, postoNew));
                rseBean.setPostoRegistroServidor(pos);
            }

            // Atualiza Tipo registro servidor
            if (merge.getAtributos().containsKey(Columns.RSE_TRS_CODIGO)) {
                final TipoRegistroServidor tps = merge.getAttribute(Columns.RSE_TRS_CODIGO) != null ? TipoRegistroServidorHome.findByPrimaryKey((String) merge.getAttribute(Columns.RSE_TRS_CODIGO)) : null;
                final String tipoRegistroOld = rseBean.getTipoRegistroServidor() != null ? rseBean.getTipoRegistroServidor().getTrsCodigo() : "";
                final String tipoRegistroNew = (tps != null) && (tps.getTrsCodigo() != null) ? tps.getTrsCodigo() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.tipo.servidor.alterado.de.arg0.para.arg1", responsavel, tipoRegistroOld, tipoRegistroNew));
                rseBean.setTipoRegistroServidor(tps);
            }

            // Atualiza informação se servidor estabilzado
            boolean alterouEstabilidade = false;
            if (merge.getAtributos().containsKey(Columns.RSE_ESTABILIZADO)) {
                String estabilizadoOld = rseBean.getRseEstabilizado() != null ? rseBean.getRseEstabilizado() : "";
                String estabilizadoNew = merge.getAttribute(Columns.RSE_ESTABILIZADO) != null ? (String) merge.getAttribute(Columns.RSE_ESTABILIZADO) : "";

                if (!TextHelper.isNull(estabilizadoOld)) {
                    estabilizadoOld = CodedValues.TPC_SIM.equals(estabilizadoOld) ? ApplicationResourcesHelper.getMessage("rotulo.sim", responsavel) : ApplicationResourcesHelper.getMessage("rotulo.nao", responsavel);
                }
                if (!TextHelper.isNull(estabilizadoNew)) {
                    estabilizadoNew = CodedValues.TPC_SIM.equals(estabilizadoNew) ? ApplicationResourcesHelper.getMessage("rotulo.sim", responsavel) : ApplicationResourcesHelper.getMessage("rotulo.nao", responsavel);
                }

                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.estabilidade.alterada.de.arg0.para.arg1", responsavel, estabilizadoOld, estabilizadoNew));
                rseBean.setRseEstabilizado((String) merge.getAttribute(Columns.RSE_ESTABILIZADO));

                alterouEstabilidade = true;
            }

            // Atualiza informação da data de fim do engajamento se houver mudança ou se estabilidade tiver sido alterada
            if (alterouEstabilidade || merge.getAtributos().containsKey(Columns.RSE_DATA_FIM_ENGAJAMENTO)) {
                final String dataOld = rseBean.getRseDataFimEngajamento() != null ? DateHelper.toDateString(rseBean.getRseDataFimEngajamento()) : "";
                String dataNew = merge.getAttribute(Columns.RSE_DATA_FIM_ENGAJAMENTO) != null ? DateHelper.toDateString((Timestamp) merge.getAttribute(Columns.RSE_DATA_FIM_ENGAJAMENTO)) : "";

                // Se o registro servidor é estabilizado, a data fim de engajamento será sempre nula
                if (!TextHelper.isNull(rseBean.getRseEstabilizado()) && CodedValues.TPC_SIM.equalsIgnoreCase(rseBean.getRseEstabilizado())) {
                    dataNew = "";
                }

                if (!dataOld.equals(dataNew)) {
                    msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.fim.engajamento.alterada.de.arg0.para.arg1", responsavel, dataOld, dataNew));

                    // Se o registro servidor é estabilizado, a data fim de engajamento será sempre nula
                    if (!TextHelper.isNull(rseBean.getRseEstabilizado()) && CodedValues.TPC_SIM.equalsIgnoreCase(rseBean.getRseEstabilizado())) {
                        rseBean.setRseDataFimEngajamento(null);
                    } else {
                        rseBean.setRseDataFimEngajamento((Timestamp) merge.getAttribute(Columns.RSE_DATA_FIM_ENGAJAMENTO));
                    }
                }
            }

            // Atualiza informação da data de limite de permanência se houver mudança ou se estabilidade tiver sido alterada
            if (alterouEstabilidade || merge.getAtributos().containsKey(Columns.RSE_DATA_LIMITE_PERMANENCIA)) {
                final String dataOld = rseBean.getRseDataLimitePermanencia() != null ? DateHelper.toDateString(rseBean.getRseDataLimitePermanencia()) : "";
                String dataNew = merge.getAttribute(Columns.RSE_DATA_LIMITE_PERMANENCIA) != null ? DateHelper.toDateString((Timestamp) merge.getAttribute(Columns.RSE_DATA_LIMITE_PERMANENCIA)) : "";

                // Se o registro servidor é estabilizado, a data limite de permanência será sempre nula
                if (!TextHelper.isNull(rseBean.getRseEstabilizado()) && CodedValues.TPC_SIM.equalsIgnoreCase(rseBean.getRseEstabilizado())) {
                    dataNew = "";
                }

                if (!dataOld.equals(dataNew)) {
                    msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.limite.permanencia.alterada.de.arg0.para.arg1", responsavel, dataOld, dataNew));

                    // Se o registro servidor é estabilizado, a data limite de permanência será sempre nula
                    if (!TextHelper.isNull(rseBean.getRseEstabilizado()) && CodedValues.TPC_SIM.equalsIgnoreCase(rseBean.getRseEstabilizado())) {
                        rseBean.setRseDataLimitePermanencia(null);
                    } else {
                        rseBean.setRseDataLimitePermanencia((Timestamp) merge.getAttribute(Columns.RSE_DATA_LIMITE_PERMANENCIA));
                    }
                }
            }

            // Atualiza informação de capacidade civil do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_CAP_CODIGO)) {
                final CapacidadeRegistroSer cap = merge.getAttribute(Columns.RSE_CAP_CODIGO) != null ? CapacidadeRegistroServidorHome.findByPrimaryKey((String) merge.getAttribute(Columns.RSE_CAP_CODIGO)) : null;
                final String capacidadeOld = rseBean.getCapacidadeRegistroSer() != null ? rseBean.getCapacidadeRegistroSer().getCapCodigo() : "";
                final String capacidadeNew = (cap != null) && (cap.getCapCodigo() != null) ? cap.getCapCodigo() : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.capacidade.civil.alterada.de.arg0.para.arg1", responsavel, capacidadeOld, capacidadeNew));
                rseBean.setCapacidadeRegistroSer(cap);
            }

            //DESENV-8327: atualiza margem limite específica do registro servidor
            if (merge.getAtributos().containsKey(Columns.RSE_MAR_CODIGO)) {
                final Margem margem = merge.getAttribute(Columns.RSE_MAR_CODIGO) != null ? MargemHome.findByPrimaryKey((Short) merge.getAttribute(Columns.RSE_MAR_CODIGO)) : null;
                final String margemOld = rseBean.getMargem() != null ? rseBean.getMargem().getMarCodigo().toString() : "";
                final String margemNew = merge.getAttribute(Columns.RSE_MAR_CODIGO) != null ? ((Short) merge.getAttribute(Columns.RSE_MAR_CODIGO)).toString() : "";

                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.margem.limite.alterado.de.arg0.para.arg1", responsavel, margemOld, margemNew));
                rseBean.setMargem(margem);
            }

            // Atualiza informação de código de banco alternativo do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_BANCO_SAL_2)) {
                final String bancoSal2Old = rseBean.getRseBancoSal2() != null ? rseBean.getRseBancoSal2() : "";
                final String bancoSal2New = merge.getAttribute(Columns.RSE_BANCO_SAL_2) != null ? (String) merge.getAttribute(Columns.RSE_BANCO_SAL_2) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.banco.alternativo.alterado.de.arg0.para.arg1", responsavel, bancoSal2Old, bancoSal2New));
                rseBean.setRseBancoSal2((String) merge.getAttribute(Columns.RSE_BANCO_SAL_2));
            }

            // Atualiza informação de agência alternativa do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_AGENCIA_SAL_2)) {
                final String agenciaSal2Old = rseBean.getRseAgenciaSal2() != null ? rseBean.getRseAgenciaSal2() : "";
                final String agenciaSal2New = merge.getAttribute(Columns.RSE_AGENCIA_SAL_2) != null ? (String) merge.getAttribute(Columns.RSE_AGENCIA_SAL_2) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.agencia.alternativa.alterada.de.arg0.para.arg1", responsavel, agenciaSal2Old, agenciaSal2New));
                rseBean.setRseAgenciaSal2((String) merge.getAttribute(Columns.RSE_AGENCIA_SAL_2));
            }

            // Atualiza informação de dígito verificador da agência alternativa do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_AGENCIA_DV_SAL_2)) {
                final String agenciaDvSal2Old = rseBean.getRseAgenciaDvSal2() != null ? rseBean.getRseAgenciaDvSal2() : "";
                final String agenciaDvSal2New = merge.getAttribute(Columns.RSE_AGENCIA_DV_SAL_2) != null ? (String) merge.getAttribute(Columns.RSE_AGENCIA_DV_SAL_2) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.agencia.dv.alternativo.alterado.de.arg0.para.arg1", responsavel, agenciaDvSal2Old, agenciaDvSal2New));
                rseBean.setRseAgenciaDvSal2((String) merge.getAttribute(Columns.RSE_AGENCIA_DV_SAL_2));
            }

            // Atualiza informação de conta alternativa do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_CONTA_SAL_2)) {
                final String contaSal2Old = rseBean.getRseContaSal2() != null ? rseBean.getRseContaSal2() : "";
                final String contaSal2New = merge.getAttribute(Columns.RSE_CONTA_SAL_2) != null ? (String) merge.getAttribute(Columns.RSE_CONTA_SAL_2) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.conta.alternativa.alterada.de.arg0.para.arg1", responsavel, contaSal2Old, contaSal2New));
                rseBean.setRseContaSal2((String) merge.getAttribute(Columns.RSE_CONTA_SAL_2));
            }

            // Atualiza informação de dígito verificador de conta alternativa do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_CONTA_DV_SAL_2)) {
                final String contaDvSal2Old = rseBean.getRseContaDvSal2() != null ? rseBean.getRseContaDvSal2() : "";
                final String contaDvSal2New = merge.getAttribute(Columns.RSE_CONTA_DV_SAL_2) != null ? (String) merge.getAttribute(Columns.RSE_CONTA_DV_SAL_2) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.conta.dv.alternativo.alterado.de.arg0.para.arg1", responsavel, contaDvSal2Old, contaDvSal2New));
                rseBean.setRseContaDvSal2((String) merge.getAttribute(Columns.RSE_CONTA_DV_SAL_2));
            }

            // Atualiza auditoria total
            if (merge.getAtributos().containsKey(Columns.RSE_AUDITORIA_TOTAL)) {
                final String auditoriaOld = rseBean.getRseAuditoriaTotal() != null ? rseBean.getRseAuditoriaTotal() : "";
                final String auditoriaNew = merge.getAttribute(Columns.RSE_AUDITORIA_TOTAL) != null ? (String) merge.getAttribute(Columns.RSE_AUDITORIA_TOTAL) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.auditoria.estendida.alterada.de.arg0.para.arg1", responsavel, auditoriaOld, auditoriaNew));
                rseBean.setRseAuditoriaTotal((String) merge.getAttribute(Columns.RSE_AUDITORIA_TOTAL));
            }

            // Atualiza município lotação
            if (merge.getAtributos().containsKey(Columns.RSE_MUNICIPIO_LOTACAO)) {
                final String municipioLotOld = rseBean.getRseMunicipioLotacao() != null ? rseBean.getRseMunicipioLotacao() : "";
                final String municipioLotNew = merge.getAttribute(Columns.RSE_MUNICIPIO_LOTACAO) != null ? (String) merge.getAttribute(Columns.RSE_MUNICIPIO_LOTACAO) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.municipio.lotacao.alterado.de.arg0.para.arg1", responsavel, municipioLotOld, municipioLotNew));
                rseBean.setRseMunicipioLotacao((String) merge.getAttribute(Columns.RSE_MUNICIPIO_LOTACAO));
            }

            // Atualiza beneficiário de financiamento de cartão
            if (merge.getAtributos().containsKey(Columns.RSE_BENEFICIARIO_FINAN_DV_CART)) {
                final String beneficiarioOld = rseBean.getRseBeneficiarioFinanDvCart() != null ? rseBean.getRseBeneficiarioFinanDvCart() : "";
                final String beneficiarioNew = merge.getAttribute(Columns.RSE_BENEFICIARIO_FINAN_DV_CART) != null ? (String) merge.getAttribute(Columns.RSE_BENEFICIARIO_FINAN_DV_CART) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.beneficiario.financiamento.divida.cartao.alterado.de.arg0.para.arg1", responsavel, beneficiarioOld, beneficiarioNew));
                rseBean.setRseBeneficiarioFinanDvCart((String) merge.getAttribute(Columns.RSE_BENEFICIARIO_FINAN_DV_CART));
            }

            // Atualiza informações das praças do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_PRACA)) {
                final String pracaOld = rseBean.getRsePraca() != null ? rseBean.getRsePraca() : "";
                final String pracaNew = merge.getAttribute(Columns.RSE_PRACA) != null ? (String) merge.getAttribute(Columns.RSE_PRACA) : "";
                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.praca.alterado.de.arg0.para.arg1", responsavel, pracaOld, pracaNew));
                rseBean.setRsePraca((String) merge.getAttribute(Columns.RSE_PRACA));
            }

            final String statusCorrente = merge.getAttribute(Columns.SRS_CODIGO) != null ? (String) merge.getAttribute(Columns.SRS_CODIGO) : rseCache.getSrsCodigo();
            final String dataSaidaNew = merge.getAttribute(Columns.RSE_DATA_SAIDA) != null ? DateHelper.toDateString((java.util.Date) merge.getAttribute(Columns.RSE_DATA_SAIDA)) : "";
            // Atualiza data de saída do servidor
            if (merge.getAtributos().containsKey(Columns.RSE_DATA_SAIDA)) {
                final String dataOld = rseBean.getRseDataSaida() != null ? DateHelper.toDateString(rseBean.getRseDataSaida()) : "";

                if (exigeDetalhesExclusao && !importacaoTransferidos && TextHelper.isNull(dataSaidaNew) && (CodedValues.SRS_EXCLUIDO.equals(statusCorrente) || CodedValues.SRS_BLOQUEADO.equals(statusCorrente))) {
                    throw new ServidorControllerException("mensagem.erro.rse.informe.data.saida", responsavel);
                }

                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.saida.ser.de.arg0.para.arg1", responsavel, dataOld, dataSaidaNew));
                rseBean.setRseDataSaida((java.util.Date) merge.getAttribute(Columns.RSE_DATA_SAIDA));
            }

            // Atualiza data de pagamento do último salário do servidor
            final String dataUltSalNew = merge.getAttribute(Columns.RSE_DATA_ULT_SALARIO) != null ? DateHelper.toDateString((java.util.Date) merge.getAttribute(Columns.RSE_DATA_ULT_SALARIO)) : "";
            if (merge.getAtributos().containsKey(Columns.RSE_DATA_ULT_SALARIO)) {
                final String dataOld = rseBean.getRseDataUltSalario() != null ? DateHelper.toDateString(rseBean.getRseDataUltSalario()) : "";

                if (exigeDetalhesExclusao && !importacaoTransferidos && TextHelper.isNull(dataUltSalNew) && (CodedValues.SRS_EXCLUIDO.equals(statusCorrente) || CodedValues.SRS_BLOQUEADO.equals(statusCorrente))) {
                    throw new ServidorControllerException("mensagem.erro.rse.informe.data.ult.salario", responsavel);
                }

                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.ult.salario.ser.de.arg0.para.arg1", responsavel, dataOld, dataUltSalNew));
                rseBean.setRseDataUltSalario((java.util.Date) merge.getAttribute(Columns.RSE_DATA_ULT_SALARIO));
            }

            // Atualiza data de pagamento do último salário do servidor
            final String dataRetornoNew = merge.getAttribute(Columns.RSE_DATA_RETORNO) != null ? DateHelper.toDateString((java.util.Date) merge.getAttribute(Columns.RSE_DATA_RETORNO)) : "";
            if (merge.getAtributos().containsKey(Columns.RSE_DATA_RETORNO)) {
                final String dataOld = rseBean.getRseDataRetorno() != null ? DateHelper.toDateString(rseBean.getRseDataRetorno()) : "";

                if (exigeDetalhesExclusao && !importacaoTransferidos && CodedValues.SRS_BLOQUEADO.equals(statusCorrente)) {
                    if (TextHelper.isNull(dataRetornoNew)) {
                        throw new ServidorControllerException("mensagem.erro.rse.informe.data.retorno", responsavel);
                    } else {
                        try {
                            final java.util.Date dataRetParse = DateHelper.parse(dataRetornoNew, LocaleHelper.getDatePattern());

                            if (DateHelper.dayDiff(dataRetParse) >= 0) {
                                throw new ServidorControllerException("mensagem.erro.rse.data.retorno.menor.atual", responsavel);
                            }
                        } catch (final ParseException e) {
                            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
                        }
                    }
                }

                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.data.retorno.ser.de.arg0.para.arg1", responsavel, dataOld, dataRetornoNew));
                rseBean.setRseDataRetorno((java.util.Date) merge.getAttribute(Columns.RSE_DATA_RETORNO));
            }

            if (merge.getAtributos().containsKey(Columns.RSE_PEDIDO_DEMISSAO)) {
                String pedidoDemissaoOld = rseBean.getRsePedidoDemissao() != null ? rseBean.getRsePedidoDemissao() : "";
                String pedidoDemissaoNew = merge.getAttribute(Columns.RSE_PEDIDO_DEMISSAO) != null ? (String) merge.getAttribute(Columns.RSE_PEDIDO_DEMISSAO) : "";
                if (TextHelper.isNull(pedidoDemissaoNew) && exigeDetalhesExclusao && !importacaoTransferidos && CodedValues.SRS_EXCLUIDO.equals(statusCorrente)) {
                    throw new ServidorControllerException("mensagem.erro.rse.informe.servidor.demitiuse", responsavel);
                }

                if (!TextHelper.isNull(pedidoDemissaoOld)) {
                    pedidoDemissaoOld = CodedValues.TPC_SIM.equals(pedidoDemissaoOld) ? ApplicationResourcesHelper.getMessage("rotulo.sim", responsavel) : ApplicationResourcesHelper.getMessage("rotulo.nao", responsavel);
                }
                if (!TextHelper.isNull(pedidoDemissaoNew)) {
                    pedidoDemissaoNew = CodedValues.TPC_SIM.equals(pedidoDemissaoNew) ? ApplicationResourcesHelper.getMessage("rotulo.sim", responsavel) : ApplicationResourcesHelper.getMessage("rotulo.nao", responsavel);
                }

                msgOrs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.rse.pedido.demissao.de.arg0.para.arg1", responsavel, pedidoDemissaoOld, pedidoDemissaoNew));
                rseBean.setRsePedidoDemissao((String) merge.getAttribute(Columns.RSE_PEDIDO_DEMISSAO));
            }

            // Atualiza o usuário modificador do registro servidor
            if (merge.getAtributos().containsKey(Columns.RSE_USU_CODIGO)) {
                final Usuario usu = UsuarioHome.findByPrimaryKey((String) merge.getAttribute(Columns.RSE_USU_CODIGO));
                rseBean.setUsuario(usu);
            }

            // Atualiza a data de modificação
            if (merge.getAtributos().containsKey(Columns.RSE_DATA_ALTERACAO)) {
                rseBean.setRseDataAlteracao((Timestamp) merge.getAttribute(Columns.RSE_DATA_ALTERACAO));
            }

            if (merge.getAtributos().containsKey(Columns.RSE_MOTIVO_FALTA_MARGEM)) {
                rseBean.setRseMotivoFaltaMargem((String) merge.getAttribute(Columns.RSE_MOTIVO_FALTA_MARGEM));
            }

            final String tmoCodigo = registroServidor.getTipoMotivo();
            final boolean tmoExigeObservacao = FuncaoExigeMotivo.getInstance().motivosExigeObs(tmoCodigo, responsavel);

            // Verifica se o tipo motivo operação e a observação foram preenchidas
            if (responsavel.isCseSupOrg() && (TextHelper.isNull(registroServidor.getTipoMotivo()) || TextHelper.isNull(registroServidor.getOrsObs()))) {
                if (!TextHelper.isNull(msgOrs) || !TextHelper.isNull(margemAlterada)) {
                    Funcao funcao = null;
                    if (responsavel.getFunCodigo() != null) {
                        funcao = usuarioController.findFuncao(responsavel.getFunCodigo(), responsavel);
                    } else {
                        funcao = usuarioController.findFuncao(CodedValues.FUN_EDT_SERVIDOR, responsavel);
                    }
                    final String exigeTmo = funcao.getFunExigeTmo();
                    if (!TextHelper.isNull(exigeTmo) && CodedValues.TPC_SIM.equals(exigeTmo)) {
                        if (TextHelper.isNull(registroServidor.getTipoMotivo())) {
                            throw new ServidorControllerException("mensagem.informe.tipo.motivo.operacao", responsavel);
                        } else if ((tmoCodigo != null) && tmoExigeObservacao && TextHelper.isNull(registroServidor.getOrsObs())) {
                            throw new ServidorControllerException("mensagem.informe.oca.observacao", responsavel);
                        }
                    }
                }

                if (exigeDetalhesExclusao && (excluiServidorManualmente || bloqueiaServidorManualmente) && merge.getAtributos().containsKey(Columns.SRS_CODIGO) && (CodedValues.SRS_BLOQUEADO.equals(merge.getAtributos().get(Columns.SRS_CODIGO).toString()) || CodedValues.SRS_EXCLUIDO.equals(merge.getAtributos().get(Columns.SRS_CODIGO).toString()))) {
                    if (TextHelper.isNull(registroServidor.getTipoMotivo())) {
                        throw new ServidorControllerException("mensagem.informe.tipo.motivo.operacao", responsavel);
                    } else if ((tmoCodigo != null) && tmoExigeObservacao && TextHelper.isNull(registroServidor.getOrsObs())) {
                        throw new ServidorControllerException("mensagem.informe.oca.observacao", responsavel);
                    }
                }

                if (!TextHelper.isNull(margemAlterada)) {
                    Funcao funcao = usuarioController.findFuncao(CodedValues.FUN_ALT_MARGEM_CONSIGNAVEL, responsavel);
                    String exigeTmo = funcao.getFunExigeTmo();

                    if (!TextHelper.isNull(exigeTmo) && CodedValues.TPC_SIM.equals(exigeTmo)) {
                        if (TextHelper.isNull(registroServidor.getTipoMotivo())) {
                            throw new ServidorControllerException("mensagem.informe.tipo.motivo.operacao", responsavel);
                        } else if ((tmoCodigo != null) && tmoExigeObservacao && TextHelper.isNull(registroServidor.getOrsObs())) {
                            throw new ServidorControllerException("mensagem.informe.oca.observacao", responsavel);
                        }

                    }

                    funcao = usuarioController.findFuncao(CodedValues.FUN_ALT_MARGEM_CONSIGNAVEL_MENOR, responsavel);
                    exigeTmo = funcao.getFunExigeTmo();

                    if (!TextHelper.isNull(exigeTmo) && CodedValues.TPC_SIM.equals(exigeTmo)) {
                        if (TextHelper.isNull(registroServidor.getTipoMotivo())) {
                            throw new ServidorControllerException("mensagem.informe.tipo.motivo.operacao", responsavel);
                        } else if ((tmoCodigo != null) && tmoExigeObservacao && TextHelper.isNull(registroServidor.getOrsObs())) {
                            throw new ServidorControllerException("mensagem.informe.oca.observacao", responsavel);
                        }
                    }
                }
            }

            // Valida se o motivo da operação selecionado é obrigatório("S") e também se o campo observação foi preenchido(orsObs)
            if ((tmoCodigo != null) && tmoExigeObservacao && registroServidor.getOrsObs().isEmpty()) {
                throw new ServidorControllerException("mensagem.erro.obrigatoriedade.observacao.motivo.operacao", responsavel);
            }

            AbstractEntityHome.update(rseBean);

            // Cria o beneficiário se o registro servidor foi ativado
            if (reativaServidorManualmente && ParamSist.paramEquals(CodedValues.TPC_HABILITA_MODULO_BENEFICIOS_SAUDE, CodedValues.TPC_SIM, responsavel)) {
                final CustomTransferObject criterio = new CustomTransferObject();
                criterio.setAttribute(Columns.RSE_CODIGO, rseCodigo);
                criterio.setAttribute(Columns.TIB_CODIGO, TipoBeneficiarioEnum.TITULAR.tibCodigo);
                final List<TransferObject> beneficiarios = beneficiarioController.listarBeneficiarios(criterio, responsavel);

                if ((beneficiarios != null) && beneficiarios.isEmpty()) {
                    final TipoBeneficiario tipoBeneficiario = new TipoBeneficiario();
                    tipoBeneficiario.setTibCodigo(TipoBeneficiarioEnum.TITULAR.tibCodigo);

                    final StatusBeneficiario statusBeneficiario = new StatusBeneficiario();
                    statusBeneficiario.setSbeCodigo(StatusBeneficiarioEnum.ATIVO.sbeCodigo);

                    final CustomTransferObject servidor = pesquisarServidorController.buscaServidor(rseCodigo, responsavel);

                    final String serCodigo = (String) servidor.getAttribute(Columns.SER_CODIGO);
                    final String serNome = (String) servidor.getAttribute(Columns.SER_NOME);
                    final String serCpf = (String) servidor.getAttribute(Columns.SER_CPF);
                    final String serNroIdt = (String) servidor.getAttribute(Columns.SER_NRO_IDT);

                    String serSexo = null;
                    final Object sexoObj = servidor.getAttribute(Columns.SER_SEXO);
                    if (!TextHelper.isNull(sexoObj)) {
                        if (sexoObj instanceof String) {
                            serSexo = (String) sexoObj;
                        } else if (sexoObj instanceof Character) {
                            serSexo = String.valueOf(sexoObj);
                        }
                    }

                    final String serTel = (String) servidor.getAttribute(Columns.SER_TEL);
                    final Date serDataNasc = (Date) servidor.getAttribute(Columns.SER_DATA_NASC);

                    final Object estCivilObj = servidor.getAttribute(Columns.SER_EST_CIVIL);
                    String serEstCivil = null;

                    if (!TextHelper.isNull(estCivilObj)) {
                        if (estCivilObj instanceof String) {
                            serEstCivil = (String) estCivilObj;
                        } else if (estCivilObj instanceof Character) {
                            serEstCivil = String.valueOf(estCivilObj);
                        }
                    }

                    final String serCelular = (String) servidor.getAttribute(Columns.SER_CELULAR);
                    final String serNomeMae = (String) servidor.getAttribute(Columns.SER_NOME_MAE);

                    final Servidor ser = new Servidor();
                    ser.setSerCodigo(serCodigo);

                    beneficiarioController.create(ser, tipoBeneficiario, null, (short) 0, serNome, serCpf, serNroIdt, serSexo, serTel, serCelular, serNomeMae, null, serDataNasc, serEstCivil, null, null, null, null, statusBeneficiario, null, null, null, responsavel);
                }
            }

            String obs = "";
            if (!TextHelper.isNull(registroServidor.getTipoMotivo())) {
                final TipoMotivoOperacao tipoMotivoOperacao = TipoMotivoOperacaoHome.findByPrimaryKey(registroServidor.getTipoMotivo());
                obs += "<br> " + ApplicationResourcesHelper.getMessage("rotulo.motivo.arg0", responsavel, tipoMotivoOperacao.getTmoDescricao());
            }
            if (!TextHelper.isNull(registroServidor.getOrsObs())) {
                obs += "<br> " + ApplicationResourcesHelper.getMessage("rotulo.observacao.arg0", responsavel, registroServidor.getOrsObs());
            }

            // Grava ocorrência de alteração
            if (transferenciaMargem) {
                final String mensagem = responsavel.isSer() ? "<BR>" + ApplicationResourcesHelper.getMessage("mensagem.transferencia.margem.ocorrencia", responsavel).toUpperCase() : "";
                criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_TRANSFERENCIA_ENTRE_MARGENS, ApplicationResourcesHelper.getMessage("mensagem.informacao.transferencia.valores.entre.margens", responsavel, margemAlterada.toString() + mensagem + obs), registroServidor.getTipoMotivo(), responsavel);
            } else {
                if (msgOrs.length() > 0) {
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_ALTERACAO_DADOS_CADASTRAIS, ApplicationResourcesHelper.getMessage("mensagem.informacao.dados.cadastrais.foram.alterados", responsavel, msgOrs.toString()) + obs, registroServidor.getTipoMotivo(), responsavel);
                }
                if (margemAlterada.length() > 0) {
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_ALTERACAO_MARGEM, ApplicationResourcesHelper.getMessage("mensagem.informacao.margem.servidor.foi.alterada", responsavel, margemAlterada.toString()) + obs, registroServidor.getTipoMotivo(), responsavel);
                }
                if (excluiServidorManualmente) {
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_EXCLUSAO_POR_CARGA_MARGEM, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.exclusao.manual", responsavel) + obs, registroServidor.getTipoMotivo(), responsavel);
                }
                if (reativaServidorManualmente) {
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_REATIVACAO_POR_CARGA_MARGEM, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.reativacao.manual", responsavel) + obs, registroServidor.getTipoMotivo(), responsavel);
                }
                if (bloqueiaServidorManualmente) {
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_BLOQUEIO_STATUS_MANUAL, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.bloqueio.manual", responsavel) + obs, registroServidor.getTipoMotivo(), responsavel);
                }
                if (desbloqueiaServidorManualmente) {
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_DESBLOQUEIO_STATUS_MANUAL, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.desbloqueio.manual", responsavel) + obs, registroServidor.getTipoMotivo(), responsavel);
                }
                if (falecimentoManualServidor || falecimentoAutomaticoServidor) {
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_FALECIMENTO_RSE, ApplicationResourcesHelper.getMessage(falecimentoAutomaticoServidor ? "mensagem.ocorrencia.ors.obs.falecido.carga.falecidos" : "mensagem.ocorrencia.ors.obs.falecido.manualmente", responsavel) + obs, registroServidor.getTipoMotivo(), responsavel);
                }
            }

            // Gravação de histórico de margem
            if (geraHistoricoMargem) {
                final String operacao = transferenciaMargem ? OperacaoHistoricoMargemEnum.TRANSFERENCIA_MARGEM.getCodigo() : OperacaoHistoricoMargemEnum.EDT_REGISTRO_SERVIDOR.getCodigo();
                boolean liberouMargem = false;

                final BigDecimal margemRest1Depois = rseBean.getRseMargemRest();
                final BigDecimal margemRest2Depois = rseBean.getRseMargemRest2();
                final BigDecimal margemRest3Depois = rseBean.getRseMargemRest3();

                if ((margemRest1Antes != null) && (margemRest1Depois != null) && !margemRest1Antes.equals(margemRest1Depois)) {
                    HistoricoMargemRegistroServidorHome.create(rseCodigo, CodedValues.INCIDE_MARGEM_SIM, null, operacao, margemRest1Antes, margemRest1Depois);
                    liberouMargem |= margemRest1Depois.compareTo(margemRest1Antes) > 0;
                }
                if ((margemRest2Antes != null) && (margemRest2Depois != null) && !margemRest2Antes.equals(margemRest2Depois)) {
                    HistoricoMargemRegistroServidorHome.create(rseCodigo, CodedValues.INCIDE_MARGEM_SIM_2, null, operacao, margemRest2Antes, margemRest2Depois);
                    liberouMargem |= margemRest2Depois.compareTo(margemRest2Antes) > 0;
                }
                if ((margemRest3Antes != null) && (margemRest3Depois != null) && !margemRest3Antes.equals(margemRest3Depois)) {
                    HistoricoMargemRegistroServidorHome.create(rseCodigo, CodedValues.INCIDE_MARGEM_SIM_3, null, operacao, margemRest3Antes, margemRest3Depois);
                    liberouMargem |= margemRest3Depois.compareTo(margemRest3Antes) > 0;
                }

                for (final Short codMargem : margemRestAntes.keySet()) {
                    if (margemRestDepois.containsKey(codMargem)) {
                        final BigDecimal vlrMargemRestAntes = margemRestAntes.get(codMargem);
                        final BigDecimal vlrMargemRestDepois = margemRestDepois.get(codMargem);
                        if ((vlrMargemRestAntes != null) && (vlrMargemRestDepois != null) && !vlrMargemRestAntes.equals(vlrMargemRestDepois)) {
                            HistoricoMargemRegistroServidorHome.create(rseCodigo, codMargem, null, operacao, vlrMargemRestAntes, vlrMargemRestDepois);
                            liberouMargem |= vlrMargemRestDepois.compareTo(vlrMargemRestAntes) > 0;
                        }
                    }
                }

                if (liberouMargem) {
                    // Se é uma operação de liberação de margem, então registra esta operação no controle de segurança
                    segurancaController.registrarOperacoesLiberacaoMargem(rseCodigo, null, responsavel);
                }
            }
            final StringBuilder corpoEmailRse = new StringBuilder();
            // Envia e-mail de notificação à todas CSA/COR que possuem contratos ativos com este servidor
            if (responsavel.isCseOrg() && (CodedValues.FUN_EDT_SERVIDOR.equals(responsavel.getFunCodigo()) || CodedValues.FUN_VALIDAR_SERVIDOR.equals(responsavel.getFunCodigo())) && ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_NOTIFICACAO_EDT_SERVIDOR, CodedValues.TPC_SIM, responsavel) && (((merge.getAtributos().size() == 1) && !merge.getAtributos().containsKey(Columns.RSE_DATA_ALTERACAO)) || (merge.getAtributos().size() > 1))) {
                try {
                    final StringBuilder textoEmail = new StringBuilder();
                    if (msgOrs.length() > 0) {
                        textoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.dados.cadastrais.foram.alterados", responsavel, msgOrs.toString()));
                        textoEmail.append("<br/>\n");
                    }
                    if (margemAlterada.length() > 0) {
                        textoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.margem.servidor.foi.alterada", responsavel, margemAlterada.toString()));
                        textoEmail.append("<br/>\n");
                    }
                    if (falecimentoManualServidor) {
                        textoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.falecido.manualmente", responsavel));
                        textoEmail.append("<br/>\n");
                    }
                    textoEmail.append(obs).append("<br/>\n");
                    if (enviaEmail) {
                        EnviaEmailHelper.enviarEmailCsasAlteracaoSer(rseCache, null, merge.getAtributos().containsKey(Columns.RSE_MATRICULA) ? (String) merge.getAttribute(Columns.RSE_MATRICULA) : rseCache.getRseMatricula(), merge.getAtributos().containsKey(Columns.SRS_CODIGO) ? (String) merge.getAttribute(Columns.SRS_CODIGO) : null, textoEmail.toString(), responsavel);
                    }
                    corpoEmailRse.append(textoEmail);
                } catch (final Exception ex) {
                    LOG.error(ex.getMessage(), ex);
                }
            }

            // Envia e-mail ao CSE/ORG relativo ao cadastro do servidor
            if (responsavel.isCsaCor() && ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_NOTIFICACAO_CAD_SERVIDOR, CodedValues.TPC_SIM, responsavel) && (registroServidor.getSrsCodigo() != null) && CodedValues.SRS_PENDENTE.equals(registroServidor.getSrsCodigo())) {
                EnviaEmailHelper.enviarEmailNotificacaoCadastroServidor(rseCodigo, responsavel);
            }

            if (margemAlterada.length() > 0) {
                logMargem.write();
            }
            log.write();
            if (enviaEmail) {
                return "";
            } else {
                return corpoEmailRse.toString();
            }
        } catch (FindException | CreateException | UpdateException | HQueryException | BeneficioControllerException  ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final ZetraException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException(ex);
        }
    }

    @Override
    public String createRegistroServidor(RegistroServidorTO registroServidor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final RegistroServidor rseBean = RegistroServidorHome.create(registroServidor.getSerCodigo(), registroServidor.getOrgCodigo(), registroServidor.getSrsCodigo(), registroServidor.getRseMatricula(), registroServidor.getRseMargem(), registroServidor.getRseMargemRest(), registroServidor.getRseMargemUsada(), registroServidor.getRseMargem2(), registroServidor.getRseMargemRest2(), registroServidor.getRseMargemUsada2(), registroServidor.getRseMargem3(), registroServidor.getRseMargemRest3(), registroServidor.getRseMargemUsada3(), registroServidor.getRseTipo(), registroServidor.getRsePrazo(),
                    registroServidor.getRseDataAdmissao(), registroServidor.getRseCLT(), registroServidor.getRseParamQtdAdeDefault(), registroServidor.getBcoCodigo(), registroServidor.getRseObs(), registroServidor.getRseAssociado(), registroServidor.getRseEstabilizado(), registroServidor.getRseDataCarga(), registroServidor.getRseDataFimEngajamento(), registroServidor.getRseDataLimitePermanencia(), registroServidor.getRseBancoSal(), registroServidor.getRseAgenciaSal(), registroServidor.getRseAgenciaDvSal(), registroServidor.getRseContaSal(), registroServidor.getRseContaDvSal(),
                    registroServidor.getRseBancoSalAlternativo(), registroServidor.getRseAgenciaSalAlternativa(), registroServidor.getRseAgenciaDvSalAlternativa(), registroServidor.getRseContaSalAlternativa(), registroServidor.getRseContaDvSalAlternativa(), registroServidor.getRseSalario(), registroServidor.getRseProventos(), registroServidor.getRseDescontosComp(), registroServidor.getRseDescontosFacu(), registroServidor.getRseOutrosDescontos(), registroServidor.getCrsCodigo(), registroServidor.getPrsCodigo(), registroServidor.getSboCodigo(), registroServidor.getUniCodigo(),
                                                                         registroServidor.getVrsCodigo(), registroServidor.getPosCodigo(), registroServidor.getTrsCodigo(), registroServidor.getCapCodigo(), registroServidor.getRsePraca(), registroServidor.getRseBeneficiarioFinanDvCart(), registroServidor.getRseMunicipioLotacao(), registroServidor.getRseMatriculaInst(), registroServidor.getRseDataContracheque(), registroServidor.getRseBaseCalculo(), registroServidor.getRsePedidoDemissao(), registroServidor.getRseDataSaida(), registroServidor.getRseDataUltSalario(),
                                                                         registroServidor.getRseDataRetorno(), registroServidor.getRseMotivoFaltaMargem());

            final String rseCodigo = rseBean.getRseCodigo();
            final LogDelegate log = new LogDelegate(responsavel, Log.REGISTRO_SERVIDOR, Log.CREATE, Log.LOG_INFORMACAO);
            log.setRegistroServidor(rseCodigo);
            log.setServidor(registroServidor.getSerCodigo());
            log.setOrgao(registroServidor.getOrgCodigo());
            if (!TextHelper.isNull(registroServidor.getVrsCodigo())) {
                log.setVincRseCodigo(registroServidor.getVrsCodigo());
            }
            if (!TextHelper.isNull(registroServidor.getCrsCodigo())) {
                log.setCargoRseCodigo(registroServidor.getCrsCodigo());
            }
            if (!TextHelper.isNull(registroServidor.getSrsCodigo())) {
                log.setStatusRseCodigo(registroServidor.getSrsCodigo());
            }
            log.getUpdatedFields(registroServidor.getAtributos(), null);
            log.write();

            return rseCodigo;
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            ServidorControllerException excecao = new ServidorControllerException("mensagem.erro.nao.possivel.criar.registro.servidor.erro.interno", responsavel, ex.getMessage());
            if (ex.getMessage().indexOf("Invalid argument value") != -1) {
                excecao = new ServidorControllerException("mensagem.erro.nao.possivel.criar.registro.servidor.existe.outro.mesma.matricula.orgao", responsavel);
            }
            throw excecao;
        }
    }

    @Override
    public int countRegistroServidor(List<String> srsCodigos, List<String> orgCodigos, List<String> estCodigos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistrosServidoresQuery query = new ListaRegistrosServidoresQuery(srsCodigos, orgCodigos, estCodigos, true);
            return query.executarContador();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public int countRegistroServidorTransferidos(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistrosServidoresTransferidosQuery query = new ListaRegistrosServidoresTransferidosQuery(true);
            return query.executarContador();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public int countRegistroServidorExcluidos(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistrosServidoresExcluidosQuery query = new ListaRegistrosServidoresExcluidosQuery(true);
            return query.executarContador();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> countQtdeServidorPorOrg(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaQtdeServidorPorOrgQuery query = new ListaQtdeServidorPorOrgQuery(responsavel);
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstRegistroServidor(List<String> srsCodigos, List<String> orgCodigos, List<String> estCodigos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistrosServidoresQuery query = new ListaRegistrosServidoresQuery(srsCodigos, orgCodigos, estCodigos);
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstRegistroServidor(String serCodigo, String orgCodigo, String estCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        final List<String> orgCodigos = new ArrayList<>();
        if (!TextHelper.isNull(orgCodigo)) {
            orgCodigos.add(orgCodigo);
        }
        final List<String> estCodigos = new ArrayList<>();
        if (!TextHelper.isNull(estCodigo)) {
            estCodigos.add(estCodigo);
        }
        return lstRegistroServidor(serCodigo, orgCodigos, estCodigos, responsavel);
    }

    @Override
    public List<TransferObject> lstRegistroServidor(String serCodigo, List<String> orgCodigos, List<String> estCodigos, AcessoSistema responsavel) throws ServidorControllerException {
        return lstRegistroServidor(serCodigo, orgCodigos, estCodigos, true, responsavel);
    }

    @Override
    public List<TransferObject> lstRegistroServidor(String serCodigo, List<String> orgCodigos, List<String> estCodigos, boolean recuperaRseExcluidos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistroServidorQuery query = new ListaRegistroServidorQuery();
            query.serCodigo = serCodigo;
            query.orgCodigos = orgCodigos;
            query.estCodigos = estCodigos;
            query.recuperaRseExcluido = recuperaRseExcluidos;

            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstRegistroServidorAuditoriaTotal(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistroServidorAuditoriaTotalQuery query = new ListaRegistroServidorAuditoriaTotalQuery();
            return query.executarDTO();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public String criaOcorrenciaSER(String serCodigo, String tocCodigo, String ocsObs, String tmoCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final String usuCodigo = responsavel != null ? responsavel.getUsuCodigo() : null;
            final OcorrenciaServidor ocs = OcorrenciaServidorHome.create(serCodigo, tocCodigo, usuCodigo, ocsObs, responsavel.getIpUsuario(), tmoCodigo);
            return ocs.getOcsCodigo();
        } catch (final CreateException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public String criaOcorrenciaRSE(String rseCodigo, String tocCodigo, String orsObs, String tmoCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final String usuCodigo = responsavel != null ? responsavel.getUsuCodigo() : null;
            final OcorrenciaRegistroSer ors = OcorrenciaRegistroServidorHome.create(rseCodigo, tocCodigo, usuCodigo, orsObs, responsavel.getIpUsuario(), tmoCodigo);
            return ors.getOrsCodigo();
        } catch (final CreateException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void criaOcorrenciaRSE(List<TransferObject> excluidosTO, String tocCodigo, String orsObs, String tmoCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            for (final TransferObject to : excluidosTO) {
                final String rseCodigo = (String) to.getAttribute(Columns.RSE_CODIGO);
                criaOcorrenciaRSE(rseCodigo, tocCodigo, orsObs, tmoCodigo, responsavel);
            }
        } catch (final Exception ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException(ex);
        }
    }

    @Override
    public List<TransferObject> lstOrsRegistroServidor(TransferObject toOrsRegistroServidor, int offset, int count, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaOcorrenciaRegistroServidorQuery query = new ListaOcorrenciaRegistroServidorQuery();
            if (offset != -1) {
                query.firstResult = offset;
            }
            if (count != -1) {
                query.maxResults = count;
            }
            query.rseCodigo = (String) toOrsRegistroServidor.getAttribute(Columns.ORS_RSE_CODIGO);
            query.tocCodigo = (String) toOrsRegistroServidor.getAttribute(Columns.ORS_TOC_CODIGO);
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erro.listar.ocorrencias", responsavel, ex);
        }
    }

    @Override
    public int countOcorrenciaSerUnionRse(TransferObject criterio, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaOcorrenciaSerUnionRseQuery query = new ListaOcorrenciaSerUnionRseQuery();
            query.count = true;
            query.serCodigo = (String) criterio.getAttribute(Columns.OCS_SER_CODIGO);
            query.tocCodigo = (String) criterio.getAttribute(Columns.OCS_TOC_CODIGO);
            query.rseCodigo = (String) criterio.getAttribute(Columns.ORS_RSE_CODIGO);
            query.tocCodigoRse = (String) criterio.getAttribute(Columns.ORS_TOC_CODIGO);
            return query.executarContador();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erro.contar.ocorrencias", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstOcorrenciaSerUnionRse(TransferObject criterio, int offset, int count, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaOcorrenciaSerUnionRseQuery query = new ListaOcorrenciaSerUnionRseQuery();
            if (offset != -1) {
                query.firstResult = offset;
            }
            if (count != -1) {
                query.maxResults = count;
            }
            query.serCodigo = (String) criterio.getAttribute(Columns.OCS_SER_CODIGO);
            query.tocCodigo = (String) criterio.getAttribute(Columns.OCS_TOC_CODIGO);
            query.rseCodigo = (String) criterio.getAttribute(Columns.ORS_RSE_CODIGO);
            query.tocCodigoRse = (String) criterio.getAttribute(Columns.ORS_TOC_CODIGO);
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erro.listar.ocorrencias", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstDataOcorrenciaServidor(String serCodigo, String tocCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ObtemDataOcorrenciaServidorQuery query = new ObtemDataOcorrenciaServidorQuery();
            query.serCodigo = serCodigo;
            query.tocCodigo = tocCodigo;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erro.listar.ocorrencias", responsavel, ex);
        }
    }

    @Override
    public int countOrsRegistroServidor(TransferObject toOrsRegistroServidor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaOcorrenciaRegistroServidorQuery query = new ListaOcorrenciaRegistroServidorQuery();
            query.count = true;
            query.rseCodigo = (String) toOrsRegistroServidor.getAttribute(Columns.ORS_RSE_CODIGO);
            query.tocCodigo = (String) toOrsRegistroServidor.getAttribute(Columns.ORS_TOC_CODIGO);
            return query.executarContador();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erro.contar.ocorrencias", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> findRegistroServidoresByMatriculas(List<String> rseMatriculas, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistroServidorQuery listaRegistroServidorQuery = new ListaRegistroServidorQuery();
            listaRegistroServidorQuery.rseMatriculas = rseMatriculas;
            return listaRegistroServidorQuery.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void setRseQtdAdeDefault(List<String> cnvCodigo) throws ServidorControllerException {
        try {
            final ServidorDAO dao = DAOFactory.getDAOFactory().getServidorDAO();
            dao.setRseQtdAdeDefault(cnvCodigo);
        } catch (final DAOException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", (AcessoSistema) null, ex);
        }
    }

    @Override
    public TransferObject getRegistroServidorPelaMatricula(String serCodigo, String orgCodigo, String estCodigo, String rseMatricula, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            TransferObject rse = null;
            final ListaRegistrosServidoresQuery query = new ListaRegistrosServidoresQuery(serCodigo, orgCodigo, estCodigo, rseMatricula);
            final List<TransferObject> servidores = query.executarDTO();

            if ((servidores != null) && (servidores.size() > 0)) {
                if (servidores.size() == 1) {
                    // Se encontrou apenas um, então este será o retorno da operação
                    final TransferObject servidorTmp = servidores.get(0);
                    final String srsCodigo = servidorTmp.getAttribute(Columns.SRS_CODIGO).toString();
                    if (!CodedValues.SRS_INATIVOS.contains(srsCodigo)) {
                        rse = servidorTmp;
                    }
                } else {
                    // Se encontrou mais de um, retorna aquele que possui maior margem restante
                    Double margemRest = Double.NEGATIVE_INFINITY;
                    for (final TransferObject servidorTmp : servidores) {
                        final Double margemRestTmp = Double.valueOf(servidorTmp.getAttribute(Columns.RSE_MARGEM_REST).toString());
                        final String srsCodigoTmp = servidorTmp.getAttribute(Columns.SRS_CODIGO).toString();
                        if ((margemRest.compareTo(margemRestTmp) < 0) && !CodedValues.SRS_INATIVOS.contains(srsCodigoTmp)) {
                            margemRest = margemRestTmp;
                            rse = servidorTmp;
                        }
                    }
                }
            }
            return rse;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /*****************************************************************************/

    @Override
    public List<TransferObject> getEstCivil(AcessoSistema responsavel) {
        try {
            final ListaEstadoCivilQuery query = new ListaEstadoCivilQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            return null;
        }
    }

    @Override
    public String getEstCivil(String estCvlCodigo, AcessoSistema responsavel) {
        try {
            if (!TextHelper.isNull(estCvlCodigo)) {
                final ListaEstadoCivilQuery query = new ListaEstadoCivilQuery();
                query.estCvlCodigo = estCvlCodigo;

                final List<TransferObject> estCivil = query.executarDTO();
                if ((estCivil != null) && (estCivil.size() > 0)) {
                    final TransferObject to = estCivil.get(0);
                    return (String) to.getAttribute(Columns.EST_CIVIL_DESCRICAO);
                }
            }

            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            return null;
        }
    }

    @Override
    public List<TransferObject> getNivelEscolaridade(AcessoSistema responsavel) {
        try {
            final ListaNivelEscolaridadeQuery query = new ListaNivelEscolaridadeQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            return null;
        }
    }

    @Override
    public String getNivelEscolaridade(String nesCodigo, AcessoSistema responsavel) {
        try {
            if (!TextHelper.isNull(nesCodigo)) {
                final ListaNivelEscolaridadeQuery query = new ListaNivelEscolaridadeQuery();
                query.nesCodigo = nesCodigo;

                final List<TransferObject> nivelEscolaridadeList = query.executarDTO();
                if ((nivelEscolaridadeList != null) && (nivelEscolaridadeList.size() > 0)) {
                    final TransferObject to = nivelEscolaridadeList.get(0);
                    return (String) to.getAttribute(Columns.NES_DESCRICAO);
                }
            }

            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            return null;
        }
    }

    @Override
    public List<TransferObject> getTipoHabitacao(AcessoSistema responsavel) {
        try {
            final ListaTipoHabitacaoQuery query = new ListaTipoHabitacaoQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            return null;
        }
    }

    @Override
    public String getTipoHabitacao(String thaCodigo, AcessoSistema responsavel) {
        try {
            if (!TextHelper.isNull(thaCodigo)) {
                final ListaTipoHabitacaoQuery query = new ListaTipoHabitacaoQuery();
                query.thaCodigo = thaCodigo;

                final List<TransferObject> tipoHabitacaoList = query.executarDTO();
                if ((tipoHabitacaoList != null) && (tipoHabitacaoList.size() > 0)) {
                    final TransferObject to = tipoHabitacaoList.get(0);
                    return (String) to.getAttribute(Columns.THA_DESCRICAO);
                }
            }

            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            return null;
        }
    }

    @Override
    public String buscaImgServidor(String serCpf, String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ServidorDAO dao = DAOFactory.getDAOFactory().getServidorDAO();
            return dao.buscaImgServidor(serCpf, rseCodigo);

        } catch (final DAOException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    // Pesquisa o cargo do servidor e retorna uma lista de cargos
    @Override
    public List<TransferObject> lstCargo(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaCargoRegistroServidorQuery query = new ListaCargoRegistroServidorQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> findCargoByIdentificador(String crsIdentificador, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaCargoRegistroServidorQuery query = new ListaCargoRegistroServidorQuery();
            query.crsIdentificador = crsIdentificador;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    // Pesquisa o padrão do servidor e retorna uma lista
    @Override
    public List<TransferObject> lstPadrao(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaPadraoRegistroServidorQuery query = new ListaPadraoRegistroServidorQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> findPadraoByIdentificador(String prsIdentificador, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaPadraoRegistroServidorQuery query = new ListaPadraoRegistroServidorQuery();
            query.prsIdentificador = prsIdentificador;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstPosto(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaPostoRegistroServidorQuery query = new ListaPostoRegistroServidorQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstTipoRegistroServidor(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaTipoRegistroServidorQuery query = new ListaTipoRegistroServidorQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstCapacidadeCivil(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaCapacidadeRegistroServidorQuery query = new ListaCapacidadeRegistroServidorQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    // Pesquisa o Sub-Orgão do servidor e retorna todos eles numa lista
    @Override
    public List<TransferObject> lstSubOrgao(AcessoSistema responsavel, String orgCodigo) throws ServidorControllerException {
        try {
            final ListaSubOrgaoQuery query = new ListaSubOrgaoQuery();
            query.orgCodigo = orgCodigo;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> findSubOrgaoByIdentificador(String sboIdentificador, String orgCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaSubOrgaoQuery query = new ListaSubOrgaoQuery();
            query.orgCodigo = orgCodigo;
            query.sboIdentificador = sboIdentificador;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    // Pesquisa a unidade do servidor e retorna todas numa lista
    @Override
    public List<TransferObject> lstUnidade(AcessoSistema responsavel, String sboCodigo) throws ServidorControllerException {
        try {
            final ListaUnidadeQuery query = new ListaUnidadeQuery();
            query.sboCodigo = sboCodigo;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> findUnidadeByIdentificador(String uniIdentificador, String sboCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaUnidadeQuery query = new ListaUnidadeQuery();
            query.sboCodigo = sboCodigo;
            query.uniIdentificador = uniIdentificador;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstStatusRegistroServidor(boolean ignoraStatusExcluidos, boolean ignoraStatusBloqSeguranca, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaStatusRegistroServidorQuery query = new ListaStatusRegistroServidorQuery();
            query.ignoraStatusExcluidos = ignoraStatusExcluidos;
            query.ignoraStatusBloqSeguranca = ignoraStatusBloqSeguranca;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> selectVincRegistroServidor(boolean ativos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaVinculoRegistroServidorQuery query = new ListaVinculoRegistroServidorQuery();
            query.ativo = ativos;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> findVincRegistroServidor(String vrsIdentificador, boolean ativos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaVinculoRegistroServidorQuery query = new ListaVinculoRegistroServidorQuery();
            query.ativo = ativos;
            query.vrsIdentificador = vrsIdentificador;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /************************* HISTORICO MARGEM **********************************/

    @Override
    public List<TransferObject> pesquisarHistoricoMargem(String rseCodigo, int offset, int count, TransferObject criterio, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaHistoricoMargemQuery query = new ListaHistoricoMargemQuery(responsavel);
            query.rseCodigo = rseCodigo;
            if (count != -1) {
                query.maxResults = count;
                query.firstResult = offset;
            }
            setaCriterioHistoricoMargemQuery(query, criterio);

            final LogDelegate log = new LogDelegate(responsavel, Log.HISTORICO_MARGEM, Log.SELECT, Log.LOG_INFORMACAO);
            log.setRegistroServidor(rseCodigo);
            log.setMargem(criterio.getAttribute("marCodigo") != null ? criterio.getAttribute("marCodigo").toString() : null);
            log.write();

            return query.executarDTO();
        } catch (final LogControllerException | HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public int countHistoricoMargem(String rseCodigo, TransferObject criterio, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaHistoricoMargemQuery query = new ListaHistoricoMargemQuery(responsavel);
            query.count = true;
            query.rseCodigo = rseCodigo;
            setaCriterioHistoricoMargemQuery(query, criterio);
            return query.executarContador();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    private void setaCriterioHistoricoMargemQuery(ListaHistoricoMargemQuery query, TransferObject criterio) {
        if (criterio != null) {
            if (!TextHelper.isNull(criterio.getAttribute("marCodigo"))) {
                try {
                    query.marCodigo = Short.valueOf(criterio.getAttribute("marCodigo").toString());
                } catch (final NumberFormatException e) {
                    LOG.error(e.getMessage(), e);
                    query.marCodigo = null;
                }
            }
            if (!TextHelper.isNull(criterio.getAttribute("adeNumero"))) {
                try {
                    query.adeNumero = Long.valueOf(criterio.getAttribute("adeNumero").toString());
                } catch (final NumberFormatException e) {
                    LOG.error(e.getMessage(), e);
                    query.adeNumero = null;
                }
            }
            if (!TextHelper.isNull(criterio.getAttribute("periodoIni"))) {
                try {
                    query.periodoIni = DateHelper.parse(criterio.getAttribute("periodoIni").toString() + " 00:00:00", LocaleHelper.getDateTimePattern());
                } catch (final ParseException e) {
                    LOG.error(e.getMessage(), e);
                    query.periodoIni = null;
                }
            }
            if (!TextHelper.isNull(criterio.getAttribute("periodoFim"))) {
                try {
                    query.periodoFim = DateHelper.parse(criterio.getAttribute("periodoFim").toString() + " 23:59:59", LocaleHelper.getDateTimePattern());
                } catch (final ParseException e) {
                    LOG.error(e.getMessage(), e);
                    query.periodoFim = null;
                }
            }
            if (!TextHelper.isNull(criterio.getAttribute("hmrOperacao"))) {
                query.hmrOperacao = criterio.getAttribute("hmrOperacao").toString();
            }
        }
    }

    /**
     * Recupera o histórico de variação de margem de um período de tempo de um determinado registro servidor.
     * @param rseCodigo
     * @param marCodigo
     * @param qtdeMesesPesquisa
     * @param responsavel
     * @return
     * @throws AutorizacaoControllerException
     */
    @Override
    public List<TransferObject> lstHistoricoVariacaoMargem(String rseCodigo, Short marCodigo, int qtdeMesesPesquisa, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaHistoricoVariacaoMargemQuery query = new ListaHistoricoVariacaoMargemQuery(qtdeMesesPesquisa);
            query.rseCodigo = rseCodigo;
            query.marCodigo = marCodigo;

            final LogDelegate log = new LogDelegate(responsavel, Log.HISTORICO_MARGEM, Log.SELECT, Log.LOG_INFORMACAO);
            log.setRegistroServidor(rseCodigo);
            log.setMargem(marCodigo.toString());
            log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.parametro.pesquisa.quantidade.meses", responsavel, String.valueOf(qtdeMesesPesquisa)));
            log.write();

            return query.executarDTO();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /*****************************************************************************/

    @Override
    public int countConvenioBloqueados(String rseCodigo, String orgCodigo, String csaCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaBloqueioConvenioServidorQuery query = new ListaBloqueioConvenioServidorQuery();
            query.count = true;
            query.rseCodigo = rseCodigo;
            query.orgCodigo = orgCodigo;
            query.csaCodigo = csaCodigo;
            return query.executarContador();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> selectConvenioBloqueados(String rseCodigo, String orgCodigo, String csaCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaBloqueioConvenioServidorQuery query = new ListaBloqueioConvenioServidorQuery();
            query.rseCodigo = rseCodigo;
            query.orgCodigo = orgCodigo;
            query.csaCodigo = csaCodigo;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Valida a data de nascimento do servidor caso a mesma esteja habilitada para o serviço dado.
     */
    @Override
    public boolean isDataNascServidorValida(String dataAValidar, String dataServidor, String svcCodigo, String dateFormat, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final CustomTransferObject paramCTO = parametroController.getParamSvcCse(svcCodigo, CodedValues.TPS_VALIDAR_DATA_NASCIMENTO_NA_RESERVA, responsavel);
            if (paramCTO != null) {
                final String paramValue = paramCTO.getAttribute(Columns.PSE_VLR).toString();
                final boolean validaData = ("1".equals(paramValue));

                if (validaData && ((dataAValidar == null) || (dataServidor == null) || (DateHelper.dateDiff(dataAValidar, dataServidor, dateFormat, null, "DIAS") != 0))) {
                    return false;
                } else {
                    return true;
                }
            } else {
                return true;
            }

        } catch (final RuntimeException re) {
            throw new ServidorControllerException("mensagem.dataMalFormatada", responsavel);
        } catch (final Exception slx) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, slx);
        }
    }

    /**
     * Realiza a transferência de valores entre margens.
     * @param registroServidor
     * @param transfTotal
     * @param valor
     * @param marCodigoOrigem
     * @param marCodigoDestino
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public boolean transferirMargem(RegistroServidorTO registroServidor, String transfTotal, BigDecimal valor, Short marCodigoOrigem, Short marCodigoDestino, AcessoSistema responsavel) throws ServidorControllerException {
        boolean validacaoOk = false;

        // A transferência de margem só deve ser realizada se o servidor estiver ativo
        if (CodedValues.SRS_ATIVO.equals(registroServidor.getSrsCodigo())) {
            // Parâmetro para casamento de margem
            final boolean margem1CasadaMargem3Lateral = ParamSist.paramEquals(CodedValues.TPC_MARGEM_1_CASADA_MARGEM_3_LATERAL, CodedValues.TPC_SIM, responsavel);

            if (margem1CasadaMargem3Lateral && marCodigoOrigem.equals(CodedValues.INCIDE_MARGEM_SIM_3) && marCodigoDestino.equals(CodedValues.INCIDE_MARGEM_SIM)) {
                // Se margem casada lateralmente 1 com 3, ao transferir da margem 3 para 1 ao invés de transferir
                // o valor baseado na rse_margem_rest_3, tem que transferir pela diferença (rse_margem_3 - rse_margem_usada_3),
                // que, neste caso, é diferente da restante_3 por causa do casamento.

                if (CodedValues.TPC_SIM.equals(transfTotal)) {
                    valor = registroServidor.getRseMargemRest3();
                }
                if ((valor.compareTo(BigDecimal.ZERO) > 0) && (registroServidor.getRseMargemRest3().compareTo(valor) >= 0)) {
                    validacaoOk = true;

                    // Valor a ser transferido = (rse_margem_3 - rse_margem_usada_3) - (rse_margem_rest_3 - valor)
                    final BigDecimal margemRest3Real = registroServidor.getRseMargem3().subtract(registroServidor.getRseMargemUsada3());
                    final BigDecimal novaMargemRest3 = registroServidor.getRseMargemRest3().subtract(valor);
                    valor = margemRest3Real.subtract(novaMargemRest3);

                    // Subtrai da Margem 3
                    registroServidor.setRseMargem3(registroServidor.getRseMargem3().subtract(valor));
                    registroServidor.setRseMargemRest3(novaMargemRest3);
                    // Soma na margem 1
                    registroServidor.setRseMargem(registroServidor.getRseMargem().add(valor));
                    registroServidor.setRseMargemRest(registroServidor.getRseMargemRest().add(valor));
                }

            } else {
                // Margem origem deve ter seu valor diminuido
                if (marCodigoOrigem.equals(CodedValues.INCIDE_MARGEM_SIM)) {
                    if (CodedValues.TPC_SIM.equals(transfTotal)) {
                        valor = registroServidor.getRseMargemRest();
                    }
                    if ((valor.compareTo(BigDecimal.ZERO) > 0) && (registroServidor.getRseMargemRest().compareTo(valor) >= 0)) {
                        registroServidor.setRseMargem(registroServidor.getRseMargem().subtract(valor));
                        registroServidor.setRseMargemRest(registroServidor.getRseMargemRest().subtract(valor));
                        validacaoOk = true;
                    }

                } else if (marCodigoOrigem.equals(CodedValues.INCIDE_MARGEM_SIM_2)) {
                    if (CodedValues.TPC_SIM.equals(transfTotal)) {
                        valor = registroServidor.getRseMargemRest2();
                    }
                    if ((valor.compareTo(BigDecimal.ZERO) > 0) && (registroServidor.getRseMargemRest2().compareTo(valor) >= 0)) {
                        registroServidor.setRseMargem2(registroServidor.getRseMargem2().subtract(valor));
                        registroServidor.setRseMargemRest2(registroServidor.getRseMargemRest2().subtract(valor));
                        validacaoOk = true;
                    }

                } else if (marCodigoOrigem.equals(CodedValues.INCIDE_MARGEM_SIM_3)) {
                    if (CodedValues.TPC_SIM.equals(transfTotal)) {
                        valor = registroServidor.getRseMargemRest3();
                    }
                    if ((valor.compareTo(BigDecimal.ZERO) > 0) && (registroServidor.getRseMargemRest3().compareTo(valor) >= 0)) {
                        registroServidor.setRseMargem3(registroServidor.getRseMargem3().subtract(valor));
                        registroServidor.setRseMargemRest3(registroServidor.getRseMargemRest3().subtract(valor));
                        validacaoOk = true;
                    }
                }

                // Margem destino deve ter seu valor aumentado
                if (marCodigoDestino.equals(CodedValues.INCIDE_MARGEM_SIM)) {
                    registroServidor.setRseMargem(registroServidor.getRseMargem().add(valor));
                    registroServidor.setRseMargemRest(registroServidor.getRseMargemRest().add(valor));

                } else if (marCodigoDestino.equals(CodedValues.INCIDE_MARGEM_SIM_2)) {
                    registroServidor.setRseMargem2(registroServidor.getRseMargem2().add(valor));
                    registroServidor.setRseMargemRest2(registroServidor.getRseMargemRest2().add(valor));

                } else if (marCodigoDestino.equals(CodedValues.INCIDE_MARGEM_SIM_3)) {
                    registroServidor.setRseMargem3(registroServidor.getRseMargem3().add(valor));
                    registroServidor.setRseMargemRest3(registroServidor.getRseMargemRest3().add(valor));
                }
            }

            if (validacaoOk) {
                // Atualizacao das margens no banco
                updateRegistroServidor(registroServidor, null, false, false, true, true, responsavel);
            }
        } else {
            throw new ServidorControllerException("mensagem.erro.transferencia.margem.nao.pode.ser.realizada.pois.servidor.nao.esta.ativo", responsavel);
        }

        return validacaoOk;
    }

    /**
     * lista registro servidor de usuário servidor dado pelo login
     * @param usuLogin - login do usuário servidor
     * @param recuperaRseExcluidos - recupera registros excluídos?
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public List<TransferObject> lstRegistroServidorUsuarioSer(String usuLogin, boolean recuperaRseExcluidos, AcessoSistema responsavel) throws ServidorControllerException {
        final ListaRegistroServidorUsuarioSerQuery query = new ListaRegistroServidorUsuarioSerQuery();
        query.recuperaRseExcluido = recuperaRseExcluidos;
        query.usuLogin = usuLogin;

        try {
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * lista registro servidor de usuário servidor dado pelo cpf
     * @param serCpf - cpf do usuário servidor
     * @param recuperaRseExcluidos - recupera registros excluídos?
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public List<TransferObject> lstRegistroServidorSerCodigo(String serCodigo, boolean recuperaRseExcluidos, AcessoSistema responsavel) throws ServidorControllerException {

        final ListaRegistroServidorSerCodigoQuery query = new ListaRegistroServidorSerCodigoQuery();

        query.serCodigo = serCodigo;
        query.recuperaRseExcluido = recuperaRseExcluidos;

        try {
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * retorna a quantidade de registro servidor de usuário servidor dado pelo código (ser_codigo)
     * @param serCodigo - código do servidor
     * @param recuperaRseExcluidos - recupera registros excluídos?
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public int countRegistroServidorSerCodigo(String serCodigo, boolean recuperaRseExcluidos, AcessoSistema responsavel) throws ServidorControllerException {

        final ListaRegistroServidorSerCodigoQuery query = new ListaRegistroServidorSerCodigoQuery();
        query.count = true;
        query.serCodigo = serCodigo;
        query.recuperaRseExcluido = recuperaRseExcluidos;

        try {
            return query.executarContador();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * verifica se ja existe um determinado email cadastrado para um servidor
     * @param serEmail - email do servidor
     * @param serCpfExceto - lista de CPFs ignorados na pesquisa
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public boolean existeEmailCadastrado(String serEmail, String serCpfExceto, AcessoSistema responsavel) throws ServidorControllerException {
        boolean existeEmailCadastrado = false;
        try {
            if (ParamSist.paramEquals(CodedValues.TPC_IMPEDE_EMAIL_IGUAL_ENTRE_SER_CPF, CodedValues.TPC_SIM, responsavel)) {
                final ObtemTotalServidoresPorEmailCelularQuery query = new ObtemTotalServidoresPorEmailCelularQuery();
                query.serEmail = serEmail;
                query.serCpfExceto = serCpfExceto;
                existeEmailCadastrado = query.executarContador() > 0;
            }
            if (!existeEmailCadastrado && ParamSist.paramEquals(CodedValues.TPC_IMPEDE_EMAIL_IGUAL_ENTRE_USU_E_SER, CodedValues.TPC_SIM, responsavel)) {
                final ObtemTotalUsuariosPorEmailQuery query = new ObtemTotalUsuariosPorEmailQuery();
                query.usuEmail = serEmail;
                query.usuCpfExceto = serCpfExceto;
                existeEmailCadastrado = query.executarContador() > 0;
            }
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
        return existeEmailCadastrado;
    }

    /**
     * verifica se ja existe um determinado celular cadastrado para um servidor
     * @param serCelular - celular do servidor
     * @param serCpfExceto - lista de CPFs ignorados na pesquisa
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    private boolean existeCelularCadastrado(String serCelular, String serCpfExceto, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ObtemTotalServidoresPorEmailCelularQuery query = new ObtemTotalServidoresPorEmailCelularQuery();
            query.serCelular = serCelular;
            query.serCpfExceto = serCpfExceto;
            return query.executarContador() > 0;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Lista tipos de base de cálculo
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public List<TransferObject> lstTipoBaseCalculo(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaTipoBaseCalculoQuery query = new ListaTipoBaseCalculoQuery();
            return query.executarDTO();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Sorteia um pergunta de dados cadastrais do grupo informado.
     *
     * @param pdcGrupo
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public TransferObject sorteiaPerguntaDadosCadastrais(Short pdcGrupo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaPerguntaDadosCadastraisQuery query = new ListaPerguntaDadosCadastraisQuery();
            query.pdcGrupo = pdcGrupo;

            final List<TransferObject> lista = query.executarDTO();
            if ((lista != null) && !lista.isEmpty()) {
                Collections.shuffle(lista, new SecureRandom());
                return lista.get(0);
            }

            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public boolean validaPerguntaDadosCadastrais(String rseCodigo, Short pdcGrupo, Short pdcNumero, String resposta, AcessoSistema responsavel) throws ServidorControllerException {
        if (TextHelper.isNull(pdcGrupo)) {
            throw new ServidorControllerException("mensagem.grupo.pergunta.dados.cadastrais.obrigatorio", responsavel);
        }

        if (TextHelper.isNull(pdcNumero)) {
            throw new ServidorControllerException("mensagem.pergunta.dados.cadastrais.obrigatorio", responsavel);
        }

        if (TextHelper.isNull(resposta)) {
            throw new ServidorControllerException("mensagem.resposta.pergunta.dados.cadastrais.obrigatorio", responsavel);
        }

        String pdcCampo = "";
        try {
            final PerguntaDadosCadastraisId id = new PerguntaDadosCadastraisId(pdcGrupo, pdcNumero);
            final PerguntaDadosCadastrais pdc = PerguntaDadosCadastraisHome.findByPrimaryKey(id);
            pdcCampo = pdc.getPdcCampo();
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.pergunta.dados.cadastrais.nao.existe", responsavel, ex);
        }

        if (TextHelper.isNull(pdcCampo)) {
            throw new ServidorControllerException("mensagem.erro.pergunta.dados.cadastrais.configuracao", responsavel);
        }

        final TransferObject servidor = buscaServidor(rseCodigo, responsavel);

        if (servidor == null) {
            throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", responsavel);
        }

        final String[] campo = pdcCampo.split(";");
        String atributo = String.valueOf(servidor.getAttribute(campo[0]));

        if (campo.length == 3) {
            atributo = StringUtils.substring(atributo, Integer.parseInt(campo[1]), Integer.parseInt(campo[2]));
        } else if (campo.length == 2) {
            atributo = StringUtils.substring(atributo, Integer.parseInt(campo[1]));
        }

        // Se não existe resposta para a pergunta, comparação será realizada com vazio, retornando sempre resposta incorreta
        if (TextHelper.isNull(atributo)) {
            atributo = "";
        }

        return resposta.trim().equals(atributo.trim());

    }

    private TransferObject buscaServidor(String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaServidorRseCodigoQuery query = new ListaServidorRseCodigoQuery(rseCodigo);
            final List<TransferObject> lista = query.executarDTO();
            TransferObject servidor = null;

            if ((lista != null) && !lista.isEmpty()) {
                servidor = lista.get(0);
            }

            return servidor;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * cadastrar/atualizar email do servidor e do usuário do servidor
     * @param protocoloCodigo
     * @param email
     * @param responsavel
     * @param usuarioSuporteResponsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public void cadastrarEmailServidor(String rseCodigo, String email, String protocoloCodigo, AcessoSistema responsavel, AcessoSistema usuarioSuporteResponsavel) throws ServidorControllerException {
        try {
            // atualiza email do servidor e cria ocorrência de alteração pelo totem
            final ServidorTransferObject servidor = findServidor(responsavel.getCodigoEntidade(), responsavel);
            servidor.setSerEmail(email);
            final String usuCodigo = responsavel.getUsuCodigo();

            // atualiza email do usuário do servidor e cria ocorrência de alteração pelo totem
            if (!TextHelper.isNull(usuCodigo)) {
                final UsuarioTransferObject usuarioSer = usuarioController.findUsuario(usuCodigo, responsavel);
                // ocorrência de usuário de servidor
                final OcorrenciaUsuarioTransferObject ocorrenciaUsu = new OcorrenciaUsuarioTransferObject();
                ocorrenciaUsu.setUsuCodigo(usuCodigo);
                ocorrenciaUsu.setTocCodigo(CodedValues.TOC_CADASTRO_EMAIL_SERVIDOR_TOTEM);
                ocorrenciaUsu.setOusUsuCodigo(usuCodigo);
                final String emailAnterior = usuarioSer.getUsuEmail() != null ? usuarioSer.getUsuEmail() : "";
                final String msgOus = ApplicationResourcesHelper.getMessage("mensagem.informacao.email.alterado.de.arg0.para.arg1", responsavel, emailAnterior, email);
                ocorrenciaUsu.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.usuario", responsavel) + msgOus.toString());
                ocorrenciaUsu.setOusIpAcesso(responsavel.getIpUsuario());
                // atualiza email do usuário e cria ocorrência
                usuarioSer.setUsuEmail(email);
                usuarioController.updateUsuario(usuarioSer, ocorrenciaUsu, null, null, AcessoSistema.ENTIDADE_SER, usuCodigo, null, responsavel);
            }

            updateServidor(servidor, CodedValues.TOC_CADASTRO_EMAIL_SERVIDOR_TOTEM, true, responsavel);
            // Grava protocolo de senha de autorização
            // TODO criar tabela para protocolo de cadastro de email de servidor
            usuarioController.createProtocoloSenhaAutorizacao(protocoloCodigo, responsavel.getUsuCodigo(), usuarioSuporteResponsavel);

            // Gera log de protocolo de cadastro de email consumido
            // TODO criar log para protocolo de cadastro de email de servidor quando a tabela de protocolo de cadastro de email de servidor for criada
            final LogDelegate logDelegate = new LogDelegate(usuarioSuporteResponsavel, Log.PROTOCOLO_CADASTRO_EMAIL, Log.CREATE, Log.LOG_INFORMACAO);
            logDelegate.setProtocoloSenhaAutorizacao(protocoloCodigo);
            logDelegate.setRegistroServidor(rseCodigo);
            logDelegate.setUsuario(usuCodigo);
            // TODO criar status para protocolo de cadastro de email de servidor quando a tabela de protocolo de cadastro de email de servidor for criada
            final StatusProtocoloSenhaAutorizacaoEnum consumido = StatusProtocoloSenhaAutorizacaoEnum.CONSUMIDO;
            logDelegate.setStatusProtocoloSenhaAutorizacao(consumido.getCodigo());
            logDelegate.add(ApplicationResourcesHelper.getMessage("rotulo.protocolo.cadastro.email.servidor.singular", usuarioSuporteResponsavel) + ": \"" + protocoloCodigo + "\" " + consumido.getDescricao());
            logDelegate.write();

            // Cria ocorrência de usuário de autorização de senha
            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setUsuCodigo(usuCodigo);
            ocorrencia.setTocCodigo(CodedValues.TOC_AUT_CADASTRO_EMAIL_SERVIDOR_TOTEM);
            ocorrencia.setOusUsuCodigo(usuarioSuporteResponsavel.getUsuCodigo());
            ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.autorizacao.cadastro.email.servidor.host.a.host", usuarioSuporteResponsavel, protocoloCodigo.replace("_EMAIL", "")));
            ocorrencia.setOusIpAcesso(usuarioSuporteResponsavel.getIpUsuario());

            usuarioController.createOcorrenciaUsuario(ocorrencia, usuarioSuporteResponsavel);
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final UsuarioControllerException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final ServidorControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw ex;
        }
    }

    @Override
    public TransferObject recuperarDadosBanco(Short bcoCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final Banco bctInfo = BancoHome.findByPrimaryKey(bcoCodigo);
            final TransferObject retorno = new CustomTransferObject();

            retorno.setAttribute(Columns.BCO_CODIGO, bctInfo.getBcoCodigo());
            retorno.setAttribute(Columns.BCO_DESCRICAO, bctInfo.getBcoDescricao());
            retorno.setAttribute(Columns.BCO_IDENTIFICADOR, bctInfo.getBcoIdentificador());
            retorno.setAttribute(Columns.BCO_ATIVO, bctInfo.getBcoAtivo());

            return retorno;
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void aprovarCadastroServidor(RegistroServidorTO registroServidor, ServidorTransferObject servidor, boolean aprovar, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            if (aprovar) {
                // Em caso de aprovação, muda o status para ativo
                registroServidor.setSrsCodigo(CodedValues.SRS_ATIVO);

                if (servidor != null) {
                    updateServidorAndUpdateRegistroServidor(registroServidor, servidor, null, false, responsavel);
                } else {
                    updateRegistroServidorSemHistoricoMargem(registroServidor, responsavel);
                }

            } else {
                // Em caso de rejeição, muda status para excluído caso ainda esteja pendente
                if ((registroServidor.getSrsCodigo() == null) || CodedValues.SRS_PENDENTE.equals(registroServidor.getSrsCodigo())) {
                    registroServidor.setSrsCodigo(CodedValues.SRS_EXCLUIDO);
                }
                updateRegistroServidorSemHistoricoMargem(registroServidor, responsavel);

                // Cancela as consignações aguard. confirmação e deferimento caso o status seja excluído/falecido
                if (CodedValues.SRS_INATIVOS.contains(registroServidor.getSrsCodigo())) {
                    final List<TransferObject> lstAde = pesquisarConsignacaoController.pesquisaAutorizacao(registroServidor.getRseCodigo(), null, CodedValues.SAD_CODIGOS_AGUARD_CONF, responsavel);
                    if ((lstAde != null) && !lstAde.isEmpty()) {
                        final CustomTransferObject motivoOperacao = new CustomTransferObject();
                        motivoOperacao.setAttribute(Columns.TMO_CODIGO, registroServidor.getTipoMotivo());
                        motivoOperacao.setAttribute(Columns.OCA_OBS, registroServidor.getOrsObs());

                        for (final TransferObject ade : lstAde) {
                            final String adeCodigo = ade.getAttribute(Columns.ADE_CODIGO).toString();
                            motivoOperacao.setAttribute(Columns.ADE_CODIGO, adeCodigo);
                            cancelarConsignacaoController.cancelar(adeCodigo, motivoOperacao, responsavel);
                        }
                    }
                }
            }

            final LogDelegate log = new LogDelegate(responsavel, Log.REGISTRO_SERVIDOR, Log.UPDATE, Log.LOG_INFORMACAO);
            log.add(ApplicationResourcesHelper.getMessage(aprovar ? "mensagem.log.aprovacao.servidor" : "mensagem.log.rejeicao.servidor", responsavel));
            log.setRegistroServidor(registroServidor.getRseCodigo());
            log.setServidor(registroServidor.getSerCodigo());
            log.setOrgao(registroServidor.getOrgCodigo());
            log.write();

        } catch (final AutorizacaoControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException(ex);
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void updateServidorAndUpdateRegistroServidor(RegistroServidorTO registroServidor, ServidorTransferObject servidor, List<MargemTO> margens, Boolean aceiteTermoUso, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            String corpoEmailSer = "";
            if (servidor != null) {
                corpoEmailSer = updateServidor(servidor, false, responsavel);
            }

            String novoStatus = null;
            String corpoEmailRse = "";
            if (registroServidor != null) {
                final String statusAnterior = findRegistroServidor(registroServidor.getRseCodigo(), responsavel).getSrsCodigo();
                corpoEmailRse = updateRegistroServidor(registroServidor, margens, !responsavel.temPermissao(CodedValues.FUN_ALT_MARGEM_CONSIGNAVEL), true, false, true, false, false, responsavel);
                final String statusAtual = findRegistroServidor(registroServidor.getRseCodigo(), responsavel).getSrsCodigo();
                if (!statusAnterior.equals(statusAtual)) {
                    novoStatus = statusAtual;
                }
            }

            if (aceiteTermoUso) {
                // Cria ocorrencia 111
                criaOcorrenciaSER(servidor.getSerCodigo(), CodedValues.TOC_ACEITACAO_TERMO_DE_USO, ApplicationResourcesHelper.getMessage("rotulo.termo.de.uso.email.aceito.ocorrencia", responsavel), null, responsavel);
            }

            if (responsavel.isCseOrg() && (CodedValues.FUN_EDT_SERVIDOR.equals(responsavel.getFunCodigo()) || CodedValues.FUN_VALIDAR_SERVIDOR.equals(responsavel.getFunCodigo())) && ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_NOTIFICACAO_EDT_SERVIDOR, CodedValues.TPC_SIM, responsavel)) {
                if ((registroServidor != null) && (servidor != null)) {
                    EnviaEmailHelper.enviarEmailCsasAlteracaoSer(servidor, servidor.getSerCpf(), registroServidor.getRseMatricula(), novoStatus, corpoEmailSer + corpoEmailRse, responsavel);
                } else if (registroServidor != null) {
                    EnviaEmailHelper.enviarEmailCsasAlteracaoSer(registroServidor, null, registroServidor.getRseMatricula(), novoStatus, corpoEmailSer + corpoEmailRse, responsavel);
                } else {
                    EnviaEmailHelper.enviarEmailCsasAlteracaoSer(servidor, servidor.getSerCpf(), null, novoStatus, corpoEmailSer + corpoEmailRse, responsavel);
                }
            }

        } catch (final ServidorControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException(ex);
        } catch (final ViewHelperException ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    @Override
    public java.util.Date obtemDataInclusaoRegistroServidor(String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final List<OcorrenciaRegistroSer> rsList = OcorrenciaRegistroServidorHome.findByRseTocCodigo(rseCodigo, CodedValues.TOC_RSE_INCLUSAO_POR_CARGA_MARGEM);
            if (!rsList.isEmpty() && (rsList.size() > 0)) {
                final OcorrenciaRegistroSer OcorrenciaRegistroSer = rsList.iterator().next();
                return OcorrenciaRegistroSer.getOrsData();
            }
        } catch (final FindException ex) {
            throw new ServidorControllerException(ex);
        }

        return null;
    }

    @Override
    public void cancelarCadastroServidor(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final Object paramValue = ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_CSE_VALIDA_CAD_SERVIDOR, AcessoSistema.getAcessoUsuarioSistema());
            final int diasParaCancelamento = paramValue != null ? Integer.parseInt((String) paramValue) : 0;

            final TransferObject criterioSer = new CustomTransferObject();
            criterioSer.setAttribute("validaAdeSerPendente", Boolean.FALSE);

            if (diasParaCancelamento > 0) {
                final List<TransferObject> lstRegistroServidor = pesquisarServidorController.pesquisarServidorPendente(criterioSer, -1, -1, responsavel);

                if ((lstRegistroServidor != null) && (lstRegistroServidor.size() > 0)) {

                    for (final TransferObject registroServidor : lstRegistroServidor) {

                        final Date orsData = DateHelper.toSQLDate((java.util.Date) registroServidor.getAttribute(Columns.ORS_DATA));

                        //Exclui o cadastro do servidor que tiver excedido o número de
                        //dias para validação, cadastrado no parâmetro de sistema 572.
                        if (DateHelper.dayDiff(orsData) > diasParaCancelamento) {
                            final String rseCodigo = (String) registroServidor.getAttribute(Columns.RSE_CODIGO);

                            final RegistroServidor rseServidor = RegistroServidorHome.findByPrimaryKey(rseCodigo);

                            rseServidor.setStatusRegistroServidor(new StatusRegistroServidor(CodedValues.SRS_EXCLUIDO));
                            criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_CANCELANCAMENTO_AUT_CAD_SERVIDOR, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.cancelamento.automatico.cadastro.servidor", responsavel), null, responsavel);
                            AbstractEntityHome.update(rseServidor);

                            final LogDelegate log = new LogDelegate(responsavel, Log.REGISTRO_SERVIDOR, Log.UPDATE, Log.LOG_INFORMACAO);
                            log.add(ApplicationResourcesHelper.getMessage("mensagem.log.cancelamento.cadastro.servidor", responsavel));
                            log.setRegistroServidor(rseServidor.getRseCodigo());
                            log.setServidor(rseServidor.getServidor().getSerCodigo());
                            log.setOrgao(rseServidor.getOrgao().getOrgCodigo());
                            log.write();

                            // Cancela as autorizações que estiverem aguardando confirmação ou aguardando deferimento
                            final ObtemConsignacaoPorCnvSerQuery adesPorCnvSer = new ObtemConsignacaoPorCnvSerQuery();
                            adesPorCnvSer.rseCodigo = rseCodigo;
                            adesPorCnvSer.sadCodigos = CodedValues.SAD_CODIGOS_AGUARD_CONF;

                            final List<TransferObject> lstAde = adesPorCnvSer.executarDTO();
                            if ((lstAde != null) && !lstAde.isEmpty()) {
                                for (final TransferObject ade : lstAde) {
                                    final String adeCodigo = ade.getAttribute(Columns.ADE_CODIGO).toString();
                                    cancelarConsignacaoController.cancelar(adeCodigo, responsavel);
                                    EnviaEmailHelper.enviaEmailNotificacaoCsaCancelamentoCadastroServidor(ade, responsavel);
                                }
                            }

                        }

                    }

                }

            }

        } catch (final AutorizacaoControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException(ex);
        } catch (LogControllerException | FindException | UpdateException | HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void createRelRegistroServidor(String rseCodigoOrigem, String rseCodigoDestino, String tntCodigo, String usuCodigo, java.util.Date rreData, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            RelacionamentoRegistroServidorHome.createRelRegistroServidor(rseCodigoOrigem, rseCodigoDestino, tntCodigo, usuCodigo, rreData, responsavel);
        } catch (final CreateException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<EnderecoServidor> listEnderecoServidorByCodigo(String serCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            return EnderecoServidorHome.listEnderecoServidorByCodigo(serCodigo);
        } catch (final FindException e) {
            throw new ServidorControllerException("mensagem.nenhumEnderecoServidorEncontrado", (AcessoSistema) null);
        }
    }

    @Override
    public EnderecoServidor findEnderecoServidorByCodigo(String ensCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            return EnderecoServidorHome.findByPrimaryKey(ensCodigo);
        } catch (final FindException e) {
            throw new ServidorControllerException("mensagem.nenhumEnderecoServidorEncontrado", (AcessoSistema) null);
        }
    }

    @Override
    public List<TipoEndereco> listAllTipoEndereco(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            return TipoEnderecoHome.listAll();
        } catch (final FindException e) {
            throw new ServidorControllerException("mensagem.nenhumEnderecoServidorEncontrado", (AcessoSistema) null);
        }
    }

    @Override
    public EnderecoServidor createEnderecoServidor(EnderecoServidor enderecoServidor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final EnderecoServidor ens = EnderecoServidorHome.create(enderecoServidor.getServidor(), enderecoServidor.getTipoEndereco(), enderecoServidor.getEnsLogradouro(), enderecoServidor.getEnsNumero(), enderecoServidor.getEnsComplemento(), enderecoServidor.getEnsBairro(), enderecoServidor.getEnsMunicipio(), enderecoServidor.getEnsCodigoMunicipio(), enderecoServidor.getEnsUf(), enderecoServidor.getEnsCep(), enderecoServidor.getEnsAtivo());

            final TipoOcorrencia tipoOcorrencia = new TipoOcorrencia();
            tipoOcorrencia.setTocCodigo(CodedValues.TOC_INCLUSAO_ENDERECO_SERVIDOR);
            final Usuario usuario = new Usuario();
            usuario.setUsuCodigo(responsavel.getUsuCodigo());
            OcorrenciaEnderecoServidorHome.create(tipoOcorrencia, usuario, ens, null, null, ApplicationResourcesHelper.getMessage("mensagem.informacao.endereco.servidor.inclusao", responsavel), responsavel.getIpUsuario());

            final LogDelegate log = new LogDelegate(responsavel, Log.ENDERECO_SERVIDOR, Log.CREATE, Log.LOG_INFORMACAO);
            log.write();

            return ens;
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException(ex);
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void updateEnderecoServidor(EnderecoServidor enderecoServidor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final EnderecoServidor enderecoAntigo = EnderecoServidorHome.findByPrimaryKey(enderecoServidor.getEnsCodigo());

            final TipoOcorrencia tipoOcorrencia = new TipoOcorrencia();
            tipoOcorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_ENDERECO_SERVIDOR);

            boolean teveAlteracao = false;

            // Validando se a cidade e o codigo ibge passado na tela são valido no banco de dados
            final List<TransferObject> cidades = sistemaController.lstCidadeCodigoIBGE(enderecoServidor.getEnsCodigoMunicipio(), responsavel);
            if ((cidades == null) || (cidades.size() == 0) || (cidades.size() > 1)) {
                throw new ServidorControllerException("mensagem.informe.servidor.cidade", responsavel);
            } else {
                final TransferObject cidade = cidades.get(0);
                final String cidNome = (String) cidade.getAttribute(Columns.CID_NOME);

                if (!cidNome.equals(enderecoServidor.getEnsMunicipio())) {
                    throw new ServidorControllerException("mensagem.informe.servidor.cidade", responsavel);
                }
            }

            final LogDelegate log = new LogDelegate(responsavel, Log.ENDERECO_SERVIDOR, Log.UPDATE, Log.LOG_INFORMACAO);
            if (!enderecoAntigo.getTipoEndereco().getTieCodigo().equals(enderecoServidor.getTipoEndereco().getTieCodigo())) {
                log.addChangedField(Columns.ENS_TIE_CODIGO, enderecoServidor.getTipoEndereco().getTieCodigo());
                teveAlteracao = true;
            }
            if (!enderecoAntigo.getEnsBairro().equals(enderecoServidor.getEnsBairro())) {
                log.addChangedField(Columns.ENS_BAIRRO, enderecoServidor.getEnsBairro());
                teveAlteracao = true;
            }
            if (!enderecoAntigo.getEnsCep().equals(enderecoServidor.getEnsCep())) {
                log.addChangedField(Columns.ENS_CEP, enderecoServidor.getEnsCep());
                teveAlteracao = true;
            }
            if (!enderecoAntigo.getEnsMunicipio().equals(enderecoServidor.getEnsMunicipio())) {
                log.addChangedField(Columns.ENS_MUNICIPIO, enderecoServidor.getEnsMunicipio());
                teveAlteracao = true;
            }
            if (!enderecoAntigo.getEnsComplemento().equals(enderecoServidor.getEnsComplemento())) {
                log.addChangedField(Columns.ENS_COMPLEMENTO, enderecoServidor.getEnsComplemento());
                teveAlteracao = true;
            }
            if (!enderecoAntigo.getEnsUf().equals(enderecoServidor.getEnsUf())) {
                log.addChangedField(Columns.ENS_UF, enderecoServidor.getEnsUf());
                teveAlteracao = true;
            }
            if (!enderecoAntigo.getEnsNumero().equals(enderecoServidor.getEnsNumero())) {
                log.addChangedField(Columns.ENS_NUMERO, enderecoServidor.getEnsNumero());
                teveAlteracao = true;
            }
            if (!enderecoAntigo.getEnsLogradouro().equals(enderecoServidor.getEnsLogradouro())) {
                log.addChangedField(Columns.ENS_LOGRADOURO, enderecoServidor.getEnsLogradouro());
                teveAlteracao = true;
            }
            if ((enderecoAntigo.getEnsCodigoMunicipio() == null) || !enderecoAntigo.getEnsCodigoMunicipio().equals(enderecoServidor.getEnsCodigoMunicipio())) {
                log.addChangedField(Columns.ENS_CODIGO_MUNICIPIO, enderecoServidor.getEnsCodigoMunicipio());
                teveAlteracao = true;
            }
            if (((enderecoAntigo.getEnsCodigoMunicipio() == null) && (enderecoServidor.getEnsCodigoMunicipio() != null)) || ((enderecoAntigo.getEnsCodigoMunicipio() != null) && (enderecoServidor.getEnsCodigoMunicipio() == null)) || ((enderecoAntigo.getEnsCodigoMunicipio() != null) && (enderecoServidor.getEnsCodigoMunicipio() != null) && (enderecoServidor.getEnsCodigoMunicipio().compareTo(enderecoAntigo.getEnsCodigoMunicipio()) != 0))) {
                log.addChangedField(Columns.ENS_CODIGO_MUNICIPIO, enderecoServidor.getEnsCodigoMunicipio());
                teveAlteracao = true;
            }

            if (teveAlteracao) {
                final Usuario usuario = new Usuario();
                usuario.setUsuCodigo(responsavel.getUsuCodigo());
                OcorrenciaEnderecoServidorHome.create(tipoOcorrencia, usuario, enderecoServidor, null, null, ApplicationResourcesHelper.getMessage("mensagem.informacao.endereco.servidor.alteracao", responsavel), responsavel.getIpUsuario());

                AbstractEntityHome.update(enderecoServidor);
                log.write();
            }
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void removeEnderecoServidor(EnderecoServidor enderecoServidor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            enderecoServidor.setEnsAtivo(CodedValues.STS_INATIVO);

            AbstractEntityHome.update(enderecoServidor);

            final TipoOcorrencia tipoOcorrencia = new TipoOcorrencia();
            tipoOcorrencia.setTocCodigo(CodedValues.TOC_EXCLUSAO_ENDERECO_SERVIDOR);
            final Usuario usuario = new Usuario();
            usuario.setUsuCodigo(responsavel.getUsuCodigo());
            OcorrenciaEnderecoServidorHome.create(tipoOcorrencia, usuario, enderecoServidor, null, null, ApplicationResourcesHelper.getMessage("mensagem.informacao.endereco.servidor.exclusao", responsavel), responsavel.getIpUsuario());

            final LogDelegate log = new LogDelegate(responsavel, Log.ENDERECO_SERVIDOR, Log.DELETE, Log.LOG_INFORMACAO);
            log.write();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> listarMargensRse(String rseCodigo, String svcCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        final List<TransferObject> margens = null;

        if (TextHelper.isNull(rseCodigo)) {
            return margens;
        }

        final ListaMargemRegistroServidorQuery lstMargem = new ListaMargemRegistroServidorQuery();
        lstMargem.rseCodigo = rseCodigo;
        lstMargem.svcCodigo = svcCodigo;

        try {
            return lstMargem.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Lista servidores que possuem consignação em qualquer situação caso seja informada consignatária.
     * @param serCpf
     * @param csaCodigo Caso seja informado, verifica se o servidor possui contratos em qualquer situação com a consignatária informada
     * @param responsavel
     * @return
     * @throws ServidorControllerException
     */
    @Override
    public List<TransferObject> listarServidorPossuiAde(String serCpf, AcessoSistema responsavel) throws ServidorControllerException {
        try {

            /**
             * Verifica parâmetro de sistema para informar se a CSA pode carregar boleto para qualquer servidor ou apenas para aqueles que esta possui consignação de qualquer status,
             * sendo o padrão permitir apenas para servidores com consignação.
             */
            final boolean csaRealizaUploadSerSemAde = ParamSist.getBoolParamSist(CodedValues.TPC_CSA_UPLOAD_BOLETO_SER_NAO_POSSUI_ADE, responsavel);

            final ListaServidorPossuiAdeQuery query = new ListaServidorPossuiAdeQuery();
            query.serCpf = serCpf;

            if (!csaRealizaUploadSerSemAde) {
                query.csaCodigo = responsavel.getCsaCodigo();
            }

            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void cadastrarDispensaDigitalServidor(TransferObject criterio, TransferObject tipoMotivoOperacao, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final String serCodigo = criterio.getAttribute(Columns.SER_CODIGO).toString();
            final String serDispensaDigital = criterio.getAttribute(Columns.SER_DISPENSA_DIGITAL).toString();
            final StringBuilder msgOcs = new StringBuilder();

            criterio.setAttribute(Columns.ARQ_TAR_CODIGO, TipoArquivoEnum.ARQUIVO_DISPENSA_VALIDACAO_DIGITAL_SER.getCodigo());

            String tmoCodigo = null;
            String ocsObs = "";
            if (tipoMotivoOperacao != null) {
                tmoCodigo = tipoMotivoOperacao.getAttribute(Columns.TMO_CODIGO).toString();
                ocsObs = tipoMotivoOperacao.getAttribute(Columns.OCS_OBS).toString();
            }

            // Alterar o campo criado SER_DISPENSA_DIGITAL
            final Servidor servidor = ServidorHome.findByPrimaryKey(serCodigo);
            String tocCodigo = CodedValues.TOC_CAD_DISPENSA_VALIDACAO_DIGITAL_SER;
            if (!TextHelper.isNull(serDispensaDigital) && CodedValues.TPC_SIM.equals(serDispensaDigital)) {
                servidor.setSerDispensaDigital(CodedValues.TPC_SIM);
                msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.servidor.cadastrar.dispensa.validacao.digital", responsavel, ocsObs));
            } else {
                servidor.setSerDispensaDigital(CodedValues.TPC_NAO);
                msgOcs.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.servidor.cadastrar.validacao.digital", responsavel, ocsObs));
                tocCodigo = CodedValues.TOC_REV_DISPENSA_VALIDACAO_DIGITAL_SER;
            }
            AbstractEntityHome.update(servidor);

            // Registrar ocorrência criada no item 5
            criaOcorrenciaSER(serCodigo, tocCodigo, msgOcs.toString(), tmoCodigo, responsavel);

            // gravar os anexos e registrá-los na tabela do item 8.
            if (!TextHelper.isNull(criterio.getAttribute(Columns.ARQ_CONTEUDO))) {
                arquivoController.createArquivoServidor(criterio, responsavel);
            }

            final LogDelegate log = new LogDelegate(responsavel, Log.DISPENSA_VALIDACAO_DIGITAL, Log.UPDATE, Log.LOG_INFORMACAO);
            log.add(msgOcs.toString());
            log.setServidor(serCodigo);
            log.write();

        } catch (final FindException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", responsavel);
        } catch (UpdateException | LogControllerException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final ArquivoControllerException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException(ex);
        }
    }

    @Override
    public List<Servidor> findByCpf(String serCpf, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            return ServidorHome.findByCPF(serCpf);
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.nenhumServidorEncontrado", responsavel);
        }
    }

    @Override
    public boolean validaServidorDentroPrazoAcessoSistemaSemValidacaoEmail(String serCodigo, java.util.Date dataOcorrencia, AcessoSistema responsavel) throws ServidorControllerException {

        final int qtdeDiasQueUsuarioPodeUsarSistemaSemValidarEmail = TextHelper.isNum(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_ACESSO_SISTEMA_SERVIDOR_SEM_VALIDACAO_EMAIL, responsavel)) ? Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_ACESSO_SISTEMA_SERVIDOR_SEM_VALIDACAO_EMAIL, responsavel).toString()) : 0;

        if (qtdeDiasQueUsuarioPodeUsarSistemaSemValidarEmail > 0) {

            Servidor servidor = null;
            try {
                servidor = ServidorHome.findByPrimaryKey(serCodigo);
            } catch (final FindException ex) {
                LOG.error(ex.getMessage(), ex);
                throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
            }
            final int resultadoEmDiasEntreDataAtualMenosDataOcorrenciaEmailIncorreto = DateHelper.dayDiff(dataOcorrencia);

            //Se o usuário servidor já possui uma ocorrencia de e-mail incorreto precisamos validar a data da ocorrencia do parâmetro 705 e a data atual para saber se o mesmo pode ter acesso ao sistema.
            //Caso o usuario servidor já realizou a atualização do e-mail, o acesso ao sistema está liberado.
            if ((servidor != null) && TextHelper.isNull(servidor.getSerDataValidacaoEmail()) && (qtdeDiasQueUsuarioPodeUsarSistemaSemValidarEmail < resultadoEmDiasEntreDataAtualMenosDataOcorrenciaEmailIncorreto)) {
                return false;
            }
        } else {
            return false;
        }
        return true;
    }

    @Override
    public void updateMargensRegistroServidor(String rseCodigo, List<MargemTO> margens, String compulsorio, String tmoCodigo, String obsMotivoOperacao, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final LogDelegate logMargem = new LogDelegate(responsavel, Log.REGISTRO_SERVIDOR, Log.UPDATE, Log.LOG_INFORMACAO);
            logMargem.setRegistroServidor(rseCodigo);

            final StringBuilder margemAlterada = new StringBuilder();

            // Busca o registro servidor passado por parâmetro
            final RegistroServidor rseBean = RegistroServidorHome.findByPrimaryKeyForUpdate(rseCodigo);
            boolean salvarRSE = false;
            boolean liberouMargem = false;

            for (final MargemTO margemTO : margens) {
                final Short marCodigo = margemTO.getMarCodigo();
                MargemRegistroServidor mrsBean = null;
                BigDecimal margemAntigaFolha = null;
                BigDecimal margemAntigaUsada = null;
                BigDecimal margemAntigaRestante = null;
                BigDecimal margemNovaFolha = null;

                if (marCodigo.equals(CodedValues.INCIDE_MARGEM_SIM)) {
                    margemAntigaFolha = rseBean.getRseMargem();
                    margemAntigaUsada = rseBean.getRseMargemUsada() != null ? rseBean.getRseMargemUsada() : new BigDecimal("0.00");
                    margemAntigaRestante = rseBean.getRseMargemRest() != null ? rseBean.getRseMargemRest() : new BigDecimal("0.00");
                    margemNovaFolha = margemTO.getMrsMargem() != null ? margemTO.getMrsMargem() : new BigDecimal("0.00");

                } else if (marCodigo.equals(CodedValues.INCIDE_MARGEM_SIM_2)) {
                    margemAntigaFolha = rseBean.getRseMargem2();
                    margemAntigaUsada = rseBean.getRseMargemUsada2() != null ? rseBean.getRseMargemUsada2() : new BigDecimal("0.00");
                    margemAntigaRestante = rseBean.getRseMargemRest2() != null ? rseBean.getRseMargemRest2() : new BigDecimal("0.00");
                    margemNovaFolha = margemTO.getMrsMargem() != null ? margemTO.getMrsMargem() : new BigDecimal("0.00");

                } else if (marCodigo.equals(CodedValues.INCIDE_MARGEM_SIM_3)) {
                    margemAntigaFolha = rseBean.getRseMargem3();
                    margemAntigaUsada = rseBean.getRseMargemUsada3() != null ? rseBean.getRseMargemUsada3() : new BigDecimal("0.00");
                    margemAntigaRestante = rseBean.getRseMargemRest3() != null ? rseBean.getRseMargemRest3() : new BigDecimal("0.00");
                    margemNovaFolha = margemTO.getMrsMargem() != null ? margemTO.getMrsMargem() : new BigDecimal("0.00");

                } else {
                    final MargemRegistroServidorId mrsPK = new MargemRegistroServidorId(marCodigo, rseCodigo);
                    mrsBean = MargemRegistroServidorHome.findByPrimaryKeyForUpdate(mrsPK);

                    margemAntigaFolha = mrsBean.getMrsMargem();
                    margemAntigaUsada = mrsBean.getMrsMargemUsada() != null ? mrsBean.getMrsMargemUsada() : new BigDecimal("0.00");
                    margemAntigaRestante = mrsBean.getMrsMargemRest() != null ? mrsBean.getMrsMargemRest() : new BigDecimal("0.00");
                    margemNovaFolha = margemTO.getMrsMargem() != null ? margemTO.getMrsMargem() : new BigDecimal("0.00");
                }

                // Se nada mudou, pula para a próxima margem
                if (margemAntigaFolha.compareTo(margemNovaFolha) == 0) {
                    continue;
                }

                // A margem restante do servidor será o valor da margem informada subtraída do valor da margem usada atual
                final BigDecimal margemRestNova = margemNovaFolha.subtract(margemAntigaUsada);

                // Adiciona a alteração ao log
                logMargem.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.atributo.margem.arg0.folha.alterado.arg1.para.arg2", responsavel, marCodigo.toString(), logMargem.formatObject(margemAntigaFolha), logMargem.formatObject(margemNovaFolha)));
                // Gera observação para gravação da ocorrência
                margemAlterada.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.arg0.alterada.de.arg1.para.arg2", responsavel, MargemHelper.getInstance().getMarDescricao(marCodigo, responsavel).toUpperCase(), margemAntigaFolha.toString(), margemNovaFolha.toString()));

                if (marCodigo.equals(CodedValues.INCIDE_MARGEM_SIM)) {
                    rseBean.setRseMargem(margemNovaFolha);
                    rseBean.setRseMargemRest(margemRestNova);
                    salvarRSE = true;

                } else if (marCodigo.equals(CodedValues.INCIDE_MARGEM_SIM_2)) {
                    rseBean.setRseMargem2(margemNovaFolha);
                    rseBean.setRseMargemRest2(margemRestNova);
                    salvarRSE = true;

                } else if (marCodigo.equals(CodedValues.INCIDE_MARGEM_SIM_3)) {
                    rseBean.setRseMargem3(margemNovaFolha);
                    rseBean.setRseMargemRest3(margemRestNova);
                    salvarRSE = true;

                } else {
                    mrsBean.setMrsMargem(margemNovaFolha);
                    mrsBean.setMrsMargemRest(margemRestNova);
                    AbstractEntityHome.update(mrsBean);
                }

                liberouMargem |= margemRestNova.compareTo(margemAntigaRestante) > 0;

                // Grava histórico da alteração da margem
                HistoricoMargemRegistroServidorHome.create(rseCodigo, marCodigo, null, OperacaoHistoricoMargemEnum.EDT_REGISTRO_SERVIDOR.getCodigo(), margemAntigaRestante, margemRestNova);
            }

            if (salvarRSE) {
                // Atualiza as margens do servidor
                AbstractEntityHome.update(rseBean);
            }

            if (liberouMargem) {
                // Se é uma operação de liberação de margem, então registra esta operação no controle de segurança
                segurancaController.registrarOperacoesLiberacaoMargem(rseCodigo, null, responsavel);
            }

            if (margemAlterada.length() > 0) {
                // Cria ocorrência de servidor indicando alteração de margem
                criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_RSE_ALTERACAO_MARGEM, ApplicationResourcesHelper.getMessage("mensagem.informacao.margem.servidor.foi.alterada", responsavel, margemAlterada.toString()) + " " + compulsorio + obsMotivoOperacao, tmoCodigo, responsavel);

                logMargem.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.atributo.valor.compulsorio.arg",responsavel, compulsorio));

                // Salva as alterações no log
                logMargem.write();
            }

        } catch (FindException | UpdateException | CreateException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final ZetraException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException(ex);
        }
    }

    @Override
    public List<TransferObject> lstDadosServidor(AcaoTipoDadoAdicionalEnum acao, VisibilidadeTipoDadoAdicionalEnum visibilidade, String serCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaDadosServidorQuery query = new ListaDadosServidorQuery();
            query.responsavel = responsavel;
            query.acao = acao;
            query.visibilidade = visibilidade;
            query.serCodigo = serCodigo;

            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException(ex);
        }
    }

    @Override
    public List<TransferObject> lstTipoDadoAdicionalServidorQuery(AcaoTipoDadoAdicionalEnum acao, VisibilidadeTipoDadoAdicionalEnum visibilidade, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaTipoDadoAdicionalServidorQuery query = new ListaTipoDadoAdicionalServidorQuery();
            query.responsavel = responsavel;
            query.acao = acao;
            query.visibilidade = visibilidade;

            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException(ex);
        }
    }

    @Override
    public String getValorDadoServidor(String serCodigo, String tdaCodigo) throws ServidorControllerException {
        try {
            final DadosServidor das = DadosServidorHome.findByPrimaryKey(new DadosServidorId(serCodigo, tdaCodigo));
            return das.getDasValor();
        } catch (final FindException ex) {
            return null;
        }
    }

    @Override
    public void setValorDadoServidor(String serCodigo, String tdaCodigo, String dasValor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            String operacao;
            DadosServidor das = null;
            String vlrAnterior = null;
            try {
                // Verifica se o dado já existe na tabela
                das = DadosServidorHome.findByPrimaryKey(new DadosServidorId(serCodigo, tdaCodigo));
                vlrAnterior = das.getDasValor();

                // Se existe, verifica se deve ser atualizado ou removido
                if (!TextHelper.isNull(dasValor)) {
                    operacao = Log.UPDATE;
                    das.setDasValor(dasValor);
                    AbstractEntityHome.update(das);
                } else {
                    operacao = Log.DELETE;
                    AbstractEntityHome.remove(das);
                }
            } catch (final FindException ex) {
                if (dasValor != null) {
                    // Senão, cria o novo dado para o servidor
                    operacao = Log.CREATE;
                    DadosServidorHome.create(serCodigo, tdaCodigo, dasValor);
                } else {
                    // Se não existe, mas o valor não foi passado, não realiza operação
                    operacao = null;
                }
            }

            if (operacao != null) {
                // Grava log da operação
                final LogDelegate log = new LogDelegate(responsavel, Log.DADOS_SERVIDOR, operacao, Log.LOG_INFORMACAO);
                log.setServidor(serCodigo);
                log.setTipoDadoAdicional(tdaCodigo);
                log.addChangedField(Columns.DAS_VALOR, dasValor);
                log.write();

                // Grava ocorrencia da operação
                String tocCodigo;
                String obs;
                if (Log.CREATE.equals(operacao)) {
                    tocCodigo = CodedValues.TOC_CRIACAO_DADOS_ADICIONAIS;
                    obs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.criacao.dados.servidor", responsavel, tdaCodigo, dasValor);
                } else if (Log.UPDATE.equals(operacao)) {
                    tocCodigo = CodedValues.TOC_ALTERACAO_DADOS_ADICIONAIS;
                    obs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.alteracao.dados.servidor", responsavel, tdaCodigo, vlrAnterior, dasValor);
                } else {
                    tocCodigo = CodedValues.TOC_EXCLUSAO_DADOS_ADICIONAIS;
                    obs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.exclusao.dados.servidor", responsavel, tdaCodigo, vlrAnterior);
                }
                OcorrenciaDadosServidorHome.create(serCodigo, tocCodigo, responsavel.getUsuCodigo(), tdaCodigo, null, obs, vlrAnterior, dasValor, responsavel.getIpUsuario());
            }
        } catch (UpdateException | RemoveException | CreateException | LogControllerException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstDataOcorrenciaServidorDescontoParcial(String serCodigo, String tocCodigo, boolean ordenar, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ObtemDataOcorrenciaServidorQuery query = new ObtemDataOcorrenciaServidorQuery();
            query.serCodigo = serCodigo;
            query.tocCodigo = tocCodigo;
            query.ordenar = ordenar;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erro.listar.ocorrencias", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstServidoresArquivamento(List<String> orgCodigos, List<String> estCodigos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaSerParaArquivamentoQuery query = new ListaSerParaArquivamentoQuery();
            query.orgCodigos = orgCodigos;
            query.estCodigos = estCodigos;
            query.responsavel = responsavel;

            return query.executarDTO();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void arquivarServidor(String serCodigo, String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            // Remove dependências do registro servidor
            AnaliseRiscoRegistroServidorHome.removeByRse(rseCodigo);
            BaseCalcRegistroServidorHome.removeByRse(rseCodigo);
            BlocoProcessamentoHome.removeByRse(rseCodigo);
            BloqueioRseFunHome.removeByRse(rseCodigo);
            CompMargemHome.removeByRse(rseCodigo);
            ComunicacaoHome.removeBySerRse(serCodigo, rseCodigo);
            ContrachequeRegistroServidorHome.removeByRse(rseCodigo);
            HistoricoConsultaMargemHome.removeByRse(rseCodigo);
            HistoricoMargemFolhaHome.removeByRse(rseCodigo);
            HistoricoMargemPeriodoHome.removeByRse(rseCodigo);
            HistoricoMargemRegistroServidorHome.removeByRse(rseCodigo);
            MargemRegistroServidorHome.removeByRse(rseCodigo);
            OcorrenciaRegistroServidorHome.removeByRse(rseCodigo);
            ParamConvenioRegistroServidorHome.removeByRse(rseCodigo);
            ParamNseRegistroServidorHome.removeByRse(rseCodigo);
            ParamServicoRegistroServidorHome.removeByRse(rseCodigo);
            OcorrenciaPermissionarioHome.removeByRse(rseCodigo);
            PermissionarioHome.removeByRse(rseCodigo);
            ReclamacaoMotivoHome.removeByRse(rseCodigo);
            ReclamacaoRegistroServidorHome.removeByRse(rseCodigo);
            RelacionamentoRegistroServidorHome.removeByRse(rseCodigo);
            VerbaRescisoriaRseHome.removeByRse(rseCodigo);
            ParamConsignatariaRegistroServidorHome.removeByRse(rseCodigo);
            ConsultaMargemSemSenhaHome.removeByRse(rseCodigo);
            RegistroServidorOcultoCsaHome.removeByRse(rseCodigo);
            PontuacaoRseCsaHome.removeByRse(rseCodigo);

            // Remove beneficiário e dependências
            final List<Beneficiario> beneficiarios = BeneficiarioHome.findByServidor(serCodigo);
            if ((beneficiarios != null) && !beneficiarios.isEmpty()) {
                for (final Beneficiario beneficiario : beneficiarios) {
                    AnexoBeneficiarioHome.removeByBeneficiario(beneficiario.getBfcCodigo());
                    ContratoBeneficioHome.removeByBeneficiario(beneficiario.getBfcCodigo());
                    OcorrenciaBeneficiarioHome.removeByBeneficiario(beneficiario.getBfcCodigo());
                    AbstractEntityHome.remove(beneficiario);
                }
            }

            // Remove dependências do servidor
            ArquivoHome.removeBySer(serCodigo);
            BoletoServidorHome.removeBySer(serCodigo);
            DadosServidorHome.removeBySer(serCodigo);
            DirfServidorHome.removeBySer(serCodigo);
            EnderecoServidorHome.removeBySer(serCodigo);
            OcorrenciaDadosServidorHome.removeBySer(serCodigo);
            OcorrenciaServidorHome.removeBySer(serCodigo);

            // Remove dependências do usuario
            final Usuario usuario = UsuarioHome.findByServidor(rseCodigo);

            if (usuario != null) {
                // Remove ligação do usuário com o servidor
                UsuarioSerHome.removeByUsu(usuario.getUsuCodigo());

                // Exclusão lógica do usuário
                // Altera o login do usuário para o seu código de modo que novos usuários possam usar o login deste usuário
                usuario.setUsuTipoBloq(usuario.getUsuLogin());
                usuario.setUsuLogin(usuario.getUsuCodigo());

                // Altera o status do usuário
                usuario.setStatusLogin(StatusLoginHome.findByPrimaryKey(CodedValues.STU_EXCLUIDO));
                AbstractEntityHome.update(usuario);
            }

            // Verifica se existe somente um registro servidor associado
            final ObtemTotalRegistroServidorQuery query = new ObtemTotalRegistroServidorQuery(serCodigo);
            final boolean possuiSomenteUmRse = query.executarContador() == 1;

            final RegistroServidor rse = RegistroServidorHome.findByPrimaryKey(rseCodigo);
            final Servidor ser = ServidorHome.findByPrimaryKey(serCodigo);

            // Verifica se existe o histórico do servidor, se existir altera, se não cria um novo histórico do servidor
            try {
                HtServidorHome.findByPrimaryKey(serCodigo);
                AbstractEntityHome.update(new HtServidor(ser));
            } catch (final FindException e) {
                HtServidorHome.create(ser);
            }

            // Cria histórico do registro servidor
            HtRegistroServidorHome.create(rse);

            // Remove registro servidor
            AbstractEntityHome.remove(rse);

            // Remove o servidor se houver somente um registro servidor associado
            if (possuiSomenteUmRse) {
                UsuarioSerHome.removeBySer(serCodigo);
                AbstractEntityHome.remove(ser);
            }

            // Grava log da operação
            final LogDelegate log = new LogDelegate(responsavel, Log.REGISTRO_SERVIDOR, Log.DELETE, Log.LOG_INFORMACAO);
            log.setServidor(serCodigo);
            log.setRegistroServidor(rseCodigo);
            log.add(ApplicationResourcesHelper.getMessage("mensagem.info.arquivamento.servidor", responsavel));
            log.write();

        } catch (CreateException | FindException | UpdateException | RemoveException | LogControllerException | HQueryException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erro.arquivamento.registro.servidor", responsavel, ex, rseCodigo);
        }
    }

    @Override
    public List<TransferObject> lstHistoricoServidor(String rseMatricula, String serCpf, String orgCodigo, String estCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListarHistoricoServidorQuery query = new ListarHistoricoServidorQuery();
            query.rseMatricula = rseMatricula;
            query.serCpf = serCpf;
            query.orgCodigo = orgCodigo;
            query.estCodigo = estCodigo;

            return query.executarDTO();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void bloquearRegistroServidorPorMotivoSeguranca(String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            // Altera o status para bloqueado automaticamente por segurança (SRS_CODIGO = 7)
            RegistroServidorHome.bloquearRegistroServidorPorSeguranca(rseCodigo);

            // Cria ocorrência de bloqueio automático de segurança (TOC_CODIGO = 191).
            final String tocCodigo = CodedValues.TOC_BLOQUEIO_AUTOMATICO_SEGURANCA;
            final String orsObs = ApplicationResourcesHelper.getMessage("mensagem.registro.servidor.bloqueado.automaticamente.seguranca", responsavel);
            OcorrenciaRegistroServidorHome.create(rseCodigo, tocCodigo, responsavel.getUsuCodigo(), orsObs, responsavel.getIpUsuario(), null);

            // Grava log da operação
            final RegistroServidor rseServidor = RegistroServidorHome.findByPrimaryKey(rseCodigo);
            final LogDelegate log = new LogDelegate(responsavel, Log.REGISTRO_SERVIDOR, Log.UPDATE, Log.LOG_INFORMACAO);
            log.setRegistroServidor(rseServidor.getRseCodigo());
            log.setServidor(rseServidor.getServidor().getSerCodigo());
            log.setOrgao(rseServidor.getOrgao().getOrgCodigo());
            log.setStatusRseCodigo(CodedValues.SRS_BLOQUEADO_AUTOMATICAMENTE_SEGURANCA);
            log.add(ApplicationResourcesHelper.getMessage("mensagem.registro.servidor.bloqueado.automaticamente.seguranca", responsavel));
            log.write();

        } catch (UpdateException | CreateException | FindException | LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstHistoricoVariacaoMargemBruta(String rseCodigo, Short marCodigo, int qtdeMesesPesquisa, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaHistoricoVariacaoMargemBrutaQuery query = new ListaHistoricoVariacaoMargemBrutaQuery(qtdeMesesPesquisa);
            query.rseCodigo = rseCodigo;
            query.marCodigo = marCodigo;

            final LogDelegate log = new LogDelegate(responsavel, Log.HISTORICO_MARGEM, Log.SELECT, Log.LOG_INFORMACAO);
            log.setRegistroServidor(rseCodigo);
            log.setMargem(marCodigo.toString());
            log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.parametro.pesquisa.quantidade.meses", responsavel, String.valueOf(qtdeMesesPesquisa)));
            log.write();

            return query.executarDTO();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void gravarDadoServidor(String serCodigo, String tdaCodigo, String dasValor, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            String operacao;
            DadosServidor das = null;
            String vlrAnterior = null;
            try {
                // Verifica se o dado já existe na tabela
                das = DadosServidorHome.findByPrimaryKey(new DadosServidorId(serCodigo, tdaCodigo));
                vlrAnterior = das.getDasValor();

                // Se existe, verifica se deve ser atualizado ou removido
                if (!TextHelper.isNull(dasValor)) {
                    operacao = Log.UPDATE;
                    das.setDasValor(dasValor);
                    AbstractEntityHome.update(das);
                } else {
                    operacao = Log.DELETE;
                    AbstractEntityHome.remove(das);
                }
            } catch (final FindException ex) {
                if (dasValor != null) {
                    // Se não, cria o novo dado para a autorização de desconto
                    operacao = Log.CREATE;
                    DadosServidorHome.create(serCodigo, tdaCodigo, dasValor);
                } else {
                    // Se não existe, mas o valor não foi passado, não realiza operação
                    operacao = null;
                }
            }

            if (operacao != null) {
                // Grava log da operação
                final LogDelegate log = new LogDelegate(responsavel, Log.DADOS_SERVIDOR, operacao, Log.LOG_INFORMACAO);
                log.setServidor(serCodigo);
                log.setTipoDadoAdicional(tdaCodigo);
                log.addChangedField(Columns.DAS_VALOR, dasValor);
                log.write();

                // Grava ocorrencia da operação
                String tocCodigo;
                String obs;
                if (Log.CREATE.equals(operacao)) {
                    tocCodigo = CodedValues.TOC_CRIACAO_DADOS_ADICIONAIS;
                    obs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.criacao.dados.servidor", responsavel, tdaCodigo, dasValor);
                } else if (Log.UPDATE.equals(operacao)) {
                    tocCodigo = CodedValues.TOC_ALTERACAO_DADOS_ADICIONAIS;
                    obs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.alteracao.dados.servidor", responsavel, tdaCodigo, vlrAnterior, dasValor);
                } else {
                    tocCodigo = CodedValues.TOC_EXCLUSAO_DADOS_ADICIONAIS;
                    obs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.exclusao.dados.servidor", responsavel, tdaCodigo, vlrAnterior);
                }
                OcorrenciaDadosServidorHome.create(serCodigo, tocCodigo, responsavel.getUsuCodigo(), tdaCodigo, null, obs, vlrAnterior, dasValor, responsavel.getIpUsuario());
            }
        } catch (UpdateException | RemoveException | CreateException | LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void notificaServidorContratosPendentesReativacao(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final List<TransferObject> servidoresContratosPendentesReativacao = pesquisarServidorController.listarServidorConsignacaoPendenteReativacao(responsavel);
            String serCodigo = "";
            for (final TransferObject servidor : servidoresContratosPendentesReativacao) {
                final String serCodigoAtual = (String) servidor.getAttribute(Columns.SER_CODIGO);
                final String serEmail = (String) servidor.getAttribute(Columns.SER_EMAIL);
                final String serNome = (String) servidor.getAttribute(Columns.SER_NOME);
                final Short marCodigo = (Short) servidor.getAttribute(Columns.ADE_INC_MARGEM);
                final MargemTO margemTO = MargemHelper.getInstance().getMargem(marCodigo, responsavel);
                if(margemTO.temMargemDisponivel() && !serCodigo.equals(serCodigoAtual) && !TextHelper.isNull(serEmail)) {
                    EnviaEmailHelper.enviarEmailServidorContratosPendentesReativacao(serNome, serEmail, responsavel);
                    serCodigo = serCodigoAtual;
                }
                if(TextHelper.isNull(serEmail)) {
                    LOG.debug(ApplicationResourcesHelper.getMessage("mensagem.erro.email.servidor.sem.email", responsavel, serCodigoAtual));
                }
            }
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> listarComposicaoMargem(TransferObject composicaoMargem, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final String rseCodigo = (String) composicaoMargem.getAttribute(Columns.RSE_CODIGO);
            final ListaComposicaoMargemRseQuery query = new ListaComposicaoMargemRseQuery();
            query.rseCodigo = rseCodigo;

            return query.executarDTO();

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public TransferObject findComposicaoMargem(String cmaCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final CompMargem composicaoMargem = CompMargemHome.findByPrimaryKey(cmaCodigo);

            final TransferObject composicao = new CustomTransferObject();
            composicao.setAttribute(Columns.CMA_CODIGO, composicaoMargem.getCmaCodigo());
            composicao.setAttribute(Columns.CMA_RSE_CODIGO, composicaoMargem.getRseCodigo());
            composicao.setAttribute(Columns.CMA_VCT_CODIGO, composicaoMargem.getVctCodigo());
            composicao.setAttribute(Columns.CMA_VLR, composicaoMargem.getCmaVlr());
            composicao.setAttribute(Columns.CMA_VINCULO, composicaoMargem.getCmaVinculo());
            composicao.setAttribute(Columns.CMA_QUANTIDADE, composicaoMargem.getCmaQuantidade());
            composicao.setAttribute(Columns.CMA_VRS_CODIGO, composicaoMargem.getVrsCodigo());
            composicao.setAttribute(Columns.CMA_CRS_CODIGO, composicaoMargem.getCrsCodigo());

            return composicao;

        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void editarComposicaoMargem(TransferObject composicaoMargem, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final String cmaCodigo = (String) composicaoMargem.getAttribute(Columns.CMA_CODIGO);
            final String rseCodigo = (String) composicaoMargem.getAttribute(Columns.CMA_RSE_CODIGO);
            final String vctCodigo = (String) composicaoMargem.getAttribute(Columns.CMA_VCT_CODIGO);
            final String vrsCodigo = (String) composicaoMargem.getAttribute(Columns.CMA_VRS_CODIGO);
            final String crsCodigo = (String) composicaoMargem.getAttribute(Columns.CMA_CRS_CODIGO);
            final BigDecimal cmaValor = (BigDecimal) composicaoMargem.getAttribute(Columns.CMA_VLR);
            final String cmaVinculo = (String) composicaoMargem.getAttribute(Columns.CMA_VINCULO);
            final Integer cmaQuantidade = (Integer) composicaoMargem.getAttribute(Columns.CMA_QUANTIDADE);

            if (VencimentoEnum.PROVENTO_BASE.getCodigo().equals(vctCodigo) && (cmaValor.compareTo(BigDecimal.ZERO) < 0)) {
                throw new ServidorControllerException("mensagem.erro.editar.composicao.margem.valor.deve.positivo", responsavel);
            }

            // Verifica se já existe uma composição de margem do tipo
            final List<String> vctCodigos = new ArrayList<>();
            vctCodigos.add(VencimentoEnum.PROVENTO_BASE.getCodigo());
            vctCodigos.add(VencimentoEnum.IRPF.getCodigo());
            vctCodigos.add(VencimentoEnum.INSS.getCodigo());
            try {
                if (vctCodigos.contains(vctCodigo)) {
                    final List<CompMargem> composicoes = CompMargemHome.findByRseCodigoAndVctCodigo(rseCodigo, vctCodigo);

                    final CompMargem jaExiste = composicoes.stream().filter(comp -> !comp.getCmaCodigo().equals(cmaCodigo)).findAny().orElse(null);
                    if (jaExiste != null) {
                        throw new ServidorControllerException("mensagem.erro.editar.composicao.margem.vencimento.duplicado", responsavel);
                    }
                }
            } catch (final FindException ex) {
                LOG.info(ApplicationResourcesHelper.getMessage("mensagem.info.editar.composicao.margem.vencimento.nao.cadastrado", responsavel));
            }

            if (!TextHelper.isNull(cmaCodigo)) {
                try {
                    final CompMargem composicao = CompMargemHome.findByPrimaryKey(cmaCodigo);
                    if (!composicao.getVctCodigo().equals(vctCodigo)) {
                        composicao.setVctCodigo(vctCodigo);
                    }

                    composicao.setCmaVlr(cmaValor);
                    composicao.setCmaVinculo(cmaVinculo);
                    composicao.setCmaQuantidade(cmaQuantidade);
                    if (!TextHelper.isNull(vrsCodigo)) {
                        composicao.setVrsCodigo(vrsCodigo);
                    } else {
                        composicao.setVrsCodigo(null);
                    }
                    if (!TextHelper.isNull(crsCodigo)) {
                        composicao.setCrsCodigo(crsCodigo);
                    } else {
                        composicao.setCrsCodigo(null);
                    }

                    AbstractEntityHome.update(composicao);

                    salvaComposicaoMargemIrpfInss(rseCodigo, vctCodigo, cmaValor, responsavel);

                    // Grava log da operação
                    final LogDelegate log = new LogDelegate(responsavel, Log.COMPOSICAO_MARGEM, Log.UPDATE, Log.LOG_INFORMACAO);
                    log.setRegistroServidor(rseCodigo);
                    log.addChangedField(Columns.CMA_CODIGO, composicao.getCmaCodigo());
                    log.addChangedField(Columns.CMA_VLR, cmaValor);
                    log.write();

                } catch (final FindException ex) {
                    LOG.error(ex.getMessage(), ex);
                    throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
                }

            } else {
                final CompMargem composicao = CompMargemHome.create(rseCodigo, vctCodigo, vrsCodigo, crsCodigo, cmaValor, cmaVinculo, cmaQuantidade);

                salvaComposicaoMargemIrpfInss(rseCodigo, vctCodigo, cmaValor, responsavel);

                // Grava log da operação
                final LogDelegate log = new LogDelegate(responsavel, Log.COMPOSICAO_MARGEM, Log.CREATE, Log.LOG_INFORMACAO);
                log.setRegistroServidor(rseCodigo);
                log.addChangedField(Columns.CMA_CODIGO, composicao.getCmaCodigo());
                log.addChangedField(Columns.CMA_VLR, cmaValor);
                log.write();
            }

        } catch (final ServidorControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException(ex);
        } catch (CreateException | UpdateException | LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    private void salvaComposicaoMargemIrpfInss(String rseCodigo, String vctCodigo, BigDecimal cmaValor, AcessoSistema responsavel) throws ServidorControllerException, UpdateException, CreateException {
        if (VencimentoEnum.PROVENTO_BASE.getCodigo().equals(vctCodigo)) {
            // Recalcula IRPF
            try {
                final List<CompMargem> listaIRPF = CompMargemHome.findByRseCodigoAndVctCodigo(rseCodigo, VencimentoEnum.IRPF.getCodigo());

                if ((listaIRPF != null) && (listaIRPF.size() > 1)) {
                    throw new ServidorControllerException("mensagem.erro.editar.composicao.margem.vencimento.irpf.duplicado", responsavel);
                }

                final CompMargem irpf = listaIRPF.get(0);
                irpf.setCmaVlr(VencimentoEnum.IRPF.getValor(cmaValor));
                irpf.setCmaQuantidade(1);
                AbstractEntityHome.update(irpf);

            } catch (final FindException ex) {
                CompMargemHome.create(rseCodigo, VencimentoEnum.IRPF.getCodigo(), null, null, VencimentoEnum.IRPF.getValor(cmaValor), null, 1);
            }

            // Recalcula INSS
            try {
                final List<CompMargem> listaINSS = CompMargemHome.findByRseCodigoAndVctCodigo(rseCodigo, VencimentoEnum.INSS.getCodigo());

                if ((listaINSS != null) && (listaINSS.size() > 1)) {
                    throw new ServidorControllerException("mensagem.erro.editar.composicao.margem.vencimento.inss.duplicado", responsavel);
                }

                final CompMargem inss = listaINSS.get(0);
                inss.setCmaVlr(VencimentoEnum.INSS.getValor(cmaValor));
                inss.setCmaQuantidade(1);
                AbstractEntityHome.update(inss);

            } catch (final FindException ex) {
                CompMargemHome.create(rseCodigo, VencimentoEnum.INSS.getCodigo(), null, null, VencimentoEnum.INSS.getValor(cmaValor), null, 1);
            }
        }
    }

    @Override
    public void excluirComposicaoMargem(String cmaCodigo, AcessoSistema responsavel) throws ServidorControllerException {

        if (TextHelper.isNull(cmaCodigo)) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
        }

        try {
            final CompMargem compMargem = CompMargemHome.findByPrimaryKey(cmaCodigo);
            AbstractEntityHome.remove(compMargem);
        } catch (FindException | RemoveException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> findVencimento(String vctIdentificador, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaVencimentoQuery query = new ListaVencimentoQuery();
            query.vctIdentificador = vctIdentificador;

            return query.executarDTO();

        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void confirmarMargemFolha(List<String> rseCodigos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            if ((rseCodigos == null) || rseCodigos.isEmpty()) {
                throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
            }

            for (final String rseCodigo : rseCodigos) {
                // Na ação de confirmação, o servidor terá seu status alterado para Ativo.
                RegistroServidorHome.alterarStatusRegistroServidor(rseCodigo, CodedValues.SRS_ATIVO);

                criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_CONFIRMACAO_MARGEM_FOLHA_RSE, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.confirmar.margem.folha", responsavel), null, responsavel);
            }

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void rejeitarMargemFolha(List<String> rseCodigos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            if ((rseCodigos == null) || rseCodigos.isEmpty()) {
                throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel);
            }

            for (final String rseCodigo : rseCodigos) {
                // A ação de rejeição deverá zerar as margens folha e recalcular a margem do servidor, além de alterar seu status para ativo.
                RegistroServidorHome.alterarStatusRegistroServidor(rseCodigo, CodedValues.SRS_ATIVO);

                final ListaMargemRegistroServidoresQuery lstMargemSvcAtivo = new ListaMargemRegistroServidoresQuery();
                lstMargemSvcAtivo.rseCodigo = List.of(rseCodigo);
                lstMargemSvcAtivo.margensComSvcAtivo = true;

                final List<TransferObject> margensSvcAtivo = lstMargemSvcAtivo.executarDTO();

                final List<MargemTO> margens = new ArrayList<>();

                final RegistroServidorTO registroServidor = findRegistroServidor(rseCodigo, responsavel);
                for (final TransferObject margem : margensSvcAtivo) {
                	final short marCodigo = (Short) margem.getAttribute(Columns.MAR_CODIGO);
                	switch (marCodigo) {
                	case 1 -> registroServidor.setRseMargem(BigDecimal.ZERO);
                	case 2 -> registroServidor.setRseMargem2(BigDecimal.ZERO);
                	case 3 -> registroServidor.setRseMargem3(BigDecimal.ZERO);
                	default -> {
                		if (!TextHelper.isNull(margem.getAttribute(Columns.MRS_MARGEM))) {
                			final MargemTO marExtra = new MargemTO(marCodigo);
                			marExtra.setMrsMargem(BigDecimal.ZERO);

                			margens.add(marExtra);
                		}
                	}
                	}
                }

                updateRegistroServidor(registroServidor, margens, false, true, false, responsavel);

                criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_REJEICAO_MARGEM_FOLHA_RSE, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.rejeitar.margem.folha", responsavel), null, responsavel);
            }

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public OcorrenciaRegistroSer obtemUltimaOcorrenciaRegistroServidor(String rseCodigo, List<String> tocCodigos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            return OcorrenciaRegistroServidorHome.findLastByRseTocCodigos(rseCodigo, tocCodigos);
        } catch (final FindException ex) {
            throw new ServidorControllerException(ex);
        }
    }

    @Override
    public List<TransferObject> lstUnidadeSubOrgao(AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaUnidadeSubOrgaoQuery query = new ListaUnidadeSubOrgaoQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public TransferObject findRegistroServidoresByLikeMatricula(String rseMatricula, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistrosServidoresLikeMatriculaQuery rseQuery = new ListaRegistrosServidoresLikeMatriculaQuery();
            rseQuery.rseMatricula = rseMatricula;
            final List<TransferObject> lstRseLikeMatricula = rseQuery.executarDTO();
            if((lstRseLikeMatricula != null) && !lstRseLikeMatricula.isEmpty()) {
                return lstRseLikeMatricula.get(0);
            }
            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> listaServidorPorCsaVerba(String csaCodigo, String cnvCodVerba, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            final ListaRegistrosServidoresByCsaConvenioQuery rseSerQuery = new ListaRegistrosServidoresByCsaConvenioQuery();
            rseSerQuery.csaCodigo = csaCodigo;
            rseSerQuery.cnvCodVerba = cnvCodVerba;

            return rseSerQuery.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
	public Servidor findByCpfMatricula(String matricula, String cpf, AcessoSistema responsavel)
			throws ServidorControllerException {
		Servidor servidor = null;
		try {
			if (matricula != null) {
				servidor = ServidorHome.findByRseMatricula(matricula);
				if ((cpf != null) && !servidor.getSerCpf().equals(cpf)) {
                	return null;
                } else {
                	return servidor;
                }
			} else {
				final List<Servidor> result = findByCpf(cpf, responsavel);
				if (!result.isEmpty()) {
					return result.get(0);
				} else {
                    return null;
				}
			}
		} catch (final FindException ex) {
			LOG.error(ex.getMessage(), ex);
			throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
		}
	}

    @Override
    public RegistroServidor findRseTipo(String matricula, String serCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        RegistroServidor rgSer = null;
        try {
            List<RegistroServidor> result = null;
            if (matricula != null) {
                result = RegistroServidorHome.findByMatricula(matricula);
            } else {
                result = RegistroServidorHome.findBySerCodigo(serCodigo);
            }

            if (!result.isEmpty()) {
                rgSer = result.get(0);
            }

            return rgSer;
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void updateCnvVincCsaSvc(String csaCodigo, String svcCodigo, List<String> vrsCodigos, AcessoSistema responsavel) throws ServidorControllerException {
       try {
           final ParamConvenioRegistroServidorDAO dao = DAOFactory.getDAOFactory().getParamConvenioRegistroServidorDAO();
           dao.updateCnvVincCsaSvc(csaCodigo, svcCodigo, vrsCodigos, responsavel);
       } catch (ServidorControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstFuncoesEnvioEmailSer(String serCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            return new FuncoesEnvioEmailSerQuery(serCodigo).executarDTO();
        } catch (final HQueryException  ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void salvarFuncoesEnvioEmailSer(List<DestinatarioEmailSer> listaInc, List<DestinatarioEmailSer> listaExc, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            if ((listaInc != null) && !listaInc.isEmpty()) {
                for (final DestinatarioEmailSer destinatario : listaInc) {
                	DestinatarioEmailSerHome.create(destinatario.getFunCodigo(), destinatario.getPapCodigo(), destinatario.getSerCodigo(), destinatario.getDesReceber());

                    final LogDelegate log = new LogDelegate(responsavel, Log.CONFIGURACAO_ENVIO_EMAIL_SER, Log.CREATE, Log.LOG_INFORMACAO);
                    log.setFuncao(destinatario.getFunCodigo());
                    log.setPapel(destinatario.getPapCodigo());
                    log.setServidor(destinatario.getSerCodigo());
                    log.addChangedField(Columns.DES_RECEBER, destinatario.getDesReceber());
                    log.write();
                }
            }
            if ((listaExc != null) && !listaExc.isEmpty()) {
                for (final DestinatarioEmailSer destinatario : listaExc) {
                	final DestinatarioEmailSer dem = DestinatarioEmailSerHome.findByPrimaryKey(destinatario.getFunCodigo(), destinatario.getPapCodigo(), destinatario.getSerCodigo());
                	AbstractEntityHome.remove(dem);

                    final LogDelegate log = new LogDelegate(responsavel, Log.CONFIGURACAO_ENVIO_EMAIL_SER, Log.DELETE, Log.LOG_INFORMACAO);
                    log.setFuncao(destinatario.getFunCodigo());
                    log.setPapel(destinatario.getPapCodigo());
                    log.setServidor(destinatario.getSerCodigo());
                    log.write();
                }
            }
        } catch (CreateException | RemoveException | FindException | LogControllerException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public String getEmailSerNotificacaoOperacao(String funCodigo, String papCodigoOperador, String serCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        final ServidorTransferObject servidor = findServidor(serCodigo, responsavel);
        try {
            final DestinatarioEmailSer bean = DestinatarioEmailSerHome.findByPrimaryKey(new DestinatarioEmailSerId(funCodigo, papCodigoOperador, serCodigo));
            if ("N".equalsIgnoreCase(bean.getDesReceber())) {
                // Se existe o registro e o servidor optou por não receber, então retorna nulo
                return null;
            } else {
                // Se existe o registro e o servidor optou por receber
                return servidor.getSerEmail();
            }
        } catch (final FindException ex) {
            // Se o servidor não tem configuração específica sobre a função, então deve retornar o e-mail do servidor
            return servidor.getSerEmail();
        }
    }

    @Override
    public List<TransferObject> findByRseTocCodigos(String rseCodigo, List<String> tocCodigos, AcessoSistema responsavel) throws ServidorControllerException {
    	try {
            final ListaOcorrenciaRegistroServidorQuery query = new ListaOcorrenciaRegistroServidorQuery();
            query.rseCodigo  = rseCodigo;
            query.tocCodigos = tocCodigos;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erro.listar.ocorrencias", responsavel, ex);
        }
    }

    @Override
    public void enviarNotificacaoVencimentoAutorizacao(Integer qtdeDiasVencimentoAutorizacao, AcessoSistema responsavel) {
        try {
            final List<ConsultaMargemSemSenha> consultas = ConsultaMargemSemSenhaHome.findAutorizacaoPrestesVencer(qtdeDiasVencimentoAutorizacao);
            if((consultas != null) && (!consultas.isEmpty())) {
                String csaNome = "";
                for(final ConsultaMargemSemSenha consulta : consultas) {
                    csaNome = consulta.getConsignataria().getCsaNome();
                    final String dataVencimento = DateHelper.toDateString(consultas.get(0).getCssDataFim());
                    final String corpoSms = ApplicationResourcesHelper.getMessage("mensagem.sms.vencimento.autorizacao", responsavel, csaNome, dataVencimento);
                    final String tituloPush = ApplicationResourcesHelper.getMessage("mensagem.notificacao.push.vencimento.autorizacao.titulo", responsavel);
                    final String textoPush = ApplicationResourcesHelper.getMessage("mensagem.notificacao.push.vencimento.autorizacao.texto", responsavel, csaNome, dataVencimento);
                    // Enviará a notificação de vencimento apenas uma vez
                    enviarNotificacaoSer(consulta.getRegistroServidor().getSerCodigo(), consulta.getCsaCodigo(), corpoSms, tituloPush, textoPush, TipoNotificacaoEnum.EMAIL_NOTIFICACAO_AUTORIZACAO_IRA_VENCER, dataVencimento, responsavel);
                }
            }
        } catch (final FindException ex) {
            LOG.error(ex.getMessage());
        }
    }

    @Override
    public void enviarNotificacaoSer(String serCodigo, String csaCodigo, String corpoSms, String tituloPush, String textoPush, TipoNotificacaoEnum tipoNotificacao, String dataVencimento, AcessoSistema responsavel) {

        String csaNome = "";
        Servidor servidor = null;
        try {
            csaNome = consignatariaController.findConsignataria(csaCodigo, responsavel).getCsaNome();
            servidor = ServidorHome.findByPrimaryKey(serCodigo);
        } catch (ConsignatariaControllerException | FindException ex) {
            LOG.error(ex.getMessage(), ex);
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.enviar.notificacao.ser", responsavel, serCodigo));
            return;
        }

        final String serEmail = servidor.getSerEmail();
        final String serNome = servidor.getSerNome();

        // Verifica se o sistem permite enviar notificação
        final Object paramEnviarNotificacaoSerReservaMargem = ParamSist.getInstance().getParam(CodedValues.TPC_ENVIAR_EMAIL_SER_RESERVA_MARGEM_APOS_OCORRER_SEM_SENHA, responsavel);

        final String strParamEnviarNotificacaoSerReservaMargem = paramEnviarNotificacaoSerReservaMargem != null ? paramEnviarNotificacaoSerReservaMargem.toString() : CodedValues.EMAIL_NOTIFICACAOO_RESERVA_MARGEM_DESABILITADO;

        if (CodedValues.EMAIL_NOTIFICACAOO_RESERVA_MARGEM_SMS.equals(strParamEnviarNotificacaoSerReservaMargem) || CodedValues.EMAIL_NOTIFICACAOO_RESERVA_MARGEM_SMS_EMAIL.equals(strParamEnviarNotificacaoSerReservaMargem)
                || CodedValues.EMAIL_NOTIFICACAOO_RESERVA_MARGEM_SMS_EMAIL_PUSH_NOTIFICATION.equals(strParamEnviarNotificacaoSerReservaMargem)) {
            try {
                final String accountSid = ParamSist.getInstance().getParam(CodedValues.TPC_SID_CONTA_SMS, responsavel).toString();
                final String authToken = ParamSist.getInstance().getParam(CodedValues.TPC_TOKEN_AUTENTICACAO_SMS, responsavel).toString();
                final String fromNumber = ParamSist.getInstance().getParam(CodedValues.TPC_NUMERO_REMETENTE_SMS, responsavel).toString();

                // Formata o telefone para o padrão do país
                final String serCelular = !TextHelper.isNull(servidor.getSerCelular()) ? LocaleHelper.formataCelular(servidor.getSerCelular()) : null;

                new SMSHelper(accountSid, authToken, fromNumber).send(serCelular, corpoSms);
            } catch (final ZetraException e) {
                try {
                    // Envia o e-mail caso o celular não tenha sido informado
                    if(dataVencimento == null) {
                        EnviaEmailHelper.notificarSerReservaMargem(serEmail, serNome, csaNome);
                    } else {
                        EnviaEmailHelper.notificarSerAutorizacaoIraVencer(serEmail, serNome, csaNome, dataVencimento);
                    }
                } catch (final ViewHelperException ex) {
                    try {
                        // Fazer push notification caso o celular e e-mail não tenha sido informado
                        notificacaoDispositivoController.enviarNotificacao(serCodigo, tituloPush, textoPush, tipoNotificacao, CodedValues.FUN_RES_MARGEM, responsavel);
                    } catch(final NotificacaoDispositivoControllerException exc) {
                        // Não dá rollback em caso de erro de notificação ao dispositivo
                        LOG.error(exc.getMessage(), exc);
                        LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.sms.ou.email.ou.push.notification.enviar", responsavel));
                    }
                }
            }
        } else if (CodedValues.EMAIL_NOTIFICACAOO_RESERVA_MARGEM_EMAIL.equals(strParamEnviarNotificacaoSerReservaMargem) || CodedValues.EMAIL_NOTIFICACAOO_RESERVA_MARGEM_EMAIL_PUSH_NOTIFICATION.equals(strParamEnviarNotificacaoSerReservaMargem)) {
            // Envia o e-mail
            try {
                if(dataVencimento == null) {
                    EnviaEmailHelper.notificarSerReservaMargem(serEmail, serNome, csaNome);
                } else {
                    EnviaEmailHelper.notificarSerAutorizacaoIraVencer(serEmail, serNome, csaNome, dataVencimento);
                }
            } catch (final ViewHelperException ex) {
                try {
                    // Fazer push notification caso o e-mail não tenha sido informado
                    notificacaoDispositivoController.enviarNotificacao(serCodigo, tituloPush, textoPush, tipoNotificacao, CodedValues.FUN_RES_MARGEM, responsavel);
                } catch(final NotificacaoDispositivoControllerException exc) {
                    // Não dá rollback em caso de erro de notificação ao dispositivo
                    LOG.error(exc.getMessage(), exc);
                    LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.ou.push.notification.enviar", responsavel));
                }
            }
        } else if (CodedValues.EMAIL_NOTIFICACAOO_RESERVA_MARGEM_PUSH_NOTIFICATION.equals(strParamEnviarNotificacaoSerReservaMargem)) {
            // Envia o push notification
            try {
                notificacaoDispositivoController.enviarNotificacao(serCodigo, tituloPush, textoPush, tipoNotificacao, CodedValues.FUN_RES_MARGEM, responsavel);
            } catch (final NotificacaoDispositivoControllerException ex) {
                // Não dá rollback em caso de erro de notificação ao dispositivo
                LOG.error(ex.getMessage(), ex);
                LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.push.notification.enviar", responsavel));
            }
        }
    }

    @Override
    public List<HistoricoMargemFolha> lstHistoricoMargemFolhaRseFiltro(String rseCodigo, java.util.Date periodoIni, java.util.Date periodoFim, Short marCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            return HistoricoMargemFolhaHome.findByRseFilters(rseCodigo, periodoIni, periodoFim, marCodigo);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> consultaSalarioServidor(String cpf, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            ListaConsultaSalarioServidorQuery query = new ListaConsultaSalarioServidorQuery();
            query.serCpf = cpf;


            return query.executarDTO();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public void createRegistroServidorOcultoCsa(String rseCodigo, List<String> csaCodigos, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            List<String> csaOcultas = listCsaOcultasRse(rseCodigo, responsavel);

            List<String> removerOcultos = csaOcultas.stream().filter(e -> !csaCodigos.contains(e)).collect(Collectors.toList());
            List<String> incluirOcultos = csaCodigos.stream().filter(e -> !csaOcultas.contains(e)).collect(Collectors.toList());

            // Remove consignatária que não devem estar ocultas
            if (removerOcultos != null && !removerOcultos.isEmpty()) {
                for (String csaCodigo : removerOcultos) {
                    RegistroServidorOcultoCsaHome.remove(new RegistroServidorOcultoCsa(rseCodigo, csaCodigo));
                    String csaNome = consignatariaController.findConsignataria(csaCodigo, responsavel).getCsaNome();
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_EXIBIR_REGISTRO_SER_OCULTO_CSA, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.rse.exibido.consignataria", responsavel, csaNome), null, responsavel);
                }

            }

            // Oculta novas consignatárias
            if (incluirOcultos != null && !incluirOcultos.isEmpty()) {
                for (String csaCodigo : incluirOcultos) {
                    RegistroServidorOcultoCsaHome.create(rseCodigo, csaCodigo, responsavel);
                    String csaNome = consignatariaController.findConsignataria(csaCodigo, responsavel).getCsaNome();
                    criaOcorrenciaRSE(rseCodigo, CodedValues.TOC_OCULTAR_REGISTRO_SER_OCULTO_CSA, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ors.obs.rse.oculto.consignataria", responsavel, csaNome), null, responsavel);
                }
            }

        } catch (CreateException | RemoveException | ConsignatariaControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    public List<String> listCsaOcultasRse(String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException {
        try {
            ObtemRegistroServidorOcultoCsaQuery query = new ObtemRegistroServidorOcultoCsaQuery(rseCodigo);
            return query.executarLista();
        } catch (HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ServidorControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }
}
cannot find symbol
//////////////////////////
package com.zetra.econsig.helper.email;

import java.io.File;
import java.io.IOException;
import java.math.BigDecimal;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;

import org.apache.commons.lang3.StringEscapeUtils;

import com.zetra.econsig.delegate.AutorizacaoDelegate;
import com.zetra.econsig.delegate.ConsignanteDelegate;
import com.zetra.econsig.delegate.ConsignatariaDelegate;
import com.zetra.econsig.delegate.ParametroDelegate;
import com.zetra.econsig.delegate.SaldoDevedorDelegate;
import com.zetra.econsig.delegate.ServicoDelegate;
import com.zetra.econsig.delegate.ServidorDelegate;
import com.zetra.econsig.delegate.TipoMotivoOperacaoDelegate;
import com.zetra.econsig.delegate.UsuarioDelegate;
import com.zetra.econsig.dto.CustomTransferObject;
import com.zetra.econsig.dto.TransferObject;
import com.zetra.econsig.dto.entidade.ConsignanteTransferObject;
import com.zetra.econsig.dto.entidade.ConsignatariaTransferObject;
import com.zetra.econsig.dto.entidade.ConvenioTransferObject;
import com.zetra.econsig.dto.entidade.CorrespondenteTransferObject;
import com.zetra.econsig.dto.entidade.EstabelecimentoTransferObject;
import com.zetra.econsig.dto.entidade.MensagemTO;
import com.zetra.econsig.dto.entidade.OrgaoTransferObject;
import com.zetra.econsig.dto.entidade.ParamSvcTO;
import com.zetra.econsig.dto.entidade.SaldoDevedorTransferObject;
import com.zetra.econsig.dto.entidade.ServidorTransferObject;
import com.zetra.econsig.dto.entidade.TipoMotivoOperacaoTransferObject;
import com.zetra.econsig.dto.entidade.UsuarioTransferObject;
import com.zetra.econsig.exception.AutorizacaoControllerException;
import com.zetra.econsig.exception.ConsignanteControllerException;
import com.zetra.econsig.exception.ConsignatariaControllerException;
import com.zetra.econsig.exception.LeilaoSolicitacaoControllerException;
import com.zetra.econsig.exception.MensagemControllerException;
import com.zetra.econsig.exception.ParametroControllerException;
import com.zetra.econsig.exception.ServidorControllerException;
import com.zetra.econsig.exception.UsuarioControllerException;
import com.zetra.econsig.exception.ViewHelperException;
import com.zetra.econsig.exception.ZetraException;
import com.zetra.econsig.helper.arquivo.FileHelper;
import com.zetra.econsig.helper.consignacao.BoletoHelper;
import com.zetra.econsig.helper.email.command.EnviaEmailCsaDesbloqueioVerbaRseCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailAlertaCriacaoNovoUsuCseCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailAlertaEnvioArquivosFolhaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailAlertaRetornoServidorCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailAlteracaoOperacaoSensivelCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailAlteracaoPerfilUsuarioCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailBloqDesbloqServidorCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailConfirmacaoDesbloqueioCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailCsaContratosColocadosEmEstoqueCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailCsaNotificacaoRegraCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailCsaNovaSolicitacaoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailCsaPortabilidadeCartaoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailCsaSerCancelaSolicitacaoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailCsasAlteracaoSerCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailCseBloqueioUsuarioCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailDownloadNaoRealizadoMovFinCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailExpiracaoConsignatariaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailExpiracaoParaConsignatariaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailLimiteAtigindoInclusaoCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotifAlterCodVerbaConvCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoAutorizacaoIraVencerCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCadastroSenhaServidorCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCadastroServidorCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoConsignacaoDeferidaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCsaCancelamentoCadastroServidorCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCsaCredenciamentoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCsaCredenciamentoConcluidoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCsaErroKYCCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCsaNovoVinculoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCsaVinculosBloqDesbloqCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCseAssTermoCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCseBloqueioCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCseCredenciamentoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCseCredenciamentoConcluidoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoCseReativacaoPrdRejeitadaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoDesbloqueioCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoDocCsaCredenciamentoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoPrazoExpiracaoSenhaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoPreenchimentoTermoCredenciamentoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoReservaMargemCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoSituacaoCsaCredenciamentoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificacaoUsuPermissaoAprovacaoAssTermoCseCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificaoCsaBloqSerCnvVariacaoMargemCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificaoCseBloqSerCnvVariacaoMargemCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNotificaoErroCriarArquivoMargemCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNovoBoletoServidorCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailNovoContratoVerbaRescisoriaSerCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailOTPServidorCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailOTPUsuarioCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailRefinanciamentoCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailSenhaNovoUsuarioCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailServidorContratosPendentesReativacaoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailServidorContratosRejeitadosCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailServidorVerbaRescisoriaSaldoInsuficienteCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailSimulacaoCommand;
import com.zetra.econsig.helper.email.command.EnviarEmailUploadArquivoCsaCommand;
import com.zetra.econsig.helper.email.command.EnviarLinkCriarSenhaUsuarioCommand;
import com.zetra.econsig.helper.email.command.EnviarLinkRecurepacaoSenhaServidorCommand;
import com.zetra.econsig.helper.email.command.EnviarNotificacaoBloqueioUsuarioInatividadeCommand;
import com.zetra.econsig.helper.markdown.Markdown4jProcessorExtended;
import com.zetra.econsig.helper.parametro.ParamSist;
import com.zetra.econsig.helper.seguranca.AcessoSistema;
import com.zetra.econsig.helper.sistema.ShowFieldHelper;
import com.zetra.econsig.helper.sms.SMSHelper;
import com.zetra.econsig.helper.texto.ApplicationResourcesHelper;
import com.zetra.econsig.helper.texto.DateHelper;
import com.zetra.econsig.helper.texto.LocaleHelper;
import com.zetra.econsig.helper.texto.NumberHelper;
import com.zetra.econsig.helper.texto.TextHelper;
import com.zetra.econsig.helper.upload.UploadHelper;
import com.zetra.econsig.helper.usuario.UsuarioHelper;
import com.zetra.econsig.helper.web.JspHelper;
import com.zetra.econsig.persistence.entity.AutDesconto;
import com.zetra.econsig.persistence.entity.Comunicacao;
import com.zetra.econsig.persistence.entity.Consignataria;
import com.zetra.econsig.persistence.entity.CredenciamentoCsa;
import com.zetra.econsig.persistence.entity.LeituraMensagemUsuario;
import com.zetra.econsig.persistence.entity.Mensagem;
import com.zetra.econsig.persistence.entity.PropostaLeilaoSolicitacao;
import com.zetra.econsig.persistence.entity.SolicitacaoAutorizacao;
import com.zetra.econsig.persistence.entity.VinculoRegistroServidor;
import com.zetra.econsig.report.jasper.dto.RegrasConvenioParametrosBean;
import com.zetra.econsig.service.comunicacao.ComunicacaoController;
import com.zetra.econsig.service.consignacao.EditarAnexoConsignacaoController;
import com.zetra.econsig.service.consignacao.PesquisarConsignacaoController;
import com.zetra.econsig.service.consignante.ConsignanteController;
import com.zetra.econsig.service.consignataria.ConsignatariaController;
import com.zetra.econsig.service.leilao.LeilaoSolicitacaoController;
import com.zetra.econsig.service.mensagem.MensagemController;
import com.zetra.econsig.service.rescisao.VerbaRescisoriaController;
import com.zetra.econsig.service.servidor.ServidorController;
import com.zetra.econsig.service.sistema.SistemaController;
import com.zetra.econsig.service.usuario.UsuarioController;
import com.zetra.econsig.values.CodedNames;
import com.zetra.econsig.values.CodedValues;
import com.zetra.econsig.values.Columns;
import com.zetra.econsig.values.FieldKeysConstants;
import com.zetra.econsig.values.OperacaoEConsigEnum;
import com.zetra.econsig.values.StatusConsignatariaEnum;
import com.zetra.econsig.values.StatusPropostaEnum;
import com.zetra.econsig.values.TipoArquivoEnum;
import com.zetra.econsig.values.TipoNotificacaoEnum;
import com.zetra.econsig.web.ApplicationContextProvider;
import com.zetra.econsig.webservice.rest.request.CsaListInfoRequest;

import jakarta.mail.MessagingException;

/**
 * <p>Title: EnviaEmailHelper</p>
 * <p>Description: Helper Class para Operação de Envio de Email Com os dados de Uma Consignação</p>
 * <p>Copyright: Copyright (c) 2004</p>
 * <p>Company: ZetraSoft</p>
 * $Author$
 * $Revision$
 * $Date$
 */
public class EnviaEmailHelper {
    private static final org.apache.commons.logging.Log LOG = org.apache.commons.logging.LogFactory.getLog(EnviaEmailHelper.class);

    // Tipos de Envio de Email para Acompanhamento de Compra de Contrato (Renegociação)
    public static final int TIPO_COMPRA_CONTRATO             = 1;
    public static final int TIPO_CADASTRO_SALDO_DEVEDOR      = 2;
    public static final int TIPO_INF_PGT_SALDO_DEVEDOR       = 3;
    public static final int TIPO_LIQUIDACAO_COMPRA_CONTRATO  = 4;
    public static final int TIPO_SOL_RECALCULO_SALDO_DEVEDOR = 5;
    public static final int TIPO_REJ_PGT_SALDO_DEVEDOR       = 6;
    public static final int TIPO_APROVACAO_SALDO_DEVEDOR     = 7;
    public static final int TIPO_REJEICAO_SALDO_DEVEDOR      = 8;

    private static String DESTINATARIO_BLOQ_SISTEMA;
    private static String EMAIL_VALIDACAO_INTEGRACAO_CSA;
    private static String EMAIL_OPERACAO_BENEFICIO;

    private static Properties env = new Properties();

    static {
        try {
            env.load(EnviaEmailHelper.class.getClassLoader().getResourceAsStream("mail.properties"));
            EMAIL_VALIDACAO_INTEGRACAO_CSA = env.getProperty("email.validacao.integracao.csa");
            DESTINATARIO_BLOQ_SISTEMA = env.getProperty("email.dest.bloqueio.sistema");
            EMAIL_OPERACAO_BENEFICIO = env.getProperty("email.dest.operacao.beneficio");
        } catch (final IOException ex) {
            LOG.error("Erro ao carregar arquivo mail.properties: " + ex.getMessage(), ex);
        }
    }

    /**
     * Envia email de acompanhamento de compra de contratos (Renegociação). O parâmetro
     * adeCodigo deve conter o código do contrato comprado, aquele que está no estado
     * de Aguard. Liq. de Compra. O tipo de email pode ser TIPO_COMPRA_CONTRATO,
     * TIPO_CADASTRO_SALDO_DEVEDOR, TIPO_INF_PGT_SALDO_DEVEDOR, TIPO_RESOL_SALDO_DEVEDOR ou
     * TIPO_LIQUIDACAO_COMPRA_CONTRATO.
     *
     * @param tipo int
     * @param adeCodigo String
     * @param observacao String
     * @param responsavel AcessoSistema
     * @return String com mensagem de erro
     */
    public static final String enviarEmailCompraContrato(int tipo, String adeCodigo, String observacao, AcessoSistema responsavel) {
        try {
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final SaldoDevedorDelegate sdvDelegate = new SaldoDevedorDelegate();

            // Busca o adeCodigo do contrato novo, que substitui o contrato comprado
            final String adeCodigoNovo = adeDelegate.getAdeRelacionamentoCompra(adeCodigo, responsavel);
            if (adeCodigoNovo == null) {
                return "";
            }

            // Busca as informações do contrato comprado e do contrato novo
            final TransferObject adeComprada = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            final TransferObject adeNova = adeDelegate.buscaAutorizacao(adeCodigoNovo, responsavel);
            if ((adeComprada == null) || (adeNova == null)) {
                return "";
            }

            // Recupera os e-mails das consignatárias.
            final ConfirguracoesEmailCsaCompraContrato enderecosCsaOrigem = recuperarEnderecosEmailCompraContrato(tipo, (String) adeComprada.getAttribute(Columns.CSA_CODIGO), (String) adeComprada.getAttribute(Columns.SVC_CODIGO), responsavel);
            final ConfirguracoesEmailCsaCompraContrato enderecosCsaDestino = recuperarEnderecosEmailCompraContrato(tipo, (String) adeNova.getAttribute(Columns.CSA_CODIGO), (String) adeNova.getAttribute(Columns.SVC_CODIGO), responsavel);

            // Recupera os e-mails dos correspondentes.
            final String emailCorOrigem  = (String) adeComprada.getAttribute(Columns.COR_EMAIL);
            final String emailCorDestino = (String) adeNova.getAttribute(Columns.COR_EMAIL);

            // Monta a lista dos destinatários da mensagem.
            List<String> emailDestinatarios;
            switch (tipo) {
                case TIPO_CADASTRO_SALDO_DEVEDOR:
                case TIPO_LIQUIDACAO_COMPRA_CONTRATO:
                case TIPO_REJ_PGT_SALDO_DEVEDOR:
                    // E-mail deve ser enviado para o responsável pelo novo contrato
                    emailDestinatarios = EnviaEmailHelper.montarListaEnderecosDestinatarios(enderecosCsaDestino.destinatariosEmail, enderecosCsaDestino.emailCsaEvento, emailCorDestino);
                    break;
                case TIPO_COMPRA_CONTRATO:
                case TIPO_INF_PGT_SALDO_DEVEDOR:
                case TIPO_SOL_RECALCULO_SALDO_DEVEDOR:
                    // E-mail deve ser enviado para o proprietário do contrato original
                    emailDestinatarios = EnviaEmailHelper.montarListaEnderecosDestinatarios(enderecosCsaOrigem.destinatariosEmail, enderecosCsaOrigem.emailCsaEvento, emailCorOrigem);
                    break;
                case TIPO_APROVACAO_SALDO_DEVEDOR:
                case TIPO_REJEICAO_SALDO_DEVEDOR:
                    // E-mail deve ser enviado para ambas as consignatárias
                    emailDestinatarios = new ArrayList<>(EnviaEmailHelper.montarListaEnderecosDestinatarios(enderecosCsaDestino.destinatariosEmail, enderecosCsaDestino.emailCsaEvento, emailCorDestino));
                    emailDestinatarios.addAll(EnviaEmailHelper.montarListaEnderecosDestinatarios(enderecosCsaOrigem.destinatariosEmail, enderecosCsaOrigem.emailCsaEvento, emailCorOrigem));
                    break;
                default:
                    LOG.error("Operação não identificada em EnviaEmailHelper.enviarEmailCompraContrato");
                    return "";
            }

            // Dados da consignação comprada
            final String adeNumero = adeComprada.getAttribute(Columns.ADE_NUMERO).toString();

            // Descrição das consignatárias envolvidas
            final String csaVendedora = !TextHelper.isNull(adeComprada.getAttribute(Columns.CSA_NOME_ABREV)) ? adeComprada.getAttribute(Columns.CSA_NOME_ABREV).toString() : adeComprada.getAttribute(Columns.CSA_NOME).toString();
            final String csaCompradora = !TextHelper.isNull(adeNova.getAttribute(Columns.CSA_NOME_ABREV)) ? adeNova.getAttribute(Columns.CSA_NOME_ABREV).toString() : adeNova.getAttribute(Columns.CSA_NOME).toString();

            // Obtém o nome do consignante
            final String cseNome = getCseNome(responsavel);

            // Dados do saldo devedor
            String textoSaldoDevedor = "";
            String textoInfDepositoSdv = "";

            // Busca os valores do saldo devedor cadastrados
            final SaldoDevedorTransferObject saldoDevedorTO = sdvDelegate.getSaldoDevedor(adeCodigo, responsavel);
            if (saldoDevedorTO != null) {
                textoSaldoDevedor = gerarTextoDetalheSaldoDevedor(saldoDevedorTO, responsavel);
                textoInfDepositoSdv = gerarTextoInfDepositoSaldoDevedor(saldoDevedorTO);
            }

            // Texto Comum para todas as mensagems
            final StringBuilder textoGeral = new StringBuilder();
            textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel));
            textoGeral.append(gerarTextoDetalheContratoParaEmail(adeComprada, cseNome, responsavel));
            textoGeral.append("<br/>\n<br/>\n");

            // Define o titulo do E-mail a partir da operação realizada
            final StringBuilder tituloOperacao = new StringBuilder();
            switch (tipo) {
                case TIPO_COMPRA_CONTRATO:
                    tituloOperacao.append(ApplicationResourcesHelper.getMessage("mensagem.email.compra.consignacao.renegociada.consignataria", responsavel, adeNumero, csaCompradora));
                    break;
                case TIPO_CADASTRO_SALDO_DEVEDOR:
                    tituloOperacao.append(ApplicationResourcesHelper.getMessage("mensagem.email.compra.consignataria.informou.saldo.devedor", responsavel, csaVendedora, adeNumero));
                    break;
                case TIPO_APROVACAO_SALDO_DEVEDOR:
                    tituloOperacao.append(ApplicationResourcesHelper.getMessage("mensagem.email.compra.servidor.aprovou.saldo.devedor", responsavel, adeNumero));
                    break;
                case TIPO_REJEICAO_SALDO_DEVEDOR:
                    tituloOperacao.append(ApplicationResourcesHelper.getMessage("mensagem.email.compra.servidor.rejeitou.saldo.devedor", responsavel, adeNumero));
                    break;
                case TIPO_INF_PGT_SALDO_DEVEDOR:
                    tituloOperacao.append(ApplicationResourcesHelper.getMessage("mensagem.email.compra.consignataria.informou.pagamento", responsavel, csaCompradora, adeNumero));
                    break;
                case TIPO_SOL_RECALCULO_SALDO_DEVEDOR:
                    tituloOperacao.append(ApplicationResourcesHelper.getMessage("mensagem.email.compra.consignataria.solicitou.novo.calculo", responsavel, csaCompradora, adeNumero));
                    break;
                case TIPO_REJ_PGT_SALDO_DEVEDOR:
                    tituloOperacao.append(ApplicationResourcesHelper.getMessage("mensagem.email.compra.consignataria.rejeitou.pagamento.saldo.devedor", responsavel, csaVendedora, adeNumero));
                    break;
                case TIPO_LIQUIDACAO_COMPRA_CONTRATO:
                    tituloOperacao.append(ApplicationResourcesHelper.getMessage("mensagem.email.compra.consignataria.liquidou.consignacao", responsavel, csaVendedora, adeNumero));
                    break;
                default:
                    break;
            }

            final String titulo = gerarTituloEmail(null, StringEscapeUtils.unescapeHtml4(tituloOperacao.toString()), responsavel);

            // Define o texto do E-mail
            String texto = titulo + "<br/>\n<br/>\n" + textoGeral.toString() + textoSaldoDevedor + textoInfDepositoSdv;

            if (!TextHelper.isNull(observacao)) {
                texto += "<br/>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.compra.observacao", responsavel, observacao);
            }

            // Inclui informações sobre a compra no cabeçalho do e-mail
            final Map<String, String> mailHeaders = new HashMap<>();
            mailHeaders.put("eConsig.nomeConsignante", cseNome);
            mailHeaders.put("eConsig.numeroADECompra", adeNova.getAttribute(Columns.ADE_NUMERO) != null ? adeNova.getAttribute(Columns.ADE_NUMERO).toString() : "");
            mailHeaders.put("eConsig.nomeCSAOrigem", csaVendedora);
            mailHeaders.put("eConsig.nomeCSADestino", csaCompradora);
            mailHeaders.put("eConsig.emailPrincipalCSAOrigem", enderecosCsaOrigem.emailCsaPrincipal != null ? enderecosCsaOrigem.emailCsaPrincipal : "");
            mailHeaders.put("eConsig.emailPrincipalCSADestino", enderecosCsaDestino.emailCsaPrincipal != null ? enderecosCsaDestino.emailCsaPrincipal : "");
            mailHeaders.put("eConsig.emailEventoCompraCSAOrigem", enderecosCsaOrigem.emailCsaEvento != null ? enderecosCsaOrigem.emailCsaEvento : "");
            mailHeaders.put("eConsig.emailEventoCompraCSADestino", enderecosCsaDestino.emailCsaEvento != null ? enderecosCsaDestino.emailCsaEvento : "");

            // Manda o email para a consignatária destinatária
            final MailHelper mailHelper = new MailHelper();
            if (emailDestinatarios.size() > 0) {
                for (final String element : emailDestinatarios) {
                    mailHelper.send(element, null, null, titulo, texto, null, mailHeaders);
                }
            }

            String serEmail = adeDelegate.getValorDadoAutDesconto(adeCodigoNovo, CodedValues.TDA_SDV_EMAIL_SERVIDOR, responsavel);
            if (TextHelper.isNull(serEmail)) {
                // Se não tiver e-mail específico para esta compra, veja se no cadastro há um e-mail
                serEmail = (String) adeComprada.getAttribute(Columns.SER_EMAIL);
            }

            if (!TextHelper.isNull(serEmail)) {
                if (tipo == TIPO_COMPRA_CONTRATO) {
                    // Se é compra de contrato, envia uma cópia da mensagem.
                    mailHelper.send(serEmail, null, null, titulo, texto, null, mailHeaders);
                } else if ((tipo == TIPO_CADASTRO_SALDO_DEVEDOR) && ParamSist.paramEquals(CodedValues.TPC_HABILITA_APROVACAO_SALDO_SERVIDOR_COMPRA, CodedValues.TPC_SIM, responsavel)) {
                    // Se é cadastro de saldo e o sistema tem etapa de aprovação de saldo, envia uma cópia da mensagem para o servidor

                    // Redefine o texto do E-mail, sem informação de depósito do saldo
                    texto = titulo + "<br/>\n<br/>\n" + textoGeral.toString() + textoSaldoDevedor;
                    if (!TextHelper.isNull(observacao)) {
                        texto += "<br/>\n"+ ApplicationResourcesHelper.getMessage("rotulo.email.compra.observacao", responsavel, observacao);
                    }

                    // Verifica se são exigidos o cadastro de anexos no saldo, para envio ao servidor
                    List<String> anexos = null;
                    if (ParamSist.paramEquals(CodedValues.TPC_EXIGE_ANEXO_DSD_SALDO_DEVEDOR_COMPRA, CodedValues.TPC_SIM, responsavel) &&
                            (ParamSist.paramEquals(CodedValues.TPC_EMAIL_ANEXO_SALDO_DEVEDOR_SERVIDOR, CodedValues.ANEXO_SALDO_DEVEDOR_SERVIDOR_ENVIA_EMAIL, responsavel) ||
                                    ParamSist.paramEquals(CodedValues.TPC_EMAIL_ANEXO_SALDO_DEVEDOR_SERVIDOR, CodedValues.ANEXO_SALDO_DEVEDOR_SERVIDOR_EMAIL_E_TELA, responsavel))) {

                        final List<String> tarCodigos = new ArrayList<>();
                        tarCodigos.add(TipoArquivoEnum.ARQUIVO_ANEXO_AUTORIZACAO_DSD.getCodigo());
                        final CustomTransferObject cto = new CustomTransferObject();
                        cto.setAttribute(Columns.AAD_ADE_CODIGO, adeCodigo);
                        cto.setAttribute(Columns.AAD_TAR_CODIGO, tarCodigos);
                        cto.setAttribute(Columns.AAD_ATIVO, CodedValues.STS_ATIVO);
                        final EditarAnexoConsignacaoController editarAnexoConsignacaoController = ApplicationContextProvider.getApplicationContext().getBean(EditarAnexoConsignacaoController.class);
                        final List<TransferObject> aadList = editarAnexoConsignacaoController.lstAnexoAutorizacaoDesconto(cto, -1, -1, responsavel);
                        if ((aadList != null) && (aadList.size() > 0)) {
                            texto += "<br/>\n<br/>\n"
                                    + ApplicationResourcesHelper.getMessage("rotulo.email.compra.arquivos.anexos", responsavel)
                                    + "<br/>\n<br/>\n";

                            anexos = new ArrayList<>();
                            for (final TransferObject aad : aadList) {
                                final String aadNome = aad.getAttribute(Columns.AAD_NOME).toString();
                                final String aadDescricao = aad.getAttribute(Columns.AAD_DESCRICAO).toString();
                                final String caminho = ParamSist.getDiretorioRaizArquivos() + File.separatorChar + "anexo" + File.separatorChar + DateHelper.format((Date)adeComprada.getAttribute(Columns.ADE_DATA), "yyyyMMdd") + File.separatorChar + adeCodigo;
                                final File arquivoAnexo = new File(caminho + File.separatorChar + aadNome);
                                if ((arquivoAnexo != null) && arquivoAnexo.exists()) {
                                    anexos.add(arquivoAnexo.getAbsolutePath());
                                    texto += "<b>" + aadDescricao + "</b>: " + aadNome + "<br>\n";
                                }
                            }
                        }
                    }

                    mailHelper.send(serEmail, null, null, titulo, texto, anexos, mailHeaders);
                }
            }

            return "";
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            return ex.getMessage();
        }
    }

    /**
     * Envia por e-mail a informação de saldo devedor para o gestor/órgão quando a solicitação
     * for cadastrada para exclusão de servidor
     * @param adeCodigo
     * @param responsavel
     * @return
     */
    public static final String enviarEmailSaldoDevedorExclusaoServidor(SaldoDevedorTransferObject saldoDevedorTO, AcessoSistema responsavel) {
        try {
            // Busca o contrato informado
            final String adeCodigo = saldoDevedorTO.getAdeCodigo();
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);

            if (ade != null) {
                // Obtém os dados da consignação
                final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
                final String cseNome = getCseNome(responsavel);

                // Define o titulo do E-mail
                final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.saldo.devedor.consignacao.informado", responsavel, adeNumero), responsavel);

                // Texto com os dados do contrato
                final StringBuilder textoGeral = new StringBuilder().append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel)).append(gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel)).append("<br/>\n<br/>\n");

                // Busca os valores do saldo devedor cadastrados
                if (saldoDevedorTO != null) {
                    textoGeral.append(gerarTextoDetalheSaldoDevedor(saldoDevedorTO, responsavel)).append("<br/>\n<br/>\n");
                }

                // Define o texto do E-mail
                final String texto = titulo + "<br/>\n<br/>\n" + textoGeral.toString();

                final List<SolicitacaoAutorizacao> soaList = new SaldoDevedorDelegate().lstSolicitacaoSaldoExclusaoPendente(adeCodigo, responsavel);
                if ((soaList != null) && !soaList.isEmpty()) {
                    for (final SolicitacaoAutorizacao solicitacaoAutorizacao : soaList) {
                        final String usuCodigo = solicitacaoAutorizacao.getUsuario().getUsuCodigo();
                        final UsuarioTransferObject usuario = new UsuarioDelegate().findUsuario(usuCodigo, responsavel);
                        // Envia as mensagens
                        if (!TextHelper.isNull(usuario.getUsuEmail())) {
                            final MailHelper mailHelper = new MailHelper();
                            mailHelper.send(usuario.getUsuEmail(), null, null, titulo, texto, null);
                        }
                    }
                }
            }
            return "";
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            return ex.getMessage();
        }
    }


    /**
     * envia email para entidades relacionadas ao contrato quando papel do usuário responsável estiver configurado tal
     * @param operacao - operação realizada sobre o contrato
     * @param adeCodigo - código da ADE
     * @param observacao - observação a ser incluída no email
     * @param responsavel
     * @throws ZetraException
     */
    public static final void enviarEmailAlteracaoAdePapDestinatarios(OperacaoEConsigEnum operacao, String adeCodigo, String observacao, TransferObject motivoOperacao, AcessoSistema responsavel) throws ZetraException, MessagingException {
        // recupera se o sistema está configurado para enviar email às entidades quando operações sobre consignação são realizadas
        final boolean enviaEmailAlertaAlteracaoAde = ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_ENTIDADES_QNDO_ALTERA_ADE, CodedValues.TPC_SIM, responsavel);
        // recupera se o sistema está configurado para enviar SMS ao servidor quando operações sobre consignação são realizadas
        final boolean enviaSMSAlertaAlteracaoAde = ParamSist.paramEquals(CodedValues.TPC_ENVIA_SMS_SERVIDOR_QNDO_ALTERA_ADE, CodedValues.TPC_SIM, responsavel);

        if (enviaEmailAlertaAlteracaoAde) {
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final ConsignatariaDelegate csaDelegate = new ConsignatariaDelegate();
            final ServidorDelegate serDelegate = new ServidorDelegate();

            // Se não há configuração de envio de e-mail, então retorna
            final String funCodigo = responsavel.getFunCodigo();
            final String papCodigo = responsavel.getPapCodigo();
            final SistemaController sistemaController = ApplicationContextProvider.getApplicationContext().getBean(SistemaController.class);
            final List<String> lstDests = sistemaController.listarPapeisEnvioEmailOperacoes(funCodigo, papCodigo, responsavel);
            if ((lstDests == null) || lstDests.isEmpty()) {
                return;
            }

            // Busca as informações do contrato comprado e do contrato novo
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            if (ade == null) {
                return;
            }

            final String csaCodigo = (String) ade.getAttribute(Columns.CSA_CODIGO);
            final String svcCodigo = (String) ade.getAttribute(Columns.SVC_CODIGO);

            final List<String> emailDestinos = new ArrayList<>();
            final List<String> celularDestinos = new ArrayList<>();

            for (final String destinatario: lstDests) {
                switch (destinatario) {
                    case CodedValues.PAP_CONSIGNATARIA:
                        final String demEmail = csaDelegate.getEmailCsaNotificacaoOperacao(funCodigo, papCodigo, csaCodigo, svcCodigo, responsavel);
                        if (!TextHelper.isNull(demEmail)) {
                            emailDestinos.add(demEmail);
                        }
                        break;
                    case CodedValues.PAP_CORRESPONDENTE:
                        if (!TextHelper.isNull(ade.getAttribute(Columns.COR_EMAIL))) {
                            emailDestinos.add(ade.getAttribute(Columns.COR_EMAIL).toString());
                        }
                        break;
                    case CodedValues.PAP_ORGAO:
                        if (!TextHelper.isNull(ade.getAttribute(Columns.ORG_EMAIL))) {
                            emailDestinos.add(ade.getAttribute(Columns.ORG_EMAIL).toString());
                        }
                        break;
                    case CodedValues.PAP_SERVIDOR:
                    	final String serEmail = serDelegate.getEmailSerNotificacaoOperacao(funCodigo, papCodigo, ade.getAttribute(Columns.SER_CODIGO).toString(), responsavel);
                        if (!TextHelper.isNull(serEmail)) {
                            emailDestinos.add(serEmail);
                        }
                        if (!TextHelper.isNull(ade.getAttribute(Columns.SER_CELULAR))) {
                            celularDestinos.add(ade.getAttribute(Columns.SER_CELULAR).toString());
                        }
                        break;
                    case CodedValues.PAP_CONSIGNANTE:
                        final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
                        final String deeEmail = cseDelegate.getEmailCseNotificacaoOperacao(funCodigo, papCodigo, CodedValues.CSE_CODIGO_SISTEMA, responsavel);
                        if (!TextHelper.isNull(deeEmail)) {
                            emailDestinos.add(deeEmail);
                        }
                        break;
                    case CodedValues.PAP_SUPORTE:
                        emailDestinos.add((String) ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_SUPORTE_ZETRASOFT, responsavel));
                        break;
                }
            }

            // Se não tem e-mail nem celular não faz nada
            if (emailDestinos.isEmpty() && (!enviaSMSAlertaAlteracaoAde || celularDestinos.isEmpty())) {
                return;
            }

            // Dados necessários para envio do e-mail
            final Long adeNumero = (Long) ade.getAttribute(Columns.ADE_NUMERO);
            final String cseNome = getCseNome(responsavel);
            String csaNome = (String) ade.getAttribute(Columns.CSA_NOME_ABREV);
            if (TextHelper.isNull(csaNome)) {
                csaNome = (String) ade.getAttribute(Columns.CSA_NOME);
            }
            if (csaNome.length() > 50) {
                csaNome = csaNome.substring(0, 47) + "...";
            }

            if (!emailDestinos.isEmpty()) {
                // Define o titulo do E-mail
                final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.operacao.realizada.consignacao", responsavel, operacao.getOperacao(), adeNumero.toString()), responsavel);

                // Se for usuário de órgão, inclui o nome do órgão na mensagem
                String usuario = responsavel.getUsuLogin();
                if (responsavel.isOrg()) {
                    usuario += ApplicationResourcesHelper.getMessage("mensagem.email.pertencente.a", responsavel, responsavel.getNomeEntidade());
                }

                // Texto Comum para todas as mensagems
                final StringBuilder textoGeral = new StringBuilder();

                textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.cse.consignacao.cabecalho", responsavel, usuario, adeNumero.toString(), operacao.getOperacao(), DateHelper.toDateTimeString(DateHelper.getSystemDatetime())));
                textoGeral.append(gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel));
                textoGeral.append("<br/>\n<br/>\n");

                if (motivoOperacao != null) {
                    final String tmoCodigo = (String) motivoOperacao.getAttribute(Columns.TMO_CODIGO);
                    final String ocaObs = (String) motivoOperacao.getAttribute(Columns.OCA_OBS);
                    if (!TextHelper.isNull(tmoCodigo)) {
                        final TipoMotivoOperacaoDelegate tmoDelegate = new TipoMotivoOperacaoDelegate();
                        final TipoMotivoOperacaoTransferObject tmo = tmoDelegate.findMotivoOperacao(tmoCodigo, responsavel);
                        textoGeral.append(ApplicationResourcesHelper.getMessage("rotulo.email.motivo", responsavel, tmo.getTmoDescricao())).append(!TextHelper.isNull(ocaObs) ? " - " + ocaObs : "").append("<br/>\n");
                    }
                }
                if (!TextHelper.isNull(observacao)) {
                    textoGeral.append(ApplicationResourcesHelper.getMessage("rotulo.email.observacao", responsavel, observacao));
                }

                // Envia os emails.
                final MailHelper mailHelper = new MailHelper();
                for (final String email: emailDestinos) {
                    if (!TextHelper.isNull(email)) {
                        mailHelper.send(email, null, null, titulo, textoGeral.toString(), null, null);
                    }
                }
            }

            if (enviaSMSAlertaAlteracaoAde && !celularDestinos.isEmpty()) {
                try {
                    // Credenciais para envio do SMS
                    final String accountSid = ParamSist.getInstance().getParam(CodedValues.TPC_SID_CONTA_SMS, responsavel).toString();
                    final String authToken = ParamSist.getInstance().getParam(CodedValues.TPC_TOKEN_AUTENTICACAO_SMS, responsavel).toString();
                    final String fromNumber = ParamSist.getInstance().getParam(CodedValues.TPC_NUMERO_REMETENTE_SMS, responsavel).toString();

                    if (TextHelper.isNull(accountSid) || TextHelper.isNull(authToken) || TextHelper.isNull(fromNumber)) {
                        LOG.warn("Necessário habilitar os parâmetros de sistema " + CodedValues.TPC_SID_CONTA_SMS + ", " + CodedValues.TPC_TOKEN_AUTENTICACAO_SMS + ", " + CodedValues.TPC_NUMERO_REMETENTE_SMS + " para envio de SMS.");

                    } else {
                        for (String celularDestinatario : celularDestinos) {
                            celularDestinatario = LocaleHelper.formataCelular(celularDestinatario);
                            if (!TextHelper.isNull(celularDestinatario)) {
                                final String corpo = ApplicationResourcesHelper.getMessage("mensagem.sms.operacao.realizada.consignacao", responsavel, operacao.getOperacao(), adeNumero.toString(), csaNome);
                                new SMSHelper(accountSid, authToken, fromNumber).send(celularDestinatario, TextHelper.removeAccent(corpo));
                            }
                        }
                    }
                } catch (final ZetraException e) {
                    throw new ViewHelperException("mensagem.erro.sms.enviar", responsavel, e);
                }
            }
        }
    }

    public static final void enviarEmailAlteracaoPerfil(String perCodigo, String tipoEntidade, String codigoEntidade, AcessoSistema responsavel) throws ZetraException {
        // Recupera se o sistema está configurado para enviar email às entidades quando operações sobre perfis de usuário são realizadas
        if (ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_ENTIDADES_QNDO_ALTERA_PERFIL, CodedValues.TPC_SIM, responsavel)) {
            final String funCodigo = responsavel.getFunCodigo();
            final String papCodigoOperador = responsavel.getPapCodigo();
            final String papCodigoDestinatario = UsuarioHelper.getPapCodigo(tipoEntidade);

            // Verifica se o papel ao qual o perfil pertence está entre a lista de destinatarios para o papel do operador
            final SistemaController sistemaController = ApplicationContextProvider.getApplicationContext().getBean(SistemaController.class);
            final List<String> lstDests = sistemaController.listarPapeisEnvioEmailOperacoes(funCodigo, papCodigoOperador, responsavel);
            if ((lstDests == null) || lstDests.isEmpty() || !lstDests.contains(papCodigoDestinatario)) {
                return;
            }

            final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
            final ConsignatariaDelegate csaDelegate = new ConsignatariaDelegate();

            final List<String> emailDestinos = new ArrayList<>();
            switch (papCodigoDestinatario) {
                case CodedValues.PAP_CONSIGNATARIA:
                    final String demEmail = csaDelegate.getEmailCsaNotificacaoOperacao(funCodigo, papCodigoOperador, codigoEntidade, null, responsavel);
                    if (!TextHelper.isNull(demEmail)) {
                        emailDestinos.add(demEmail);
                    }
                    break;
                case CodedValues.PAP_CORRESPONDENTE:
                    final String corEmail = csaDelegate.findCorrespondente(codigoEntidade, responsavel).getCorEmail();
                    if (!TextHelper.isNull(corEmail)) {
                        emailDestinos.add(corEmail);
                    }
                    break;
                case CodedValues.PAP_ORGAO:
                    final String orgEmail = cseDelegate.findOrgao(codigoEntidade, responsavel).getOrgEmail();
                    if (!TextHelper.isNull(orgEmail)) {
                        emailDestinos.add(orgEmail.toString());
                    }
                    break;
                case CodedValues.PAP_CONSIGNANTE:
                    final String cseEmail = cseDelegate.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel).getCseEmail();
                    if (!TextHelper.isNull(cseEmail)) {
                        emailDestinos.add(cseEmail);
                    }
                    break;
                case CodedValues.PAP_SUPORTE:
                    final String supEmail = (String) ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_SUPORTE_ZETRASOFT, responsavel);
                    if (!TextHelper.isNull(supEmail)) {
                        emailDestinos.add(supEmail);
                    }
                    break;
            }

            // Se não tem e-mail para envio não faz nada
            if (emailDestinos.isEmpty()) {
                return;
            }

            final UsuarioDelegate usuDelegate = new UsuarioDelegate();
            final String perDescricao = usuDelegate.findPerfil(perCodigo, responsavel).getPerDescricao();

            for (final String emailDestino : emailDestinos) {
                final EnviarEmailAlteracaoPerfilUsuarioCommand command = new EnviarEmailAlteracaoPerfilUsuarioCommand(emailDestino, perDescricao, responsavel);
                command.execute();
            }
        }
    }

    /**
     * Envia e-mail para a consignatária quando um servidor solicita o saldo
     * devedor de uma de suas consignações.
     * @param adeCodigo
     * @param isQuitacao
     * @param responsavel
     * @return
     */
    public static final String enviarEmailSolicitacaoSaldo(String adeCodigo, boolean isQuitacao, Date dataValidade, AcessoSistema responsavel) {
        try {
            // Busca o contrato
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);

            if (ade != null) {
                // Determina os destinatários da mensagem, de acordo com os parâmetros de SVC/CSA.
                final List<String> tpsCodigos = new ArrayList<>();
                tpsCodigos.add(CodedValues.TPS_EMAIL_INF_SOLICITACAO_SALDO_DEVEDOR);
                tpsCodigos.add(CodedValues.TPS_DESTINATARIOS_EMAILS_CONTROLE_COMPRA);

                String destinatariosEmail = CodedValues.RECEBE_EMAIL_APENAS_CONSIGNATARIA;
                final String emailCorrespondente = (String) ade.getAttribute(Columns.COR_EMAIL);
                String emailConsignataria = null;

                // Busca os parâmetros de serviço da consignatária.
                final List<TransferObject> parametros = new ParametroDelegate().selectParamSvcCsa((String) ade.getAttribute(Columns.SVC_CODIGO), (String) ade.getAttribute(Columns.CSA_CODIGO), tpsCodigos, false, responsavel);
                if (parametros != null) {
                    for (final TransferObject paramSvcCsa : parametros) {
                        final String codigoParametro = (String) paramSvcCsa.getAttribute(Columns.TPS_CODIGO);
                        final String valorParametro = (String) paramSvcCsa.getAttribute(Columns.PSC_VLR);
                        if (CodedValues.TPS_EMAIL_INF_SOLICITACAO_SALDO_DEVEDOR.equals(codigoParametro)) {
                            emailConsignataria = valorParametro;
                        } else if (CodedValues.TPS_DESTINATARIOS_EMAILS_CONTROLE_COMPRA.equals(codigoParametro)) {
                            destinatariosEmail = valorParametro;
                        }
                    }
                }

                // Monta a lista de destinatários da mensagem.
                final List<String> destinatarios = montarListaEnderecosDestinatarios(destinatariosEmail, emailConsignataria, emailCorrespondente);

                // Manda o email para os destinatários.
                if (destinatarios.size() > 0) {
                    // Dados da consignação que teve o saldo devedor solicitado
                    final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
                    final String cseNome = getCseNome(responsavel);

                    // Telefone pra contato - se existir.
                    final String telefone = adeDelegate.getValorDadoAutDesconto(adeCodigo, CodedValues.TDA_SDV_TEL_SERVIDOR, responsavel);

                    // Texto Comum para todas as mensagems
                    final StringBuilder textoGeral = new StringBuilder().append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel)).append(gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel)).append(TextHelper.isNull(telefone) ? "" : "<br/>\n"+ ApplicationResourcesHelper.getMessage("rotulo.email.telefone", responsavel, telefone));
                            if(dataValidade != null) {
                                textoGeral.append("<br/>\n").append(ApplicationResourcesHelper.getMessage("mensagem.email.data.validade.solicitacao.saldo.devedor", responsavel, DateHelper.format(dataValidade, LocaleHelper.getDateTimePattern())));
                            }
                            textoGeral.append("<br/>\n<br/>\n");

                    // Define o titulo do E-mail
                    final String titulo = gerarTituloEmail(null, isQuitacao ? ApplicationResourcesHelper.getMessage("mensagem.email.saldo.devedor.consignacao.solicitado.liquidacao", responsavel, adeNumero) : ApplicationResourcesHelper.getMessage("mensagem.email.saldo.devedor.consignacao.solicitado", responsavel, adeNumero), responsavel);

                    // Define o texto do E-mail
                    final String texto = titulo + "<br/>\n<br/>\n" + textoGeral.toString();

                    // Envia as mensagens.
                    final MailHelper mailHelper = new MailHelper();
                    for (final String element : destinatarios) {
                        mailHelper.send(element, null, null, titulo, texto, null);
                    }
                }
            }

            return "";
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            return ex.getMessage();
        }
    }

    /**
     * Envia por e-mail os anexos do saldo devedor para o servidor quando a consignatária
     * cadastra um saldo devedor originado de uma solicitação do prórprio servidor,
     * e o parâmetro de sistema determina que o e-mail seja enviado.
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    public static final String enviarEmailAnexosSaldoSolicServidor(SaldoDevedorTransferObject saldoDevedorTO, AcessoSistema responsavel) {
        try {
            // Se exige anexos no cadastro de saldo para o servidor e o parâmetro de sistema
            // diz que os anexos do saldo devedor são entregues por e-mail ou e-mail/tela,
            // então verifica se o servidor possui e-mail para envio do saldo devedor.
            if ((ParamSist.paramEquals(CodedValues.TPC_EXIGE_ANEXO_DSD_SALDO_SERVIDOR, CodedValues.TPC_SIM, responsavel) ||
                    ParamSist.paramEquals(CodedValues.TPC_EXIGE_ANEXO_BOLETO_SALDO_SERVIDOR, CodedValues.TPC_SIM, responsavel)) &&
                    (ParamSist.paramEquals(CodedValues.TPC_EMAIL_ANEXO_SALDO_DEVEDOR_SERVIDOR, CodedValues.ANEXO_SALDO_DEVEDOR_SERVIDOR_ENVIA_EMAIL, responsavel) ||
                            ParamSist.paramEquals(CodedValues.TPC_EMAIL_ANEXO_SALDO_DEVEDOR_SERVIDOR, CodedValues.ANEXO_SALDO_DEVEDOR_SERVIDOR_EMAIL_E_TELA, responsavel))) {

                // Busca o contrato informado
                final String adeCodigo = saldoDevedorTO.getAdeCodigo();
                final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
                final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
                if (ade != null) {
                    // Verifica se o servidor possui e-mail cadastrado
                    final String serEmail = (String) ade.getAttribute(Columns.SER_EMAIL);
                    if (!TextHelper.isNull(serEmail)) {

                        // Obtém os dados da consignação
                        final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
                        final String cseNome = getCseNome(responsavel);

                        // Define o titulo do E-mail
                        final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.saldo.devedor.consignacao.informado", responsavel, adeNumero), responsavel);

                        // Texto com os dados do contrato
                        final StringBuilder textoGeral = new StringBuilder().append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel)).append(gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel)).append("<br/>\n<br/>\n");

                        // Busca os valores do saldo devedor cadastrados
                        if (saldoDevedorTO != null) {
                            textoGeral.append(gerarTextoDetalheSaldoDevedor(saldoDevedorTO, responsavel)).append("<br/>\n<br/>\n");
                        }

                        // Se o sistema exige anexos no cadastro de saldo, verifica se já foram informados
                        List<String> anexos = null;
                        final List<String> tarCodigos = new ArrayList<>();
                        tarCodigos.add(TipoArquivoEnum.ARQUIVO_ANEXO_AUTORIZACAO_DSD.getCodigo());
                        tarCodigos.add(TipoArquivoEnum.ARQUIVO_ANEXO_AUTORIZACAO_BOLETO.getCodigo());
                        final CustomTransferObject cto = new CustomTransferObject();
                        cto.setAttribute(Columns.AAD_ADE_CODIGO, adeCodigo);
                        cto.setAttribute(Columns.AAD_TAR_CODIGO, tarCodigos);
                        cto.setAttribute(Columns.AAD_ATIVO, CodedValues.STS_ATIVO);
                        final EditarAnexoConsignacaoController editarAnexoConsignacaoController = ApplicationContextProvider.getApplicationContext().getBean(EditarAnexoConsignacaoController.class);
                        final List<TransferObject> aadList = editarAnexoConsignacaoController.lstAnexoAutorizacaoDesconto(cto, -1, -1, responsavel);
                        if ((aadList != null) && (aadList.size() > 0)) {
                            textoGeral.append(ApplicationResourcesHelper.getMessage("rotulo.email.compra.arquivos.anexos", responsavel)).append("<br/>\n<br/>\n");

                            anexos = new ArrayList<>();
                            for (final TransferObject aad : aadList) {
                                final String aadNome = aad.getAttribute(Columns.AAD_NOME).toString();
                                final String aadDescricao = aad.getAttribute(Columns.AAD_DESCRICAO).toString();
                                final String caminho = ParamSist.getDiretorioRaizArquivos() + File.separatorChar + "anexo" + File.separatorChar + DateHelper.format((Date)ade.getAttribute(Columns.ADE_DATA), "yyyyMMdd") + File.separatorChar + adeCodigo;
                                final File arquivoAnexo = new File(caminho + File.separatorChar + aadNome);
                                if ((arquivoAnexo != null) && arquivoAnexo.exists()) {
                                    anexos.add(arquivoAnexo.getAbsolutePath());
                                    textoGeral.append("<b>").append(aadDescricao).append("</b>: ").append(aadNome).append("<br>\n");
                                }
                            }
                        }

                        // Define o texto do E-mail
                        final String texto = titulo + "<br/>\n<br/>\n" + textoGeral.toString();

                        // Envia as mensagens.
                        final MailHelper mailHelper = new MailHelper();
                        mailHelper.send(serEmail, null, null, titulo, texto, anexos);
                    }
                }
            }

            return "";
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            return ex.getMessage();
        }
    }

    /**
     * Envia e-mail o servidor quando a consignatária
     * cadastra um saldo devedor originado de uma solicitação do prórprio servidor,
     * e o parâmetro de sistema determina que o e-mail seja enviado.
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    public static final String enviarEmailSaldoSolicServidor(SaldoDevedorTransferObject saldoDevedorTO, AcessoSistema responsavel) {
        try {
            boolean emailAnexo = false;

            //faz a mesma verificação do enviarEmailAnexosSaldoSolicServidor() para evitar duplicação de emails
            if ((ParamSist.paramEquals(CodedValues.TPC_EXIGE_ANEXO_DSD_SALDO_SERVIDOR, CodedValues.TPC_SIM, responsavel) ||
                    ParamSist.paramEquals(CodedValues.TPC_EXIGE_ANEXO_BOLETO_SALDO_SERVIDOR, CodedValues.TPC_SIM, responsavel)) &&
                    (ParamSist.paramEquals(CodedValues.TPC_EMAIL_ANEXO_SALDO_DEVEDOR_SERVIDOR, CodedValues.ANEXO_SALDO_DEVEDOR_SERVIDOR_ENVIA_EMAIL, responsavel) ||
                            ParamSist.paramEquals(CodedValues.TPC_EMAIL_ANEXO_SALDO_DEVEDOR_SERVIDOR, CodedValues.ANEXO_SALDO_DEVEDOR_SERVIDOR_EMAIL_E_TELA, responsavel))) {
                emailAnexo = true;
            }

            // Busca o contrato informado
            final String adeCodigo = saldoDevedorTO.getAdeCodigo();
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            if (ade != null) {
                // Verifica se o servidor possui e-mail cadastrado
                final String serEmail = (String) ade.getAttribute(Columns.SER_EMAIL);
                if (!TextHelper.isNull(serEmail) && !emailAnexo) {

                    // Obtém os dados da consignação
                    final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
                    final String cseNome = getCseNome(responsavel);

                    // Define o titulo do E-mail
                    final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.saldo.devedor.consignacao.informado", responsavel, adeNumero), responsavel);

                    // Texto com os dados do contrato
                    final StringBuilder textoGeral = new StringBuilder().append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel)).append(gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel)).append("<br/>\n<br/>\n");

                    // Busca os valores do saldo devedor cadastrados
                    if (saldoDevedorTO != null) {
                        textoGeral.append(gerarTextoDetalheSaldoDevedor(saldoDevedorTO, responsavel)).append("<br/>\n<br/>\n");
                    }

                    // Define o texto do E-mail
                    final String texto = titulo + "<br/>\n<br/>\n" + textoGeral.toString();

                    // Envia as mensagens.
                    final MailHelper mailHelper = new MailHelper();
                    mailHelper.send(serEmail, null, null, titulo, texto, null);
                }
            }

            return "";
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            return ex.getMessage();
        }
    }


    /**
     * Envia e-mail para o servidor quando este for bloqueado ou desbloqueado por serviço
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    public static final void enviarEmailBloqDesbloqServidorServico(String rseCodigo, List<TransferObject> bloqueado, List<TransferObject> desbloqueado, List<TransferObject> alterado, AcessoSistema responsavel) {
        try {
            // se não teve alteração, retorna
            if(bloqueado.isEmpty() && desbloqueado.isEmpty() && alterado.isEmpty()){
                return;
            }

            // Busca o servidor
            final ServidorDelegate serDelegate = new ServidorDelegate();

            final TransferObject servidor = serDelegate.buscaServidor(rseCodigo, responsavel);
            if (servidor != null) {
                // Verifica se o servidor possui e-mail cadastrado
                final String serEmail = (String) servidor.getAttribute(Columns.SER_EMAIL);
                if (!TextHelper.isNull(serEmail)) {

                    // Define o titulo do E-mail
                    final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.bloqueio.servidor.servico.titulo", responsavel), responsavel);

                    final StringBuilder textoGeral = new StringBuilder();
                    // Texto com os dados do bloqueio
                    if (bloqueado.size()>0){
                        textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.bloqueio.servidor.servico", responsavel));
                        textoGeral.append("<br>\n");

                        final Iterator<TransferObject> it = bloqueado.iterator();

                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            textoGeral.append(to.getAttribute(Columns.SVC_DESCRICAO));
                            if (it.hasNext()){
                                textoGeral.append(", ");
                            }
                        }
                        textoGeral.append(".<br>\n");
                    }
                    // Texto com os dados do desbloqueio
                    if (desbloqueado.size()>0){
                        textoGeral.append("<br>\n");
                        final Iterator<TransferObject> it = desbloqueado.iterator();
                        final StringBuilder msg = new StringBuilder();
                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            msg.append(to.getAttribute(Columns.SVC_DESCRICAO));
                            if (it.hasNext()){
                                msg.append(", ");
                            }
                        }

                        textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.desbloqueio.servidor.servico", responsavel, msg.toString(), JspHelper.getNomeSistema(responsavel)));
                        textoGeral.append("<br>\n");
                    }
                    // Texto com os dados dos alterados
                    if (alterado.size()>0){
                        textoGeral.append("<br>\n");
                        final Iterator<TransferObject> it = alterado.iterator();
                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.alteracao.servidor.servico", responsavel, to.getAttribute(Columns.SVC_DESCRICAO).toString(), to.getAttribute(Columns.PSR_VLR).toString()));
                            if (it.hasNext()){
                                textoGeral.append("<br>\n");
                            }
                        }
                        textoGeral.append("<br>\n");
                    }

                    // Define o texto do E-mail
                    String texto = titulo + "<br>\n<br>\n" + textoGeral.toString();
                    texto = TextHelper.forHtmlContentComTags(texto);

                    // Envia as mensagens.
                    final MailHelper mailHelper = new MailHelper();
                    mailHelper.send(serEmail, null, null, titulo, texto, null);
                }
            }

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail para o servidor quando este for bloqueado ou desbloqueado por natureza de serviço
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    public static final void enviarEmailBloqDesbloqServidorNaturezaServico(String rseCodigo, List<TransferObject> bloqueado, List<TransferObject> desbloqueado, List<TransferObject> alterado, AcessoSistema responsavel) {
        try {
            // se não teve alteração, retorna
            if(bloqueado.isEmpty() && desbloqueado.isEmpty() && alterado.isEmpty()){
                return;
            }

            // Busca o servidor
            final ServidorDelegate serDelegate = new ServidorDelegate();

            final TransferObject servidor = serDelegate.buscaServidor(rseCodigo, responsavel);
            if (servidor != null) {
                // Verifica se o servidor possui e-mail cadastrado
                final String serEmail = (String) servidor.getAttribute(Columns.SER_EMAIL);
                if (!TextHelper.isNull(serEmail)) {

                    // Define o titulo do E-mail
                    final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.bloqueio.servidor.natureza.servico.titulo", responsavel), responsavel);

                    final StringBuilder textoGeral = new StringBuilder();
                    // Texto com os dados do bloqueio
                    if (bloqueado.size()>0){
                        textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.bloqueio.servidor.natureza.servico", responsavel));
                        textoGeral.append("<br>\n");

                        final Iterator<TransferObject> it = bloqueado.iterator();

                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            textoGeral.append(to.getAttribute(Columns.NSE_DESCRICAO));
                            if (it.hasNext()){
                                textoGeral.append(", ");
                            }
                        }
                        textoGeral.append(".<br>\n");
                    }
                    // Texto com os dados do desbloqueio
                    if (desbloqueado.size()>0){
                        textoGeral.append("<br>\n");
                        final Iterator<TransferObject> it = desbloqueado.iterator();
                        final StringBuilder msg = new StringBuilder();
                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            msg.append(to.getAttribute(Columns.NSE_DESCRICAO));
                            if (it.hasNext()){
                                msg.append(", ");
                            }
                        }

                        textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.desbloqueio.servidor.natureza.servico", responsavel, msg.toString(), JspHelper.getNomeSistema(responsavel)));
                        textoGeral.append("<br>\n");
                    }
                    // Texto com os dados dos alterados
                    if (alterado.size()>0){
                        textoGeral.append("<br>\n");
                        final Iterator<TransferObject> it = alterado.iterator();
                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.alteracao.servidor.natureza.servico", responsavel, to.getAttribute(Columns.NSE_DESCRICAO).toString(), to.getAttribute(Columns.PNR_VLR).toString()));
                            if (it.hasNext()){
                                textoGeral.append("<br>\n");
                            }
                        }
                        textoGeral.append("<br>\n");
                    }

                    // Define o texto do E-mail
                    String texto = titulo + "<br>\n<br>\n" + textoGeral.toString();
                    texto = TextHelper.forHtmlContentComTags(texto);

                    // Envia as mensagens.
                    final MailHelper mailHelper = new MailHelper();
                    mailHelper.send(serEmail, null, null, titulo, texto, null);
                }
            }

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail para o servidor quando este for bloqueado ou desbloqueado por verba
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    public static final void enviarEmailBloqDesbloqServidorVerba(String rseCodigo, List<TransferObject> bloqueado, List<TransferObject> desbloqueado, List<TransferObject> alterado, AcessoSistema responsavel) {
        try {
            // se não teve alteração, retorna
            if(bloqueado.isEmpty() && desbloqueado.isEmpty() && alterado.isEmpty()){
                return;
            }

            // Busca o servidor
            final ServidorDelegate serDelegate = new ServidorDelegate();

            final TransferObject servidor = serDelegate.buscaServidor(rseCodigo, responsavel);
            if (servidor != null) {
                // Verifica se o servidor possui e-mail cadastrado
                final String serEmail = (String) servidor.getAttribute(Columns.SER_EMAIL);
                if (!TextHelper.isNull(serEmail)) {

                    // Define o titulo do E-mail
                    final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.bloqueio.servidor.codigo.verba.titulo", responsavel), responsavel);

                    final StringBuilder textoGeral = new StringBuilder();
                    // Texto com os dados do bloqueio
                    if (bloqueado.size()>0){
                        textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.bloqueio.servidor.codigo.verba", responsavel));
                        textoGeral.append("<br>\n");

                        final Iterator<TransferObject> it = bloqueado.iterator();

                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            textoGeral.append(to.getAttribute(Columns.CNV_COD_VERBA));
                            if (it.hasNext()){
                                textoGeral.append(", ");
                            }
                        }
                        textoGeral.append(".<br>\n");
                    }
                    // Texto com os dados do desbloqueio
                    if (desbloqueado.size()>0){
                        textoGeral.append("<br>\n");
                        final Iterator<TransferObject> it = desbloqueado.iterator();
                        final StringBuilder msg = new StringBuilder();
                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            msg.append(to.getAttribute(Columns.CNV_COD_VERBA));
                            if (it.hasNext()){
                                msg.append(", ");
                            }
                        }

                        textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.desbloqueio.servidor.codigo.verba", responsavel, msg.toString(), JspHelper.getNomeSistema(responsavel)));
                        textoGeral.append("<br>\n");
                    }
                    // Texto com os dados dos alterados
                    if (alterado.size()>0){
                        textoGeral.append("<br>\n");
                        final Iterator<TransferObject> it = alterado.iterator();
                        while (it.hasNext()) {
                            final TransferObject to = it.next();
                            textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.alteracao.servidor.codigo.verba",
                                    responsavel, to.getAttribute(Columns.CNV_COD_VERBA).toString(),
                                    to.getAttribute(Columns.PCR_VLR).toString()));
                            if (it.hasNext()){
                                textoGeral.append("<br>\n");
                            }
                        }
                        textoGeral.append("<br>\n");
                    }

                    // Define o texto do E-mail
                    String texto = titulo + "<br>\n<br>\n" + textoGeral.toString();
                    texto = TextHelper.forHtmlContentComTags(texto);

                    // Envia as mensagens.
                    final MailHelper mailHelper = new MailHelper();
                    mailHelper.send(serEmail, null, null, titulo, texto, null);
                }
            }

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail para o servidor quando este for bloqueado ou desbloqueado para fazer reserva em determinada consignatária
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    public static final void enviarEmailBloqDesbloqServidorCsa(String rseCodigo, List<TransferObject> bloqueado, List<TransferObject> desbloqueado, List<TransferObject> alterado, AcessoSistema responsavel) {
        try {
            // se não teve alteração, retorna
            if(bloqueado.isEmpty() && desbloqueado.isEmpty() && alterado.isEmpty()){
                return;
            }

            final EnviarEmailBloqDesbloqServidorCsaCommand command = new EnviarEmailBloqDesbloqServidorCsaCommand(rseCodigo, bloqueado, desbloqueado, alterado, responsavel);
            command.execute();

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia email para o servidor, caso o módulo de recuperação de senha do servidor esteja habilitado e o email do servidor tenha sido alterado.
     * @param destinatario
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailCadastroSenhaSer(String destinatario, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(destinatario)) {
            throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
        }

        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String titulo =  ApplicationResourcesHelper.getMessage("rotulo.email.recuperacao.senha", responsavel, nomeSistema);

        // Recupera o nome do consignante
        final String cseNome = getCseNome(responsavel);
        //Uso o parâmetro "TPC_LINK_ACESSO_SISTEMA" para recuperar o link de acesso ao sistema porque este método é chamado no
        //SessionBean "ServidorControllerBean" que não tem acesso ao "Request".
        String url = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_LINK_ACESSO_SISTEMA, responsavel)) ? (String) ParamSist.getInstance().getParam(CodedValues.TPC_LINK_ACESSO_SISTEMA, responsavel) : "";
        url += (url.endsWith("/") ? "" : "/") + "v3/recuperarSenhaServidor?acao=iniciarServidor";
        url = "<a href='" + url +"' >" + url + "</a>";

        final String mensagemCorpo = ApplicationResourcesHelper.getMessage("mensagem.cadastro.senha.email", responsavel, url);

        final StringBuilder corpo = new StringBuilder("<b>").append(nomeSistema).append(" - ").append(cseNome).append("</b><br/>\n<br/>\n");
        corpo.append(mensagemCorpo);
        corpo.append("<br/>\n<br/>\n");

        // Envia o email
        try {
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(destinatario, null, null, titulo, corpo.toString(), null);
        } catch (final MessagingException e) {
            throw new ViewHelperException("mensagem.erro.email.indisponivel", responsavel, e);

        }
    }

    /**
     * Envia por e-mail uma mensagem cadastrada no sistema.
     * @param mensagem Bean da mensagem a ser enviada.
     * @param destinatarios Endereços de e-mail dos destinatários.
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailMensagem(Mensagem mensagem, List<String> destinatarios, AcessoSistema responsavel) throws ViewHelperException {
        if (mensagem == null) {
            throw new ViewHelperException("mensagem.erro.email.mensagem", responsavel);
        }

        if ((destinatarios == null) || (destinatarios.size() == 0) || TextHelper.isNull(destinatarios.get(0))) {
            throw new ViewHelperException("mensagem.erro.email.nenhuma.csa.cadastrada", responsavel);
        }

        if (TextHelper.isNull(mensagem.getMenTexto())) {
            throw new ViewHelperException("mensagem.informe.email.mensagem", responsavel);
        }

        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String titulo = nomeSistema + (!TextHelper.isNull(mensagem.getMenTitulo()) ? ": " + mensagem.getMenTitulo() : "");

        // Recupera o nome do consignante
        final String cseNome = getCseNome(responsavel);

        String corpo = "<b>" + nomeSistema + " - " + cseNome + "<b><br/>\n<br/>\n";
        try {
            if("N".equals(mensagem.getMenHtml())) {
                corpo += new Markdown4jProcessorExtended().process(TextHelper.forHtmlContent(mensagem.getMenTexto())).toString();
            } else {
                corpo += mensagem.getMenTexto();
            }
        } catch (final IOException e) {
            throw new ViewHelperException("mensagem.erro.interpretar.texto.email", responsavel, e);
        }


        // Envia o email
        try {
            final MailHelper mailHelper = new MailHelper();
            if (destinatarios.size() == 1) {
                mailHelper.send(destinatarios.get(0), null, null, titulo, corpo, null);
            } else {
                // Se há mais de um destinatário, envia para todos via cópia carbono.
                mailHelper.send(null, null, TextHelper.join(destinatarios, ","), titulo, corpo, null);
            }
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.indisponivel", responsavel, e);
        }
    }

    /**
     * Envia confirmação de leitura de mensagem para o consignante.
     * @param leituraMensagem
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailConfLeituraMensagem(LeituraMensagemUsuario leituraMensagem, AcessoSistema responsavel) throws ViewHelperException {
        try {
            if (leituraMensagem == null) {
                throw new ViewHelperException("mensagem.erro.email.enviar", responsavel);
            }

            // Recupera o nome do consignante
            final String cseNome = getCseNome(responsavel);
            final String cseEmail = getCseEmail(responsavel);

            if (TextHelper.isNull(cseEmail)) {
                return;
            }

            final String[] emails = cseEmail.replace(" ", "").split(",|;");
            final List<String> destinatarios = Arrays.asList(emails);

            final MensagemController mensagemController = ApplicationContextProvider.getApplicationContext().getBean(MensagemController.class);
            MensagemTO msgTO = new MensagemTO(leituraMensagem.getMenCodigo());
            msgTO = mensagemController.findMensagem(msgTO, responsavel);

            final UsuarioDelegate usuDelegate = new UsuarioDelegate();
            final TransferObject usuario = usuDelegate.obtemUsuarioTipo(leituraMensagem.getUsuCodigo(), null, responsavel);

            final String entidade = usuario.getAttribute("ENTIDADE").toString();
            final String usuLogin = usuario.getAttribute(Columns.USU_LOGIN).toString();
            final String lmuData = DateHelper.format(leituraMensagem.getLmuData(), LocaleHelper.getDateTimePattern());

            final String nomeSistema = JspHelper.getNomeSistema(responsavel);
            final String titulo = nomeSistema + (!TextHelper.isNull(msgTO.getMenTitulo()) ? ": " + msgTO.getMenTitulo() : "");

            // incluindo o nome da entidade (seja CSA/COR/ORG), do usuário, login, data e hora da confirmação.

            String corpo = "<b>" + nomeSistema + " - " + cseNome + "</b><br/>\n<br/>\n";
            corpo += ApplicationResourcesHelper.getMessage("rotulo.usuario.entidade", responsavel) + ": " + entidade + "<br/>\n";
            corpo += ApplicationResourcesHelper.getMessage("rotulo.usuario.login", responsavel) + ": " + usuLogin + "<br/>\n";
            corpo += ApplicationResourcesHelper.getMessage("rotulo.mensagem.data.confirmacao.leitura", responsavel) + ": " + lmuData;
            corpo += "<br/>\n";

            // Envia o email
            final MailHelper mailHelper = new MailHelper();
            if (destinatarios.size() == 1) {
                mailHelper.send(destinatarios.get(0), null, null, titulo, corpo, null);
            } else {
                // Se há mais de um destinatário, envia para todos via cópia carbono.
                mailHelper.send(null, null, TextHelper.join(destinatarios, ","), titulo, corpo, null);
            }
        } catch (MessagingException | MensagemControllerException | UsuarioControllerException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia e-mail para o servidor informando sobre alteração de senha.
     * @param destinatario : E-mail do destinatário
     * @param matricula : Matrícula do servidor
     * @param novaSenha : Nova senha do servidor
     * @param reiniciacao : Informa se foi uma reiniciação ou alteração de senha
     * @param senhaAutorizacaoServidor : Indica que é senha de autorização (senha 2)
     * @param responsavel : Responsável
     * @throws ViewHelperException
     */
    public static final void enviarEmailAlteracaoSenhaServidor(String destinatario, String matricula, String novaSenha, boolean reiniciacao, boolean senhaAutorizacaoServidor, boolean senhaApp, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(destinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String cseNome = getCseNome(responsavel);
        String titulo = nomeSistema + " - " + cseNome + ": ";
        final StringBuilder corpo = new StringBuilder();

        if (!senhaAutorizacaoServidor) {
            titulo += reiniciacao ? ApplicationResourcesHelper.getMessage("rotulo.email.reinicializacao.senha", responsavel) : ApplicationResourcesHelper.getMessage("rotulo.email.alteracao.senha", responsavel);

            // Determina quais dados do servidor devem ir no corpo do e-mail.
            String paramDadosServidorEmail = (String) ParamSist.getInstance().getParam(CodedValues.TPC_DADOS_SERVIDOR_EMAIL_ALTERACAO_SENHA, responsavel);
            if (TextHelper.isNull(paramDadosServidorEmail)) {
                paramDadosServidorEmail = CodedValues.DADOS_SERVIDOR_EMAIL_MATRICULA + CodedValues.DADOS_SERVIDOR_EMAIL_SEPARADOR + CodedValues.DADOS_SERVIDOR_EMAIL_SENHA;
            }
            final List<String> dadosServidorEmail = Arrays.asList(TextHelper.dropBlankSpace(paramDadosServidorEmail).toUpperCase().split(CodedValues.DADOS_SERVIDOR_EMAIL_SEPARADOR));

            if (reiniciacao) {
                corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.senha.servidor.reiniciada", responsavel));
            } else if (senhaApp) {
                corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.senha.app.servidor.alterada", responsavel));
            } else {
                corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.senha.servidor.alterada", responsavel));
            }

            corpo.append("<br/>\n<br/>");

            if (dadosServidorEmail.contains(CodedValues.DADOS_SERVIDOR_EMAIL_MATRICULA)) {
                corpo.append(ApplicationResourcesHelper.getMessage("rotulo.email.matricula.servidor", responsavel, matricula));
                corpo.append("<br/>\n");
            }

            //DESENV-13471: Se alteração de senha vinda de requisição de mobile, nunca enviar senha no corpo do e-mail.
            if (!senhaApp && dadosServidorEmail.contains(CodedValues.DADOS_SERVIDOR_EMAIL_SENHA)) {
                corpo.append(ApplicationResourcesHelper.getMessage("rotulo.email.nova.senha", responsavel, novaSenha));
                corpo.append("<br/>\n");
            }

        } else {
            titulo += ApplicationResourcesHelper.getMessage("rotulo.email.geracao.senha.servidor.autorizacao", responsavel);
            corpo.append(ApplicationResourcesHelper.getMessage("mensagem.senha.servidor.autorizacao.sucesso.corpo.email", responsavel)).append("<br/>\n<br/>").append(ApplicationResourcesHelper.getMessage("rotulo.email.senha.servidor.autorizacao", responsavel, novaSenha)).append("<br/>\n");
        }

        final String texto = titulo + "<br/>\n<br/>\n" + corpo.toString();

        // Envia o e-mail.
        try {
            new MailHelper().send(destinatario, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia link por e-mail para o servidor para recuperação de senha.
     * @param destinatario E-mail do destinatário.
     * @param matricula Matrícula do servidor.
     * @param novaSenha Nova senha do servidor.
     * @param reiniciacao Informa se foi uma reiniciação ou alteração de senha.
     * @param responsavel Responsável.
     * @throws ViewHelperException
     */
    public static final void enviarEmailLinkRecuperarSenha(String destinatario, String matricula, String link, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(destinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String cseNome = getCseNome(responsavel);
        final String titulo =  ApplicationResourcesHelper.getMessage("rotulo.email.consignante.recuperacao.senha", responsavel, nomeSistema, cseNome);

        // Determina quais dados do servidor devem ir no corpo do e-mail.
        String paramDadosServidorEmail = (String) ParamSist.getInstance().getParam(CodedValues.TPC_DADOS_SERVIDOR_EMAIL_ALTERACAO_SENHA, responsavel);
        if (TextHelper.isNull(paramDadosServidorEmail)) {
            paramDadosServidorEmail = CodedValues.DADOS_SERVIDOR_EMAIL_MATRICULA + CodedValues.DADOS_SERVIDOR_EMAIL_SEPARADOR + CodedValues.DADOS_SERVIDOR_EMAIL_SENHA;
        }
        Arrays.asList(TextHelper.dropBlankSpace(paramDadosServidorEmail).toUpperCase().split(CodedValues.DADOS_SERVIDOR_EMAIL_SEPARADOR));

        link = "<a href='" + link +"' >" + link + "</a>";

        final String corpo = ApplicationResourcesHelper.getMessage("mensagem.recuperacao.senha.email", responsavel, link);

        final String texto = titulo + "<br/>\n<br/>\n" + corpo;

        // Envia o e-mail.
        try {
            new MailHelper().send(destinatario, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

   /**
    * E-mail enviado a um novo usuário do sistema eConsig para definir senha de acesso
    * @param destinatario E-mail do destinatário.
    * @param usuNome - Nome do novo usuário criado
    * @param entNome - Nome da entidade à qual pertence o usuário
    * @param link link a que direciona à página de entrada da nova senha
    * @param responsavel
    * @throws ViewHelperException
    */
    public static final void enviarEmailLinkDefinirSenhaNovoUsuario(String destinatario, String usuLogin, String usuNome, String link, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final EnviarLinkCriarSenhaUsuarioCommand command = new EnviarLinkCriarSenhaUsuarioCommand();
            command.setSerEmail(destinatario);
            command.setLink(link);
            command.setUsuLogin(usuLogin);
            command.setSerNome(usuNome);
            command.setResponsavel(responsavel);
            command.execute();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia link por e-mail para o usuário informando sobre alteração de senha no auto-desbloqueio.
     * @param destinatario E-mail do destinatário.
     * @param matricula Matrícula do servidor, no caso de desbloqueio de servidor.
     * @param link url de recuperação de senha
     * @param responsavel Responsável.
     * @throws ViewHelperException
     */
    public static final void enviarEmailLinkRecuperarSenhaAutoDesbloqueio(String destinatario, String matricula, String link, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(destinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String cseNome = getCseNome(responsavel);
        final String titulo =  ApplicationResourcesHelper.getMessage("rotulo.email.consignante.auto.desbloqueio", responsavel, nomeSistema, cseNome);

        if (responsavel.isSer()) {
            // Determina quais dados do servidor devem ir no corpo do e-mail.
            String paramDadosServidorEmail = (String) ParamSist.getInstance().getParam(CodedValues.TPC_DADOS_SERVIDOR_EMAIL_ALTERACAO_SENHA, responsavel);
            if (TextHelper.isNull(paramDadosServidorEmail)) {
                paramDadosServidorEmail = CodedValues.DADOS_SERVIDOR_EMAIL_MATRICULA + CodedValues.DADOS_SERVIDOR_EMAIL_SEPARADOR + CodedValues.DADOS_SERVIDOR_EMAIL_SENHA;
            }
            Arrays.asList(TextHelper.dropBlankSpace(paramDadosServidorEmail).toUpperCase().split(CodedValues.DADOS_SERVIDOR_EMAIL_SEPARADOR));
        }

        link = "<a href='" + link +"' >" + link + "</a>";

        final String corpo = ApplicationResourcesHelper.getMessage("mensagem.auto.desbloqueio.email", responsavel, link);

        final String texto = titulo + "<br/>\n<br/>\n" + corpo;

        // Envia o e-mail.
        try {
            new MailHelper().send(destinatario, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia e-mail para o servidor informando o código de autorização para solicitação.
     * @param destinatario E-mail do destinatário.
     * @param matricula Matrícula do servidor.
     * @param adeCodigo Código da autorização desconto.
     * @param codAutorizacao Código de autorização da solicitação.
     * @param responsavel Responsável.
     * @throws ViewHelperException
     */
    public static final void enviarEmailCodigoAutorizacaoServidor(String destinatario, String matricula, String adeCodigo, String codAutorizacao, AcessoSistema responsavel) throws ViewHelperException {
        try {
            if (TextHelper.isNull(destinatario)) {
                throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
            }

            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);

            final String cseNome = getCseNome(responsavel);
            final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();

            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.email.codigo.autorizacao.solicitacao", responsavel, adeNumero), responsavel);

            final StringBuilder corpo = new StringBuilder();
            corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.seguem.dados.solicitacao.codigo.autorizacao", responsavel) + ": <br/>\n<br/>");
            corpo.append(gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel));
            corpo.append("<br/>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.email.codigo.autorizacao", responsavel, codAutorizacao) + "</b>");
            corpo.append("<br/>\n<br/>\n");

            final String texto = titulo + "<br/>\n<br/>\n" + corpo.toString();

            // Envia o e-mail.
            new MailHelper().send(destinatario, null, null, titulo, texto, null);
        } catch (MessagingException | AutorizacaoControllerException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }


    /**
     * Envia e-mail para o servidor informando o código para verificação do e-mail.
     * @param destinatario E-mail do destinatário.
     * @param matricula Matrícula do servidor.
     * @param adeCodigo Código da autorização desconto.
     * @param codAutorizacao Código de autorização da solicitação.
     * @param responsavel Responsável.
     * @throws ViewHelperException
     */
    public static final void enviarEmailCodigoVerificacaoEmailServidor(String destinatario, String codVerificacao, AcessoSistema responsavel) throws ViewHelperException {
        try {
            if (TextHelper.isNull(destinatario)) {
                throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
            }

            final String cseNome = getCseNome(responsavel);
            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.email.codigo.verificacao.email", responsavel), responsavel);

            final StringBuilder corpo = new StringBuilder();
            corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.codigo.verificacao.alteracao.email", responsavel) + ": <br/>\n<br/>");
            corpo.append("<br/>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.email.codigo.autorizacao", responsavel, codVerificacao) + "</b>");
            corpo.append("<br/>\n<br/>\n");

            final String texto = titulo + "<br/>\n<br/>\n" + corpo.toString();

            // Envia o e-mail.
            new MailHelper().send(destinatario, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }


    /**
     * Envia e-mail para as consignatárias que são bloqueadas automaticamente pelo módulo avançado
     * de compra ou pela solicitação de saldo devedor, em detrimento a alguma penalidade sofrida
     * pelo não cumprimento de algum prazo estipulado pelo Consignante.
     * @param adesResponsaveisBloqueio Lista de ADEs responsáveis pelo bloqueio.
     * @param motivoBloqueio Motivo de bloqueio.
     * @param responsavel
     */
    public final static void enviarEmailBloqueioConsignatarias(List<TransferObject> adesResponsaveisBloqueio, int motivoBloqueio, AcessoSistema responsavel) throws ViewHelperException {
        if ((adesResponsaveisBloqueio == null) || (adesResponsaveisBloqueio.size() == 0)) {
            return;
        }

        // Relaciona os endereços de email dos destinatários com os respectivos contratos (agrupados por consignatária) responsáveis pelo bloqueio.
        final Map<String, Map<String, List<TransferObject>>> destinatariosContratos = new HashMap<>();

        for (final TransferObject adeResponsavelBloqueio : adesResponsaveisBloqueio) {
            // Determina quais endereços de e-mail devem ser comunicados a respeito do bloqueio provocado pela ADE.
            final List<String> enderecosAviso = EnviaEmailHelper.montarListaEnderecosDestinatarios((String) adeResponsavelBloqueio.getAttribute("DESTINATARIOS_EMAILS"), (String) adeResponsavelBloqueio.getAttribute("EMAIL_AVISO_CSA"), (String) adeResponsavelBloqueio.getAttribute(Columns.COR_EMAIL));

            final String csaCodigo = (String) adeResponsavelBloqueio.getAttribute(Columns.CSA_CODIGO);

            // Se a lista de endereços não for vazia.
            if (enderecosAviso.size() > 0) {
                // Agrupa as ADEs por CSA para o destinatário.
                for (final String enderecoAviso : enderecosAviso) {
                    final Map<String, List<TransferObject>> adesBloqueioDestinatario = destinatariosContratos.containsKey(enderecoAviso) ? destinatariosContratos.get(enderecoAviso) : new HashMap<>();
                    final List<TransferObject> adesDaConsignataria = adesBloqueioDestinatario.containsKey(csaCodigo) ? adesBloqueioDestinatario.get(csaCodigo) : new ArrayList<>();
                    adesDaConsignataria.add(adeResponsavelBloqueio);
                    adesBloqueioDestinatario.put(csaCodigo, adesDaConsignataria);
                    destinatariosContratos.put(enderecoAviso, adesBloqueioDestinatario);
                }
            }
        }

        // Se não há e-mail a ser enviado, termina.
        if (destinatariosContratos.size() < 1) {
            return;
        }

        // Para cada destinatário
        for (final String emailDestinatario : destinatariosContratos.keySet()) {
            final Map<String, List<TransferObject>> consignatariaAdes = destinatariosContratos.get(emailDestinatario);

            // Para cada consignatária
            for (final String csaCodigo : consignatariaAdes.keySet()) {
                final List<TransferObject> ades = consignatariaAdes.get(csaCodigo);

                // O nome da consignatária é igual em todas ADEs. Pega o nome da primeira ADE da lista.
                final String csaNome = (String) ades.get(0).getAttribute(Columns.CSA_NOME);

                EnviaEmailHelper.enviarEmailBloqueioConsignataria(emailDestinatario, motivoBloqueio, csaNome, ades, responsavel);
            }
        }
    }

    private final static void enviarEmailBloqueioConsignataria(String emailDestinatario, int motivoBloqueio, String csaNome, List<TransferObject> adesResponsaveisBloqueio, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(emailDestinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        // Recupera o nome do consignante
        final String cseNome = getCseNome(responsavel);

        // Define o título do E-mail
        final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.email.bloqueio.consignataria", responsavel), responsavel);

        final StringBuilder corpo = new StringBuilder();
        switch (motivoBloqueio) {
            case CodedValues.BLOQUEIO_INF_SALDO_DEVEDOR_COMPRA:
                corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.bloqueada.nao.informou.saldo.devedor", responsavel, csaNome));
                break;
            case CodedValues.BLOQUEIO_INF_PGT_SALDO_COMPRA:
                corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.bloqueada.nao.informou.pagamento.saldo.devedor", responsavel, csaNome));
                break;
            case CodedValues.BLOQUEIO_LIQUIDACAO_COMPRA:
                corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.bloqueada.nao.liquidou.contrato", responsavel, csaNome));
                break;
            case CodedValues.BLOQUEIO_SOLIC_SALDO_DEVEDOR:
                corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.bloqueada.nao.atendeu.solicitacao", responsavel, csaNome));
                break;
            default:
                break;
        }
        corpo.append("<br/>\n<br/>\n");

        if ((adesResponsaveisBloqueio != null) && (adesResponsaveisBloqueio.size() > 0)) {
            final StringBuilder textoConsignacoes = new StringBuilder("<b>").append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao.plural", responsavel)).append("</b>");

            for (final TransferObject ade : adesResponsaveisBloqueio) {
                textoConsignacoes.append(gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel)).append("<br/>\n");
            }

            corpo.append(textoConsignacoes.toString());
        }

        final String texto = titulo + "<br/>\n<br/>\n" + corpo.toString();

        // Envia o e-mail.
        try {
            new MailHelper().send(emailDestinatario, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia e-mail de aviso da alteração da tabela de taxas limite,
     * informando que as demais consignatárias devem alterar sua tabela
     * de taxas para ficarem em conformidade com o sistema.
     * @param emailDestinatario
     * @param entName
     * @param tipoEntidade
     * @param dataFimVig
     * @param novaTabelaLimiteTaxa
     * @param tabelaTaxaAtual
     * @param responsavel
     * @throws ViewHelperException
     */
    public final static void enviarEmailAlteracaoTabelaTaxaLimite(String emailDestinatario, String entName, String tipoEntidade, java.util.Date dataFimVig, List<TransferObject> novaTabelaLimiteTaxa, List<TransferObject> tabelaTaxaAtual, AcessoSistema responsavel) throws ViewHelperException {
        if ((novaTabelaLimiteTaxa != null) && (novaTabelaLimiteTaxa.size() > 0) &&
                !TextHelper.isNull(emailDestinatario)) {

            // Define o título da mensagem
            final String nomeSistema = JspHelper.getNomeSistema(responsavel);
            final String cseNome = getCseNome(responsavel);
            final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.alteracao.tabela.taxas.limite", responsavel, nomeSistema, cseNome);

            // Monta o corpo da mensagem com a tabela de taxas
            final StringBuilder corpoMensagem = new StringBuilder();
            if (AcessoSistema.ENTIDADE_CSA.equals(tipoEntidade)) {
                corpoMensagem.append("<br>"+ ApplicationResourcesHelper.getMessage("rotulo.email.consignataria", responsavel, entName));
            } else if (AcessoSistema.ENTIDADE_CSE.equals(tipoEntidade)) {
                corpoMensagem.append("<br>"+ ApplicationResourcesHelper.getMessage("rotulo.email.consignante", responsavel, entName));
            }
            if (dataFimVig != null) {
                // Se foi passada uma data limite, então significa que esta consignatária teve a tabela expirada
                corpoMensagem.append(ApplicationResourcesHelper.getMessage("mensagem.email.tabela.taxas.limite.alterada.atualize.dados", responsavel, DateHelper.toDateTimeString(dataFimVig)));
            } else {
                // Senão, é apenas uma mensagem de aviso sobre a alteração
                corpoMensagem.append(ApplicationResourcesHelper.getMessage("mensagem.email.tabela.taxas.limite.alterada", responsavel));
            }

            corpoMensagem.append("<br><br><b>" + ApplicationResourcesHelper.getMessage("mensagem.email.nova.tabela.taxas", responsavel) + ":</b><br>");
            corpoMensagem.append("<table border=\"1\">");
            corpoMensagem.append("<tr><td><b>" + ApplicationResourcesHelper.getMessage("rotulo.consignacao.prazo", responsavel) + "</b></td><td><b>" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.maximo.permitido", responsavel) + "</b></td></tr>");

            Iterator<TransferObject> itCoeficientes = novaTabelaLimiteTaxa.iterator();
            while (itCoeficientes.hasNext()) {
                final TransferObject valor = itCoeficientes.next();
                final BigDecimal cftVlr = new BigDecimal(valor.getAttribute(Columns.CFT_VLR).toString());
                final String prazo = valor.getAttribute(Columns.PRZ_VLR).toString();
                if (cftVlr.signum() > 0) {
                    corpoMensagem.append("<tr><td>" + prazo + "</td><td>" + NumberHelper.format(cftVlr.doubleValue() - 0.01, NumberHelper.getLang()) + "</td></tr>");
                } else {
                    corpoMensagem.append("<tr><td>" + prazo + "</td><td>" + ApplicationResourcesHelper.getMessage("rotulo.email.ilimitado", responsavel) + "</td></tr>");
                }
            }
            corpoMensagem.append("</table>");

            if (tabelaTaxaAtual != null) {
                corpoMensagem.append("<br><br><b>" + ApplicationResourcesHelper.getMessage("mensagem.email.prazos.acima.limite.permitido.sao", responsavel) + ":</b><br>");
                corpoMensagem.append("<table border=\"1\">");
                corpoMensagem.append("<tr><td><b>" + ApplicationResourcesHelper.getMessage("rotulo.consignacao.prazo", responsavel) + "</b></td><td><b>" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.atual", responsavel) + "</b></td></tr>");

                itCoeficientes = tabelaTaxaAtual.iterator();
                while (itCoeficientes.hasNext()) {
                    final TransferObject valor = itCoeficientes.next();
                    final BigDecimal cftVlr = new BigDecimal(valor.getAttribute(Columns.CFT_VLR).toString());
                    final String prazo = valor.getAttribute(Columns.PRZ_VLR).toString();
                    corpoMensagem.append("<tr><td>" + prazo + "</td><td>" + NumberHelper.format(cftVlr.doubleValue(), NumberHelper.getLang()) + "</td></tr>");
                }
                corpoMensagem.append("</table>");
            }

            // Envia o e-mail.
            try {
                new MailHelper().send(emailDestinatario, null, null, titulo, corpoMensagem.toString(), null);
            } catch (final MessagingException e) {
                throw new ViewHelperException ("mensagem.erro.email.alteracao.tabela.taxas.limite", responsavel, e);
            }
        }
    }

    /**
     * Envia email com o resultado da validação no ambiente do eConsig das regras cadastradas.
     * @param destinatario Destinatpario do email.
     * @param regrasInvalidas Lista de regras que nao foram cumpridas.
     * @param bloqueio Flag que indica se o ambiente foi bloqueado.
     * @param responsavel Responsável pela operação.
     * @throws ViewHelperException Exceção padrão da classe.
     */
    public static void enviarEmailValidacaoAmbiente(List<String> regrasInvalidas, boolean bloqueio, AcessoSistema responsavel) throws ViewHelperException  {
        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String cseNome = getCseNome(responsavel);

        final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.rotina.automatica.verificacao.ambiente.execucao", responsavel, nomeSistema, cseNome);
        final StringBuilder corpo = new StringBuilder(ApplicationResourcesHelper.getMessage("mensagem.email.ocorreram.erros.regras.ambiente", responsavel));
        for (final String regra : regrasInvalidas) {
            corpo.append("- <b>" + regra + "</b><br/>\n");
        }
        if (bloqueio) {
            corpo.append("<br/>\n<br/>\n "+ ApplicationResourcesHelper.getMessage("mensagem.email.sistema.bloqueado.para.ajustes", responsavel));
        }
        final String texto = titulo + "<br/>\n<br/>\n" + corpo;

        // Envia o e-mail
        try {
            new MailHelper().send(DESTINATARIO_BLOQ_SISTEMA, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * envia e-mail de alerta aos destinatários de uma nova comunicação gerada.
     * @param usuCodigo código do usuário rementente
     * @param endDestinatario - e-mail de destino
     * @param cmnCodigo - código da comunicação para a qual o e-mail será criado
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailComunicacao(String usuCodigo, String endDestinatario, TransferObject comunicacao, AcessoSistema responsavel) throws ViewHelperException {
        String nomeRemetente = "";
        TransferObject dadosRemetente = null;
        UsuarioTransferObject usuEntity = null;
        final StringBuilder emailTexto = new StringBuilder();


        try {
            final UsuarioDelegate usuDelegate = new UsuarioDelegate();
            Throwable findException = null;

            try {
                dadosRemetente = usuDelegate.findUsuarioSer(usuCodigo, responsavel);
            } catch (final Exception ex) {
                findException = ex;
            }

            if (dadosRemetente != null) {
                nomeRemetente = (String) dadosRemetente.getAttribute(Columns.USU_NOME);
                emailTexto.append(ApplicationResourcesHelper.getMessage("rotulo.email.o.usuario.servidor", responsavel, nomeRemetente));
            } else {
                try {
                    usuEntity = usuDelegate.findUsuario(usuCodigo, responsavel);
                } catch (final Exception ex) {
                    findException = ex;
                }

                if (usuEntity != null) {
                    nomeRemetente = usuEntity.getUsuNome();

                    final CustomTransferObject usuEntityTO = usuDelegate.findTipoUsuario(usuEntity.getUsuLogin(), responsavel);

                    if ((usuEntityTO != null) && (usuEntityTO.getAttribute(Columns.UCA_CSA_CODIGO) != null)) {
                        final ConsignatariaDelegate csaDelegate = new ConsignatariaDelegate();
                        final ConsignatariaTransferObject csaTO = csaDelegate.findConsignataria((String) usuEntityTO.getAttribute(Columns.UCA_CSA_CODIGO), responsavel);
                        emailTexto.append(ApplicationResourcesHelper.getMessage("rotulo.email.a.consignataria", responsavel, csaTO.getCsaNome()));

                    } else if ((usuEntityTO != null) && (usuEntityTO.getAttribute(Columns.UCE_CSE_CODIGO) != null)) {
                        final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
                        final ConsignanteTransferObject cseTO = cseDelegate.findConsignante((String) usuEntityTO.getAttribute(Columns.UCE_CSE_CODIGO), responsavel);
                        emailTexto.append(ApplicationResourcesHelper.getMessage("rotulo.email.o.gestor", responsavel, cseTO.getCseNome()));

                    } else if ((usuEntityTO != null) && (usuEntityTO.getAttribute(Columns.UOR_ORG_CODIGO) != null)) {
                        final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
                        final OrgaoTransferObject orgTO = cseDelegate.findOrgao((String) usuEntityTO.getAttribute(Columns.UOR_ORG_CODIGO), responsavel);
                        emailTexto.append(ApplicationResourcesHelper.getMessage("rotulo.email.o.orgao", responsavel, orgTO.getOrgNome()));

                    } else {
                        throw new ViewHelperException ("mensagem.erro.email.remetente.nao.encontrado", responsavel);
                    }
                } else {
                    throw new ViewHelperException ("mensagem.erro.email.remetente.nao.encontrado", responsavel, findException);
                }
            }

            if ((dadosRemetente != null) || (usuEntity != null)) {
                if (comunicacao.getAttribute(Columns.CMN_CODIGO_PAI) == null) {
                    emailTexto.append(" " + ApplicationResourcesHelper.getMessage("rotulo.email.gerou.nova.comunicacao", responsavel));
                } else {
                    final ComunicacaoController comunicacaoController = ApplicationContextProvider.getApplicationContext().getBean(ComunicacaoController.class);
                    final Comunicacao cmnOriginal = comunicacaoController.findComunicacaoByPK((String) comunicacao.getAttribute(Columns.CMN_CODIGO_PAI), responsavel);
                    emailTexto.append(" " + ApplicationResourcesHelper.getMessage("rotulo.email.gerou.comunicacao.resposta", responsavel) + "<br><br>\n");
                    emailTexto.append("<P ALIGN=\"CENTER\">").append("\"").append(cmnOriginal.getCmnTexto()).append("\"").append("</P>\n");
                    emailTexto.append("<br><br>\n");
                    emailTexto.append(ApplicationResourcesHelper.getMessage("rotulo.email.enviada.em", responsavel, DateHelper.toDateTimeString(cmnOriginal.getCmnData()))).append("\n");
                }

                final String nomeSistema = JspHelper.getNomeSistema(responsavel);
                final String cseNome = getCseNome(responsavel);

                final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.alerta.nova.comunicacao", responsavel, nomeSistema, cseNome);

                String mensagem = (String) comunicacao.getAttribute(Columns.CMN_TEXTO);
                mensagem = mensagem.replaceAll("\\r\\n|\\r|\\n", "<br>");

                emailTexto.append("<br><br>\n");
                emailTexto.append("<b>").append(mensagem).append("</b>");

                emailTexto.append("<br><br>\n");
                emailTexto.append(ApplicationResourcesHelper.getMessage("mensagem.email.confira.sistema.maiores.detalhes", responsavel, nomeSistema));

                final MailHelper mailHelper = new MailHelper();
                try {
                    mailHelper.send(endDestinatario, null, null, titulo, emailTexto.toString(), null);
                } catch (final MessagingException e) {
                    throw new ViewHelperException ("mensagem.erro.email.alerta.nova.comunicacao", responsavel, e);
                }

            } else {
                throw new ViewHelperException ("mensagem.erro.email.remetente.nao.encontrado", responsavel);
            }
        } catch (final ZetraException e) {
            throw new ViewHelperException ("mensagem.erro.email.alerta.nova.comunicacao", responsavel, e);
        }
    }

    /**
     * envia e-mail do relatorio
     * @param usuCodigo código do usuário rementente
     * @param endDestinatario - e-mail de destino
     * @param cmnCodigo - código da comunicação para a qual o e-mail será criado
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailRelatorioIntegracao(String csaCodigo, String endDestinatario,
            String pathArquivo, List<String> arquivos, String nomeArquivo, AcessoSistema responsavel) throws ViewHelperException {

        final StringBuilder emailTexto = new StringBuilder();
        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String cseNome = getCseNome(responsavel);
        final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.relatorio.integracao", responsavel, nomeSistema, cseNome);
        final List<String> anexo = new ArrayList<>();
        File arquivoAnexo = null;
        try {
            emailTexto.append("<b>").append(nomeSistema).append(" - ").append(cseNome).append("</b><br/>\n<br/>\n");
            emailTexto.append(ApplicationResourcesHelper.getMessage("mensagem.email.relatorio.integracao", responsavel));
            emailTexto.append("<br/>\n<br/>\n");

            if ((arquivos != null) && !arquivos.isEmpty()) {
                final String zip = pathArquivo + nomeArquivo + ".zip";
                FileHelper.zip(arquivos, zip);
                arquivoAnexo = new File(zip);

                if ((arquivoAnexo != null) && arquivoAnexo.exists()) {
                    anexo.add(arquivoAnexo.getAbsolutePath());
                    final MailHelper mailHelper = new MailHelper();
                    mailHelper.send(endDestinatario, null, null, titulo, emailTexto.toString(), anexo);
                }

            }

        } catch (MessagingException | IOException e) {
            throw new ViewHelperException ("mensagem.erro.email.relatorio.integracao", responsavel, e);
        } finally {
            if ((arquivoAnexo != null) && arquivoAnexo.exists()) {
                arquivoAnexo.delete();
            }
        }
    }

    /**
     * Envia email para consignatária de alerta de proximidade de corte.
     * @param destinatario
     * @param diaCorte
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailCsaAlertaProximidadeCorte(String destinatario, Date diaCorte, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(destinatario)) {
            throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
        }

        final String[] emails = destinatario.replace(" ", "").split(",|;");
        final List<String> destinatarios = Arrays.asList(emails);

        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String cseNome = getCseNome(responsavel);

        final String titulo =  ApplicationResourcesHelper.getMessage("rotulo.email.proximidade.corte.titulo", responsavel, cseNome);
        final String mensagemCorpo = ApplicationResourcesHelper.getMessage("rotulo.email.proximidade.corte", responsavel, cseNome, DateHelper.format(diaCorte, LocaleHelper.getDatePattern()));

        String corpo = "<b>" + nomeSistema + " - " + cseNome + "</b><br/>\n<br/>\n";
        corpo += mensagemCorpo;
        corpo += "<br/>\n<br/>\n";

        // Envia o email
        try {
            final MailHelper mailHelper = new MailHelper();
            if (destinatarios.size() == 1) {
                mailHelper.send(destinatarios.get(0), null, null, titulo, corpo, null);
            } else {
                // Se há mais de um destinatário, envia para todos via cópia carbono.
                mailHelper.send(null, null, TextHelper.join(destinatarios, ","), titulo, corpo, null);
            }
        } catch (final MessagingException e) {
            throw new ViewHelperException("mensagem.erro.email.indisponivel", responsavel, e);

        }
    }

    /**
     * envia e-mail de alerta à consignatária de dias restantes para o bloqueio desta no sistema em questão
     * @param consignataria - consignatária alvo do email
     * @param diasParaBloqueio - dias restantes para bloqueio da consignatária no sistema
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailDiasBloqueioCsa(ConsignatariaTransferObject consignataria, int diasParaBloqueio, AcessoSistema responsavel) throws ViewHelperException {

        // Recupera o nome do consignante
        final String cseNome = getCseNome(responsavel);
        final String csaEmailExpiracao = consignataria.getCsaEmailExpiracao();
        final String emailCsa = !TextHelper.isNull(csaEmailExpiracao) ? csaEmailExpiracao : consignataria.getCsaEmail();

        if (TextHelper.isNull(emailCsa)) {
            LOG.warn("Erro ao enviar e-mail de alerta de dias para expiração de consignatária: e-mail da consignatária não cadastrado.");
            return;
        }

        final EnviarEmailExpiracaoParaConsignatariaCommand command = new EnviarEmailExpiracaoParaConsignatariaCommand();
        command.setCsaNome(consignataria.getCsaNome());
        command.setCseNome(cseNome);
        command.setEmail(emailCsa);
        command.setPrazoConsignatarias(diasParaBloqueio);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * envia e-mail de alerta à consignatária de dias restantes para o bloqueio desta no sistema em questão
     * @param consignataria - consignatária alvo do email
     * @param diasParaBloqueio - dias restantes para bloqueio da consignatária no sistema
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailDiasBloqueioCsaParaCseOrg(Map<String, List<ConsignatariaTransferObject>> prazoConsignatarias, AcessoSistema responsavel) throws ViewHelperException {

        // Recupera o nome do consignante
        final String cseNome = getCseNome(responsavel);
        String email = getCseEmail(responsavel);

        if (TextHelper.isNull(email)) {
            // Pegar todos os endereços cadastrados em ORG_EMAIL
            email = getAllOrgEmail(responsavel);
        }

        if (TextHelper.isNull(email)) {
            LOG.error("Erro ao enviar e-mail de alerta de dias para expiração de consignatária: e-mail do consignante ou órgãos não cadastrado.");
            return;
        }

        final EnviarEmailExpiracaoConsignatariaCommand command = new EnviarEmailExpiracaoConsignatariaCommand();
        command.setCseNome(cseNome);
        command.setEmail(email);
        command.setPrazoConsignatarias(prazoConsignatarias);
        command.setResponsavel(responsavel);
        command.execute();

    }

    /**
     * envia e-mail de alerta ao gestor de que há mensagens pendentes para uma comunicação
     * @param comunicacao - comunicação que possui mensagens pendentes
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailAlertaCmnMsgPendentes(TransferObject comunicacao, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final ConsignanteTransferObject cse = new ConsignanteDelegate().findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);
            final ConsignatariaTransferObject csa = new ConsignatariaDelegate().findConsignataria((String) comunicacao.getAttribute(Columns.CSA_CODIGO), responsavel);

            final ServidorDelegate serDelegate = new ServidorDelegate();
            final TransferObject serTO = serDelegate.buscaUsuarioServidor((String) comunicacao.getAttribute(Columns.CMN_USU_CODIGO), responsavel);

            final StringBuilder emailTexto = new StringBuilder();

            final String nomeSistema = JspHelper.getNomeSistema(responsavel);

            emailTexto.append(ApplicationResourcesHelper.getMessage("rotulo.email.a.comunicacao", responsavel, comunicacao.getAttribute(Columns.CMN_NUMERO).toString()) + "<br><br>\n");
            emailTexto.append("<P ALIGN=\"CENTER\">").append("\"").append((String) comunicacao.getAttribute(Columns.CMN_TEXTO)).append("\"").append("</P>\n");
            emailTexto.append("<br><br>\n");
            emailTexto.append(ApplicationResourcesHelper.getMessage("mensagem.email.enviada.por.servidor.destinada.consignataria", responsavel
                    ,DateHelper.toDateTimeString((Date) comunicacao.getAttribute(Columns.CMN_DATA))
                    ,serTO.getAttribute(Columns.SER_NOME).toString()
                    ,serTO.getAttribute(Columns.RSE_MATRICULA).toString()
                    ,csa.getCsaIdentificador()
                    ,csa.getCsaNome()));
            emailTexto.append("<br><br>\n");
            emailTexto.append(ApplicationResourcesHelper.getMessage("mensagem.email.confira.sistema.maiores.detalhes", responsavel, nomeSistema));

            final String emailGestor = cse.getCseEmail();

            if (TextHelper.isNull(emailGestor)) {
                throw new ViewHelperException ("mensagem.erro.email.alerta.mensagem.pendente.comunicacao", responsavel);
            }

            final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.alerta.mensagem.pendente.comunicacao", responsavel, nomeSistema);

            final MailHelper mailHelper = new MailHelper();
            try {
                mailHelper.send(emailGestor, null, null, titulo, emailTexto.toString(), null);
            } catch (final MessagingException e) {
                throw new ViewHelperException ("mensagem.erro.email.alerta.mensagem.pendente.comunicacao", responsavel, e);
            }
        } catch (ConsignanteControllerException | ConsignatariaControllerException | ServidorControllerException e) {
            throw new ViewHelperException ("mensagem.erro.email.alerta.numero.maximo.mensagens.comunicacao", responsavel, e);
        }
    }

    /**
     * Envia e-mail com o arquivo do relatório em anexo para os destinatários informados.
     *
     * @param relatorio Caminho completo do arquivo do relatório contendo inclusive o nome do arquivo
     * @param tituloRelatorio Título do relatório
     * @param destinatarios E-mails destinatários.
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailRelatorio(String relatorio, String tituloRelatorio, String[] destinatarios, AcessoSistema responsavel) throws ViewHelperException {
        try {
            // Se não houver destinatários, não envia e-mail
            if ((destinatarios == null) || (destinatarios.length == 0)) {
                return;
            }

            // Recupera o nome do consignante
            final String cseNome = getCseNome(responsavel);

            // Define o titulo do e-mail
            final String titulo = gerarTituloEmail(cseNome, tituloRelatorio, responsavel);

            final String corpo = ApplicationResourcesHelper.getMessage("mensagem.email.relatorio.anexo", responsavel, tituloRelatorio);

            final List<String> anexos = new ArrayList<>();
            final File arquivoAnexo = new File(relatorio);
            if ((arquivoAnexo != null) && arquivoAnexo.exists()) {
                anexos.add(arquivoAnexo.getAbsolutePath());

                // Envia o e-mail
                final MailHelper mailHelper = new MailHelper();
                if (destinatarios.length == 1) {
                    mailHelper.send(destinatarios[0], null, null, titulo, corpo, anexos);
                } else {
                    // Se houver mais de um destinatário, envia para todos via cópia carbono.
                    mailHelper.send(null, null, TextHelper.join(destinatarios, ","), titulo, corpo, anexos);
                }
            }

        } catch (final MessagingException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Envia e-mail informando a geração do Relatório de Auditoria.
     *
     * @param destinatarios Endereços de e-mail dos destinatários.
     * @param responsavel Responsável pela operação.
     * @throws ViewHelperException
     * @throws MensagemControllerException
     */
    public static final void enviarEmailRelatorioAuditoria(String relatorio, String codigoEntidade, String tipoEntidade, List<String> destinatarios, AcessoSistema responsavel) throws ViewHelperException, MensagemControllerException {
        if ((destinatarios == null) || destinatarios.isEmpty() || TextHelper.isNull(destinatarios.get(0))) {
            throw new MensagemControllerException("mensagem.erro.email.nenhum.destinatario.cadastrado.valido", responsavel);
        }

        // Recupera o nome do consignante
        final String cseNome = getCseNome(responsavel);
        final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.auditoria", responsavel, cseNome);

        // Recupera a entidade para qual foi gerado o relatório
        String entidade = "";
        if (!TextHelper.isNull(tipoEntidade) && !TextHelper.isNull(codigoEntidade)) {
            try {
                if (AcessoSistema.ENTIDADE_CSE.equals(tipoEntidade)) {
                    final ConsignanteTransferObject cse = new ConsignanteDelegate().findConsignante(codigoEntidade, responsavel);
                    entidade = cse.getCseIdentificador() + " - " + cse.getCseNome();
                } else if (AcessoSistema.ENTIDADE_EST.equals(tipoEntidade)) {
                    final EstabelecimentoTransferObject est = new ConsignanteDelegate().findEstabelecimento(codigoEntidade, responsavel);
                    entidade =  est.getEstIdentificador() + " - " + (!TextHelper.isNull(est.getEstNomeAbrev()) ? est.getEstNomeAbrev() : est.getEstNome());
                } else if (AcessoSistema.ENTIDADE_ORG.equals(tipoEntidade)) {
                    final OrgaoTransferObject org = new ConsignanteDelegate().findOrgao(codigoEntidade, responsavel);
                    entidade = org.getOrgIdentificador() + " - " + (!TextHelper.isNull(org.getOrgNomeAbrev()) ? org.getOrgNomeAbrev() : org.getOrgNome());
                } else if (AcessoSistema.ENTIDADE_CSA.equals(tipoEntidade)) {
                    final ConsignatariaTransferObject csa = new ConsignatariaDelegate().findConsignataria(codigoEntidade, responsavel);
                    entidade =  csa.getCsaIdentificador() + " - " + (!TextHelper.isNull(csa.getCsaNomeAbreviado()) ? csa.getCsaNomeAbreviado() : csa.getCsaNome());
                } else if (AcessoSistema.ENTIDADE_COR.equals(tipoEntidade)) {
                    final CorrespondenteTransferObject cor = new ConsignatariaDelegate().findCorrespondente(codigoEntidade, responsavel);
                    entidade = cor.getCorIdentificador() + " - " + cor.getCorNome();
                }
            } catch (ConsignanteControllerException | ConsignatariaControllerException e) {
                LOG.error("Não foi possível localizar a entidade. ", e);
            }
        }

        String corpo = "";
        if (!TextHelper.isNull(entidade)) {
            corpo += "<b>" + entidade + "</b><br/>\n<br/>\n";
        }

        corpo += ApplicationResourcesHelper.getMessage("mensagem.email.relatorio.auditoria", responsavel, relatorio.substring(relatorio.lastIndexOf(File.separatorChar) + 1, relatorio.length()));

        final List<String> anexos = new ArrayList<>();
        anexos.add(relatorio);

        // Envia o email
        try {
            final MailHelper mailHelper = new MailHelper();
            if (destinatarios.size() == 1) {
                mailHelper.send(destinatarios.get(0), null, null, titulo, corpo, anexos);
            } else {
                // Se há mais de um destinatário, envia para todos via cópia carbono.
                mailHelper.send(null, null, TextHelper.join(destinatarios, ","), titulo, corpo, anexos);
            }
        } catch (final MessagingException e) {
            throw new MensagemControllerException ("mensagem.erro.email.indisponivel", responsavel, e);
        }
    }

    /**
     * Envia e-mail sobre o bloqueio do sistema, com a mensagem informada por parâmetro
     * @param motivo      : mensagem de motivo de bloqueio
     * @param responsavel : responsável pelo bloqueio
     * @throws ViewHelperException
     */
    public static void enviarEmailBloqueioSistema(String motivo, AcessoSistema responsavel) throws ViewHelperException  {
        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String cseNome = getCseNome(responsavel);
        final String usuNome = responsavel.getUsuNome();
        final String ipAcesso = responsavel.getIpUsuario();
        final String data = DateHelper.toDateTimeString(DateHelper.getSystemDatetime());

        final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.bloqueio.sistema", responsavel, nomeSistema, cseNome);

        final StringBuilder texto = new StringBuilder();
        texto.append(ApplicationResourcesHelper.getMessage("mensagem.email.sistema.bloqueado", responsavel, cseNome, usuNome, data, motivo, ipAcesso));

        // Envia o e-mail
        try {
            new MailHelper().send(DESTINATARIO_BLOQ_SISTEMA, null, null, titulo, texto.toString(), null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * envia e-mail relatorio com lista de relatórios de integração com códigos de verba inválidos por consignatária
     * @param emailTexto - listagem de relatórios inválidos por consignatária
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailValidacaoIntegracaoCsa(String textoArqInvalidos, String textoArqIgnorados, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(EMAIL_VALIDACAO_INTEGRACAO_CSA)) {
            throw new ViewHelperException("mensagem.informe.email.endereco.validacao.relatorio.integracao.consignataria", responsavel);
        }
        if (TextHelper.isNull(textoArqInvalidos) && TextHelper.isNull(textoArqIgnorados)) {
            // Nada a ser enviado por e-mail
            return;
        }

        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        final String cseNome = getCseNome(responsavel);
        final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.alerta.relatorio.integracao.consignataria", responsavel, nomeSistema);

        final StringBuilder corpoEmail = new StringBuilder();
        corpoEmail.append(nomeSistema).append(" - ").append(cseNome);
        corpoEmail.append("<br><br>");

        if (!TextHelper.isNull(textoArqInvalidos)) {
            corpoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignatarias.relatorios.integracao.codigo.verba.invalido", responsavel));
            corpoEmail.append(textoArqInvalidos.toString());
        }
        if (!TextHelper.isNull(textoArqInvalidos) && !TextHelper.isNull(textoArqIgnorados)) {
            corpoEmail.append("<br><br>");
        }
        if (!TextHelper.isNull(textoArqIgnorados)) {
            corpoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignatarias.relatorios.integracao.leiaute.customizado", responsavel));
            corpoEmail.append(textoArqIgnorados.toString());
        }
        corpoEmail.append("<br><br>");

        // Envia o e-mail
        try {
            LOG.debug(corpoEmail.toString());
            new MailHelper().send(EMAIL_VALIDACAO_INTEGRACAO_CSA, null, null, titulo, corpoEmail.toString(), null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * envia e-mail de informação ao gestor de que um arquivo de margem/retorno foi recebido
     * @param tipo
     * @param nomeArquivo
     * @param enviaEmailCSE
     * @param enviaEmailORG
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailRecebimentoArquivo(String tipo, String nomeArquivo, boolean enviaEmailCSE, boolean enviaEmailORG, String orgCodigo, String obs, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
            final List<String> destinatarios = new ArrayList<>();

            if (enviaEmailCSE) {
                final ConsignanteTransferObject cse = cseDelegate.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);
                if (!TextHelper.isNull(cse.getCseEmailFolha())) {
                    destinatarios.add(cse.getCseEmailFolha());
                }
            }

            if (enviaEmailORG) {
                if (responsavel.isOrg() || !TextHelper.isNull(orgCodigo)) {
                    final String codigo = !TextHelper.isNull(orgCodigo) ? orgCodigo : responsavel.getOrgCodigo();
                    final OrgaoTransferObject org = cseDelegate.findOrgao(codigo, responsavel);
                    if (!TextHelper.isNull(org.getOrgEmailFolha())) {
                        destinatarios.add(org.getOrgEmailFolha());
                    }
                } else {
                    // Se não é usuário de órgão, nem arquivo direcionado a um órgão, mas ainda assim deve
                    // enviar e-mail para órgão, então lista todos e envia o e-mail
                    final TransferObject criterio = new CustomTransferObject();
                    criterio.setAttribute(Columns.ORG_ATIVO, CodedValues.STS_ATIVO);
                    final List<TransferObject> orgaos = cseDelegate.lstOrgaos(criterio, responsavel);
                    for (final TransferObject org : orgaos) {
                        if (!TextHelper.isNull(org.getAttribute(Columns.ORG_EMAIL_FOLHA))) {
                            destinatarios.add(org.getAttribute(Columns.ORG_EMAIL_FOLHA).toString());
                        }
                    }
                }
            }

            // Se não possui e-mail cadastrado, não tenta enviar e-mail
            if (destinatarios.isEmpty()) {
                return;
            }

            String corpo = ApplicationResourcesHelper.getMessage("mensagem.email.notificacao.upload.arquivo.corpo", responsavel);

            if (corpo.contains("<CABECALHO>")) {
                final String mensagemCorpo = ApplicationResourcesHelper.getMessage("mensagem.email.recebimento.arquivo", responsavel, tipo);
                corpo = corpo.replace("<CABECALHO>", mensagemCorpo);
            }

            final String nomeSistema = JspHelper.getNomeSistema(responsavel);

            if(!TextHelper.isNull(obs)) {
                corpo += "<br/>\n";
                corpo += ApplicationResourcesHelper.getMessage("rotulo.email.observacao", responsavel, obs);
            }

            if (corpo.contains("<DETALHE_ARQUIVOS>")) {

                final StringBuilder emailTexto = new StringBuilder();

                if (!TextHelper.isNull(nomeArquivo)) {
                    emailTexto.append(nomeArquivo);
                }

                emailTexto.append("<br/>\n<br/>\n");
                emailTexto.append(ApplicationResourcesHelper.getMessage("rotulo.email.enviado.usuario", responsavel, responsavel.getUsuLogin()));

                emailTexto.append("<br/>\n<br/>\n");
                emailTexto.append(ApplicationResourcesHelper.getMessage("rotulo.email.enviado.data", responsavel, DateHelper.format(Calendar.getInstance().getTime(), LocaleHelper.getDateTimePattern())));

                emailTexto.append("<br/>\n<br/>\n");

                corpo = corpo.replace("<DETALHE_ARQUIVOS>", emailTexto.toString());

            }


            if (corpo.contains("<RODAPE>")) {
                final String rodape = ApplicationResourcesHelper.getMessage("mensagem.email.recebimento.arquivo.rodape", responsavel);
                corpo = corpo.replace("<RODAPE>", rodape);
            }


            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.notificacao.upload.arquivo.titulo", responsavel);

            if (titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", nomeSistema);
            }

            if (titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel));
            }

            if (titulo.contains("<TITULO>")) {
                titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("rotulo.email.recebimento.arquivo", responsavel, nomeSistema, tipo.toString()));
            }

            final MailHelper mailHelper = new MailHelper();
            try {
                mailHelper.send(TextHelper.join(destinatarios, ",").replace(';', ','), null, null, titulo, corpo, null);
            } catch (final MessagingException e) {
                throw new ViewHelperException("mensagem.erro.email.recebimento.arquivo", responsavel, e, tipo.toString());
            }
        } catch (final Exception e) {
            throw new ViewHelperException("mensagem.erro.email.recebimento.arquivo", responsavel, e, tipo.toString());
        }
    }

    /**
     * Envia e-mail para consignatárias e correspondente informando upload de arquivo.
     * @param tipo
     * @param nomeArquivo
     * @param enviaEmailCSA
     * @param enviaEmailCOR
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailUploadArquivoCsa(String tipo, String nomeArquivo, boolean enviaEmailCSA, boolean enviaEmailCOR, String obs, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailUploadArquivoCsaCommand command = new EnviarEmailUploadArquivoCsaCommand();
        command.setTipo(tipo);
        command.setNomeArquivo(nomeArquivo);
        command.setEnviaEmailCSA(enviaEmailCSA);
        command.setEnviaEmailCOR(enviaEmailCOR);
        command.setResponsavel(responsavel);
        command.setObservacao(obs);
        command.execute();
    }

    /**
     * Envia e-mail à consignatária identificada pelo parâmetro "csaCodigo" informando que a consignação,
     * representada pelo parâmetro "adeCodigo" está pendente de aprovação/deferimento pela consignatária.
     * @param csaCodigo
     * @param adeCodigo
     * @param responsavel
     * @throws ZetraException
     * @throws MessagingException
     */
    public static final void enviarEmailCsaPendenciaDeferimento(String csaCodigo, String adeCodigo, AcessoSistema responsavel) throws ViewHelperException {
        try {
            // Busca as informações do contrato que está pendente de deferimento
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            if (ade == null) {
                return;
            }

            // Recupera o endereço de e-mail da consignatária que deve realizar o deferimento
            final ConsignatariaTransferObject consignataria = new ConsignatariaDelegate().findConsignataria(csaCodigo, responsavel);
            final String emailDestino = consignataria.getCsaEmail();

            // Se não tem e-mail não faz nada
            if (TextHelper.isNull(emailDestino)) {
                return;
            }

            // Dados necessários para envio do e-mail
            final String cseNome = getCseNome(responsavel);
            final String rseMatricula = ade.getAttribute(Columns.RSE_MATRICULA) != null ? ade.getAttribute(Columns.RSE_MATRICULA).toString() : "";
            final String serNome =  ade.getAttribute(Columns.SER_NOME) != null ? ade.getAttribute(Columns.SER_NOME).toString() : "";
            final String serCpf = ade.getAttribute(Columns.SER_CPF) != null ? ade.getAttribute(Columns.SER_CPF).toString() : "";
            final String adeVlr = ade.getAttribute(Columns.ADE_VLR) != null ? NumberHelper.format(((BigDecimal) ade.getAttribute(Columns.ADE_VLR)).doubleValue(), NumberHelper.getLang(), true) : "";
            final String adeData = ade.getAttribute(Columns.ADE_DATA) != null ? DateHelper.toDateTimeString((Date) ade.getAttribute(Columns.ADE_DATA)) : "";

            // Define o titulo do E-mail
            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.email.operacao.consignacao.pendente.aprovacao", responsavel), responsavel);

            // Texto Comum para todas as mensagems
            final StringBuilder textoGeral = new StringBuilder();
            textoGeral.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignacao.pendente.aprovacao", responsavel));
            textoGeral.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.servidor", responsavel, rseMatricula, serNome));
            textoGeral.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.cpf", responsavel, serCpf));
            textoGeral.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.data.inclusao", responsavel, adeData));
            textoGeral.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.prestacao", responsavel, adeVlr));
            textoGeral.append("<br/>\n<br/>\n");

            // Envia os emails.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(emailDestino, null, null, titulo, textoGeral.toString(), null, null);
        } catch (AutorizacaoControllerException | ConsignatariaControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final MessagingException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.erro.email.alerta.entidade.responsavel.deferimento.contrato", responsavel, ex);
        }
    }

    /**
     * Envia e-mail ao endereço padrão de consignante do sistema para alertar de inclusão de novo contrato.
     * @param adeNumero número do novo contrato incluído.
     * @param operacaoAde operação que disparou o email
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailCseInclusaoAde(String adeCodigo, String operacaoAde, AcessoSistema responsavel) throws ViewHelperException {
        final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
        try {
            final ConsignanteTransferObject cseTO = cseDelegate.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);

            // Define o titulo do E-mail
            final String titulo = gerarTituloEmail(cseTO.getCseNome(), ApplicationResourcesHelper.getMessage("mensagem.email.cse.titulo.consignacao.criada", responsavel), responsavel);

            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject adeTO = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            final StringBuilder corpoEmail = new StringBuilder(ApplicationResourcesHelper.getMessage("mensagem.email.cse.consignacao.cabecalho", responsavel,
                    responsavel.getUsuLogin(), //0
                    adeTO.getAttribute(Columns.ADE_NUMERO).toString(), //1
                    operacaoAde, //2
                    DateHelper.toDateTimeString(DateHelper.getSystemDatetime()) //3
                    ));
            corpoEmail.append(gerarTextoDetalheContratoParaEmail(adeTO, cseTO.getCseNome(), responsavel));

            // se o órgão do servidor possuir e-mail, este prevalece sobre o do gestor.
            final String orgEmail = (String) adeTO.getAttribute(Columns.ORG_EMAIL_VALIDAR_SERVIDOR);

            final String cseMail = cseTO.getCseEmailValidarServidor();

            if (TextHelper.isNull(cseMail) && TextHelper.isNull(orgEmail)) {
                throw new ViewHelperException("mensagem.email.validar.servidor.cse.nao.cadastrado", responsavel);
            }

            // Envia os emails.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(!TextHelper.isNull(orgEmail) ? orgEmail : cseMail, null, null, titulo, corpoEmail.toString(), null, null);
        } catch (final MessagingException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.email.cse.falha.envio.email", responsavel, ex);
        } catch (ConsignanteControllerException | AutorizacaoControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Envia e-mail ao endereço padrão de consignante do sistema para alertar de liquidação de contrato.
     * @param adeNumero número do contrato liquidado.
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailCseLiquidacaoAde(String adeCodigo, AcessoSistema responsavel) throws ViewHelperException {
        final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
        final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
        try {
            if (ParamSist.getBoolParamSist(CodedValues.TPC_ENVIA_EMAIL_CSE_LIQUIDAR_CONTRATO, responsavel)){
                final ConsignanteTransferObject cseTO = cseDelegate.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);

                // Busca as informações do contrato
                final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);

                final String titulo = gerarTituloEmail(cseTO.getCseNome(), ApplicationResourcesHelper.getMessage("mensagem.email.cse.titulo.consignacao.liquidada", responsavel), responsavel);
                final StringBuilder corpoEmail = new StringBuilder(ApplicationResourcesHelper.getMessage("mensagem.email.cse.consignacao.cabecalho", responsavel,
                        responsavel.getUsuLogin(), //0
                        ade.getAttribute(Columns.ADE_NUMERO).toString(), //1
                        OperacaoEConsigEnum.LIQUIDAR_CONSIGNACAO.getOperacao(), //2
                        DateHelper.toDateTimeString(DateHelper.getSystemDatetime()) //3
                        ));
                corpoEmail.append(gerarTextoDetalheContratoParaEmail(ade, cseTO.getCseNome(), responsavel));

                // se o órgão do servidor possuir e-mail, este prevalece sobre o do gestor.
                final String orgEmail = (String) ade.getAttribute(Columns.ORG_EMAIL);

                final String cseMail = cseTO.getCseEmail();

                if (TextHelper.isNull(cseMail) && TextHelper.isNull(orgEmail)) {
                    throw new ViewHelperException("mensagem.email.cse.nao.cadastrado", responsavel);
                }

                // Envia o email
                final MailHelper mailHelper = new MailHelper();
                mailHelper.send(!TextHelper.isNull(orgEmail) ? orgEmail : cseMail, null, null, titulo, corpoEmail.toString(), null, null);
            }
        } catch (final MessagingException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.email.cse.falha.envio.email", responsavel, ex);
        } catch (ConsignanteControllerException | AutorizacaoControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /**
     * Envia por e-mail a informação de saldo devedor para o gestor/órgão quando a solicitação
     * for cadastrada para exclusão de servidor
     * @param adeCodigo
     * @param responsavel
     * @return
     */
    public static final void enviarEmailDataCorteAlterada(String diaAtual, Date periodoAtual, AcessoSistema responsavel) {
        try {
            final List<Consignataria> consignatarias = new ConsignatariaDelegate().findConsignatariaComEmailCadastrado(responsavel);
            if ((consignatarias != null) && !consignatarias.isEmpty()) {
                // Recupera o nome do consignante
                final String cseNome = getCseNome(responsavel);

                // Define o titulo do E-mail
                final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.data.corte.alterada", responsavel), responsavel);

                final DateFormat df = new SimpleDateFormat(LocaleHelper.getDatePattern());

                // Texto com os dados do contrato
                final String texto = ApplicationResourcesHelper.getMessage("rotulo.consignante.singular.arg0", responsavel, cseNome) + "<br>"
                             + ApplicationResourcesHelper.getMessage("mensagem.email.data.corte.alterada.corpo", responsavel, df.format(periodoAtual), diaAtual)
                        ;

                for (final Consignataria consignataria : consignatarias) {
                    if (!TextHelper.isNull(consignataria.getCsaEmail())) {
                        final MailHelper mailHelper = new MailHelper();
                        mailHelper.send(consignataria.getCsaEmail(), null, null, titulo, texto, null);
                    }
                }
            }
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia email com OTP para o servidor.
     * @param destinatario
     * @param otp
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailOTPServidor(String nome, String destinatario, String otp, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(destinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        try {
            final String nomeSistema = JspHelper.getNomeSistema(responsavel);
            final String cseNome = getCseNome(responsavel);

            final String tituloEmail = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.otp", responsavel), responsavel);

            final String primeiroNome = nome.split("\\s+")[0];

            final EnviarEmailOTPServidorCommand command = new EnviarEmailOTPServidorCommand();

            command.setNomeSistema(nomeSistema);
            command.setCseNome(cseNome);
            command.setTituloEmail(tituloEmail);
            command.setResponsavel(responsavel);
            command.setNome(nome);
            command.setPrimeiroNome(primeiroNome);
            command.setEmail(destinatario);
            command.setOtp(otp);

            command.execute();

        } catch (final ViewHelperException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia email com OTP para o usuário.
     * @param destinatario
     * @param otp
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailOTP(String nome, String destinatario, String otp, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(destinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        try {
            final String nomeSistema = JspHelper.getNomeSistema(responsavel);
            final String cseNome = getCseNome(responsavel);

            final String tituloEmail = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.otp", responsavel), responsavel);

            final String primeiroNome = nome.split("\\s+")[0];


            final EnviarEmailOTPUsuarioCommand command = new EnviarEmailOTPUsuarioCommand();

            command.setNomeSistema(nomeSistema);
            command.setCseNome(cseNome);
            command.setTituloEmail(tituloEmail);
            command.setResponsavel(responsavel);
            command.setNome(nome);
            command.setPrimeiroNome(primeiroNome);
            command.setEmail(destinatario);
            command.setOtp(otp);

            command.execute();

        } catch (final ViewHelperException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * envia e-mail ao servidor alertando-o de que a documentação anexa da solicitação foi aprovada
     * @param destinatario
     * @param adeCodigo
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailDocAprovadaServidor(String destinatario, String adeCodigo, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(destinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        try {
            final String cseNome = getCseNome(responsavel);
            final AutorizacaoDelegate autDelegate = new AutorizacaoDelegate();
            final TransferObject ade = autDelegate.buscaAutorizacao(adeCodigo, responsavel);

            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.documentacao.aprovada.titulo", responsavel), responsavel);

            final StringBuilder corpo = new StringBuilder();
            corpo.append("<br/>\n" + ApplicationResourcesHelper.getMessage("mensagem.email.documentacao.aprovada", responsavel, ade.getAttribute(Columns.ADE_NUMERO).toString()));
            corpo.append("<br/>\n<br/>\n");

            final String texto = titulo + "<br/>\n<br/>\n" + corpo.toString();

            //Envia para a consignatária o mesmo email
            if (!TextHelper.isNull(ade.getAttribute(Columns.CSA_EMAIL))) {
                destinatario += ","+ade.getAttribute(Columns.CSA_EMAIL).toString();
            }

            // Envia o e-mail.
            new MailHelper().send(destinatario, null, null, titulo, texto, null);
        } catch (AutorizacaoControllerException | MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia email para consignatária sobre alteração no servidor.
     *
     * @param dadosServidor
     * @param cpf
     * @param matricula
     * @param novoStatus
     * @param obsAlteracao
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailCsasAlteracaoSer(TransferObject dadosServidor, String cpf, String matricula, String novoStatus, String obsAlteracao, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailCsasAlteracaoSerCommand command = new EnviarEmailCsasAlteracaoSerCommand();
        command.setDadosServidor(dadosServidor);
        command.setCpf(cpf);
        command.setMatricula(matricula);
        command.setNovoStatus(novoStatus);
        command.setObsAlteracao(obsAlteracao);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * Envia e-mail para  as consignatárias cuja proposta foi rejeitada.
     * @param adeCodigo
     * @param plsVencedora
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailCsaPropostaLeilaoRejeitada(String adeCodigo, PropostaLeilaoSolicitacao plsVencedora, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final LeilaoSolicitacaoController leilaoSolicitacaoController = ApplicationContextProvider.getApplicationContext().getBean(LeilaoSolicitacaoController.class);
            final List<TransferObject> lstRejeitadas = leilaoSolicitacaoController.lstPropostaLeilaoSolicitacao(adeCodigo, null, StatusPropostaEnum.REJEITADA.getCodigo(), false, responsavel);

            final List<String> csaEmails = new ArrayList<>();
            final ConsignatariaDelegate csaDelegate = new ConsignatariaDelegate();
            for (final TransferObject rejeitada: lstRejeitadas) {
                final String csaCodigo = (String) rejeitada.getAttribute(Columns.CSA_CODIGO);

                final ConsignatariaTransferObject csaTO = csaDelegate.findConsignataria(csaCodigo, responsavel);
                if (!TextHelper.isNull(csaTO.getCsaEmail())) {
                    csaEmails.add(csaTO.getCsaEmail());
                }
            }

            TransferObject adeTO = null;

            if (!csaEmails.isEmpty()) {
                final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
                adeTO = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            } else {
                return;
            }

            final String cseNome = getCseNome(responsavel);
            final Long adeNumero = (Long) adeTO.getAttribute(Columns.ADE_NUMERO);
            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.titulo.leilao.encerrado", responsavel, adeNumero.toString()), responsavel);

            final boolean simulacaoPorTaxaJuros = ParamSist.paramEquals(CodedValues.TPC_SIMULACAO_POR_TAXA_JUROS, CodedValues.TPC_SIM, responsavel);
            final boolean temCET = ParamSist.paramEquals(CodedValues.TPC_TEM_CET, CodedValues.TPC_SIM, responsavel);

            final String adeTipoTaxa = (String) adeTO.getAttribute(Columns.ADE_TIPO_TAXA);

            final List<String> parametros = new ArrayList<>();
            parametros.add(CodedValues.TPS_ADD_VALOR_IOF_VAL_TAXA_JUROS);
            parametros.add(CodedValues.TPS_ADD_VALOR_TAC_VAL_TAXA_JUROS);
            parametros.add(CodedValues.TPS_VLR_LIQ_TAXA_JUROS);

            final ParametroDelegate parDelegate = new ParametroDelegate();
            final ParamSvcTO paramSvcCse = parDelegate.selectParamSvcCse((String) adeTO.getAttribute(Columns.SVC_CODIGO), parametros, responsavel);

            // Define rótulo para o campo de Taxa de Juros/CET/Coeficiente
            String rotuloTaxa = "";
            if (adeTipoTaxa != null) {
                if (CodedValues.TIPO_TAXA_CET.equals(adeTipoTaxa)) {
                    //CET Real: Cálculo com valor liberado sem adicionar IOF e TAC
                    rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.consignacao.cet", responsavel);
                } else if (CodedValues.TIPO_TAXA_JUROS.equals(adeTipoTaxa)) {
                    // Taxa de Juros Real: Cálculo com valor liberado somando IOF e TAC
                    rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.consignacao.taxa.juros", responsavel);
                }
            } else if (temCET) {
                rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.consignacao.cet", responsavel);
            } else if (paramSvcCse.isTpsVlrLiqTaxaJuros() || simulacaoPorTaxaJuros) {
                rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.consignacao.taxa.juros", responsavel);
            }

            final StringBuilder corpoEmail = new StringBuilder(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.cabecalho.leilao.encerrado", responsavel, adeTO.getAttribute(Columns.ADE_NUMERO).toString(), (String) adeTO.getAttribute(Columns.SVC_DESCRICAO))).append("<BR>");

            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("mensagem.email.servidor.proposta.aprovada.leilao", responsavel));
            corpoEmail.append("</b> : <BR><BR>");
            corpoEmail.append("<b>").append(rotuloTaxa).append("</b> : ").append(plsVencedora.getPlsTaxaJuros().setScale(2, java.math.RoundingMode.HALF_UP));
            corpoEmail.append("<BR>");
            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.valor.liberado", responsavel)).append("</b> : ");
            corpoEmail.append(LocaleHelper.getCurrencyFormat().format(plsVencedora.getPlsValorLiberado().setScale(2, java.math.RoundingMode.HALF_UP))).append("<BR>");
            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.valor.parcela", responsavel)).append("</b> : ");
            corpoEmail.append(LocaleHelper.getCurrencyFormat().format(plsVencedora.getPlsValorParcela().setScale(2, java.math.RoundingMode.HALF_UP)));
            corpoEmail.append("<BR>");
            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.prazo.singular", responsavel)).append("</b> : ");
            corpoEmail.append(plsVencedora.getPlsPrazo()).append(" ").append(CodedValues.PERIODICIDADE_FOLHA_MENSAL.equals(adeTO.getAttribute(Columns.ADE_PERIODICIDADE)) ? ApplicationResourcesHelper.getMessage("rotulo.consignacao.mes.plural", responsavel) : ApplicationResourcesHelper.getMessage("rotulo.consignacao.quinzena.plural", responsavel)).append("<BR>");

            if (ParamSist.getBoolParamSist(CodedValues.TPC_ENVIAR_DADOS_SERVIDOR_CSA_REJEITADA_PROPOSTA_LEILAO, responsavel)) {
                final String serNome = (String) adeTO.getAttribute(Columns.SER_NOME);
                final String serTel = (String) adeTO.getAttribute(Columns.SER_TEL);
                final String serCelular = (String) adeTO.getAttribute(Columns.SER_CELULAR);

                corpoEmail.append("<BR>");
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.leilao.proposta.rejeitada.servidor", responsavel)).append("</b> : ");
                corpoEmail.append(serNome).append("<BR>");

                if (!TextHelper.isNull(serTel) || !TextHelper.isNull(serCelular)) {
                    corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.leilao.proposta.rejeitada.telefone", responsavel)).append("</b> : ");

                    if (!TextHelper.isNull(serTel) && !TextHelper.isNull(serCelular)) {
                        corpoEmail.append(TextHelper.formatarTelefone(serTel)).append(" / ").append(TextHelper.formatarTelefone(serCelular)).append("<BR>");
                    } else {
                        corpoEmail.append(!TextHelper.isNull(serTel) ? TextHelper.formatarTelefone(serTel) : TextHelper.formatarTelefone(serCelular)).append("<BR>");
                    }
                }
            }

            // Envia o e-mail.
            for (final String email : csaEmails) {
                new MailHelper().send(email, null, null, titulo, corpoEmail.toString(), null);
            }
        } catch (LeilaoSolicitacaoControllerException | ConsignatariaControllerException | AutorizacaoControllerException | ParametroControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException(ex.getMessageKey(), responsavel, ex);
        } catch (final MessagingException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /********************************************* MÉTODOS AUXILIARES PARA ENVIO DE E-MAIL *****************************************************/

    /**
     * Recupera as configurações de e-mail de uma consignatária para eventos relacionados ao processo de compra de contrato.
     * @param tipoEvento
     * @param csaCodigo
     * @param svcCodigo
     * @param responsavel
     * @return
     * @throws Exception
     */
    private static ConfirguracoesEmailCsaCompraContrato recuperarEnderecosEmailCompraContrato(int tipoEvento, String csaCodigo, String svcCodigo, AcessoSistema responsavel) throws Exception {
        // Em uma só consulta traz a configuração de e-mail para o evento de compra
        // e a configuração dos destinatários da mensagem.
        final List<String> tpsCodigos = new ArrayList<>();
        tpsCodigos.add(CodedValues.TPS_DESTINATARIOS_EMAILS_CONTROLE_COMPRA);

        String parametroEvento = null;
        switch (tipoEvento) {
            case TIPO_COMPRA_CONTRATO:
            case TIPO_SOL_RECALCULO_SALDO_DEVEDOR:
                parametroEvento = CodedValues.TPS_EMAIL_INF_CONTRATOS_COMPRADOS;
                break;
            case TIPO_CADASTRO_SALDO_DEVEDOR:
            case TIPO_REJ_PGT_SALDO_DEVEDOR:
                parametroEvento = CodedValues.TPS_EMAIL_INF_SALDO_DEVEDOR;
                break;
            case TIPO_APROVACAO_SALDO_DEVEDOR:
            case TIPO_REJEICAO_SALDO_DEVEDOR:
                parametroEvento = CodedValues.TPS_EMAIL_INF_APROVACAO_SALDO_DEVEDOR;
                break;
            case TIPO_INF_PGT_SALDO_DEVEDOR:
                parametroEvento = CodedValues.TPS_EMAIL_INF_PGT_SALDO_DEVEDOR;
                break;
            case TIPO_LIQUIDACAO_COMPRA_CONTRATO:
                parametroEvento = CodedValues.TPS_EMAIL_INF_LIQ_CONTRATO_COMPRADO;
                break;
            default:
                break;
        }
        tpsCodigos.add(parametroEvento);

        final ConfirguracoesEmailCsaCompraContrato enderecos = new ConfirguracoesEmailCsaCompraContrato();

        // Recupera o endereço de e-mail do cadastro da consignatária.
        final ConsignatariaTransferObject consignataria = new ConsignatariaDelegate().findConsignataria(csaCodigo, responsavel);
        enderecos.emailCsaPrincipal = consignataria.getCsaEmail();

        // Busca os parâmetros de serviço da consignatária
        final List<TransferObject> parametros = new ParametroDelegate().selectParamSvcCsa(svcCodigo, csaCodigo, tpsCodigos, false, responsavel);
        if ((parametros != null) && (parametros.size() > 0)) {
            String codigoParametro, valorParametro;
            for (final TransferObject parametro : parametros) {
                codigoParametro = (parametro != null) && !TextHelper.isNull(parametro.getAttribute(Columns.TPS_CODIGO)) ? parametro.getAttribute(Columns.TPS_CODIGO).toString() : null;
                valorParametro = (parametro != null) && !TextHelper.isNull(parametro.getAttribute(Columns.PSC_VLR)) ? parametro.getAttribute(Columns.PSC_VLR).toString() : null;

                if (CodedValues.TPS_DESTINATARIOS_EMAILS_CONTROLE_COMPRA.equals(codigoParametro)) {
                    enderecos.destinatariosEmail = valorParametro;
                } else if ((codigoParametro != null) && (parametroEvento != null) && codigoParametro.equals(parametroEvento)) {
                    enderecos.emailCsaEvento = valorParametro;
                }
            }
        }

        return enderecos;
    }

    /**
     * Monta a lista de endereços de destinatários.
     * @param destinatariosEmail Valor do parâmetro que informa quem deve receber e-mails (CSA, COR ou ambos)
     * @param emailCsa
     * @param emailCorrespondente
     * @return
     */
    private static List<String> montarListaEnderecosDestinatarios(String destinatariosEmail, String emailCsa, String emailCorrespondente) {
        final List<String> listaEnderecos = new ArrayList<>();

        if (TextHelper.isNull(destinatariosEmail) || CodedValues.RECEBE_EMAIL_APENAS_CONSIGNATARIA.equals(destinatariosEmail)) {
            if (!TextHelper.isNull(emailCsa)) {
                listaEnderecos.add(emailCsa);
            }
        } else if (CodedValues.RECEBE_EMAIL_APENAS_CORRESPONDENTE.equals(destinatariosEmail)) {
            if (!TextHelper.isNull(emailCorrespondente)) {
                listaEnderecos.add(emailCorrespondente);
            } else // Se o correspondente não possui e-mail, envia para a consignatária.
            if (!TextHelper.isNull(emailCsa)) {
                listaEnderecos.add(emailCsa);
            }
        } else if (CodedValues.RECEBE_EMAIL_CSA_E_COR.equals(destinatariosEmail)) {
            if (!TextHelper.isNull(emailCorrespondente)) {
                listaEnderecos.add(emailCorrespondente);
            }
            if (!TextHelper.isNull(emailCsa)) {
                listaEnderecos.add(emailCsa);
            }
        }

        return listaEnderecos;
    }

    /**
     * Classe privada que reúne configurações de e-mail relacionadas ao
     * processo de compra de contrato para uma consignatária.
     */
    private static class ConfirguracoesEmailCsaCompraContrato {
        private String destinatariosEmail = null;
        private String emailCsaPrincipal = null;
        private String emailCsaEvento = null;
    }

    /**
     * Obtém o nome do consignante para envio de e-mail
     * @param responsavel
     * @return
     * @throws ViewHelperException
     */
    private static final String getCseNome(AcessoSistema responsavel) throws ViewHelperException {
        try {
            final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
            final ConsignanteTransferObject cse = cseDelegate.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);
            return cse.getCseNome();
        } catch (final ConsignanteControllerException e) {
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, e);
        }
    }

    /**
     * Obtém o email do consignante
     * @param responsavel
     * @return
     * @throws ViewHelperException
     */
    private static final String getCseEmail(AcessoSistema responsavel) throws ViewHelperException {
        try {
            final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
            final ConsignanteTransferObject cse = cseDelegate.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);
            return cse.getCseEmail();
        } catch (final ConsignanteControllerException e) {
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, e);
        }
    }

    /**
     * Obtém o email do consignante
     * @param responsavel
     * @return
     * @throws ViewHelperException
     */
    private static final String getAllOrgEmail(AcessoSistema responsavel) throws ViewHelperException {
        try {
            final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
            final List<TransferObject> lstOrgaos = cseDelegate.lstOrgaos(null, responsavel);

            final StringBuilder builder = new StringBuilder();

            for (final Iterator<TransferObject> iterator = lstOrgaos.iterator(); iterator.hasNext();) {
                final TransferObject orgao = iterator.next();

                final String email = (String)orgao.getAttribute(Columns.ORG_EMAIL);

                if (!TextHelper.isNull(email)) {
                    builder.append(email);
                    if (iterator.hasNext()) {
                        builder.append(",");
                    }
                }

            }

            return builder.toString();

        } catch (final ConsignanteControllerException e) {
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, e);
        }
    }

    /**
     * Método auxuliar para geração do texto do e-mail com o detalhe de um
     * contrato. Recebe um TransferObject com os dados do contrato.
     * @param ade
     * @param cseNome
     * @param responsavel
     * @return
     */
    private static String gerarTextoDetalheContratoParaEmail(TransferObject ade1, String cseNome, AcessoSistema responsavel) {

        final AutorizacaoDelegate del = new AutorizacaoDelegate();
        TransferObject ade;
        // Como não vinham dados suficientes em nenhuma das situações que este método é chamado, foi escolhido realizar uma
        // busca pelos dados do contrato.
        try {
            ade = del.buscaAutorizacao((String) ade1.getAttribute(Columns.ADE_CODIGO), responsavel);
        } catch (final AutorizacaoControllerException e) {
            // Usa os dados informados (Provavelmente nunca entrará aqui)
            ade = ade1;
        }

        final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
        final String adeIdentificador = ade.getAttribute(Columns.ADE_IDENTIFICADOR) != null ? ade.getAttribute(Columns.ADE_IDENTIFICADOR).toString() : "";
        final String adePrazo = ade.getAttribute(Columns.ADE_PRAZO) != null ? ade.getAttribute(Columns.ADE_PRAZO).toString() : ApplicationResourcesHelper.getMessage("rotulo.indeterminado", responsavel);
        final String adePrdPagas = ade.getAttribute(Columns.ADE_PRD_PAGAS) != null ? ade.getAttribute(Columns.ADE_PRD_PAGAS).toString() : "0";
        final String adeVlr = ade.getAttribute(Columns.ADE_VLR) != null ? NumberHelper.format(((BigDecimal) ade.getAttribute(Columns.ADE_VLR)).doubleValue(), NumberHelper.getLang(), true) : "";
        final String adeData = ade.getAttribute(Columns.ADE_DATA) != null ? DateHelper.toDateTimeString((Date) ade.getAttribute(Columns.ADE_DATA)) : "";
        final String sadDescricao = ade.getAttribute(Columns.SAD_DESCRICAO) != null ? ade.getAttribute(Columns.SAD_DESCRICAO).toString() : "";
        final String rseMatricula = ade.getAttribute(Columns.RSE_MATRICULA) != null ? ade.getAttribute(Columns.RSE_MATRICULA).toString() : "";
        final String serNome =  ade.getAttribute(Columns.SER_NOME) != null ? ade.getAttribute(Columns.SER_NOME).toString() : "";
        final String serCpf = ade.getAttribute(Columns.SER_CPF) != null ? ade.getAttribute(Columns.SER_CPF).toString() : "";
        final String csaIdentificador = ade.getAttribute(Columns.CSA_IDENTIFICADOR) != null ? ade.getAttribute(Columns.CSA_IDENTIFICADOR).toString() : "";
        final String csaNome = ade.getAttribute(Columns.CSA_NOME_ABREV) != null ? ade.getAttribute(Columns.CSA_NOME_ABREV).toString() : ade.getAttribute(Columns.CSA_NOME).toString();
        final String corIdentificador = ade.getAttribute(Columns.COR_IDENTIFICADOR) != null ? ade.getAttribute(Columns.COR_IDENTIFICADOR).toString() : "";
        final String corNome = ade.getAttribute(Columns.COR_NOME) != null ? ade.getAttribute(Columns.COR_NOME).toString() : "";
        final StringBuilder servico = new StringBuilder().append((ade.getAttribute(Columns.CNV_COD_VERBA) != null) && !"".equals(ade.getAttribute(Columns.CNV_COD_VERBA).toString()) ? ade.getAttribute(Columns.CNV_COD_VERBA).toString() : ade.getAttribute(Columns.SVC_IDENTIFICADOR).toString());
        servico.append((ade.getAttribute(Columns.ADE_INDICE) != null) && !"".equals(ade.getAttribute(Columns.ADE_INDICE).toString()) ? ade.getAttribute(Columns.ADE_INDICE).toString() : "");
        servico.append(" - ").append(ade.getAttribute(Columns.SVC_DESCRICAO).toString());

        final StringBuilder texto = new StringBuilder();
        texto.append("<br>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.consignante.singular", responsavel) + ":</b> " + cseNome);
        texto.append("<br>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.singular", responsavel) + ":</b> " + csaIdentificador + " - " + csaNome);
        if (!TextHelper.isNull(corIdentificador) && !TextHelper.isNull(corNome)) {
            texto.append("<br>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.correspondente.singular", responsavel) + ":</b> " + corIdentificador + " - " + corNome);
        }
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.servidor", responsavel, rseMatricula, serNome));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.cpf", responsavel, serCpf));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.data.inclusao", responsavel, adeData));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.numero.ade", responsavel, adeNumero));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.consignacao.identificador", responsavel, adeIdentificador));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.servico", responsavel, servico.toString()));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.prestacao", responsavel, adeVlr));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.numero.prestacao", responsavel, adePrazo));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.parcelas.pagas", responsavel, adePrdPagas));
        texto.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.situacao.ade", responsavel, sadDescricao));

        return texto.toString();
    }

    /**
     * Método auxuliar para geração do texto do e-mail com o detalhe do saldo
     * devedor de um contrato. Recebe um TransferObject com os dados do saldo.
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    private static String gerarTextoDetalheSaldoDevedor(SaldoDevedorTransferObject saldoDevedorTO, AcessoSistema responsavel) {
        try {
            final String adeCodigo = saldoDevedorTO.getAdeCodigo();
            final String valorSaldoDevedor = NumberHelper.format(saldoDevedorTO.getSdvValor().doubleValue(), NumberHelper.getLang());
            final boolean exigeMultiplosSaldos = ParamSist.paramEquals(CodedValues.TPC_EXIGE_MULTIPLOS_SALDOS_DEVEDORES, CodedValues.TPC_SIM, responsavel);

            final StringBuilder textoSaldoDevedor = new StringBuilder().append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel));
            if (exigeMultiplosSaldos) {
                final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
                final String dataSaldoDevedor1 = adeDelegate.getValorDadoAutDesconto(adeCodigo, CodedValues.TDA_SDV_DATA_VCTO1, responsavel);
                String valorSaldoDevedor1 = adeDelegate.getValorDadoAutDesconto(adeCodigo, CodedValues.TDA_SDV_VALOR_VCTO1, responsavel);
                final String dataSaldoDevedor2 = adeDelegate.getValorDadoAutDesconto(adeCodigo, CodedValues.TDA_SDV_DATA_VCTO2, responsavel);
                String valorSaldoDevedor2 = adeDelegate.getValorDadoAutDesconto(adeCodigo, CodedValues.TDA_SDV_VALOR_VCTO2, responsavel);
                final String dataSaldoDevedor3 = adeDelegate.getValorDadoAutDesconto(adeCodigo, CodedValues.TDA_SDV_DATA_VCTO3, responsavel);
                String valorSaldoDevedor3 = adeDelegate.getValorDadoAutDesconto(adeCodigo, CodedValues.TDA_SDV_VALOR_VCTO3, responsavel);

                valorSaldoDevedor1 = NumberHelper.reformat(valorSaldoDevedor1, "en", NumberHelper.getLang());
                valorSaldoDevedor2 = NumberHelper.reformat(valorSaldoDevedor2, "en", NumberHelper.getLang());
                valorSaldoDevedor3 = NumberHelper.reformat(valorSaldoDevedor3, "en", NumberHelper.getLang());

                textoSaldoDevedor.append("<br/>\n").append(ApplicationResourcesHelper.getMessage("rotulo.email.valor.saldo.devedor.vencimento.em", responsavel, dataSaldoDevedor1, valorSaldoDevedor1));
                textoSaldoDevedor.append("<br/>\n").append(ApplicationResourcesHelper.getMessage("rotulo.email.valor.saldo.devedor.vencimento.em", responsavel, dataSaldoDevedor2, valorSaldoDevedor2));
                textoSaldoDevedor.append("<br/>\n").append(ApplicationResourcesHelper.getMessage("rotulo.email.valor.saldo.devedor.vencimento.em", responsavel, dataSaldoDevedor3, valorSaldoDevedor3));
            } else {
                textoSaldoDevedor.append("<br/>\n").append(ApplicationResourcesHelper.getMessage("rotulo.email.valor.saldo.devedor", responsavel, valorSaldoDevedor));
            }
            if (!TextHelper.isNull(saldoDevedorTO.getObs())) {
                textoSaldoDevedor.append("<br/>\n").append(ApplicationResourcesHelper.getMessage("rotulo.email.observacao.abreviado", responsavel, saldoDevedorTO.getObs()));
            }

            return textoSaldoDevedor.toString();
        } catch (AutorizacaoControllerException | ParseException ex) {
            LOG.error(ex.getMessage(), ex);
            return "";
        }
    }

    /**
     * Método auxuliar para geração do texto do e-mail com a informação para
     * depósito do saldo devedor de um contrato.
     * @param saldoDevedorTO
     * @return
     */
    private static String gerarTextoInfDepositoSaldoDevedor(SaldoDevedorTransferObject saldoDevedorTO) {

        return (saldoDevedorTO.getBcoCodigo() != null ? "<br/>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.banco.deposito", (AcessoSistema) null,  saldoDevedorTO.getBcoCodigo().toString()) : "")
                + (!TextHelper.isNull(saldoDevedorTO.getSdvAgencia()) ? "<br/>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.agencia.deposito", (AcessoSistema) null, saldoDevedorTO.getSdvAgencia()) : "")
                + (!TextHelper.isNull(saldoDevedorTO.getSdvConta()) ? "<br/>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.conta.deposito", (AcessoSistema) null, saldoDevedorTO.getSdvConta()) : "")
                + (!TextHelper.isNull(saldoDevedorTO.getSdvNomeFavorecido()) ? "<br/>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.nome.favorecido.deposito", (AcessoSistema) null, saldoDevedorTO.getSdvNomeFavorecido()) : "")
                + (!TextHelper.isNull(saldoDevedorTO.getSdvCnpj()) ? "<br/>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.cnpj.deposito", (AcessoSistema) null, saldoDevedorTO.getSdvCnpj()) : "")
                + "<br/>\n<br/>\n";
    }

    /**
     * Define o título padrão dos e-mails, com o nome do sistema,
     * opcionalmente com o nome do consignante, e um titulo customizado.
     * @param cseNome
     * @param tituloCustomizado
     * @param responsavel
     * @return
     */
    private static String gerarTituloEmail(String cseNome, String tituloCustomizado, AcessoSistema responsavel) {
        return JspHelper.getNomeSistema(responsavel) + (!TextHelper.isNull(cseNome) ? " - " + cseNome : "") + ": " + tituloCustomizado;
    }


    /**
     * Envia boleto por email para o servidor.
     * @param boleto
     * @param responsavel
     * @throws Exception
     */
    public static void enviaBoleto(TransferObject boleto, AcessoSistema responsavel) throws Exception {
        if (!TextHelper.isNull(boleto.getAttribute(Columns.SER_EMAIL))) {
            final String corpo = geraHtmlBoleto(boleto, responsavel);
            final MailHelper mh = new MailHelper();
            final String cseNome = getCseNome(responsavel);
            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.boleto.consignacao.titulo", responsavel), responsavel);
            mh.send((String) boleto.getAttribute(Columns.SER_EMAIL), null, null, titulo, corpo, null);
        }
    }

  //TODO: mover para BoletoHelper este método
    /**
     * encapsula geração de HTML do boleto
     * @param boleto
     * @param includeCSS - define se mantém ou remove código CSS do template final (relevante para parser HTML do iText)
     * @param responsavel
     * @return
     * @throws Exception
     */
    public static String geraHtmlBoleto(TransferObject boleto, boolean includeCSS, AcessoSistema responsavel) throws Exception{
        final ParametroDelegate parDelegate = new ParametroDelegate();
        final List<String> parametros = new ArrayList<>();
        parametros.add(CodedValues.TPS_BUSCA_BOLETO_EXTERNO);
        parametros.add(CodedValues.TPS_DIAS_DESBL_SOLICITACAO_NAO_CONF);
        parametros.add(CodedValues.TPS_EXIGE_CODIGO_AUTORIZACAO_CONF_SOLIC);
        final String svcCodigo = (String) boleto.getAttribute(Columns.SVC_CODIGO);
        final ParamSvcTO paramSvcCse = parDelegate.selectParamSvcCse(svcCodigo, parametros, responsavel);
        final boolean boletoExterno = paramSvcCse.isTpsBuscaBoletoExterno();
        final boolean exigeCodAutSolicitacao = paramSvcCse.isTpsExigeCodAutorizacaoSolic();

        final int numDias = (paramSvcCse.getTpsDiasDesblSolicitacaoNaoConf() != null) && !"".equals(paramSvcCse.getTpsDiasDesblSolicitacaoNaoConf()) ?
                Integer.parseInt(paramSvcCse.getTpsDiasDesblSolicitacaoNaoConf()) : 2;
        Date dataSim = (Date) boleto.getAttribute(Columns.ADE_DATA);
        if (dataSim == null) {
          dataSim = DateHelper.getSystemDatetime();
        }
        final Date dataValidade = DateHelper.addDays(dataSim, numDias - 1);

        final StringBuilder out = new StringBuilder();

        if (includeCSS) {
            out.append("<HTML>");
            out.append("<HEAD>");
            out.append("<TITLE>").append(ApplicationResourcesHelper.getMessage("rotulo.boleto.consignacao.titulo", responsavel)).append("</TITLE>");
            out.append("<META HTTP-EQUIV=\"Content-Type\" CONTENT=\"text/html; charset=iso-8859-1\">");
            out.append("<link rel=\"stylesheet\" href=\"../css/style.css\" type=\"text/css\">");

            out.append("<STYLE>");
            out.append("table {  padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px}");
            out.append("table.Tabelaresultado {  padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px}");
            out.append("table.Tabelaresultado1 { padding-top: 1pt; padding-right: 1pt; padding-bottom: 1pt; padding-left: 1pt ; border: #000000 solid; border-width: 0px 1px}");
            out.append("td.dados {");
            out.append("border: 1px solid #666666;");
            out.append("padding: 1px;");
            out.append("}");
            out.append("BODY {");
            out.append("BACKGROUND-COLOR: #FFFFFF;");
            out.append("background-image: none;");
            out.append("}");
            out.append("BODY.PRINT {");
            out.append("BACKGROUND-COLOR: #FFFFFF;");
            out.append("background-image: none;");
            out.append("}");
            out.append("@media print {    /* for good browsers */");
            out.append(".no-print, .no-print * {");
            out.append("display: none !important;");
            out.append("}");
            out.append("BODY {");
            out.append("BACKGROUND-COLOR: #FFFFFF;");
            out.append("background-image: none;");
            out.append("}");
            out.append("}");
            out.append("</STYLE>");
        }
        out.append("</HEAD>");
        out.append("<BODY>");

        final String boletoMsg = CodedNames.TEMPLATE_BOLETO_AUT_DESCONTO;

        if (boletoExterno) {
            String absolutePath = ParamSist.getDiretorioRaizArquivos();
            absolutePath += File.separatorChar + "boleto" + File.separatorChar + svcCodigo + File.separatorChar + boletoMsg;

            File arqBoleto = new File(absolutePath);
            if (!arqBoleto.exists()) {
                absolutePath = ParamSist.getDiretorioRaizArquivos();
                absolutePath += File.separatorChar + "boleto" + File.separatorChar + boletoMsg;
                arqBoleto = new File(absolutePath);
                if (!arqBoleto.exists()) {
                    LOG.error(ApplicationResourcesHelper.getMessage("mensagem.log.boleto.nao.encontrado", responsavel, absolutePath));
                    throw new ZetraException("mensagem.erro.interno.boleto.nao.encontrado", responsavel);
                }
            }

            boleto.setAttribute(Columns.ORG_CODIGO, responsavel.getOrgCodigo());

            String msg = FileHelper.readAll(absolutePath);
            msg = BoletoHelper.gerarTextoBoleto(msg, (CustomTransferObject) boleto, responsavel);
            out.append(msg);
            out.append("</BODY></HTML>");
            return out.toString();
        }

        final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
        final String codigoAutorizacaoSolic = adeDelegate.getValorDadoAutDesconto((String) boleto.getAttribute(Columns.ADE_CODIGO), CodedValues.TDA_CODIGO_AUTORIZACAO_SOLICITACAO, responsavel);

        out.append("<TABLE WIDTH=\"80%\" BORDER=\"0\" ALIGN=\"CENTER\" CELLPADDING=\"0\" CELLSPACING=\"0\">");
        if (exigeCodAutSolicitacao && responsavel.isSer() && !TextHelper.isNull(codigoAutorizacaoSolic)) {
            out.append("<TR>");
            out.append("<TD>");
            out.append("<br><font class=\"codigoAutorizacao\"><b>" + ApplicationResourcesHelper.getMessage("rotulo.consignacao.codigo.autorizacao", responsavel) + "</b>: " + codigoAutorizacaoSolic + "</font>");
            out.append("</TD>");
            out.append("</TR>");
        }
        out.append("<TR>");
        out.append("<TD>");
        out.append(" <TABLE WIDTH=\"100%\" BORDER=\"1\" CELLPADDING=\"0\" CELLSPACING=\"0\" >");
        out.append("       <TR>");
        out.append("         <TD colspan=\"5\" ALIGN=\"CENTER\"><FONT SIZE=\"4\"><I>");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.boleto.consignacao.titulo", responsavel));
        out.append("</I></FONT></TD>");
        out.append("       </TR>");
        out.append("       <TR>");
        out.append("         <TD colspan=\"5\" class=\"TituloColuna\"><I>I - ");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.boleto.dados.pessoais", responsavel)).append("</I></TD>");
        out.append("       </TR>");
        out.append("       <TR>");
        out.append("         <TD colspan=\"3\" valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.nome", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_NOME))).append("&nbsp;</TD>");
        out.append("        <TD colspan=\"2\" valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.cpf", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_CPF))).append("&nbsp;</TD>");
        if(!TextHelper.isNull(boleto.getAttribute(Columns.SER_SEXO))) {
            out.append("        <TD valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
            out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.sexo", responsavel)).append("</span><BR>");
            out.append("M".equalsIgnoreCase(boleto.getAttribute(Columns.SER_SEXO).toString())
                    ? ApplicationResourcesHelper.getMessage("rotulo.servidor.sexo.masculino", responsavel)
                            : ApplicationResourcesHelper.getMessage("rotulo.servidor.sexo.feminino", responsavel)).append("&nbsp;</TD>");
        }
        out.append("      </TR>");
        out.append("    <TR>");
        out.append("      <TD valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.dataNasc", responsavel)).append("</span><br>");
        out.append(DateHelper.toDateString((Date) boleto.getAttribute(Columns.SER_DATA_NASC))).append("&nbsp;</TD>");
        out.append("        <TD valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.estadoCivil", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_EST_CIVIL)) + "&nbsp;</TD>");
        out.append("        <TD colspan=\"3\" valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.identidade.uf.orgao.data", responsavel));
        out.append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_NRO_IDT))).append("&nbsp; </TD>");
        out.append("      </TR>");
        out.append("      <TR>");
        out.append("        <TD colspan=\"2\" valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.nomePai", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_NOME_PAI))).append("&nbsp; </TD>");
        out.append("        <TD colspan=\"3\" valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.nomeMae", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_NOME_MAE))).append("&nbsp;</TD>");
        out.append("      </TR>");
        out.append("      <TR>");
        out.append("       <TD colspan=\"2\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.boleto.rua.avenida.praca", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_END)) + "&nbsp;</TD>");
        out.append("        <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.endereco.numero", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_NRO)) + "&nbsp;</TD>");
        out.append("        <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.endereco.complemento.abreviado", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_COMPL))).append("&nbsp;</TD>");
        out.append("        <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.endereco.bairro", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_BAIRRO))).append("&nbsp;</TD>");
        out.append("      </TR>");
        out.append("     <TR>");
        out.append("        <TD valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.endereco.cidade", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_CIDADE)) + "&nbsp;</TD>");
        out.append("        <TD valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.endereco.estado", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_UF))).append("&nbsp;</TD>");
        out.append("        <TD valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.endereco.cep", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_CEP))).append("&nbsp;</TD>");
        out.append("        <TD colspan=\"2\" valign=\"top\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.telefone", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SER_TEL))).append("&nbsp;</TD>");
        out.append("      </TR>");
        out.append("      <TR>");
        out.append("        <TD colspan=\"5\" class=\"TituloColuna\"><I>II - ");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.boleto.dados.funcionais", responsavel)).append("</I></TD>");
        out.append("      </TR>");
        out.append("      <TR valign=\"top\">");
        out.append("        <TD width=\"19%\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.matricula", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.RSE_MATRICULA)) + "&nbsp;</TD>");
        out.append("        <TD width=\"19%\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.categoria", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.RSE_TIPO)) + "&nbsp;</TD>");
        out.append("        <TD width=\"19%\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.servidor.dataAdmissao", responsavel)).append("</span><br>");
        out.append(forHtmlContent(DateHelper.toDateString((Date) boleto.getAttribute(Columns.RSE_DATA_ADMISSAO)))).append("&nbsp;</TD>");
        out.append("       <TD colspan=\"2\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.singular", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_IDENTIFICADOR))).append(" - ");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_NOME))).append("&nbsp;</TD>");
        out.append("      </TR>");
        out.append("      <TR valign=\"top\">");
        out.append("        <TD colspan=\"2\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.endereco.comercial", responsavel));
        out.append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_LOGRADOURO)) + "&nbsp;</TD>");
        out.append("        <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.numero", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_NRO))).append("&nbsp;</TD>");
        out.append("       <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.complemento", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_COMPL))).append("&nbsp;</TD>");
        out.append("        <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.bairro", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_BAIRRO))).append("&nbsp;</TD>");
        out.append("      </TR>");
        out.append("      <TR valign=\"top\">");
        out.append("        <TD colspan=\"2\" CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.cidade", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_CIDADE))).append("&nbsp;</TD>");
        out.append("       <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.uf", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_UF))).append("&nbsp;</TD>");
        out.append("       <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.cep", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_CEP))).append("&nbsp;</TD>");
        out.append("        <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.orgao.telefone.ramal", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ORG_TEL))).append("&nbsp;</TD>");
        out.append("      </TR>");
        out.append("      <TR>");
        out.append("        <TD colspan=\"5\" class=\"TituloColuna\"><I>III -");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.boleto.caracteristicas.operacao", responsavel)).append("</I></TD>");
        out.append("     </TR>");
        out.append("     <TR valign=\"top\">");
        out.append("       <TD colspan=\"4\" CLASS=\"FonteReduzida\">");
        out.append("         <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.consignataria.singular", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.CSA_NOME)));
        out.append("       </TD>");
        out.append("       <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.usuario.responsavel", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.USU_LOGIN))).append("&nbsp;</TD>");
        out.append("     </TR>");
        out.append("     <TR valign=\"top\">");
        out.append("       <TD CLASS=\"FonteReduzida\">");
        out.append("         <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.codigo.verba.singular", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.CNV_COD_VERBA))).append("&nbsp;</TD>");
        out.append("        <TD colspan=\"2\" CLASS=\"FonteReduzida\">");
        out.append("          <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.natureza.operacao", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.SVC_DESCRICAO))).append("&nbsp;</TD>");
        out.append("       <TD CLASS=\"FonteReduzida\">");
        out.append("         <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.numero", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ADE_NUMERO))).append("&nbsp;</TD>");
        out.append("       <TD CLASS=\"FonteReduzida\"><span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.ranking", responsavel)).append("</span><BR>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.CDE_RANKING))).append("&ordf;</TD>");
        out.append("     </TR>");
        out.append("      <TR valign=\"top\">");
        out.append("        <TD CLASS=\"FonteReduzida\">");
        out.append("           <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.valor.liberado", responsavel)).append("</span><br>");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.moeda", responsavel))
            .append(NumberHelper.format(((BigDecimal) boleto.getAttribute(Columns.CDE_VLR_LIBERADO)).doubleValue(), NumberHelper.getLang(), true)).append("&nbsp;</TD>");
        out.append("        <TD CLASS=\"FonteReduzida\">");
        out.append("         <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.valor.parcela", responsavel)).append("</span><br>");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.moeda", responsavel))
            .append(NumberHelper.format(((BigDecimal) boleto.getAttribute(Columns.ADE_VLR)).doubleValue(), NumberHelper.getLang(), true)).append("&nbsp;</TD>");
        out.append("       <TD CLASS=\"FonteReduzida\">");
        out.append("          <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.prazo", responsavel)).append("</span><br>");
        out.append(forHtmlContent(boleto.getAttribute(Columns.ADE_PRAZO))).append("&nbsp;</TD>");
        out.append("       <TD CLASS=\"FonteReduzida\">");
        out.append("         <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.data.inicial", responsavel)).append("</span><br>");
        out.append(forHtmlContent(DateHelper.toPeriodString((java.util.Date) boleto.getAttribute(Columns.ADE_ANO_MES_INI)))).append("&nbsp;</TD>");
        out.append("       <TD CLASS=\"FonteReduzida\">");
        out.append("         <span class=\"RotuloReduzido\">");
        out.append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.data.final", responsavel)).append("</span><br>");
        out.append(forHtmlContent(DateHelper.toPeriodString((java.util.Date) boleto.getAttribute(Columns.ADE_ANO_MES_FIM)))).append("&nbsp;</TD>");
        out.append("     </TR>");
        out.append("   </TABLE>");
        out.append(" </TD>");
        out.append("</TR>");
        out.append("<TR>");
        out.append("<TD CLASS=\"FonteReduzida\"><p align=\"justify\"><br>");

        final StringBuilder absolutePath = new StringBuilder().append(ParamSist.getDiretorioRaizArquivos());
        absolutePath.append(File.separatorChar).append("boleto").append(File.separatorChar).append(boletoMsg);
        final String msg = FileHelper.readAll(absolutePath.toString())
                .replaceAll("<SERVICO>", boleto.getAttribute(Columns.SVC_DESCRICAO).toString().toUpperCase())
                .replaceAll("<CONSIGNATARIA>", boleto.getAttribute(Columns.CSA_NOME).toString().toUpperCase());
        out.append(msg);

        out.append("</p></TD>");
        out.append("</TR>");
        out.append(" <TR>");
        out.append(" <TD>&nbsp;</TD>");
        out.append("</TR>");
        out.append("<TR>");
        out.append("  <TD>");
        out.append("  <TABLE WIDTH=\"100%\" BORDER=\"0\">");
        out.append("     <TR>");
        out.append("       <TD colspan=\"2\" VALIGN=\"TOP\" CLASS=\"FonteReduzida\">_________________________, _____ ")
                .append(ApplicationResourcesHelper.getMessage("rotulo.data.de", responsavel))
                .append(" ________________ ")
                .append(ApplicationResourcesHelper.getMessage("rotulo.data.de", responsavel)).append(" 20____</TD>");
        out.append("      </TR>");
        out.append("      <TR>");
        out.append("        <TD height=\"30\" VALIGN=\"TOP\" CLASS=\"FonteReduzida\">&nbsp;</TD>");
        out.append("        <TD>&nbsp;</TD>");
        out.append("      </TR>");
        out.append("      <TR>");
        out.append("        <TD align=\"center\" VALIGN=\"TOP\" CLASS=\"FonteReduzida\"><p>______________________________________________<BR>")
                .append(ApplicationResourcesHelper.getMessage("rotulo.servidor.singular", responsavel).toUpperCase())
                .append("</p></TD>");
        out.append("        <TD align=\"center\" valign=\"top\"><p>______________________________________________<BR>")
                .append(ApplicationResourcesHelper.getMessage("rotulo.consignataria.singular", responsavel).toUpperCase())
                .append("</p></TD>");
        out.append("      </TR>");
        out.append("  </TABLE></TD>");
        out.append("</TR>");
        out.append("<TR>");
        out.append("  <TD>");
        out.append("  <HR>");
        out.append("  </TD>");
        out.append("</TR>");
        out.append("<TR>");
        out.append("  <TD CLASS=\"FonteReduzida\">");
        out.append("  <TABLE WIDTH=\"100%\" BORDER=\"0\" cellpadding=\"0\" cellspacing=\"0\">");
        out.append("      <TR>");
        out.append("        <TD CLASS=\"FonteReduzida\" WIDTH=\"40%\">")
                .append(ApplicationResourcesHelper.getMessage("rotulo.boleto.valido.ate", responsavel))
                .append(DateHelper.toDateString(dataValidade)).append("</TD>");
        out.append("        <TD WIDTH=\"20%\" align=\"center\" CLASS=\"FonteReduzida\">")
                .append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.numero", responsavel)).append(": ")
                .append(forHtmlContent(boleto.getAttribute(Columns.ADE_NUMERO))).append("</TD>");
        out.append("        <TD CLASS=\"FonteReduzida\" WIDTH=\"40%\" ALIGN=\"RIGHT\">")
                .append(forHtmlContent(boleto.getAttribute(Columns.USU_LOGIN))).append(" - ")
                .append(DateHelper.toDateTimeString(dataSim)).append("</TD>");
        out.append("      </TR>");
        out.append("  </TABLE></TD>");
        out.append("</TR>");
        out.append("</TABLE>");
        out.append("<BR>");
        out.append("</BODY></HTML>");

        return out.toString();

    }

    //TODO: mover para BoletoHelper este método
    public static String geraHtmlBoleto(TransferObject boleto, AcessoSistema responsavel) throws Exception{
        return geraHtmlBoleto(boleto, true, responsavel);
    }

    private static String forHtmlContent(Object st){
        if (st == null) {
            return "";
        }
        return TextHelper.forHtmlContent(st);
    }

    /**
     * Envia por e-mail a informação de cadastro de servidor
     * @param adeCodigo
     * @param responsavel
     * @return
     * @throws ViewHelperException
     */
    public static final void enviarEmailNotificacaoCadastroServidor(String rseCodigo, AcessoSistema responsavel) throws ViewHelperException{
        final EnviarEmailNotificacaoCadastroServidorCommand command = new EnviarEmailNotificacaoCadastroServidorCommand();
        command.setRseCodigo(rseCodigo);
        command.setResponsavel(responsavel);
        command.execute();
    }

    public static void enviarEmailCsaSolicitacaoFeitaPorSer(String csaEmail, String rseCodigo, String adeCodigo, BigDecimal rseMargemRestAntes, Short adeIncMargem, ConvenioTransferObject cnvTo, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailCsaNovaSolicitacaoCommand command = new EnviarEmailCsaNovaSolicitacaoCommand();
        command.setRseCodigo(rseCodigo);
        command.setAdeCodigo(adeCodigo);
        command.setCnvTo(cnvTo);
        command.setCsaMail(csaEmail);
        command.setRseMargemRestOld(rseMargemRestAntes);
        command.setIncMargem(adeIncMargem);
        command.setResponsavel(responsavel);
        command.execute();
    }

    public static void enviarEmailCsaSolicitacaoCanceladaPorSer(String csaEmail, String rseCodigo, String adeCodigo, BigDecimal rseMargemRestAntes, Short adeIncMargem, ConvenioTransferObject cnvTo, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailCsaSerCancelaSolicitacaoCommand command = new EnviarEmailCsaSerCancelaSolicitacaoCommand();
        command.setRseCodigo(rseCodigo);
        command.setAdeCodigo(adeCodigo);
        command.setCnvTo(cnvTo);
        command.setCsaMail(csaEmail);
        command.setRseMargemRestOld(rseMargemRestAntes);
        command.setIncMargem(adeIncMargem);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * Envia e-mail para as consignatárias informando sobre a inclusão de um novo leilão
     * @param adeCodigo
     * @param responsavel
     * @return
     * @throws ViewHelperException
     */
    public static void enviarEmailNotificacaoNovoLeilao(SolicitacaoAutorizacao solicitacao, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(solicitacao.getAutDesconto().getAdeCodigo(), responsavel);

            final LeilaoSolicitacaoController leilaoSolicitacaoController = ApplicationContextProvider.getApplicationContext().getBean(LeilaoSolicitacaoController.class);
            final List<TransferObject> lstPls = leilaoSolicitacaoController.lstPropostaLeilaoSolicitacao(ade.getAttribute(Columns.ADE_CODIGO).toString(), null, null, false, responsavel);

            // Nesse momento, somente 1 proposta pode estar ativa
            if ((lstPls !=null) && (lstPls.isEmpty() || (lstPls.size() > 1))) {
                throw new LeilaoSolicitacaoControllerException("mensagem.erro.leilao.envio.notificacao.consignataria", responsavel);
            }

            final TransferObject proposta = lstPls.get(0);

            final List<String> lstEmailsDest = leilaoSolicitacaoController.lstEmailConsignatariasNotificacaoLeilao(solicitacao.getAutDesconto().getAdeCodigo(), responsavel);
            String titulo = null;

            if ((lstEmailsDest != null) && !lstEmailsDest.isEmpty()) {
                final String cseNome = getCseNome(responsavel);
                final String dataAbertura = DateHelper.format(solicitacao.getSoaData(), LocaleHelper.getDateTimePattern());
                final String dataValidade = !TextHelper.isNull(solicitacao.getSoaDataValidade()) ? DateHelper.format(solicitacao.getSoaDataValidade(), LocaleHelper.getDateTimePattern()) : ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.data.fechamento.nao.definida", responsavel);
                final String adeValorLiq = NumberHelper.format(((BigDecimal) proposta.getAttribute(Columns.PLS_VALOR_LIBERADO)).doubleValue(), NumberHelper.getLang());
                final String adeValor = NumberHelper.format(((BigDecimal) proposta.getAttribute(Columns.PLS_VALOR_PARCELA)).doubleValue(), NumberHelper.getLang());

                final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
                final String serNome = ade.getAttribute(Columns.SER_NOME).toString();
                final String rseMatricula = ade.getAttribute(Columns.RSE_MATRICULA).toString();
                final String serCpf = ade.getAttribute(Columns.SER_CPF).toString();
                String posto = null;

                if (ShowFieldHelper.showField(FieldKeysConstants.FILTRO_PESQUISA_POSTO_SERVIDOR, responsavel)) {
                    posto = ade.getAttribute(Columns.POS_DESCRICAO) != null ? ade.getAttribute(Columns.POS_DESCRICAO).toString() : "";
                }

                // Valor Taxa Juros
                 final String adeTaxaJurosReal = NumberHelper.format(((BigDecimal) proposta.getAttribute(Columns.PLS_TAXA_JUROS)).doubleValue(), NumberHelper.getLang()) + " %";

                // Define rótulo para o campo de Taxa de Juros/CET/Coeficiente
                final String rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.proposta.leilao.solicitacao.proposta.taxa.informada", responsavel);

                titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.titulo.alerta.novo.leilao", responsavel, dataAbertura, dataValidade), responsavel);
                final StringBuilder corpoEmail = new StringBuilder();
                corpoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.novo.leilao.aberto", responsavel)).append("<br><br>");

                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.proposta.leilao.solicitacao.numero", responsavel)).append("</b> : ");
                corpoEmail.append(adeNumero).append("<br>");
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.valor.liberado", responsavel)).append("</b> : ");
                corpoEmail.append(ApplicationResourcesHelper.getMessage("rotulo.moeda", responsavel)).append(" ").append(adeValorLiq).append("<br>");
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.valor.prestacao", responsavel)).append("</b> : ");
                corpoEmail.append(ApplicationResourcesHelper.getMessage("rotulo.moeda", responsavel)).append(" ").append(adeValor).append("<br>");
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.prazo", responsavel)).append("</b> : ");
                corpoEmail.append(proposta.getAttribute(Columns.PLS_PRAZO)).append("<br>");
                corpoEmail.append("<b>").append(rotuloTaxa).append("</b> : ");
                corpoEmail.append(adeTaxaJurosReal).append("<br>");
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.data.abertura", responsavel)).append("</b> : ");
                corpoEmail.append(dataAbertura).append("<br>");
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.data.fechamento", responsavel)).append("</b> : ");
                corpoEmail.append(dataValidade).append("<br><br>");
                corpoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.dados.servidor", responsavel)).append("<br><br>");

                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.servidor.nome", responsavel)).append("</b> : ");
                corpoEmail.append(serNome).append("<br>");
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.servidor.cpf", responsavel)).append("</b> : ");
                corpoEmail.append(serCpf).append("<br>");
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.matricula.singular", responsavel)).append("</b> : ");
                corpoEmail.append(rseMatricula).append("<br>");

                if (posto != null) {
                    corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.servidor.posto", responsavel)).append("</b> : ");
                    corpoEmail.append(posto).append("<br>");
                }

                // Envia o e-mail.
                for (final String email : lstEmailsDest) {
                    new MailHelper().send(TipoNotificacaoEnum.EMAIL_NOVA_PROPOSTA_LEILAO, email, null, null, titulo, corpoEmail.toString(), null, null, responsavel);
                }
            }
        } catch (MessagingException | ZetraException ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail ao servidor para alertar de inclusão de novo contrato oriundo de proposta de leilão aceita.
     * @param adeCodigo do novo contrato incluído.
     * @param codigoAutorizacao código de autorização da solicitação para confirmação do contrato
     * @param senhaAutorizacao senha para ser consumida na confirmação do contrato
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailSerPropostaLeilaoAprovada(String adeCodigo, String codigoAutorizacao, String senhaAutorizacao, PropostaLeilaoSolicitacao plsVencedora, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject adeTO = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            final String serEmail = (String) adeTO.getAttribute(Columns.SER_EMAIL);

            if (!TextHelper.isNull(serEmail)) {
                final String qtdDiasConcretizarLeilao = (String) ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_PARA_SER_CONCRETIZAR_LEILAO, responsavel);

                final StringBuilder textoSenha = new StringBuilder();
                if (!TextHelper.isNull(codigoAutorizacao)) {
                    textoSenha.append("<br/>\n<b>").append(ApplicationResourcesHelper.getMessage("rotulo.email.codigo.autorizacao", responsavel, codigoAutorizacao)).append("</b>");
                }
                if (!TextHelper.isNull(senhaAutorizacao)) {
                    textoSenha.append("<br/>\n<b>").append(ApplicationResourcesHelper.getMessage("rotulo.email.senha.servidor.autorizacao", responsavel, senhaAutorizacao)).append("</b>");
                }
                final String cseNome = getCseNome(responsavel);
                // Define o titulo do email
                final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.servidor.proposta.aprovada.leilao", responsavel), responsavel);
                // Define o corpo do email
                final StringBuilder corpoEmail = new StringBuilder().append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel)).append(gerarTextoDetalheContratoParaEmail(adeTO, cseNome, responsavel)).append(textoSenha.append("<br/>\n<br/>\n").append(ApplicationResourcesHelper.getMessage("mensagem.email.servidor.proposta.aprovada.leilao.instrucoes", responsavel, qtdDiasConcretizarLeilao)).append("<br/>\n<br/>\n").toString());

                final boolean enviaEmailCsaVencedoraLeilao = ParamSist.getBoolParamSist(CodedValues.TPC_ENVIAR_EMAIL_CONSIGNATARIA_VENCEDORA_DO_LEILAO, responsavel);
                if (!enviaEmailCsaVencedoraLeilao) {
                    corpoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.email.servidor.proposta.aprovada.leilao.acesse.web", responsavel, qtdDiasConcretizarLeilao)).append("<br/>\n<br/>\n");
                }

                corpoEmail.append(plsVencedora.getPlsTxtContatoCsa()).append("<br/>\n<br/>\n");

                if (ParamSist.getBoolParamSist(CodedValues.TPC_ENVIAR_INFOS_CSA_NO_EMAIL_SER_PROPOSTA_LEILAO_APROVADA, responsavel)) {
                    final String csaNome = plsVencedora.getConsignataria().getCsaNome();
                    final String cet = plsVencedora.getPlsTaxaJuros() != null ? NumberHelper.format(plsVencedora.getPlsTaxaJuros().doubleValue(), NumberHelper.getLang()) : null;
                    final String csaEmailContato = plsVencedora.getConsignataria().getCsaEmailContato();
                    final String csaWhatsapp = plsVencedora.getConsignataria().getCsaWhatsapp();
                    final String csaTxtContato = plsVencedora.getConsignataria().getCsaTxtContato();

                    if (!TextHelper.isNull(csaNome)) {
                        corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.singular", responsavel)).append(": ").append(csaNome);
                    }
                    if (!TextHelper.isNull(cet)) {
                        corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.cet.singular", responsavel)).append(": ").append(cet);
                    }
                    if (!TextHelper.isNull(csaEmailContato)) {
                        corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.email", responsavel)).append(": ").append(csaEmailContato);
                    }
                    if (!TextHelper.isNull(csaWhatsapp)) {
                        corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.whatsapp", responsavel)).append(": ").append(csaWhatsapp);
                    }
                    if (!TextHelper.isNull(csaTxtContato)) {
                        corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.telefone", responsavel)).append(": ").append(csaTxtContato);
                    }


                    try {
                        final LeilaoSolicitacaoController leilaoSolicitacaoController = ApplicationContextProvider.getApplicationContext().getBean(LeilaoSolicitacaoController.class);
                        final ConsignatariaController consingnatariaController = ApplicationContextProvider.getApplicationContext().getBean(ConsignatariaController.class);
                        final List<TransferObject> lstRejeitadas = leilaoSolicitacaoController.lstPropostaLeilaoSolicitacao(plsVencedora.getAdeCodigo(), null, StatusPropostaEnum.REJEITADA.getCodigo(), false, responsavel);

                        if ((lstRejeitadas != null) && !lstRejeitadas.isEmpty()) {
                            corpoEmail.append("<br/>\n<br/>\n").append(ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.propostas.leilao.rejeitadas", responsavel));

                            for (final TransferObject propostaRejeitada: lstRejeitadas) {
                                final String csaCodigoPropostaRejeitada = (String) propostaRejeitada.getAttribute(Columns.CSA_CODIGO);
                                final String csaNomePropostaRejeitada = (String) propostaRejeitada.getAttribute(Columns.CSA_NOME);
                                final String cetPropostaRejeitada = propostaRejeitada.getAttribute(Columns.PLS_TAXA_JUROS) != null ? NumberHelper.format(((BigDecimal) propostaRejeitada.getAttribute(Columns.PLS_TAXA_JUROS)).doubleValue(), NumberHelper.getLang()) : null;

                                final ConsignatariaTransferObject csaPropostaRejeitada = consingnatariaController.findConsignataria(csaCodigoPropostaRejeitada, responsavel);
                                final String csaEmailContatoPropostaRejeitada = csaPropostaRejeitada.getCsaEmailContato();
                                final String csaWhatsappPropostaRejeitada = csaPropostaRejeitada.getCsaWhatsapp();
                                final String csaTxtContatoPropostaRejeitada = csaPropostaRejeitada.getCsaTxtContato();

                                if (!TextHelper.isNull(csaNomePropostaRejeitada)) {
                                    corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.singular", responsavel)).append(": ").append(csaNomePropostaRejeitada);
                                }
                                if (!TextHelper.isNull(cetPropostaRejeitada)) {
                                    corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.cet.singular", responsavel)).append(": ").append(cetPropostaRejeitada);
                                }
                                if (!TextHelper.isNull(csaEmailContatoPropostaRejeitada)) {
                                    corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.email", responsavel)).append(": ").append(csaEmailContatoPropostaRejeitada);
                                }
                                if (!TextHelper.isNull(csaWhatsappPropostaRejeitada)) {
                                    corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.whatsapp", responsavel)).append(": ").append(csaWhatsappPropostaRejeitada);
                                }
                                if (!TextHelper.isNull(csaTxtContatoPropostaRejeitada)) {
                                    corpoEmail.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.telefone", responsavel)).append(": ").append(csaTxtContatoPropostaRejeitada);
                                }
                                corpoEmail.append("<br/>\n<br/>\n");
                            }
                        }
                    } catch (final ZetraException ex) {
                        LOG.error(ex.getMessage(), ex);
                    }
                }

                // Envia o email.
                final MailHelper mailHelper = new MailHelper();
                mailHelper.send(serEmail, null, null, titulo, corpoEmail.toString().toString(), null, null);
            }
        } catch (MessagingException | AutorizacaoControllerException ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail de notificação que não foi possível realizar oferta automática em um leilão pois o limite mínimo foi alcançado.
     *
     * @param adeCodigo
     * @param melhorTaxa
     * @param taxaLimite
     * @param decremento
     * @param dataFechamento
     * @param email
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailCsaOfertaAutLimiteMinSuperado(String adeCodigo, BigDecimal melhorTaxa, BigDecimal taxaLimite, BigDecimal decremento, Date dataFechamento, String email, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();

            final String taxaLimiteStr = NumberHelper.format(taxaLimite.doubleValue(), NumberHelper.getLang());
            final String decrementoStr = NumberHelper.format(decremento.doubleValue(), NumberHelper.getLang());
            final String melhorTaxaStr = NumberHelper.format(melhorTaxa.doubleValue(), NumberHelper.getLang());

            final String cseNome = getCseNome(responsavel);
            final String rseMatricula = ade.getAttribute(Columns.RSE_MATRICULA) != null ? ade.getAttribute(Columns.RSE_MATRICULA).toString() : "";
            final String serNome =  ade.getAttribute(Columns.SER_NOME) != null ? ade.getAttribute(Columns.SER_NOME).toString() : "";
            final String serCpf = ade.getAttribute(Columns.SER_CPF) != null ? ade.getAttribute(Columns.SER_CPF).toString() : "";

            // Define o titulo do email
            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.oferta.automatica.leilao.taxa.min.superada", responsavel), responsavel);

            // Define o corpo do email
            final String corpoEmail  = ApplicationResourcesHelper.getMessage("mensagem.email.oferta.automatica.leilao.taxa.min.superada.detalhe", responsavel, taxaLimiteStr, decrementoStr, adeNumero, melhorTaxaStr) + "<br>\n"
                    + "<br>\n" + ApplicationResourcesHelper.getMessage("mensagem.email.seguem.dados.leilao.solicitacao", responsavel)
                    + "<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.servidor", responsavel, rseMatricula, serNome)
                    + "<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.cpf", responsavel, serCpf)
                    + "<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.data.fechamento.leilao", responsavel, DateHelper.format(dataFechamento, LocaleHelper.getDateTimePattern()))
                    + "<br/>\n<br/>\n";

            // Envia o email.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(email, null, null, titulo, corpoEmail.toString(), null, null);

        } catch (AutorizacaoControllerException | MessagingException ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }


    /**
     * Envia e-mail para as consignatárias informando sobre a inclusão de um novo leilão dentro dos filtros criados
     * @param adeCodigo
     * @param responsavel
     * @return
     * @throws ViewHelperException
     */
    public static void enviarEmailNotificacaoNovoLeilaoByFiltro(SolicitacaoAutorizacao solicitacao, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final LeilaoSolicitacaoController leilaoSolicitacaoController = ApplicationContextProvider.getApplicationContext().getBean(LeilaoSolicitacaoController.class);
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();

            final List<TransferObject> filtros = leilaoSolicitacaoController.listarFiltrosByAdeCodigo(solicitacao.getAutDesconto().getAdeCodigo(), responsavel);

            final TransferObject ade = adeDelegate.buscaAutorizacao(solicitacao.getAutDesconto().getAdeCodigo(), responsavel);

            final List<TransferObject> lstPls = leilaoSolicitacaoController.lstPropostaLeilaoSolicitacao(ade.getAttribute(Columns.ADE_CODIGO).toString(), null, null, false, responsavel);

            // Nesse momento, somente 1 proposta pode estar ativa
            if ((lstPls !=null) && (lstPls.isEmpty() || (lstPls.size() > 1))) {
                throw new LeilaoSolicitacaoControllerException("mensagem.erro.leilao.envio.notificacao.filtro.consignataria", responsavel);
            }

            final TransferObject proposta = lstPls.get(0);

            if ((filtros != null) && !filtros.isEmpty()) {
                for (final TransferObject filtro : filtros) {
                    try {
                        final String cseNome = getCseNome(responsavel);
                        final String dataAbertura = DateHelper.format(solicitacao.getSoaData(), LocaleHelper.getDateTimePattern());
                        final String dataValidade = !TextHelper.isNull(solicitacao.getSoaDataValidade()) ? DateHelper.format(solicitacao.getSoaDataValidade(), LocaleHelper.getDateTimePattern()) : ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.data.fechamento.nao.definida", responsavel);
                        final String adeValorLiq = NumberHelper.format(((BigDecimal) proposta.getAttribute(Columns.PLS_VALOR_LIBERADO)).doubleValue(), NumberHelper.getLang());
                        final String adeValor = NumberHelper.format(((BigDecimal) proposta.getAttribute(Columns.PLS_VALOR_PARCELA)).doubleValue(), NumberHelper.getLang());

                        final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
                        final String serNome = ade.getAttribute(Columns.SER_NOME).toString();
                        final String rseMatricula = ade.getAttribute(Columns.RSE_MATRICULA).toString();
                        final String serCpf = ade.getAttribute(Columns.SER_CPF).toString();
                        String posto = null;

                        if (ShowFieldHelper.showField(FieldKeysConstants.FILTRO_PESQUISA_POSTO_SERVIDOR, responsavel)) {
                            posto = ade.getAttribute(Columns.POS_DESCRICAO) != null ? ade.getAttribute(Columns.POS_DESCRICAO).toString() : "";
                        }

                        // Valor Taxa Juros
                        final String adeTaxaJurosReal = NumberHelper.format(((BigDecimal) proposta.getAttribute(Columns.PLS_TAXA_JUROS)).doubleValue(), NumberHelper.getLang()) + " %";

                        // Define rótulo para o campo de Taxa de Juros/CET/Coeficiente
                        final String rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.proposta.leilao.solicitacao.proposta.taxa.informada", responsavel);

                        final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.titulo.alerta.novo.leilao.filtro", responsavel, dataAbertura, dataValidade), responsavel);
                        final StringBuilder corpoEmail = new StringBuilder();
                        corpoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.novo.leilao.aberto.filtro", responsavel)).append("<br><br>");

                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.filtro.leilao.singular", responsavel)).append("</b> : ");
                        corpoEmail.append(filtro.getAttribute(Columns.FLS_DESCRICAO).toString()).append("<br>");

                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.proposta.leilao.solicitacao.numero", responsavel)).append("</b> : ");
                        corpoEmail.append(adeNumero).append("<br>");
                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.valor.liberado", responsavel)).append("</b> : ");
                        corpoEmail.append(ApplicationResourcesHelper.getMessage("rotulo.moeda", responsavel)).append(" ").append(adeValorLiq).append("<br>");
                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.valor.prestacao", responsavel)).append("</b> : ");
                        corpoEmail.append(ApplicationResourcesHelper.getMessage("rotulo.moeda", responsavel)).append(" ").append(adeValor).append("<br>");
                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.prazo", responsavel)).append("</b> : ");
                        corpoEmail.append(proposta.getAttribute(Columns.PLS_PRAZO)).append("<br>");
                        corpoEmail.append("<b>").append(rotuloTaxa).append("</b> : ");
                        corpoEmail.append(adeTaxaJurosReal).append("<br>");
                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.data.abertura", responsavel)).append("</b> : ");
                        corpoEmail.append(dataAbertura).append("<br>");
                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.acompanhamento.leilao.solicitacao.data.fechamento", responsavel)).append("</b> : ");
                        corpoEmail.append(dataValidade).append("<br><br>");
                        corpoEmail.append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.dados.servidor", responsavel)).append("<br><br>");

                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.servidor.nome", responsavel)).append("</b> : ");
                        corpoEmail.append(serNome).append("<br>");
                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.servidor.cpf", responsavel)).append("</b> : ");
                        corpoEmail.append(serCpf).append("<br>");
                        corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.matricula.singular", responsavel)).append("</b> : ");
                        corpoEmail.append(rseMatricula).append("<br>");

                        if (posto != null) {
                            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.servidor.posto", responsavel)).append("</b> : ");
                            corpoEmail.append(posto).append("<br>");
                        }

                        final String email = filtro.getAttribute(Columns.FLS_EMAIL_NOTIFICACAO) != null ? filtro.getAttribute(Columns.FLS_EMAIL_NOTIFICACAO).toString() : null;

                        if (!TextHelper.isNull(email)) {
                            // Envia o e-mail.
                            new MailHelper().send(email, null, null, titulo, corpoEmail.toString(), null);
                        }
                    } catch (final Exception ex) {
                        // caso algum filtro dê algum erro continua o processo enviando o email dos outros filtros
                        LOG.error(ex.getMessage(), ex);
                        continue;
                    }
                }
            }

        } catch (LeilaoSolicitacaoControllerException | AutorizacaoControllerException ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia email para consignatária que possui taxa superior ao limite cadastrado.
     *
     * @param lstTaxas
     * @param limiteTaxaJuros
     * @param svcCodigo
     * @param dataFimVig
     * @param responsavel
     * @throws ZetraException
     * @throws MessagingException
     */
    public static final void enviarEmailTaxaSuperiorLimite(List<TransferObject> lstTaxas, CustomTransferObject limiteTaxaJuros, List<TransferObject> lstRegraJurosSuperior, String svcCodigo, Date dataFimVig, boolean aplicarRegraCETTaxaJuros,AcessoSistema responsavel) throws ZetraException, MessagingException {

        // Retorna caso não exista taxa superior ao limite cadastrado
        if(((lstTaxas == null) || lstTaxas.isEmpty()) && ((lstRegraJurosSuperior == null) || lstRegraJurosSuperior.isEmpty())){
            return;
        }

        // Agrupa taxas superiores ao limite informado por consignatária
        final Map<String, List<TransferObject>> consignatariasPorTaxa = new HashMap<>();
        for (final TransferObject taxa : lstTaxas) {
            final String csaCodigo = (String) taxa.getAttribute(Columns.CSA_CODIGO);

            List<TransferObject> taxasPorConsignataria = consignatariasPorTaxa.get(csaCodigo);
            if (taxasPorConsignataria == null) {
                taxasPorConsignataria = new ArrayList<>();
                consignatariasPorTaxa.put(csaCodigo, taxasPorConsignataria);
            }

            taxasPorConsignataria.add(taxa);
        }

        //Agrupo regras de juros superiores ao limite informado por consignatária
        final Map<String, List<TransferObject>> consignatariasRegraTaxaJuros = new HashMap<>();
        if(aplicarRegraCETTaxaJuros) {
            for (final TransferObject regraJurosSuperior : lstRegraJurosSuperior) {
                final String csaCodigo = (String) regraJurosSuperior.getAttribute(Columns.CSA_CODIGO);

                List<TransferObject> regraTaxaJurosPorConsignataria = consignatariasRegraTaxaJuros.get(csaCodigo);
                if (regraTaxaJurosPorConsignataria == null) {
                    regraTaxaJurosPorConsignataria = new ArrayList<>();
                    consignatariasRegraTaxaJuros.put(csaCodigo, regraTaxaJurosPorConsignataria);
                }

                regraTaxaJurosPorConsignataria.add(regraJurosSuperior);
            }
        }


        final boolean temCET = ParamSist.paramEquals(CodedValues.TPC_TEM_CET, CodedValues.TPC_SIM, responsavel);

        final String nomeSistema = JspHelper.getNomeSistema(responsavel);
        // Dados necessários para envio do e-mail
        final String cseNome = getCseNome(responsavel);
        // Define o titulo do E-mail
        final String titulo = ApplicationResourcesHelper.getMessage("rotulo.email.alteracao.tabela.taxas.limite", responsavel, nomeSistema, cseNome);

        final ServicoDelegate svcDelegate = new ServicoDelegate();
        final TransferObject servico = svcDelegate.findServico(svcCodigo);
        final String svcDescricao = (servico != null) && !TextHelper.isNull(servico.getAttribute(Columns.SVC_DESCRICAO)) ? servico.getAttribute(Columns.SVC_DESCRICAO).toString() : "";


        //Consignatarias que receberao o email
        final List<String> consignatarias = new ArrayList<>(consignatariasPorTaxa.keySet());
        for(final String csaCodigo : consignatariasRegraTaxaJuros.keySet()) {
            if(!consignatarias.contains(csaCodigo)) {
                consignatarias.add(csaCodigo);
            }
        }

        for (final String csaCodigo : consignatarias) {
            // Recupera o endereço de e-mail do cadastro da consignatária.
            final ConsignatariaTransferObject consignataria = new ConsignatariaDelegate().findConsignataria(csaCodigo, responsavel);
            final String emailDestino = consignataria.getCsaEmail();
            final String csaNome = !TextHelper.isNull(consignataria.getCsaNomeAbreviado()) ? consignataria.getCsaNomeAbreviado() : consignataria.getCsaNome();

            // Se não tem e-mail não faz nada
            if (TextHelper.isNull(emailDestino)) {
                continue;
            }

            // Texto Comum para todas as mensagems
            final StringBuilder corpoMensagem = new StringBuilder();
            corpoMensagem.append(ApplicationResourcesHelper.getMessage("mensagem.email.tabela.taxas.limite.alterada.atualize.dados", responsavel, DateHelper.toDateTimeString(dataFimVig)));

            corpoMensagem.append("<br>");
            corpoMensagem.append("<br><b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignataria.singular", responsavel)).append(":</b> ").append(csaNome);
            corpoMensagem.append("<br><b>").append(ApplicationResourcesHelper.getMessage("rotulo.servico.singular", responsavel)).append(":</b> ").append(svcDescricao);

            corpoMensagem.append("<br><br><b>" + ApplicationResourcesHelper.getMessage("mensagem.email.novo.limite.cadastrado", responsavel) + ":</b><br>");
            corpoMensagem.append("<table border=\"1\">");
            corpoMensagem.append("<tr><td><b>" + ApplicationResourcesHelper.getMessage("rotulo.prazo.singular", responsavel) + "</b></td><td><b>" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.maximo.permitido", responsavel) + "</b></td></tr>");

            final BigDecimal cftVlrLimite = new BigDecimal(limiteTaxaJuros.getAttribute(Columns.LTJ_JUROS_MAX).toString());
            final String prazoLimite = limiteTaxaJuros.getAttribute(Columns.LTJ_PRAZO_REF).toString();
            if (cftVlrLimite.signum() > 0) {
                corpoMensagem.append("<tr><td>" + prazoLimite + "</td><td>" + NumberHelper.format(cftVlrLimite.doubleValue(), NumberHelper.getLang()) + "</td></tr>");
            } else {
                corpoMensagem.append("<tr><td>" + prazoLimite + "</td><td>" + ApplicationResourcesHelper.getMessage("rotulo.email.ilimitado", responsavel) + "</td></tr>");
            }
            corpoMensagem.append("</table>");

            corpoMensagem.append("<br><br><b>" + ApplicationResourcesHelper.getMessage("mensagem.email.prazos.acima.limite.permitido.sao", responsavel) + ":</b><br>");

            corpoMensagem.append("<br/>\n<br/>\n");
            corpoMensagem.append("<table border=\"1\">");
            corpoMensagem.append("<tr>");
            corpoMensagem.append("<td><b>").append(ApplicationResourcesHelper.getMessage("rotulo.prazo.singular", responsavel)).append("</b></td>");
            if (temCET) {
                corpoMensagem.append("<td><b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.cet", responsavel)).append("</b></td>");
            } else {
                corpoMensagem.append("<td><b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.taxa.juros", responsavel)).append("</b></td>");
            }
            corpoMensagem.append("</tr>");

            final List<TransferObject> taxas = consignatariasPorTaxa.get(csaCodigo);
            if(!TextHelper.isNull(taxas)) {
                for (final TransferObject taxa : taxas) {
                    final BigDecimal cftVlr = new BigDecimal(taxa.getAttribute(Columns.CFT_VLR).toString());
                    final String prazo = taxa.getAttribute(Columns.PRZ_VLR).toString();
                    corpoMensagem.append("<tr>");
                    corpoMensagem.append("<td>").append(prazo + "</td>");
                    corpoMensagem.append("<td>").append(NumberHelper.format(cftVlr.doubleValue() - 0.01, NumberHelper.getLang()) + "</td>");
                    corpoMensagem.append("</tr>");
                }
            }
            corpoMensagem.append("</table>");
            corpoMensagem.append("<br/>\n<br/>\n");

            //Cria tabela que sera enviada no email com as regras de taxa de juros acima do limite
            if(aplicarRegraCETTaxaJuros) {
                corpoMensagem.append("<br><br><b>" + ApplicationResourcesHelper.getMessage("mensagem.email.prazos.regra.taxa.juros.acima.limite.permitido.sao", responsavel) + ":</b><br>");

                corpoMensagem.append("<br/>\n<br/>\n");
                corpoMensagem.append("<table border=\"1\">");
                corpoMensagem.append("<tr>");
                corpoMensagem.append("<td><b>").append(ApplicationResourcesHelper.getMessage("rotulo.prazo.inicial", responsavel)).append("</b></td>");
                corpoMensagem.append("<td><b>").append(ApplicationResourcesHelper.getMessage("rotulo.prazo.final", responsavel)).append("</b></td>");
                corpoMensagem.append("<td><b>").append(ApplicationResourcesHelper.getMessage("rotulo.funcao.singular", responsavel)).append("</b></td>");
                corpoMensagem.append("<td><b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.taxa.juros", responsavel)).append("</b></td>");

                corpoMensagem.append("</tr>");

                final List<TransferObject> regrasTaxaJuros = consignatariasRegraTaxaJuros.get(csaCodigo);
                if(!TextHelper.isNull(regrasTaxaJuros)) {
                    for (final TransferObject regraTaxaJuros : regrasTaxaJuros) {
                        final BigDecimal dtjTaxaJuros = new BigDecimal(regraTaxaJuros.getAttribute(Columns.DTJ_TAXA_JUROS).toString());
                        final String funcao = !TextHelper.isNull(regraTaxaJuros.getAttribute(Columns.FUN_CODIGO)) ? (String) regraTaxaJuros.getAttribute(Columns.FUN_CODIGO) : "-";
                        final String dtjFaixaPrazoIni = regraTaxaJuros.getAttribute(Columns.DTJ_FAIXA_PRAZO_INI).toString();
                        final String dtjFaixaPrazoFim = regraTaxaJuros.getAttribute(Columns.DTJ_FAIXA_PRAZO_FIM).toString();
                        corpoMensagem.append("<tr>");
                        corpoMensagem.append("<td>").append(dtjFaixaPrazoIni + "</td>");
                        corpoMensagem.append("<td>").append(dtjFaixaPrazoFim + "</td>");
                        corpoMensagem.append("<td>").append(funcao + "</td>");
                        corpoMensagem.append("<td>").append(NumberHelper.format(dtjTaxaJuros.doubleValue() - 0.01, NumberHelper.getLang()) + "</td>");
                        corpoMensagem.append("</tr>");
                    }
                }
                corpoMensagem.append("</table>");
                corpoMensagem.append("<br/>\n<br/>\n");
            }

            // Envia os emails.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(emailDestino, null, null, titulo, corpoMensagem.toString(), null, null);
        }
    }


    /**
     * envia e-mail de alerta ao responsável pelo processamento da folha de que data de upload de arquivo de retorno no sistema está próximo
     * ou já passou
     * @param destinatario - e-mail do destinatário
     * @param dataPrevistaRetorno - data prevista da importação de retorno
     * @param alertaAntesDiaCorte - define se é um e-mail de alerta antes ou após a data prevista
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailAlertaEnvioArquivosFolha(String destinatario, Date dataPrevistaRetorno, boolean alertaAntesDiaCorte, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailAlertaEnvioArquivosFolhaCommand command = new EnviarEmailAlertaEnvioArquivosFolhaCommand();
        command.setDestinatario(destinatario);
        command.setDataPrevistaRetorno(dataPrevistaRetorno);
        command.setAlertaAntesDiaCorte(alertaAntesDiaCorte);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * Envia e-mail para o servidor informando que a documentação enviada para aprovação de crédito eletrônico
     * foi reprovada. O corpo do e-mail deve conter os dados da solicitação e o motivo de reprovação informado
     * pela consignatária. O motivo informado pela consignatária deve especificar os documentos que foram reprovados.
     * @param destinatario E-mail do destinatário.
     * @param matricula Matrícula do servidor.
     * @param adeCodigo Código da autorização desconto.
     * @param motivoReprovacao Motivo de reprovação da documentação.
     * @param responsavel Responsável.
     * @throws ViewHelperException
     */
    public static final void enviarEmailReprovacaoDocumentacaoServidor(String destinatario, String adeCodigo, String motivoReprovacao, AcessoSistema responsavel) throws ViewHelperException {
        try {
            if (TextHelper.isNull(destinatario)) {
                throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
            }

            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);

            final String cseNome = getCseNome(responsavel);
            final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();

            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.email.credito.eletronico.documentacao.reprovada", responsavel, adeNumero), responsavel);

            final StringBuilder corpo = new StringBuilder();
            corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.seguem.dados.solicitacao.credito.eletronico.documentacao.reprovada", responsavel) + ": <br/>\n<br/>");
            corpo.append(gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel));
            corpo.append("<br/>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.email.credito.eletronico.documentacao.reprovada.motivo", responsavel, motivoReprovacao) + "</b>");
            corpo.append("<br/>\n<br/>\n");

            final String texto = titulo + "<br/>\n<br/>\n" + corpo.toString();

            // Envia o e-mail.
            new MailHelper().send(destinatario, null, null, titulo, texto, null);
        } catch (MessagingException | AutorizacaoControllerException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia e-mail com resumo de uma consignação
     * @param emailDestinatario
     * @param autdes
     * @param responsavel
     * @throws ViewHelperException
     */
    public final static void enviarEmailResumoConsignacao(String emailDestinatario, CustomTransferObject autdes, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(emailDestinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        // Recupera os dados necessários para montar o texto do e-mail
        final String cseNome = getCseNome(responsavel);
        final String adeNumero = autdes.getAttribute(Columns.ADE_NUMERO).toString();

        // Define o título do E-mail
        final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.email.resumo.consignacao", responsavel, adeNumero, responsavel.getNomeEntidade()), responsavel);

        final String corpo = "<b>"+ ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel) + "</b>"
                     + gerarTextoDetalheContratoParaEmail(autdes, cseNome, responsavel) + "<br/>\n";

        final String texto = titulo + "<br/>\n<br/>\n" + corpo;

        // Envia o e-mail.
        try {
            new MailHelper().send(emailDestinatario, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia e-mail com aviso de comunicações não lidas
     * @param emailDestinatario
     * @param autdes
     * @param responsavel
     * @throws ViewHelperException
     */
    public final static void enviarEmailComunicacaoNoaLida(String emailDestinatario, String destinatario, Long qtdComunicacoesNaoLidas, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(emailDestinatario)) {
            throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
        }

        // Recupera os dados necessários para montar o texto do e-mail
        final String cseNome = getCseNome(responsavel);

        // Define o título do E-mail
        final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.email.aviso.comunicacoes.nao.lidas", responsavel), responsavel);

        String corpo = null;
        if (qtdComunicacoesNaoLidas == 1) {
            corpo = ApplicationResourcesHelper.getMessage("mensagem.email.comunicacao.nao.lidas", responsavel, destinatario);
        } else {
            corpo = ApplicationResourcesHelper.getMessage("mensagem.email.comunicacoes.nao.lidas", responsavel, destinatario, String.valueOf(qtdComunicacoesNaoLidas));
        }

        final String texto = titulo + "<br/>\n<br/>\n" + corpo;

        // Envia o e-mail.
        try {
            new MailHelper().send(emailDestinatario, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     *
     * @param diasParam
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailAlertaRetornoServidor(List<Integer> diasParam, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailAlertaRetornoServidorCommand command = new EnviarEmailAlertaRetornoServidorCommand();
        command.setDiasParam(diasParam);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * Envia email para usuários caso haja contratos rejeitados pela folha
     * @param email
     * @param corpoEmail
     * @throws ViewHelperException
     */
    public static final void enviaEmailServidorContratosRejeitados (String email, String corpoEmail) throws ViewHelperException {
        final EnviarEmailServidorContratosRejeitadosCommand command = new EnviarEmailServidorContratosRejeitadosCommand();
        command.setEmail(email);
        command.setCorpoEmail(corpoEmail);
        command.execute();
    }

    /**
     * Envia por e-mail a informação do cancelamento do cadastro do servidor para as CSA's que possuem contratos com os mesmos.
     * @param rseCodigo
     * @param responsavel
     * @return
     */
    public static final void enviaEmailNotificacaoCsaCancelamentoCadastroServidor(TransferObject ade, AcessoSistema responsavel) {
        try {
            final EnviarEmailNotificacaoCsaCancelamentoCadastroServidorCommand command = new EnviarEmailNotificacaoCsaCancelamentoCadastroServidorCommand();
            command.setAde(ade);
            command.setResponsavel(responsavel);
            command.execute();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Monta o corpo do email e envia.
     * @param totalContratoAtivosMensalidadePlanoSaude
     * @param totalContratoAtivosMensalidadeOdotologico
     * @param listaContratoNoSistemaNaoConciliacaoPlanoSaude
     * @param listaContratoNaoSistemaNoConciliacaoPlanoSaude
     * @param listaContratoNoSistemaNaoConciliacaoOdontologico
     * @param listaContratoNaoSistemaNoConciliacaoOdontologico
     */
    public static final void enviaEmailConciliacaoBeneficio(String csaCodigo, int totalContratoAtivosMensalidadePlanoSaude, int totalContratoAtivosMensalidadeOdotologico,
            List<String> listaContratoNoSistemaNaoConciliacaoPlanoSaude, List<String> listaContratoNaoSistemaNoConciliacaoPlanoSaude,
            List<String> listaContratoNoSistemaNaoConciliacaoOdontologico, List<String> listaContratoNaoSistemaNoConciliacaoOdontologico, AcessoSistema responsavel) {
        try {
            // Define o título do E-mail
            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.relatorio.conciliacao.beneficio", responsavel);

            if(titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel)+" - ");
            }
            if(titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel)+ " - ");
            }
            if(titulo.contains("<TITULO>")) {
                titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.relatorio.conciliacao.beneficio", responsavel));
            }

            //Texto com os detalhes do servidor.
            final ConsignatariaDelegate csaDelegate = new ConsignatariaDelegate();
            final ConsignatariaTransferObject csaTO = csaDelegate.findConsignataria(csaCodigo, responsavel);
            String textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.operadora.relatorio.conciliacao.beneficio", responsavel, csaTO.getCsaNome());
            textoGeral = "<b>" + textoGeral +"</b><br><br>\n" + ApplicationResourcesHelper.getMessage("mensagem.email.corpo.relatorio.conciliacao.beneficio", responsavel);

            if (textoGeral.contains("<TOTAL_MENSALIDADE_PLANO_SAUDE>")) {
                textoGeral = textoGeral.replace("<TOTAL_MENSALIDADE_PLANO_SAUDE>", String.valueOf(totalContratoAtivosMensalidadePlanoSaude));
            }

            if (textoGeral.contains("<TOTAL_MENSALIDADE_ODONTOLOGICO>")) {
                textoGeral = textoGeral.replace("<TOTAL_MENSALIDADE_ODONTOLOGICO>", String.valueOf(totalContratoAtivosMensalidadeOdotologico));
            }

            if (textoGeral.contains("<TOTAL_EXISTE_SISTEMA_NAO_EXISTE_ARQUIVO_SAUDE>")) {
                textoGeral = textoGeral.replace("<TOTAL_EXISTE_SISTEMA_NAO_EXISTE_ARQUIVO_SAUDE>", String.valueOf(listaContratoNoSistemaNaoConciliacaoPlanoSaude.size()));
            }
            StringBuilder tmp = geraTextoListaConciliacaoBeneficio(listaContratoNoSistemaNaoConciliacaoPlanoSaude, responsavel);
            textoGeral = textoGeral.replace("<LINHA_EXISTE_SISTEMA_NAO_EXISTE_ARQUIVO_SAUDE>", tmp.toString());

            if (textoGeral.contains("<TOTAL_NAO_EXISTE_SISTEMA_EXISTE_ARQUIVO_SAUDE>")) {
                textoGeral = textoGeral.replace("<TOTAL_NAO_EXISTE_SISTEMA_EXISTE_ARQUIVO_SAUDE>", String.valueOf(listaContratoNaoSistemaNoConciliacaoPlanoSaude.size()));
            }
            tmp = geraTextoListaConciliacaoBeneficio(listaContratoNaoSistemaNoConciliacaoPlanoSaude, responsavel);
            textoGeral = textoGeral.replace("<LINHA_NAO_EXISTE_SISTEMA_EXISTE_ARQUIVO_SAUDE>", tmp.toString());

            if (textoGeral.contains("<TOTAL_EXISTE_SISTEMA_NAO_EXISTE_ARQUIVO_ODONTOLOGICO>")) {
                textoGeral = textoGeral.replace("<TOTAL_EXISTE_SISTEMA_NAO_EXISTE_ARQUIVO_ODONTOLOGICO>", String.valueOf(listaContratoNoSistemaNaoConciliacaoOdontologico.size()));
            }
            tmp = geraTextoListaConciliacaoBeneficio(listaContratoNoSistemaNaoConciliacaoOdontologico, responsavel);
            textoGeral = textoGeral.replace("<LINHA_EXISTE_SISTEMA_NAO_EXISTE_ARQUIVO_ODONTOLOGICO>", tmp.toString());

            if (textoGeral.contains("<TOTAL_NAO_EXISTE_SISTEMA_EXISTE_ARQUIVO_ODONTOLOGICO>")) {
                textoGeral = textoGeral.replace("<TOTAL_NAO_EXISTE_SISTEMA_EXISTE_ARQUIVO_ODONTOLOGICO>", String.valueOf(listaContratoNaoSistemaNoConciliacaoOdontologico.size()));
            }
            tmp = geraTextoListaConciliacaoBeneficio(listaContratoNaoSistemaNoConciliacaoOdontologico, responsavel);
            textoGeral = textoGeral.replace("<LINHA_NAO_EXISTE_SISTEMA_EXISTE_ARQUIVO_ODONTOLOGICO>", tmp.toString());

            tmp = new StringBuilder();
            textoGeral = textoGeral.concat("<br>\n");

            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(EMAIL_OPERACAO_BENEFICIO, null, null, titulo, textoGeral, null);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * geraTextoListaConciliacaoBeneficio - Helper para gerar as linhas.
     * @param entrada
     * @return
     */
    private static StringBuilder geraTextoListaConciliacaoBeneficio(List<String> entrada, AcessoSistema responsavel) {
        final StringBuilder tmp = new StringBuilder();
        tmp.append("<br>\n");
        if ((entrada.size() > 0) && (entrada.size() < 101)) {
            for (final String linha : entrada) {
                tmp.append(linha);
                tmp.append("<br>\n");
            }
        } else if (entrada.size() > 101){
            tmp.append(ApplicationResourcesHelper.getMessage("mensagem.email.gentileza.consultar.relatorio.conciliacao.beneficio", responsavel));
        }

        return tmp;
    }

    /**
     * Envia no email os anexos do relatorio de Beneficiario e Concessoes de Beneficios
     * @param arquivosRelatorio
     * @param responsavel
     */
    public static final void enviaEmailRelatorioBeneficiariosEConcessoesDeBeneficios(List<String> arquivosRelatorio, AcessoSistema responsavel) {
        try {
            // Define o título do E-mail
            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.relatorio.beneficiarios.e.concessoes.de.beneficios", responsavel);

            if(titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel)+" - ");
            }
            if(titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel)+ " - ");
            }
            if(titulo.contains("<TITULO>")) {
                titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.relatorio.beneficiarios.e.concessoes.de.beneficios", responsavel));
            }

            // Texto do copo do email
            final String textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.relatorio.beneficiarios.e.concessoes.de.beneficios", responsavel);

            // Enviando o email.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(EMAIL_OPERACAO_BENEFICIO, null, null, titulo, textoGeral, arquivosRelatorio);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    public static final void enviaEmailConclusaoRelatorioBeneficioDirf(Date periodo, String orgNome, boolean inconsistencia, AcessoSistema responsavel) {
        try {
            // Define o título do E-mail
            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.relatorio.beneficios.consolidados.dirf", responsavel, orgNome);

            if(titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel)+" - ");
            }
            if(titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel)+ " - ");
            }
            if(titulo.contains("<TITULO>")) {
                titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.relatorio.beneficios.consolidados.dirf", responsavel));
            }

            // Texto do copo do email
            String textoGeral = null;
            if (!inconsistencia) {
                textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.relatorio.beneficios.consolidados.dirf", responsavel, DateHelper.format(periodo, "MM/yyyy"), orgNome);
            } else {
                textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.relatorio.beneficios.consolidados.dirf.com.inconsistencia", responsavel, DateHelper.format(periodo, "MM/yyyy"), orgNome);
            }

            // Enviando o email.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(EMAIL_OPERACAO_BENEFICIO, null, null, titulo, textoGeral, null);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail para a consignatária informando que os convênios com o serviço informado no parâmetro "svcDescricao"
     * foram bloqueados pois expiraram na data informada em "pscVlr".
     * @param csaNome
     * @param csaEmail
     * @param svcIdentificador
     * @param svcDescricao
     * @param pscVlr
     * @param responsavel
     */
    public static final void enviarEmailBloqueioConvenioExpirado(String csaNome, String csaEmail, String svcIdentificador, String svcDescricao, String pscVlr, AcessoSistema responsavel) {
        try {
            if (!TextHelper.isNull(csaEmail)) {
                final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.convenio.expirado.bloqueado.assunto", responsavel, svcDescricao), responsavel);
                final String texto = ApplicationResourcesHelper.getMessage("mensagem.email.convenio.expirado.bloqueado.corpo", responsavel, csaNome, svcDescricao, pscVlr) + "<br>\n"
                        + "<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.consignante.singular", responsavel) + ": " + getCseNome(responsavel)
                        + "<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.servico.singular", responsavel) + ": " + svcDescricao + " - " + svcIdentificador
                        ;

                new MailHelper().send(csaEmail, null, null, titulo, texto, null);
            }
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail para o servidor informando que foi solicitado o cancelamento do contrato de benefício
     * @param serEmail
     * @param bfcNome
     * @param benDescricao
     * @param responsavel
     */
    public static final void enviarEmailContratoBeneficioCancelamento(String serEmail, String bfcNome, String benDescricao, String bfcCpf, String csaNome, AcessoSistema responsavel) {
        try {
            final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.contrato.beneficio.cancelado.titulo", responsavel, benDescricao) , responsavel);
            final String texto = ApplicationResourcesHelper.getMessage("mensagem.email.contrato.beneficio.cancelado.corpo", responsavel, csaNome, bfcNome, bfcCpf, benDescricao) + "<br>\n";

            new MailHelper().send(serEmail, null, null, titulo, texto, null);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia no email os anexos do relatorio de Beneficiario e Concessoes de Beneficios
     * @param arquivosExportados
     * @param responsavel
     */
    public static final void enviaEmailExportacaoArquivosDeIntegracaoOperadora(List<String> arquivosExportados, AcessoSistema responsavel) {
        try {
            // Define o título do E-mail
            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.exportacao.arquivo.operadora.beneficio", responsavel);

            if(titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel)+" - ");
            }
            if(titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel)+ " - ");
            }
            if(titulo.contains("<TITULO>")) {
                titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.exportacao.arquivo.operadora.beneficio", responsavel));
            }

            // Texto do copo do email
            final String textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.exportacao.arquivo.operadora.beneficio", responsavel);

            // Enviando o email.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(EMAIL_OPERACAO_BENEFICIO, null, null, titulo, textoGeral, arquivosExportados);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia no email retortando importação com sucesso ou não.
     * @param arquivosExportados
     * @param responsavel
     */
    public static final void enviaEmailImportacaoArquivosOperadora(String nomeArquivoRetorno, String nomeArquivoCritica, String csaNome, int totalLinhasCriticas, AcessoSistema responsavel) {
        try {
            // Define o título do E-mail
            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.importacao.arquivo.operadora.beneficio", responsavel);

            if (titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel) + " - ");
            }
            if (titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel) + " - ");
            }
            if (titulo.contains("<TITULO>")) {
                if (totalLinhasCriticas != 0) {
                    titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.importacao.arquivo.operadora.beneficio.ressalva", responsavel));
                } else {
                    titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.importacao.arquivo.operadora.beneficio.sucesso", responsavel));

                }
            }

            titulo = titulo.replace("<CSA_NOME>", csaNome);

            // Texto do copo do email
            String textoGeral;
            if (totalLinhasCriticas != 0) {
                textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.importacao.arquivo.operadora.beneficio.ressalva", responsavel);
                textoGeral = textoGeral.replace("<NOME_ARQUIVO_CRITICA>", nomeArquivoCritica);
            } else {
                textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.importacao.arquivo.operadora.beneficio.sucesso", responsavel);
            }

            textoGeral = textoGeral.replace("<NOME_ARQUIVO>", nomeArquivoRetorno);

            // Enviando o email.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(EMAIL_OPERACAO_BENEFICIO, null, null, titulo, textoGeral, null);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Método que aciona a classe "Command" para que seja enviado o email de
     * notificação.
     */
    public static final void enviaNotificacaoUsuariosPorTempoInatividade() {

        final EnviarNotificacaoBloqueioUsuarioInatividadeCommand enviaNotificacaoUsuarioInatividade = new EnviarNotificacaoBloqueioUsuarioInatividadeCommand();
        try {
            enviaNotificacaoUsuarioInatividade.execute();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }

    }


    /**
     * Envia email para servidor/funcionário informando que sua consignação foi deferida.
     * @param csaNome
     * @param emailDestinatario
     * @param adeNumero
     * @param responsavel
     */
    public static final void enviaEmailNotificacaoConsignacaoDeferida(String csaNome, String emailDestinatario, String adeNumero, String corpo, AcessoSistema responsavel) {
        final EnviarEmailNotificacaoConsignacaoDeferidaCommand enviarEmailNotificacaoConsignacaoDeferida = new EnviarEmailNotificacaoConsignacaoDeferidaCommand();
        enviarEmailNotificacaoConsignacaoDeferida.setEmailDestinatario(emailDestinatario);
        enviarEmailNotificacaoConsignacaoDeferida.setCsaNome(csaNome);
        enviarEmailNotificacaoConsignacaoDeferida.setAdeNumero(adeNumero);
        enviarEmailNotificacaoConsignacaoDeferida.setCorpo(corpo);
        enviarEmailNotificacaoConsignacaoDeferida.setResponsavel(responsavel);

        try {
            enviarEmailNotificacaoConsignacaoDeferida.execute();
        } catch (final ViewHelperException ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia email de notificação referente à alteração do código da verba do convênio da CSA
     * @param email
     * @param corpoEmail
     * @throws ViewHelperException
     */
    public static final void enviaNotifAlterCodVerbaConvCSA (AcessoSistema responsavel, String email, List<TransferObject> conveniosAnteriores
            , List<TransferObject> conveniosAtuais, String svcCodigo, String svcDescricao) throws ViewHelperException {

        if (TextHelper.isNull(email)) {
            LOG.info("Não existe usuário a ser notificado.");
            return;
        }
        final String servico = svcDescricao;
        final StringBuilder listaAtivado = new StringBuilder();
        final StringBuilder listaDesativado = new StringBuilder();
        final StringBuilder listaCodVerbaAlterado = new StringBuilder();

        List<TransferObject> conveniosA = null;
        List<TransferObject> conveniosD = null;
        if ((conveniosAnteriores != null) && (conveniosAtuais!=null)){
            conveniosA = conveniosAnteriores;
            conveniosD = conveniosAtuais;

            CustomTransferObject ca = null;
            final Iterator<TransferObject> it = conveniosA.iterator();

            CustomTransferObject cd = null;
            final Iterator<TransferObject> itD = conveniosD.iterator();

            while (it.hasNext() && itD.hasNext()) {
                ca = (CustomTransferObject)it.next();
                cd = (CustomTransferObject)itD.next();
                //verifica se o estabelecimento/orgao anterior é igual ao estabelecimento/orgao atual
                final String estabAnt = ca.getAttribute(Columns.EST_IDENTIFICADOR).toString()+" - "+ca.getAttribute(Columns.ORG_NOME).toString()+" - "+ca.getAttribute(Columns.ORG_IDENTIFICADOR).toString();
                final String estabAtu = cd.getAttribute(Columns.EST_IDENTIFICADOR).toString()+" - "+cd.getAttribute(Columns.ORG_NOME).toString()+" - "+cd.getAttribute(Columns.ORG_IDENTIFICADOR).toString();
                if (estabAnt.equals(estabAtu)) {
                    //Monta lista de convênios ativados e desativados
                    final String scvCodigoAnt = ca.getAttribute("STATUS").toString();
                    final String scvCodigoNov = cd.getAttribute("STATUS").toString();
                    final String listaOrgao = ca.getAttribute(Columns.EST_IDENTIFICADOR).toString()+" - "+ca.getAttribute(Columns.ORG_NOME).toString()+" - "+ca.getAttribute(Columns.ORG_IDENTIFICADOR).toString();
                    if (!scvCodigoAnt.equals(scvCodigoNov)) {
                        if ("1".equals(scvCodigoNov)) {
                            listaAtivado.append("<br>" + listaOrgao + ": "+ ApplicationResourcesHelper.getMessage("rotulo.corpo.email.codVerba.servico.listaAtivado", responsavel) +"; ");
                        }else {
                            listaDesativado.append("<br>" + listaOrgao +": "+ ApplicationResourcesHelper.getMessage("rotulo.corpo.email.codVerba.servico.listaDesativado", responsavel) + "; ");
                        }
                    }
                    //monta lista de codigo de verba alterado
                    final String cnvCodVerbaAnt = ca.getAttribute(Columns.CNV_COD_VERBA) != null ? ca.getAttribute(Columns.CNV_COD_VERBA).toString() : "";
                    final String cnvCodVerbaRefAnt = ca.getAttribute(Columns.CNV_COD_VERBA_REF) != null ? ca.getAttribute(Columns.CNV_COD_VERBA_REF).toString() : "";
                    final String cnvCodVerbaDep = cd.getAttribute(Columns.CNV_COD_VERBA) != null ? cd.getAttribute(Columns.CNV_COD_VERBA).toString() : "";
                    final String cnvCodVerbaRefDep = cd.getAttribute(Columns.CNV_COD_VERBA_REF) != null ? cd.getAttribute(Columns.CNV_COD_VERBA_REF).toString() : "";
                    if (!cnvCodVerbaAnt.equals(cnvCodVerbaDep) || !cnvCodVerbaRefAnt.equals(cnvCodVerbaRefDep)) {
                        listaCodVerbaAlterado.append("<br>" + listaOrgao + ": " + ApplicationResourcesHelper.getMessage("rotulo.corpo.email.codVerba.servico.convenioAlterado.de", responsavel)
                          + " " + cnvCodVerbaAnt + " " + cnvCodVerbaRefAnt + " " + ApplicationResourcesHelper.getMessage("rotulo.corpo.email.codVerba.servico.convenioAlterado.para", responsavel)
                          + " " + cnvCodVerbaDep + " " + cnvCodVerbaRefDep +"; ");
                    }
                }
            }
            final EnviarEmailNotifAlterCodVerbaConvCsaCommand command = new EnviarEmailNotifAlterCodVerbaConvCsaCommand();
            command.setEmail(email);
            command.setServico(servico);
            command.setListaAtivado(listaAtivado);
            command.setListaDesativado(listaDesativado);
            command.setListaCodVerbaAlterado(listaCodVerbaAlterado);
            command.setResponsavel(responsavel);
            command.execute();
        }
    }

    /**
     * Envia e-mail de alerta de download não realizado de movimento financeiro.
     * ou já passou
     * @param listaArquivoMovFinSemDownload - listagem de arquivos de movimento financeiro que não foram baixados
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailDownloadNaoRealizadoMovFin(List<TransferObject> listaArquivoMovFinSemDownload, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailDownloadNaoRealizadoMovFinCommand command = new EnviarEmailDownloadNaoRealizadoMovFinCommand();
        command.setListaArquivoMovFinSemDownload(listaArquivoMovFinSemDownload);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * Envia e-mail de notificação de envio ao sistema de novo boleto para o servidor
     * @param serEmail
     * @param remetente
     * @param servidor
     * @param conteudoArquivoPdf
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailNovoBoletoServidor(String serEmail, String remetente, TransferObject servidor, byte[] conteudoArquivoPdf, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailNovoBoletoServidorCommand command = new EnviarEmailNovoBoletoServidorCommand();
        command.setSerEmail(serEmail);
        command.setRemetente(remetente);
        command.setServidor(servidor);
        command.setConteudoArquivoPdf(conteudoArquivoPdf);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * E-mail enviado a um usuário do sistema eConsig para validação do email
     * @param destinatario E-mail do destinatário.
     * @param usuNome - Nome do novo usuário criado
     * @param entNome - Nome da entidade à qual pertence o usuário
     * @param link link a que direciona à página de confirmação de validação
     * @param responsavel
     * @throws ViewHelperException
     */
     public static final void enviarEmailLinkValidarEmailusuario(String destinatario, String usuNome, String link, AcessoSistema responsavel) throws ViewHelperException {
         if (TextHelper.isNull(destinatario)) {
             throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
         }

         final String nomeSistema = JspHelper.getNomeSistema(responsavel);
         final String cseNome = getCseNome(responsavel);
         final String titulo =  ApplicationResourcesHelper.getMessage("rotulo.validaemail.titulo.assunto", responsavel, nomeSistema, cseNome);

         link = "<a href='" + link + "'>" + link + "</a>";

         final String corpo = ApplicationResourcesHelper.getMessage("mensagem.validaemail.link.confirmacao", responsavel, usuNome, link);

         final String texto = titulo + "<br/>\n<br/>\n" + corpo;

         // Envia o e-mail.
         try {
             new MailHelper().send(destinatario, null, null, titulo, texto, null);
         } catch (final MessagingException e) {
             throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
         }
     }


     public static final void enviarEmailErroReativacaoAutomatica(TransferObject ade, String emailDestinatario, String nomeDestinatario, String dataReativacaoAut, String mensagemErro, AcessoSistema responsavel) {
         try {
             if (TextHelper.isNull(emailDestinatario)) {
                 throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
             }

             if (ade != null) {
                 // Obtém os dados da consignação
                 final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
                 final String cseNome = getCseNome(responsavel);

                 // Define o titulo do E-mail
                 final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.erro.reativao.automatica.consignacao.resumo", responsavel, adeNumero), responsavel);

                 // Texto com os dados do contrato
                 final String texto = ApplicationResourcesHelper.getMessage("mensagem.email.erro.reativao.automatica.consignacao.detalhe", responsavel, nomeDestinatario, dataReativacaoAut, mensagemErro)
                         + "<br/>\n<br/>\n"
                         + ApplicationResourcesHelper.getMessage("mensagem.email.abaixo.seguem.dados.consignacao", responsavel)
                         + gerarTextoDetalheContratoParaEmail(ade, cseNome, responsavel)
                         + "<br/>\n<br/>\n"
                         ;

                 final MailHelper mailHelper = new MailHelper();
                 mailHelper.send(emailDestinatario, null, null, titulo, texto, null);
             }
         } catch (final Exception ex) {
             LOG.error(ex.getMessage(), ex);
         }
     }

     /**
      * DESENV-13123 - Envia email das ades autorizadas pelo servidor para o cse
      * @param nomeServidor
      * @param estabelecimento
      * @param orgao
      * @param cpf
      * @param tabela
      * @param responsavel
      * @throws ViewHelperException
      */
     public static final void enviarEmailAutorizarConsignacao(String nomeServidor, String estabelecimento, String orgao, String cpf, String tabela, AcessoSistema responsavel) throws ViewHelperException {
         try {
             final ConsignanteDelegate cseDelegate = new ConsignanteDelegate();
             final ConsignanteTransferObject cse = cseDelegate.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);
             final String destinatario = cse.getCseEmailFolha();

             if (TextHelper.isNull(destinatario)) {
                 throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
             }

             final String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.autorizar.titulo", responsavel, nomeServidor);

             final String corpo = ApplicationResourcesHelper.getMessage("mensagem.email.autorizar.corpo", responsavel, estabelecimento, orgao, nomeServidor, cpf, tabela);

             // Envia o e-mail.
             new MailHelper().send(destinatario, null, null, titulo, corpo, null);
         } catch (final MessagingException e) {
             throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
         } catch (final ConsignanteControllerException ex) {
             LOG.error(ex.getMessage(), ex);
             throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, ex);
         }
     }

     /**
      * E-mail recuperação de senha usuário servidor
      * @param destinatario E-mail do destinatário.
      * @param serNome - Nome do Servidor
      * @param link - Link de Recuperação de Senha
      * @param responsavel
      * @throws ViewHelperException
      */

     public static final void enviarLinkRecuperacaoSenhaServidor(String serEmail, String serPrimeiroNome, String link, AcessoSistema responsavel) throws ViewHelperException {
         final EnviarLinkRecurepacaoSenhaServidorCommand command = new EnviarLinkRecurepacaoSenhaServidorCommand();
         command.setSerEmail(serEmail);
         command.setSerPrimeirNome(serPrimeiroNome);
         command.setLink(link);
         command.setResponsavel(responsavel);
         command.execute();
     }

     public static final void enviarCadastroSenhaServidor(String serEmail, String serPrimeiroNome, List<String> anexos, AcessoSistema responsavel) throws ViewHelperException {
         final EnviarEmailNotificacaoCadastroSenhaServidorCommand command = new EnviarEmailNotificacaoCadastroSenhaServidorCommand();
         command.setSerEmail(serEmail);
         command.setSerPrimeirNome(serPrimeiroNome);
         command.setResponsavel(responsavel);
         command.setAnexos(anexos);
         command.execute();
     }

     public static final void enviarEmailConfirmacaoOperacaoSensivel(EmailAlteracaoOperacaoSensivel email, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailAlteracaoOperacaoSensivelCommand command = new EnviarEmailAlteracaoOperacaoSensivelCommand();
        command.setEmail(email);
        command.setConfirmacaoOperacaoSensivel(true);
        command.setResponsavel(responsavel);
        command.execute();
    }

    public static final void enviarEmailReprovacaoOperacaoSensivel(EmailAlteracaoOperacaoSensivel email, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailAlteracaoOperacaoSensivelCommand command = new EnviarEmailAlteracaoOperacaoSensivelCommand();
        command.setEmail(email);
        command.setConfirmacaoOperacaoSensivel(false);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * Envia por e-mail a informação de que houve erro na tentativa de executar o KYC pelo servidor.
     * @param rseCodigo
     * @param responsavel
     * @return
     */
    public static final void enviaEmailNotificacaoCsaErroKYC(String csaCodigo, String panNumber, String status, AcessoSistema responsavel) {
        try {
            final EnviarEmailNotificacaoCsaErroKYCCommand command = new EnviarEmailNotificacaoCsaErroKYCCommand();
            command.setCsaCodigo(csaCodigo);
            command.setPanNumber(panNumber);
            command.setStatus(status);
            command.setResponsavel(responsavel);
            command.execute();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail à consignatária identificada pelo parâmetro "csaCodigo" informando que uma nova consignação
     * foi criada para pagamento do saldo devedor da ADE representada pelo parâmetro "adeCodigo" utilizando a
     * verba rescisória do colaborador.
     * @param csaCodigo
     * @param adeCodigo
     * @param responsavel
     * @throws ZetraException
     * @throws MessagingException
     */
    public static final void enviarEmailCsaNovoContratoVerbaRescisoria(String csaCodigo, String adeCodigo, AcessoSistema responsavel) {
        try {
            // Busca as informações do novo contrato criado para abater o saldo devedor na verba rescisória
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            if (ade == null) {
                return;
            }

            // Recupera o endereço de e-mail da consignatária que deve realizar o deferimento
            final ConsignatariaTransferObject consignataria = new ConsignatariaDelegate().findConsignataria(csaCodigo, responsavel);
            final String emailDestino = consignataria.getCsaEmail();

            // Se não tem e-mail não faz nada
            if (TextHelper.isNull(emailDestino)) {
                return;
            }

            // Dados necessários para envio do e-mail
            final String rseMatricula = ade.getAttribute(Columns.RSE_MATRICULA) != null ? ade.getAttribute(Columns.RSE_MATRICULA).toString() : "";
            final String serNome =  ade.getAttribute(Columns.SER_NOME) != null ? ade.getAttribute(Columns.SER_NOME).toString() : "";
            final String serCpf = ade.getAttribute(Columns.SER_CPF) != null ? ade.getAttribute(Columns.SER_CPF).toString() : "";
            final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO) != null ? ade.getAttribute(Columns.ADE_NUMERO).toString() : "";
            final String adeVlr = ade.getAttribute(Columns.ADE_VLR) != null ? NumberHelper.format(((BigDecimal) ade.getAttribute(Columns.ADE_VLR)).doubleValue(), NumberHelper.getLang(), true) : "";
            final String adeData = ade.getAttribute(Columns.ADE_DATA) != null ? DateHelper.toDateTimeString((Date) ade.getAttribute(Columns.ADE_DATA)) : "";

            // Define o titulo do E-mail
            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.novo.contrato.verba.rescisoria", responsavel);
            if(titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel)+" - ");
            }
            if(titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel)+ " - ");
            }
            if(titulo.contains("<TITULO>")) {
                titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.novo.contrato.verba.rescisoria", responsavel));
            }

            // Texto do corpo do e-mail
            String textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.novo.contrato.verba.rescisoria", responsavel);

            if (textoGeral.contains("<DETALHE_CONTRATO>")) {
                final StringBuilder detalhe = new StringBuilder();
                detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.servidor", responsavel, rseMatricula, serNome));
                detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.cpf", responsavel, serCpf));
                detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.numero.ade", responsavel, adeNumero));
                detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.data.inclusao", responsavel, adeData));
                detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.prestacao", responsavel, adeVlr));
                detalhe.append("<br/>\n<br/>\n");
                textoGeral = textoGeral.replace("<DETALHE_CONTRATO>", detalhe.toString());
            }

            // Envia o email.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(emailDestino, null, null, titulo, textoGeral.toString(), null, null);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail ao servidor identificado pelo parâmetro "rseCodigo" informando que uma nova consignação
     * foi criada para pagamento do saldo devedor da ADE representada pelo parâmetro "adeCodigo" utilizando a
     * verba rescisória deste servidor
     * @param csaCodigo
     * @param adeCodigo
     * @param responsavel
     * @throws ZetraException
     * @throws MessagingException
     */
    public static final void enviarEmailSerNovoContratoVerbaRescisoria(String rseCodigo, String adeCodigo, AcessoSistema responsavel) {
        try {
            // Busca as informações do novo contrato criado para abater o saldo devedor na verba rescisória
            final PesquisarConsignacaoController pesquisarConsignacaoController = ApplicationContextProvider.getApplicationContext().getBean(PesquisarConsignacaoController.class);
            final TransferObject ade = pesquisarConsignacaoController.buscaAutorizacao(adeCodigo, responsavel);
            if (ade == null) {
                LOG.info("Não encontrado contrato para notificação");
                return;
            }

            // Recupera o endereço de e-mail da consignatária que deve realizar o deferimento
            final ServidorController servidorContorller = ApplicationContextProvider.getApplicationContext().getBean(ServidorController.class);
            final ServidorTransferObject servidor = servidorContorller.findServidorByRseCodigo(rseCodigo, responsavel);
            final String emailDestino = servidor.getSerEmail();

            // Se não tem e-mail não faz nada
            if (TextHelper.isNull(emailDestino)) {
                LOG.info("Não existe email cadastrado do registro servidor para envio: " + rseCodigo);
                return;
            }

            // Dados necessários para envio do e-mail
            final String rseMatricula = ade.getAttribute(Columns.RSE_MATRICULA) != null ? ade.getAttribute(Columns.RSE_MATRICULA).toString() : "";
            final String serNome =  ade.getAttribute(Columns.SER_NOME) != null ? ade.getAttribute(Columns.SER_NOME).toString() : "";
            final String serCpf = ade.getAttribute(Columns.SER_CPF) != null ? ade.getAttribute(Columns.SER_CPF).toString() : "";
            final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO) != null ? ade.getAttribute(Columns.ADE_NUMERO).toString() : "";
            final BigDecimal adeVlr = ade.getAttribute(Columns.ADE_VLR) != null ? (BigDecimal) ade.getAttribute(Columns.ADE_VLR) : BigDecimal.ZERO;
            final Date adeData = ade.getAttribute(Columns.ADE_DATA) != null ? (Date) ade.getAttribute(Columns.ADE_DATA) : null;

            final EnviarEmailNovoContratoVerbaRescisoriaSerCommand command = new EnviarEmailNovoContratoVerbaRescisoriaSerCommand();
            command.setEmail(emailDestino);
            command.setRseMatricula(rseMatricula);
            command.setSerNome(serNome);
            command.setSerCpf(serCpf);
            command.setAdeNumero(adeNumero);
            command.setAdeData(adeData);
            command.setAdeVlr(adeVlr);
            command.execute();

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail ao colaborador envolvido em um processo de rescisão de contrato de trabalho informando os dados
     * das consignações que possuem saldo devedor.
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    public static final void enviarEmailServidorDemitidoSaldoDevedor(String serEmail, List<TransferObject> contratosComSaldoDevedor, AcessoSistema responsavel) {
        try {
            if ((contratosComSaldoDevedor == null) || contratosComSaldoDevedor.isEmpty()) {
                return;
            }
            // Define o titulo do E-mail
            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.colaborador.rescisao.saldo.devedor", responsavel);
            if(titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel)+" - ");
            }
            if(titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel)+ " - ");
            }
            if(titulo.contains("<TITULO>")) {
                titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.colaborador.rescisao.saldo.devedor", responsavel));
            }

            // Texto do corpo do e-mail
            String textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.colaborador.rescisao.saldo.devedor", responsavel);

            if (textoGeral.contains("<DETALHE_CONTRATO>")) {
                final StringBuilder detalhe = new StringBuilder();
                for (final TransferObject ade : contratosComSaldoDevedor) {
                    // Dados necessários para envio do e-mail
                    final String csaNome =  ade.getAttribute(Columns.CSA_NOME) != null ? ade.getAttribute(Columns.CSA_NOME).toString() : "";
                    final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO) != null ? ade.getAttribute(Columns.ADE_NUMERO).toString() : "";
                    final String adeVlr = ade.getAttribute(Columns.ADE_VLR) != null ? NumberHelper.format(((BigDecimal) ade.getAttribute(Columns.ADE_VLR)).doubleValue(), NumberHelper.getLang(), true) : "";
                    final String adeData = ade.getAttribute(Columns.ADE_DATA) != null ? DateHelper.toDateTimeString((Date) ade.getAttribute(Columns.ADE_DATA)) : "";

                    detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.numero.ade", responsavel, adeNumero));
                    detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.data.inclusao", responsavel, adeData));
                    detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.prestacao", responsavel, adeVlr));
                    detalhe.append("<br>\n" + ApplicationResourcesHelper.getMessage("rotulo.email.consignataria", responsavel, csaNome));
                    detalhe.append("<br/>\n<br/>\n");
                }
                textoGeral = textoGeral.replace("<DETALHE_CONTRATO>", detalhe.toString());
            }

            // Envia o email.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(serEmail, null, null, titulo, textoGeral.toString(), null, null);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail e anexos para o caso de uso "mensagem de e-mail para a consignatária de destino para portabilidade"
     * @param mensagem
     * @param destinatario
     * @param arquivosAnexoEmail
     * @param responsavel
     */
    public static final void enviarEmailMensagemCsaCorPortabilidade(String mensagem, String destinatario, List<String> arquivosAnexoEmail, AcessoSistema responsavel) {
        try {
            // Define o título do E-mail
            String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.consignataria.destino.portabilidade", responsavel);

            if(titulo.contains("<NOME_SISTEMA>")) {
                titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel)+" - ");
            }
            if(titulo.contains("<NOME_CONSIGNANTE>")) {
                titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel)+ " - ");
            }
            if(titulo.contains("<TITULO>")) {
                titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.comunicacao.portabilidade.contrato", responsavel));
            }

            // Enviando o email.
            final MailHelper mailHelper = new MailHelper();
            mailHelper.send(destinatario, null, null, titulo, mensagem, arquivosAnexoEmail);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail o servidor quando a consignatária
     * deseja fazer um refinanciamento de parcelas ou redução.
     * @param saldoDevedorTO
     * @param responsavel
     * @return
     */
    public static final String enviarEmailRefinanciamentoParcela(String adeCodigo, String textoProposta, AcessoSistema responsavel) {
        try {

            // Busca o contrato informado
            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            if (ade != null) {
                // Verifica se o servidor possui e-mail cadastrado
                final String serEmail = ade.getAttribute(Columns.SER_EMAIL).toString();

                // Obtém os dados da consignação
                final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
                final String cseNome = getCseNome(responsavel);

                // Define o titulo do E-mail
                final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.email.saldo.devedor.refinanciamento.parcelas.titulo", responsavel, adeNumero), responsavel);

                // Busca os valores do saldo devedor cadastrados
                textoProposta += gerarTextoDetalheContratoParaEmail(ade,cseNome, responsavel) + "<br/>\n<br/>\n";

                // Define o texto do E-mail
                final String texto = "<br/>\n<br/>\n" + textoProposta;

                // Envia as mensagens.
                final MailHelper mailHelper = new MailHelper();
                mailHelper.send(serEmail, null, null, titulo, texto, null);
            }

            return "";
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            return ex.getMessage();
        }
    }

    public static final String enviarEmailSuporteDuvidaChatbot(String nome, String email, String duvida, AcessoSistema responsavel) {
        try {
            final String emailSuporte = (String) ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_SUPORTE_ZETRASOFT, responsavel);
            if (!TextHelper.isNull(emailSuporte)) {
                // Define o titulo do E-mail
                final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("mensagem.atendimento.chatbot.email.duvida.titulo", responsavel), responsavel);

                // Define o texto do E-mail
                //Texto contendo o comentário sobre o motivo do faq não ter sido útil.
                String textoGeral = "";
                if (!TextHelper.isNull(email)) {
                    textoGeral = ApplicationResourcesHelper.getMessage("", responsavel, nome, email, duvida);
                } else {
                    textoGeral = ApplicationResourcesHelper.getMessage("mensagem.atendimento.chatbot.email.duvida.texto.sem.email", responsavel, nome, duvida);
                }
                final String texto = titulo + "<br/>\n<br/>\n" + textoGeral;

                // Envia as mensagens.
                final MailHelper mailHelper = new MailHelper();
                mailHelper.send(emailSuporte, null, null, titulo, texto, null);
            }

            return "";
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            return ex.getMessage();
        }
    }

    /**
     * Envia e-mail para o servidor informando o código para autorizar desconto parcial.
     * @param destinatario E-mail do destinatário.
     * @param codAutorizacao Código de autorização da solicitação.
     * @param responsavel Responsável.
     * @throws ViewHelperException
     */
    public static final void enviarEmailCodigoAutorizarDescontoParcialSer(String destinatario, String codVerificacao, AcessoSistema responsavel) throws ViewHelperException {
        try {
            if (TextHelper.isNull(destinatario)) {
                throw new ViewHelperException("mensagem.informe.email.destinatario", responsavel);
            }

            final String cseNome = getCseNome(responsavel);
            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("rotulo.email.codigo.verificacao.email", responsavel), responsavel);

            final StringBuilder corpo = new StringBuilder();
            corpo.append(ApplicationResourcesHelper.getMessage("mensagem.email.codigo.autorizar.desconto.parcial.email", responsavel) + ": <br/>\n<br/>");
            corpo.append("<br/>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.email.codigo.autorizacao", responsavel, codVerificacao) + "</b>");
            corpo.append("<br/>\n<br/>\n");

            final String texto = titulo + "<br/>\n<br/>\n" + corpo.toString();

            // Envia o e-mail.
            new MailHelper().send(destinatario, null, null, titulo, texto, null);
        } catch (final MessagingException e) {
            throw new ViewHelperException ("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    public static final String enviarEmailAvaliacaoFaqNaoUtil(String nome, String email, String duvida, String entidade, String consignante,  AcessoSistema responsavel) {
        try {

            final String emailSuporte = (String) ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_SUPORTE_ZETRASOFT, responsavel);
            if (!TextHelper.isNull(emailSuporte)) {
                // Define o titulo do E-mail
            	//Comantário referente a avaliação do faq não útil feita pelo usuário.
                final String titulo = gerarTituloEmail(null, ApplicationResourcesHelper.getMessage("rotulo.email.avaliacao.faq.nao.util", responsavel), responsavel);

                // Define o texto do E-mail
                String textoGeral = "";
                if (!TextHelper.isNull(email)) {
                    textoGeral = ApplicationResourcesHelper.getMessage("mensagem.avaliacao.faq.email.duvida.texto", responsavel, nome, email, duvida);
                } else {
                    textoGeral = ApplicationResourcesHelper.getMessage("mensagem.avaliacao.faq.email.duvida.texto.sem.email", responsavel, nome, duvida);
                }
                final String texto = titulo + "<br/>\n<br/>\n" + textoGeral;

                // Envia as mensagens.
                final MailHelper mailHelper = new MailHelper();
                mailHelper.send(emailSuporte, null, null, titulo, texto, null);
            }

            return "";
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            return ex.getMessage();
        }
    }

    /**
     * Envia e-mail à equipe de segurança, com destinatário cadastrado em parâmetro de sistema, informando os usuários e/ou entidades
     * que foram bloqueados automaticamente por motivo de segurança por ultrapassarem os limites de operações de liberação de margem.
     * @param servidoresAfetados
     * @param usuariosBloqueados
     * @param servidoresBloqueados
     * @param csaCodigo
     */
    public static final void enviarEmailBloqueioAutomaticoSegurancaLiberacaoMargem(List<TransferObject> servidoresAfetados, List<TransferObject> usuariosBloqueados, List<TransferObject> servidoresBloqueados, String csaCodigo, AcessoSistema responsavel) {
        try {
            if ((servidoresAfetados != null) && !servidoresAfetados.isEmpty()) {
                // Recupera o endereço de e-mail para destinatário da mensagem
                final String destinatario = (String) ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_NOTIFICACAO_SEGURANCA, responsavel);
                // Se não tem e-mail configurado para receber notificações, interrompe o envio
                if (TextHelper.isNull(destinatario)) {
                    return;
                }

                // Define o titulo do E-mail
                String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.notificacao.bloqueio.automatico.seguranca", responsavel);
                if(titulo.contains("<NOME_SISTEMA>")) {
                    titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel) + " - ");
                }
                if(titulo.contains("<NOME_CONSIGNANTE>")) {
                    titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel) + " - ");
                }
                if(titulo.contains("<TITULO>")) {
                    titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.notificacao.bloqueio.automatico.seguranca", responsavel));
                }

                // Texto do corpo do e-mail
                String textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.notificacao.bloqueio.automatico.seguranca", responsavel);

                if (textoGeral.contains("<DETALHE_OPERACOES>")) {
                    final String detalheOperacoes = gerarTextoDetalheOperacoesLiberacaoMargem(servidoresAfetados, csaCodigo, responsavel);
                    textoGeral = textoGeral.replace("<DETALHE_OPERACOES>", detalheOperacoes.toString());
                }

                if (textoGeral.contains("<DETALHE_BLOQUEIO>")) {
                    final String detalheBloqueio = gerarTextoDetalheBloqueioAutomaticoSeguranca(usuariosBloqueados, servidoresBloqueados, responsavel);
                    textoGeral = textoGeral.replace("<DETALHE_BLOQUEIO>", detalheBloqueio);
                }
                // Envia o email.
                final MailHelper mailHelper = new MailHelper();
                mailHelper.send(destinatario, null, null, titulo, textoGeral.toString(), null, null);
            }
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia e-mail à equipe de segurança, com destinatário cadastrado em parâmetro de sistema, informando os usuários e/ou entidades
     * que atingiram os limites de operações de liberação de margem para notificação.
     * @param servidoresAfetados
     * @param csaCodigo
     */
    public static final void enviarEmailNotificacaoLimiteOperacoesLiberacaoMargem(List<TransferObject> servidoresAfetados, String csaCodigo, AcessoSistema responsavel) {
        try {
            if ((servidoresAfetados != null) && !servidoresAfetados.isEmpty()) {
                // Recupera o endereço de e-mail para destinatário da mensagem
                final String destinatario = (String) ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_NOTIFICACAO_SEGURANCA, responsavel);
                // Se não tem e-mail configurado para receber notificações, interrompe o envio
                if (TextHelper.isNull(destinatario)) {
                    return;
                }

                // Define o titulo do E-mail
                String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.notificacao.bloqueio.automatico.seguranca", responsavel);
                if(titulo.contains("<NOME_SISTEMA>")) {
                    titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel) + " - ");
                }
                if(titulo.contains("<NOME_CONSIGNANTE>")) {
                    titulo = titulo.replace("<NOME_CONSIGNANTE>", getCseNome(responsavel) + " - ");
                }
                if(titulo.contains("<TITULO>")) {
                    titulo = titulo.replace("<TITULO>", ApplicationResourcesHelper.getMessage("mensagem.email.assunto.notificacao.limite.operacoes.liberacao.margem", responsavel));
                }

                // Texto do corpo do e-mail
                String textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.notificacao.limite.operacao.liberacao.margem", responsavel);

                if (textoGeral.contains("<DETALHE_OPERACOES>")) {
                    final String detalheOperacoes = gerarTextoDetalheOperacoesLiberacaoMargem(servidoresAfetados, csaCodigo, responsavel);
                    textoGeral = textoGeral.replace("<DETALHE_OPERACOES>", detalheOperacoes.toString());
                }

                // Envia o email.
                final MailHelper mailHelper = new MailHelper();
                mailHelper.send(destinatario, null, null, titulo, textoGeral.toString(), null, null);
            }

        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Método auxiliar para geração do texto do e-mail com o detalhe dos usuários e entidades bloqueados.
     * @param usuCodigosBloqueados
     * @param rseCodigosBloqueados
     * @param responsavel
     * @return String com o texto informativo dos usuários/entidades bloqueados
     */
    private static String gerarTextoDetalheBloqueioAutomaticoSeguranca(List<TransferObject> usuariosBloqueados, List<TransferObject> servidoresBloqueados, AcessoSistema responsavel) {
        final StringBuilder detalhe = new StringBuilder();
        if ((usuariosBloqueados != null) && !usuariosBloqueados.isEmpty()) {
            detalhe.append("<br><b>\n<b>" + ApplicationResourcesHelper.getMessage("mensagem.email.detalhe.usuarios.bloqueio.automatico.seguranca.liberacao.margem", responsavel) + "</b>");
            detalhe.append("<br>\n");
            detalhe.append("<table border=\"1\">");
            detalhe.append("<tr>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.usuario.nome", responsavel) + "</b></td>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.usuario.login", responsavel) + "</b></td>");
            detalhe.append("</tr>");
            for (final TransferObject to : usuariosBloqueados) {
                final String usuNome = (String) to.getAttribute(Columns.USU_NOME);
                final String usuLogin = (String) to.getAttribute(Columns.USU_LOGIN);
                detalhe.append("<tr>");
                detalhe.append("<td>" + usuNome + "</td>");
                detalhe.append("<td>" + usuLogin + "</td>");
                detalhe.append("</tr>");
            }
            detalhe.append("</table>");
        }
        if ((servidoresBloqueados != null) && !servidoresBloqueados.isEmpty()) {
            detalhe.append("<br>\n<br>\n<b>" + ApplicationResourcesHelper.getMessage("mensagem.email.detalhe.servidores.bloqueio.automatico.seguranca.liberacao.margem", responsavel) + "</b>");
            detalhe.append("<br>\n");
            detalhe.append("<table border=\"1\">");
            detalhe.append("<tr>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.servidor.matricula", responsavel) + "</b></td>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.servidor.nome", responsavel) + "</b></td>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.servidor.cpf", responsavel) + "</b></td>");
            detalhe.append("</tr>");
            for (final TransferObject to : servidoresBloqueados) {
                final String rseMatricula = (String) to.getAttribute(Columns.RSE_MATRICULA);
                final String serNome = (String) to.getAttribute(Columns.SER_NOME);
                final String serCpf = (String) to.getAttribute(Columns.SER_CPF);
                detalhe.append("<tr>");
                detalhe.append("<td>" + rseMatricula + "</td>");
                detalhe.append("<td>" + serNome + "</td>");
                detalhe.append("<td>" + serCpf + "</td>");
                detalhe.append("</tr>");
            }
            detalhe.append("</table>");
        }
        return detalhe.toString();
    }

    /**
     * Método auxiliar para geração do texto do e-mail com o detalhe das operações de liberação de margem que geraram notificação de limite
     * de operações e/ou bloqueio de usuários e entidades.
     * @param rseCodigosAfetados
     * @param responsavel
     * @param csaCodigo
     * @return String com o texto informativo das operações de liberação de margem
     */
    private static String gerarTextoDetalheOperacoesLiberacaoMargem(List<TransferObject> rseCodigosAfetados, String csaCodigo, AcessoSistema responsavel) {
        final StringBuilder detalhe = new StringBuilder();
        try {
            detalhe.append("<br>\n<br>\n<b>" + ApplicationResourcesHelper.getMessage("mensagem.email.detalhe.notificacao.operacoes.liberacao.margem", responsavel) + "</b>");
            detalhe.append("<br>\n");
            detalhe.append("<table border=\"1\">");
            detalhe.append("<tr>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.servidor.matricula", responsavel) + "</b></td>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.servidor.nome", responsavel) + "</b></td>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.servidor.cpf", responsavel) + "</b></td>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.usuario.singular", responsavel) + "</b></td>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.usuario.login", responsavel) + "</b></td>");
            detalhe.append("<td><b>" + ApplicationResourcesHelper.getMessage("rotulo.usuario.entidade", responsavel) + "</b></td>");
            detalhe.append("</tr>");
            for (final TransferObject to : rseCodigosAfetados) {
                final String rseMatricula = (String) to.getAttribute(Columns.RSE_MATRICULA);
                final String serNome = (String) to.getAttribute(Columns.SER_NOME);
                final String serCpf = (String) to.getAttribute(Columns.SER_CPF);
                final String usuNome = (String) to.getAttribute(Columns.USU_NOME);
                final String usuLogin = (String) to.getAttribute(Columns.USU_LOGIN);
                final String tipoEntidade = (String) to.getAttribute("TIPO_ENTIDADE");
                final String nomeEntidade = (String) to.getAttribute("NOME_ENTIDADE");
                detalhe.append("<tr>");
                detalhe.append("<td>" + rseMatricula + "</td>");
                detalhe.append("<td>" + serNome + "</td>");
                detalhe.append("<td>" + serCpf + "</td>");
                detalhe.append("<td>" + usuNome + "</td>");
                detalhe.append("<td>" + usuLogin + "</td>");
                detalhe.append("<td>" + tipoEntidade + " - " + nomeEntidade + "</td>");
                detalhe.append("</tr>");
            }
            detalhe.append("</table>");
            if (!TextHelper.isNull(csaCodigo)) {
                final ConsignatariaTransferObject consignataria = new ConsignatariaDelegate().findConsignataria(csaCodigo, responsavel);
                final String csaNome = consignataria.getCsaIdentificador() + " - " + consignataria.getCsaNome();
                final String csaNomeResponsavel = consignataria.getCsaResponsavel();
                final String csaTelefoneResponsavel = consignataria.getCsaRespTelefone();
                final String csaEmail = consignataria.getCsaEmail();
                final String csaAtivo = String.valueOf(consignataria.getCsaAtivo());
                String csaStatus = "";
                if (StatusConsignatariaEnum.ATIVO.getCodigo().equals(csaAtivo)) {
                    csaStatus = ApplicationResourcesHelper.getMessage("rotulo.consignataria.ativa", responsavel);
                } else if (StatusConsignatariaEnum.BLOQUEADO.getCodigo().equals(csaAtivo)) {
                    csaStatus = ApplicationResourcesHelper.getMessage("rotulo.consignataria.bloqueada", responsavel);
                } else if (StatusConsignatariaEnum.BLOQUEADO_POR_SEGURANCA.getCodigo().equals(csaAtivo)) {
                    csaStatus = ApplicationResourcesHelper.getMessage("rotulo.consignataria.bloqueada.seguranca", responsavel);
                }
                detalhe.append("<br>\n<br>\n<b>" + ApplicationResourcesHelper.getMessage("mensagem.email.detalhe.csa.bloqueio.automatico.seguranca.liberacao.margem", responsavel) + "</b>");
                detalhe.append("<br>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.nome", responsavel) + ":</b> " + csaNome);
                detalhe.append("<br>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.contato", responsavel) + ":</b> " + csaNomeResponsavel);
                detalhe.append("<br>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.telefone", responsavel) + ":</b> " + csaTelefoneResponsavel);
                detalhe.append("<br>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.email", responsavel) + ":</b> " + csaEmail);
                detalhe.append("<br>\n<b>" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.status", responsavel) + ":</b> " + csaStatus);
            }
        } catch (final ConsignatariaControllerException ex) {
            LOG.error(ex.getMessage(), ex);
        }
        return detalhe.toString();
    }

    /**
     * Envia e-mail às consignatárias afetadas pelo caso de uso de ajuste de consignações à margem e seus contratos foram automaticamente alterados
     * pelo sistema.
     * @param consignações modificadas
     * @param parametros da decisão judicial
     */
    public static final void enviarEmailNotificacaoAlteracaoContratoAjustadosMargem(List<TransferObject> autDes, CustomTransferObject decisaoJudicial, AcessoSistema responsavel) {
        try {
            if ((autDes != null) && !autDes.isEmpty()) {
                String destinatario = null;
                // Recupera o endereço de e-mail para destinatário da mensagem, se nulo/vazio, enviar para o usu_email de todos os usuários desbloqueados da CSA que tenham permissão de editar consignatária (FUN_CODIGO = 85)
                for (final TransferObject ade : autDes) {
                    final String csaCodigo = ade.getAttribute(Columns.CSA_CODIGO).toString();
                    if(!csaCodigo.equals(responsavel.getCodigoEntidade())) {
                        final ConsignatariaController consingnatariaController = ApplicationContextProvider.getApplicationContext().getBean(ConsignatariaController.class);
                        final ConsignatariaTransferObject consignataria = consingnatariaController.findConsignataria(csaCodigo, responsavel);
                        destinatario = consignataria.getCsaEmail();

                        List<TransferObject> usuarioCsa = new ArrayList<>();
                        final UsuarioController usuarioController = ApplicationContextProvider.getApplicationContext().getBean(UsuarioController.class);
                        if(TextHelper.isNull(destinatario)) {
                            final CustomTransferObject filtro = new CustomTransferObject();
                            filtro.setAttribute(Columns.USU_STU_CODIGO, CodedValues.STU_ATIVO);
                            usuarioCsa = usuarioController.getUsuarios(AcessoSistema.ENTIDADE_CSA, csaCodigo, filtro, -1, -1, responsavel);
                        }

                        // Define o titulo do E-mail
                        String titulo = ApplicationResourcesHelper.getMessage("mensagem.email.titulo.ajustar.consignacao.a.margem", responsavel);
                        if(titulo.contains("<NOME_SISTEMA>")) {
                            titulo = titulo.replace("<NOME_SISTEMA>", JspHelper.getNomeSistema(responsavel) + " - ");
                        }

                        String textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.ajustar.consignacao.a.margem.sem.decisao", responsavel, ade.getAttribute(Columns.ADE_NUMERO).toString());
                        if (ParamSist.paramEquals(CodedValues.TPC_HABILITA_CAD_DECISAO_JUDICIAL_OP_AVANCADA, CodedValues.TPC_SIM, responsavel)) {
                            // Texto do corpo do e-mail
                            final String numeroProcesso = (String) decisaoJudicial.getAttribute("numeroProcesso");
                            final String tipoJustica = (String) decisaoJudicial.getAttribute("tipoJustica");
                            final String uf = (String) decisaoJudicial.getAttribute("uf");
                            final String comarca = (String) decisaoJudicial.getAttribute("comarca");
                            final String dataDecisao = (String) decisaoJudicial.getAttribute("dataDecisao");
                            final String textoDecisao = (String) decisaoJudicial.getAttribute("textoDecisao");

                            textoGeral = ApplicationResourcesHelper.getMessage("mensagem.email.corpo.ajustar.consignacao.a.margem",responsavel, ade.getAttribute(Columns.ADE_NUMERO).toString(),numeroProcesso,tipoJustica,uf,comarca,dataDecisao,textoDecisao);
                        }


                        if((usuarioCsa != null) && !usuarioCsa.isEmpty()) {
                            for (final TransferObject usuario : usuarioCsa) {
                                final String emailUsu = (String) usuario.getAttribute(Columns.USU_EMAIL);
                                if (!TextHelper.isNull(emailUsu) && usuarioController.usuarioTemPermissao(usuario.getAttribute(Columns.USU_CODIGO).toString(), CodedValues.FUN_EDT_CONSIGNATARIA, AcessoSistema.ENTIDADE_CSA, responsavel)) {
                                    final MailHelper mailHelper = new MailHelper();
                                    mailHelper.send(emailUsu, null, null, titulo, textoGeral.toString(), null, null);
                                }
                            }
                        } else {
                            final MailHelper mailHelper = new MailHelper();
                            mailHelper.send(destinatario, null, null, titulo, textoGeral.toString(), null, null);
                        }
                    }
                }
            }
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia email alerta logo após criação de um novo usuário de CSE.
     * @param usuCodigo
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailAlertaCriaNovoUsuCse(String usuCodigo, AcessoSistema responsavel)
            throws ViewHelperException {

        try {

            final String convenio = JspHelper.getNomeSistema(responsavel);

            final EnviarEmailAlertaCriacaoNovoUsuCseCommand command = new EnviarEmailAlertaCriacaoNovoUsuCseCommand();

            command.setConvenio(convenio);
            command.setUsuCodigo(usuCodigo);

            command.execute();

        } catch (final ViewHelperException e) {
            throw new ViewHelperException("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia email informando o servidor que existem contratos suspensos pendentes de reativação.
     * @param usuCodigo
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailServidorContratosPendentesReativacao(String serNome, String serEmail, AcessoSistema responsavel)
            throws ViewHelperException {

        try {
            final EnviarEmailServidorContratosPendentesReativacaoCommand command = new EnviarEmailServidorContratosPendentesReativacaoCommand();
            command.setNome(serNome);
            command.setEmail(serEmail);
            command.execute();

        } catch (final ViewHelperException e) {
            throw new ViewHelperException("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia email informando o servidor que existem contratos suspensos pendentes de reativação.
     * @param usuCodigo
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailConsignatariaContratoColocadoEmEstoque(AutDesconto autDesconto, AcessoSistema responsavel)
            throws ViewHelperException {

        try {

            final String matricula = autDesconto.getRegistroServidor().getRseMatricula();
            final String csaEmail = autDesconto.getVerbaConvenio().getConvenio().getConsignataria().getCsaEmail();
            final String serNome = autDesconto.getRegistroServidor().getServidor().getSerNome();
            final String adeVlr = NumberHelper.formata(autDesconto.getAdeVlr().doubleValue(), ApplicationResourcesHelper.getMessage("rotulo.moeda.pattern",responsavel));
            final String adePrazo = TextHelper.isNull(autDesconto.getAdePrazo()) ? ApplicationResourcesHelper.getMessage("rotulo.indeterminado", responsavel) : autDesconto.getAdePrazo().toString();
            final String adeNumero = autDesconto.getAdeNumero().toString();
            final String csaNomeAbrev = autDesconto.getVerbaConvenio().getConvenio().getConsignataria().getCsaNomeAbrev();
            final String serCpf = autDesconto.getRegistroServidor().getServidor().getSerCpf();

            if(TextHelper.isNull(csaEmail)) {
                LOG.debug(ApplicationResourcesHelper.getMessage("mensagem.erro.email.nao.enviado.csa.contrato.colocado.em.estoque", responsavel));
                return;
            }

            final EnviarEmailCsaContratosColocadosEmEstoqueCommand command = new EnviarEmailCsaContratosColocadosEmEstoqueCommand();
            command.setMatricula(matricula);
            command.setCsaEmail(csaEmail);
            command.setSerNome(serNome);
            command.setAdeVlr(adeVlr);
            command.setAdePrazo(adePrazo);
            command.setAdeNumero(adeNumero);
            command.setCsaNomeAbrev(csaNomeAbrev);
            command.setSerCpf(serCpf);
            command.execute();

        } catch (final ViewHelperException e) {
            throw new ViewHelperException("mensagem.erro.email.enviar", responsavel, e);
        }
    }

    /**
     * Envia email informando ao consignante a reativação do contrato suspenso por parcela rejeitada.
     * @param adeCodigo
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailNotificacaoCseReativacaoPrdRejeitada(String adeCodigo, AcessoSistema responsavel) throws ViewHelperException {
        try {
            // Recupera o nome do consignante
            final String cseNome = getCseNome(responsavel);
            final String email = getCseEmail(responsavel);

            final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
            final TransferObject ade = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);

            if (TextHelper.isNull(email)) {
                throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
            }

            final String adeNumero = ade.getAttribute(Columns.ADE_NUMERO).toString();
            final String rseMatricula = ade.getAttribute(Columns.RSE_MATRICULA) != null ? ade.getAttribute(Columns.RSE_MATRICULA).toString() : "";
            final String serNome =  ade.getAttribute(Columns.SER_NOME) != null ? ade.getAttribute(Columns.SER_NOME).toString() : "";
            final String serCpf = ade.getAttribute(Columns.SER_CPF) != null ? ade.getAttribute(Columns.SER_CPF).toString() : "";

            final EnviarEmailNotificacaoCseReativacaoPrdRejeitadaCommand command = new EnviarEmailNotificacaoCseReativacaoPrdRejeitadaCommand();
            command.setCseNome(cseNome);
            command.setEmail(email);
            command.setNome(serNome);
            command.setMatricula(rseMatricula);
            command.setSerCpf(serCpf);
            command.setAdeNumero(adeNumero);
            command.setResponsavel(responsavel);
            command.execute();

        } catch (final AutorizacaoControllerException ex) {
            throw new ViewHelperException("mensagem.erro.email.enviar", responsavel, ex);
        }
    }

    /**
     * Envia email sobre informação para a consignatária iniciar o processo de credenciamento da consignataria
     * @param adeCodigo
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailNotificacaoCsaModuloCredenciamento(ConsignatariaTransferObject consignataria, AcessoSistema responsavel) throws ViewHelperException {
            String arqModelo = ParamSist.getDiretorioRaizArquivos();
            arqModelo += File.separator + "credenciamento" + File.separator + "modelo" + File.separator + "lista_documentos";

            boolean arquivoExiste = false;

            for(final String extensao : UploadHelper.EXTENSOES_PERMITIDAS_DOCUMENTOS_CREDENCIAMENTO) {
                final File arquivo = new File(arqModelo+extensao);
                if(arquivo.exists()) {
                    arqModelo += extensao;
                    arquivoExiste = true;
                    break;
                }
            }

            final EnviarEmailNotificacaoCsaCredenciamentoCommand command = new EnviarEmailNotificacaoCsaCredenciamentoCommand();
            command.setEmail(consignataria.getCsaEmail());
            if(arquivoExiste) {
                command.setAnexo(arqModelo);
            } else {
                LOG.warn("Credenciamento: Arquivo com a lista de documentos não existe, mesmo assim iremos enviar o email");
            }
            command.execute();
	}

    /**
     * Envia email informando o desbloqueio da CSA.
     * @param csa
     * @param email
     * @param convenio
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailNotificacaoDesbloqueioCsa(String csaNome, String email, AcessoSistema responsavel) throws ViewHelperException {
            if (TextHelper.isNull(email)) {
                throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
            }

            final EnviarEmailNotificacaoDesbloqueioCsaCommand command = new EnviarEmailNotificacaoDesbloqueioCsaCommand();
            command.setCsaNome(csaNome);
            command.setEmail(email);
            command.execute();
    }

    /**
     * Envia email informando necessidade de aprovação para o desbloqueio da CSA.
     * @param nome
     * @param csa
     * @param email
     * @param convenio
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailSuporteCsaPendente(String nome, String csaNome, String csaEmailsDesbloqueio, AcessoSistema responsavel) throws ViewHelperException {
        if(TextHelper.isNull(csaEmailsDesbloqueio)) {
            LOG.warn(ApplicationResourcesHelper.getMessage("mensagem.info.notificacao.nao.enviada.desbloqueio.csa", responsavel));
            return;
        }
        final EnviarEmailConfirmacaoDesbloqueioCsaCommand command = new EnviarEmailConfirmacaoDesbloqueioCsaCommand();
        command.setEmail(csaEmailsDesbloqueio);
        command.setNome(nome);
        command.setCsaNome(csaNome);
        command.execute();
    }

    /**
     * Envia email sobre informação para a consignante que a csa fez os envios da documentação
     * @param cseEmail
     * @param csaNomeAbrev
     * @param anexos
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailNotificacaoCseModuloCredenciamento(String cseEmail, String csaNomeAbrev, List<String> anexos, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(cseEmail)) {
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.destinatario.invalido", responsavel));
            throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
        }

        final EnviarEmailNotificacaoCseCredenciamentoCommand command = new EnviarEmailNotificacaoCseCredenciamentoCommand();
        command.setEmail(cseEmail);
        command.setCsaNomeAbrev(csaNomeAbrev);
        command.setAnexos(anexos);
        command.execute();
    }

    /**
     * Envia email sobre aprovação da documentação do credenciamento para a consignatária
     * @param CredenciamentoCsa
     * @param situacao
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificarCsaAprovacaoDocumentacaoCsa(CredenciamentoCsa credenciamentocsa, String situacao, AcessoSistema responsavel) throws ViewHelperException {
        final String csaEmail = credenciamentocsa.getConsignataria().getCsaEmail();
        if (TextHelper.isNull(csaEmail)) {
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.destinatario.invalido", responsavel));
            throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
        }

        final EnviarEmailNotificacaoDocCsaCredenciamentoCommand command = new EnviarEmailNotificacaoDocCsaCredenciamentoCommand();
        command.setEmail(csaEmail);
        command.setCsaNomeAbrev(credenciamentocsa.getConsignataria().getCsaNomeAbrev());
        command.setSituacao(situacao);
        command.execute();
    }

    /**
     * Envia email sobre atualização do credenciamento para a consignatária
     * @param CredenciamentoCsa
     * @param situacao
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificarCsaSituacaoCredenciamento(CredenciamentoCsa credenciamentocsa, String situacao, AcessoSistema responsavel) throws ViewHelperException {
        final String csaEmail = credenciamentocsa.getConsignataria().getCsaEmail();
        if (TextHelper.isNull(csaEmail)) {
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.destinatario.invalido", responsavel));
            throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
        }

        final EnviarEmailNotificacaoSituacaoCsaCredenciamentoCommand command = new EnviarEmailNotificacaoSituacaoCsaCredenciamentoCommand();
        command.setEmail(csaEmail);
        command.setCsaNomeAbrev(credenciamentocsa.getConsignataria().getCsaNomeAbrev());
        command.setSituacao(situacao);
        command.execute();
    }

    /**
     * Envia email sobre a necessidade do preenchidmento do termo aditivo para a consignatária
     * @param CredenciamentoCsa
     * @param anexoTermoAditivo
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificarCsaPreenchimentoTermoAditivoCredenciamento(CredenciamentoCsa credenciamentocsa, String anexoTermoPreenchido, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailNotificacaoPreenchimentoTermoCredenciamentoCommand command = new EnviarEmailNotificacaoPreenchimentoTermoCredenciamentoCommand();
        command.setEmail(credenciamentocsa.getConsignataria().getCsaEmail());
        command.setCsaNomeAbrev(credenciamentocsa.getConsignataria().getCsaNomeAbrev());
        command.setAnexoTermoPreenchido(anexoTermoPreenchido);
        command.execute();
    }

    /**
     * Envia email informando que o termo aditivo foi assinado pela csa
     * @param cseEmail
     * @param csaNome
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificarCseAssTermoAditivo(String cseEmail, String csaNome, String anexoTermoAssinado, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(cseEmail)) {
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.destinatario.invalido", responsavel));
            throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
        }

        final EnviarEmailNotificacaoCseAssTermoCsaCommand command = new EnviarEmailNotificacaoCseAssTermoCsaCommand();
        command.setEmail(cseEmail);
        command.setCsaNomeAbrev(csaNome);
        command.setAnexo(anexoTermoAssinado);
        command.execute();
    }

    /**
     * Envia email informando que o termo aditivo foi assinado pela cse para os usuário com função de aprovacao
     * @param cseEmail
     * @param csaNome
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificarUsuAprovacaoAssTermoCseAditivo(String usuEmail,String usuNome, String anexoTermoAssinado, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(usuEmail)) {
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.destinatario.invalido", responsavel));
            throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
        }

        final EnviarEmailNotificacaoUsuPermissaoAprovacaoAssTermoCseCommand command = new EnviarEmailNotificacaoUsuPermissaoAprovacaoAssTermoCseCommand();
        command.setEmail(usuEmail);
        command.setUsuNome(usuNome);
        command.setAnexo(anexoTermoAssinado);
        command.execute();
    }

    /**
     * Envia email informando que o credenciamento foi concluído
     * @param cseEmail
     * @param csaNome
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificarCredenciamentoConcluido(String cseEmail, String csaNome, String csaEmail, String anexoTermoAssinado, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(cseEmail) || TextHelper.isNull(csaEmail)) {
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.destinatario.invalido", responsavel));
            throw new ViewHelperException("mensagem.erro.email.destinatario.invalido", responsavel);
        }

        final EnviarEmailNotificacaoCseCredenciamentoConcluidoCommand command = new EnviarEmailNotificacaoCseCredenciamentoConcluidoCommand();
        command.setEmail(cseEmail);
        command.setCsaNomeAbrev(csaNome);
        command.setAnexo(anexoTermoAssinado);
        command.execute();

        final EnviarEmailNotificacaoCsaCredenciamentoConcluidoCommand commandCsa = new EnviarEmailNotificacaoCsaCredenciamentoConcluidoCommand();
        commandCsa.setEmail(csaEmail);
        commandCsa.setCsaNomeAbrev(csaNome);
        commandCsa.setAnexo(anexoTermoAssinado);
        commandCsa.execute();
    }

    /**
     * Envia e-mail para o servidor com os contratos que não foram possíveis ser concluídos com o valor da verba rescisória
     * @param rseCodigo
     * @param responsavel
     * @throws ZetraException
     * @throws MessagingException
     */
    public static final void enviarEmailSerVerbaRescisoriaSaldoInsuficiente(String rseCodigo, AcessoSistema responsavel) {
        try {

            final VerbaRescisoriaController verbaRescisoriaController = ApplicationContextProvider.getApplicationContext().getBean(VerbaRescisoriaController.class);

            // Busca os contratos com a ocorrência de insuficiente de saldo da verba rescisória
            final List<AutDesconto> lstAutDescontoVerbaRescisoria = verbaRescisoriaController.listarConsignacoesReterVerbaRescisoriaSaldoInsuficiente(rseCodigo, responsavel);

            final String emailDestino = lstAutDescontoVerbaRescisoria.get(0).getRegistroServidor().getServidor().getSerEmail();

            if (TextHelper.isNull(emailDestino)) {
                LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.servidor.email.invalido", responsavel));
                throw new ViewHelperException("mensagem.erro.servidor.email.invalido", responsavel);
            }

            final StringBuilder detalhe = new StringBuilder();

            for (final AutDesconto ade : lstAutDescontoVerbaRescisoria) {
                detalhe.append("<br>" + ApplicationResourcesHelper.getMessage("rotulo.email.numero.ade", responsavel, String.valueOf(ade.getAdeNumero())));
                detalhe.append("<br>" + ApplicationResourcesHelper.getMessage("rotulo.email.data.inclusao", responsavel, DateHelper.toDateTimeString(ade.getAdeData())));
                detalhe.append("<br>" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.prestacao", responsavel, NumberHelper.format(ade.getAdeVlr().doubleValue(), NumberHelper.getLang(), true)));
                detalhe.append("<br>" + ApplicationResourcesHelper.getMessage("rotulo.email.valor.restante", responsavel));
                detalhe.append("<br><b>" + ApplicationResourcesHelper.getMessage("rotulo.consignataria.singular", responsavel)).append(":</b> ").append(ade.getVerbaConvenio().getConvenio().getConsignataria().getCsaNome());
            }

            final EnviarEmailServidorVerbaRescisoriaSaldoInsuficienteCommand enviaEmailSer = new EnviarEmailServidorVerbaRescisoriaSaldoInsuficienteCommand();
            enviaEmailSer.setSerNome(TextHelper.capitailizeFirstLetter(lstAutDescontoVerbaRescisoria.get(0).getRegistroServidor().getServidor().getSerNome()));
            enviaEmailSer.setDetalheConsignacao(detalhe.toString());
            enviaEmailSer.setEmail(emailDestino);

            enviaEmailSer.execute();
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    /**
     * Envia email informando todos vinculos que foram criados e ela deve escolher como proceder
     * @param lista de vinculos
     * @Param lista de consignatarias
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificarCsaNovosVinculosRse(List<VinculoRegistroServidor> vinculosRegistroServidor, List<TransferObject> listaCsaEnviarNotificacao, AcessoSistema responsavel) throws ViewHelperException {

        for (final TransferObject csaEnviarNotificacao : listaCsaEnviarNotificacao) {
            final String csaNome = (String) csaEnviarNotificacao.getAttribute(Columns.CSA_NOME);
            final String csaNomeAbrev = (String) csaEnviarNotificacao.getAttribute(Columns.CSA_NOME_ABREV);
            final String csaIdentificador = (String) csaEnviarNotificacao.getAttribute(Columns.CSA_IDENTIFICADOR);
            final String tpaEmail = (String) csaEnviarNotificacao.getAttribute("VALOR_PARAM_95");
            final String valorParam81 = (String) csaEnviarNotificacao.getAttribute("VALOR_PARAM");

            if(TextHelper.isNull(tpaEmail)) {
                LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.destinatario.invalido", responsavel));
                continue;
            }
            final StringBuilder vinculos = new StringBuilder();

           for(var i = 0; i < vinculosRegistroServidor.size(); i++) {
                final VinculoRegistroServidor vinculoRegistroServidor = vinculosRegistroServidor.get(i);
                vinculos.append(vinculoRegistroServidor.getVrsIdentificador() + "-" + vinculoRegistroServidor.getVrsDescricao() + " " +
                                ApplicationResourcesHelper.getMessage("mensagem.email.notificar.novos.vinculos.texto.dia", responsavel) + " " +
                                DateHelper.toDateTimeString(vinculoRegistroServidor.getVrsDataCriacao()));
                if(i < (vinculosRegistroServidor.size()-1)) {
                    vinculos.append(", ");
                }
            }

        final EnviarEmailNotificacaoCsaNovoVinculoCommand command = new EnviarEmailNotificacaoCsaNovoVinculoCommand();
        command.setCsaEmail(tpaEmail.replace(";", ","));
        command.setCsaIdentificador(csaIdentificador);
        command.setCsaNome(csaNome);
        command.setCsaNomeAbrev(csaNomeAbrev);
        command.setVinculos(vinculos.toString());
        command.setSituacaoVinculo(CodedValues.TPC_NAO.equals(valorParam81) ? ApplicationResourcesHelper.getMessage("rotulo.acoes.bloquear", responsavel).toLowerCase() : ApplicationResourcesHelper.getMessage("rotulo.acoes.desbloquear", responsavel).toLowerCase());
        command.execute();
        }
    }

    /**
     * Envia email informando ao suporte que houve um erro ao criar o arquivo de margem de serviço externo
     * @Param emailSuporte
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificaSuporteErroCriarArqMargemServicoExterno(String emailSuporte, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailNotificaoErroCriarArquivoMargemCommand command = new EnviarEmailNotificaoErroCriarArquivoMargemCommand();
        command.setEmail(emailSuporte);
        command.execute();
    }

    /**
     * Envia email informando ao consignante que foi gerado um arquivo com a lista de servidores bloqueados para determinada csa, pois o limite de variação foi superado
     * @Param emailSuporte
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificaCseArqRelacaoBloqRseCnvVariacaoCsa(String emailConsignante, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailNotificaoCseBloqSerCnvVariacaoMargemCsaCommand command = new EnviarEmailNotificaoCseBloqSerCnvVariacaoMargemCsaCommand();
        command.setEmail(emailConsignante);
        command.execute();
    }

    /**
     * Envia email informando à consignatária que uma determinada de servdiores foram bloqueados para cada verba por ultrapassarem o limite estabelecido de variação de margem
     * @Param emailSuporte
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificaCsaQuantidadeServidorVerbaBloq(String csaEmail, String csaNome, String quantidadePorVerba, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailNotificaoCsaBloqSerCnvVariacaoMargemCommand command = new EnviarEmailNotificaoCsaBloqSerCnvVariacaoMargemCommand();
        command.setEmail(csaEmail);
        command.setCsaNome(csaNome);
        command.setQuantidadePorVerba(quantidadePorVerba);
        command.execute();
    }

    public static final void enviarEmailOfertaRefinanciamentoCsa(String csaEmail, String csaNome, String percentual, String adeNumeros) throws ViewHelperException {
        final EnviarEmailRefinanciamentoCsaCommand command = new EnviarEmailRefinanciamentoCsaCommand();
        command.setEmail(csaEmail);
        command.setCsaNome(csaNome);
        command.setAdeNumeros(adeNumeros);
        command.setPercentual(percentual);
        command.execute();
    }

    /**
     * Envia email para notificar servidor após reserva de margem sem necessidade de senha ou código único
     * @Param serEmail
     * @param serNome
     * @param csaNome
     * @throws ViewHelperException
     */
    public static final void notificarSerReservaMargem(String serEmail, String serNome, String csaNome) throws ViewHelperException {
        final EnviarEmailNotificacaoReservaMargemCommand command = new EnviarEmailNotificacaoReservaMargemCommand();
        command.setEmail(serEmail);
        command.setSerNome(serNome);
        command.setCsaNome(csaNome);
        command.execute();
    }

    /**
     * Envia email para notificar servidor que a autorização irá vencer
     * @Param serEmail
     * @param serNome
     * @param csaNome
     * @param dataVencimento
     * @throws ViewHelperException
     */
    public static final void notificarSerAutorizacaoIraVencer(String serEmail, String serNome, String csaNome, String dataVencimento) throws ViewHelperException {
        final EnviarEmailNotificacaoAutorizacaoIraVencerCommand command = new EnviarEmailNotificacaoAutorizacaoIraVencerCommand();
        command.setEmail(serEmail);
        command.setSerNome(serNome);
        command.setCsaNome(csaNome);
        command.setDataVencimento(dataVencimento);
        command.execute();
    }

    /**
     * Envia email para notificar csa que a verba do registro servidor foi desbloqueada
     * @Param csaEmail
     * @param csaNome
     * @param cseNome
     * @param count
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificaCsaDesbloqueioVerbaRse(String csaEmail, String cseNome, String csaNome, int count, AcessoSistema responsavel) throws ViewHelperException {
        final EnviaEmailCsaDesbloqueioVerbaRseCommand command = new EnviaEmailCsaDesbloqueioVerbaRseCommand();
        command.setCount(count);
        command.setCsaEmail(csaEmail);
        command.setCsaNome(csaNome);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /**
     * Envia email para notificar csa os vínculos bloqueados e desbloqueados
     * @Param csaEmail
     * @param csaCodigo
     * @param csaNome
     * @param obvCodigos
     * @throws ViewHelperException
     */
    public static final void enviarEmailCsaVinculosBloqDesbloq(String csaEmail, String csaCodigo, String csaNome, List<String> obvCodigos) throws ViewHelperException {
        final EnviarEmailNotificacaoCsaVinculosBloqDesbloqCommand command = new EnviarEmailNotificacaoCsaVinculosBloqDesbloqCommand();
        command.setCsaEmail(csaEmail);
        command.setCsaCodigo(csaCodigo);
        command.setCsaNome(csaNome);
        command.setOvrCodigos(obvCodigos);
        command.execute();
    }

    /**
     * Envia email ao gestor informando o bloqueio de uma consignatária, motivo e usuário.
     * @param cseEmail
     * @param csaNomeAbrev
     * @param anexos
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailNotificacaoCseBloqueioConsignataria(String cseEmail, String obsBloqueio, String csaNome, String csaNomeAbrev, String usuario, AcessoSistema responsavel) throws ViewHelperException {
        if (TextHelper.isNull(cseEmail)) {
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.destinatario.invalido", responsavel));
            return;
        }

        final EnviarEmailNotificacaoCseBloqueioCsaCommand command = new EnviarEmailNotificacaoCseBloqueioCsaCommand();
        command.setEmail(cseEmail);
        command.setMotivoBloqueio(obsBloqueio);
        command.setCsaNome(csaNome);
        command.setCsaNomeAbrev(csaNomeAbrev);
        command.setUsuario(usuario);
        command.setDataBloqueio(DateHelper.toDateString(DateHelper.getSystemDate()));
        command.execute();
    }

    /** Envia email para notificar csa após portabilidade de reserva de cartão
     * @Param csaEmail
     * @param adeNumero
     * @param serCpf
     * @param serMatricula
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificaCsaPortabilidadeCartao(String csaEmail, String adeNumero, String serCpf, String serMatricula, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailCsaPortabilidadeCartaoCommand command = new EnviarEmailCsaPortabilidadeCartaoCommand();
        command.setCsaEmail(csaEmail);
        command.setAdeNumero(adeNumero);
        command.setSerCpf(serCpf);
        command.setSerMatricula(serMatricula);
        command.setResponsavel(responsavel);
        command.execute();
    }

    /** Envia email para notificar servidor após simulacao de reserva
     * @Param serEmail
     * @Param anexoEmail
     * @Param nomeUSu
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificaSerSimulacaoConsignacao(List<CsaListInfoRequest> inforCsas, String serEmail, String nomeUsu, String cseNome, String anexoEmail, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailSimulacaoCommand command = new EnviarEmailSimulacaoCommand();
        command.setResponsavel(responsavel);
        command.setSerEmail(serEmail);
        command.setNomeUsu(nomeUsu);
        command.setAnexoEmail(anexoEmail);
        command.setListInfor(inforCsas);
        command.setCseNome(cseNome);
        command.execute();

	}

    /**
     * Envia e-mail para a consignatária vencedora do leilão com o telefone do servidor.
     * @param adeCodigo
     * @param plsVencedora
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void enviarEmailCsaVencedoraLeilao(String adeCodigo, PropostaLeilaoSolicitacao plsVencedora, AcessoSistema responsavel) throws ViewHelperException {
        try {
            final String csaEmail = plsVencedora.getConsignataria().getCsaEmail();

            TransferObject adeTO = null;

            if (!TextHelper.isNull(csaEmail)) {
                final AutorizacaoDelegate adeDelegate = new AutorizacaoDelegate();
                adeTO = adeDelegate.buscaAutorizacao(adeCodigo, responsavel);
            } else {
                return;
            }

            final String cseNome = getCseNome(responsavel);
            final String adeNumero = adeTO.getAttribute(Columns.ADE_NUMERO).toString();
            final String serNome = (String) adeTO.getAttribute(Columns.SER_NOME);
            final String serTel = (String) adeTO.getAttribute(Columns.SER_TEL);
            final String serCelular = (String) adeTO.getAttribute(Columns.SER_CELULAR);
            final String titulo = gerarTituloEmail(cseNome, ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.titulo.leilao.encerrado", responsavel, adeNumero), responsavel);

            final boolean simulacaoPorTaxaJuros = ParamSist.paramEquals(CodedValues.TPC_SIMULACAO_POR_TAXA_JUROS, CodedValues.TPC_SIM, responsavel);
            final boolean temCET = ParamSist.paramEquals(CodedValues.TPC_TEM_CET, CodedValues.TPC_SIM, responsavel);

            final String adeTipoTaxa = (String) adeTO.getAttribute(Columns.ADE_TIPO_TAXA);

            final List<String> parametros = new ArrayList<>();
            parametros.add(CodedValues.TPS_ADD_VALOR_IOF_VAL_TAXA_JUROS);
            parametros.add(CodedValues.TPS_ADD_VALOR_TAC_VAL_TAXA_JUROS);
            parametros.add(CodedValues.TPS_VLR_LIQ_TAXA_JUROS);

            final ParametroDelegate parDelegate = new ParametroDelegate();
            final ParamSvcTO paramSvcCse = parDelegate.selectParamSvcCse((String) adeTO.getAttribute(Columns.SVC_CODIGO), parametros, responsavel);

            // Define rótulo para o campo de Taxa de Juros/CET/Coeficiente
            String rotuloTaxa = "";
            if (adeTipoTaxa != null) {
                if (CodedValues.TIPO_TAXA_CET.equals(adeTipoTaxa)) {
                    //CET Real: Cálculo com valor liberado sem adicionar IOF e TAC
                    rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.consignacao.cet", responsavel);
                } else if (CodedValues.TIPO_TAXA_JUROS.equals(adeTipoTaxa)) {
                    // Taxa de Juros Real: Cálculo com valor liberado somando IOF e TAC
                    rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.consignacao.taxa.juros", responsavel);
                }
            } else if (temCET) {
                rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.consignacao.cet", responsavel);
            } else if (paramSvcCse.isTpsVlrLiqTaxaJuros() || simulacaoPorTaxaJuros) {
                rotuloTaxa = ApplicationResourcesHelper.getMessage("rotulo.consignacao.taxa.juros", responsavel);
            }

            final StringBuilder corpoEmail = new StringBuilder(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.cabecalho.leilao.encerrado", responsavel, adeNumero, (String) adeTO.getAttribute(Columns.SVC_DESCRICAO))).append("<BR>");

            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("mensagem.email.consignataria.vencedora.leilao", responsavel, adeNumero));
            corpoEmail.append("</b> : <BR><BR>");
            corpoEmail.append("<b>").append(rotuloTaxa).append("</b> : ").append(plsVencedora.getPlsTaxaJuros().setScale(2, java.math.RoundingMode.HALF_UP));
            corpoEmail.append("<BR>");
            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.valor.liberado", responsavel)).append("</b> : ");
            corpoEmail.append(LocaleHelper.getCurrencyFormat().format(plsVencedora.getPlsValorLiberado().setScale(2, java.math.RoundingMode.HALF_UP))).append("<BR>");
            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.consignacao.valor.parcela", responsavel)).append("</b> : ");
            corpoEmail.append(LocaleHelper.getCurrencyFormat().format(plsVencedora.getPlsValorParcela().setScale(2, java.math.RoundingMode.HALF_UP)));
            corpoEmail.append("<BR>");
            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.prazo.singular", responsavel)).append("</b> : ");
            corpoEmail.append(plsVencedora.getPlsPrazo()).append(" ").append(CodedValues.PERIODICIDADE_FOLHA_MENSAL.equals(adeTO.getAttribute(Columns.ADE_PERIODICIDADE)) ? ApplicationResourcesHelper.getMessage("rotulo.consignacao.mes.plural", responsavel) : ApplicationResourcesHelper.getMessage("rotulo.consignacao.quinzena.plural", responsavel)).append("<BR>");
            corpoEmail.append("<BR><BR>");
            corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.servidor.singular", responsavel)).append("</b> : ").append(serNome);
            corpoEmail.append("<BR>");
            if (!TextHelper.isNull(serTel) || !TextHelper.isNull(serCelular)) {
                corpoEmail.append("<b>").append(ApplicationResourcesHelper.getMessage("rotulo.servidor.telefone", responsavel)).append("</b> : ");
                if (!TextHelper.isNull(serTel) && !TextHelper.isNull(serCelular)) {
                    corpoEmail.append(serTel).append(" / ").append(serCelular);
                } else if (!TextHelper.isNull(serTel)) {
                    corpoEmail.append(serTel);
                } else {
                    corpoEmail.append(serCelular);
                }
            }

            // Envia o e-mail.
            new MailHelper().send(csaEmail, null, null, titulo, corpoEmail.toString(), null);
        } catch (AutorizacaoControllerException | ParametroControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException(ex.getMessageKey(), responsavel, ex);
        } catch (final MessagingException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ViewHelperException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    /** Envia email para notificar gestor que determinada consignatária atingiu o limite diário de consignações incluídas
     * @Param serEmail
     * @Param anexoEmail
     * @Param nomeUSu
     * @param responsavel
     * @throws ViewHelperException
     */
    public static final void notificaCseLimiteConsignacaoCsa(String csaCodigo, int contadorAtual, AcessoSistema responsavel) throws ViewHelperException {
        final ConsignatariaController consignatariaController = ApplicationContextProvider.getApplicationContext().getBean(ConsignatariaController.class);
        final ConsignanteController consignanteController = ApplicationContextProvider.getApplicationContext().getBean(ConsignanteController.class);
        ConsignatariaTransferObject consignataria;
        ConsignanteTransferObject consignante;
        try {
            consignataria = consignatariaController.findConsignataria(csaCodigo, responsavel);
            consignante = consignanteController.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);
        } catch (ConsignatariaControllerException | ConsignanteControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            return;
        }

        final EnviarEmailLimiteAtigindoInclusaoCsaCommand command = new EnviarEmailLimiteAtigindoInclusaoCsaCommand();
        command.setResponsavel(responsavel);
        command.setContadorAtual(contadorAtual);
        command.setCsaNome(consignataria.getCsaNome());
        command.setCsaNomeAbrev(consignataria.getCsaNomeAbreviado());
        command.setCseEmail(consignante.getCseEmail());
        command.setCseNome(consignante.getCseNome());
        command.execute();
    }

    /**
     * Envia email para notificar usuário sobre o prazo de expiração de senha
     * @Param usuNome
     * @Param usuEmail
     * @param qtdeDiasExpiracaoSenha
     * @throws ViewHelperException
     */
    public static final void notificarUsuPrazoExpiracaoSenha(String usuNome, String usuEmail, Integer qtdeDiasExpiracaoSenha, AcessoSistema responsavel) throws ViewHelperException {
        final ConsignanteController consignanteController = ApplicationContextProvider.getApplicationContext().getBean(ConsignanteController.class);
        ConsignanteTransferObject consignante;
        try {
            consignante = consignanteController.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);
        } catch (final ConsignanteControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            return;
        }

        final EnviarEmailNotificacaoPrazoExpiracaoSenhaCommand command = new EnviarEmailNotificacaoPrazoExpiracaoSenhaCommand();
        command.setResponsavel(responsavel);
        command.setCseNome(consignante.getCseNome());
        command.setUsuEmail(usuEmail);
        command.setUsuNome(usuNome);
        command.setQtdeDiasExpiracaoSenha(qtdeDiasExpiracaoSenha);
        command.execute();
    }

    /**
     * Envia email para alertar consignante sobre bloqueio de usuário
     * @Param usuario
     * @throws ViewHelperException
     */
    public static final void enviarEmailCseBloqueioUsuario(UsuarioTransferObject usuario, AcessoSistema responsavel) throws ViewHelperException {
        final ConsignanteController consignanteController = ApplicationContextProvider.getApplicationContext().getBean(ConsignanteController.class);
        ConsignanteTransferObject consignante;
        try {
            consignante = consignanteController.findConsignante(CodedValues.CSE_CODIGO_SISTEMA, responsavel);
        } catch (final ConsignanteControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            return;
        }

        final EnviarEmailCseBloqueioUsuarioCommand command = new EnviarEmailCseBloqueioUsuarioCommand();
        command.setResponsavel(responsavel);
        command.setCseEmail(consignante.getCseEmail());
        command.setUsuNome(usuario.getUsuNome());
        command.setUsuCpf(usuario.getUsuCPF());
        command.setUsuLogin(usuario.getUsuLogin());
        command.setUsuEmail(usuario.getUsuEmail());
        command.execute();
    }

    /**
     * Envia email para o usuário com a senha criada para ele.
     * @Param usuario
     * @throws ViewHelperException
     */
    public static final void enviarEmailSenhaNovoUsuario(UsuarioTransferObject usuario, String senha, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailSenhaNovoUsuarioCommand command = new EnviarEmailSenhaNovoUsuarioCommand();
        command.setResponsavel(responsavel);
        command.setUsuEmail(usuario.getUsuEmail());
        command.setUsuNome(usuario.getUsuNome());
        command.setUsuSenha(senha);
        command.execute();
    }
    

    /**
     * Envia e-mail para a consignatária com as alterações realizadas nas regras do convênio.
     * @param dadosAlterados 
     * @param csaNome 
     * @param csaNotificacaoRegra 
     * @param responsavel 
     * @throws ViewHelperException 
     */
	public static void enviarEmailCsaAlteracaoRegrasConvenio(List<RegrasConvenioParametrosBean> dadosAlterados, String csaNome, String csaNotificacaoRegra, AcessoSistema responsavel) throws ViewHelperException {
        final EnviarEmailCsaNotificacaoRegraCommand command = new EnviarEmailCsaNotificacaoRegraCommand();
        command.setResponsavel(responsavel);
        command.setCsaNome(csaNome);
        command.setCsaNotificacaoRegra(csaNotificacaoRegra);
        command.setDadosAlterados(dadosAlterados);
        command.execute();		
	}
}

cannot find symbol



package com.zetra.econsig.service.usuario;

import java.io.File;
import java.io.IOException;
import java.sql.Date;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.interceptor.TransactionAspectSupport;

import com.zetra.econsig.delegate.LogDelegate;
import com.zetra.econsig.dto.CustomTransferObject;
import com.zetra.econsig.dto.TransferObject;
import com.zetra.econsig.dto.entidade.ConsignanteTransferObject;
import com.zetra.econsig.dto.entidade.ConsignatariaTransferObject;
import com.zetra.econsig.dto.entidade.CorrespondenteTransferObject;
import com.zetra.econsig.dto.entidade.EnderecoFuncaoTransferObject;
import com.zetra.econsig.dto.entidade.OcorrenciaUsuarioTransferObject;
import com.zetra.econsig.dto.entidade.OrgaoTransferObject;
import com.zetra.econsig.dto.entidade.RegistroServidorTO;
import com.zetra.econsig.dto.entidade.ServidorTransferObject;
import com.zetra.econsig.dto.entidade.UsuarioTransferObject;
import com.zetra.econsig.exception.AutorizacaoControllerException;
import com.zetra.econsig.exception.ConsignanteControllerException;
import com.zetra.econsig.exception.ConsignatariaControllerException;
import com.zetra.econsig.exception.CorrespondenteControllerException;
import com.zetra.econsig.exception.CreateException;
import com.zetra.econsig.exception.DAOException;
import com.zetra.econsig.exception.FindException;
import com.zetra.econsig.exception.HQueryException;
import com.zetra.econsig.exception.HistoricoArquivoControllerException;
import com.zetra.econsig.exception.LogControllerException;
import com.zetra.econsig.exception.ParametroControllerException;
import com.zetra.econsig.exception.RemoveException;
import com.zetra.econsig.exception.SSOException;
import com.zetra.econsig.exception.ServicoControllerException;
import com.zetra.econsig.exception.ServidorControllerException;
import com.zetra.econsig.exception.UpdateException;
import com.zetra.econsig.exception.UsuarioControllerException;
import com.zetra.econsig.exception.ViewHelperException;
import com.zetra.econsig.exception.ZetraException;
import com.zetra.econsig.helper.arquivo.FileHelper;
import com.zetra.econsig.helper.criptografia.JCrypt;
import com.zetra.econsig.helper.email.EnviaEmailHelper;
import com.zetra.econsig.helper.emailexterno.ConsultarEmailExternoServidor;
import com.zetra.econsig.helper.emailexterno.ConsultarEmailExternoServidorFactory;
import com.zetra.econsig.helper.log.Log;
import com.zetra.econsig.helper.parametro.ParamSist;
import com.zetra.econsig.helper.seguranca.AcessoSistema;
import com.zetra.econsig.helper.seguranca.SynchronizerToken;
import com.zetra.econsig.helper.senha.GeradorSenhaUtil;
import com.zetra.econsig.helper.senha.SenhaHelper;
import com.zetra.econsig.helper.senhaexterna.SenhaExterna;
import com.zetra.econsig.helper.sms.EnviaSMSHelper;
import com.zetra.econsig.helper.sms.SMSHelper;
import com.zetra.econsig.helper.texto.ApplicationResourcesHelper;
import com.zetra.econsig.helper.texto.DateHelper;
import com.zetra.econsig.helper.texto.LocaleHelper;
import com.zetra.econsig.helper.texto.TextHelper;
import com.zetra.econsig.helper.usuario.UsuarioHelper;
import com.zetra.econsig.helper.web.JspHelper;
import com.zetra.econsig.parser.EscritorArquivoTexto;
import com.zetra.econsig.parser.EscritorMemoria;
import com.zetra.econsig.parser.Leitor;
import com.zetra.econsig.parser.LeitorListTO;
import com.zetra.econsig.parser.ParserException;
import com.zetra.econsig.parser.Tradutor;
import com.zetra.econsig.persistence.entity.*;
import com.zetra.econsig.persistence.query.funcao.FuncoesPerfilQuery;
import com.zetra.econsig.persistence.query.funcao.FuncoesPerfilRestricaoAcessoQuery;
import com.zetra.econsig.persistence.query.funcao.FuncoesPersonalizadasQuery;
import com.zetra.econsig.persistence.query.funcao.FuncoesPersonalizadasRestricaoAcessoQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncaoPerfilTodasEntidadesQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesAuditadasQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesAuditaveisPapelQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesBloqueadasQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesBloqueaveisQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesPerfilQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesPermitidasNcaQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesPermitidasPapelQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesRegraTaxaQuery;
import com.zetra.econsig.persistence.query.funcao.ListaFuncoesSensiveisCsaQuery;
import com.zetra.econsig.persistence.query.funcao.ListaPapeisQuery;
import com.zetra.econsig.persistence.query.funcao.ListaPerfilTodasEntidadesPossuemFuncaoQuery;
import com.zetra.econsig.persistence.query.funcao.ListarFuncaoQuery;
import com.zetra.econsig.persistence.query.funcao.ObtemFuncaoQuery;
import com.zetra.econsig.persistence.query.perfil.ListaOcorrenciaPerfilQuery;
import com.zetra.econsig.persistence.query.perfil.ListaPerfilSemBloqueioRepasseQuery;
import com.zetra.econsig.persistence.query.perfil.ListaPerfilTipoEntidadeQuery;
import com.zetra.econsig.persistence.query.senha.ListaOcorrenciaUsuSerSenhaAutorizacaoViaTotemQuery;
import com.zetra.econsig.persistence.query.senha.ListaSenhaAutorizacaoServidorExpiradaQuery;
import com.zetra.econsig.persistence.query.senha.ListaSenhaAutorizacaoServidorQuery;
import com.zetra.econsig.persistence.query.senha.ListaSenhasAntigasUsuarioQuery;
import com.zetra.econsig.persistence.query.senha.ListaUsuarioSerSenhaAutExpiradaQuery;
import com.zetra.econsig.persistence.query.senha.ObtemProtocoloSenhaAutorizacaoQuery;
import com.zetra.econsig.persistence.query.senha.ObtemSenhaServidorQuery;
import com.zetra.econsig.persistence.query.servidor.ListaServidoresQuery;
import com.zetra.econsig.persistence.query.servidor.ObtemTotalServidoresPorEmailCelularQuery;
import com.zetra.econsig.persistence.query.usuario.FindEmailUsuarioRepeatQuery;
import com.zetra.econsig.persistence.query.usuario.ListaFuncoesUsuarioQuery;
import com.zetra.econsig.persistence.query.usuario.ListaOcorrenciaUsuarioQuery;
import com.zetra.econsig.persistence.query.usuario.ListaStatusLoginQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuarioAtivoComEmailQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuarioAuditorEntidadeQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuarioCriadoPorResponsavelQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuarioFimVigenciaQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuarioInativoQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuarioNotificacaoInatividadeQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuarioServidorNovaSenhaQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuariosAuditoresQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuariosComNovaSenhaQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuariosEntidadeQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuariosFuncaoEspecificaQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuariosQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuariosSerQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuariosSerRseQuery;
import com.zetra.econsig.persistence.query.usuario.ListaUsuariosServidorLoginQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemNomeUsuarioQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemPapelUsuarioQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemTotalUsuariosPorEmailQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemUsuarioCsaCorQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemUsuarioCseOrgQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemUsuarioCseQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemUsuarioQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemUsuarioServidorQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemUsuarioSupQuery;
import com.zetra.econsig.persistence.query.usuario.ObtemUsuarioTipoQuery;
import com.zetra.econsig.persistence.query.usuario.UsuarioCorPodeModificarPerfilQuery;
import com.zetra.econsig.persistence.query.usuario.UsuarioCorPodeModificarUsuQuery;
import com.zetra.econsig.persistence.query.usuario.UsuarioCsaPodeModificarPerfilQuery;
import com.zetra.econsig.persistence.query.usuario.UsuarioCsaPodeModificarUsuQuery;
import com.zetra.econsig.persistence.query.usuario.UsuarioCsePodeModificarUsuQuery;
import com.zetra.econsig.persistence.query.usuario.UsuarioEstPodeModificarUsuQuery;
import com.zetra.econsig.persistence.query.usuario.UsuarioOrgPodeModificarPerfilQuery;
import com.zetra.econsig.persistence.query.usuario.UsuarioOrgPodeModificarUsuQuery;
import com.zetra.econsig.service.arquivo.HistoricoArquivoController;
import com.zetra.econsig.service.consignante.ConsignanteController;
import com.zetra.econsig.service.consignataria.ConsignatariaController;
import com.zetra.econsig.service.correspondente.CorrespondenteController;
import com.zetra.econsig.service.parametro.ParametroController;
import com.zetra.econsig.service.servico.ServicoController;
import com.zetra.econsig.service.servidor.PesquisarServidorController;
import com.zetra.econsig.service.servidor.ServidorController;
import com.zetra.econsig.values.CanalEnum;
import com.zetra.econsig.values.CodedValues;
import com.zetra.econsig.values.Columns;
import com.zetra.econsig.values.OperacaoValidacaoTotpEnum;
import com.zetra.econsig.values.ParamEmailExternoServidorEnum;
import com.zetra.econsig.values.PermiteValidacaoTotpEnum;
import com.zetra.econsig.values.TipoArquivoEnum;
import com.zetra.econsig.webclient.sso.SSOClient;

/**
 * <p>Title: UsuarioControllerBean</p>
 * <p>Description: Session Façade para manipulação de usuário</p>
 * <p>Copyright: Copyright (c) 2003</p>
 * <p>Company: ZetraSoft Ltda.</p>
 * $
 * $
 * $
 */
@Service
@Transactional
public class UsuarioControllerBean implements UsuarioController {
    private static final org.apache.commons.logging.Log LOG = org.apache.commons.logging.LogFactory.getLog(UsuarioControllerBean.class);

    // TODO Criar uma constante única para todo o código
    private static final String MENSAGEM_ERRO_INTERNO_SISTEMA = "mensagem.erroInternoSistema";

    @Autowired
    private ConsignanteController consignanteController;

    @Autowired
    private ConsignatariaController consignatariaController;

    @Autowired
    private HistoricoArquivoController historicoArquivoController;

    @Autowired
    private ServidorController servidorController;

    @Autowired
    private ServicoController servicoController;

    @Autowired
    private ParametroController parametroController;

    @Autowired
    private PesquisarServidorController pesquisarServidorController;

    @Autowired
    private CorrespondenteController correspondenteController;

    @Lazy(true)
    @Autowired
    private SSOClient ssoClient;

    // Usuario
    @Override
    public UsuarioTransferObject findUsuario(UsuarioTransferObject usuario, String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        return setUsuarioValues(findUsuarioBean(usuario, tipo));
    }

    @Override
    public UsuarioTransferObject findUsuario(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        final UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        return findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);
    }

    @Override
    public UsuarioTransferObject findUsuarioSer(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        final UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        return findUsuario(usuario, AcessoSistema.ENTIDADE_SER, responsavel);
    }

    @Override
    public UsuarioTransferObject findUsuarioByLogin(String login, AcessoSistema responsavel) throws UsuarioControllerException {
        final UsuarioTransferObject usuario = new UsuarioTransferObject();
        usuario.setUsuLogin(login);
        return findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);
    }

    @Override
    public String findUsuarioPerfil(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        // Remove o perfil do usuário
        try {
            final PerfilUsuario upeBean = PerfilUsuarioHome.findByPrimaryKey(usuCodigo);
            return upeBean.getPerfil().getPerCodigo();
        } catch (final FindException e) {
            return null;
        }
    }

    @Override
    public CustomTransferObject findTipoUsuarioByLogin(String usuLogin, AcessoSistema responsavel) throws UsuarioControllerException {
        CustomTransferObject usuario = null;
        try {
            final ObtemUsuarioQuery query = new ObtemUsuarioQuery();
            query.usuLogin = usuLogin;
            final List<TransferObject> list = query.executarDTO();
            if (list.size() > 0) {
                usuario = (CustomTransferObject) list.get(0);
            }
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
        return usuario;
    }

    @Override
    public CustomTransferObject findTipoUsuarioByCodigo(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        CustomTransferObject usuario = null;
        try {
            final ObtemUsuarioQuery query = new ObtemUsuarioQuery();
            query.usuCodigo = usuCodigo;
            final List<TransferObject> list = query.executarDTO();
            if (list.size() > 0) {
                usuario = (CustomTransferObject) list.get(0);
            }
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
        return usuario;
    }

    @Override
    public List<TransferObject> findUsuarioCseList(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemUsuarioCseQuery query = new ObtemUsuarioCseQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public Usuario findUsuarioByEmailAndToken(String email, String token, AcessoSistema responsavel) throws UsuarioControllerException {
        List<Usuario> usuarioBean = null;

        try {
            usuarioBean = UsuarioHome.findByEmailAndToken(email, token);

        } catch (final FindException e) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", (AcessoSistema) null);
        }

        if (usuarioBean == null) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", (AcessoSistema) null);
        }

        if (usuarioBean.size() > 1) {
            throw new UsuarioControllerException("mensagem.erro.usuario.multiplo", (AcessoSistema) null);
        }

        return usuarioBean.get(0);
    }

    @Override
    public List<TransferObject> findUsuarioByEmail(String email, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemUsuarioQuery query = new ObtemUsuarioQuery();
            query.usuEmail = email;
            return query.executarDTO();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public List<UsuarioTransferObject> lstUsuariosSerByEmail(String email, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final List<UsuarioTransferObject> retorno = new ArrayList<>();

            final List<Usuario> usuarios = UsuarioHome.findByEmail(email);
            if ((usuarios != null) && !usuarios.isEmpty()) {
                for (final Usuario usuario : usuarios) {
                    try {
                        // Verifica se é usuário servidor
                        findUsuarioSer(usuario.getUsuCodigo(), responsavel);

                        if (!TextHelper.isNull(usuario.getUsuCpf())) {
                            retorno.add(setUsuarioValues(usuario));
                        }
                    } catch (final UsuarioControllerException e) {
                        // Se não é usuário servidor, não inclui na lista que será retornada
                    }
                }
            }

            return retorno;
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    private Usuario findUsuarioBean(UsuarioTransferObject usuario, String tipo) throws UsuarioControllerException {
        tipo = tipo.toUpperCase();

        if (!AcessoSistema.ENTIDADE_USU.equals(tipo) && (usuario.getUsuCodigo() == null)) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", (AcessoSistema) null);
        }

        Usuario usuarioBean = null;
        try {
            if (AcessoSistema.ENTIDADE_USU.equals(tipo)) {
                if (usuario.getUsuCodigo() != null) {
                    usuarioBean = UsuarioHome.findByPrimaryKey(usuario.getUsuCodigo());
                } else if (usuario.getUsuLogin() != null) {
                    usuarioBean = UsuarioHome.findByLogin(usuario.getUsuLogin());
                }
            } else if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                usuarioBean = UsuarioHome.findUsuCse(usuario.getUsuCodigo());
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                usuarioBean = UsuarioHome.findUsuCsa(usuario.getUsuCodigo());
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                usuarioBean = UsuarioHome.findUsuCor(usuario.getUsuCodigo());
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                usuarioBean = UsuarioHome.findUsuOrg(usuario.getUsuCodigo());
            } else if (AcessoSistema.ENTIDADE_SER.equals(tipo)) {
                usuarioBean = UsuarioHome.findUsuSer(usuario.getUsuCodigo());
            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                usuarioBean = UsuarioHome.findUsuSup(usuario.getUsuCodigo());
            }
        } catch (final FindException e) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", (AcessoSistema) null, e);
        }
        if (usuarioBean == null) {
            // Se não deu FindException, significa que o método foi chamado com ENTIDADE_USU
            // e não foi passado usuCodigo nem usuLogin. Chama o dumpStack para identificarmos
            // o ponto que está chamando o método com parâmetros inválidos.
            Thread.dumpStack();
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", (AcessoSistema) null);
        }

        return usuarioBean;
    }

    private Collection<?> findFuncaoPerfilBean(String usuCodigo, String tipo) throws UsuarioControllerException {
        tipo = tipo.toUpperCase();

        try {
            Collection<?> funcoes = null;

            if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                funcoes = FuncaoPerfilCseHome.findByUsuCodigo(usuCodigo);
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                funcoes = FuncaoPerfilCsaHome.findByUsuCodigo(usuCodigo);
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                funcoes = FuncaoPerfilCorHome.findByUsuCodigo(usuCodigo);
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                funcoes = FuncaoPerfilOrgHome.findByUsuCodigo(usuCodigo);
            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                funcoes = FuncaoPerfilSupHome.findByUsuCodigo(usuCodigo);
            }
            return funcoes;
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.perfil.usuario.nao.encontrado", (AcessoSistema) null);
        }
    }

    /**
     * Recupera arquivos de um usuário na base
     * @param usuCodigo - código do usuário
     * @param tarCodigo - tipo de arquivo de usuário que se deseja buscar (opcional)
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public Collection<ArquivoUsuario> findArquivoUsuario(String usuCodigo, String tarCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            return ArquivoUsuarioHome.findByUsuCodigoTipoArquivo(usuCodigo, tarCodigo);
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.arquivo.nao.encontrado", (AcessoSistema) null);
        }
    }

    private UsuarioTransferObject setUsuarioValues(Usuario usuarioBean) {
        final UsuarioTransferObject usuario = new UsuarioTransferObject(usuarioBean.getUsuCodigo());
        if (usuarioBean.getUsuDataCad() != null) {
            usuario.setUsuDataCad(DateHelper.toSQLDate(usuarioBean.getUsuDataCad()));
        }
        usuario.setStuCodigo(usuarioBean.getStatusLogin().getStuCodigo());
        usuario.setUsuLogin(usuarioBean.getUsuLogin());
        usuario.setUsuSenha(usuarioBean.getUsuSenha());
        usuario.setUsuSenha2(usuarioBean.getUsuSenha2());
        usuario.setUsuSenhaApp(usuarioBean.getUsuSenhaApp());
        usuario.setUsuNome(usuarioBean.getUsuNome());
        usuario.setUsuEmail(usuarioBean.getUsuEmail());
        usuario.setUsuTel(usuarioBean.getUsuTel());
        usuario.setUsuDicaSenha(usuarioBean.getUsuDicaSenha());
        usuario.setUsuTipoBloq(usuarioBean.getUsuTipoBloq());
        if (usuarioBean.getUsuDataExpSenha() != null) {
            usuario.setUsuDataExpSenha(DateHelper.toSQLDate(usuarioBean.getUsuDataExpSenha()));
        }
        if (usuarioBean.getUsuDataExpSenha2() != null) {
            usuario.setUsuDataExpSenha2(DateHelper.toSQLDate(usuarioBean.getUsuDataExpSenha2()));
        }
        if (usuarioBean.getUsuDataUltAcesso() != null) {
            usuario.setUsuDataUltAcesso(DateHelper.toSQLDate(usuarioBean.getUsuDataUltAcesso()));
        }
        usuario.setUsuIpAcesso(usuarioBean.getUsuIpAcesso());
        usuario.setUsuDDNSAcesso(usuarioBean.getUsuDdnsAcesso());
        usuario.setUsuCPF(usuarioBean.getUsuCpf());
        usuario.setUsuCentralizador(usuarioBean.getUsuCentralizador() != null ? usuarioBean.getUsuCentralizador().toString() : null);
        usuario.setUsuVisivel(usuarioBean.getUsuVisivel() != null ? usuarioBean.getUsuVisivel().toString() : null);
        usuario.setUsuExigeCertificado(usuarioBean.getUsuExigeCertificado() != null ? usuarioBean.getUsuExigeCertificado().toString() : null);
        usuario.setUsuMatriculaInst(usuarioBean.getUsuMatriculaInst() != null ? usuarioBean.getUsuMatriculaInst().toString() : null);
        usuario.setUsuChaveRecuperarSenha(usuarioBean.getUsuChaveRecuperarSenha() != null ? usuarioBean.getUsuChaveRecuperarSenha().toString() : null);
        usuario.setUsuNovaSenha(usuarioBean.getUsuNovaSenha() != null ? usuarioBean.getUsuNovaSenha().toString() : null);
        usuario.setUsuDataFimVig(usuarioBean.getUsuDataFimVig() != null ? new Date(usuarioBean.getUsuDataFimVig().getTime()) : null);
        usuario.setUsuDeficienteVisual(usuarioBean.getUsuDeficienteVisual() != null ? usuarioBean.getUsuDeficienteVisual().toString() : null);
        usuario.setUsuDataRecSenha(usuarioBean.getUsuDataRecSenha() != null ? new Date(usuarioBean.getUsuDataRecSenha().getTime()) : null);
        usuario.setUsuChaveValidacaoTotp(usuarioBean.getUsuChaveValidacaoTotp());
        usuario.setUsuPermiteValidacaoTotp(usuarioBean.getUsuPermiteValidacaoTotp());
        usuario.setUsuOperacoesValidacaoTotp(usuarioBean.getUsuOperacoesValidacaoTotp());
        usuario.setUsuOperacoesSenha2(usuarioBean.getUsuOperacoesSenha2());
        usuario.setUsuOtpCodigo(usuarioBean.getUsuOtpCodigo());
        usuario.setUsuOtpChaveSeguranca(usuarioBean.getUsuOtpChaveSeguranca());
        usuario.setUsuOtpDataCadastro(usuarioBean.getUsuOtpDataCadastro());
        usuario.setUsuQtdConsultasMargem(usuarioBean.getUsuQtdConsultasMargem());
        usuario.setUsuAutentiaSso(usuarioBean.getUsuAutenticaSso());
        usuario.setUsuAutorizaEmailMarketing(usuarioBean.getUsuAutorizaEmailMarketing());
        return usuario;
    }

    @Override
    public String createUsuario(UsuarioTransferObject usuario, List<String> funcoes, String codigoEntidade, String tipo, String senhaAberta, AcessoSistema responsavel) throws UsuarioControllerException {
        return createUsuario(usuario, funcoes, null, codigoEntidade, tipo, null, true, senhaAberta, true, responsavel);
    }

    @Override
    public String createUsuario(UsuarioTransferObject usuario, List<String> funcoes, String codigoEntidade, String tipo, TransferObject tipoMotivoOperacao, boolean validaCpfEmail, String senhaAberta, AcessoSistema responsavel) throws UsuarioControllerException {
        return createUsuario(usuario, funcoes, null, codigoEntidade, tipo, tipoMotivoOperacao, validaCpfEmail, senhaAberta, true, responsavel);
    }

    @Override
    public String createUsuario(UsuarioTransferObject usuario, List<String> funcoes, String codigoEntidade, String tipo, TransferObject tipoMotivoOperacao, boolean validaCpfEmail, String senhaAberta, boolean validaForcaSenha, AcessoSistema responsavel) throws UsuarioControllerException {
        return createUsuario(usuario, funcoes, null, codigoEntidade, tipo, tipoMotivoOperacao, validaCpfEmail, senhaAberta, validaForcaSenha, responsavel);
    }

    @Override
    public String createUsuario(UsuarioTransferObject usuario, String perCodigo, String codigoEntidade, String tipo, String senhaAberta, AcessoSistema responsavel) throws UsuarioControllerException {
        return createUsuario(usuario, null, perCodigo, codigoEntidade, tipo, null, true, senhaAberta, true, responsavel);
    }

    @Override
    public String createUsuario(UsuarioTransferObject usuario, String perCodigo, String codigoEntidade, String tipo, TransferObject tipoMotivoOperacao, boolean validaCpfEmail, String senhaAberta, boolean validaForcaSenha, AcessoSistema responsavel) throws UsuarioControllerException {
        return createUsuario(usuario, null, perCodigo, codigoEntidade, tipo, tipoMotivoOperacao, validaCpfEmail, senhaAberta, validaForcaSenha, responsavel);
    }

    private String createUsuario(UsuarioTransferObject usuario, List<String> funcoes, String perCodigo, String codigoEntidade, String tipo, TransferObject tipoMotivoOperacao, boolean validaCpfEmail, String senhaAberta, boolean validaForcaSenha, AcessoSistema responsavel) throws UsuarioControllerException {
        String usuCodigo = null;
        try {
            // Verifica se não existe outro usuário com o mesmo login
            final UsuarioTransferObject teste = new UsuarioTransferObject();
            teste.setUsuLogin((String) usuario.getAttribute(Columns.USU_LOGIN));

            boolean existe = false;
            try {
                findUsuarioBean(teste, AcessoSistema.ENTIDADE_USU);
                existe = true;
            } catch (final UsuarioControllerException ex) {
                // OK, nenhum usuário encontrato com o login informado
            }

            if (existe) {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.criar.este.usuario.existe.outro.mesmo.login.cadastrado.sistema", responsavel);
            }

            boolean autenticaSSO = false;

            if (responsavel.isCsa() && responsavel.getCanal() == CanalEnum.WEB) {

                boolean campoAutenticaSsoTrue = (!TextHelper.isNull(usuario.getUsuAutenticaSso()) && usuario.getUsuAutenticaSso().equals("S"));
                // Verifica se como CSA o campo autentica via SSO é verdadeiro
                autenticaSSO = campoAutenticaSsoTrue;

            } else {
                // se o parâmetro de sistema do papel autentica no SSO
                autenticaSSO = validarDadosSSO(usuario, codigoEntidade, tipo, responsavel);
            }

            
            
            boolean enviaEmailInicializacaoSenha = false;

            // Na criação do usuário MASTER realizado durante a criação da CSA, não valido CPF ou email
            if (validaCpfEmail) {

                validaCpfUsuario(usuario.getUsuCPF(), tipo, responsavel);
                validaUnicidadeCpf(usuario.getUsuCodigo(), usuario.getUsuCPF(), tipo, codigoEntidade, responsavel);

                enviaEmailInicializacaoSenha = verificarSeEnviaEmailInicializacaoSenha(autenticaSSO, tipo, usuario, responsavel);

            }

            if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                final boolean usuTelObrigatorio = ParamSist.paramEquals(CodedValues.TPC_CADASTRO_TELEFONE_OBRIGATORIO_USUARIO_SUP, CodedValues.TPC_SIM, responsavel);
                if (usuTelObrigatorio && TextHelper.isNull(usuario.getUsuTel())) {
                    throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.telefone.usuario.deve.ser.informado", responsavel);
                }
            }
            if (AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                final boolean usuTelObrigatorio = ParamSist.paramEquals(CodedValues.TPC_CADASTRO_TELEFONE_OBRIGATORIO_USUARIO_CSE, CodedValues.TPC_SIM, responsavel);
                if (usuTelObrigatorio && TextHelper.isNull(usuario.getUsuTel())) {
                    throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.telefone.usuario.deve.ser.informado", responsavel);
                }
            }
            
            // Cria a entidade na tb_usuario
            final String usuExigeCertificado = !TextHelper.isNull(usuario.getUsuExigeCertificado()) ? usuario.getUsuExigeCertificado().substring(0, 1) : null;
            final String usuCentralizador = !TextHelper.isNull(usuario.getUsuCentralizador()) ? usuario.getUsuCentralizador().substring(0, 1) : null;
            final String usuVisivel = !TextHelper.isNull(usuario.getUsuVisivel()) ? usuario.getUsuVisivel().substring(0, 1) : null;

            if (validaForcaSenha) {
                SenhaHelper.validarForcaSenha(senhaAberta, AcessoSistema.ENTIDADE_SER.equals(tipo), responsavel);
            }

            final Usuario usuarioBean = UsuarioHome.create(usuario.getStuCodigo(), usuario.getUsuLogin(), usuario.getUsuSenha(), usuario.getUsuSenha2(), usuario.getUsuNome(), usuario.getUsuEmail(), usuario.getUsuTel(), usuario.getUsuDicaSenha(), usuario.getUsuTipoBloq(), usuario.getUsuDataExpSenha(), usuario.getUsuDataExpSenha2(), usuario.getUsuIpAcesso(), usuario.getUsuDDNSAcesso(), usuario.getUsuCPF(), usuCentralizador, usuVisivel, usuExigeCertificado, usuario.getUsuMatriculaInst(), usuario.getUsuChaveRecuperarSenha(), usuario.getUsuDataFimVig(), usuario.getUsuDeficienteVisual(),
                                                           usuario.getUsuChaveValidacaoTotp(), usuario.getUsuPermiteValidacaoTotp(), usuario.getUsuQtdConsultasMargem(), usuario.getUsuAutenticaSso());
            usuCodigo = usuarioBean.getUsuCodigo();

            // Cria a entidade na tb_usuario_xxx
            createUsuarioEntidade(usuCodigo, codigoEntidade, tipo);

            // Verifica se o responsável tem permissão para criar este usuário
            usuarioPodeModificarUsu(usuCodigo, false, true, responsavel);

            // Cria o perfil do usuário
            updateUsuarioPerfil(funcoes, perCodigo, usuCodigo, codigoEntidade, tipo, false, responsavel);

            // Recupera as funções que pertencem ao papel do novo usuário e
            // que estão bloqueadas para o usuário responsável, que serão bloqueadas também para o novo usuário
            final List<String> codSvcEntidade = retornaCodigoServicoEntidade(codigoEntidade, tipo, responsavel);
            final List<TransferObject> lista = selectFuncoesBloqueadas(responsavel.getUsuCodigo(), tipo, responsavel);
            if (!lista.isEmpty()) {
                final List<TransferObject> funcoesBloqueadas = new ArrayList<>();
                for (final TransferObject to : lista) {
                    // Se não retornou uma lista de serviços nula,
                    // é porque a entidade possui convênio com todos os serviços.
                    // Se retornou serviços, devem ser validados os serviços que pertencem ao convênio da entidade.
                    if ((codSvcEntidade == null) || ((codSvcEntidade != null) && !codSvcEntidade.isEmpty() && codSvcEntidade.contains(to.getAttribute(Columns.BUF_SVC_CODIGO).toString()))) {
                        to.setAttribute(Columns.BUF_USU_CODIGO, usuCodigo);
                        funcoesBloqueadas.add(to);
                    }
                }
                // Insere bloqueio de funções para o novo usuário
                insereBloqueiosFuncoes(usuCodigo, funcoesBloqueadas, responsavel);
            }

            // Cria ocorrência de inclusão de usuário
            final CustomTransferObject ocorrencia = new CustomTransferObject();
            ocorrencia.setAttribute(Columns.OUS_USU_CODIGO, usuCodigo);
            ocorrencia.setAttribute(Columns.OUS_TOC_CODIGO, CodedValues.TOC_INCLUSAO_USUARIO);
            ocorrencia.setAttribute(Columns.OUS_OUS_USU_CODIGO, responsavel.getUsuCodigo());
            ocorrencia.setAttribute(Columns.OUS_OBS, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.inclusao.usuario", responsavel));
            ocorrencia.setAttribute(Columns.OUS_IP_ACESSO, responsavel.getIpUsuario());
            if (tipoMotivoOperacao != null) {
                ocorrencia.setAttribute(Columns.OUS_OBS, ocorrencia.getAttribute(Columns.OUS_OBS) + (ocorrencia.getAttribute(Columns.OUS_OBS).toString().lastIndexOf(".") == (ocorrencia.getAttribute(Columns.OUS_OBS).toString().length() - 1) ? " " : ". ") + tipoMotivoOperacao.getAttribute(Columns.OUS_OBS));
                ocorrencia.setAttribute(Columns.OUS_TMO_CODIGO, tipoMotivoOperacao.getAttribute(Columns.TMO_CODIGO));
            }

            createOcorrenciaUsuario(ocorrencia, responsavel);

            if (enviaEmailInicializacaoSenha) {
                final String linkReinicializacao = usuario.getLinkRecuperarSenha();

                if (TextHelper.isNull(linkReinicializacao)) {
                    throw new UsuarioControllerException("mensagem.erro.usuario.link.senha.ausente", responsavel);
                }

                // Gera uma nova codigo de recuparação de senha
                final String cod_Senha = SynchronizerToken.generateToken();
                // Atualiza o codigo de recuperação de senha do usuário
                alteraChaveRecupSenha(usuCodigo, cod_Senha, responsavel);
                // Envia e-mail com link para recuperação de senha
                enviaLinkIniciacaoSenhaNovoUsuario(usuCodigo, usuario.getUsuEmail(), (String) usuario.getAttribute(Columns.USU_LOGIN), usuario.getUsuNome(), linkReinicializacao, cod_Senha, responsavel);
                // Limpa o atributo para não ser gravado no log
                usuario.setLinkRecuperarSenha(null);
            }

            if (autenticaSSO) {
                // Irá verificar se o sso está habilitado e cria o usuário no sso
                ssoClient.addUsuarioSSO(usuario, senhaAberta, tipo, codigoEntidade, responsavel);
            }

            final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.CREATE, Log.LOG_INFORMACAO);
            log.setUsuario(usuCodigo);
            log.setStatusLogin(usuario.getStuCodigo());
            log.getUpdatedFields(usuario.getAtributos(), null);

            if (!TextHelper.isNull(tipo)) {
                final List<String> codigosEntidade = new ArrayList<>();
                codigosEntidade.add(codigoEntidade);

                log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.usuario.tipo.arg0", responsavel, tipo + " "));
                if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                    log.add(Columns.CSE_NOME, codigosEntidade, ConsignanteHome.class);
                } else if (AcessoSistema.ENTIDADE_EST.equals(tipo)) {
                    log.add(Columns.EST_NOME, codigosEntidade, EstabelecimentoHome.class);
                } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                    log.add(Columns.ORG_NOME, codigosEntidade, OrgaoHome.class);
                } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                    log.add(Columns.CSA_NOME, codigosEntidade, ConsignatariaHome.class);
                } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                    log.add(Columns.COR_NOME, codigosEntidade, CorrespondenteHome.class);
                } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                    log.add(Columns.CSE_NOME, codigosEntidade, ConsignanteHome.class);
                }
            }

            if ((perCodigo != null) && !"".equals(perCodigo)) {
                log.setPerfil(perCodigo);
            } else {
                log.add(Columns.FUN_CODIGO, funcoes, FuncaoHome.class);
            }
            log.write();
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.criar.usuario.erro.interno.arg0", responsavel, ex.getMessage());
        } catch (final ZetraException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(e);
        }
        return usuCodigo;
    }

    private boolean verificarSeEnviaEmailInicializacaoSenha(boolean autenticaSSO, 
            String tipo,
            UsuarioTransferObject usuario,
            AcessoSistema responsavel) throws UsuarioControllerException {
        
        //DESENV-10463: Verifica se sistema envia e-mail de inicialização de senha na criação do usuário do tipo em questão
        boolean enviaEmailInicializacaoSenha = ((AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_ORG.equals(tipo)) && ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_CRIACAO_SENHA_NOVO_USU_CSE_ORG, CodedValues.TPC_SIM, responsavel)) || ((AcessoSistema.ENTIDADE_CSA.equals(tipo) || AcessoSistema.ENTIDADE_COR.equals(tipo)) && ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_CRIACAO_SENHA_NOVO_USU_CSA_COR, CodedValues.TPC_SIM, responsavel)) ||
                                        (AcessoSistema.ENTIDADE_SUP.equals(tipo) && ParamSist.paramEquals(CodedValues.TPC_ENVIA_EMAIL_CRIACAO_SENHA_NOVO_USU_SUP, CodedValues.TPC_SIM, responsavel));

        if (AcessoSistema.ENTIDADE_CSA.equals(tipo) || AcessoSistema.ENTIDADE_COR.equals(tipo)) {
            final boolean usuEmailObrigatorio = enviaEmailInicializacaoSenha || ParamSist.getBoolParamSist(CodedValues.TPC_CADASTRO_EMAIL_OBRIGATORIO_USUARIO_CSA, responsavel);
            if (usuEmailObrigatorio && TextHelper.isNull(usuario.getUsuEmail())) {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.email.usuario.deve.ser.informado", responsavel);
            }
        } else if (AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_ORG.equals(tipo) || AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
            final boolean usuEmailObrigatorio = enviaEmailInicializacaoSenha || ParamSist.getBoolParamSist(CodedValues.TPC_CADASTRO_EMAIL_OBRIGATORIO_CSE_ORG_SUP, responsavel);
            if (usuEmailObrigatorio && TextHelper.isNull(usuario.getUsuEmail())) {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.email.usuario.deve.ser.informado", responsavel);
            }
        }
        
        boolean ehCriacaoUsuarioViaAccessGateway = autenticaSSO && responsavel.getCanal() == CanalEnum.SOAP;

        if (ehCriacaoUsuarioViaAccessGateway) {
            enviaEmailInicializacaoSenha = false;
        }

        return enviaEmailInicializacaoSenha;

    }

    private boolean validarDadosSSO(UsuarioTransferObject usuario, String codigoEntidade, String tipoEntidade, AcessoSistema responsavel) throws UsuarioControllerException, ParametroControllerException {

        boolean realizaCadastroSSO = UsuarioHelper.usuarioAutenticaSso(usuario, tipoEntidade, responsavel);

        if (AcessoSistema.ENTIDADE_CSA.equals(tipoEntidade)) {
            // Caso seja consignatária, valida se o parâmetro de criação de usuário autenticado no SSO foi habilitado para a CSA
            realizaCadastroSSO = false;
            final String criaUsuarioAutenticaoSSO = parametroController.getParamCsa(codigoEntidade, CodedValues.TPA_USUARIO_AUTENTICA_SSO, responsavel);

            if (!TextHelper.isNull(criaUsuarioAutenticaoSSO) && "S".equalsIgnoreCase(criaUsuarioAutenticaoSSO)) {
                realizaCadastroSSO = true;
            }
        } else if (AcessoSistema.ENTIDADE_COR.equals(tipoEntidade)) {
            // Se for correspondente, o padrão é criar não autenticando no SSO
            realizaCadastroSSO = false;
        }

        if (realizaCadastroSSO) {
            // Validar se email cadastrado
            if (TextHelper.isNull(usuario.getUsuEmail())) {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.email.usuario.deve.ser.informado", responsavel);
            }

            // Seta para autenticar no SSO
            usuario.setUsuAutentiaSso(CodedValues.TPC_SIM);
        }

        return realizaCadastroSSO;
    }

    /**
     * Retorna os códigos dos serviços disponíveis para a entidade informada.
     * Se retornou uma lista nula é porque a entidade é cse e possui convênio com todos os serviços.
     *
     * @param codigoEntidade Código da entidade informada.
     * @param tipo Tipo da entidade informada.
     * @param responsavel
     * @return Retorna uma lista com os códigos dos serviços disponíveis para a entidade informada. Se a lista nula é porque a entidade é cse e possui convênio com todos os serviços.
     * @throws UsuarioControllerException
     */
    private List<String> retornaCodigoServicoEntidade(String codigoEntidade, String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        tipo = tipo.toUpperCase();
        List<String> retorno = null;
        try {
            List<TransferObject> servicos = null;
            if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                servicos = servicoController.selectServicosCsa(codigoEntidade, responsavel);
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                servicos = servicoController.selectServicosCorrespondente(codigoEntidade, responsavel);
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                servicos = servicoController.selectServicosOrgao(codigoEntidade, responsavel);
            }

            if ((servicos != null) && !servicos.isEmpty()) {
                retorno = new ArrayList<>();
                for (final TransferObject servico : servicos) {
                    retorno.add(servico.getAttribute(Columns.SVC_CODIGO).toString());
                }
            }

        } catch (final ServicoControllerException ex) {
            throw new UsuarioControllerException(ex);
        }
        return retorno;
    }

    private void createUsuarioEntidade(String usuCodigo, String codigoEntidade, String tipo) throws UsuarioControllerException {
        tipo = tipo.toUpperCase();
        try {
            final String stuCodigo = CodedValues.STU_ATIVO;

            if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                UsuarioCseHome.create(codigoEntidade, usuCodigo, stuCodigo);
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                UsuarioCsaHome.create(codigoEntidade, usuCodigo, stuCodigo);
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                UsuarioCorHome.create(codigoEntidade, usuCodigo, stuCodigo);
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                UsuarioOrgHome.create(codigoEntidade, usuCodigo, stuCodigo);
            } else if (AcessoSistema.ENTIDADE_SER.equals(tipo)) {
                UsuarioSerHome.create(codigoEntidade, usuCodigo, stuCodigo);
            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                UsuarioSupHome.create(codigoEntidade, usuCodigo, stuCodigo);
            }
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.criar.usuario.erro.interno.arg0", (AcessoSistema) null, ex.getMessage());
        }
    }

    private void createUsuarioPerfil(List<String> funcoes, String usuCodigo, String codigoEntidade, String tipo) throws UsuarioControllerException {
        tipo = tipo.toUpperCase();
        if (funcoes == null) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.criar.usuario.erro.interno.arg0", (AcessoSistema) null, ApplicationResourcesHelper.getMessage("mensagem.informacao.lista.funcoes.perfil.usuario.nao.pode.ser.nula", (AcessoSistema) null));
        }

        try {
            final Iterator<String> it = funcoes.iterator();

            if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                while (it.hasNext()) {
                    final String funCodigo = it.next().toString();
                    FuncaoPerfilCseHome.create(codigoEntidade, usuCodigo, funCodigo);
                }
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                while (it.hasNext()) {
                    final String funCodigo = it.next().toString();
                    FuncaoPerfilCsaHome.create(codigoEntidade, usuCodigo, funCodigo);
                }
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                while (it.hasNext()) {
                    final String funCodigo = it.next().toString();
                    FuncaoPerfilCorHome.create(codigoEntidade, usuCodigo, funCodigo);
                }
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                while (it.hasNext()) {
                    final String funCodigo = it.next().toString();
                    FuncaoPerfilOrgHome.create(codigoEntidade, usuCodigo, funCodigo);
                }
            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                while (it.hasNext()) {
                    final String funCodigo = it.next().toString();
                    FuncaoPerfilSupHome.create(codigoEntidade, usuCodigo, funCodigo);
                }
            }
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.criar.usuario.erro.interno.arg0", (AcessoSistema) null, ex.getMessage());
        }
    }

    private void updateUsuario(UsuarioTransferObject usuario, OcorrenciaUsuarioTransferObject ocorrenciaUsu, AcessoSistema responsavel) throws UsuarioControllerException {
        alteraUsuario(usuario, ocorrenciaUsu, null, null, null, null, false, false, false, null, responsavel);
    }

    @Override
    public void updateUsuario(UsuarioTransferObject usuario, OcorrenciaUsuarioTransferObject ocorrenciaUsu, List<String> funcoes, String perCodigo, String tipo, String codigoEntidade, TransferObject tipoMotivoOperacao, AcessoSistema responsavel) throws UsuarioControllerException {
        alteraUsuario(usuario, ocorrenciaUsu, funcoes, perCodigo, tipo, codigoEntidade, true, true, true, tipoMotivoOperacao, responsavel);
    }

    private void updateUsuario(UsuarioTransferObject usuario, OcorrenciaUsuarioTransferObject ocorrenciaUsu, List<String> funcoes, String perCodigo, String tipo, String codigoEntidade, TransferObject tipoMotivoOperacao, AcessoSistema responsavel, Boolean validarCpf) throws UsuarioControllerException {
        alteraUsuario(usuario, ocorrenciaUsu, funcoes, perCodigo, tipo, codigoEntidade, validarCpf, true, true, tipoMotivoOperacao, responsavel);
    }

    /**
     * Altera os dados do usuário.
     * Se uma ocorrência for passada por parâmetro a mesma será salva, caso contrário será incluída uma ocorrência de alteração de usuário.
     * @param usuario : Dados para alteração do usuário
     * @param ocorrenciaUsu : Ocorrencia que deverá ser incluída, caso seja nula será criada uma ocorrência de alteração de usuário.
     * @param funcoes : Funções de perfil personalizado do usuário
     * @param perCodigo : Perfil não personalizado do usuário
     * @param tipo : Tipo da entidade do usuario.
     * @param codigoEntidade : Código da entidade do usuário
     * @param validaCpf : True caso seja para validar o CPF do usuário
     * @param validaEmail : True caso seja para validar o Email do usuário de CSA/COR
     * @param validaTel : True caso seja para validar o Telefone do usuário CSA/COR
     * @param tipoMotivoOperacao : Motivo da operação
     * @param responsavel : Responsável pela operação
     * @throws UsuarioControllerException
     */
    private void alteraUsuario(UsuarioTransferObject usuario, OcorrenciaUsuarioTransferObject ocorrenciaUsu, List<String> funcoes, String perCodigo, String tipo, String codigoEntidade, boolean validaCpf, boolean validaEmail, boolean validaTel, TransferObject tipoMotivoOperacao, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            // Se é consumo de senha, ou o usuário pode modificar o usuário, realiza a operação
            if (((ocorrenciaUsu != null) && ocorrenciaUsu.isUtilizacaoSenhaAutServidor()) || usuarioPodeModificarUsu(usuario.getUsuCodigo(), true, true, responsavel)) {

                final Usuario usuarioBean = findUsuarioBean(usuario, AcessoSistema.ENTIDADE_USU);
                final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.UPDATE, Log.LOG_INFORMACAO);
                log.setUsuario(usuarioBean.getUsuCodigo());

                /* Compara a versão do cache com a passada por parâmetro */
                final String usuLoginAntesExclusao = usuarioBean.getUsuLogin();
                final UsuarioTransferObject usuarioCache = setUsuarioValues(usuarioBean);
                final CustomTransferObject merge = log.getUpdatedFields(usuario.getAtributos(), usuarioCache.getAtributos());

                final StringBuilder msgOus = new StringBuilder();

                if (merge.getAtributos().containsKey(Columns.USU_LOGIN)) {

                    // Verifica se não existe outro usuário com o mesmo login
                    final UsuarioTransferObject teste = new UsuarioTransferObject();
                    teste.setUsuLogin((String) merge.getAttribute(Columns.USU_LOGIN));

                    boolean existe = false;
                    try {
                        findUsuarioBean(teste, AcessoSistema.ENTIDADE_USU);
                        existe = true;
                    } catch (final UsuarioControllerException ex) {
                    }
                    if (existe) {
                        throw new UsuarioControllerException("mensagem.erro.nao.possivel.alterar.este.usuario.existe.outro.mesmo.login.cadastrado.sistema", responsavel);
                    }
                    msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.login.alterado.de.arg0.para.arg1", responsavel, usuarioBean.getUsuLogin(), (String) merge.getAttribute(Columns.USU_LOGIN)));
                    usuarioBean.setUsuLogin((String) merge.getAttribute(Columns.USU_LOGIN));
                }

                String stu_codigo = "";
                boolean stuAtivo = CodedValues.STU_ATIVO.equals(usuarioBean.getStatusLogin().getStuCodigo());
                if (merge.getAtributos().containsKey(Columns.USU_STU_CODIGO)) {
                    final boolean isCseSup = responsavel == null ? false : responsavel.isCseSup();
                    final boolean isSup = responsavel == null ? false : responsavel.isSup();

                    stu_codigo = merge.getAttribute(Columns.USU_STU_CODIGO) != null ? merge.getAttribute(Columns.USU_STU_CODIGO).toString() : CodedValues.STU_ATIVO;

                    // Se o usuário alterado está sendo bloqueado ...
                    if (CodedValues.STU_BLOQUEADO.equals(stu_codigo)) {

                        // Verifica se ele não esta sendo bloqueado por ele próprio
                        if ((responsavel != null) && usuarioCache.getUsuCodigo().equals(responsavel.getUsuCodigo())) {
                            throw new UsuarioControllerException("mensagem.erro.usuario.nao.pode.bloquear.ele.proprio", responsavel);
                        }

                        // Verifica se o usuário está sendo bloqueado por um usuário da consignante
                        if (isCseSup) {
                            stu_codigo = CodedValues.STU_BLOQUEADO_POR_CSE;
                            usuarioBean.setUsuTipoBloq(ApplicationResourcesHelper.getMessage(isSup ? "mensagem.usuario.bloqueado.sup" : "mensagem.usuario.bloqueado.cse", responsavel));
                        }

                        // Se o usuário alterado está sendo desbloqueado ...
                    } else if (CodedValues.STU_ATIVO.equals(stu_codigo)) {

                        if (!isCseSup && CodedValues.STU_BLOQUEADO_POR_CSE.equals(usuarioCache.getStuCodigo())) {
                            // Verifica se um usuário que não é da consignante está tentando desbloquear um usuário bloqueado pela consignante
                            throw new UsuarioControllerException("mensagem.erro.nao.possivel.desbloquear.usuario.arg0.pois.foi.bloqueado.pelo.consignante", responsavel, usuarioCache.getUsuLogin());
                        } else if (!isSup && CodedValues.STU_BLOQUEADO_AUTOMATICAMENTE_SEGURANCA.equals(usuarioCache.getStuCodigo())) {
                            // verifica se o usuário não é sup e está tentando desbloquear um usuário bloqueado por segurança
                            throw new UsuarioControllerException("mensagem.erro.nao.possivel.desbloquear.usuario.arg0.pois.foi.bloqueado.por.seguranca", responsavel, usuarioCache.getUsuLogin());
                        } else {
                            usuarioBean.setUsuTipoBloq("");
                        }

                        // Se o usuário alterado está sendo cancelado ...
                    } else if (CodedValues.STU_EXCLUIDO.equals(stu_codigo)) {

                        // Altera o login do usuário para o seu código de modo que
                        // novos usuários possam usar o login deste usuário
                        usuarioBean.setUsuTipoBloq(usuarioBean.getUsuLogin());
                        usuarioBean.setUsuLogin(usuarioBean.getUsuCodigo());
                    }

                    stuAtivo = CodedValues.STU_ATIVO.equals(stu_codigo);

                    // Altera o status do usuário
                    final StatusLogin statusLogin = StatusLoginHome.findByPrimaryKey(stu_codigo);
                    usuarioBean.setStatusLogin(statusLogin);
                    log.setStatusLogin(stu_codigo);
                }

                if (merge.getAtributos().containsKey(Columns.USU_NOME)) {
                    final String antes = usuarioBean.getUsuNome() != null ? usuarioBean.getUsuNome() : "";
                    final String depois = merge.getAttribute(Columns.USU_NOME) != null ? merge.getAttribute(Columns.USU_NOME).toString() : "";
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.nome.alterado.de.arg0.para.arg1", responsavel, antes, depois));
                    }
                    usuarioBean.setUsuNome((String) merge.getAttribute(Columns.USU_NOME));
                }
                if (merge.getAtributos().containsKey(Columns.USU_CPF)) {
                    final String antes = usuarioBean.getUsuCpf() != null ? usuarioBean.getUsuCpf() : "";
                    final String depois = merge.getAttribute(Columns.USU_CPF) != null ? merge.getAttribute(Columns.USU_CPF).toString() : "";
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.cpf.alterado.de.arg0.para.arg1", responsavel, antes, depois));
                    }
                    usuarioBean.setUsuCpf((String) merge.getAttribute(Columns.USU_CPF));
                }
                if (merge.getAtributos().containsKey(Columns.USU_EMAIL)) {
                    final String antes = usuarioBean.getUsuEmail() != null ? usuarioBean.getUsuEmail() : "";
                    final String depois = merge.getAttribute(Columns.USU_EMAIL) != null ? merge.getAttribute(Columns.USU_EMAIL).toString() : "";

                    final boolean bloqueiaEdicaoEmail = !responsavel.isSup() && ParamSist.getBoolParamSist(CodedValues.TPC_BLOQUEIA_EDICAO_EMAIL, responsavel);
                    if (bloqueiaEdicaoEmail && !TextHelper.isNull(antes)) {
                        // Se não pode editar e-mail e ele já estava cadastrado, então lança exceção
                        throw new UsuarioControllerException("mensagem.erro.usuario.email.nao.pode.ser.alterado", responsavel);
                    }
                    if (existeOutroUsuarioMesmoEmail(depois, usuarioBean.getUsuCpf(), responsavel)) {
                        // Se existe outro usuário no sistema com o mesmo e-mail, envia mensagem de erro
                        throw new UsuarioControllerException("mensagem.erro.usuario.email.informado.em.uso", responsavel);
                    }
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.email.alterado.de.arg0.para.arg1", responsavel, antes, depois));
                    }

                    usuarioBean.setUsuEmail(depois);
                    // força nova validação do e-mail
                    usuarioBean.setUsuDataValidacaoEmail(null);
                }
                if (merge.getAtributos().containsKey(Columns.USU_TEL)) {
                    final String antes = usuarioBean.getUsuTel() != null ? usuarioBean.getUsuTel() : "";
                    final String depois = merge.getAttribute(Columns.USU_TEL) != null ? merge.getAttribute(Columns.USU_TEL).toString() : "";
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.telefone.alterado.de.arg0.para.arg1", responsavel, antes, depois));
                    }
                    usuarioBean.setUsuTel((String) merge.getAttribute(Columns.USU_TEL));
                }
                if (merge.getAtributos().containsKey(Columns.USU_SENHA)) {
                    usuarioBean.setUsuSenha((String) merge.getAttribute(Columns.USU_SENHA));
                }
                if (merge.getAtributos().containsKey(Columns.USU_SENHA_APP)) {
                    usuarioBean.setUsuSenhaApp((String) merge.getAttribute(Columns.USU_SENHA_APP));
                }
                if (merge.getAtributos().containsKey(Columns.USU_SENHA_2)) {
                    usuarioBean.setUsuSenha2((String) merge.getAttribute(Columns.USU_SENHA_2));
                }
                if (merge.getAtributos().containsKey(Columns.USU_NOVA_SENHA)) {
                    usuarioBean.setUsuNovaSenha((String) merge.getAttribute(Columns.USU_NOVA_SENHA));
                }
                if (merge.getAtributos().containsKey(Columns.USU_DICA_SENHA)) {
                    final String antes = usuarioBean.getUsuDicaSenha() != null ? usuarioBean.getUsuDicaSenha() : "";
                    final String depois = merge.getAttribute(Columns.USU_DICA_SENHA) != null ? merge.getAttribute(Columns.USU_DICA_SENHA).toString() : "";
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.dica.senha.alterada.dearg0.para.arg1", responsavel, antes, depois));
                    }
                    usuarioBean.setUsuDicaSenha((String) merge.getAttribute(Columns.USU_DICA_SENHA));
                }
                if (merge.getAtributos().containsKey(Columns.USU_DATA_EXP_SENHA)) {
                    usuarioBean.setUsuDataExpSenha((java.sql.Date) merge.getAttribute(Columns.USU_DATA_EXP_SENHA));
                }
                if (merge.getAtributos().containsKey(Columns.USU_DATA_EXP_SENHA_2)) {
                    usuarioBean.setUsuDataExpSenha2((java.sql.Date) merge.getAttribute(Columns.USU_DATA_EXP_SENHA_2));
                }
                if (merge.getAtributos().containsKey(Columns.USU_DATA_EXP_SENHA_APP)) {
                    usuarioBean.setUsuDataExpSenhaApp((java.sql.Date) merge.getAttribute(Columns.USU_DATA_EXP_SENHA_APP));
                }
                if (merge.getAtributos().containsKey(Columns.USU_IP_ACESSO)) {
                    final String antes = usuarioBean.getUsuIpAcesso() != null ? usuarioBean.getUsuIpAcesso() : "";
                    final String depois = merge.getAttribute(Columns.USU_IP_ACESSO) != null ? merge.getAttribute(Columns.USU_IP_ACESSO).toString() : "";
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.ip.acesso.alterado.de.arg0.para.arg1", responsavel, antes, depois));
                    }
                    usuarioBean.setUsuIpAcesso((String) merge.getAttribute(Columns.USU_IP_ACESSO));
                }
                if (merge.getAtributos().containsKey(Columns.USU_DDNS_ACESSO)) {
                    final String antes = usuarioBean.getUsuDdnsAcesso() != null ? usuarioBean.getUsuDdnsAcesso() : "";
                    final String depois = merge.getAttribute(Columns.USU_DDNS_ACESSO) != null ? merge.getAttribute(Columns.USU_DDNS_ACESSO).toString() : "";
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.endereco.acesso.alterado.de.arg0.para.arg1", responsavel, antes, depois));
                    }
                    usuarioBean.setUsuDdnsAcesso((String) merge.getAttribute(Columns.USU_DDNS_ACESSO));
                }
                if (merge.getAtributos().containsKey(Columns.USU_CENTRALIZADOR)) {
                    final String usuCentralizador = (String) merge.getAttribute(Columns.USU_CENTRALIZADOR);
                    final String centralizadorOld = usuarioBean.getUsuCentralizador() != null ? usuarioBean.getUsuCentralizador().toString() : "";
                    final String centralizadorNew = !TextHelper.isNull(usuCentralizador) ? usuCentralizador.substring(0, 1) : "";
                    if (!centralizadorOld.equals(centralizadorNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.centralizador.alterado.de.arg0.para.arg1", responsavel, centralizadorOld, centralizadorNew));
                    }
                    usuarioBean.setUsuCentralizador(!TextHelper.isNull(usuCentralizador) ? usuCentralizador.substring(0, 1) : null);
                }
                if (merge.getAtributos().containsKey(Columns.USU_AUTENTICA_SSO)) {
                    final String usuAutenticaSso = (String) merge.getAttribute(Columns.USU_AUTENTICA_SSO);
                    final String ssoOld = usuarioBean.getUsuAutenticaSso() != null ? usuarioBean.getUsuAutenticaSso().toString() : "";
                    final String ssoNew = !TextHelper.isNull(usuAutenticaSso) ? usuAutenticaSso.substring(0, 1) : "";
                    if (!ssoOld.equals(ssoNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.sso.alterado.de.arg0.para.arg1", responsavel, ssoOld, ssoNew));
                    }
                    usuarioBean.setUsuAutenticaSso(!TextHelper.isNull(usuAutenticaSso) ? usuAutenticaSso.substring(0, 1) : null);
                }
                if (merge.getAtributos().containsKey(Columns.USU_VISIVEL)) {
                    final String usuVisivel = (String) merge.getAttribute(Columns.USU_VISIVEL);
                    final String visivelOld = usuarioBean.getUsuVisivel() != null ? usuarioBean.getUsuVisivel().toString() : "";
                    final String visivelNew = !TextHelper.isNull(usuVisivel) ? usuVisivel.substring(0, 1) : "";
                    if (!visivelOld.equals(visivelNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.visibilidade.alterada.de.arg0.para.arg1", responsavel, visivelOld, visivelNew));
                    }
                    usuarioBean.setUsuVisivel(!TextHelper.isNull(usuVisivel) ? usuVisivel.substring(0, 1) : null);
                }
                if (merge.getAtributos().containsKey(Columns.USU_EXIGE_CERTIFICADO)) {
                    final String usuExigeCertificado = (String) merge.getAttribute(Columns.USU_EXIGE_CERTIFICADO);
                    final String certificadoOld = usuarioBean.getUsuExigeCertificado() != null ? usuarioBean.getUsuExigeCertificado().toString() : "";
                    final String certificadoNew = !TextHelper.isNull(usuExigeCertificado) ? usuExigeCertificado.substring(0, 1) : "";
                    if (!certificadoOld.equals(certificadoNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.exige.certificado.alterado.de.arg0.para.arg1", responsavel, certificadoOld, certificadoNew));
                    }
                    usuarioBean.setUsuExigeCertificado(!TextHelper.isNull(usuExigeCertificado) ? usuExigeCertificado.substring(0, 1) : null);
                }
                if (merge.getAtributos().containsKey(Columns.USU_TIPO_BLOQ)) {
                    usuarioBean.setUsuTipoBloq((String) merge.getAttribute(Columns.USU_TIPO_BLOQ));
                }
                if (merge.getAtributos().containsKey(Columns.USU_MATRICULA_INST)) {
                    usuarioBean.setUsuMatriculaInst((String) merge.getAttribute(Columns.USU_MATRICULA_INST));
                }
                if (merge.getAtributos().containsKey(Columns.USU_CHAVE_RECUPERAR_SENHA)) {
                    usuarioBean.setUsuChaveRecuperarSenha((String) merge.getAttribute(Columns.USU_CHAVE_RECUPERAR_SENHA));
                }
                if (merge.getAtributos().containsKey(Columns.USU_OPERACOES_SENHA_2)) {
                    usuarioBean.setUsuOperacoesSenha2((Short) merge.getAttribute(Columns.USU_OPERACOES_SENHA_2));
                }
                if (merge.getAtributos().containsKey(Columns.USU_DATA_REC_SENHA)) {
                    usuarioBean.setUsuDataRecSenha((java.util.Date) merge.getAttribute(Columns.USU_DATA_REC_SENHA));
                }
                if (merge.getAtributos().containsKey(Columns.USU_QTD_CONSULTAS_MARGEM)) {
                    usuarioBean.setUsuQtdConsultasMargem((Integer) merge.getAttribute(Columns.USU_QTD_CONSULTAS_MARGEM));
                }
                if (merge.getAtributos().containsKey(Columns.USU_DATA_FIM_VIG)) {
                    final String dataOld = usuarioBean.getUsuDataFimVig() != null ? DateHelper.toDateString(usuarioBean.getUsuDataFimVig()) : "";
                    final String dataNew = merge.getAttribute(Columns.USU_DATA_FIM_VIG) != null ? DateHelper.toDateString((Date) merge.getAttribute(Columns.USU_DATA_FIM_VIG)) : "";
                    if (!dataOld.equals(dataNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.fim.vigencia.alterado.de.arg0.para.arg1", responsavel, dataOld, dataNew));
                    }
                    usuarioBean.setUsuDataFimVig((Date) merge.getAttribute(Columns.USU_DATA_FIM_VIG));
                }
                if (merge.getAtributos().containsKey(Columns.USU_DEFICIENTE_VISUAL)) {
                    final String usuDeficienteVisual = (String) merge.getAttribute(Columns.USU_DEFICIENTE_VISUAL);
                    final String deficienteVisualOld = usuarioBean.getUsuDeficienteVisual() != null ? usuarioBean.getUsuDeficienteVisual().toString() : "";
                    final String deficienteVisualNew = !TextHelper.isNull(usuDeficienteVisual) ? usuDeficienteVisual.substring(0, 1) : "";
                    if (!deficienteVisualOld.equals(deficienteVisualNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.deficiente.visual.alterado.de.arg0.para.arg1", responsavel, deficienteVisualOld, deficienteVisualNew));
                    }
                    usuarioBean.setUsuDeficienteVisual(!TextHelper.isNull(usuDeficienteVisual) ? usuDeficienteVisual.substring(0, 1) : null);
                }

                if (merge.getAtributos().containsKey(Columns.USU_CHAVE_VALIDACAO_EMAIL)) {
                    usuarioBean.setUsuChaveValidacaoEmail((String) merge.getAttribute(Columns.USU_CHAVE_VALIDACAO_EMAIL));
                }

                if (merge.getAtributos().containsKey(Columns.USU_DATA_VALIDACAO_EMAIL)) {
                    usuarioBean.setUsuDataValidacaoEmail((java.util.Date) merge.getAttribute(Columns.USU_DATA_VALIDACAO_EMAIL));
                }

                if (merge.getAtributos().containsKey(Columns.USU_AUTORIZA_EMAIL_MARKETING)) {
                    usuarioBean.setUsuAutorizaEmailMarketing((String) merge.getAttribute(Columns.USU_AUTORIZA_EMAIL_MARKETING));
                }

                if (stuAtivo) {
                    if (validaCpf) {
                        // Se o usuário está ativo, ou está sendo desbloqueado, validar obrigatoriedade
                        // do CPF, bem como sua unicidade, dado os parâmetros de sistema
                        validaCpfUsuario(usuarioBean.getUsuCpf(), tipo, responsavel);
                        validaUnicidadeCpf(usuarioBean.getUsuCodigo(), usuarioBean.getUsuCpf(), tipo, codigoEntidade, responsavel);
                    }
                    if (validaEmail) {
                        if (AcessoSistema.ENTIDADE_CSA.equals(tipo) || AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                            final boolean usuEmailObrigatorio = ParamSist.paramEquals(CodedValues.TPC_CADASTRO_EMAIL_OBRIGATORIO_USUARIO_CSA, CodedValues.TPC_SIM, responsavel);
                            if (usuEmailObrigatorio && TextHelper.isNull(usuarioBean.getUsuEmail())) {
                                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.email.usuario.deve.ser.informado", responsavel);
                            }
                        } else if (AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_ORG.equals(tipo) || AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                            final boolean usuEmailObrigatorio = ParamSist.paramEquals(CodedValues.TPC_CADASTRO_EMAIL_OBRIGATORIO_CSE_ORG_SUP, CodedValues.TPC_SIM, responsavel);
                            if (usuEmailObrigatorio && TextHelper.isNull(usuarioBean.getUsuEmail())) {
                                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.email.usuario.deve.ser.informado", responsavel);
                            }
                        }
                    }
                    if (validaTel) {
                        if (AcessoSistema.ENTIDADE_CSA.equals(tipo) || AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                            final boolean usuTelObrigatorio = ParamSist.paramEquals(CodedValues.TPC_CADASTRO_TELEFONE_OBRIGATORIO_USUARIO_CSA, CodedValues.TPC_SIM, responsavel);
                            if (usuTelObrigatorio && TextHelper.isNull(usuarioBean.getUsuTel())) {
                                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.telefone.usuario.deve.ser.informado", responsavel);
                            }
                        }
                        if (AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                            final boolean usuTelObrigatorio = ParamSist.paramEquals(CodedValues.TPC_CADASTRO_TELEFONE_OBRIGATORIO_USUARIO_CSE, CodedValues.TPC_SIM, responsavel);
                            if (usuTelObrigatorio && TextHelper.isNull(usuarioBean.getUsuTel())) {
                                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.telefone.usuario.deve.ser.informado", responsavel);
                            }
                        }
                        if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                            final boolean usuTelObrigatorio = ParamSist.paramEquals(CodedValues.TPC_CADASTRO_TELEFONE_OBRIGATORIO_USUARIO_SUP, CodedValues.TPC_SIM, responsavel);
                            if (usuTelObrigatorio && TextHelper.isNull(usuarioBean.getUsuTel())) {
                                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.telefone.usuario.deve.ser.informado", responsavel);
                            }
                        }
                    }
                }

                if (merge.getAtributos().containsKey(Columns.USU_CHAVE_VALIDACAO_TOTP) && responsavel.getUsuCodigo().equals(usuario.getUsuCodigo())) {
                    final String usuChaveValidacaoTotp = (String) merge.getAttribute(Columns.USU_CHAVE_VALIDACAO_TOTP);
                    final String chaveTotpOld = !TextHelper.isNull(usuarioBean.getUsuChaveValidacaoTotp()) ? usuarioBean.getUsuChaveValidacaoTotp() : "";
                    final String chaveTotpNew = !TextHelper.isNull(usuChaveValidacaoTotp) ? usuChaveValidacaoTotp : "";
                    if (!chaveTotpOld.equals(chaveTotpNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.chave.validacao.totp.alterado.de.arg0.para.arg1", responsavel, chaveTotpOld, chaveTotpNew));
                    }
                    usuarioBean.setUsuChaveValidacaoTotp(!TextHelper.isNull(usuChaveValidacaoTotp) ? usuChaveValidacaoTotp : null);
                }

                if (merge.getAtributos().containsKey(Columns.USU_PERMITE_VALIDACAO_TOTP) && (responsavel.getUsuCodigo().equals(usuario.getUsuCodigo()) || responsavel.isSup())) {
                    final String usuPermiteValidacaoTotp = (String) merge.getAttribute(Columns.USU_PERMITE_VALIDACAO_TOTP);
                    final String permiteTotpOld = !TextHelper.isNull(usuarioBean.getUsuPermiteValidacaoTotp()) ? usuarioBean.getUsuPermiteValidacaoTotp() : "";
                    final String permiteTotpNew = !TextHelper.isNull(usuPermiteValidacaoTotp) ? usuPermiteValidacaoTotp : "";
                    if (!permiteTotpOld.equals(permiteTotpNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.permite.validacao.totp.alterado.de.arg0.para.arg1", responsavel, permiteTotpOld, permiteTotpNew));
                    }
                    usuarioBean.setUsuPermiteValidacaoTotp(!TextHelper.isNull(usuPermiteValidacaoTotp) ? usuPermiteValidacaoTotp : null);
                }

                if (merge.getAtributos().containsKey(Columns.USU_OPERACOES_VALIDACAO_TOTP) && responsavel.getUsuCodigo().equals(usuario.getUsuCodigo())) {
                    final String usuOperacoesValidacaoTotp = (String) merge.getAttribute(Columns.USU_OPERACOES_VALIDACAO_TOTP);
                    final String operacoesTotpOld = !TextHelper.isNull(usuarioBean.getUsuOperacoesValidacaoTotp()) ? usuarioBean.getUsuOperacoesValidacaoTotp() : OperacaoValidacaoTotpEnum.AUTORIZACAO_OPERACAO_SENSIVEL.getCodigo();
                    final String operacoesTotpNew = !TextHelper.isNull(usuOperacoesValidacaoTotp) ? usuOperacoesValidacaoTotp : OperacaoValidacaoTotpEnum.AUTORIZACAO_OPERACAO_SENSIVEL.getCodigo();
                    if (!operacoesTotpOld.equals(operacoesTotpNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.operacoes.validacao.totp.alterado.de.arg0.para.arg1", responsavel, operacoesTotpOld, operacoesTotpNew));
                    }
                    usuarioBean.setUsuOperacoesValidacaoTotp(operacoesTotpNew);
                }

                if (merge.getAtributos().containsKey(Columns.USU_OTP_CHAVE_SEGURANCA)) {
                    final String usuOtpChaveSeguranca = (String) merge.getAttribute(Columns.USU_OTP_CHAVE_SEGURANCA);
                    final String chaveOtpOld = !TextHelper.isNull(usuarioBean.getUsuOtpChaveSeguranca()) ? usuarioBean.getUsuOtpChaveSeguranca() : "";
                    final String chaveOtpNew = !TextHelper.isNull(usuOtpChaveSeguranca) ? usuOtpChaveSeguranca : "";
                    if (!chaveOtpOld.equals(chaveOtpNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.otp.chave.seguranca.alterado.de.arg0.para.arg1", responsavel, chaveOtpOld, chaveOtpNew));
                    }
                    usuarioBean.setUsuOtpChaveSeguranca(!TextHelper.isNull(usuOtpChaveSeguranca) ? usuOtpChaveSeguranca : null);
                }

                if (merge.getAtributos().containsKey(Columns.USU_OTP_CODIGO)) {
                    final String usuOtpCodigo = (String) merge.getAttribute(Columns.USU_OTP_CODIGO);
                    final String otpCodigoOld = !TextHelper.isNull(usuarioBean.getUsuOtpCodigo()) ? usuarioBean.getUsuOtpCodigo() : "";
                    final String otpCodigoNew = !TextHelper.isNull(usuOtpCodigo) ? usuOtpCodigo : "";
                    if (!otpCodigoOld.equals(otpCodigoNew)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.otp.codigo.alterado.de.arg0.para.arg1", responsavel, otpCodigoOld, otpCodigoNew));
                    }
                    usuarioBean.setUsuOtpCodigo(!TextHelper.isNull(usuOtpCodigo) ? usuOtpCodigo : null);
                }

                if (merge.getAtributos().containsKey(Columns.USU_OTP_DATA_CADASTRO)) {
                    usuarioBean.setUsuOtpDataCadastro((java.util.Date) merge.getAttribute(Columns.USU_OTP_DATA_CADASTRO));
                }

                AbstractEntityHome.update(usuarioBean);

                // Atualiza o perfil do usuário
                if (!TextHelper.isNull(perCodigo) || (funcoes != null)) {
                    updateUsuarioPerfil(funcoes, perCodigo, usuario.getUsuCodigo(), codigoEntidade, tipo, true, responsavel);
                }

                if ((ocorrenciaUsu == null) && !merge.getAtributos().isEmpty()) {
                    // Cria ocorrência de alteração de usuário
                    ocorrenciaUsu = new OcorrenciaUsuarioTransferObject();
                    ocorrenciaUsu.setUsuCodigo(usuarioBean.getUsuCodigo());
                    ocorrenciaUsu.setTocCodigo(CodedValues.TOC_ALTERACAO_USUARIO);
                    ocorrenciaUsu.setOusUsuCodigo(responsavel.getUsuCodigo());
                    ocorrenciaUsu.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.usuario", responsavel) + msgOus.toString());
                    ocorrenciaUsu.setOusIpAcesso(responsavel.getIpUsuario());
                }
                if ((ocorrenciaUsu != null) && (tipoMotivoOperacao != null)) {
                    ocorrenciaUsu.setOusObs(ocorrenciaUsu.getOusObs() + (ocorrenciaUsu.getOusObs().lastIndexOf(".") == (ocorrenciaUsu.getOusObs().length() - 1) ? " " : ". ") + tipoMotivoOperacao.getAttribute(Columns.OUS_OBS));
                    ocorrenciaUsu.setAttribute(Columns.OUS_TMO_CODIGO, tipoMotivoOperacao.getAttribute(Columns.TMO_CODIGO));
                }
                if (ocorrenciaUsu != null) {
                    createOcorrenciaUsuario(ocorrenciaUsu, responsavel);
                }

                log.write();

                // Se for exclusão de usuário csa, verifica se o parâmetro de sistema do papel autentica no SSO
                boolean autenticaSSO = false;
                if (!TextHelper.isNull(tipo) && !TextHelper.isNull(codigoEntidade) && CodedValues.STU_EXCLUIDO.equals(stu_codigo) && AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                    // Seta email apenas para validação do usuário
                    usuario.setUsuEmail(usuarioBean.getUsuEmail());
                    autenticaSSO = !TextHelper.isNull(usuarioBean.getUsuAutenticaSso()) && CodedValues.TPC_SIM.equals(usuarioBean.getUsuAutenticaSso()) && validarDadosSSO(usuario, codigoEntidade, tipo, responsavel);
                }

                if (autenticaSSO) {
                    // Irá verificar se o sso está habilitado e remover a ligação com a consignatária
                    ssoClient.removeServiceProviderFromUser(usuLoginAntesExclusao, tipo, codigoEntidade);
                }
            }
        } catch (final UsuarioControllerException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw ex;
        } catch (ParametroControllerException | SSOException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(ex.getMessage(), responsavel, ex);
        } catch (UpdateException | FindException | LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public void updateEnderecoAcessoFuncao(CustomTransferObject dadosTo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final String usuCodigo = (String) dadosTo.getAttribute(Columns.USU_CODIGO);
            final String codEntidade = (String) dadosTo.getAttribute("COD_ENTIDADE");
            final String tipo = (String) dadosTo.getAttribute("TIPO");

            final String funCodigo = (String) dadosTo.getAttribute(Columns.FUN_CODIGO);
            final String funDescricao = (String) dadosTo.getAttribute(Columns.FUN_DESCRICAO);
            final String eafIpAcesso = (String) dadosTo.getAttribute(Columns.EAF_IP_ACESSO);
            final String eafDdnsAcesso = (String) dadosTo.getAttribute(Columns.EAF_DDNS_ACESSO);

            // Carrega o objeto do banco (se existir)
            final CustomTransferObject criterio = new CustomTransferObject();
            criterio.setAttribute(Columns.FUN_CODIGO, funCodigo);
            final EnderecoFuncaoTransferObject funcoesToAtual = selectFuncoes(usuCodigo, codEntidade, tipo, criterio, -1, -1, responsavel).get(funCodigo);
            boolean create = false;
            EnderecoAcessoFuncao eafBean = null;
            try {
                eafBean = EnderecoAcessoFuncaoHome.findByPrimaryKey(usuCodigo, funCodigo);
            } catch (final FindException ex) {
                eafBean = new EnderecoAcessoFuncao(usuCodigo, funCodigo, funcoesToAtual.getEafIpAcesso(), funcoesToAtual.getEafDdnsAcesso());
                create = true;
            }

            // Objeto a ser salvo
            final EnderecoFuncaoTransferObject funcoesToNovo = new EnderecoFuncaoTransferObject();
            funcoesToNovo.setFunCodigo(funCodigo);
            funcoesToNovo.setFunDescricao(funDescricao);
            funcoesToNovo.setEafIpAcesso(eafIpAcesso);
            funcoesToNovo.setEafDdnsAcesso(eafDdnsAcesso);

            // LOG
            final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.UPDATE, Log.LOG_INFORMACAO);
            log.setUsuario(usuCodigo);

            final boolean podeEdtRestAcessoFun = usuarioPodeModificarUsu(usuCodigo, true, true, responsavel) && responsavel.temPermissao(CodedValues.FUN_EDT_RESTRICAO_ACESSO_POR_FUNCAO);

            // Se o usuário pode modificar o usuário, realiza a operação
            if (podeEdtRestAcessoFun) {
                // Compara as versões
                final CustomTransferObject merge = log.getUpdatedFields(funcoesToNovo.getAtributos(), funcoesToAtual.getAtributos());

                final StringBuilder msgOus = new StringBuilder();

                if (merge.getAtributos().containsKey(Columns.EAF_IP_ACESSO)) {
                    final String antes = eafBean.getEafIpAcesso() != null ? eafBean.getEafIpAcesso() : "";
                    final String depois = merge.getAttribute(Columns.EAF_IP_ACESSO) != null ? merge.getAttribute(Columns.EAF_IP_ACESSO).toString() : "";
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.ip.acesso.alterado.de.arg0.para.arg1", responsavel, antes, depois));
                    }
                    eafBean.setEafIpAcesso((String) merge.getAttribute(Columns.EAF_IP_ACESSO));
                }
                if (merge.getAtributos().containsKey(Columns.EAF_DDNS_ACESSO)) {
                    final String antes = eafBean.getEafDdnsAcesso() != null ? eafBean.getEafDdnsAcesso() : "";
                    final String depois = merge.getAttribute(Columns.EAF_DDNS_ACESSO) != null ? merge.getAttribute(Columns.EAF_DDNS_ACESSO).toString() : "";
                    if (!antes.equals(depois)) {
                        msgOus.append(ApplicationResourcesHelper.getMessage("mensagem.informacao.endereco.acesso.alterado.de.arg0.para.arg1", responsavel, antes, depois));
                    }
                    eafBean.setEafDdnsAcesso((String) merge.getAttribute(Columns.EAF_DDNS_ACESSO));
                }

                if (!create && TextHelper.isNull(eafIpAcesso) && TextHelper.isNull(eafDdnsAcesso)) {
                    AbstractEntityHome.remove(eafBean);
                } else if (create) {
                    EnderecoAcessoFuncaoHome.create(eafBean);
                } else {
                    AbstractEntityHome.update(eafBean);
                }

                if (!merge.getAtributos().isEmpty()) {
                    // Cria ocorrência de alteração de usuário
                    OcorrenciaUsuarioTransferObject ocorrenciaUsu = new OcorrenciaUsuarioTransferObject();
                    ocorrenciaUsu = new OcorrenciaUsuarioTransferObject();
                    ocorrenciaUsu.setUsuCodigo(usuCodigo);
                    ocorrenciaUsu.setTocCodigo(CodedValues.TOC_ALTERACAO_USUARIO);
                    ocorrenciaUsu.setOusUsuCodigo(responsavel.getUsuCodigo());
                    ocorrenciaUsu.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.usuario", responsavel) + msgOus.toString());
                    ocorrenciaUsu.setOusIpAcesso(responsavel.getIpUsuario());
                    if (ocorrenciaUsu != null) {
                        createOcorrenciaUsuario(ocorrenciaUsu, responsavel);
                    }
                }
                log.write();
            }
        } catch (CreateException | UpdateException | RemoveException | LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }

    }

    /**
     * Verifica obrigatoriedade do CPF, bem como se o valor informado é válido para um usuário.
     * @param usuCpf: CPF a ser validado
     * @param tipo : CSE, ORG, CSA, COR, SER ou SUP
     * @param responsavel: Responsável pela operação
     * @return TRUE caso o CPF seja informado e esteja correto, ou se não é obrigatório e não foi informado
     * @throws UsuarioControllerException
     */
    private boolean validaCpfUsuario(String usuCpf, String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        final String[] cpfsInvalidos = {
                                         "000.000.000-00", "111.111.111-11", "222.222.222-22", "333.333.333-33", "444.444.444-44",
                                         "555.555.555-55", "666.666.666-66", "777.777.777-77", "888.888.888-88", "999.999.999-99"
        };

        // Não valida CPF de usuário de suporte em sistema que não seja no Brasil
        final boolean validarCpfSuporte = (!AcessoSistema.ENTIDADE_SUP.equals(tipo) || LocaleHelper.BRASIL.equals(LocaleHelper.getLocale()));

        if (TextHelper.isNull(usuCpf)) {
            final boolean cpfObrigatorio = ParamSist.paramEquals(CodedValues.TPC_CADASTRO_CPF_OBRIGATORIO_USUARIO, CodedValues.TPC_SIM, responsavel);
            if (cpfObrigatorio) {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.cpf.usuario.deve.ser.informado", responsavel);
            }
        } else if (validarCpfSuporte && (!TextHelper.cpfOk(TextHelper.dropSeparator(usuCpf)) || (Arrays.binarySearch(cpfsInvalidos, usuCpf) >= 0))) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.cpf.usuario.invalido", responsavel);
        }
        return true;
    }

    /**
     * Verifica se o sistema impede que o usuario de csa/cor cadastrado tenha CPF igual ao de algum outro usuario csa/cor
     * de entidade diferente ou de um servidor.
     * @param usuCodigo: Codigo do usuario.
     * @param usuCpf: CPF do usuario.
     * @param tipoEntidade: Tipo da entidade do usuario.
     * @param codigoEntidade: Código da entidade do usuário
     * @param responsavel: Responsavel pela operacao.
     * @throws UsuarioControllerException Excecao padrao.
     */
    private void validaUnicidadeCpf(String usuCodigo, String usuCpf, String tipoEntidade, String codigoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        if (!TextHelper.isNull(usuCpf) && !TextHelper.isNull(tipoEntidade)) {
            if (AcessoSistema.ENTIDADE_CSA.equals(tipoEntidade) || AcessoSistema.ENTIDADE_COR.equals(tipoEntidade)) {
                // CPF cadastrado para um usuário de CSA/COR não pode ser igual a um CPF de servidor não excluído
                boolean exigeUnicidadeCPF = ParamSist.getBoolParamSist(CodedValues.TPC_IMPEDE_CPF_IGUAL_ENTRE_USU_CSA_E_SER, responsavel);
                if (exigeUnicidadeCPF && existeServidor(usuCpf, responsavel)) {
                    throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.existe.servidor.mesmo.cpf", responsavel);
                }

                // CPF cadastrado para um usuário de CSA/COR não pode ser igual a um CPF de usuário CSE/ORG ativo
                exigeUnicidadeCPF = ParamSist.getBoolParamSist(CodedValues.TPC_IMPEDE_CPF_IGUAL_ENTRE_USU_CSA_E_CSE, responsavel);
                if (exigeUnicidadeCPF) {
                    List<TransferObject> usuarios = lstUsuarioCseOrg(usuCodigo, usuCpf, responsavel);
                    if ((usuarios != null) && (usuarios.size() > 0)) {
                        throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.existe.gestor.mesmo.cpf", responsavel);
                    }
                    usuarios = lstUsuarioSup(usuCodigo, usuCpf, responsavel);
                    if ((usuarios != null) && (usuarios.size() > 0)) {
                        throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.existe.suporte.mesmo.cpf", responsavel);
                    }
                }

                // CPF cadastrado para um usuário de CSA/COR não pode ser igual a um CPF de usuário de outra entidade CSA/COR ativo
                exigeUnicidadeCPF = ParamSist.getBoolParamSist(CodedValues.TPC_IMPEDE_CPF_IGUAL_ENTRE_USU_CSA, responsavel);
                if (exigeUnicidadeCPF) {
                    final List<TransferObject> usuarios = lstUsuarioCsaCor(usuCodigo, usuCpf, false, tipoEntidade, codigoEntidade, false, responsavel);
                    if ((usuarios != null) && (usuarios.size() > 0)) {
                        throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.existe.usuario.outra.entidade.mesmo.cpf", responsavel);
                    }
                }

                // CPF cadastrado para um usuário de CSA/COR não pode ser igual a um CPF de usuário da mesma entidade CSA/COR ativo
                exigeUnicidadeCPF = ParamSist.getBoolParamSist(CodedValues.TPC_IMPEDE_CPF_IGUAL_ENTRE_USU_MESMA_CSA, responsavel);
                if (exigeUnicidadeCPF) {
                    final List<TransferObject> usuarios = lstUsuarioCsaCor(usuCodigo, usuCpf, false, tipoEntidade, codigoEntidade, true, responsavel);
                    if ((usuarios != null) && (usuarios.size() > 0)) {
                        throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.existe.usuario.mesma.entidade.mesmo.cpf", responsavel);
                    }
                }

            } else if (AcessoSistema.ENTIDADE_CSE.equals(tipoEntidade) || AcessoSistema.ENTIDADE_ORG.equals(tipoEntidade) || AcessoSistema.ENTIDADE_SUP.equals(tipoEntidade)) {
                // CPF cadastrado para um usuário de CSE/ORG não pode ser igual a um CPF de outro usuário CSE/ORG ativo
                boolean exigeUnicidadeCPF = ParamSist.getBoolParamSist(CodedValues.TPC_IMPEDE_CPF_IGUAL_ENTRE_USU_CSE, responsavel);
                if (exigeUnicidadeCPF) {
                    List<TransferObject> usuarios = lstUsuarioCseOrg(usuCodigo, usuCpf, responsavel);
                    if ((usuarios != null) && (usuarios.size() > 0)) {
                        throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.existe.gestor.mesmo.cpf", responsavel);
                    }
                    usuarios = lstUsuarioSup(usuCodigo, usuCpf, responsavel);
                    if ((usuarios != null) && (usuarios.size() > 0)) {
                        throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.existe.suporte.mesmo.cpf", responsavel);
                    }
                }

                // CPF cadastrado para um usuário de CSE/ORG não pode ser igual a um CPF de usuário CSA/COR ativo
                exigeUnicidadeCPF = ParamSist.getBoolParamSist(CodedValues.TPC_IMPEDE_CPF_IGUAL_ENTRE_USU_CSA_E_CSE, responsavel);
                if (exigeUnicidadeCPF) {
                    final List<TransferObject> usuarios = lstUsuarioCsaCor(usuCodigo, usuCpf, false, null, null, false, responsavel);
                    if ((usuarios != null) && (usuarios.size() > 0)) {
                        throw new UsuarioControllerException("mensagem.erro.nao.possivel.realizar.esta.operacao.pois.existe.usuario.outra.entidade.mesmo.cpf", responsavel);
                    }
                }
            }
        }
    }

    private void updateUsuarioPerfil(List<String> funcoes, String perCodigo, String usuCodigo, String codigoEntidade, String tipo, boolean isAlteracao, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            // LOG Verificar log que está setando funções removidas/inseridas ou perfil alterado
            final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.UPDATE, Log.LOG_INFORMACAO);
            log.setUsuario(usuCodigo);

            boolean alterou = false;

            // Pega as funções que o usuário possui nas tabelas tb_funcao_perfil_???
            final List<String> funcoesOld = getUsuarioFuncoes(usuCodigo, tipo, responsavel);

            final List<String> diff = new ArrayList<>();
            final List<String> excluir = new ArrayList<>();

            // Funções permitidas para o usuário
            final List<String> funcoesPermitidas = new ArrayList<>();
            final List<TransferObject> funPermUsu = lstFuncoesPermitidasUsuario(tipo, codigoEntidade, responsavel);
            if ((funPermUsu != null) && !funPermUsu.isEmpty()) {
                for (final TransferObject transferObject : funPermUsu) {
                    funcoesPermitidas.add(transferObject.getAttribute(Columns.FUN_CODIGO).toString());
                }
            }

            if (funcoes != null) {
                for (final String funPermitida : funcoesPermitidas) {
                    if (funcoesOld.contains(funPermitida) && !funcoes.contains(funPermitida)) {
                        excluir.add(funPermitida);
                    } else if (funcoesOld.contains(funPermitida) && funcoes.contains(funPermitida)) {
                        // Usuário já possui a função, não precisa incluir
                        continue;
                    } else if (!funcoesOld.contains(funPermitida) && funcoes.contains(funPermitida)) {
                        diff.add(funPermitida);
                    }
                }

                //Caso a função não seja permitida gera log de erro
                for (final String novaFuncao : funcoes) {
                    if (!funcoesPermitidas.contains(novaFuncao)) {
                        try {
                            final LogDelegate logErro = new LogDelegate(responsavel, Log.FUNCAO_PERFIL, Log.UPDATE, Log.LOG_ERRO_SEGURANCA);
                            logErro.setPerfil(perCodigo);
                            logErro.setFuncao(novaFuncao);
                            logErro.add(ApplicationResourcesHelper.getMessage("rotulo.erro.upper.arg0", responsavel, ApplicationResourcesHelper.getMessage("mensagem.erro.usuario.nao.tem.permissao.incluir.esta.funcao", responsavel)));
                            logErro.write();
                            continue;
                        } catch (final LogControllerException ex) {
                            LOG.error(ex.getMessage(), ex);
                        }
                    }
                }

                // confere se usuário possui email cadastrado para atrbuir a função 248 (usuário auditor)
                if (funcoes.contains(CodedValues.FUN_USUARIO_AUDITOR)) {
                    final UsuarioTransferObject filtro = new UsuarioTransferObject(usuCodigo);

                    final UsuarioTransferObject usuario = findUsuario(filtro, tipo, responsavel);
                    if (TextHelper.isNull(usuario.getUsuEmail())) {
                        throw new UsuarioControllerException("mensagem.erro.email.valido.deve.ser.cadastrado.para.atribuir.permissao.auditor.ao.usuario", responsavel);
                    }
                }
            } else {
                excluir.addAll(funcoesOld);
            }

            List<String> funcPerfil = null;
            if (!TextHelper.isNull(perCodigo)) {
                funcPerfil = getFuncaoPerfil(tipo, codigoEntidade, perCodigo, responsavel);
            }

            // confere se é o último usuário auditor para a entidade alvo.
            if (excluir.contains(CodedValues.FUN_USUARIO_AUDITOR) && !podeRemoverFuncAuditoria(usuCodigo, codigoEntidade, tipo, responsavel) && ((funcPerfil == null) || !funcPerfil.contains(CodedValues.FUN_USUARIO_AUDITOR))) {
                throw new UsuarioControllerException("mensagem.erro.permissao.auditoria.nao.pode.remover", responsavel);
            }

            // confere se usuário possui email cadastrado para atrbuir a função 248 (usuário auditor)
            // para o caso de ser atribuído a um perfil
            if (!TextHelper.isNull(perCodigo)) {
                funcPerfil = getFuncaoPerfil(tipo, codigoEntidade, perCodigo, responsavel);

                if (funcPerfil.contains(CodedValues.FUN_USUARIO_AUDITOR)) {
                    final UsuarioTransferObject filtro = new UsuarioTransferObject(usuCodigo);

                    final UsuarioTransferObject usuario = findUsuario(filtro, tipo, responsavel);
                    if (TextHelper.isNull(usuario.getUsuEmail())) {
                        throw new UsuarioControllerException("mensagem.erro.email.valido.deve.ser.cadastrado.para.atribuir.permissao.auditor.ao.usuario", responsavel);
                    }
                }
            }

            // Apagar as removidas presentes em funcoesOld
            if (excluir.size() > 0) {
                removeFuncaoPerfilUsuario(excluir, usuCodigo, tipo);
                log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.removendo.permissoes", responsavel, TextHelper.join(excluir, ",")));
                alterou = true;
            }

            // Adicionar as novas presentes em diff
            if (diff.size() > 0) {
                createUsuarioPerfil(diff, usuCodigo, codigoEntidade, tipo);
                log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.inserindo.permissoes", responsavel, TextHelper.join(diff, ",")));
                alterou = true;
            }

            // Busca o perfil do usuário
            PerfilUsuario upeBean = null;
            Perfil perfilAnterior = null;
            try {
                upeBean = PerfilUsuarioHome.findByPrimaryKey(usuCodigo);
                perfilAnterior = PerfilHome.findByPrimaryKey(upeBean.getPerfil().getPerCodigo());
            } catch (final FindException ex) {
            }

            String obs = "";
            if (!TextHelper.isNull(perCodigo) && (upeBean != null)) {
                // Se o usuário mudou de perfil
                if (!perCodigo.equals(perfilAnterior.getPerCodigo())) {
                    log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.trocando.de.perfil", responsavel, perfilAnterior.getPerCodigo() + "," + perCodigo));
                    final Perfil perfil = PerfilHome.findByPrimaryKey(perCodigo);
                    obs = ApplicationResourcesHelper.getMessage("mensagem.informacao.de.arg0.para.arg1", responsavel, perfilAnterior.getPerDescricao(), perfil.getPerDescricao());
                    upeBean.setPerfil(perfil);
                    AbstractEntityHome.update(upeBean);
                    alterou = true;
                }
            } else if (!TextHelper.isNull(perCodigo)) {
                // Se o usuário agora tem um perfil
                log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.incluindo.perfil", responsavel, perCodigo));
                final Perfil perfil = PerfilHome.findByPrimaryKey(perCodigo);
                obs = ApplicationResourcesHelper.getMessage("mensagem.informacao.de.arg0.para.arg1", responsavel, ApplicationResourcesHelper.getMessage("rotulo.usuario.perfil.personalizado", responsavel), perfil.getPerDescricao());
                PerfilUsuarioHome.create(usuCodigo, perCodigo);
                alterou = true;
            } else if (upeBean != null) {
                // Se o usuário não tem mais um perfil
                log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.excluindo.perfil", responsavel, perfilAnterior.getPerCodigo()));
                obs = ApplicationResourcesHelper.getMessage("mensagem.informacao.de.arg0.para.arg1", responsavel, perfilAnterior.getPerDescricao(), ApplicationResourcesHelper.getMessage("rotulo.usuario.perfil.personalizado", responsavel));
                AbstractEntityHome.remove(upeBean);
                alterou = true;
            }

            log.write();

            // Se alterou o perfil de funções do usuário
            if (alterou && isAlteracao) {
                // Cria ocorrência de alteração de perfil de usuário
                final CustomTransferObject ocorrencia = new CustomTransferObject();
                ocorrencia.setAttribute(Columns.OUS_USU_CODIGO, usuCodigo);
                ocorrencia.setAttribute(Columns.OUS_TOC_CODIGO, CodedValues.TOC_ALTERACAO_PERFIL_USUARIO);
                ocorrencia.setAttribute(Columns.OUS_OUS_USU_CODIGO, responsavel.getUsuCodigo());
                ocorrencia.setAttribute(Columns.OUS_OBS, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.perfil.usuario", responsavel) + obs);
                ocorrencia.setAttribute(Columns.OUS_IP_ACESSO, responsavel.getIpUsuario());

                createOcorrenciaUsuario(ocorrencia, responsavel);
            }
        } catch (CreateException | UpdateException | RemoveException | FindException | LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    /**
     * confere se a função de auditoria pode ser removida do usuário alvo. se ele for o último auditor
     * da entidade e houver funções auditadas para esta, a função não pode ser removida.
     * @param usuCodigo
     * @param codigoEntidade
     * @param tipo
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public boolean podeRemoverFuncAuditoria(String usuCodigo, String codigoEntidade, String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        // se estiver removendo a permissão de auditor, verificar se há funções auditadas para a entidade
        // e se este é o último usuário auditor do sistema
        final ListaUsuariosAuditoresQuery lstAuditores = new ListaUsuariosAuditoresQuery();
        final List<String> usuCodigos = new ArrayList<>();
        usuCodigos.add(CodedValues.NOT_EQUAL_KEY);
        usuCodigos.add(usuCodigo);
        lstAuditores.usuCodigo = usuCodigos;
        lstAuditores.codigoEntidade = codigoEntidade;
        lstAuditores.tipo = tipo;
        lstAuditores.count = true;

        try {
            final int auditoresQntd = lstAuditores.executarContador();
            if (auditoresQntd <= 0) {
                final ListaFuncoesAuditadasQuery funcAuditadasEnt = new ListaFuncoesAuditadasQuery();
                funcAuditadasEnt.codigoEntidade = codigoEntidade;
                funcAuditadasEnt.tipo = tipo;
                funcAuditadasEnt.count = true;

                final int numFuncAuditadas = funcAuditadasEnt.executarContador();
                if (numFuncAuditadas > 0) {
                    return false;
                }
            }
        } catch (final HQueryException e) {
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel);
        }

        return true;
    }

    @Override
    public void removeUsuario(UsuarioTransferObject usuario, String tipo, TransferObject tipoMotivoOperacao, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if (usuarioPodeModificarUsu(usuario.getUsuCodigo(), true, true, responsavel)) {

                try {
                    // Verifica se o responsável pela operação ainda existe, ou seja, se o usuário não foi excluido.
                    findUsuarioBean(new UsuarioTransferObject(responsavel.getUsuCodigo()), responsavel.getTipoEntidade());
                } catch (final UsuarioControllerException ex) {
                    throw new UsuarioControllerException("mensagem.erro.nao.possivel.excluir.usuario.selecionado.pois.seu.usuario.esta.bloqueado", responsavel);
                }

                final Usuario usuarioBean = findUsuarioBean(usuario, tipo);
                final String usuCodigo = usuarioBean.getUsuCodigo();

                final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.DELETE, Log.LOG_INFORMACAO);
                log.setUsuario(usuCodigo);

                // Se o usuário que está excluindo é o mesmo usuário que será excluído
                if (usuCodigo.equals(responsavel.getUsuCodigo())) {
                    throw new UsuarioControllerException("mensagem.erro.usuario.nao.pode.ser.excluido.por.ele.proprio", responsavel);
                }

                String tpcEnviaAuditoria = null;
                try {
                    if (responsavel.isCseSupOrg()) {
                        tpcEnviaAuditoria = parametroController.findParamSistCse(CodedValues.TPC_PERIODO_ENVIO_EMAIL_AUDITORIA_CSE_ORG, "1", responsavel);
                    } else if (responsavel.isCsaCor()) {
                        tpcEnviaAuditoria = parametroController.findParamSistCse(CodedValues.TPC_PERIODO_ENVIO_EMAIL_AUDITORIA_CSA_COR, "1", responsavel);
                    }
                } catch (final ParametroControllerException e1) {
                    LOG.error(e1.getMessage(), e1);
                    throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e1);
                }

                if (!TextHelper.isNull(tpcEnviaAuditoria) && !CodedValues.PER_ENV_EMAIL_AUDIT_DESABILITADO.equals(tpcEnviaAuditoria)) {
                    final ListaUsuariosAuditoresQuery usuAuditListQuery = new ListaUsuariosAuditoresQuery();

                    final String codEntidade = usuario.getAttribute(Columns.COR_CODIGO) != null ? (String) usuario.getAttribute(Columns.COR_CODIGO) : usuario.getAttribute(Columns.CSA_CODIGO) != null ? (String) usuario.getAttribute(Columns.CSA_CODIGO) : usuario.getAttribute(Columns.CSE_CODIGO) != null ? (String) usuario.getAttribute(Columns.CSE_CODIGO) : usuario.getAttribute(Columns.ORG_CODIGO) != null ? (String) usuario.getAttribute(Columns.ORG_CODIGO) : null;

                    if (!TextHelper.isNull(codEntidade)) {
                        usuAuditListQuery.codigoEntidade = codEntidade;
                        usuAuditListQuery.stuCodigo = CodedValues.STU_ATIVO;
                        usuAuditListQuery.tipo = tipo;

                        try {
                            final List<UsuarioTransferObject> usuAuditList = usuAuditListQuery.executarDTO(UsuarioTransferObject.class);
                            if (usuAuditList.size() == 1) {
                                final String usuCodigoAudit = usuAuditList.get(0).getUsuCodigo();

                                // se usuário é o último auditor remascente da entidade e houver configuração de auditoria para esta,
                                // a remoção do usuário não é permitida
                                if (usuCodigoAudit.equals(usuario.getUsuCodigo())) {
                                    throw new UsuarioControllerException("mensagem.erro.usuario.nao.pode.ser.removido.pois.entidade.possui.configuracoes.auditoria", responsavel);
                                }
                            }
                        } catch (final HQueryException e) {
                            LOG.error(e.getMessage(), e);
                            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e);
                        }
                    }
                }

                String entidade = null;
                if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                    entidade = (String) usuario.getAttribute(Columns.COR_CODIGO);
                } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                    entidade = (String) usuario.getAttribute(Columns.CSA_CODIGO);
                } else if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                    entidade = (String) usuario.getAttribute(Columns.CSE_CODIGO);
                } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                    entidade = (String) usuario.getAttribute(Columns.ORG_CODIGO);
                } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                    entidade = (String) usuario.getAttribute(Columns.CSE_CODIGO);
                }

                final Map<String, EnderecoFuncaoTransferObject> funcMap = selectFuncoes(usuCodigo, entidade, tipo, responsavel);
                final Set<String> keySet = funcMap.keySet();

                if (keySet.contains(CodedValues.FUN_USUARIO_AUDITOR) && !podeRemoverFuncAuditoria(usuCodigo, entidade, tipo, responsavel)) {
                    throw new UsuarioControllerException("mensagem.erro.permissao.auditoria.nao.pode.remover", responsavel);
                }

                // Remove ligacao entre perfil e usuário (tb_perfil_usuario) para perfis especificos
                try {
                    final PerfilUsuario upeBean = PerfilUsuarioHome.findByPrimaryKey(usuCodigo);
                    AbstractEntityHome.remove(upeBean);
                    final List<String> funcoes = getFuncaoPerfil(tipo, usuCodigo, upeBean.getPerfil().getPerCodigo(), responsavel);

                    log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.funcoes.removidas", responsavel, TextHelper.join(funcoes, ",")));
                } catch (final FindException e) {
                } // Se nao achou é porque usuario possui perfil personalizado

                // Exclui da tabela tb_funcao_perfil_xxx para perfis personalizados
                final List<String> listaFuncoes = removeFuncaoPerfilUsuario(null, usuCodigo, tipo);
                if ((listaFuncoes != null) && !listaFuncoes.isEmpty()) {
                    log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.funcoes.removidas", responsavel, TextHelper.join(listaFuncoes, ",")));
                }

                // Cria ocorrência de exclusão
                final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                ocorrencia.setUsuCodigo(usuario.getUsuCodigo());
                ocorrencia.setTocCodigo(CodedValues.TOC_EXCLUSAO_USUARIO);
                ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.exclusao.usuario", responsavel));
                ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
                if (tipoMotivoOperacao != null) {
                    ocorrencia.setOusObs(ocorrencia.getOusObs() + (ocorrencia.getOusObs().lastIndexOf(".") == (ocorrencia.getOusObs().length() - 1) ? " " : ". ") + tipoMotivoOperacao.getAttribute(Columns.OUS_OBS));
                    ocorrencia.setAttribute(Columns.OUS_TMO_CODIGO, tipoMotivoOperacao.getAttribute(Columns.TMO_CODIGO));
                }

                // Exclusão lógica de usuário
                usuario.setStuCodigo(CodedValues.STU_EXCLUIDO);
                alteraUsuario(usuario, ocorrencia, null, null, tipo, entidade, false, false, false, null, responsavel);

                log.write();
            }
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel);
        } catch (final RemoveException ex) {
            LOG.error(ex.getMessage());
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.excluir.usuario.selecionado.erro.interno.arg0", responsavel, ex.getMessage());
        } catch (final UsuarioControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(ex);
        }
    }

    private void removeVinculoFuncao(String funCodigo, List<String> papCodigos, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final LogDelegate log = new LogDelegate(responsavel, Log.FUNCAO_PERFIL, Log.DELETE, Log.LOG_INFORMACAO);
            log.setFuncao(funCodigo);

            final Funcao funcao = FuncaoHome.findByPrimaryKey(funCodigo);

            // Exclui todos os vínculos da função com qualquer perfil personalizado de qualquer usuário
            final ListaFuncaoPerfilTodasEntidadesQuery funPerTodasEntidades = new ListaFuncaoPerfilTodasEntidadesQuery();
            funPerTodasEntidades.funCodigo = funCodigo;
            final List<TransferObject> fpeEntidades = funPerTodasEntidades.executarDTO();
            if (fpeEntidades != null) {
                for (final TransferObject fpe : fpeEntidades) {
                    final String codigoEntidade = fpe.getAttribute("CODIGO_ENTIDADE").toString();
                    final String tipoEntidade = fpe.getAttribute("TIPO_ENTIDADE").toString();
                    final String papel = fpe.getAttribute("PAPEL").toString();
                    final String usuCodigo = fpe.getAttribute(Columns.USU_CODIGO).toString();

                    if ((papCodigos == null) || papCodigos.isEmpty() || !papCodigos.contains(papel)) {
                        if (AcessoSistema.ENTIDADE_CSE.equals(tipoEntidade)) {
                            final FuncaoPerfilCseId id = new FuncaoPerfilCseId();
                            id.setCseCodigo(codigoEntidade);
                            id.setFunCodigo(funCodigo);
                            id.setUsuCodigo(usuCodigo);

                            final FuncaoPerfilCse fp = new FuncaoPerfilCse();
                            fp.setFuncao(funcao);
                            fp.setId(id);

                            AbstractEntityHome.remove(fp);
                        } else if (AcessoSistema.ENTIDADE_ORG.equals(tipoEntidade)) {
                            final FuncaoPerfilOrgId id = new FuncaoPerfilOrgId();
                            id.setOrgCodigo(codigoEntidade);
                            id.setFunCodigo(funCodigo);
                            id.setUsuCodigo(usuCodigo);

                            final FuncaoPerfilOrg fp = new FuncaoPerfilOrg();
                            fp.setFuncao(funcao);
                            fp.setId(id);

                            AbstractEntityHome.remove(fp);
                        } else if (AcessoSistema.ENTIDADE_CSA.equals(tipoEntidade)) {
                            final FuncaoPerfilCsaId id = new FuncaoPerfilCsaId();
                            id.setCsaCodigo(codigoEntidade);
                            id.setFunCodigo(funCodigo);
                            id.setUsuCodigo(usuCodigo);

                            final FuncaoPerfilCsa fp = new FuncaoPerfilCsa();
                            fp.setFuncao(funcao);
                            fp.setId(id);

                            AbstractEntityHome.remove(fp);
                        } else if (AcessoSistema.ENTIDADE_COR.equals(tipoEntidade)) {
                            final FuncaoPerfilCorId id = new FuncaoPerfilCorId();
                            id.setCorCodigo(codigoEntidade);
                            id.setFunCodigo(funCodigo);
                            id.setUsuCodigo(usuCodigo);

                            final FuncaoPerfilCor fp = new FuncaoPerfilCor();
                            fp.setFuncao(funcao);
                            fp.setId(id);

                            AbstractEntityHome.remove(fp);
                        } else if (AcessoSistema.ENTIDADE_SUP.equals(tipoEntidade)) {
                            final FuncaoPerfilSupId id = new FuncaoPerfilSupId();
                            id.setCseCodigo(codigoEntidade);
                            id.setFunCodigo(funCodigo);
                            id.setUsuCodigo(usuCodigo);

                            final FuncaoPerfilSup fp = new FuncaoPerfilSup();
                            fp.setFuncao(funcao);
                            fp.setId(id);

                            AbstractEntityHome.remove(fp);
                        }
                        log.setUsuario(usuCodigo);
                        log.write();
                    }
                }
            }

            // Exclui todos os vínculos da função com qualquer perfil
            final ListaPerfilTodasEntidadesPossuemFuncaoQuery lstPerfilFuncaoTodasEntidades = new ListaPerfilTodasEntidadesPossuemFuncaoQuery();
            lstPerfilFuncaoTodasEntidades.funCodigo = funCodigo;
            final List<TransferObject> funcoesPerfil = lstPerfilFuncaoTodasEntidades.executarDTO();
            if (funcoesPerfil != null) {
                for (final TransferObject to : funcoesPerfil) {
                    final String perCodigo = to.getAttribute(Columns.PER_CODIGO).toString();
                    final String papel = to.getAttribute("PAPEL").toString();

                    if ((papCodigos == null) || papCodigos.isEmpty() || !papCodigos.contains(papel)) {
                        final FuncaoPerfilId id = new FuncaoPerfilId();
                        id.setFunCodigo(funCodigo);
                        id.setPerCodigo(perCodigo);

                        final FuncaoPerfil fpe = new FuncaoPerfil();
                        fpe.setFuncao(funcao);
                        fpe.setId(id);

                        AbstractEntityHome.remove(fpe);

                        log.setPerfil(perCodigo);
                        log.setFuncao(funCodigo);
                        log.write();
                    }
                }
            }
        } catch (HQueryException | FindException | RemoveException | LogControllerException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.excluir.permissoes.usuario.erro.interno.arg0", responsavel, e.getMessage());
        }
    }

    private List<String> removeFuncaoPerfilUsuario(List<String> drop, String usuCodigo, String tipo) throws UsuarioControllerException {
        tipo = tipo.toUpperCase();
        final List<String> listaFuncoes = new ArrayList<>();
        try {
            final Collection<?> funcoes = findFuncaoPerfilBean(usuCodigo, tipo);
            final Iterator<?> it = funcoes.iterator();
            if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                while (it.hasNext()) {
                    final FuncaoPerfilCse fp = (FuncaoPerfilCse) it.next();
                    if ((drop == null) || drop.contains(fp.getFunCodigo())) {
                        AbstractEntityHome.remove(fp);
                        listaFuncoes.add(fp.getFunCodigo());
                    }
                }
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                while (it.hasNext()) {
                    final FuncaoPerfilCsa fp = (FuncaoPerfilCsa) it.next();
                    if ((drop == null) || drop.contains(fp.getFunCodigo())) {
                        AbstractEntityHome.remove(fp);
                        listaFuncoes.add(fp.getFunCodigo());
                    }
                }
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                while (it.hasNext()) {
                    final FuncaoPerfilCor fp = (FuncaoPerfilCor) it.next();
                    if ((drop == null) || drop.contains(fp.getFunCodigo())) {
                        AbstractEntityHome.remove(fp);
                        listaFuncoes.add(fp.getFunCodigo());
                    }
                }
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                while (it.hasNext()) {
                    final FuncaoPerfilOrg fp = (FuncaoPerfilOrg) it.next();
                    if ((drop == null) || drop.contains(fp.getFunCodigo())) {
                        AbstractEntityHome.remove(fp);
                        listaFuncoes.add(fp.getFunCodigo());
                    }
                }
            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                while (it.hasNext()) {
                    final FuncaoPerfilSup fp = (FuncaoPerfilSup) it.next();
                    if ((drop == null) || drop.contains(fp.getFunCodigo())) {
                        AbstractEntityHome.remove(fp);
                        listaFuncoes.add(fp.getFunCodigo());
                    }
                }
            }
        } catch (final RemoveException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.excluir.usuario.selecionado.erro.interno.arg0", (AcessoSistema) null, ex.getMessage());
        }
        return listaFuncoes;
    }

    /** LISTAGEM DE USUÁRIOS --------------------------------------------------------------------------------- **/

    // Get (lst_usuario_papel)
    @Override
    public List<TransferObject> getUsuarios(String tipo, String codigo, CustomTransferObject filtro, int offset, int count, AcessoSistema responsavel) throws UsuarioControllerException {
        return lstUsuarios("0", tipo, codigo, filtro, offset, count, responsavel);
    }

    // List (lst_usuario)
    @Override
    public List<TransferObject> listUsuarios(String tipo, String codigo, CustomTransferObject filtro, int offset, int count, AcessoSistema responsavel) throws UsuarioControllerException {
        return lstUsuarios("1", tipo, codigo, filtro, offset, count, responsavel);
    }

    @Override
    public List<TransferObject> lstUsuarios(String opcao, String tipo, String codigoEntidade, CustomTransferObject filtro, AcessoSistema responsavel) throws UsuarioControllerException {
        return lstUsuarios(opcao, tipo, codigoEntidade, filtro, -1, -1, responsavel);
    }

    @Override
    public List<TransferObject> lstUsuarios(String opcao, String tipo, String codigoEntidade, CustomTransferObject filtro, int offset, int count, AcessoSistema responsavel) throws UsuarioControllerException {

        if (!responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_CSE) && !responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_CSA) && !responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_COR) && !responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_ORG) && !responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_SUP)) {
            return new ArrayList<>();
        }

        // somente usuários de suporte podem listar usuários de papel suporte
        if (AcessoSistema.ENTIDADE_SUP.equals(tipo) && !responsavel.isSup()) {
            return new ArrayList<>();
        }

        try {
            if ("1".equals(opcao)) {
                final ListaUsuariosQuery query = new ListaUsuariosQuery();
                query.responsavel = responsavel;

                if (offset != -1) {
                    query.firstResult = offset;
                }

                if (count != -1) {
                    query.maxResults = count;
                }

                query.tipo = tipo;
                query.entCodigo = codigoEntidade;

                if (filtro != null) {
                    query.cseNome = (String) filtro.getAttribute(Columns.CSE_NOME);
                    query.usuCodigo = (String) filtro.getAttribute(Columns.USU_CODIGO);
                    query.usuLogin = (String) filtro.getAttribute(Columns.USU_LOGIN);
                    query.usuNome = (String) filtro.getAttribute(Columns.USU_NOME);
                    query.usuCpf = (String) filtro.getAttribute(Columns.USU_CPF);
                    query.stuCodigo = filtro.getAttribute(Columns.USU_STU_CODIGO);
                    query.orgNome = (String) filtro.getAttribute(Columns.ORG_NOME);
                    query.csaNome = (String) filtro.getAttribute(Columns.CSA_NOME + CodedValues.OR_KEY + Columns.CSA_NOME_ABREV);
                    query.csaNomeAbrev = (String) filtro.getAttribute(Columns.CSA_NOME + CodedValues.OR_KEY + Columns.CSA_NOME_ABREV);
                    query.corNome = (String) filtro.getAttribute(Columns.COR_NOME);
                    query.orgNome = (String) filtro.getAttribute(Columns.ORG_NOME);
                    query.usuCseUsuCodigo = (String) filtro.getAttribute(Columns.UCE_USU_CODIGO);
                    query.usuCsaUsuCodigo = (String) filtro.getAttribute(Columns.UCA_USU_CODIGO);
                    query.usuCorUsuCodigo = (String) filtro.getAttribute(Columns.UCO_USU_CODIGO);
                    query.usuOrgUsuCodigo = (String) filtro.getAttribute(Columns.UOR_USU_CODIGO);
                    if (filtro.getAttribute("OCULTA_USU_VISIVEL") != null) {
                        query.ocultaUsuVisivel = (Boolean) filtro.getAttribute("OCULTA_USU_VISIVEL");
                    }
                }

                return query.executarDTO();
            } else {
                final ListaUsuariosEntidadeQuery query = new ListaUsuariosEntidadeQuery();
                if (offset != -1) {
                    query.firstResult = offset;
                }

                if (count != -1) {
                    query.maxResults = count;
                }

                query.entCodigo = codigoEntidade;
                query.tipo = tipo;
                query.perCodigo = (String) filtro.getAttribute(Columns.PER_CODIGO);
                query.perDescricao = (String) filtro.getAttribute(Columns.PER_DESCRICAO);
                query.usuCodigo = (String) filtro.getAttribute(Columns.USU_CODIGO);
                query.usuLogin = (String) filtro.getAttribute(Columns.USU_LOGIN);
                query.usuNome = (String) filtro.getAttribute(Columns.USU_NOME);
                query.usuCpf = (String) filtro.getAttribute(Columns.USU_CPF);
                query.stuCodigo = filtro.getAttribute(Columns.USU_STU_CODIGO);
                query.usuEmail = (String) filtro.getAttribute(Columns.USU_EMAIL);
                if (filtro.getAttribute("OCULTA_USU_VISIVEL") != null) {
                    query.ocultaUsuVisivel = (Boolean) filtro.getAttribute("OCULTA_USU_VISIVEL");
                }

                return query.executarDTO();
            }

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public int countUsuarios(String tipo, String codigo, CustomTransferObject filtro, AcessoSistema responsavel) throws UsuarioControllerException {
        return countUsuarios("0", tipo, codigo, filtro, responsavel);
    }

    @Override
    public int listCountUsuarios(String tipo, String codigo, CustomTransferObject filtro, AcessoSistema responsavel) throws UsuarioControllerException {
        return countUsuarios("1", tipo, codigo, filtro, responsavel);
    }

    @Override
    public int countUsuarios(String opcao, String tipo, String codigoEntidade, CustomTransferObject filtro, AcessoSistema responsavel) throws UsuarioControllerException {
        if (!responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_CSE) &&
            !responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_CSA) &&
            !responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_COR) &&
            !responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_ORG) &&
            !responsavel.temPermissao(CodedValues.FUN_CONS_USUARIOS_SUP)) {

            return 0;
        }

        // somente usuários de suporte podem listar usuários de papel suporte
        if (AcessoSistema.ENTIDADE_SUP.equals(tipo) && !responsavel.isSup()) {
            return 0;
        }

        try {
            if ("1".equals(opcao)) {
                final ListaUsuariosQuery query = new ListaUsuariosQuery();
                query.responsavel = responsavel;

                query.count = true;
                query.tipo = tipo;
                query.entCodigo = codigoEntidade;

                if (filtro != null) {
                    query.cseNome = (String) filtro.getAttribute(Columns.CSE_NOME);
                    query.usuCodigo = (String) filtro.getAttribute(Columns.USU_CODIGO);
                    query.usuLogin = (String) filtro.getAttribute(Columns.USU_LOGIN);
                    query.usuNome = (String) filtro.getAttribute(Columns.USU_NOME);
                    query.usuCpf = (String) filtro.getAttribute(Columns.USU_CPF);
                    query.stuCodigo = filtro.getAttribute(Columns.USU_STU_CODIGO);
                    query.orgNome = (String) filtro.getAttribute(Columns.ORG_NOME);
                    query.csaNome = (String) filtro.getAttribute(Columns.CSA_NOME + CodedValues.OR_KEY + Columns.CSA_NOME_ABREV);
                    query.csaNomeAbrev = (String) filtro.getAttribute(Columns.CSA_NOME + CodedValues.OR_KEY + Columns.CSA_NOME_ABREV);
                    query.corNome = (String) filtro.getAttribute(Columns.COR_NOME);
                    query.orgNome = (String) filtro.getAttribute(Columns.ORG_NOME);
                    query.usuCseUsuCodigo = (String) filtro.getAttribute(Columns.UCE_USU_CODIGO);
                    query.usuCsaUsuCodigo = (String) filtro.getAttribute(Columns.UCA_USU_CODIGO);
                    query.usuCorUsuCodigo = (String) filtro.getAttribute(Columns.UCO_USU_CODIGO);
                    query.usuOrgUsuCodigo = (String) filtro.getAttribute(Columns.UOR_USU_CODIGO);
                    if (filtro.getAttribute("OCULTA_USU_VISIVEL") != null) {
                        query.ocultaUsuVisivel = (Boolean) filtro.getAttribute("OCULTA_USU_VISIVEL");
                    }
                }

                return query.executarContador();
            } else {
                final ListaUsuariosEntidadeQuery query = new ListaUsuariosEntidadeQuery();
                query.entCodigo = codigoEntidade;
                query.tipo = tipo;
                query.perCodigo = (String) filtro.getAttribute(Columns.PER_CODIGO);
                query.perDescricao = (String) filtro.getAttribute(Columns.PER_DESCRICAO);
                query.usuCodigo = (String) filtro.getAttribute(Columns.USU_CODIGO);
                query.usuLogin = (String) filtro.getAttribute(Columns.USU_LOGIN);
                query.usuNome = (String) filtro.getAttribute(Columns.USU_NOME);
                query.usuCpf = (String) filtro.getAttribute(Columns.USU_CPF);
                query.stuCodigo = filtro.getAttribute(Columns.USU_STU_CODIGO);
                if (filtro.getAttribute("OCULTA_USU_VISIVEL") != null) {
                    query.ocultaUsuVisivel = (Boolean) filtro.getAttribute("OCULTA_USU_VISIVEL");
                }
                query.count = true;

                return query.executarContador();
            }

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /** LISTAGEM DE USUÁRIOS SERVIDORES ---------------------------------------------------------------------- **/

    @Override
    public List<TransferObject> lstUsuariosSerByRseCodigo(String rseCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuariosSerQuery query = new ListaUsuariosSerQuery();
            query.rseCodigo = rseCodigo;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public List<TransferObject> lstUsuariosSerByRseCodigos(List<String> rseCodigos, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuariosSerRseQuery query = new ListaUsuariosSerRseQuery();
            query.rseCodigos = rseCodigos;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public List<TransferObject> lstUsuariosSer(String serCpf, String rseMatricula, String estIdentificador, String orgIdentificador, AcessoSistema responsavel) throws UsuarioControllerException {
        return lstUsuariosSer(serCpf, rseMatricula, estIdentificador, orgIdentificador, -1, -1, responsavel);
    }

    @Override
    public List<TransferObject> lstUsuariosSer(String serCpf, String rseMatricula, String estIdentificador, String orgIdentificador, int offset, int count, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuariosSerQuery query = new ListaUsuariosSerQuery();

            if (offset != -1) {
                query.firstResult = offset;
            }

            if (count != -1) {
                query.maxResults = count;
            }

            query.serCpf = serCpf;
            query.rseMatricula = rseMatricula;
            query.estIdentificador = estIdentificador;
            query.orgIdentificador = orgIdentificador;

            return query.executarDTO();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /**
     *
     * @param usuLogin
     * @param rseMatricula
     * @param serCpf
     * @param estIdentificador
     * @param orgIdentificador
     * @param serSomenteAtivo
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public List<TransferObject> lstUsuariosSerLoginComCpf(String usuLogin, String rseMatricula, String serCpf, String estIdentificador, String orgIdentificador, boolean serSomenteAtivo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuariosServidorLoginQuery listaUsuariosServidorLoginQuery = new ListaUsuariosServidorLoginQuery();
            listaUsuariosServidorLoginQuery.usuLogin = usuLogin;
            listaUsuariosServidorLoginQuery.rseMatricula = rseMatricula;
            listaUsuariosServidorLoginQuery.serCpf = serCpf;
            listaUsuariosServidorLoginQuery.estIdentificador = estIdentificador;
            listaUsuariosServidorLoginQuery.orgIdentificador = orgIdentificador;
            listaUsuariosServidorLoginQuery.serSomenteAtivo = serSomenteAtivo;

            return listaUsuariosServidorLoginQuery.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /**
     * Retorna as funções associadas ao perfil personalizado do usuário, porém
     * somente as funções que podem ser repassadas do usuário responsavel para
     * o usuário usuCodigo.
     * @param usuCodigo : usuário que está sendo editado
     * @param tipo : tipo do usuário que está sendo editado
     * @param responsavel : responsável pela edição do usuário
     * @return A lista de funCodigos
     * @throws UsuarioControllerException
     */
    @Override
    public List<String> getUsuarioFuncoes(String usuCodigo, String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if (AcessoSistema.ENTIDADE_SER.equals(tipo)) {
                // DESENV-15096 : usuário servidor não tem mais perfil personalizado
                return new ArrayList<>();
            }

            final ListaFuncoesUsuarioQuery query = new ListaFuncoesUsuarioQuery();

            query.tipo = tipo;
            query.usuCodigo = usuCodigo;
            query.papCodigoDestino = UsuarioHelper.getPapCodigo(tipo);
            query.papCodigoOrigem = UsuarioHelper.getPapCodigo(responsavel.getTipoEntidade());

            return query.executarLista();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public Funcao findFuncao(String funCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            return FuncaoHome.findByPrimaryKey(funCodigo);
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public String createFuncao(String grfCodigo, String funDescricao, String funPermiteBloqueio, String funExigeTmo, String funExigeSegundaSenhaCse, String funExigeSegundaSenhaSup, String funExigeSegundaSenhaOrg, String funExigeSegundaSenhaCsa, String funExigeSegundaSenhaCor, String funExigeSegundaSenhaSer, String funAuditavel, List<String> papCodigos, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final Funcao funcao = FuncaoHome.create(grfCodigo, funDescricao, funPermiteBloqueio, funExigeTmo, funExigeSegundaSenhaCse, funExigeSegundaSenhaSup, funExigeSegundaSenhaOrg, funExigeSegundaSenhaCsa, funExigeSegundaSenhaCor, funExigeSegundaSenhaSer, funAuditavel);
            final String funCodigo = funcao.getFunCodigo();

            createPapelFuncao(papCodigos, funCodigo, responsavel);

            final LogDelegate logDelegate = new LogDelegate(responsavel, Log.FUNCAO, Log.CREATE, Log.LOG_INFORMACAO);
            logDelegate.setFuncao(funCodigo);
            logDelegate.setGrupoFuncao(grfCodigo);
            logDelegate.write();

            return funCodigo;
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(ex);
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel);
        }
    }

    private void createPapelFuncao(List<String> papCodigos, String funCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if ((papCodigos != null) && !papCodigos.isEmpty()) {
                for (final String papCodigo : papCodigos) {
                    PapelFuncaoHome.create(funCodigo, papCodigo);
                }
            }
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public void updateFuncao(TransferObject funcaoTO, List<String> papCodigos, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final String funCodigo = funcaoTO.getAttribute(Columns.FUN_CODIGO).toString();

            final Funcao funcao = FuncaoHome.findByPrimaryKey(funCodigo);
            final TransferObject cache = new CustomTransferObject();
            cache.setAttribute(Columns.FUN_CODIGO, funcao.getFunCodigo());
            cache.setAttribute(Columns.FUN_DESCRICAO, funcao.getFunDescricao());
            cache.setAttribute(Columns.FUN_AUDITAVEL, funcao.getFunAuditavel());
            cache.setAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_CSE, funcao.getFunExigeSegundaSenhaCse());
            cache.setAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_SUP, funcao.getFunExigeSegundaSenhaSup());
            cache.setAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_ORG, funcao.getFunExigeSegundaSenhaOrg());
            cache.setAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_CSA, funcao.getFunExigeSegundaSenhaCsa());
            cache.setAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_COR, funcao.getFunExigeSegundaSenhaCor());
            cache.setAttribute(Columns.FUN_EXIGE_TMO, funcao.getFunExigeTmo());
            cache.setAttribute(Columns.FUN_GRF_CODIGO, funcao.getGrupoFuncao().getGrfCodigo());
            cache.setAttribute(Columns.FUN_PERMITE_BLOQUEIO, funcao.getFunPermiteBloqueio());

            final LogDelegate log = new LogDelegate(responsavel, Log.FUNCAO, Log.UPDATE, Log.LOG_INFORMACAO);
            log.setFuncao(funCodigo);

            /* Compara a versão do cache com a passada por parâmetro */
            final CustomTransferObject merge = log.getUpdatedFields(funcaoTO.getAtributos(), cache.getAtributos());
            if (merge.getAtributos().containsKey(Columns.FUN_DESCRICAO)) {
                funcao.setFunDescricao((String) merge.getAttribute(Columns.FUN_DESCRICAO));
            }
            if (merge.getAtributos().containsKey(Columns.FUN_AUDITAVEL)) {
                funcao.setFunAuditavel((String) merge.getAttribute(Columns.FUN_AUDITAVEL));
            }
            if (merge.getAtributos().containsKey(Columns.FUN_EXIGE_SEGUNDA_SENHA_CSE)) {
                funcao.setFunExigeSegundaSenhaCse((String) merge.getAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_CSE));
            }
            if (merge.getAtributos().containsKey(Columns.FUN_EXIGE_SEGUNDA_SENHA_SUP)) {
                funcao.setFunExigeSegundaSenhaSup((String) merge.getAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_SUP));
            }
            if (merge.getAtributos().containsKey(Columns.FUN_EXIGE_SEGUNDA_SENHA_ORG)) {
                funcao.setFunExigeSegundaSenhaOrg((String) merge.getAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_ORG));
            }
            if (merge.getAtributos().containsKey(Columns.FUN_EXIGE_SEGUNDA_SENHA_CSA)) {
                funcao.setFunExigeSegundaSenhaCsa((String) merge.getAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_CSA));
            }
            if (merge.getAtributos().containsKey(Columns.FUN_EXIGE_SEGUNDA_SENHA_COR)) {
                funcao.setFunExigeSegundaSenhaCor((String) merge.getAttribute(Columns.FUN_EXIGE_SEGUNDA_SENHA_COR));
            }
            if (merge.getAtributos().containsKey(Columns.FUN_EXIGE_TMO)) {
                funcao.setFunExigeTmo((String) merge.getAttribute(Columns.FUN_EXIGE_TMO));
            }
            if (merge.getAtributos().containsKey(Columns.FUN_GRF_CODIGO)) {
                funcao.setGrupoFuncao(GrupoFuncaoHome.findByPrimaryKey((String) merge.getAttribute(Columns.FUN_GRF_CODIGO)));
                if (!TextHelper.isNull(merge.getAttribute(Columns.FUN_GRF_CODIGO))) {
                    log.setGrupoFuncao((String) merge.getAttribute(Columns.FUN_GRF_CODIGO));
                }
            }
            if (merge.getAtributos().containsKey(Columns.FUN_PERMITE_BLOQUEIO)) {
                funcao.setFunPermiteBloqueio((String) merge.getAttribute(Columns.FUN_PERMITE_BLOQUEIO));
            }
            AbstractEntityHome.update(funcao);

            if ((papCodigos != null) && !papCodigos.isEmpty()) {
                // Remove os papeis função antigos e insere novos papeis para a função
                removePapelFuncao(funCodigo, responsavel);
                createPapelFuncao(papCodigos, funCodigo, responsavel);

                removeVinculoFuncao(funCodigo, papCodigos, responsavel);
            }

        } catch (FindException | UpdateException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(e);
        } catch (final LogControllerException e) {
            LOG.error(e.getMessage(), e);
            throw new UsuarioControllerException(e);
        }
    }

    @Override
    public void removeFuncao(String funCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final Funcao funcao = FuncaoHome.findByPrimaryKey(funCodigo);

            removeVinculoFuncao(funCodigo, null, responsavel);

            removePapelFuncao(funCodigo, responsavel);

            AbstractEntityHome.remove(funcao);

            final LogDelegate logDelegate = new LogDelegate(responsavel, Log.FUNCAO, Log.DELETE, Log.LOG_INFORMACAO);
            logDelegate.setFuncao(funCodigo);
            logDelegate.write();

        } catch (FindException | RemoveException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(e);
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel);
        }
    }

    private void removePapelFuncao(String funCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final Collection<PapelFuncao> papeis = PapelFuncaoHome.findByFunCodigo(funCodigo);
            for (final PapelFuncao papel : papeis) {
                AbstractEntityHome.remove(papel);
            }
        } catch (FindException | RemoveException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(e);
        }
    }

    @Override
    public int countFuncao(TransferObject criterio, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListarFuncaoQuery query = new ListarFuncaoQuery();
            query.count = true;

            if ((criterio != null) && !TextHelper.isNull(criterio.getAttribute(Columns.FUN_DESCRICAO))) {
                query.funDescricao = criterio.getAttribute(Columns.FUN_DESCRICAO).toString();
            }

            if ((criterio != null) && !TextHelper.isNull(criterio.getAttribute(Columns.GRF_DESCRICAO))) {
                query.grfDescricao = criterio.getAttribute(Columns.GRF_DESCRICAO).toString();
            }

            return query.executarContador();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public List<TransferObject> listFuncao(TransferObject criterio, int offset, int size, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListarFuncaoQuery query = new ListarFuncaoQuery();

            if ((criterio != null) && !TextHelper.isNull(criterio.getAttribute(Columns.FUN_DESCRICAO))) {
                query.funDescricao = criterio.getAttribute(Columns.FUN_DESCRICAO).toString();
            }

            if ((criterio != null) && !TextHelper.isNull(criterio.getAttribute(Columns.GRF_DESCRICAO))) {
                query.grfDescricao = criterio.getAttribute(Columns.GRF_DESCRICAO).toString();
            }

            if (offset != -1) {
                query.firstResult = offset;
            }

            if (size != -1) {
                query.maxResults = size;
            }

            return query.executarDTO();

        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /**
     * Retorna um Mapa com as funções associadas ao perfil do usuário (tanto personalizado
     * quanto perfil fixo). Todas as funções são retornadas independente de bloqueio de repasse.
     * @param usuCodigo
     * @param entidade
     * @param tipo
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */

    @Override
    public Map<String, EnderecoFuncaoTransferObject> selectFuncoes(String usuCodigo, String entidade, String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        return selectFuncoes(usuCodigo, entidade, tipo, null, -1, -1, responsavel);
    }

    /**
     * Retorna um Mapa com as funções associadas ao perfil do usuário (tanto personalizado
     * quanto perfil fixo). Todas as funções são retornadas independente de bloqueio de repasse.
     * @param usuCodigo
     * @param entidade
     * @param tipo
     * @param filtro
     * @param offset
     * @param count
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public Map<String, EnderecoFuncaoTransferObject> selectFuncoes(String usuCodigo, String entidade, String tipo, CustomTransferObject filtro, int offset, int count, AcessoSistema responsavel) throws UsuarioControllerException {
        List<EnderecoFuncaoTransferObject> listResult = null;
        final Map<String, EnderecoFuncaoTransferObject> mapResult = new LinkedHashMap<>(); // Necessário manter ordenação para exibição
        String funCodigo = null, funDescricao = null;
        if ((filtro != null) && !filtro.getAtributos().isEmpty()) {
            funCodigo = (String) filtro.getAttribute(Columns.FUN_CODIGO);
            funDescricao = (String) filtro.getAttribute(Columns.FUN_DESCRICAO);
        }

        try {
            LOG.debug("usuCodigo: " + usuCodigo);

            try {
                if (TextHelper.isNull(usuCodigo)) {
                    throw new FindException("mensagem.erro.entidade.nao.encontrada", (AcessoSistema) null);
                }
                final PerfilUsuario upeBean = PerfilUsuarioHome.findByPrimaryKey(usuCodigo);

                // Busca as funções do perfil
                final FuncoesPerfilQuery query = new FuncoesPerfilQuery();
                query.perCodigo = upeBean.getPerfil().getPerCodigo();
                query.usuCodigo = usuCodigo;
                query.funCodigo = funCodigo;
                query.funDescricao = funDescricao;
                if (offset != -1) {
                    query.firstResult = offset;
                }

                if (count != -1) {
                    query.maxResults = count;
                }
                listResult = query.executarDTO(EnderecoFuncaoTransferObject.class);

            } catch (final FindException e) {
                if (AcessoSistema.ENTIDADE_SER.equals(tipo)) {
                    // DESENV-15096 : usuário servidor não tem mais perfil personalizado
                    listResult = new ArrayList<>();

                } else {
                    // Busca as funções p/ perfil personalizado
                    final FuncoesPersonalizadasQuery query = new FuncoesPersonalizadasQuery();
                    query.usuCodigo = usuCodigo;
                    query.entidade = entidade;
                    query.tipo = tipo;
                    query.funCodigo = funCodigo;
                    query.funDescricao = funDescricao;
                    if (offset != -1) {
                        query.firstResult = offset;
                    }

                    if (count != -1) {
                        query.maxResults = count;
                    }
                    listResult = query.executarDTO(EnderecoFuncaoTransferObject.class);
                }
            }
        } catch (final DAOException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }

        // Cria um mapa para facilitar a manter a compatibilidade com a estrutura (Map<String, String>, onde a chave era funCodigo e o valor era funDescricao)
        // e métodos anteriores reduzindo o impacto da alteração.
        for (final EnderecoFuncaoTransferObject enderecoFuncaoTo : listResult) {
            mapResult.put((String) enderecoFuncaoTo.getAttribute(Columns.FUN_CODIGO), enderecoFuncaoTo);
        }
        return mapResult;
    }

    /**
     * Retorna um Mapa com as funções associadas ao perfil do usuário para retrição de acesso (tanto personalizado
     * quanto perfil fixo). Somente funções com acesso_recurso e papel associados
     * @param usuCodigo
     * @param entidade
     * @param tipo
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public Map<String, String> selectFuncoesRestricaoAcesso(String usuCodigo, String entidade, String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        Map<String, String> result = null;
        try {
            LOG.debug("usuCodigo: " + usuCodigo);

            try {
                final PerfilUsuario upeBean = PerfilUsuarioHome.findByPrimaryKey(usuCodigo);

                // Busca as funções do perfil
                final FuncoesPerfilRestricaoAcessoQuery query = new FuncoesPerfilRestricaoAcessoQuery();
                query.perCodigo = upeBean.getPerfil().getPerCodigo();
                query.papel = responsavel.getPapCodigo();
                result = query.executarMapa();

            } catch (final FindException e) {
                if (!TextHelper.isNull(tipo) && AcessoSistema.ENTIDADE_SER.equals(tipo)) {
                    // DESENV-15096 : usuário servidor não tem mais perfil personalizado
                    return new HashMap<>();
                }

                // Busca as funções p/ perfil personalizado
                final FuncoesPersonalizadasRestricaoAcessoQuery query = new FuncoesPersonalizadasRestricaoAcessoQuery();
                query.usuCodigo = usuCodigo;
                query.entidade = entidade;
                query.tipo = tipo;
                query.papel = responsavel.getPapCodigo();
                result = query.executarMapa();
            }
        } catch (final DAOException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }

        return result;
    }

    @Override
    public List<TransferObject> selectFuncoes(String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaFuncoesPermitidasPapelQuery funcoesQuery = new ListaFuncoesPermitidasPapelQuery();
            funcoesQuery.papCodigoOrigem = UsuarioHelper.getPapCodigo(responsavel.getTipoEntidade());
            funcoesQuery.papCodigoDestino = UsuarioHelper.getPapCodigo(tipo);
            return funcoesQuery.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    /**
     * Recupera todas funções permitidas por natureza de consignatária
     * @param ncaCodigo
     * @return
     * @throws UsuarioControllerException
     */
    private List<String> selectFuncoesPermitidasNca(String ncaCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final List<String> resultado = new ArrayList<>();
            final ListaFuncoesPermitidasNcaQuery funcoesQuery = new ListaFuncoesPermitidasNcaQuery();
            funcoesQuery.ncaCodigo = ncaCodigo;
            final List<TransferObject> funcoes = funcoesQuery.executarDTO();
            for (final TransferObject funcao : funcoes) {
                resultado.add((String) funcao.getAttribute(Columns.FPN_FUN_CODIGO));
            }
            return resultado;
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public List<TransferObject> selectFuncoesSensiveisCsa(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            return new ListaFuncoesSensiveisCsaQuery().executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /**
     * Lista as permissões de função por natureza de consignatária.
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public List<TransferObject> selectFuncoesPermitidasNca(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaFuncoesPermitidasNcaQuery funcoesQuery = new ListaFuncoesPermitidasNcaQuery();
            return funcoesQuery.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    /**
     * Recupera todos os papeis do sistema.
     *
     * @return Retorna uma lista com todos os papeis do sistema.
     * @throws UsuarioControllerException
     */
    @Override
    public List<TransferObject> lstPapel(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaPapeisQuery query = new ListaPapeisQuery();
            return query.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    /** BLOQUEIO DE FUNÇÕES ---------------------------------------------------------------------------------- **/

    @Override
    public List<TransferObject> lstFuncoes(String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaFuncoesQuery query = new ListaFuncoesQuery();
            query.tipo = tipo;
            return query.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public Map<String, String> getMapFuncoes(String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaFuncoesQuery query = new ListaFuncoesQuery();
            query.tipo = tipo;
            return query.executarMapa();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public List<TransferObject> lstFuncoesBloqueaveis(String tipo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaFuncoesBloqueaveisQuery funcoesBloqQuery = new ListaFuncoesBloqueaveisQuery();
            funcoesBloqQuery.tipo = tipo;
            return funcoesBloqQuery.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public List<TransferObject> findFuncoesRegraTaxa(String funCodigos, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaFuncoesRegraTaxaQuery funcoesRegraTaxa = new ListaFuncoesRegraTaxaQuery();
            funcoesRegraTaxa.funCodigos = funCodigos;
            return funcoesRegraTaxa.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public List<TransferObject> selectFuncoesBloqueadas(String usuario, AcessoSistema responsavel) throws UsuarioControllerException {
        return selectFuncoesBloqueadas(usuario, null, responsavel);
    }

    @Override
    public List<TransferObject> selectFuncoesBloqueadas(String usuario, String tipoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaFuncoesBloqueadasQuery funcoesBloqueadasQuery = new ListaFuncoesBloqueadasQuery();
            funcoesBloqueadasQuery.usuCodigo = usuario;
            funcoesBloqueadasQuery.tipoEntidade = tipoEntidade;
            return funcoesBloqueadasQuery.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public void insereBloqueiosFuncoes(String usuCodigo, List<TransferObject> bloqueios, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            // Remove as funções antigas bloqueadas
            final List<BloqueioUsuFunSvc> blocToRemove = BloqueioUsuFunSvcHome.findByUsuCodigo(usuCodigo);
            for (final BloqueioUsuFunSvc bloqueio : blocToRemove) {
                AbstractEntityHome.remove(bloqueio);

                final LogDelegate log = new LogDelegate(responsavel, Log.BLOQUEIO_FUNCAO_USU_SVC, Log.DELETE, Log.LOG_INFORMACAO);
                log.setUsuario(usuCodigo);
                log.setServico(bloqueio.getServico().getSvcCodigo());
                log.setFuncao(bloqueio.getFuncao().getFunCodigo());
                log.write();
            }

            // Insere as novas funções bloqueadas
            if ((bloqueios != null) && !bloqueios.isEmpty()) {
                for (final TransferObject bloqueio : bloqueios) {
                    final String svcCodigo = bloqueio.getAttribute(Columns.BUF_SVC_CODIGO).toString();
                    final String funCodigo = bloqueio.getAttribute(Columns.BUF_FUN_CODIGO).toString();
                    BloqueioUsuFunSvcHome.create(funCodigo, usuCodigo, svcCodigo);

                    final LogDelegate log = new LogDelegate(responsavel, Log.BLOQUEIO_FUNCAO_USU_SVC, Log.CREATE, Log.LOG_INFORMACAO);
                    log.setUsuario(usuCodigo);
                    log.setServico(svcCodigo);
                    log.setFuncao(funCodigo);
                    log.write();
                }
            }

            if (!blocToRemove.isEmpty() || ((bloqueios != null) && !bloqueios.isEmpty())) {
                // Cria ocorrência de alteração de perfil de usuário
                final CustomTransferObject ocorrencia = new CustomTransferObject();
                ocorrencia.setAttribute(Columns.OUS_USU_CODIGO, usuCodigo);
                ocorrencia.setAttribute(Columns.OUS_TOC_CODIGO, CodedValues.TOC_ALTERACAO_PERFIL_USUARIO);
                ocorrencia.setAttribute(Columns.OUS_OUS_USU_CODIGO, responsavel.getUsuCodigo());
                ocorrencia.setAttribute(Columns.OUS_OBS, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.perfil.usuario", responsavel));
                ocorrencia.setAttribute(Columns.OUS_IP_ACESSO, responsavel.getIpUsuario());

                createOcorrenciaUsuario(ocorrencia, responsavel);
            }
        } catch (CreateException | RemoveException | FindException | LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public boolean usuarioTemBloqueioFuncao(String usuCodigo, String funCodigo, String svcCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        final CustomTransferObject funcao = getFuncao(funCodigo, responsavel);

        if (funcao == null) {
            return true;
        }

        if (funcao.getAttribute(Columns.FUN_PERMITE_BLOQUEIO) == null) {
            return false;
        }

        if (CodedValues.TPC_SIM.equals(funcao.getAttribute(Columns.FUN_PERMITE_BLOQUEIO).toString())) {
            final List<TransferObject> bloqueiosUsuario = selectFuncoesBloqueadas(usuCodigo, responsavel);
            for (final TransferObject bloqueio : bloqueiosUsuario) {
                if (bloqueio.getAttribute(Columns.BUF_USU_CODIGO).toString().equals(usuCodigo) && bloqueio.getAttribute(Columns.BUF_FUN_CODIGO).toString().equals(funCodigo) && bloqueio.getAttribute(Columns.BUF_SVC_CODIGO).toString().equals(svcCodigo)) {
                    return true;
                }
            }
        } else {
        }

        return false;
    }

    @Override
    public List<TransferObject> lstFuncaoExigeTmo(String funExigeTmo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemFuncaoQuery funQuery = new ObtemFuncaoQuery();
            funQuery.funExigeTmo = funExigeTmo;
            return funQuery.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    /** EDIÇÃO DE PERFIL -------------------------------------------------------------------------------------- **/

    @Override
    public Perfil findPerfil(String perCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            return PerfilHome.findByPrimaryKey(perCodigo);
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, "");
        }
    }

    @Override
    public Short getPerfilStatus(String perCodigo, String tipo, String entCodigo, AcessoSistema responsavel) throws FindException, UsuarioControllerException {
        try {
            if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                final PerfilCse perCse = PerfilCseHome.findByPrimaryKey(new PerfilCseId(entCodigo, perCodigo));
                return perCse.getPceAtivo();
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                final PerfilCsa perCsa = PerfilCsaHome.findByPrimaryKey(new PerfilCsaId(entCodigo, perCodigo));
                return perCsa.getPcaAtivo();
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                final PerfilOrg perOrg = PerfilOrgHome.findByPrimaryKey(new PerfilOrgId(entCodigo, perCodigo));
                return perOrg.getPorAtivo();
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                final PerfilCor perCor = PerfilCorHome.findByPrimaryKey(new PerfilCorId(entCodigo, perCodigo));
                return perCor.getPcoAtivo();
            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                final PerfilSup perSup = PerfilSupHome.findByPrimaryKey(new PerfilSupId(entCodigo, perCodigo));
                return perSup.getPsuAtivo();
            } else {
                return null;
            }
        } catch (final FindException fex) {
            throw fex;
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.recuperar.perfil", responsavel);
        }
    }

    @Override
    public String createPerfil(String tipoEntidade, String codigoEntidade, String perDescricao, String perVisivel, java.util.Date perDataExpiracao, String perEntAltera, String perOrigem, String perAutoDesbloqueio, List<String> funCodigo, String perIpAcesso, String perDdnsAcesso, AcessoSistema responsavel) throws UsuarioControllerException {
        return createPerfil(tipoEntidade, codigoEntidade, perDescricao, perVisivel, perDataExpiracao, perEntAltera, perOrigem, perAutoDesbloqueio, funCodigo, null, perIpAcesso, perDdnsAcesso, responsavel);
    }

    @Override
    public String createPerfil(String tipoEntidade, String codigoEntidade, String perDescricao, String perVisivel, java.util.Date perDataExpiracao, String perEntAltera, String perOrigem, String perAutoDesbloqueio, List<String> funCodigo, Boolean pcaPerfilPadrao, String perIpAcesso, String perDdnsAcesso, AcessoSistema responsavel) throws UsuarioControllerException {
        String perCodigo = null;
        try {
            final String papCodigo = UsuarioHelper.getPapCodigo(tipoEntidade);
            final Short status = CodedValues.STS_ATIVO;
            if (TextHelper.isNull(perEntAltera)) {
                perEntAltera = CodedValues.TPA_SIM;
            }

            if (TextHelper.isNull(perAutoDesbloqueio)) {
                perAutoDesbloqueio = CodedValues.TPA_NAO;
            }

            // Cria o perfil
            final Perfil perBean = PerfilHome.create(papCodigo, perDescricao, perVisivel, perDataExpiracao, perAutoDesbloqueio, perEntAltera, perIpAcesso, perDdnsAcesso );
            perCodigo = perBean.getPerCodigo();

            // Se for passado um perfil de origem, as funções do perfil de origem serão replicadas para o novo perfil
            if (!TextHelper.isNull(perOrigem)) {
                funCodigo = new ArrayList<>();
                final Collection<FuncaoPerfil> funcoesPerfil = FuncaoPerfilHome.findByPerfil(perOrigem);
                if ((funcoesPerfil != null) && !funcoesPerfil.isEmpty()) {
                    for (final FuncaoPerfil funcaoPerfil : funcoesPerfil) {
                        funCodigo.add(funcaoPerfil.getFunCodigo());
                    }
                }
            }

            // Cria as funções para o perfil
            updateFuncaoPerfil(tipoEntidade, codigoEntidade, perCodigo, funCodigo, responsavel);

            // Associa o perfil a sua entidade
            if (CodedValues.PAP_CONSIGNANTE.equals(papCodigo)) { // CSE
                PerfilCseHome.create(codigoEntidade, perCodigo, status);
            } else if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigo)) { // CSA
                PerfilCsaHome.create(codigoEntidade, perCodigo, status, pcaPerfilPadrao);
                updateOthersPerfils(pcaPerfilPadrao, codigoEntidade, perCodigo);
            } else if (CodedValues.PAP_ORGAO.equals(papCodigo)) { // ORG
                PerfilOrgHome.create(codigoEntidade, perCodigo, status);
            } else if (CodedValues.PAP_CORRESPONDENTE.equals(papCodigo)) { // COR
                PerfilCorHome.create(codigoEntidade, perCodigo, status);
            } else if (CodedValues.PAP_SUPORTE.equals(papCodigo)) { // SUP
                PerfilSupHome.create(codigoEntidade, perCodigo, status);
            } else {
                throw new UsuarioControllerException("mensagem.erro.arg0.tipo.entidade.invalido", responsavel, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
            }

            // Verifica se o responsável pode modificar este perfil
            usuarioPodeModificarPerfil(perCodigo, false, true, responsavel);

            // Gera o log de auditoria
            final LogDelegate logDelegate = new LogDelegate(responsavel, Log.PERFIL, Log.CREATE, Log.LOG_INFORMACAO);
            logDelegate.setPerfil(perCodigo);
            if (!TextHelper.isNull(perOrigem)) {
                logDelegate.setPerfilOrigem(perOrigem);
                logDelegate.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.perfil.criado.a.partir.das.funcoes.associadas.perfil.origem", responsavel));
            }
            logDelegate.write();

            if ((funCodigo != null) && funCodigo.isEmpty()) {
                criaOcorrenciaPerfil(perCodigo, CodedValues.TOC_ALTERA_PERFIL, ApplicationResourcesHelper.getMessage("mensagem.perfil.ocorrencia.criado", responsavel), null, responsavel);
            }

        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.interno.do.sistema.ao.criar.perfil", responsavel);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();

            if (ex instanceof UsuarioControllerException) {
                throw (UsuarioControllerException) ex;
            } else {
                throw new UsuarioControllerException("mensagem.erro.interno.do.sistema.ao.criar.perfil", responsavel);
            }
        }

        return perCodigo;
    }

    @Override
    public void updatePerfil(String tipoEntidade, String codigoEntidade, String perCodigo, String perDescricao, String perVisivel, java.util.Date perDataExpiracao, String perEntAltera, Short status, String perAutDesbloqueio, String perIpAcesso, String perDdnsAcesso, Boolean pcaPerfilPadrao, List<String> funcoes, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if (usuarioPodeModificarPerfil(perCodigo, true, true, responsavel)) {
                final String papCodigo = UsuarioHelper.getPapCodigo(tipoEntidade);

                // Busca o perfil
                final Perfil perBean = PerfilHome.findByPrimaryKey(perCodigo);
                boolean alterou = false;

                // Cria log de edição do perfil
                final LogDelegate logDelegate = new LogDelegate(responsavel, Log.PERFIL, Log.UPDATE, Log.LOG_INFORMACAO);
                logDelegate.setPerfil(perCodigo);

                // Altera a descrição do perfil
                if ((perDescricao != null) && !perDescricao.equals(perBean.getPerDescricao())) {
                    logDelegate.addChangedField(Columns.PER_DESCRICAO, perDescricao, perBean.getPerDescricao());
                    perBean.setPerDescricao(perDescricao);
                    alterou = true;
                }
                if ((perVisivel != null) && !perVisivel.equals(perBean.getPerVisivel())) {
                    logDelegate.addChangedField(Columns.PER_VISIVEL, perVisivel, perBean.getPerVisivel());
                    perBean.setPerVisivel(perVisivel);
                    alterou = true;
                }
                if (((perDataExpiracao != null) && (perBean.getPerDataExpiracao() != null) && (perBean.getPerDataExpiracao().compareTo(perDataExpiracao) != 0)) || (TextHelper.isNull(perDataExpiracao) && (perBean.getPerDataExpiracao() != null)) || (!TextHelper.isNull(perDataExpiracao) && TextHelper.isNull(perBean.getPerDataExpiracao()))) {
                    logDelegate.addChangedField(Columns.PER_DATA_EXPIRACAO, perDataExpiracao, perBean.getPerDataExpiracao());
                    perBean.setPerDataExpiracao(perDataExpiracao);
                    alterou = true;
                }

                if ((perAutDesbloqueio != null) && (perBean.getPerAutoDesbloqueio() != null) && (perBean.getPerAutoDesbloqueio().compareTo(perAutDesbloqueio) != 0)) {
                    logDelegate.addChangedField(Columns.PER_AUTO_DESBLOQUEIO, perAutDesbloqueio, perBean.getPerAutoDesbloqueio());
                    perBean.setPerAutoDesbloqueio(perAutDesbloqueio);
                    alterou = true;
                }

                if ((perEntAltera != null) && !perEntAltera.equals(perBean.getPerEntAltera())) {
                    perBean.setPerEntAltera(perEntAltera);
                    alterou = true;
                }

                //Altera ip do perfil.
                if((perIpAcesso != null) && !perIpAcesso.equals(perBean.getPerIpAcesso())) {
                    perBean.setPerIpAcesso(perIpAcesso);
                    alterou = true;
                }

                //Altera ddns do perfil.
                if((perDdnsAcesso != null) && !perDdnsAcesso.equals(perBean.getPerDdnsAcesso())) {
                    perBean.setPerDdnsAcesso(perDdnsAcesso);
                    alterou = true;
                }

                if (alterou) {
                    AbstractEntityHome.update(perBean);
                }

                // Altera o perfil nas tabelas de entidades
                if (!TextHelper.isNull(papCodigo)) {
                    if (CodedValues.PAP_CONSIGNANTE.equals(papCodigo)) { // CSE
                        updatePcaCseBean(codigoEntidade, perCodigo, status, logDelegate);
                    } else if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigo)) { // CSA
                        updatePcaCsaBean(codigoEntidade, perCodigo, status, pcaPerfilPadrao, logDelegate);
                    } else if (CodedValues.PAP_ORGAO.equals(papCodigo)) { // ORG
                        updatePcaOrgBean(codigoEntidade, perCodigo, status, logDelegate);
                    } else if (CodedValues.PAP_CORRESPONDENTE.equals(papCodigo)) { // COR
                        updatePcaCorBean(codigoEntidade, perCodigo, status, logDelegate);
                    } else if (CodedValues.PAP_SUPORTE.equals(papCodigo)) { // SUP
                        updatePcaSupBean(codigoEntidade, perCodigo, status, logDelegate);
                    } else {
                        throw new UsuarioControllerException("mensagem.erro.arg0.tipo.entidade.invalido", responsavel, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
                    }
                }
                
                if (status != null) {
                    if (status.equals(CodedValues.STS_ATIVO)) {
                        criaOcorrenciaPerfil(perCodigo, CodedValues.TOC_ALTERA_PERFIL, ApplicationResourcesHelper.getMessage("mensagem.perfil.ocorrencia.desbloqueio", responsavel), null, responsavel);
                    } else {
                        criaOcorrenciaPerfil(perCodigo, CodedValues.TOC_ALTERA_PERFIL, ApplicationResourcesHelper.getMessage("mensagem.perfil.ocorrencia.bloqueio", responsavel), null, responsavel);
                    }
                }

                // Atualiza as funções do perfil
                final boolean funcoesAlteradas = updateFuncaoPerfil(tipoEntidade, codigoEntidade, perCodigo, funcoes, responsavel);

                // Atualiza o log
                logDelegate.write();

                if ((funcoes != null) && funcoes.isEmpty()) {
                    criaOcorrenciaPerfil(perCodigo, CodedValues.TOC_ALTERA_PERFIL, ApplicationResourcesHelper.getMessage("mensagem.perfil.ocorrencia.alterado", responsavel), null, responsavel);
                }

                if (funcoesAlteradas) {
                    // Notifica as entidades da alteração do perfil de usuário
                    EnviaEmailHelper.enviarEmailAlteracaoPerfil(perCodigo, tipoEntidade, codigoEntidade, responsavel);
                }
            }
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, "");
        } catch (final UpdateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.atualizar.este.perfil.erro.interno.arg0", responsavel, ex.getMessage());
        } catch (final ZetraException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    private void updatePcaCsaBean(String codigoEntidade, String perCodigo, Short status, Boolean pcaPerfilPadrao,
            final LogDelegate logDelegate) throws FindException, UpdateException, LogControllerException {

        final PerfilCsa pcaBean = PerfilCsaHome.findByPrimaryKey(new PerfilCsaId(codigoEntidade, perCodigo));
        Boolean previousPerfilPadrao = pcaBean.getPcaPerfilPadrao();

        if (status != null) {
            pcaBean.setPcaAtivo(status);
        }

        if (isToChangePerfilPadrao(pcaPerfilPadrao, previousPerfilPadrao)) {

            pcaBean.setPcaPerfilPadrao(pcaPerfilPadrao);
            updateOthersPerfils(pcaPerfilPadrao, codigoEntidade, perCodigo);

        }

        AbstractEntityHome.update(pcaBean);
        logDelegate.addChangedField(Columns.PCA_ATIVO, status);
    }

    private boolean isToChangePerfilPadrao(Boolean pcaPerfilPadrao, Boolean previousPerfilPadrao) {
        return pcaPerfilPadrao != null && !pcaPerfilPadrao.equals(previousPerfilPadrao);
    }

    private void updateOthersPerfils(Boolean pcaPerfilPadrao, String codigoEntidade, String perCodigo) throws FindException, UpdateException {
        
        if (pcaPerfilPadrao != null && pcaPerfilPadrao) {

            List<PerfilCsa> perfilCsas = PerfilCsaHome.listByCsaCodigo(codigoEntidade);

            for (PerfilCsa perfilCsa : perfilCsas) {

                if (!perCodigo.equals(perfilCsa.getPerCodigo())) {
                    perfilCsa.setPcaPerfilPadrao(false);
                    PerfilCsaHome.update(perfilCsa);
                }

            }

        }


    }

    private void updatePcaSupBean(String codigoEntidade, String perCodigo, Short status, final LogDelegate logDelegate)
            throws FindException, UpdateException, LogControllerException {

        if (status != null) {
            final PerfilSup psuBean = PerfilSupHome.findByPrimaryKey(new PerfilSupId(codigoEntidade, perCodigo));
            psuBean.setPsuAtivo(status);
            AbstractEntityHome.update(psuBean);
            logDelegate.addChangedField(Columns.PSU_ATIVO, status);
        }
        
    }

    private void updatePcaCorBean(String codigoEntidade, String perCodigo, Short status, final LogDelegate logDelegate)
            throws FindException, UpdateException, LogControllerException {
        
        if (status != null) {
            final PerfilCor pcoBean = PerfilCorHome.findByPrimaryKey(new PerfilCorId(codigoEntidade, perCodigo));
            pcoBean.setPcoAtivo(status);
            AbstractEntityHome.update(pcoBean);
            logDelegate.addChangedField(Columns.PCO_ATIVO, status);
        }

    }

    private void updatePcaOrgBean(String codigoEntidade, String perCodigo, Short status, final LogDelegate logDelegate)
            throws FindException, UpdateException, LogControllerException {
        
        if (status != null) {
            final PerfilOrg porBean = PerfilOrgHome.findByPrimaryKey(new PerfilOrgId(codigoEntidade, perCodigo));
            porBean.setPorAtivo(status);
            AbstractEntityHome.update(porBean);
            logDelegate.addChangedField(Columns.POR_ATIVO, status);
        }

    }

    private void updatePcaCseBean(String codigoEntidade, String perCodigo, Short status, final LogDelegate logDelegate)
            throws FindException, UpdateException, LogControllerException {

        if (status != null) {
            final PerfilCse pceBean = PerfilCseHome.findByPrimaryKey(new PerfilCseId(codigoEntidade, perCodigo));
            pceBean.setPceAtivo(status);
            AbstractEntityHome.update(pceBean);
            logDelegate.addChangedField(Columns.PCE_ATIVO, status);
        }

    }

    private boolean updateFuncaoPerfil(String tipoEntidade, String codigoEntidade, String perCodigo, List<String> funcoes, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            // Altera as funções deste perfil
            if (funcoes != null) {
                final List<String> funcoesNovas = new ArrayList<>();
                final List<String> funcoesRemovidas = new ArrayList<>();

                FuncaoPerfil fperBean = null;

                // Navega nas funções antigas deste perfil
                final List<String> funcoesOld = getFuncaoPerfil(tipoEntidade, codigoEntidade, perCodigo, responsavel);

                // Funções permitidas para o usuário
                final List<String> funcoesPermitidas = new ArrayList<>();
                final List<TransferObject> funPermUsu = lstFuncoesPermitidasPerfil(tipoEntidade, codigoEntidade, responsavel);
                if ((funPermUsu != null) && !funPermUsu.isEmpty()) {
                    for (final TransferObject transferObject : funPermUsu) {
                        funcoesPermitidas.add(transferObject.getAttribute(Columns.FUN_CODIGO).toString());
                    }
                }

                if (funcoes != null) {
                    for (final String funPermitida : funcoesPermitidas) {
                        if (funcoesOld.contains(funPermitida) && !funcoes.contains(funPermitida)) {
                            fperBean = FuncaoPerfilHome.findByPrimaryKey(new FuncaoPerfilId(funPermitida, perCodigo));

                            // se a função a ser removida é a de usuário auditor, verifica se os usuários do perfil
                            // são os únicos auditores do sistema. caso sim, não é permitido remover esta permissão
                            if (CodedValues.FUN_USUARIO_AUDITOR.equals(funPermitida)) {
                                final ListaUsuariosAuditoresQuery lstAuditores = new ListaUsuariosAuditoresQuery();
                                final List<String> perCodigos = new ArrayList<>();
                                perCodigos.add(CodedValues.NOT_EQUAL_KEY);
                                perCodigos.add(perCodigo);
                                lstAuditores.perCodigo = perCodigos;
                                lstAuditores.codigoEntidade = codigoEntidade;
                                lstAuditores.tipo = tipoEntidade;
                                lstAuditores.count = true;

                                try {
                                    final int auditoresQntd = lstAuditores.executarContador();
                                    if (auditoresQntd <= 0) {
                                        final ListaFuncoesAuditadasQuery funcAuditadasEnt = new ListaFuncoesAuditadasQuery();
                                        funcAuditadasEnt.codigoEntidade = codigoEntidade;
                                        funcAuditadasEnt.tipo = tipoEntidade;
                                        funcAuditadasEnt.count = true;

                                        final int numFuncAuditadas = funcAuditadasEnt.executarContador();
                                        if (numFuncAuditadas > 0) {
                                            throw new UsuarioControllerException("mensagem.erro.permissao.auditoria.nao.pode.remover", responsavel);
                                        }
                                    }
                                } catch (final HQueryException e) {
                                    throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel);
                                }

                                AbstractEntityHome.remove(fperBean);
                                funcoesRemovidas.add(funPermitida);
                            } else {
                                AbstractEntityHome.remove(fperBean);
                                funcoesRemovidas.add(funPermitida);
                            }
                        } else if (funcoesOld.contains(funPermitida) && funcoes.contains(funPermitida)) {
                            // Usuário já possui a função, não precisa incluir
                            continue;
                        } else if (!funcoesOld.contains(funPermitida) && funcoes.contains(funPermitida)) {
                            funcoesNovas.add(funPermitida);
                        }
                    }
                }

                // todos os usuários do perfil devem ter e-mail cadastrado ao adicionar permissão de usuário auditor
                if (funcoesNovas.contains(CodedValues.FUN_USUARIO_AUDITOR)) {
                    final CustomTransferObject filtro = new CustomTransferObject();
                    filtro.setAttribute(Columns.PER_CODIGO, perCodigo);

                    final List<TransferObject> listUsuarios = lstUsuarios("0", tipoEntidade, codigoEntidade, filtro, responsavel);
                    if (!listUsuarios.isEmpty()) {
                        for (final TransferObject usuario : listUsuarios) {
                            if (TextHelper.isNull(usuario.getAttribute(Columns.USU_EMAIL))) {
                                throw new UsuarioControllerException("mensagem.erro.todos.usuarios.perfil.devem.possuir.email.valido.cadastrado.para.atribuir.permissao.auditor", responsavel);
                            }
                        }
                    }
                }

                // Insere as novas funções
                if (funcoesNovas.size() > 0) {
                    createFuncaoPerfil(funcoesNovas, perCodigo, responsavel);
                }

                // Grava log das funções removidas
                if ((funcoesRemovidas != null) && (funcoesRemovidas.size() > 0)) {
                    final LogDelegate log = new LogDelegate(responsavel, Log.FUNCAO_PERFIL, Log.DELETE, Log.LOG_INFORMACAO);
                    log.setPerfil(perCodigo);
                    for (final String funcaoRemovida : funcoesRemovidas) {
                        log.setFuncao(funcaoRemovida);
                        log.write();
                    }
                }

                // Insere ocorrência de inclusão ou alteração para o perfil
                String funcoesInseridas = "";
                String funcoesRetiradas = "";

                if ((funcoesNovas != null) && !funcoesNovas.isEmpty()) {
                    for (final String funcao : funcoesNovas) {
                        funcoesInseridas += funcao + ", ";
                    }
                }

                if ((funcoesRemovidas != null) && !funcoesRemovidas.isEmpty()) {
                    for (final String funcao : funcoesRemovidas) {
                        funcoesRetiradas += funcao + ", ";
                    }
                }

                if ((funcoesNovas != null) && !funcoesNovas.isEmpty() && ((funcoesOld == null) || funcoesOld.isEmpty())) {
                    criaOcorrenciaPerfil(perCodigo, CodedValues.TOC_ALTERA_PERFIL, ApplicationResourcesHelper.getMessage("mensagem.perfil.ocorrencia.inclusao", responsavel, funcoesInseridas.substring(0, funcoesInseridas.length() - 2)), null, responsavel);
                } else if ((funcoesNovas != null) && !funcoesNovas.isEmpty() && ((funcoesRemovidas == null) || funcoesRemovidas.isEmpty())) {
                    criaOcorrenciaPerfil(perCodigo, CodedValues.TOC_ALTERA_PERFIL, ApplicationResourcesHelper.getMessage("mensagem.perfil.ocorrencia.alteracao", responsavel, funcoesInseridas.substring(0, funcoesInseridas.length() - 2)), null, responsavel);
                } else if ((funcoesNovas != null) && !funcoesNovas.isEmpty() && (funcoesRemovidas != null) && !funcoesRemovidas.isEmpty()) {
                    criaOcorrenciaPerfil(perCodigo, CodedValues.TOC_ALTERA_PERFIL, ApplicationResourcesHelper.getMessage("mensagem.perfil.ocorrencia.alteracao.remocao.inclusao", responsavel, funcoesInseridas.substring(0, funcoesInseridas.length() - 2), funcoesRetiradas.substring(0, funcoesRetiradas.length() - 2)), null, responsavel);
                } else if (((funcoesNovas == null) || funcoesNovas.isEmpty()) && (funcoesRemovidas != null) && !funcoesRemovidas.isEmpty()) {
                    criaOcorrenciaPerfil(perCodigo, CodedValues.TOC_ALTERA_PERFIL, ApplicationResourcesHelper.getMessage("mensagem.perfil.ocorrencia.remocao", responsavel, funcoesRetiradas.substring(0, funcoesRetiradas.length() - 2)), null, responsavel);
                }

                return ((funcoesNovas != null) && !funcoesNovas.isEmpty()) || ((funcoesRemovidas != null) && !funcoesRemovidas.isEmpty());
            }
            return false;
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, "");
        } catch (final RemoveException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.atualizar.este.perfil.erro.interno.arg0", responsavel, ex.getMessage());
        }
    }

    @Override
    public void removePerfil(String tipoEntidade, String codigoEntidade, String perCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if (usuarioPodeModificarPerfil(perCodigo, true, true, responsavel)) {
                final String papCodigo = UsuarioHelper.getPapCodigo(tipoEntidade);

                // verifica se este perfil tem usuários ligados a ele antes de remover
                final List<PerfilUsuario> usuarios = PerfilUsuarioHome.findByPerfil(perCodigo);
                if ((usuarios != null) && (usuarios.size() > 0)) {
                    throw new UsuarioControllerException("mensagem.erro.nao.possivel.remover.perfil.pois.existem.usuarios.associados", responsavel);
                }

                // Remove as funções deste perfil
                final List<FuncaoPerfil> funcoes = FuncaoPerfilHome.findByPerfil(perCodigo);
                for (final FuncaoPerfil fperBean : funcoes) {
                    AbstractEntityHome.remove(fperBean);
                }

                // Remove a associação do perfil com a entidade criadora
                if (CodedValues.PAP_CONSIGNANTE.equals(papCodigo)) { // CSE
                    final PerfilCse pceBean = PerfilCseHome.findByPrimaryKey(new PerfilCseId(codigoEntidade, perCodigo));
                    AbstractEntityHome.remove(pceBean);
                } else if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigo)) { // CSA
                    final PerfilCsa pcaBean = PerfilCsaHome.findByPrimaryKey(new PerfilCsaId(codigoEntidade, perCodigo));
                    AbstractEntityHome.remove(pcaBean);
                } else if (CodedValues.PAP_ORGAO.equals(papCodigo)) { // ORG
                    final PerfilOrg porBean = PerfilOrgHome.findByPrimaryKey(new PerfilOrgId(codigoEntidade, perCodigo));
                    AbstractEntityHome.remove(porBean);
                } else if (CodedValues.PAP_CORRESPONDENTE.equals(papCodigo)) { // COR
                    final PerfilCor pcoBean = PerfilCorHome.findByPrimaryKey(new PerfilCorId(codigoEntidade, perCodigo));
                    AbstractEntityHome.remove(pcoBean);
                } else if (CodedValues.PAP_SUPORTE.equals(papCodigo)) { // SUP
                    final PerfilSup psuBean = PerfilSupHome.findByPrimaryKey(new PerfilSupId(codigoEntidade, perCodigo));
                    AbstractEntityHome.remove(psuBean);
                } else {
                    throw new UsuarioControllerException("mensagem.erro.arg0.tipo.entidade.invalido", responsavel, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
                }

                // Remove Ocorrências do perfil
                OcorrenciaPerfilHome.deleteTodasOcorrenciaPerfilSelecionado(perCodigo);

                // Remove o perfil
                final Perfil perBean = PerfilHome.findByPrimaryKey(perCodigo);
                AbstractEntityHome.remove(perBean);

                final LogDelegate logDelegate = new LogDelegate(responsavel, Log.PERFIL, Log.DELETE, Log.LOG_INFORMACAO);
                logDelegate.setPerfil(perCodigo);
                logDelegate.write();
            }
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, "");
        } catch (final RemoveException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.remover.este.perfil.erro.interno.arg0", responsavel, ex.getMessage());
        }
    }

    @Override
    public void copyPerfil(String tipoEntidade, String codigoEntidade, String perOrigem, List<String> perDestino, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if (TextHelper.isNull(perOrigem)) {
                throw new UsuarioControllerException("mensagem.erro.selecione.um.perfil.origem.de.onde.funcoes.serao.copiadas", responsavel);
            }
            if ((perDestino == null) || perDestino.isEmpty()) {
                throw new UsuarioControllerException("mensagem.erro.selecione.pelo.menos.um.perfil.destino.onde.funcoes.serao.aplicadas", responsavel);
            }

            // Recupera as funções que serão copiadas
            final List<String> funcoes = new ArrayList<>();
            final Collection<FuncaoPerfil> funcoesPerfil = FuncaoPerfilHome.findByPerfil(perOrigem);
            if ((funcoesPerfil != null) && !funcoesPerfil.isEmpty()) {
                for (final FuncaoPerfil funcaoPerfil : funcoesPerfil) {
                    funcoes.add(funcaoPerfil.getFunCodigo());
                }
            }

            for (final String perCodigoDestino : perDestino) {
                if (!perCodigoDestino.equals(perOrigem)) {
                    final Perfil perfilDestino = PerfilHome.findByPrimaryKey(perCodigoDestino);
                    Short status = null;
                    if (AcessoSistema.ENTIDADE_CSE.equals(tipoEntidade)) {
                        final PerfilCse perfilEntidade = PerfilCseHome.findByPrimaryKey(new PerfilCseId(codigoEntidade, perCodigoDestino));
                        status = perfilEntidade.getPceAtivo();
                    } else if (AcessoSistema.ENTIDADE_CSA.equals(tipoEntidade)) {
                        final PerfilCsa perfilEntidade = PerfilCsaHome.findByPrimaryKey(new PerfilCsaId(codigoEntidade, perCodigoDestino));
                        status = perfilEntidade.getPcaAtivo();
                    } else if (AcessoSistema.ENTIDADE_COR.equals(tipoEntidade)) {
                        final PerfilCor perfilEntidade = PerfilCorHome.findByPrimaryKey(new PerfilCorId(codigoEntidade, perCodigoDestino));
                        status = perfilEntidade.getPcoAtivo();
                    } else if (AcessoSistema.ENTIDADE_ORG.equals(tipoEntidade)) {
                        final PerfilOrg perfilEntidade = PerfilOrgHome.findByPrimaryKey(new PerfilOrgId(codigoEntidade, perCodigoDestino));
                        status = perfilEntidade.getPorAtivo();
                    } else if (AcessoSistema.ENTIDADE_SUP.equals(tipoEntidade)) {
                        final PerfilSup perfilEntidade = PerfilSupHome.findByPrimaryKey(new PerfilSupId(codigoEntidade, perCodigoDestino));
                        status = perfilEntidade.getPsuAtivo();
                    }
                    if (status.equals(CodedValues.STS_INDISP)) {
                        LOG.warn("Funções não foram copiadas para o perfil ['" + perCodigoDestino + "'] porque o perfil está excluído.");
                        continue;
                    }

                    // Altera as funções do perfil
                    updatePerfil(tipoEntidade, codigoEntidade, perCodigoDestino, perfilDestino.getPerDescricao(), perfilDestino.getPerVisivel(), perfilDestino.getPerDataExpiracao(), null, status, null, null, null, null, funcoes, responsavel);

                    // Gera o log de auditoria
                    final LogDelegate logDelegate = new LogDelegate(responsavel, Log.PERFIL, Log.UPDATE, Log.LOG_INFORMACAO);
                    logDelegate.setPerfil(perCodigoDestino);
                    logDelegate.setPerfilOrigem(perOrigem);
                    logDelegate.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.perfil.alterado.a.partir.funcoes.associadas.perfil.origem", responsavel));
                    logDelegate.write();
                }
            }
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.recuperar.informacoes.para.copia.funcoes.para.perfil", responsavel);
        }
    }

    private void createFuncaoPerfil(List<String> funCodigo, String perCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if ((funCodigo != null) && (funCodigo.size() > 0)) {
                for (final String funcao : funCodigo) {
                    if (CodedValues.FUNCOES_NAO_PERMITIDAS_PERFIL.contains(funcao)) {
                        throw new UsuarioControllerException("mensagem.erro.nao.permitida.associacao.funcao.arg0.perfil", responsavel, funcao);
                    }
                    FuncaoPerfilHome.create(funcao, perCodigo);
                }

                final LogDelegate log = new LogDelegate(responsavel, Log.FUNCAO_PERFIL, Log.CREATE, Log.LOG_INFORMACAO);
                log.setPerfil(perCodigo);
                for (final String funcao : funCodigo) {
                    log.setFuncao(funcao);
                    log.write();
                }
            }
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.associar.funcao.perfil.erro.interno.arg0", responsavel, ex.getMessage());
        }
    }

    @Override
    public CustomTransferObject getFuncao(String funCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemFuncaoQuery funQuery = new ObtemFuncaoQuery();
            funQuery.funCodigo = funCodigo;

            final List<TransferObject> lstFuncao = funQuery.executarDTO();
            if (!lstFuncao.isEmpty()) {
                return (CustomTransferObject) lstFuncao.get(0);
            }
            return null;
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public List<String> getFuncaoPerfil(String tipoEntidade, String codigoEntidade, String perCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaFuncoesPerfilQuery funPerQuery = new ListaFuncoesPerfilQuery();
            funPerQuery.perCodigo = perCodigo;
            funPerQuery.papCodigoDestino = UsuarioHelper.getPapCodigo(tipoEntidade);
            funPerQuery.papCodigoOrigem = UsuarioHelper.getPapCodigo(responsavel.getTipoEntidade());
            return funPerQuery.executarLista();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public List<TransferObject> lstPerfil(String tipoEntidade, String codigoEntidade, CustomTransferObject filtro, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaPerfilTipoEntidadeQuery lstPerTipoEntQuery = new ListaPerfilTipoEntidadeQuery();
            lstPerTipoEntQuery.tipoEntidade = tipoEntidade;
            lstPerTipoEntQuery.codigoEntidade = codigoEntidade;
            lstPerTipoEntQuery.pceAtivo = (Short) filtro.getAttribute(Columns.PCE_ATIVO);
            lstPerTipoEntQuery.pcaAtivo = (Short) filtro.getAttribute(Columns.PCA_ATIVO);
            lstPerTipoEntQuery.pcoAtivo = (Short) filtro.getAttribute(Columns.PCO_ATIVO);
            lstPerTipoEntQuery.porAtivo = (Short) filtro.getAttribute(Columns.POR_ATIVO);
            lstPerTipoEntQuery.psuAtivo = (Short) filtro.getAttribute(Columns.PSU_ATIVO);
            lstPerTipoEntQuery.perDescricao = (String) filtro.getAttribute(Columns.PER_DESCRICAO);
            lstPerTipoEntQuery.responsavel = responsavel;

            return lstPerTipoEntQuery.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public List<TransferObject> lstPerfilSemBloqueioRepasse(String tipoEntidade, String codigoEntidade, String usuCodigoEdt, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaPerfilSemBloqueioRepasseQuery perSemBloqRepQuery = new ListaPerfilSemBloqueioRepasseQuery();
            perSemBloqRepQuery.tipoEntidade = tipoEntidade;
            perSemBloqRepQuery.papCodigoDestino = UsuarioHelper.getPapCodigo(tipoEntidade);
            perSemBloqRepQuery.papCodigoOrigem = UsuarioHelper.getPapCodigo(responsavel.getTipoEntidade());
            perSemBloqRepQuery.usuCodigoEdt = usuCodigoEdt;
            perSemBloqRepQuery.codigoEntidade = codigoEntidade;
            perSemBloqRepQuery.responsavel = responsavel;

            return perSemBloqRepQuery.executarDTO();
        } catch (final HQueryException hex) {
            LOG.error(hex.getMessage(), hex);
            throw new UsuarioControllerException(hex);
        }
    }

    @Override
    public Short getStatusPerfil(String tipoEntidade, String codigoEntidade, String perCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final String papCodigo = UsuarioHelper.getPapCodigo(tipoEntidade);

            // Remove a associação do perfil com a entidade criadora
            if (CodedValues.PAP_CONSIGNANTE.equals(papCodigo)) { // CSE
                final PerfilCse pceBean = PerfilCseHome.findByPrimaryKey(new PerfilCseId(codigoEntidade, perCodigo));
                return pceBean.getPceAtivo();
            } else if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigo)) { // CSA
                final PerfilCsa pcaBean = PerfilCsaHome.findByPrimaryKey(new PerfilCsaId(codigoEntidade, perCodigo));
                return pcaBean.getPcaAtivo();
            } else if (CodedValues.PAP_ORGAO.equals(papCodigo)) { // ORG
                final PerfilOrg porBean = PerfilOrgHome.findByPrimaryKey(new PerfilOrgId(codigoEntidade, perCodigo));
                return porBean.getPorAtivo();
            } else if (CodedValues.PAP_CORRESPONDENTE.equals(papCodigo)) { // COR
                final PerfilCor pcoBean = PerfilCorHome.findByPrimaryKey(new PerfilCorId(codigoEntidade, perCodigo));
                return pcoBean.getPcoAtivo();
            } else if (CodedValues.PAP_SUPORTE.equals(papCodigo)) { // SUP
                final PerfilSup psuBean = PerfilSupHome.findByPrimaryKey(new PerfilSupId(codigoEntidade, perCodigo));
                return psuBean.getPsuAtivo();
            } else if (CodedValues.PAP_SERVIDOR.equals(papCodigo)) { // SER
                return CodedValues.STS_ATIVO; // PerfilSer não existe, portanto considera o perfil ativo
            } else {
                throw new UsuarioControllerException("mensagem.erro.arg0.tipo.entidade.invalido", responsavel, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
            }
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, ex, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
        }
    }

    /**
     * Verifica se o usuário tem permissão para executar a função identificada pelo funCodigo.
     * ATENÇÃO: Não utilizar este método, a não ser que seja necessário verificar se um terceiro
     * usuário tenha permissão para realizar uma operação. Caso seja para verificar sobre o próprio
     * usuário, utilize a função AcessoSistema.temPermissao()
     * @param usuCodigo : código do usuário
     * @param funCodigo : código da função
     * @param tipoEntidade : CSE, CSA, ORG, COR ou SER, null para todos
     * @param responsavel : responsável pela verificaçãp
     * @return True se o usuário tem a permissão, falso caso contrário
     * @throws UsuarioControllerException
     */
    @Override
    public boolean usuarioTemPermissao(String usuCodigo, String funCodigo, String tipoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            // Grava Log de Acesso
            final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.FIND, Log.LOG_INFORMACAO);
            log.setUsuario(usuCodigo);
            log.setFuncao(funCodigo);
            log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.verificando.se.usuario.tem.permissao.para.funcao", responsavel));
            log.write();
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
        }

        // Faz a busca pelo perfil do usuário
        try {
            // busca as funções do perfil
            final PerfilUsuario upeBean = PerfilUsuarioHome.findByPrimaryKey(usuCodigo);
            final FuncaoPerfilId pk = new FuncaoPerfilId(funCodigo, upeBean.getPerfil().getPerCodigo());
            FuncaoPerfilHome.findByPrimaryKey(pk);
            LOG.debug("Usuario Com Perfil Com Permissão Para " + funCodigo + ".");
            return true;

        } catch (final FindException ex) {
            // Busca as funções p/ perfil personalizado

            if ((tipoEntidade == null) || AcessoSistema.ENTIDADE_COR.equalsIgnoreCase(tipoEntidade)) {
                try {
                    final List<FuncaoPerfilCor> perfil = FuncaoPerfilCorHome.findByUsuFunCodigo(usuCodigo, funCodigo);
                    if ((perfil != null) && (perfil.size() > 0)) {
                        return true;
                    }
                } catch (final FindException e) {
                    LOG.error(e.getMessage(), e);
                    throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, e, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
                }
            }

            if ((tipoEntidade == null) || AcessoSistema.ENTIDADE_CSA.equalsIgnoreCase(tipoEntidade)) {
                try {
                    final List<FuncaoPerfilCsa> perfil = FuncaoPerfilCsaHome.findByUsuFunCodigo(usuCodigo, funCodigo);
                    if ((perfil != null) && (perfil.size() > 0)) {
                        return true;
                    }
                } catch (final FindException e) {
                    LOG.error(e.getMessage(), e);
                    throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, e, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
                }
            }

            if ((tipoEntidade == null) || AcessoSistema.ENTIDADE_ORG.equalsIgnoreCase(tipoEntidade)) {
                try {
                    final List<FuncaoPerfilOrg> perfil = FuncaoPerfilOrgHome.findByUsuFunCodigo(usuCodigo, funCodigo);
                    if ((perfil != null) && (perfil.size() > 0)) {
                        return true;
                    }
                } catch (final FindException e) {
                    LOG.error(e.getMessage(), e);
                    throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, e, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
                }
            }

            if ((tipoEntidade == null) || AcessoSistema.ENTIDADE_CSE.equalsIgnoreCase(tipoEntidade)) {
                try {
                    final List<FuncaoPerfilCse> perfil = FuncaoPerfilCseHome.findByUsuFunCodigo(usuCodigo, funCodigo);
                    if ((perfil != null) && (perfil.size() > 0)) {
                        return true;
                    }
                } catch (final FindException e) {
                    LOG.error(e.getMessage(), e);
                    throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, e, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
                }
            }

            if ((tipoEntidade == null) || AcessoSistema.ENTIDADE_SUP.equalsIgnoreCase(tipoEntidade)) {
                try {
                    final List<FuncaoPerfilSup> perfil = FuncaoPerfilSupHome.findByUsuFunCodigo(usuCodigo, funCodigo);
                    if ((perfil != null) && (perfil.size() > 0)) {
                        return true;
                    }
                } catch (final FindException e) {
                    LOG.error(e.getMessage(), e);
                    throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, e, ApplicationResourcesHelper.getMessage(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel) + " ");
                }
            }
        }

        return false;
    }

    /**
     * Verifica se um usuário tem permissão de realizar operações no usuário
     * informada pelo parâmetro "usuCodigo",  de acordo com sua entidade.
     * @param usuCodigo : usuário que está sendo afetado
     * @param gravaLog : determina se será gravado log de erro, caso não tenha permissão
     * @param lancaExcecao : determina se será lançado uma exceção, caso não tenha permissão
     * @param responsavel : responsável pela operação de modificação do usuário
     * @return boolean
     * @throws AutorizacaoControllerException
     */
    private boolean usuarioPodeModificarUsu(String usuCodigo, boolean gravaLog, boolean lancaExcecao, AcessoSistema responsavel) throws UsuarioControllerException {
        final boolean podeModificar = entidadeUsuarioPodeModificarUsu(usuCodigo, responsavel);
        if (!podeModificar) {
            if (gravaLog) {
                try {
                    // Grava log de Erro
                    final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.UPDATE, Log.LOG_ERRO_SEGURANCA);
                    log.setUsuario(usuCodigo);
                    log.add(ApplicationResourcesHelper.getMessage("rotulo.erro.upper.arg0", responsavel, ApplicationResourcesHelper.getMessage("mensagem.erro.usuario.nao.tem.permissao.para.modificar.este.usuario", responsavel)));
                    log.write();
                } catch (final LogControllerException ex) {
                    LOG.error(ex.getMessage(), ex);
                    throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
                }
            }

            if (lancaExcecao) {
                throw new UsuarioControllerException("mensagem.erro.usuario.nao.tem.permissao.para.modificar.este.usuario", responsavel);
            } else {
                return false;
            }
        }
        return true;
    }

    /**
     * Retorna TRUE se o usuário, representado pelo parâmetro "responsavel", pertence a uma
     * entidade, seja CSE/ORG/SUP/CSA/COR/SER, que tenha permissão de realizar operações
     * sobre o usuário, representada pelo parâmetro "usuCodigo".
     * @param usuCodigo String
     * @param responsavel AcessoSistema
     * @return
     * @throws UsuarioControllerException
     */
    private boolean entidadeUsuarioPodeModificarUsu(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            boolean podeModificar = false;

            // DESENV-10480: correção da DESENV-9892 para sempre retornar true se houver o parâmetro de sistema de autodesbloqueio e for a respectiva ação do tipo de usuário correspondente
            if (responsavel.getUsuCodigo().equals(usuCodigo) && (
                    (ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_USUARIO_CSE_ORG, CodedValues.TPC_SIM, AcessoSistema.getAcessoUsuarioSistema()) && !TextHelper.isNull(responsavel.getFunCodigo()) && CodedValues.FUN_AUTODESBLOQUEIO_CSE_ORG.equals(responsavel.getFunCodigo())) ||
                    (ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_USUARIO_CSA, CodedValues.TPC_SIM, AcessoSistema.getAcessoUsuarioSistema()) && !TextHelper.isNull(responsavel.getFunCodigo()) && CodedValues.FUN_AUTODESBLOQUEIO_CSA_COR.equals(responsavel.getFunCodigo())) ||
                    (ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_USUARIO_COR, CodedValues.TPC_SIM, AcessoSistema.getAcessoUsuarioSistema()) && !TextHelper.isNull(responsavel.getFunCodigo()) && CodedValues.FUN_AUTODESBLOQUEIO_CSA_COR.equals(responsavel.getFunCodigo())) ||
                    (ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_USUARIO_SUP, CodedValues.TPC_SIM, AcessoSistema.getAcessoUsuarioSistema()) && !TextHelper.isNull(responsavel.getFunCodigo()) && CodedValues.FUN_AUTODESBLOQUEIO_SUP.equals(responsavel.getFunCodigo())))) {

                return true;
            } else if (!TextHelper.isNull(responsavel.getFunCodigo()) && (
                    CodedValues.FUN_AUTODESBLOQUEIO_CSE_ORG.equals(responsavel.getFunCodigo()) ||
                    CodedValues.FUN_AUTODESBLOQUEIO_CSA_COR.equals(responsavel.getFunCodigo()) ||
                    CodedValues.FUN_AUTODESBLOQUEIO_SUP.equals(responsavel.getFunCodigo()))) {
                // é ação de desbloqueio, porém não tem o respectivo parâmetro de sistema como S.
                return false;
            }

            if (responsavel.isSistema() || responsavel.isSup()) {
                // O sistema e usuários de suporte, podem modificar quaisquer usuários
                podeModificar = true;

            } else if (responsavel.isCse()) {
                // Usuário de gestor pode modificar quaisquer usuários exceto os de suporte
                final UsuarioCsePodeModificarUsuQuery query = new UsuarioCsePodeModificarUsuQuery();
                query.usuCodigoAfetado = usuCodigo;
                final List<?> result = query.executarLista();
                podeModificar = (result != null) && (result.size() > 0);

            } else if (responsavel.isOrg() && responsavel.temPermissao(CodedValues.FUN_ACE_CONSIG_ESTABELECIMENTO)) {
                // Usuário de "estabelecimento" pode modificar apenas usuários do próprio órgão, usuários servidores
                // dos órgãos do mesmo estabelecimento e usuários de consignatárias
                final UsuarioEstPodeModificarUsuQuery query = new UsuarioEstPodeModificarUsuQuery();
                query.usuCodigoAfetado = usuCodigo;
                query.usuCodigoResponsavel = responsavel.getUsuCodigo();
                final List<?> result = query.executarLista();
                podeModificar = (result != null) && (result.size() > 0);

            } else if (responsavel.isOrg() && !responsavel.temPermissao(CodedValues.FUN_ACE_CONSIG_ESTABELECIMENTO)) {
                // Usuário de órgão pode modificar apenas usuários do próprio órgão, usuários servidores
                // do próprio órgão e usuários de consignatárias
                final UsuarioOrgPodeModificarUsuQuery query = new UsuarioOrgPodeModificarUsuQuery();
                query.usuCodigoAfetado = usuCodigo;
                query.usuCodigoResponsavel = responsavel.getUsuCodigo();
                final List<?> result = query.executarLista();
                podeModificar = (result != null) && (result.size() > 0);

            } else if (responsavel.isCsa()) {
                // Usuário de consignatária pode modificar usuários da próprio consignatária e de seus correspondentes
                final UsuarioCsaPodeModificarUsuQuery query = new UsuarioCsaPodeModificarUsuQuery();
                query.usuCodigoAfetado = usuCodigo;
                query.usuCodigoResponsavel = responsavel.getUsuCodigo();
                final List<?> result = query.executarLista();
                podeModificar = (result != null) && (result.size() > 0);

            } else if (responsavel.isCor()) {
                // Usuário de correspondente pode modificar apenas usuários do próprio correspondente
                final UsuarioCorPodeModificarUsuQuery query = new UsuarioCorPodeModificarUsuQuery();
                query.usuCodigoAfetado = usuCodigo;
                query.usuCodigoResponsavel = responsavel.getUsuCodigo();
                final List<?> result = query.executarLista();
                podeModificar = (result != null) && (result.size() > 0);

            } else if (responsavel.isSer()) {
                if (ParamSist.paramEquals(CodedValues.TPC_ALTERA_SENHA_TODOS_LOGINS_SERVIDOR, CodedValues.TPC_SIM, responsavel) ||
                        (ParamSist.paramEquals(CodedValues.TPC_RECUPERACAO_SENHA_USU_SERVIDOR_CPF, CodedValues.TPC_SIM, responsavel))) {
                    final Usuario usuarioSer = UsuarioHome.findByPrimaryKey(usuCodigo);
                    final Servidor responsavelServidor = ServidorHome.findByUsuCodigo(responsavel.getUsuCodigo());

                    // Usuário servidor pode modificar outros usuários servidores com o mesmo cpf
                    podeModificar = responsavelServidor.getSerCpf().equals(usuarioSer.getUsuCpf());
                } else {
                    // Usuário servidor pode modificar apenas seu próprio usuário
                    podeModificar = responsavel.getUsuCodigo().equals(usuCodigo);
                }
            }

            return podeModificar;
        } catch (HQueryException | FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /**
     * Verifica se um usuário tem permissão de realizar operações no perfil
     * informada pelo parâmetro "perCodigo",  de acordo com sua entidade.
     * @param perCodigo : perfil que está sendo afetado
     * @param gravaLog : determina se será gravado log de erro, caso não tenha permissão
     * @param lancaExcecao : determina se será lançado uma exceção, caso não tenha permissão
     * @param responsavel : responsável pela operação de modificação do perfil
     * @return boolean
     * @throws AutorizacaoControllerException
     */
    private boolean usuarioPodeModificarPerfil(String perCodigo, boolean gravaLog, boolean lancaExcecao, AcessoSistema responsavel) throws UsuarioControllerException {
        final boolean podeModificar = entidadeUsuarioPodeModificarPerfil(perCodigo, responsavel);
        if (!podeModificar) {
            if (gravaLog) {
                try {
                    // Grava log de Erro
                    final LogDelegate log = new LogDelegate(responsavel, Log.PERFIL, Log.UPDATE, Log.LOG_ERRO_SEGURANCA);
                    log.setPerfil(perCodigo);
                    log.add(ApplicationResourcesHelper.getMessage("rotulo.erro.upper.arg0", responsavel, ApplicationResourcesHelper.getMessage("mensagem.erro.usuario.nao.tem.permissao.para.modificar.este.perfil", responsavel)));
                    log.write();
                } catch (final LogControllerException ex) {
                    LOG.error(ex.getMessage(), ex);
                    throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
                }
            }

            if (lancaExcecao) {
                throw new UsuarioControllerException("mensagem.erro.usuario.nao.tem.permissao.para.modificar.este.perfil", responsavel);
            } else {
                return false;
            }
        }
        return true;
    }

    /**
     * Retorna TRUE se o usuário, representado pelo parâmetro "responsavel", pertence a uma
     * entidade, seja CSE/ORG/SUP/CSA/COR/SER, que tenha permissão de realizar operações
     * sobre o perfil, representada pelo parâmetro "perCodigo".
     * @param usuCodigo String
     * @param responsavel AcessoSistema
     * @return
     * @throws UsuarioControllerException
     */
    private boolean entidadeUsuarioPodeModificarPerfil(String perCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            boolean podeModificar = false;

            if (responsavel.isSistema() || responsavel.isCse() || responsavel.isSup()) {
                // O sistema, usuários de gestor ou suporte, podem modificar quaisquer usuários
                podeModificar = true;

            } else if (responsavel.isOrg()) {
                // Usuário de órgão pode modificar apenas perfil do próprio órgão e perfil de consignatárias
                final UsuarioOrgPodeModificarPerfilQuery query = new UsuarioOrgPodeModificarPerfilQuery();
                query.perCodigoAfetado = perCodigo;
                query.usuCodigoResponsavel = responsavel.getUsuCodigo();
                final List<?> result = query.executarLista();
                podeModificar = (result != null) && (result.size() > 0);

            } else if (responsavel.isCsa()) {
                // Usuário de consignatária pode modificar usuários da próprio consignatária e de seus correspondentes
                final UsuarioCsaPodeModificarPerfilQuery query = new UsuarioCsaPodeModificarPerfilQuery();
                query.perCodigoAfetado = perCodigo;
                query.usuCodigoResponsavel = responsavel.getUsuCodigo();
                final List<?> result = query.executarLista();
                podeModificar = (result != null) && (result.size() > 0);

            } else if (responsavel.isCor()) {
                // Usuário de correspondente pode modificar apenas usuários do próprio correspondente
                final UsuarioCorPodeModificarPerfilQuery query = new UsuarioCorPodeModificarPerfilQuery();
                query.perCodigoAfetado = perCodigo;
                query.usuCodigoResponsavel = responsavel.getUsuCodigo();
                final List<?> result = query.executarLista();
                podeModificar = (result != null) && (result.size() > 0);

            } else if (responsavel.isSer()) {
                // Usuário servidor não pode modificar nenhum perfil
                podeModificar = false;
            }

            return podeModificar;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /** SENHA DE SERVIDOR ------------------------------------------------------------------------------------- **/

    @Override
    public TransferObject getSenhaServidor(String rseCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemSenhaServidorQuery query = new ObtemSenhaServidorQuery();
            query.rseCodigo = rseCodigo;

            final List<TransferObject> usuarios = query.executarDTO();

            if (usuarios.size() == 0) {
                return null;
            }
            return usuarios.get(0);
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /** OCORRÊNCIA DE USUÁRIO --------------------------------------------------------------------------------- **/

    @Override
    public String createOcorrenciaUsuario(CustomTransferObject ocorrencia, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final OcorrenciaUsuario ocoUsuarioBean = OcorrenciaUsuarioHome.create(ocorrencia.getAttribute(Columns.OUS_TOC_CODIGO).toString(), (String) ocorrencia.getAttribute(Columns.OUS_USU_CODIGO), DateHelper.getSystemDatetime(), (String) ocorrencia.getAttribute(Columns.OUS_OBS), (String) ocorrencia.getAttribute(Columns.OUS_OUS_USU_CODIGO), (String) ocorrencia.getAttribute(Columns.OUS_IP_ACESSO), (String) ocorrencia.getAttribute(Columns.OUS_TMO_CODIGO));

            return ocoUsuarioBean.getOusCodigo();

        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.criar.ocorrencia.para.este.usuario.erro.interno.arg0", responsavel, ex.getMessage());
        }
    }

    @Override
    public List<TransferObject> lstOcorrenciaUsuario(CustomTransferObject filtro, int offset, int count, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaOcorrenciaUsuarioQuery query = new ListaOcorrenciaUsuarioQuery();
            if (offset != -1) {
                query.firstResult = offset;
            }
            if (count != -1) {
                query.maxResults = count;
            }
            if (filtro != null) {
                query.ousUsuCodigo = (String) filtro.getAttribute(Columns.OUS_USU_CODIGO);
                query.tocCodigos = (List<String>) filtro.getAttribute("tocCodigos");
            }
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public int countOcorrenciaUsuario(CustomTransferObject filtro, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaOcorrenciaUsuarioQuery query = new ListaOcorrenciaUsuarioQuery();
            query.count = true;
            if (filtro != null) {
                query.ousUsuCodigo = (String) filtro.getAttribute(Columns.OUS_USU_CODIGO);
                query.tocCodigos = (List<String>) filtro.getAttribute("tocCodigos");
            }
            return query.executarContador();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /**
     * Verifica se um usuário é usuário de órgão
     * @param usuCodigo : código do usuário
     * @return O código do órgão, caso o usuário seja de órgão, ou nulo caso contrário
     * @throws UsuarioControllerException
     */
    @Override
    public String isOrg(String usuCodigo) throws UsuarioControllerException {
        try {
            final UsuarioOrg usuBean = UsuarioOrgHome.findByUsuCodigo(usuCodigo);
            return usuBean.getOrgao().getOrgCodigo();
        } catch (final FindException ex) {
            LOG.error(ex.getMessage());
            return null;
        }
    }

    /**
     * Cadastra chave para validação TOTP e associa ao usuário responsável
     * @param usuChaveValidacaoTotp
     * @param operacoesValidacaoTotp
     * @param permiteValidacaoTotp
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public String cadastrarChaveValidacaoTotp(String usuChaveValidacaoTotp, OperacaoValidacaoTotpEnum operacoesValidacaoTotp, PermiteValidacaoTotpEnum permiteValidacaoTotp, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if (permiteValidacaoTotp == null || permiteValidacaoTotp.equals(PermiteValidacaoTotpEnum.DESABILITADO)) {
                throw new UsuarioControllerException("mensagem.usoIncorretoSistema", responsavel);
            }

            final UsuarioTransferObject usuario = findUsuario(new UsuarioTransferObject(responsavel.getUsuCodigo()), AcessoSistema.ENTIDADE_USU, responsavel);
            usuario.setUsuChaveValidacaoTotp(usuChaveValidacaoTotp);
            usuario.setUsuOperacoesValidacaoTotp(operacoesValidacaoTotp.getCodigo());
            usuario.setUsuPermiteValidacaoTotp(permiteValidacaoTotp.getCodigo());

            if (permiteValidacaoTotp.equals(PermiteValidacaoTotpEnum.EMAIL) || permiteValidacaoTotp.equals(PermiteValidacaoTotpEnum.SMS)) {
                // Apaga o OTP usado para cadastrar a chave
                usuario.setUsuOtpCodigo(null);
                usuario.setUsuOtpDataCadastro(null);
            }
            
            updateUsuario(usuario, null, responsavel);

            final LogDelegate logDelegate = new LogDelegate(responsavel, Log.USUARIO, Log.UPDATE, Log.LOG_INFORMACAO);
            logDelegate.setUsuario(responsavel.getUsuCodigo());
            logDelegate.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.cadastro.chave.validacao.totp", responsavel));
            logDelegate.write();

            return usuChaveValidacaoTotp;
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    /**
     * Gera chave para validação TOTP e associa ao usuário responsável
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public void removerChaveValidacaoTotp(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final UsuarioTransferObject usuario = findUsuario(new UsuarioTransferObject(responsavel.getUsuCodigo()), AcessoSistema.ENTIDADE_USU, responsavel);
            final PermiteValidacaoTotpEnum permiteValidacaoTotp = Optional.ofNullable(PermiteValidacaoTotpEnum.get(usuario.getUsuPermiteValidacaoTotp())).orElse(PermiteValidacaoTotpEnum.DESABILITADO);
            if (permiteValidacaoTotp.equals(PermiteValidacaoTotpEnum.DESABILITADO)) {
                throw new UsuarioControllerException("mensagem.usoIncorretoSistema", responsavel);
            }

            usuario.setUsuChaveValidacaoTotp(null);
            usuario.setUsuPermiteValidacaoTotp(PermiteValidacaoTotpEnum.DESABILITADO.getCodigo());

            if (permiteValidacaoTotp.equals(PermiteValidacaoTotpEnum.EMAIL) || permiteValidacaoTotp.equals(PermiteValidacaoTotpEnum.SMS)) {
                // Apaga o OTP usado para cadastrar a chave
                usuario.setUsuOtpCodigo(null);
                usuario.setUsuOtpDataCadastro(null);
            }

            updateUsuario(usuario, null, responsavel);

            final LogDelegate logDelegate = new LogDelegate(responsavel, Log.USUARIO, Log.UPDATE, Log.LOG_INFORMACAO);
            logDelegate.setUsuario(responsavel.getUsuCodigo());
            logDelegate.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.remocao.chave.validacao.totp", responsavel));
            logDelegate.write();

        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public void alterarSenha(String usuCodigo, String senhaNova, String dicaSenha, boolean expiracaoImediata, boolean reiniciacao, boolean senhaCriptografada, String senhaAtualAberta, AcessoSistema responsavel) throws UsuarioControllerException {
        alterarSenha(usuCodigo, senhaNova, dicaSenha, expiracaoImediata, reiniciacao, senhaCriptografada, null, senhaAtualAberta, responsavel);
    }

    /**
     * Altera a senha do usuário.
     * @param usuCodigo
     * @param senhaNova
     * @param dicaSenha
     * @param responsavel
     * @param expiracaoImediata Indica se a senha deve expirar imediatamente,
     *        ou se o prazo de validade deve ser determinado pelo parâmetro de sistema.
     * @param reiniciacao Indica se a alteração é por motivo de reiniciação de senha.
     * @param tipoMotivoOperacao Indo o motivo da operação que será gravado junto com a ocorrência
     * @throws UsuarioControllerException
     */
    @Override
    public void alterarSenha(String usuCodigo, String senhaNova, String dicaSenha, boolean expiracaoImediata, boolean reiniciacao, boolean senhaCriptografada, CustomTransferObject tipoMotivoOperacao, String senhaAtualAberta, AcessoSistema responsavel) throws UsuarioControllerException {
        this.alterarSenha(usuCodigo, senhaNova, null, dicaSenha, expiracaoImediata, reiniciacao, false, senhaCriptografada, null, tipoMotivoOperacao, false, false, senhaAtualAberta, responsavel);
    }

    /**
     * Altera a senha do usuário.
     * @param usuCodigo : Código do usuário.
     * @param senhaNova : Nova senha (O flag senhaCriptografada determina se está ou não criptografada).
     * @param senhaUtilizada : Senha utilizada e que será removida. (O flag senhaCriptografada determina se está ou não criptografada).
     * @param dicaSenha : Dica da senha, se houver.
     * @param expiracaoImediata : Indica se a senha expira imediatamente.
     * @param reiniciacao : Indica se trata-se de reiniciação.
     * @param senhaAutorizacaoServidor : Informa se a senha sendo alterada é a de autorização do servidor.
     * @param senhaCriptografada : especifica se a senha passada pelo param 'senhaNova' já está criptografada ou não.
     * @param tocCodigo : Tipo de ocorrência ser gravada.
     * @param tipoMotivoOperacao : Dados do motivo da operação.
     * @param responsavel : Responsável.
     * @throws UsuarioControllerException
     */
    private void alterarSenha(String usuCodigo, String senhaNova, String senhaUtilizada, String dicaSenha, boolean expiracaoImediata, boolean reiniciacao, boolean senhaAutorizacaoServidor, boolean senhaCriptografada, String tocCodigo, CustomTransferObject tipoMotivoOperacao, AcessoSistema responsavel) throws UsuarioControllerException {
        this.alterarSenha(usuCodigo, senhaNova, senhaUtilizada, dicaSenha, expiracaoImediata, reiniciacao, senhaAutorizacaoServidor, senhaCriptografada, tocCodigo, tipoMotivoOperacao, false, false, null, responsavel);
    }

    /**
     * Altera a senha do usuário, seja por uma alteração manual, reinicialização,
     * consumo ou cancelamento de senha de autorização.
     * @param usuCodigo : Código do usuário.
     * @param senhaNova : Nova senha (O flag senhaCriptografada determina se está ou não criptografada).
     * @param senhaUtilizada : Senha utilizada e que será removida. (O flag senhaCriptografada determina se está ou não criptografada).
     * @param dicaSenha : Dica da senha, se houver.
     * @param expiracaoImediata : Indica se a senha expira imediatamente.
     * @param reiniciacao : Indica se trata-se de reiniciação.
     * @param senhaAutorizacaoServidor : Informa se a senha sendo alterada é a de autorização do servidor.
     * @param senhaCriptografada : especifica se a senha passada pelo param 'senhaNova' já está criptografada ou não.
     * @param tocCodigo : Tipo de ocorrência ser gravada.
     * @param tipoMotivoOperacao : Dados do motivo da operação.
     * @param naoComunicarServidor : Não enviar email para o servidor com a nova senha
     * @param senhaAtualAberta : Senha atual do usuário aberta para ser validada antes da alteração da senha atual.
     * @param responsavel : Responsável.
     * @throws UsuarioControllerException
     */
    private void alterarSenha(String usuCodigo, String senhaNova, String senhaUtilizada, String dicaSenha, boolean expiracaoImediata, boolean reiniciacao, boolean senhaAutorizacaoServidor, boolean senhaCriptografada, String tocCodigo, CustomTransferObject tipoMotivoOperacao, boolean naoComunicarServidor, boolean senhaApp, String senhaAtualAberta, AcessoSistema responsavel) throws UsuarioControllerException {
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        boolean usuarioSer = false;

        try {
            // Tenta buscar por um usuario servidor.
            usuario = this.findUsuario(usuario, AcessoSistema.ENTIDADE_SER, responsavel);
            usuarioSer = true;
        } catch (final UsuarioControllerException ex) {
            if (senhaAutorizacaoServidor) {
                throw new UsuarioControllerException("mensagem.erro.usuario.nao.servidor", responsavel);
            }

            // Se não foi possível localizar um usuário servidor, trata-se de outro tipo de usuário.
            usuario = this.findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);
            usuarioSer = false;
        }

        // Se autenticação foi realizada pelo SSO e o usuário está alterando a sua própria senha, alteração de senha deve ser no SSO também
        final boolean autenticacaoSSO = UsuarioHelper.usuarioAutenticaSso(findTipoUsuarioByCodigo(usuCodigo, responsavel), responsavel);

        // Se é usuário servidor e utiliza senha de autorização, verifica se o parâmetro de múltiplas senhas
        // está habilitado, pois neste caso as senhas estarão armazenadas na tabela tb_senha_autorizacao_servidor,
        // e não na tb_usuario.usu_senha_2.
        final boolean usaMultiplasSenhasAut = usuarioSer && senhaAutorizacaoServidor && ParamSist.paramEquals(CodedValues.TPC_USA_MULTIPLAS_SENHAS_AUTORIZACAO_SERVIDOR, CodedValues.TPC_SIM, responsavel);

        if (!senhaAutorizacaoServidor && !reiniciacao) {
            SenhaHelper.validarForcaSenha(senhaNova, usuarioSer, responsavel);
        }

        // Criptografa a nova senha para armazenamento no banco.
        String senhaNovaCrypt = null;
        if (senhaNova != null) {
            if (!senhaCriptografada) {
                senhaNovaCrypt = SenhaHelper.criptografarSenha(usuario.getUsuLogin(), senhaNova, usuarioSer, responsavel);
            } else {
                senhaNovaCrypt = senhaNova;
            }
        }
        // Criptografa a senha utilizada para ser cancelada/consumida. Para SaltedMD5, a senha deve chegar aqui criptografada
        String senhaUtilizadaCrypt = null;
        if (usaMultiplasSenhasAut && (senhaUtilizada != null)) {
            if (!senhaCriptografada) {
                senhaUtilizadaCrypt = SenhaHelper.criptografarSenha(usuario.getUsuLogin(), senhaUtilizada, usuarioSer, responsavel);
            } else {
                senhaUtilizadaCrypt = senhaUtilizada;
            }
        }

        if (!reiniciacao) {
            // O padrão é não permitir senhas de consulta e autorização iguais.
            if (usuarioSer && (senhaNovaCrypt != null) && !ParamSist.paramEquals(CodedValues.TPC_PERMITE_SENHAS_SERVIDOR_IGUAIS, CodedValues.TPC_SIM, responsavel)) {
                if (senhaAutorizacaoServidor) {
                    // Se está alterando a senha de autorização, testa o valor da senha de consulta.
                    if (JCrypt.verificaSenha(senhaNova, usuario.getUsuSenha())) {
                        throw new UsuarioControllerException("mensagem.erro.senha.servidor.autorizacao.deve.ser.diferente.de.senha.servidor.consulta", responsavel);
                    }
                } else // Se não está alterando a senha de autorização, verifica se o sistema trabalha com ela. Caso positivo, compara seu valor.
                if (ParamSist.paramEquals(CodedValues.TPC_USA_SENHA_AUTORIZACAO_DESC_SERVIDOR, CodedValues.TPC_SIM, responsavel) && JCrypt.verificaSenha(senhaNova, usuario.getUsuSenha2())) {
                    throw new UsuarioControllerException("mensagem.erro.senha.servidor.autorizacao.deve.ser.diferente.de.senha.servidor.consulta", responsavel);
                }
            }

            // Verifica a senha com relação às anteriores
            validaSenhasAnteriores(usuCodigo, senhaNova, senhaNovaCrypt, senhaAutorizacaoServidor, responsavel);
        }

        try {
            // Calcula a data de expiração da senha.
            Calendar dataExpiracaoSenhaCalc = null;
            if (senhaNova != null) {
                if (!expiracaoImediata) {
                    dataExpiracaoSenhaCalc = calculaDataExpiracaoSenha(senhaAutorizacaoServidor, usuario, usuarioSer, responsavel);
                } else {
                    dataExpiracaoSenhaCalc = Calendar.getInstance();
                }
            }
            // Recupera a data de expiração apenas com a parte da data (SQL Date)
            final java.sql.Date dataExpiracaoSenha = dataExpiracaoSenhaCalc != null ? new java.sql.Date(dataExpiracaoSenhaCalc.getTimeInMillis()) : null;

            // Salva a alteração de senha.
            if (!reiniciacao && (dicaSenha != null) && !senhaAutorizacaoServidor) {
                usuario.setUsuDicaSenha(dicaSenha);
            }

            if (!senhaAutorizacaoServidor) {
                if (senhaNovaCrypt != null) {
                    if (senhaApp) {
                        usuario.setUsuSenhaApp(senhaNovaCrypt);
                    } else {
                        usuario.setUsuSenha(senhaNovaCrypt);
                    }
                } else {
                    usuario.setUsuSenha(CodedValues.USU_SENHA_SERVIDOR_CANCELADA);
                }
                if (senhaApp) {
                    usuario.setUsuDataExpSenhaApp(dataExpiracaoSenha);
                } else {
                    usuario.setUsuDataExpSenha(dataExpiracaoSenha);
                }

            } else {
                // Se nova senha de autorização foi definida, verifica o parâmetro com a quantidade
                // de operações permitidas para a nova senha 2: Default 1 (uma operação).
                final String paramQtdOperacoes = (String) ParamSist.getInstance().getParam(CodedValues.TPC_QTD_OPERACOES_VALIDADE_SENHA_AUTORIZACAO, responsavel);
                final Short qtdOperacoes = !TextHelper.isNull(paramQtdOperacoes) ? Short.valueOf(paramQtdOperacoes) : Short.valueOf("1");

                // Se usa múltiplas senhas, grava a nova na tabela apropriada
                if (usaMultiplasSenhasAut) {
                    if (senhaNovaCrypt != null) {
                        // Gerando senha múltipla de autorização
                        try {
                            SenhaAutorizacaoServidorHome.create(usuCodigo, senhaNovaCrypt, dataExpiracaoSenha, qtdOperacoes);
                        } catch (final CreateException ex) {
                            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                            throw new UsuarioControllerException("mensagem.erro.interno.criacao.nova.senha.autorizacao.usuario", responsavel, ex);
                        }
                    } else {
                        // Cancelando/Consumindo senha múltipla de autorização
                        try {
                            final SenhaAutorizacaoServidor sas = SenhaAutorizacaoServidorHome.findPrimeiroByUsuarioSenha(usuCodigo, senhaUtilizadaCrypt);
                            AbstractEntityHome.remove(sas);
                        } catch (final FindException ex) {
                            throw new UsuarioControllerException("mensagem.erro.nao.possivel.localizar.senha.autorizacao.para.executar.operacao", responsavel, ex);
                        } catch (final RemoveException ex) {
                            throw new UsuarioControllerException("mensagem.erro.interno.consumir.cancelar.senha.autorizacao.para.usuario", responsavel, ex);
                        }
                    }
                } else {
                    usuario.setUsuSenha2(senhaNovaCrypt);
                    usuario.setUsuDataExpSenha2(dataExpiracaoSenha);
                    if (senhaNovaCrypt != null) {
                        usuario.setUsuOperacoesSenha2(qtdOperacoes);
                    } else {
                        usuario.setUsuOperacoesSenha2(Short.valueOf("0"));
                    }
                }
            }

            // Determina parâmetros da ocorrência de usuário a ser gravada.
            String tocCodigoOcorrencia = null;
            String ousObs = null;
            if (!senhaAutorizacaoServidor) {
                if (tocCodigo != null) {
                    tocCodigoOcorrencia = tocCodigo;
                } else {
                    tocCodigoOcorrencia = CodedValues.TOC_ALTERACAO_SENHA_USUARIO;
                }

                if (CodedValues.TOC_CANCELAMENTO_SENHA_NAO_UTILIZADA.equals(tocCodigoOcorrencia)) {
                    ousObs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.cancelamento.senha.nao.utilizada", responsavel);
                } else {
                    ousObs = ApplicationResourcesHelper.getMessage(reiniciacao ? "mensagem.ocorrencia.ous.obs.reinicializacao.senha.usuario" : "mensagem.ocorrencia.ous.obs.alteracao.senha.usuario", responsavel);
                }
            } else {
                if (tocCodigo != null) {
                    tocCodigoOcorrencia = tocCodigo;
                } else {
                    tocCodigoOcorrencia = CodedValues.TOC_ALTERACAO_SENHA_AUTORIZACAO;
                }

                if (CodedValues.TOC_UTILIZACAO_SENHA_AUTORIZACAO.equals(tocCodigoOcorrencia)) {
                    ousObs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.utilizacao.senha.autorizacao", responsavel);
                } else if (CodedValues.TOC_CANCELAMENTO_SENHA_NAO_UTILIZADA.equals(tocCodigoOcorrencia)) {
                    ousObs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.cancelamento.senha.2.nao.utilizada", responsavel);
                } else if (CodedValues.TOC_ALTERACAO_SENHA_AUTORIZACAO_TOTEM.equals(tocCodigoOcorrencia)) {
                    ousObs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.senha.autorizacao.host.a.host", responsavel);
                } else {
                    ousObs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.senha.autorizacao", responsavel);
                }
            }

            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setUsuCodigo(usuCodigo);
            ocorrencia.setTocCodigo(tocCodigoOcorrencia);
            ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
            ocorrencia.setOusObs(ousObs);
            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
            if (tipoMotivoOperacao != null) {
                ocorrencia.setOusObs(ocorrencia.getOusObs() + (ocorrencia.getOusObs().lastIndexOf(".") == (ocorrencia.getOusObs().length() - 1) ? " " : ". ") + tipoMotivoOperacao.getAttribute(Columns.OUS_OBS));
                ocorrencia.setAttribute(Columns.OUS_TMO_CODIGO, tipoMotivoOperacao.getAttribute(Columns.TMO_CODIGO));
            }
            if (senhaAutorizacaoServidor && CodedValues.TOC_UTILIZACAO_SENHA_AUTORIZACAO.equals(tocCodigo)) {
                ocorrencia.setUtilizacaoSenhaAutServidor(true);
            }

            // Altera usuário com ocorrência e log
            updateUsuario(usuario, ocorrencia, responsavel);

            // Caso autenticação seja no SSO, altera no SSO também
            if (autenticacaoSSO && !atualizaSenhaSSO(usuario, senhaNova, senhaAtualAberta, responsavel)) {
                LOG.error("Erro ao atualizar senha do usuário no SSO.");
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException("mensagem.erro.alterar.senha.usuario", responsavel);
            }

            if (!senhaAutorizacaoServidor && usuarioSer && ParamSist.paramEquals(CodedValues.TPC_ALTERA_SENHA_TODOS_LOGINS_SERVIDOR, CodedValues.TPC_SIM, responsavel)) {
                //Replica a senha para todos o logins do servidor.
                matriculasUsuariosServidores(usuCodigo, senhaNovaCrypt, true, responsavel);
            }

            // Se for um usuário servidor.
            if (usuarioSer) {
                final String login = usuario.getUsuLogin();
                final int primeiroSeparador = login.indexOf('-');
                final int segundoSeparador = login.indexOf('-', primeiroSeparador + 1);

                final String estabelecimento = login.substring(0, primeiroSeparador > 0 ? primeiroSeparador : 0);
                final String matricula = login.substring((ParamSist.paramEquals(CodedValues.TPC_LOGIN_USU_SERVIDOR_COM_EST_ORG_ID, CodedValues.TPC_SIM, responsavel) ? segundoSeparador : primeiroSeparador) + 1, login.length());

                // Verifica parâmetros de sistema que informam se há senha externa e se deve ser atualizada.
                if (!senhaAutorizacaoServidor && ParamSist.paramEquals(CodedValues.TPC_SENHA_EXTERNA, CodedValues.TPC_SIM, responsavel) && ParamSist.paramEquals(CodedValues.TPC_ATUALIZA_SENHA_EXTERNA, CodedValues.TPC_SIM, responsavel)) {
                    // Se existir, reinicia a senha externa do servidor.
                    try {
                        final String[] parametros = { senhaNovaCrypt != null ? senhaNovaCrypt : CodedValues.USU_SENHA_SERVIDOR_CANCELADA, estabelecimento, matricula };
                        SenhaExterna.getInstance().atualizarSenha(parametros);
                    } catch (final UsuarioControllerException ex) {
                        LOG.error("Erro ao atualizar senha externa do servidor", ex);
                        throw new UsuarioControllerException("mensagem.erro.atualizar.senha.externa.servidor", responsavel, ex);
                    }
                }

                // Verifica se a alteração de senha deve ser comunicada.
                if ((senhaNova != null) && !naoComunicarServidor) {
                    if ((!senhaAutorizacaoServidor && ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_USUARIO_SER, CodedValues.TPC_SIM, responsavel) && (!reiniciacao || !ParamSist.paramEquals(CodedValues.TPC_EMAIL_REINICIALIZACAO_SENHA, CodedValues.TPC_SIM, responsavel))) ||
                        (senhaAutorizacaoServidor && (ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_ENVIA_EMAIL, responsavel) || ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_EMAIL_OU_TELA, responsavel) || ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_SMS, responsavel) ||
                                                      ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_SMS_E_EMAIL, responsavel) || ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_EMAIL_E_TELA, responsavel)))) {
                        try {
                            comunicaAlteracaoSenhaServidor(usuario.getUsuCodigo(), matricula, senhaNova, reiniciacao, senhaAutorizacaoServidor, false, responsavel);
                        } catch (final UsuarioControllerException e) {
                            // Falha no envio da comunicação não impede a alteração da senha.
                            LOG.error(e.getMessage(), e);
                        }
                    }
                }
            }
        } catch (UsuarioControllerException | SSOException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.alterar.senha.usuario", responsavel, ex);
        }
    }

    private boolean atualizaSenhaSSO(UsuarioTransferObject usuario, String senhaNova, String senhaAtualAberta,
                                     AcessoSistema responsavel) throws SSOException {
        // Se o token foi setado, é porque o usuário não estava com a senha expirada
        if (!responsavel.getUsuCodigo().equals(usuario.getUsuCodigo()) || (!TextHelper.isNull(responsavel.getSsoToken()) && !TextHelper.isNull(responsavel.getSsoToken().access_token))) {
            if (usuario.getUsuCodigo().equals(responsavel.getUsuCodigo())) {
                return ssoClient.updatePassword(responsavel.getSsoToken(), senhaNova, senhaAtualAberta);
            } else { // se o usuário responsável não é o mesmo que está tendo a senha alterada, deve-se usar a API de alteração de senha com usuário admin.
                // Logar usuário admin para inclusão de novo usuário
                return ssoClient.updatePasswordAsAdmin(usuario.getUsuEmail(), senhaNova);
            }
        } else if (!TextHelper.isNull(senhaAtualAberta)) {
            return ssoClient.updateExpiredPassword(usuario.getUsuEmail(), senhaNova, senhaAtualAberta);
        } else {
            // se senha atual vazia, significa que é uma reinicialização de senha.
            return ssoClient.updatePasswordAsAdmin(usuario.getUsuEmail(), senhaNova);
        }
    }

    /**
     * Sobrecarga do método "alterarSenhaApp()".
     * @param usuCodigo
     * @param senhaNova
     * @param senhaCriptografada
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void alterarSenhaApp(String usuCodigo, String senhaNova, boolean senhaCriptografada, AcessoSistema responsavel) throws UsuarioControllerException {
        alterarSenhaApp(usuCodigo, senhaNova, senhaCriptografada, false, responsavel);
    }

    /**
     * Altera a senha do App.
     * @param usuCodigo
     * @param senhaNova
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void alterarSenhaApp(String usuCodigo, String senhaNova, boolean senhaCriptografada, boolean chamadaMobile, AcessoSistema responsavel) throws UsuarioControllerException {
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);

        try {
            // Tenta buscar por um usuario servidor.
            usuario = this.findUsuario(usuario, AcessoSistema.ENTIDADE_SER, responsavel);
        } catch (final UsuarioControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.alterar.senha.usuario", responsavel, ex);
        }

        SenhaHelper.validarForcaSenha(senhaNova, true, responsavel);

        // Criptografa a nova senha para armazenamento no banco.
        String senhaNovaCrypt = null;
        if (senhaNova != null) {
            if (!senhaCriptografada) {
                senhaNovaCrypt = SenhaHelper.criptografarSenha(usuario.getUsuLogin(), senhaNova, true, responsavel);
            } else {
                senhaNovaCrypt = senhaNova;
            }
        }

        try {
            final boolean habilitaSenhaApp = ParamSist.paramEquals(CodedValues.TPC_HABILITA_SENHA_APP, CodedValues.TPC_SIM, responsavel);

            if (chamadaMobile && habilitaSenhaApp) {
                usuario.setUsuSenhaApp(senhaNovaCrypt);
                usuario.setUsuDataExpSenhaApp(new Date(calculaDataExpiracaoSenha(false, usuario, true, responsavel).getTimeInMillis()));
            } else {
                usuario.setUsuSenha(senhaNovaCrypt);
                usuario.setUsuDataExpSenha(new Date(calculaDataExpiracaoSenha(false, usuario, true, responsavel).getTimeInMillis()));
            }

            // Determina parâmetros da ocorrência de usuário a ser gravada.
            final String tocCodigoOcorrencia = CodedValues.TOC_ALTERACAO_SENHA_APP;
            final String ousObs = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.senha.app.usuario", responsavel);

            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setUsuCodigo(usuCodigo);
            ocorrencia.setTocCodigo(tocCodigoOcorrencia);
            ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
            ocorrencia.setOusObs(ousObs);
            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

            updateUsuario(usuario, ocorrencia, responsavel);

            final String matricula = usuario.getUsuLogin().substring(usuario.getUsuLogin().lastIndexOf('-') + 1, usuario.getUsuLogin().length());

            // Verifica se a alteração de senha deve ser comunicada.
            if ((senhaNova != null) && ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_USUARIO_SER, CodedValues.TPC_SIM, responsavel)) {
                try {
                    comunicaAlteracaoSenhaServidor(usuario.getUsuCodigo(), matricula, senhaNova, false, false, true, responsavel);
                } catch (final UsuarioControllerException e) {
                    // Falha no envio da comunicação não impede a alteração da senha.
                    LOG.error(e.getMessage(), e);
                }
            }
        } catch (final UsuarioControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.alterar.senha.usuario", responsavel, ex);
        }
    }

    /**
     * Valida a nova senha de acordo com as anteriores já salvas
     * @param usuCodigo
     * @param senhaNova
     * @param senhaNovaCrypt
     * @param senhaAutorizacaoServidor
     * @param responsavel
     * @throws UsuarioControllerException
     */
    private void validaSenhasAnteriores(String usuCodigo, String senhaNova, String senhaNovaCrypt, boolean senhaAutorizacaoServidor, AcessoSistema responsavel) throws UsuarioControllerException {
        final TransferObject usuario = obtemUsuarioTipo(usuCodigo, null, responsavel);
        final String tipo = !TextHelper.isNull(usuario.getAttribute("TIPO")) ? usuario.getAttribute("TIPO").toString() : "";
        final String senhaAntigaCrypt = (String) usuario.getAttribute(Columns.USU_SENHA);

        Integer qtdeSenhasAntigasUsuPodeRepetir = 0;
        if (AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_ORG.equals(tipo) || AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
            qtdeSenhasAntigasUsuPodeRepetir = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_SENHAS_ANT_USU_CSE_NAO_REPETE, responsavel)) ? Integer.valueOf(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_SENHAS_ANT_USU_CSE_NAO_REPETE, responsavel).toString()) : 0;
        } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo) || AcessoSistema.ENTIDADE_COR.equals(tipo)) {
            qtdeSenhasAntigasUsuPodeRepetir = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_SENHAS_ANT_USU_CSA_NAO_REPETE, responsavel)) ? Integer.valueOf(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_SENHAS_ANT_USU_CSA_NAO_REPETE, responsavel).toString()) : 0;
        } else if (AcessoSistema.ENTIDADE_SER.equals(tipo)) {
            qtdeSenhasAntigasUsuPodeRepetir = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_SENHAS_ANT_USU_SER_NAO_REPETE, responsavel)) ? Integer.valueOf(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_SENHAS_ANT_USU_SER_NAO_REPETE, responsavel).toString()) : 0;
        } else {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel);
        }

        // Se for servidor e a senha a ser validada é a de autorização, não requer validação
        if (AcessoSistema.ENTIDADE_SER.equals(tipo) && senhaAutorizacaoServidor) {
            return;
        }

        if (qtdeSenhasAntigasUsuPodeRepetir.compareTo(0) > 0) {
            final List<TransferObject> senhasAntigas = lstSenhasAnterioresUsuarios(usuCodigo, responsavel);

            // Caso não possua nenhuma senha antiga cadastrada e o parâmetro for maior que 1, cadastra a senha anterior
            if (senhasAntigas.isEmpty() && (qtdeSenhasAntigasUsuPodeRepetir.compareTo(1) > 0)) {
                try {
                    SenhaAnteriorHome.create(usuCodigo, senhaAntigaCrypt, DateHelper.getSystemDatetime());
                } catch (final CreateException e) {
                    TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                    throw new UsuarioControllerException("mensagem.erro.nao.possivel.armazenar.senha.anterior", responsavel);
                }
            }

            while (qtdeSenhasAntigasUsuPodeRepetir.compareTo(senhasAntigas.size()) < 0) {
                // Se a quantidade senhas anteriores for maior que o parâmetro deve excluir as N mais antigas
                try {
                    final TransferObject excluir = senhasAntigas.remove(0);
                    final SenhaAnteriorId pk = new SenhaAnteriorId(usuCodigo, excluir.getAttribute(Columns.SEA_SENHA).toString());
                    final SenhaAnterior senhaAnterior = SenhaAnteriorHome.findByPrimaryKey(pk);
                    AbstractEntityHome.remove(senhaAnterior);
                } catch (final FindException e) {
                    throw new UsuarioControllerException("mensagem.erro.interno.nao.possivel.validar.senha.anterior", responsavel);
                } catch (final RemoveException e) {
                    TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                    throw new UsuarioControllerException("mensagem.erro.interno.nao.possivel.validar.senha.anterior", responsavel);
                }
            }

            for (final TransferObject senhaAntiga : senhasAntigas) {
                // Se a nova senha for igual a uma das senhas anteriores lança uma exceção
                if (JCrypt.verificaSenha(senhaNova, (String) senhaAntiga.getAttribute(Columns.SEA_SENHA))) {
                    throw new UsuarioControllerException("mensagem.erro.nova.senha.deve.ser.diferente.das.ultimas.arg0.senhas.definidas", responsavel, qtdeSenhasAntigasUsuPodeRepetir.toString());
                }
            }

            // Armazena a nova senha como senha anterior
            try {
                SenhaAnteriorHome.create(usuCodigo, senhaNovaCrypt, DateHelper.getSystemDatetime());
            } catch (final CreateException e) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.armazenar.senha.anterior", responsavel);
            }

            // Se estiver criando a X senha antiga, excluir a mais antiga
            if (qtdeSenhasAntigasUsuPodeRepetir.compareTo(senhasAntigas.size()) == 0) {
                try {
                    final TransferObject excluir = senhasAntigas.remove(0);
                    final SenhaAnteriorId pk = new SenhaAnteriorId(usuCodigo, excluir.getAttribute(Columns.SEA_SENHA).toString());
                    final SenhaAnterior senhaAnterior = SenhaAnteriorHome.findByPrimaryKey(pk);
                    AbstractEntityHome.remove(senhaAnterior);
                } catch (final FindException e) {
                    throw new UsuarioControllerException("mensagem.erro.interno.nao.possivel.validar.senha.anterior", responsavel);
                } catch (final RemoveException e) {
                    TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                    throw new UsuarioControllerException("mensagem.erro.interno.nao.possivel.excluir.senha.anterior", responsavel);
                }
            }
        }
    }

    /**
     * Comunica ao usuário servidor sobre a alteração de sua senha.
     * @param usuCodigo : Código do usuário
     * @param matricula : Mátricula do servidor
     * @param novaSenha : Nova senha
     * @param reiniciacao : Indica se a senha foi reiniciada ou alterada
     * @param senhaAutorizacaoServidor : Indica que é senha de autorização (senha 2)
     * @param responsavel : Responsável
     * @throws UsuarioControllerException
     */
    private void comunicaAlteracaoSenhaServidor(String usuCodigo, String matricula, String novaSenha, boolean reiniciacao, boolean senhaAutorizacaoServidor, boolean senhaApp, AcessoSistema responsavel) throws UsuarioControllerException {
        String emailDestinatario = null;
        String celularDestinatario = null;
        final String modoEntrega = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, responsavel)) ? ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, responsavel).toString() : CodedValues.ALTERACAO_SENHA_AUT_SER_ENVIA_EMAIL;

        final ObtemUsuarioServidorQuery query = new ObtemUsuarioServidorQuery();
        query.usuCodigo = usuCodigo;
        query.rseMatricula = matricula;

        List<TransferObject> servidores = null;
        try {
            servidores = query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.encontrar.servidor", responsavel, e);
        }

        if (ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_ENVIA_EMAIL, responsavel) || ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_EXIBE_TELA, responsavel) || ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_EMAIL_OU_TELA, responsavel) || ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_EMAIL_E_TELA, responsavel)) {
            if ((servidores != null) && (servidores.size() == 1)) {
                emailDestinatario = consultarEmailServidor(true, (String) servidores.get(0).getAttribute(Columns.SER_CPF), (String) servidores.get(0).getAttribute(Columns.SER_EMAIL), modoEntrega, responsavel);
            } else {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.encontrar.servidor", responsavel);
            }

            if (!TextHelper.isNull(emailDestinatario)) {
                try {
                    EnviaEmailHelper.enviarEmailAlteracaoSenhaServidor(emailDestinatario, matricula, novaSenha, reiniciacao, senhaAutorizacaoServidor, senhaApp, responsavel);
                } catch (final ViewHelperException e) {
                    throw new UsuarioControllerException("mensagem.erro.enviar.email.servidor", responsavel, e);
                }
            }

        } else if (ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_SMS, responsavel)) {

            if ((servidores != null) && (servidores.size() == 1)) {
                celularDestinatario = (String) servidores.get(0).getAttribute(Columns.SER_CELULAR);
            } else {
                throw new UsuarioControllerException("", responsavel);
            }

            if (!TextHelper.isNull(celularDestinatario)) {
                try {
                    EnviaSMSHelper.enviarSMSSenhaAutorizacao(celularDestinatario, matricula, novaSenha, reiniciacao, senhaAutorizacaoServidor, senhaApp, responsavel);
                } catch (final ZetraException e) {
                    throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, e);
                }
            }

        } else if (ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_SMS_E_EMAIL, responsavel)) {
            if ((servidores != null) && (servidores.size() == 1)) {
                celularDestinatario = (String) servidores.get(0).getAttribute(Columns.SER_CELULAR);
            	emailDestinatario = consultarEmailServidor(true, (String) servidores.get(0).getAttribute(Columns.SER_CPF), (String) servidores.get(0).getAttribute(Columns.SER_EMAIL), modoEntrega, responsavel);
            } else {
                throw new UsuarioControllerException("", responsavel);
            }

            if (!TextHelper.isNull(emailDestinatario)) {
                try {
                    EnviaEmailHelper.enviarEmailAlteracaoSenhaServidor(emailDestinatario, matricula, novaSenha, reiniciacao, senhaAutorizacaoServidor, senhaApp, responsavel);
                } catch (final ViewHelperException e) {
                    throw new UsuarioControllerException("mensagem.erro.enviar.email.servidor", responsavel, e);
                }
            }

            if (!TextHelper.isNull(celularDestinatario)) {
                try {
                    EnviaSMSHelper.enviarSMSSenhaAutorizacao(celularDestinatario, matricula, novaSenha, reiniciacao, senhaAutorizacaoServidor, senhaApp, responsavel);
                } catch (final ZetraException e) {
                    throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, e);
                }
            }
        }
    }

    @Override
    public String gerarSenhaAutorizacaoOtp(String rseCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        return gerarSenhaAutorizacaoOtp(rseCodigo, null, responsavel);
    }

    /**
     * Gera nova senha de autorização do servidor OTP e envia por email e/ou SMS.
     * @param usuCodigo
     * @param tocCodigo
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public String gerarSenhaAutorizacaoOtp(String rseCodigo, String modoEntrega, AcessoSistema responsavel) throws UsuarioControllerException {

        if (!ParamSist.paramEquals(CodedValues.TPC_USA_SENHA_AUTORIZACAO_DESC_SERVIDOR, CodedValues.TPC_SIM, responsavel)) {
            throw new UsuarioControllerException("mensagem.operacaoInvalida", responsavel);
        }

        ServidorTransferObject servidor = null;
        try {
            servidor = servidorController.findServidorByRseCodigo(rseCodigo, responsavel);
        } catch (final ServidorControllerException e) {
            throw new UsuarioControllerException(e);
        }

        final List<TransferObject> usuarios = lstUsuariosSerByRseCodigo(rseCodigo, responsavel);

        if ((usuarios == null) || usuarios.isEmpty() || (usuarios.size() > 1)) {
            throw new UsuarioControllerException("mensagem.erro.servidor.usuario.nao.encontrado", responsavel);
        }

        final String serNome = servidor.getSerNome();
        final String usuCodigo = usuarios.get(0).getAttribute(Columns.USU_CODIGO).toString();

        if (TextHelper.isNull(modoEntrega)) {
            modoEntrega = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, responsavel)) ? ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, responsavel).toString() : CodedValues.ALTERACAO_SENHA_AUT_SER_ENVIA_EMAIL;
        }

        boolean enviou = false;
        boolean enviaEmail = false;
        boolean enviaCelular = false;
        boolean reconhecimentoFacial = false;

        switch (modoEntrega) {
            case CodedValues.ALTERACAO_SENHA_AUT_SER_ENVIA_EMAIL:
                enviaEmail = true;
                break;

            case CodedValues.ALTERACAO_SENHA_AUT_SER_EXIBE_TELA:
            case CodedValues.ALTERACAO_SENHA_AUT_SER_EMAIL_OU_TELA:
            case CodedValues.ALTERACAO_SENHA_AUT_SER_EMAIL_E_TELA:
                enviaEmail = true;
                break;

            case CodedValues.ALTERACAO_SENHA_AUT_SER_SMS:
                enviaCelular = true;
                break;

            case CodedValues.ALTERACAO_SENHA_AUT_SER_SMS_E_EMAIL:
                enviaCelular = true;
                enviaEmail = true;
                break;

            case CodedValues.ALTERACAO_SENHA_AUT_SER_RECONHECIMENTO_FACIAL:
                reconhecimentoFacial = true;
                break;

            default:
                enviaEmail = true;
                break;
        }

        final String novaSenhaPlana = gerarSenhaAutorizacao(usuCodigo, false, true, true, responsavel);

        if (reconhecimentoFacial) {
            return novaSenhaPlana;
        }

        final String email = consultarEmailServidor(enviaEmail, servidor.getSerCpf(), servidor.getSerEmail(), modoEntrega, responsavel);

        final String celular = servidor.getSerCelular();

        // Envia mensagem
        if (enviaCelular && !TextHelper.isNull(celular)) {
            try {
                EnviaSMSHelper.enviarSMSOTP(celular, novaSenhaPlana, responsavel);
                enviou = true;
            } catch (final ZetraException e) {
                // Se deu erro ao enviar, espera possível envio por email
            }
        }

        if (enviaEmail && !TextHelper.isNull(email)) {
            try {
                EnviaEmailHelper.enviarEmailOTPServidor(serNome, email, novaSenhaPlana, responsavel);
                enviou = true;
            } catch (final ViewHelperException e) {
                // Se deu erro ao enviar, mensagem de erro será setada no próximo tratamento
            }
        }

        if (!enviou) {
            if (enviaCelular && enviaEmail) {
                throw new UsuarioControllerException("mensagem.erro.sms.ou.email.enviar", responsavel);
            } else if (enviaCelular) {
                throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel);
            } else if (enviaEmail) {
                throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel);
            }
        }

        return novaSenhaPlana;
    }

    /**
     * Gera nova senha de autorização do servidor.
     * @param usuCodigo
     * @param tocCodigo
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public String gerarSenhaAutorizacao(String usuCodigo, boolean totem, AcessoSistema responsavel) throws UsuarioControllerException {
        return gerarSenhaAutorizacao(usuCodigo, totem, false, true, responsavel);
    }

    /**
     * Gera nova senha de autorização do servidor.
     * @param usuCodigo
     * @param tocCodigo
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public String gerarSenhaAutorizacao(String usuCodigo, boolean totem, boolean naoComunicarServidor, boolean validaQtdeSenhaAutorizacao, AcessoSistema responsavel) throws UsuarioControllerException {
        if (validaQtdeSenhaAutorizacao) {
            // Valida a quantidade máxima de senhas de autorização múltiplas que podem ser geradas para um servidor
            validaQtdeSenhaAutorizacao(usuCodigo, responsavel);
        }

        final TransferObject servidor = obtemServidorPorUsuario(usuCodigo, responsavel);
        final String srsCodigo = servidor.getAttribute(Columns.SRS_CODIGO).toString();
        if (!CodedValues.SRS_ATIVO.equals(srsCodigo)) {
            throw new UsuarioControllerException("mensagem.senha.servidor.autorizacao.erro.servidor.bloqueado", responsavel);
        }

        // Tamanho máximo da senha de autorização
        final int tamMaxSenhaServidor = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MAX_SENHA_AUT_SERVIDOR, responsavel)) ? Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MAX_SENHA_AUT_SERVIDOR, responsavel).toString()) : 8;

        // Gera nova senha plana: verifica se deve ser apenas numérica
        final boolean senhaAutNumerica = ParamSist.paramEquals(CodedValues.TPC_SENHA_AUT_SERVIDOR_SOMENTE_NUMERICA, CodedValues.TPC_SIM, responsavel);
        final String novaSenhaPlana = senhaAutNumerica ? GeradorSenhaUtil.getPasswordNumber(tamMaxSenhaServidor, responsavel) : GeradorSenhaUtil.getPassword(tamMaxSenhaServidor, AcessoSistema.ENTIDADE_SER, responsavel);

        final String tocCodigo = totem ? CodedValues.TOC_ALTERACAO_SENHA_AUTORIZACAO_TOTEM : CodedValues.TOC_ALTERACAO_SENHA_AUTORIZACAO;
        // Altera a senha de autorização do servidor
        this.alterarSenha(usuCodigo, novaSenhaPlana, null, null, false, true, true, false, tocCodigo, null, naoComunicarServidor, false, null, responsavel);

        // Retorna a senha gerada
        return novaSenhaPlana;
    }

    /**
     * Gera nova senha de autorização do servidor (REST)
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public String gerarSenhaAutorizacaoRest(AcessoSistema responsavel) throws UsuarioControllerException {
        final String senhaPlana = gerarSenhaAutorizacao(responsavel.getUsuCodigo(), false, responsavel);

        //No mobile a senha deve ser sempre enviada por e-mail, independente do tpc 362, por isso enviamos o e-mail caso o parâmetro esteja habilitado somente para exibir na tela
        //Caso esteja as duas outras opções o método anterior já enviou o e-mail
        if (!TextHelper.isNull(responsavel.getSerEmail()) && (senhaPlana != null) && ParamSist.paramEquals(CodedValues.TPC_EMAIL_ALTERACAO_SENHA_AUT_SERVIDOR, CodedValues.ALTERACAO_SENHA_AUT_SER_EXIBE_TELA, responsavel)) {
            try {
                comunicaAlteracaoSenhaServidor(responsavel.getUsuCodigo(), responsavel.getRseMatricula(), senhaPlana, false, true, false, responsavel);
            } catch (final UsuarioControllerException e) {
                // Falha no envio da comunicação não impede a alteração da senha.
                LOG.error(e.getMessage(), e);
            }
        }

        return senhaPlana;
    }

    /**
     * Valida a quantidade máxima de senhas de autorização múltiplas que podem ser geradas para um servidor.
     * Validação somente é executada caso o sistema utilize senhas múltiplas de autorização.
     *
     * @param usuCodigo
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void validaQtdeSenhaAutorizacao(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        // Verifica se utiliza múltiplas senhas de autorização, e caso utilize
        // se é possível gerar nova senha de autorização
        if (ParamSist.paramEquals(CodedValues.TPC_USA_MULTIPLAS_SENHAS_AUTORIZACAO_SERVIDOR, CodedValues.TPC_SIM, responsavel)) {
            int qtdMaxSenhaAut = 5;
            try {
                // Obtém parâmetro com a quantidade máxima de senhas de autorização: Default = 5
                final Object qtdMaxSenhaAutParam = ParamSist.getInstance().getParam(CodedValues.TPC_QTD_MAX_MULTIPLAS_SENHAS_AUTORIZACAO, responsavel);
                qtdMaxSenhaAut = !TextHelper.isNull(qtdMaxSenhaAutParam) ? Integer.parseInt(qtdMaxSenhaAutParam.toString()) : 5;
            } catch (final NumberFormatException ex) {
                LOG.warn("Valor incorreto para o parâmetro de sistema: " + CodedValues.TPC_QTD_MAX_MULTIPLAS_SENHAS_AUTORIZACAO);
                qtdMaxSenhaAut = 5;
            }
            try {
                // Recupera as senhas de autorização do servidor
                final ListaSenhaAutorizacaoServidorQuery query = new ListaSenhaAutorizacaoServidorQuery();
                query.usuCodigo = usuCodigo;
                query.count = true;
                final int total = query.executarContador();
                // Caso já exceda o total, não permite geração de nova senha
                if (total >= qtdMaxSenhaAut) {
                    throw new UsuarioControllerException("mensagem.senha.servidor.autorizacao.erro.qtd.excedida", responsavel);
                }
            } catch (final HQueryException ex) {
                throw new UsuarioControllerException("mensagem.erro.interno.listar.senhas.autorizacao.usuario", responsavel, ex);
            }
        }
    }

    /**
     * Altera a senha de autorização do servidor.
     * @param usuCodigo
     * @param senhaNova
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void alterarSenhaAutorizacao(String usuCodigo, String senhaNova, AcessoSistema responsavel) throws UsuarioControllerException {
        this.alterarSenha(usuCodigo, senhaNova, null, null, false, false, true, false, CodedValues.TOC_ALTERACAO_SENHA_AUTORIZACAO, null, responsavel);
    }

    /**
     * Registra a utilização da senha de autorização do servidor através de sua remoção.
     * @param usuCodigo : Código do usuário servidor.
     * @param senhaUtilizada : Senha utilizada que será consumida
     * @param responsavel : Responsável pela operação
     * @throws UsuarioControllerException
     */
    @Override
    public void consomeSenhaAutorizacao(String usuCodigo, String senhaUtilizada, AcessoSistema responsavel) throws UsuarioControllerException {
        this.alterarSenha(usuCodigo, null, senhaUtilizada, null, false, true, true, true, CodedValues.TOC_UTILIZACAO_SENHA_AUTORIZACAO, null, responsavel);
    }

    /**
     * Cancela a senha de autorização do servidor.
     * @param usuCodigo : Código do usuário servidor.
     * @param senhaUtilizada : Senha não utilizada que será cancelada (criptografada)
     * @param responsavel : Responsável pela operação
     * @throws UsuarioControllerException
     */
    @Override
    public void cancelaSenhaAutorizacao(String usuCodigo, String senhaNaoUtilizada, AcessoSistema responsavel) throws UsuarioControllerException {
        this.alterarSenha(usuCodigo, null, senhaNaoUtilizada, null, false, true, true, true, CodedValues.TOC_CANCELAMENTO_SENHA_NAO_UTILIZADA, null, responsavel);
    }

    /**
     * Cancela a senha de autorização do servidor. (REST)
     * @param dataCriacao : Data de criação da senha que será cancelada (criptografada)
     * @param responsavel : Responsável pela operação
     * @throws UsuarioControllerException
     */
    @Override
    public void cancelaSenhaAutorizacaoRest(java.util.Date dataCriacao, AcessoSistema responsavel) throws UsuarioControllerException {
        SenhaAutorizacaoServidor senha = new SenhaAutorizacaoServidor();
        try {
            senha = SenhaAutorizacaoServidorHome.findByPrimaryKey(new SenhaAutorizacaoServidorId(responsavel.getUsuCodigo(), dataCriacao));
        } catch (final FindException e) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.localizar.senha.autorizacao.para.executar.operacao", responsavel, e);
        }

        this.alterarSenha(responsavel.getUsuCodigo(), null, senha.getSasSenha(), null, false, true, true, true, CodedValues.TOC_CANCELAMENTO_SENHA_NAO_UTILIZADA, null, responsavel);
    }

    /**
     * Altera a quantidade de operações disponíveis para a senha de autorização do servidor
     * @param usuCodigo
     * @param qtdOperacoes
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void alterarOperacoesSenhaAutorizacao(String usuCodigo, Short qtdOperacoes, String senhaUtilizada, AcessoSistema responsavel) throws UsuarioControllerException {
        // Verifica se utiliza múltiplas senhas de autorização
        final boolean usaMultiplasSenhasAut = ParamSist.paramEquals(CodedValues.TPC_USA_MULTIPLAS_SENHAS_AUTORIZACAO_SERVIDOR, CodedValues.TPC_SIM, responsavel);

        // Busca o registro do usuário servidor a ser alterado
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        usuario = this.findUsuario(usuario, AcessoSistema.ENTIDADE_SER, responsavel);
        Short qtdOperacoesAtual = null;
        SenhaAutorizacaoServidor sas = null;

        if (usaMultiplasSenhasAut) {
            try {
                final List<SenhaAutorizacaoServidor> senhasAut = SenhaAutorizacaoServidorHome.findByUsuCodigo(usuCodigo);
                for (final SenhaAutorizacaoServidor senhaAut : senhasAut) {
                    if (JCrypt.verificaSenha(senhaUtilizada, senhaAut.getSasSenha())) {
                        sas = senhaAut;
                        qtdOperacoesAtual = sas.getSasQtdOperacoes();
                        break;
                    }
                }
                if (sas == null) {
                    throw new UsuarioControllerException("mensagem.senha.servidor.autorizacao.nao.encontrada", responsavel);
                }
            } catch (final FindException ex) {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.localizar.senha.autorizacao.para.executar.operacao", responsavel, ex);
            }
        } else {
            qtdOperacoesAtual = usuario.getUsuOperacoesSenha2();
        }

        // Se a quantidade de operações é maior que zero e está sendo reduzida,
        // cria ocorrência de utilização da senha, pois ela ainda está válida e
        // não será "consumida" pela operação
        OcorrenciaUsuarioTransferObject ocorrencia = null;
        if ((qtdOperacoes != null) && (qtdOperacoesAtual != null) && (qtdOperacoes > 0) && (qtdOperacoesAtual > qtdOperacoes)) {
            ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setUsuCodigo(usuCodigo);
            ocorrencia.setTocCodigo(CodedValues.TOC_UTILIZACAO_SENHA_AUTORIZACAO);
            ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
            ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.utilizacao.senha.autorizacao", responsavel));
            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
            ocorrencia.setUtilizacaoSenhaAutServidor(true);
        }

        if (usaMultiplasSenhasAut) {
            try {
                sas.setSasQtdOperacoes(qtdOperacoes);
                AbstractEntityHome.update(sas);
                if (ocorrencia != null) {
                    createOcorrenciaUsuario(ocorrencia, responsavel);
                }
            } catch (final UpdateException ex) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.atualizar.senha.autorizacao", responsavel, ex);
            }
        } else {
            // Atualiza o registro no usuário
            usuario.setUsuOperacoesSenha2(qtdOperacoes);
            updateUsuario(usuario, ocorrencia, responsavel);
        }
    }

    /**
     * Lista as senhas de autorização do servidor não expiradas e com qtd
     * de operações maior que zero.
     * @param usuCodigo : código do usuário servidor
     * @param responsavel : responsável pela operação
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public List<TransferObject> lstSenhaAutorizacaoServidor(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaSenhaAutorizacaoServidorQuery query = new ListaSenhaAutorizacaoServidorQuery();
            query.usuCodigo = usuCodigo;
            return query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.interno.listar.senhas.autorizacao.usuario", responsavel, e);
        }
    }

    /**
     * Lista as senhas de autorização do servidor não expiradas e com qtd (REST)
     * de operações maior que zero.
     * @param responsavel : responsável pela operação
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public List<TransferObject> lstSenhaAutorizacaoServidorRest(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaSenhaAutorizacaoServidorQuery query = new ListaSenhaAutorizacaoServidorQuery();
            query.usuCodigo = responsavel.getUsuCodigo();
            return query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.interno.listar.senhas.autorizacao.usuario", responsavel, e);
        }
    }

    /**
     * Retorna a quantidade de senha de autorização de usuário servidor gerada no dia atual via host a host.
     *
     * @param usuCodigo
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public int qtdeSenhaAutorizacaoUsuSerDiaHostAHost(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaOcorrenciaUsuSerSenhaAutorizacaoViaTotemQuery query = new ListaOcorrenciaUsuSerSenhaAutorizacaoViaTotemQuery();
            query.usuCodigo = usuCodigo;
            return query.executarContador();
        } catch (final HQueryException e) {
            // TODO Alterar mensagem da exceção
            throw new UsuarioControllerException("mensagem.erro.interno.listar.senhas.autorizacao.usuario", responsavel, e);
        }
    }

    /**
     * Recupera os dados da senha de autorização do servidor.
     * @param usuCodigo : código do usuário servidor
     * @param sasSenha : senha criptografada
     * @param responsavel : responsável pela operação
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public TransferObject obtemSenhaAutorizacaoServidor(String usuCodigo, String senha, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaSenhaAutorizacaoServidorQuery query = new ListaSenhaAutorizacaoServidorQuery();
            query.usuCodigo = usuCodigo;
            query.sasSenha = null;
            query.senhasValidas = false;
            //query.maxResults = 1;
            final List<TransferObject> senhasAutServidor = query.executarDTO();
            if ((senhasAutServidor != null) && (senhasAutServidor.size() > 0)) {
                for (final TransferObject autorizacao : senhasAutServidor) {
                    final String sasSenha = (String) autorizacao.getAttribute(Columns.SAS_SENHA);
                    if (JCrypt.verificaSenha(senha, sasSenha)) {
                        return autorizacao;
                    }
                }
            }
            return null;
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.interno.listar.senhas.autorizacao.usuario", responsavel, e);
        }
    }

    /**
     * Cria o protocolo de senha de autorização do servidor.
     *
     * @param psaCodigo
     * @param usuCodigoResponsavel
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public String createProtocoloSenhaAutorizacao(String psaCodigo, String usuCodigoAfetado, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            ProtocoloSenhaAutorizacaoHome.create(psaCodigo, usuCodigoAfetado, responsavel.getUsuCodigo());

            return psaCodigo;
        } catch (final CreateException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e);
        }
    }

    /**
     * Retorna protocolo de senha de autorização.
     *
     * @param psaCodigo
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public TransferObject getProtocoloSenhaAutorizacao(String psaCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemProtocoloSenhaAutorizacaoQuery query = new ObtemProtocoloSenhaAutorizacaoQuery();
            query.psaCodigo = psaCodigo;
            final List<TransferObject> lista = query.executarDTO();
            return (lista != null) && !lista.isEmpty() ? lista.get(0) : null;
        } catch (final HQueryException e) {
            LOG.error(e.getMessage(), e);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e);
        }
    }

    /**
     * Invalida as senhas de autorização dos servidores de acordo com o prazo de validade
     * definido no parâmetro de sistema.
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public List<TransferObject> listarSenhasExpiradasCancelamentoAut(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            List<TransferObject> senhasAutorizacaoExpiradas = null;
            if (ParamSist.paramEquals(CodedValues.TPC_USA_MULTIPLAS_SENHAS_AUTORIZACAO_SERVIDOR, CodedValues.TPC_SIM, responsavel)) {
                // Recupera a lista de senhas de autorização já expiradas
                final ListaSenhaAutorizacaoServidorExpiradaQuery query = new ListaSenhaAutorizacaoServidorExpiradaQuery();
                senhasAutorizacaoExpiradas = query.executarDTO();

            } else {
                // Recupera a lista de usuários com senha de autorização vencida.
                final ListaUsuarioSerSenhaAutExpiradaQuery query = new ListaUsuarioSerSenhaAutExpiradaQuery();
                senhasAutorizacaoExpiradas = query.executarDTO();
            }
            return senhasAutorizacaoExpiradas;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.recuperar.senhas.nao.utilizadas", responsavel, ex);
        }
    }

    /**
     * Altera a chave de recuperação de senha do usuário.
     * @param usuCodigo : Código do usuário
     * @param codSenha  : Código de recuperação de senha
     * @param responsavel : Usuário que está realizando a recuperação de senha
     * @throws UsuarioControllerException
     */
    @Override
    public void alteraChaveRecupSenha(String usuCodigo, String codSenha, AcessoSistema responsavel) throws UsuarioControllerException {
        // Busca o usuário pela chave primária
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        usuario = findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);

        if (!CodedValues.STU_ATIVO.equals(usuario.getStuCodigo())) {
            throw new UsuarioControllerException("mensagem.usuarioBloqueado", responsavel);
        }

        try {
            // Salva chave para recuperação de senha.
            usuario.setUsuChaveRecuperarSenha(codSenha);

            if (!TextHelper.isNull(codSenha)) {
                usuario.setUsuDataRecSenha(DateHelper.getSystemDatetime());
            } else {
                usuario.setUsuDataRecSenha(null);
            }

            // Determina parâmetros da ocorrência de usuário a ser gravada.
            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_SENHA_USUARIO);
            ocorrencia.setUsuCodigo(usuCodigo);
            ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
            if (!TextHelper.isNull(codSenha)) {
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.chave.recup.senha.usuario", responsavel));
            } else {
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.utilizacao.chave.recup.senha.usuario", responsavel));
            }

            updateUsuario(usuario, ocorrencia, responsavel);

        } catch (final UsuarioControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.alterar.chave.recuperacao.senha.usuario", responsavel, ex);
        }
    }

    /**
     * Altera a chave de recuperação de senha do usuário no auto-desbloqueio
     * @param usuCodigo : Código do usuário
     * @param codSenha  : Código de recuperação de senha
     * @param responsavel : Usuário que está realizando a recuperação de senha
     * @throws UsuarioControllerException
     */
    @Override
    public void alteraChaveRecupSenhaAutoDesbloqueio(String usuCodigo, String codSenha, AcessoSistema responsavel) throws UsuarioControllerException {
        // Busca o usuário pela chave primária
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        usuario = findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);

        if (!CodedValues.STU_BLOQUEADO_AUTOMATICAMENTE.equals(usuario.getStuCodigo())) {
            throw new UsuarioControllerException("mensagem.auto.desbloqueio.servidor.nao.pode.desbloqueado", responsavel);
        }

        try {
            // Salva chave para recuperação de senha.
            usuario.setUsuChaveRecuperarSenha(codSenha);

            if (!TextHelper.isNull(codSenha)) {
                usuario.setUsuDataRecSenha(DateHelper.getSystemDatetime());
            } else {
                usuario.setUsuDataRecSenha(null);
            }

            // Determina parâmetros da ocorrência de usuário a ser gravada.
            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_SENHA_USUARIO);
            ocorrencia.setUsuCodigo(usuCodigo);
            ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
            if (!TextHelper.isNull(codSenha)) {
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.chave.recup.senha.usuario", responsavel));
            } else {
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.utilizacao.chave.recup.senha.usuario", responsavel));
            }

            updateUsuario(usuario, ocorrencia, responsavel);

        } catch (final UsuarioControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.alterar.chave.recuperacao.senha.usuario", responsavel, ex);
        }
    }

    private boolean validarChaveRecupSenha(String usuCodigo, String codSenha, AcessoSistema responsavel) throws UsuarioControllerException {
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        usuario = findUsuario(usuario, responsavel.getTipoEntidade(), responsavel);

        if (!CodedValues.STU_ATIVO.equals(usuario.getStuCodigo())) {
            throw new UsuarioControllerException("mensagem.usuarioBloqueado", responsavel);
        }

        // Busca chave do usuario salvo em banco de dados.
        final String usuChave = usuario.getUsuChaveRecuperarSenha() == null ? "" : usuario.getUsuChaveRecuperarSenha();
        // Verificar se os codigos de recuperação são iguais.
        if (usuChave.equals(codSenha) && !"".equals(usuChave) && !"".equals(codSenha)) {
            // verifica se chave de recuperação já passou do limite de 1 dia para ser consumida
            final java.util.Date dataCriacaoChave = usuario.getUsuDataRecSenha();
            if (DateHelper.dayDiff(DateHelper.getSystemDatetime(), dataCriacaoChave) > 1) {
                return false;
            }

            alteraChaveRecupSenha(usuCodigo, "", responsavel);
            return true;
        } else {
            return false;
        }
    }

    private boolean validarChaveRecupSenhaAutoDesbloqueio(String usuCodigo, String codSenha, AcessoSistema responsavel) throws UsuarioControllerException {
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        usuario = findUsuario(usuario, responsavel.getTipoEntidade(), responsavel);

        if (!CodedValues.STU_BLOQUEADO_AUTOMATICAMENTE.equals(usuario.getStuCodigo())) {
            throw new UsuarioControllerException("mensagem.auto.desbloqueio.servidor.nao.pode.desbloqueado", responsavel);
        }

        // Busca chave do usuario salvo em banco de dados.
        final String usuChave = usuario.getUsuChaveRecuperarSenha() == null ? "" : usuario.getUsuChaveRecuperarSenha();
        // Verificar se os codigos de recuperação são iguais.
        if (usuChave.equals(codSenha) && !"".equals(usuChave) && !"".equals(codSenha)) {
            // verifica se chave de recuperação já passou do limite de 1 dia para ser consumida
            final java.util.Date dataCriacaoChave = usuario.getUsuDataRecSenha();
            if (DateHelper.dayDiff(DateHelper.getSystemDatetime(), dataCriacaoChave) > 1) {
                return false;
            }

            alteraChaveRecupSenhaAutoDesbloqueio(usuCodigo, "", responsavel);
            return true;
        } else {
            return false;
        }
    }

    /**
     * Envia ao usuário servidor link para reinicializar a senha na recuperação de senha.
     * @param usuCodigo Código do usuário
     * @param matricula Mátricula do servidor
     * @param link Link para recuperar senha
     * @param codigo Codigo para verificação do usuario
     * @param responsavel Responsável
     * @throws UsuarioControllerException
     */
    @Override
    public void enviaLinkReinicializarSenhaSer(String usuCodigo, String matricula, String link, String codigo, AcessoSistema responsavel) throws UsuarioControllerException {
        String emailDestinatario = null;
        String[] serNome = null;
        String serPrimeiroNome = null;

        final ObtemUsuarioServidorQuery query = new ObtemUsuarioServidorQuery();

        query.usuCodigo = usuCodigo;
        query.rseMatricula = matricula;
        link = link + "&tipo=recuperar&cod_recuperar=" + codigo;

        List<TransferObject> servidores = null;
        try {
            servidores = query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.recuperar.email.servidor", responsavel, e);
        }

        if ((servidores != null) && (servidores.size() == 1)) {
            emailDestinatario = (String) servidores.get(0).getAttribute(Columns.SER_EMAIL);
            serNome = TextHelper.split((String) servidores.get(0).getAttribute(Columns.SER_NOME), " ");
            serPrimeiroNome = serNome[0].trim().toString();
        } else {
            throw new UsuarioControllerException("mensagem.erro.recuperar.email.servidor", responsavel);
        }

        if (!TextHelper.isNull(emailDestinatario)) {
            try {
                EnviaEmailHelper.enviarLinkRecuperacaoSenhaServidor(emailDestinatario, serPrimeiroNome, link, responsavel);
            } catch (final ViewHelperException e) {
                throw new UsuarioControllerException("mensagem.erro.enviar.email.servidor", responsavel, e);
            }
        }
    }

    /**
     * Envia ao usuário servidor link para reinicializar a senha na recuperação de senha.
     * @param usuCodigo Código do usuário
     * @param matricula Mátricula do servidor
     * @param novaSenha Nova senha
     * @param reiniciacao Indica se a senha foi reiniciada ou alterada.
     * @param responsavel Responsável
     * @throws UsuarioControllerException
     */
    @Override
    public void enviaLinkReinicializarSenhaUsu(String usuCodigo, String login, String link, String codigo, AcessoSistema responsavel) throws UsuarioControllerException {
        enviaLinkReinicializarSenhaUsuEmail(usuCodigo, login, link, codigo, null, responsavel);
    }

    private void enviaLinkReinicializarSenhaUsuEmail(String usuCodigo, String login, String link, String codigo, String emailDestinatario, AcessoSistema responsavel) throws UsuarioControllerException {

        link = link + "&tipo=recuperar&cod_recuperar=" + codigo;

        if (emailDestinatario == null) {
            final ObtemUsuarioQuery query = new ObtemUsuarioQuery();
            query.usuCodigo = usuCodigo;

            List<TransferObject> usuario = null;
            try {
                usuario = query.executarDTO();
            } catch (final HQueryException e) {
                throw new UsuarioControllerException("mensagem.erro.recuperar.email.usuario", responsavel, e);
            }

            if ((usuario != null) && (usuario.size() == 1)) {
                emailDestinatario = (String) usuario.get(0).getAttribute(Columns.USU_EMAIL);
            } else {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.encontrar.usuario", responsavel);
            }
        }

        if (!TextHelper.isNull(emailDestinatario)) {
            try {
                EnviaEmailHelper.enviarEmailLinkRecuperarSenha(emailDestinatario, login, link, responsavel);
            } catch (final ViewHelperException e) {
                throw new UsuarioControllerException("mensagem.erro.falha.enviar.email", responsavel, e);
            }
        }
    }

    /**
     * Envia ao novo usuário cirado link para definir a senha de acessi ao sistema
     * @param usuCodigo
     * @param emailDestinatario
     * @param usuLogin - Login do novo usuáro criado
     * @param usuNome - Nome do novo usuário criado
     * @param entidadeNome - Nome da entidade na qual o usuário foi criado.
     * @param link - link a ser enviado no e-mail que direciona para a página de definição de senha.
     * @param codigo - token de fluxo de acesso da URL
     * @param responsavel
     * @throws UsuarioControllerException
     */
    private void enviaLinkIniciacaoSenhaNovoUsuario(String usuCodigo, String emailDestinatario, String usuLogin, String usuNome, String link, String codigo, AcessoSistema responsavel) throws UsuarioControllerException {
        link = link + "&tipo=recuperar&cod_recuperar=" + codigo;

        if (!TextHelper.isNull(emailDestinatario)) {
            try {
                EnviaEmailHelper.enviarEmailLinkDefinirSenhaNovoUsuario(emailDestinatario, usuLogin, usuNome, link, responsavel);
            } catch (final ViewHelperException e) {
                throw new UsuarioControllerException("mensagem.erro.falha.enviar.email", responsavel, e);
            }
        }
    }

    /**
     * Envia ao usuário servidor link para reinicializar a senha no auto desbloqueio
     * @param usuCodigo Código do usuário
     * @param matricula Mátricula do servidor
     * @param link Link para recuperar senha
     * @param codigo Codigo para verificação do usuario
     * @param responsavel Responsável
     * @throws UsuarioControllerException
     */
    @Override
    public void enviaLinkReinicializarSenhaSerAutoDesbloqueio(String usuCodigo, String matricula, String link, String codigo, AcessoSistema responsavel) throws UsuarioControllerException {
        String emailDestinatario = null;

        final ObtemUsuarioServidorQuery query = new ObtemUsuarioServidorQuery();

        query.usuCodigo = usuCodigo;
        query.rseMatricula = matricula;
        link = link + "&tipo=recuperar&cod_recuperar=" + codigo + "&autodesbloqueio=true";

        List<TransferObject> servidores = null;
        try {
            servidores = query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.recuperar.email.servidor", responsavel, e);
        }

        if ((servidores != null) && (servidores.size() == 1)) {
            emailDestinatario = (String) servidores.get(0).getAttribute(Columns.SER_EMAIL);
        } else {
            throw new UsuarioControllerException("mensagem.erro.recuperar.email.servidor", responsavel);
        }

        if (!TextHelper.isNull(emailDestinatario)) {
            try {
                EnviaEmailHelper.enviarEmailLinkRecuperarSenhaAutoDesbloqueio(emailDestinatario, matricula, link, responsavel);
            } catch (final ViewHelperException e) {
                throw new UsuarioControllerException("mensagem.erro.enviar.email.servidor", responsavel, e);
            }
        }
    }

    /**
     * Envia ao usuário de outras entidades que não servidor um link para reinicializar a senha no auto desbloqueio
     * @param usuLogin login do usuário
     * @param link Link para recuperar senha
     * @param codigo Codigo para verificação do usuario
     * @param responsavel Responsável
     * @throws UsuarioControllerException
     */
    @Override
    public void enviaLinkReinicializarSenhaUsuAutoDesbloqueio(String usuLogin, String link, String codigo, AcessoSistema responsavel) throws UsuarioControllerException {
        String emailDestinatario = null;

        final ObtemUsuarioQuery query = new ObtemUsuarioQuery();

        query.usuLogin = usuLogin;
        link = link + "&tipo=recuperar&cod_recuperar=" + codigo + "&autodesbloqueio=true";

        List<TransferObject> usuarios = null;
        try {
            usuarios = query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.recuperar.email.usuario", responsavel, e);
        }

        if ((usuarios != null) && (usuarios.size() == 1)) {
            emailDestinatario = (String) usuarios.get(0).getAttribute(Columns.USU_EMAIL);
        } else {
            throw new UsuarioControllerException("mensagem.erro.recuperar.email.usuario", responsavel);
        }

        if (!TextHelper.isNull(emailDestinatario)) {
            try {
                EnviaEmailHelper.enviarEmailLinkRecuperarSenhaAutoDesbloqueio(emailDestinatario, null, link, responsavel);
            } catch (final ViewHelperException e) {
                throw new UsuarioControllerException(e);
            }
        }
    }

    @Override
    public List<TransferObject> lstStatusLogin(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaStatusLoginQuery query = new ListaStatusLoginQuery();
            return query.executarDTO();
        } catch (final HQueryException e) {
            LOG.error(e.getMessage(), e);
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.encontrar.possiveis.status.login", responsavel, e);
        }
    }

    @Override
    public TransferObject obtemUsuarioTipo(String usuCodigo, String usuLogin, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemUsuarioTipoQuery query = new ObtemUsuarioTipoQuery();
            query.usuCodigo = usuCodigo;
            query.usuLogin = usuLogin;

            final List<TransferObject> lista = query.executarDTO();
            if ((lista == null) || lista.isEmpty()) {
                throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel);
            }

            return lista.get(0);
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel, e);
        }
    }

    private List<TransferObject> lstSenhasAnterioresUsuarios(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaSenhasAntigasUsuarioQuery query = new ListaSenhasAntigasUsuarioQuery();
            query.usuCodigo = usuCodigo;

            return query.executarDTO();
        } catch (final HQueryException e) {
            LOG.error(e.getMessage(), e);
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.encontrar.possiveis.status.login", responsavel, e);
        }
    }

    @Override
    public void alteraDataUltimoAcessoSistema(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final java.util.Date dataUltAcesso = DateHelper.getSystemDatetime();
            UsuarioHome.updateUsuDataUltimoAcesso(dataUltAcesso, responsavel.getUsuCodigo());
            HistoricoLoginHome.create(responsavel.getUsuCodigo(), dataUltAcesso, responsavel.getCanal());
        } catch (final UpdateException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.alterar.data.acesso.usuario", responsavel, e);
        } catch (final CreateException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e);
        }
    }

    /**
     * Lista usuários cujo período de inatividade excede o permitido via configuração de sistema
     * @param usuCodigo - caso se queira pesquisar um usuário específico. Caso contrário, informar null
     * @param dataLimiteBloqueio - data a se verificar com o limite de inatividade configurado no sisteema
     * @param responsavel - responsavel pela operação
     */
    @Override
    public List<TransferObject> listarBloqueiaUsuariosInativos(String usuCodigo, java.util.Date dataLimiteBloqueio, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuarioInativoQuery query = new ListaUsuarioInativoQuery();
            query.usuCodigo = usuCodigo;
            query.dataLimiteBloqueio = dataLimiteBloqueio;
            return query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.bloquear.usuarios.inativos.sistema", responsavel, e);
        }
    }

    /**
     * Verifica se exite servidor com CPF informado e matricula nao excluida.
     * @param serCpf CPF a ser pesquisado.
     * @param responsavel Responsavel pela operaca
     * @return Verdadeiro se existir.
     * @throws UsuarioControllerException Excecao padrao.
     */
    private boolean existeServidor(String serCpf, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaServidoresQuery query = new ListaServidoresQuery();
            query.serCpf = serCpf;
            final List<TransferObject> usuarios = query.executarDTO();
            return (usuarios != null) && (usuarios.size() > 0);
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.servidor.nao.encontrado", responsavel, e);
        }
    }

    /**
     * Obtem usuarios de CSA/COR que possuem um CPF igual ao informado pelo parâmetro "usuCpf",
     * em uma entidade diferente de (ou igual a) "tipoEntidade/codigoEntidade";
     * ou que possuem CPF igual a de algum servidor não excluído.
     * @param usuCodigo : Ignora o usuário representado por este código
     * @param usuCpf : CPF a ser pesquisado
     * @param validaServidor : Flag para validar se o servidor com mesmo CPF do usuario possui matricula não excluída.
     * @param tipoEntidade : tipo da entidade do usuário
     * @param codigoEntidade : código da entidade do usuário
     * @param mesmaEntidade :
     * @param responsavel: Responsavel pela operacao
     * @return Lista de usuarios csa/cor.
     * @throws UsuarioControllerException
     */
    private List<TransferObject> lstUsuarioCsaCor(String usuCodigo, String usuCpf, boolean validaServidor, String tipoEntidade, String codigoEntidade, boolean mesmaEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemUsuarioCsaCorQuery query = new ObtemUsuarioCsaCorQuery();
            query.tipoEntidade = tipoEntidade;
            query.codigoEntidade = codigoEntidade;
            query.mesmaEntidade = mesmaEntidade;
            query.usuCodigo = usuCodigo;
            query.usuCpf = usuCpf;
            query.validaServidor = validaServidor;
            return query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel, e);
        }
    }

    /**
     * Obtem usuarios de CSE/ORG que possuem um CPF igual ao informado pelo parâmetro "usuCpf".
     * @param usuCodigo: Ignora o usuário representado por este código
     * @param usuCpf: CPF a ser pesquisado
     * @param responsavel: Responsavel pela operacao
     * @return Lista de usuarios cse/org.
     * @throws UsuarioControllerException
     */
    private List<TransferObject> lstUsuarioCseOrg(String usuCodigo, String usuCpf, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemUsuarioCseOrgQuery query = new ObtemUsuarioCseOrgQuery();
            query.usuCodigo = usuCodigo;
            query.usuCpf = usuCpf;
            return query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel, e);
        }
    }

    /**
     * Obtem usuarios de SUPorte que possuem um CPF igual ao informado pelo parâmetro "usuCpf".
     * @param usuCodigo: Ignora o usuário representado por este código
     * @param usuCpf: CPF a ser pesquisado
     * @param responsavel: Responsavel pela operacao
     * @return Lista de usuarios suporte.
     * @throws UsuarioControllerException
     */
    private List<TransferObject> lstUsuarioSup(String usuCodigo, String usuCpf, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemUsuarioSupQuery query = new ObtemUsuarioSupQuery();
            query.usuCodigo = usuCodigo;
            query.usuCpf = usuCpf;
            return query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel, e);
        }
    }

    /**
     * Se o parametro exigir que o CPF cadastrado para um servidor não seja igual a um CPF de usuário CSA/COR ativo, esse usuário deve ser bloqueado.
     * @param serCpf CPF do servidor a ser pesquisado.
     * @param responsavel Responsavel pela operacao.
     * @throws UsuarioControllerException Excecao padrao.
     */
    @Override
    public void bloqueiaUsuarioCsaComCPFServidor(String serCpf, AcessoSistema responsavel) throws UsuarioControllerException {
        final boolean exigeUnicidadeCPF = ParamSist.getBoolParamSist(CodedValues.TPC_IMPEDE_CPF_IGUAL_ENTRE_USU_CSA_E_SER, responsavel);
        if (exigeUnicidadeCPF) {
            final List<TransferObject> usuarios = lstUsuarioCsaCor(null, serCpf, true, null, null, false, responsavel);
            for (final TransferObject to : usuarios) {
                final String usuCodigo = (String) to.getAttribute(Columns.USU_CODIGO);
                final UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
                usuario.setStuCodigo(CodedValues.STU_BLOQUEADO_POR_CSE);
                usuario.setUsuTipoBloq(ApplicationResourcesHelper.getMessage(responsavel.isSup() ? "mensagem.usuario.bloqueado.sup" : "mensagem.usuario.bloqueado.cse", responsavel));

                // Grava ocorrência de bloqueio do usuário pelo consignante
                final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                ocorrencia.setUsuCodigo(usuCodigo);
                ocorrencia.setTocCodigo(CodedValues.TOC_BLOQUEIO_USUARIO_POR_CSE);
                ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage(responsavel.isSup() ? "mensagem.ocorrencia.ous.obs.bloqueio.usuario.por.sup" : "mensagem.ocorrencia.ous.obs.bloqueio.usuario.por.cse", responsavel));
                ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

                updateUsuario(usuario, ocorrencia, responsavel);
            }
        }
    }

    /**
     * Método que encapsula verificação da obrigatoriedade de cadastro de IP na criação/atualização
     * de um usuário, assim como validação sintática do IP.
     * @param tipo
     * @param usuLogin
     * @param codigoEntidade
     * @param ipList
     * @param ddnsList
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void validaIpAcessoResponsavel(String tipo, String usuLogin, String codigoEntidade, String ipList, String ddnsList, AcessoSistema responsavel) throws UsuarioControllerException {
        // Confere se cadastro de IPs (ou DDNS) de acesso é obrigatório de acordo com o tipo da entidade
        if (AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_ORG.equals(tipo) || AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
            final boolean paramExigeIpAcesso = ParamSist.getBoolParamSist(CodedValues.TPC_EXIGE_CADASTRO_IP_CSE_ORG, responsavel);
            final boolean paramVerificaIpAcesso = ParamSist.getBoolParamSist(CodedValues.TPC_VERIFICA_CADASTRO_IP_CSE_ORG, responsavel);
            final boolean paramCadUsuSobrepoeGeral = !ParamSist.paramEquals(CodedValues.TPC_ENDERECO_ACESSO_USU_SOBREPOE_CSE_ORG, CodedValues.TPC_NAO, responsavel);

            // Se um dos parametros 223 ou 225 for SIM, entao deve exigir o cadastro de IP
            final boolean exigeIpAcesso = paramExigeIpAcesso || paramVerificaIpAcesso;

            if (exigeIpAcesso && ((TextHelper.isNull(ipList) && TextHelper.isNull(ddnsList)) || !paramCadUsuSobrepoeGeral)) {
                try {
                    if (AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                        ConsignanteTransferObject cse = null;
                        try {
                            cse = consignanteController.findConsignante(codigoEntidade, responsavel);
                        } catch (final ConsignanteControllerException ex) {
                            if (!TextHelper.isNull(usuLogin)) {
                                final CustomTransferObject usuario = findUsuario(usuLogin, responsavel);
                                final String cseCodigo = !TextHelper.isNull(usuario.getAttribute(Columns.UCE_CSE_CODIGO)) ? usuario.getAttribute(Columns.UCE_CSE_CODIGO).toString() : null;
                                if (cseCodigo != null) {
                                    cse = consignanteController.findConsignante(cseCodigo, responsavel);
                                }
                            }
                        }
                        if ((cse == null) || (TextHelper.isNull(cse.getCseIPAcesso()) && TextHelper.isNull(cse.getCseDDNSAcesso()))) {
                            throw new UsuarioControllerException("mensagem.erro.usuario.ou.sua.entidade.deve.possuir.ips.acesso.cadastrados.sistema", responsavel);
                        }
                    } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                        OrgaoTransferObject org = null;
                        try {
                            org = consignanteController.findOrgao(codigoEntidade, responsavel);
                        } catch (final ConsignanteControllerException ex) {
                            if (!TextHelper.isNull(usuLogin)) {
                                final CustomTransferObject usuario = findUsuario(usuLogin, responsavel);
                                final String orgCodigo = !TextHelper.isNull(usuario.getAttribute(Columns.UOR_ORG_CODIGO)) ? usuario.getAttribute(Columns.UOR_ORG_CODIGO).toString() : null;
                                if (orgCodigo != null) {
                                    org = consignanteController.findOrgao(orgCodigo, responsavel);
                                }
                            }
                        }
                        if ((org == null) || (TextHelper.isNull(org.getOrgIPAcesso()) && TextHelper.isNull(org.getOrgDDNSAcesso()))) {
                            throw new UsuarioControllerException("mensagem.erro.usuario.ou.sua.entidade.deve.possuir.ips.acesso.cadastrados.sistema", responsavel);
                        }
                    }
                } catch (final ConsignanteControllerException ex) {
                    throw new UsuarioControllerException(ex);
                }
            }
        } else if ((AcessoSistema.ENTIDADE_CSA.equals(tipo) || AcessoSistema.ENTIDADE_COR.equals(tipo)) && (TextHelper.isNull(ipList) && TextHelper.isNull(ddnsList))) {
            final boolean paramExigeIpAcesso = ParamSist.getBoolParamSist(CodedValues.TPC_EXIGE_CADASTRO_IP_CSA_COR, responsavel);
            final boolean paramVerificaIpAcesso = ParamSist.getBoolParamSist(CodedValues.TPC_VERIFICA_CADASTRO_IP_CSA_COR, responsavel);

            // Se um dos parametros 222 ou 224 for SIM, entao deve exigir o cadastro de IP
            boolean exigeIpAcesso = paramExigeIpAcesso || paramVerificaIpAcesso;

            try {
                // Nao da erro se tiver IP (ou DDNS) cadastrado para CSA ou COR
                if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                    CorrespondenteTransferObject cor = null;
                    try {
                        cor = consignatariaController.findCorrespondente(codigoEntidade, responsavel);
                    } catch (final ConsignatariaControllerException ex) {
                        if (!TextHelper.isNull(usuLogin)) {
                            final CustomTransferObject usuario = findUsuario(usuLogin, responsavel);
                            final String corCodigo = !TextHelper.isNull(usuario.getAttribute(Columns.UCO_COR_CODIGO)) ? usuario.getAttribute(Columns.UCO_COR_CODIGO).toString() : null;
                            if (corCodigo != null) {
                                cor = consignatariaController.findCorrespondente(corCodigo, responsavel);
                            }
                        }
                    }
                    if (cor != null) {
                        // Se o campo corExigeEnderecoAcesso estiver preenchido, ele prevalece sobre os parametros 222 e 224
                        exigeIpAcesso = cor.getCorExigeEnderecoAcesso() != null ? CodedValues.TPC_SIM.equals(cor.getCorExigeEnderecoAcesso()) : exigeIpAcesso;

                        if (exigeIpAcesso && TextHelper.isNull(cor.getCorIPAcesso()) && TextHelper.isNull(cor.getCorDDNSAcesso())) {
                            throw new UsuarioControllerException("mensagem.erro.usuario.ou.sua.entidade.deve.possuir.ips.acesso.cadastrados.sistema", responsavel);
                        }
                    }
                } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                    ConsignatariaTransferObject csa = null;
                    try {
                        csa = consignatariaController.findConsignataria(codigoEntidade, responsavel);
                    } catch (final ConsignatariaControllerException ex) {
                        if (!TextHelper.isNull(usuLogin)) {
                            final CustomTransferObject usuario = findUsuario(usuLogin, responsavel);
                            final String csaCodigo = !TextHelper.isNull(usuario.getAttribute(Columns.UCA_CSA_CODIGO)) ? usuario.getAttribute(Columns.UCA_CSA_CODIGO).toString() : null;
                            if (csaCodigo != null) {
                                csa = consignatariaController.findConsignataria(csaCodigo, responsavel);
                            }
                        }
                    }
                    if (csa != null) {
                        // Se o campo csaExigeEnderecoAcesso estiver preenchido, ele prevalece sobre os parametros 222 e 224
                        exigeIpAcesso = csa.getCsaExigeEnderecoAcesso() != null ? CodedValues.TPC_SIM.equals(csa.getCsaExigeEnderecoAcesso().toString()) : exigeIpAcesso;

                        if (exigeIpAcesso && TextHelper.isNull(csa.getCsaIPAcesso()) && TextHelper.isNull(csa.getCsaDDNSAcesso())) {
                            throw new UsuarioControllerException("mensagem.erro.usuario.ou.sua.entidade.deve.possuir.ips.acesso.cadastrados.sistema", responsavel);
                        }
                    }
                }
            } catch (final ConsignatariaControllerException ex) {
                throw new UsuarioControllerException(ex);
            }
        }

        if (!TextHelper.isNull(ipList)) {
            final List<String> ipsAcesso = Arrays.asList(ipList.split(";"));
            if (!JspHelper.validaListaIps(ipsAcesso)) {
                throw new UsuarioControllerException("mensagem.erro.endereco.ip.invalido", responsavel);
            }
        }
    }

    @Override
    public List<TransferObject> lstFuncoesPermitidasUsuario(String tipo, String codigoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        return lstFuncoesPermitidas(tipo, false, codigoEntidade, responsavel);
    }

    @Override
    public List<TransferObject> lstFuncoesPermitidasPerfil(String tipo, String codigoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        return lstFuncoesPermitidas(tipo, true, codigoEntidade, responsavel);
    }

    private List<TransferObject> lstFuncoesPermitidas(String tipo, boolean isPerfil, String codigoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        final boolean isAdministrador = responsavel.temPermissao(CodedValues.FUN_USUARIO_ADMINISTRADOR);

        final List<TransferObject> funcoesPermitidas = new ArrayList<>();

        String ncaCodigo = null;

        // recupera a natureza da consignataria para filtrar as funções que são restritas para essa natureza
        if (!TextHelper.isNull(codigoEntidade)) {
            ConsignatariaTransferObject csa = null;
            CorrespondenteTransferObject cor = null;
            if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                try {
                    csa = consignatariaController.findConsignataria(codigoEntidade, responsavel);
                    ncaCodigo = csa.getCsaNcaNatureza();
                } catch (final ConsignatariaControllerException ex) {
                    throw new UsuarioControllerException(ex);
                }
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                try {
                    cor = consignatariaController.findCorrespondente(codigoEntidade, responsavel);
                    csa = consignatariaController.findConsignataria(cor.getCsaCodigo(), responsavel);
                    ncaCodigo = csa.getCsaNcaNatureza();
                } catch (final ConsignatariaControllerException ex) {
                    throw new UsuarioControllerException(ex);
                }
            }
        }

        List<String> funcoesPermitidasNca = null;
        if (!TextHelper.isNull(ncaCodigo)) {
            funcoesPermitidasNca = selectFuncoesPermitidasNca(ncaCodigo, responsavel);
        }

        final List<TransferObject> funcoes = selectFuncoes(tipo, responsavel);
        for (final TransferObject to : funcoes) {
            final String funCodigo = (String) to.getAttribute(Columns.FUN_CODIGO);
            final String grfCodigo = (String) to.getAttribute(Columns.FUN_GRF_CODIGO);
            final String funRestritaNca = (String) to.getAttribute(Columns.FUN_RESTRITA_NCA);

            // Verifica se a função pode ser associada a um perfil
            if (isPerfil && CodedValues.FUNCOES_NAO_PERMITIDAS_PERFIL.contains(funCodigo)) {
                continue;
            }

            // Verifica se a função é de grupo administrador: só exibe para usuários administradores
            if (!TextHelper.isNull(grfCodigo) && CodedValues.GRUPO_FUNCAO_ADMINISTRADOR.equals(grfCodigo) && !isAdministrador) {
                continue;
            }

            // Verifica se as funções são restritas por natureza de consignatária quando o tipo for CSA ou COR
            // caso sejam, verifica se a CSA/COR tem permissão para utilizar a função
            if ((AcessoSistema.ENTIDADE_CSA.equals(tipo) || AcessoSistema.ENTIDADE_COR.equals(tipo)) && "S".equals(funRestritaNca)) {
                if ((funcoesPermitidasNca == null) || funcoesPermitidasNca.isEmpty() || !funcoesPermitidasNca.contains(funCodigo)) {
                    continue;
                }
            }

            // Se usuário de CSE, ou o tipo do usuário não é o mesmo, ou tem permissão para a função, então é permitida
            if (responsavel.isCseSup() || !responsavel.getTipoEntidade().equalsIgnoreCase(tipo) || responsavel.temPermissao(funCodigo)) {
                funcoesPermitidas.add(to);
            }
        }

        return funcoesPermitidas;
    }

    @Override
    public List<TransferObject> lstUsuarioCriadoRecursivoPorResponsavel(List<String> usuCodigos, AcessoSistema responsavel) throws UsuarioControllerException {
        List<TransferObject> retorno = new ArrayList<>();
        retorno = lstUsuarioCriadoPorResponsavel(usuCodigos, responsavel);

        if ((retorno != null) && !retorno.isEmpty()) {
            final List<String> codigos = new ArrayList<>();
            for (final TransferObject to : retorno) {
                codigos.add(to.getAttribute(Columns.USU_CODIGO).toString());
            }
            retorno.addAll(lstUsuarioCriadoRecursivoPorResponsavel(codigos, responsavel));
        }

        return retorno;
    }

    @Override
    public List<TransferObject> lstUsuarioCriadoPorResponsavel(List<String> usuCodigos, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuarioCriadoPorResponsavelQuery query = new ListaUsuarioCriadoPorResponsavelQuery();
            query.responsaveis = usuCodigos;
            return query.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.localizar.usuarios.criados.pelo.responsavel", responsavel, e);
        }
    }

    @Override
    public void bloquearDesbloquearUsuario(String usuCodigo, String status, String tipo, String tmoCodigo, String ousObs, AcessoSistema responsavel) throws UsuarioControllerException {
        bloquearDesbloquearUsuario(usuCodigo, status, tipo, tmoCodigo, ousObs, responsavel, true);
    }

    @Override
    public void bloquearDesbloquearUsuario(String usuCodigo, String status, String tipo, String tmoCodigo, String ousObs, AcessoSistema responsavel, Boolean validarCpf) throws UsuarioControllerException {
        final UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        usuario.setStuCodigo(status);
        if (CodedValues.STU_ATIVO.equals(status)) {
            usuario.setUsuTipoBloq("");
        }

        final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
        ocorrencia.setUsuCodigo(usuCodigo);
        ocorrencia.setTocCodigo(CodedValues.STU_ATIVO.equals(status) ? CodedValues.TOC_DESBLOQUEIO_USUARIO : responsavel.isCseSup() ? CodedValues.TOC_BLOQUEIO_USUARIO_POR_CSE : CodedValues.TOC_BLOQUEIO_USUARIO);
        ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
        ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage(CodedValues.STU_ATIVO.equals(status) ? "mensagem.ocorrencia.ous.obs.desbloqueio.usuario" : responsavel.isSup() ? "mensagem.ocorrencia.ous.obs.bloqueio.usuario.por.sup" : responsavel.isCse() ? "mensagem.ocorrencia.ous.obs.bloqueio.usuario.por.cse" : "mensagem.ocorrencia.ous.obs.bloqueio.usuario", responsavel));
        ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

        TransferObject tmo = null;
        // Verifica motivo da operação
        if (!TextHelper.isNull(tmoCodigo)) {
            tmo = new CustomTransferObject();
            tmo.setAttribute(Columns.USU_CODIGO, usuCodigo);
            tmo.setAttribute(Columns.TMO_CODIGO, tmoCodigo);
            tmo.setAttribute(Columns.OUS_OBS, ousObs);
        }

        updateUsuario(usuario, ocorrencia, null, null, tipo, null, tmo, responsavel, validarCpf);
    }

    @Override
    public void bloquearDesbloquearUsuario(List<TransferObject> usuarios, String status, String tmoCodigo, String ousObs, AcessoSistema responsavel) throws UsuarioControllerException {
        for (final TransferObject usuario : usuarios) {
            bloquearDesbloquearUsuario(usuario.getAttribute(Columns.USU_CODIGO).toString(), status, usuario.getAttribute("TIPO").toString(), tmoCodigo, ousObs, responsavel);
        }
    }

    @Override
    public void bloquearUsuarioMotivoSeguranca(String usuCodigo, String entidadeOperada, String operacao, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            // Monta texto a ser inserido no log de segurança contendo: funcao, entidade e operacao, caso venha a ser bloqueado
            String textoDoLog = "";

            // funcao
            if (!TextHelper.isNull(responsavel.getFunCodigo())) {
                final Funcao funcao = FuncaoHome.findByPrimaryKey(responsavel.getFunCodigo());
                textoDoLog += ApplicationResourcesHelper.getMessage("rotulo.log.funcao", responsavel) + ": " + funcao.getFunDescricao() + "; ";
            }
            // entidade
            if (!TextHelper.isNull(entidadeOperada)) {
                final TipoEntidade tipoEntidade = TipoEntidadeHome.findByPrimaryKey(entidadeOperada);
                textoDoLog += ApplicationResourcesHelper.getMessage("rotulo.log.entidade", responsavel) + ": " + tipoEntidade.getTenDescricao() + "; ";
            }
            // operação
            if (!TextHelper.isNull(operacao)) {
                textoDoLog += ApplicationResourcesHelper.getMessage("rotulo.log.acao", responsavel) + ": " + operacao;
            }

            String motivoDoBloqueio = "";
            if (!TextHelper.isNull(textoDoLog)) {
                motivoDoBloqueio = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.bloqueio.automatico.usuario.seguranca.arg0", responsavel, textoDoLog);
            } else {
                motivoDoBloqueio = ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.bloqueio.automatico.usuario.seguranca", responsavel);
            }

            // Se o limite foi alcançado, então bloqueia o usuário
            final UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
            usuario.setStuCodigo(CodedValues.STU_BLOQUEADO_AUTOMATICAMENTE_SEGURANCA);
            usuario.setUsuTipoBloq(ApplicationResourcesHelper.getMessage("mensagem.usuario.bloqueado.automaticamente.seguranca", responsavel));

            // Grava ocorrência de bloqueio automático do usuário
            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setUsuCodigo(usuCodigo);
            ocorrencia.setTocCodigo(CodedValues.TOC_BLOQUEIO_AUTOMATICO_USUARIO);
            ocorrencia.setOusUsuCodigo(AcessoSistema.getAcessoUsuarioSistema().getUsuCodigo());
            ocorrencia.setOusObs(motivoDoBloqueio);
            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

            updateUsuario(usuario, ocorrencia, responsavel);
        } catch (final FindException ex) {
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public void aprovarCadastroUsuarioSer(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        final UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        usuario.setStuCodigo(CodedValues.STU_ATIVO);
        usuario.setUsuTipoBloq("");

        final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
        ocorrencia.setUsuCodigo(usuCodigo);
        ocorrencia.setTocCodigo(CodedValues.TOC_APROVACAO_CADASTRO_USUARIO_SER);
        ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
        ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.aprovacao.cadastro.usuario.ser", responsavel));
        ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

        updateUsuario(usuario, ocorrencia, null, null, AcessoSistema.ENTIDADE_SER, null, null, responsavel, false);
    }

    @Override
    public Map<String, List<TransferObject>> lstUsuarioAuditorEntidade(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuarioAuditorEntidadeQuery query = new ListaUsuarioAuditorEntidadeQuery();
            final List<TransferObject> lista = query.executarDTO();

            final Map<String, List<TransferObject>> retorno = new HashMap<>();
            if ((lista != null) && !lista.isEmpty()) {
                for (final TransferObject to : lista) {
                    final String codigoEntidade = to.getAttribute("CODIGO_ENTIDADE").toString();
                    final String tipoEntidade = to.getAttribute("TIPO_ENTIDADE").toString();
                    final String chave = tipoEntidade + "|" + codigoEntidade;
                    List<TransferObject> valores = retorno.get(chave);
                    if (valores == null) {
                        valores = new ArrayList<>();
                        retorno.put(chave, valores);
                    }
                    valores.add(to);
                }
            }

            return retorno;
        } catch (final HQueryException e) {
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e);
        }
    }

    @Override
    public List<TransferObject> lstFuncoesAuditaveis(String tipo, String codigoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        final ListaFuncoesAuditaveisPapelQuery lstFuncAuditaveis = new ListaFuncoesAuditaveisPapelQuery();

        lstFuncAuditaveis.tipo = tipo;
        lstFuncAuditaveis.codigoEntidade = codigoEntidade;

        final String papelResponsavel = AcessoSistema.ENTIDADE_CSE.equals(responsavel.getTipoEntidade()) ? CodedValues.PAP_CONSIGNANTE : AcessoSistema.ENTIDADE_CSA.equals(responsavel.getTipoEntidade()) ? CodedValues.PAP_CONSIGNATARIA : AcessoSistema.ENTIDADE_COR.equals(responsavel.getTipoEntidade()) ? CodedValues.PAP_CORRESPONDENTE : AcessoSistema.ENTIDADE_ORG.equals(responsavel.getTipoEntidade()) ? CodedValues.PAP_ORGAO : AcessoSistema.ENTIDADE_SUP.equals(responsavel.getTipoEntidade()) ? CodedValues.PAP_SUPORTE : null;

        lstFuncAuditaveis.papCodigoOrigem = papelResponsavel;

        final String papelEntidade = AcessoSistema.ENTIDADE_CSE.equals(tipo) ? CodedValues.PAP_CONSIGNANTE : AcessoSistema.ENTIDADE_CSA.equals(tipo) ? CodedValues.PAP_CONSIGNATARIA : AcessoSistema.ENTIDADE_COR.equals(tipo) ? CodedValues.PAP_CORRESPONDENTE : AcessoSistema.ENTIDADE_ORG.equals(tipo) ? CodedValues.PAP_ORGAO : AcessoSistema.ENTIDADE_SUP.equals(tipo) ? CodedValues.PAP_SUPORTE : null;

        lstFuncAuditaveis.papCodigoDestino = papelEntidade;
        lstFuncAuditaveis.usuCodigoResponsavel = responsavel.getUsuCodigo();

        final String perCodigoResnp = findUsuarioPerfil(responsavel.getUsuCodigo(), responsavel);

        if (!TextHelper.isNull(perCodigoResnp)) {
            lstFuncAuditaveis.perCodigoResponsavel = perCodigoResnp;
        }

        List<TransferObject> retorno = new ArrayList<>();
        try {
            retorno = lstFuncAuditaveis.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e);
        }

        return retorno;
    }

    @Override
    public List<UsuarioTransferObject> lstUsuariosAuditores(String tipo, String codigoEntidade, Object stuCodigo, int offset, int size, AcessoSistema responsavel) throws UsuarioControllerException {
        final ListaUsuariosAuditoresQuery usuAuditListQuery = new ListaUsuariosAuditoresQuery();
        usuAuditListQuery.tipo = tipo;
        usuAuditListQuery.codigoEntidade = codigoEntidade;
        usuAuditListQuery.stuCodigo = stuCodigo;

        if (offset != -1) {
            usuAuditListQuery.firstResult = offset;
        }

        if (size != -1) {
            usuAuditListQuery.maxResults = size;
        }

        try {
            return usuAuditListQuery.executarDTO(UsuarioTransferObject.class);
        } catch (final HQueryException e) {
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e);
        }
    }

    @Override
    public int countUsuariosAuditores(String tipo, String codigoEntidade, Object stuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        final ListaUsuariosAuditoresQuery usuAuditListQuery = new ListaUsuariosAuditoresQuery();
        usuAuditListQuery.tipo = tipo;
        usuAuditListQuery.codigoEntidade = codigoEntidade;
        usuAuditListQuery.stuCodigo = stuCodigo;
        usuAuditListQuery.count = true;

        try {
            return usuAuditListQuery.executarContador();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, e);
        }
    }

    @Override
    public void updateFuncoesAuditaveis(List<String> funcoes, String tipo, String codigoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        // LOG Verificar log que está setando funções removidas/inseridas ou perfil alterado
        LogDelegate log = null;

        //verifica se entidade possui usuários auditores. só será permitido configuração de funções auditáveis se houver pelo menos um usuário auditor
        if (funcoes != null) {
            final ListaUsuariosAuditoresQuery usuAuditoresList = new ListaUsuariosAuditoresQuery();
            usuAuditoresList.tipo = tipo;
            usuAuditoresList.codigoEntidade = codigoEntidade;
            usuAuditoresList.stuCodigo = CodedValues.STU_ATIVO;

            try {
                final List<UsuarioTransferObject> auditoresList = usuAuditoresList.executarDTO(UsuarioTransferObject.class);

                if ((auditoresList == null) || auditoresList.isEmpty()) {
                    throw new UsuarioControllerException("mensagem.erro.entidade.deve.possuir.ao.menos.um.usuario.auditor.para.configurar.auditoria", responsavel);
                } else {
                    // confere se ao menos um usuário auditor possui e-mail cadastrado
                    boolean emailCheck = false;
                    for (final UsuarioTransferObject usuAudit : auditoresList) {
                        final UsuarioTransferObject usuTO = usuAudit;
                        if (!TextHelper.isNull(usuTO.getUsuEmail())) {
                            emailCheck = true;
                            break;
                        }
                    }

                    if (!emailCheck) {
                        throw new UsuarioControllerException("mensagem.erro.entidade.deve.possuir.ao.menos.um.usuario.auditor.com.email.configurado.para.configurar.auditoria", responsavel);
                    }
                }
            } catch (final HQueryException e) {
                throw new UsuarioControllerException("mensagem.erro.consultar.usuarios.auditores", responsavel, e);
            }
        }

        Collection<String> funcAuditOld = null;

        try {
            if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                funcAuditOld = FuncaoAuditavelCseHome.findFuncoesByCseCodigo(codigoEntidade);
                log = new LogDelegate(responsavel, Log.CONSIGNANTE, Log.UPDATE, Log.LOG_INFORMACAO);
                log.setConsignante(codigoEntidade);
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                funcAuditOld = FuncaoAuditavelOrgHome.findFuncoesByOrgCodigo(codigoEntidade);
                log = new LogDelegate(responsavel, Log.ORGAO, Log.UPDATE, Log.LOG_INFORMACAO);
                log.setOrgao(codigoEntidade);
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                funcAuditOld = FuncaoAuditavelCsaHome.findFuncoesByCsaCodigo(codigoEntidade);
                log = new LogDelegate(responsavel, Log.CONSIGNATARIA, Log.UPDATE, Log.LOG_INFORMACAO);
                log.setConsignataria(codigoEntidade);
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                funcAuditOld = FuncaoAuditavelCorHome.findFuncoesByCorCodigo(codigoEntidade);
                log = new LogDelegate(responsavel, Log.CORRESPONDENTE, Log.UPDATE, Log.LOG_INFORMACAO);
                log.setCorrespondente(codigoEntidade);
            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                funcAuditOld = FuncaoAuditavelSupHome.findFuncoesByCseCodigo(codigoEntidade);
                log = new LogDelegate(responsavel, Log.CONSIGNANTE, Log.UPDATE, Log.LOG_INFORMACAO);
                log.setConsignante(codigoEntidade);
            }
        } catch (final FindException e) {
            LOG.error(e.getMessage(), e);
            throw new UsuarioControllerException("mensagem.erro.entidade.nao.encontrada", responsavel, e);
        }

        final List<String> diff = new ArrayList<>();
        final List<String> excluir = new ArrayList<>();

        for (final String funcaoOld : funcAuditOld) {
            if ((funcoes == null) || !funcoes.contains(funcaoOld)) {
                excluir.add(funcaoOld);
            }
        }

        if (funcoes != null) {
            for (final String funcaoCorrente : funcoes) {
                if (!funcAuditOld.contains(funcaoCorrente)) {
                    diff.add(funcaoCorrente);
                }
            }
        }

        try {
            if (!diff.isEmpty()) {
                createFuncaoAuditavel(diff, codigoEntidade, tipo);
                log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.configurando.auditoria.para.permissoes.arg0", responsavel, TextHelper.join(diff, ",")));
            }

            if (!excluir.isEmpty()) {
                removeFuncoesAuditaveis(excluir, codigoEntidade, tipo);
                log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.removendo.configuracoes.auditoria.para.permissoes.arg0", responsavel, TextHelper.join(excluir, ",")));
            }
            log.write();
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    private void createFuncaoAuditavel(List<String> funcoes, String codigoEntidade, String tipo) throws UsuarioControllerException {
        for (final String funcao : funcoes) {
            try {
                if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                    FuncaoAuditavelCseHome.create(codigoEntidade, funcao);
                } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                    FuncaoAuditavelOrgHome.create(codigoEntidade, funcao);
                } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                    FuncaoAuditavelCsaHome.create(codigoEntidade, funcao);
                } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                    FuncaoAuditavelCorHome.create(codigoEntidade, funcao);
                } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                    FuncaoAuditavelSupHome.create(codigoEntidade, funcao);
                }
            } catch (final CreateException ex) {
                LOG.error(ex.getMessage(), ex);
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.configurar.auditoria.para.esta.entidade.erro.interno.arg0", (AcessoSistema) null, ex.getMessage());
            }
        }
    }

    private void removeFuncoesAuditaveis(List<String> funcoes, String codigoEntidade, String tipo) throws UsuarioControllerException {
        try {
            if (AcessoSistema.ENTIDADE_CSE.equals(tipo)) {
                final Collection<FuncaoAuditavelCse> funcAuditaveis = FuncaoAuditavelCseHome.findByCseCodigo(codigoEntidade);
                for (final FuncaoAuditavelCse funAudit : funcAuditaveis) {
                    if (funcoes.contains(funAudit.getFunCodigo())) {
                        AbstractEntityHome.remove(funAudit);
                    }
                }
            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipo)) {
                final Collection<FuncaoAuditavelOrg> funcAuditaveis = FuncaoAuditavelOrgHome.findByOrgCodigo(codigoEntidade);
                for (final FuncaoAuditavelOrg funAudit : funcAuditaveis) {
                    if (funcoes.contains(funAudit.getFunCodigo())) {
                        AbstractEntityHome.remove(funAudit);
                    }
                }
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo)) {
                final Collection<FuncaoAuditavelCsa> funcAuditaveis = FuncaoAuditavelCsaHome.findByCsaCodigo(codigoEntidade);
                for (final FuncaoAuditavelCsa funAudit : funcAuditaveis) {
                    if (funcoes.contains(funAudit.getFunCodigo())) {
                        AbstractEntityHome.remove(funAudit);
                    }
                }
            } else if (AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                final Collection<FuncaoAuditavelCor> funcAuditaveis = FuncaoAuditavelCorHome.findByCorCodigo(codigoEntidade);
                for (final FuncaoAuditavelCor funAudit : funcAuditaveis) {
                    if (funcoes.contains(funAudit.getFunCodigo())) {
                        AbstractEntityHome.remove(funAudit);
                    }
                }
            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                final Collection<FuncaoAuditavelSup> funcAuditaveis = FuncaoAuditavelSupHome.findByCseCodigo(codigoEntidade);
                for (final FuncaoAuditavelSup funAudit : funcAuditaveis) {
                    if (funcoes.contains(funAudit.getFunCodigo())) {
                        AbstractEntityHome.remove(funAudit);
                    }
                }
            }
        } catch (FindException | RemoveException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.remover.configuracoes.auditoria.para.esta.entidade.erro.interno.arg0", (AcessoSistema) null, ex.getMessage());
        }

    }

    /**
     * gera novas senhas para usuários servidores ativos ou recém criados, de acordo com param.
     * de sistema 348, e gera arquivo compactado protegido por senha com usuários alterados.
     * @throws UsuarioControllerException
     * @return a senha plana do arquivo ZIP com os dados para exportação
     */
    @Override
    public String gerarSenhasUsuServidores(AcessoSistema responsavel) throws UsuarioControllerException {
        final String dia = DateHelper.format(new java.util.Date(), "dd-MM-yyyy");

        //Diretório raiz de arquivos eConsig
        final String absolutePath = ParamSist.getDiretorioRaizArquivos();

        final String pathConf = absolutePath + File.separatorChar + "conf";
        final String pathSaida = absolutePath + File.separatorChar + "senhaservidores";

        final File dirArqSenhas = new File(pathSaida);
        final File[] arqSenhas = dirArqSenhas.listFiles();

        // deleta qualquer arquivo de senhas geradas anteriormente no diretório
        if (arqSenhas != null) {
            for (final File arquivo : arqSenhas) {
                arquivo.delete();
            }
        }

        final Object paramValue = ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MAX_SENHA_SERVIDOR, responsavel);
        final int tamanhoSenha = paramValue != null ? Integer.parseInt(paramValue.toString()) : 8;

        // Arquivos de configuração para geração de senhas de servidores
        final String nomeArqConfSaida = "senhas_servidores_saida.xml";
        final String nomeArqConfTradutor = "senhas_servidores_tradutor.xml";

        //Arquivos de configuração default
        final String nomeArqConfSaidaDefault = pathConf + File.separatorChar + nomeArqConfSaida;
        final String nomeArqConfTradutorDefault = pathConf + File.separatorChar + nomeArqConfTradutor;

        if (!new File(nomeArqConfSaidaDefault).exists() || !new File(nomeArqConfTradutorDefault).exists()) {
            throw new UsuarioControllerException("mensagem.erro.arquivos.configuracao.layout.geracao.novas.senhas.ausentes.ou.incorretos", responsavel);
        }

        final boolean todosUsuAtivos = ParamSist.getBoolParamSist(CodedValues.TPC_GERAR_SENHA_TODOS_USU_SER_ATIVOS, responsavel);

        // define se o filtro é para todos usuários ativos ou apenas para os novos usuários
        String arqPrefix = null;
        String harObs = null;
        if (todosUsuAtivos) {
            harObs = ApplicationResourcesHelper.getMessage("mensagem.erro.novas.senhas.geradas.para.todos.servidores", responsavel);
            arqPrefix = "usuarios_" + ApplicationResourcesHelper.getMessage("rotulo.servidor.plural", responsavel) + "_ativos";
        } else {
            harObs = ApplicationResourcesHelper.getMessage("mensagem.erro.novas.senhas.geradas.para.novos.usuarios.servidores", responsavel);
            arqPrefix = "novos_usuarios_" + ApplicationResourcesHelper.getMessage("rotulo.servidor.plural", responsavel);
        }

        // Substitui caracteres inválidos em nomes de arquivos:  / \ : * ? " < > |
        arqPrefix = arqPrefix.replaceAll("[/|\\\\|:|*|?|\"|<|>|\\|| ]", "_");

        final String nomeArqSaida = pathSaida + File.separator + "novas_senhas_" + arqPrefix + "_" + dia + ".txt";

        //escritor temporário que armazenará os dados da linha da tabela usuário e
        //processar a geração da nova senha
        final HashMap<String, Object> camposLinha = new HashMap<>();
        EscritorMemoria escritor = new EscritorMemoria(camposLinha);

        EscritorArquivoTexto escritorFinal = null;
        try {
            escritorFinal = new EscritorArquivoTexto(nomeArqConfSaidaDefault, nomeArqSaida);
        } catch (final Exception fex) {
            LOG.error(fex.getMessage(), fex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, fex);
        }

        Tradutor tradutor = null;
        try {
            final ListaUsuarioServidorNovaSenhaQuery query = new ListaUsuarioServidorNovaSenhaQuery();
            query.todosUsuAtivos = todosUsuAtivos;
            final List<TransferObject> usuServidoresNovaSenha = query.executarDTO();

            // Cache usado para otimizar
            final HashMap<String, TransferObject> usuariosMap = new HashMap<>();
            for (final TransferObject usuario : usuServidoresNovaSenha) {
                usuariosMap.put((String) usuario.getAttribute("USU_CODIGO"), usuario);
            }

            final Leitor leitor = new LeitorListTO(usuServidoresNovaSenha);
            tradutor = new Tradutor(nomeArqConfTradutorDefault, leitor, escritor);
            tradutor.iniciaTraducao(false);
            escritorFinal.iniciaEscrita();

            boolean temRegistro = false;
            while (tradutor.traduzProximo()) {
                temRegistro = true;
                // gera a nova senha para a entidade usuário
                final boolean senhaNumerica = ParamSist.paramEquals(CodedValues.TPC_SENHA_CONS_SERVIDOR_SOMENTE_NUMERICA, CodedValues.TPC_SIM, AcessoSistema.getAcessoUsuarioSistema());
                final String novaSenha = senhaNumerica ? GeradorSenhaUtil.getPasswordNumber(tamanhoSenha, responsavel) : GeradorSenhaUtil.getPassword(tamanhoSenha, AcessoSistema.ENTIDADE_SER, responsavel);

                camposLinha.put("USU_NOVA_SENHA", novaSenha);

                if (TextHelper.isNull(camposLinha.get("USU_CODIGO"))) {
                    LOG.error("Campo USU_CODIGO obrigatório no XML tradutor da geração de arquivo de exportação de senhas de usuários " + ApplicationResourcesHelper.getMessage("rotulo.servidor.plural", responsavel) + ".");
                    throw new UsuarioControllerException("mensagem.erro.arquivo.configuracao.exportacao.novas.senhas.usuarios.servidores.incorreto", responsavel);
                }

                final String usuCodigo = (String) camposLinha.get("USU_CODIGO");
                final TransferObject usuTo = usuariosMap.get(usuCodigo);
                final String senhaNovaCrypt = SenhaHelper.criptografarSenha((String) usuTo.getAttribute(Columns.USU_LOGIN), novaSenha, true, responsavel);

                UsuarioHome.updateUsuNovaSenha(senhaNovaCrypt, usuCodigo);

                final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                ocorrencia.setUsuCodigo(usuCodigo);
                ocorrencia.setTocCodigo(CodedValues.TOC_GERACAO_NOVA_SENHA);
                ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage(todosUsuAtivos ? "mensagem.informacao.geracao.senhas.para.servidores.ativos" : "mensagem.informacao.geracao.senhas.para.novos.usuarios.servidores", responsavel));
                ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

                createOcorrenciaUsuario(ocorrencia, responsavel);

                final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.GERAR_NOVA_SENHA, Log.LOG_INFORMACAO);
                log.setUsuario(usuCodigo);
                log.write();

                escritorFinal.escreve(camposLinha);

                // limpa o escritor para os dados da próxima linha
                escritor.iniciaEscrita();
            }

            if (temRegistro) {
                escritorFinal.encerraEscrita();
                escritorFinal = null;
                escritor.encerraEscrita();
                escritor = null;
                tradutor.encerraTraducao();
                tradutor = null;

                // gera histórico do arquivo de senhas de usuário servidores
                final String harResultado = CodedValues.STS_ATIVO.toString();
                final TipoArquivoEnum tipoArquivo = TipoArquivoEnum.ARQUIVO_SENHAS_SERVIDORES;
                historicoArquivoController.createHistoricoArquivo(null, null, tipoArquivo, nomeArqSaida, harObs, null, null, harResultado, responsavel);

                // comprime e encripta arquivo gerado para exportação
                final File arqNovasSenhas = new File(nomeArqSaida);
                final File arqComprimido = new File(pathSaida + File.separator + "novas_senhas_" + arqPrefix + "_" + dia + ".zip");
                final String senhaZip = GeradorSenhaUtil.getPassword(tamanhoSenha, AcessoSistema.ENTIDADE_SER, responsavel);
                FileHelper.zipAndEncrypt(arqNovasSenhas, arqComprimido, senhaZip);
                arqNovasSenhas.delete();

                return senhaZip;
            } else {
                throw new UsuarioControllerException("mensagem.nenhum.usuario.servidor.encontrado", responsavel);
            }

        } catch (final UpdateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.alterar.usuario", responsavel, ex);
        } catch (ParserException | IOException | LogControllerException | HistoricoArquivoControllerException | DAOException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        } finally {
            try {
                if (escritorFinal != null) {
                    escritorFinal.encerraEscrita();
                }
                if (escritor != null) {
                    escritor.encerraEscrita();
                }
                if (tradutor != null) {
                    tradutor.encerraTraducao();
                }
            } catch (final ParserException ex) {
                LOG.error(ex.getMessage(), ex);
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
            }
        }
    }

    /**
     * Ativar as senhas geradas automaticamente e armazenadas no campo USU_NOVA_SENHA, tornando-as a senha oficial dos
     * respectivos usuários servidores
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void ativarSenhasUsuServidores(AcessoSistema responsavel) throws UsuarioControllerException {
        final ParamSist ps = ParamSist.getInstance();
        // Diretório raiz de arquivos eConsig
        final String absolutePath = ParamSist.getDiretorioRaizArquivos();

        final String pathArquivos = absolutePath + File.separatorChar + "senhaservidores";

        final File dirArqSenhas = new File(pathArquivos);
        final File[] arqSenhas = dirArqSenhas.listFiles();

        if ((arqSenhas == null) || (arqSenhas.length == 0)) {
            throw new UsuarioControllerException("mensagem.erro.nenhum.arquivo.com.informacao.senhas.encontrado", responsavel);
        }

        final ListaUsuariosComNovaSenhaQuery servidoresList = new ListaUsuariosComNovaSenhaQuery();

        int diasParaExpiracaoNovaSenha = 0;
        try {
            diasParaExpiracaoNovaSenha = Integer.parseInt(ps.getParam(CodedValues.TPC_DIAS_EXPIRACAO_NOVA_SENHA_SERVIDOR, responsavel).toString());
        } catch (final Exception ex) {
            diasParaExpiracaoNovaSenha = 0;
        }

        try {
            final List<TransferObject> usuTo = servidoresList.executarDTO();

            for (final TransferObject servidorTo : usuTo) {
                final String usuCodigo = (String) servidorTo.getAttribute(Columns.USU_CODIGO);

                // configura o dia para expiração da senha, de acordo com parâmetro.
                java.util.Date usuDataExpSenha = null;
                if (diasParaExpiracaoNovaSenha > 0) {
                    usuDataExpSenha = DateHelper.addDays(DateHelper.getSystemDatetime(), diasParaExpiracaoNovaSenha);
                } else {
                    usuDataExpSenha = DateHelper.getSystemDatetime();
                }

                UsuarioHome.ativaUsuNovaSenha(usuDataExpSenha, usuCodigo);

                final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                ocorrencia.setUsuCodigo(usuCodigo);
                ocorrencia.setTocCodigo(CodedValues.TOC_ATIVAR_NOVA_SENHA);
                ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.informacao.ativacao.senha.para.usuario", responsavel));
                ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

                createOcorrenciaUsuario(ocorrencia, responsavel);

                final LogDelegate log = new LogDelegate(responsavel, Log.USUARIO, Log.ATIVAR_NOVA_SENHA, Log.LOG_INFORMACAO);
                log.setUsuario(usuCodigo);
                log.write();
            }

            if (arqSenhas != null) {
                for (final File arquivo : arqSenhas) {
                    arquivo.delete();
                }
            }
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.listar.usuarios.servidores", responsavel, ex);
        } catch (final UpdateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.interno.atualizar.usuario", responsavel, ex);
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> findFuncaoAuditavelPorEntidade(String codigoEntidade, String tipoEntidade, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final List<TransferObject> retorno = new ArrayList<>();
            if (AcessoSistema.ENTIDADE_CSE.equals(tipoEntidade)) {
                final Collection<FuncaoAuditavelCse> colecao = FuncaoAuditavelCseHome.findByCseCodigo(codigoEntidade);
                for (final FuncaoAuditavelCse funcaoAuditavel : colecao) {
                    final TransferObject to = new CustomTransferObject();
                    final Funcao funcao = FuncaoHome.findByPrimaryKey(funcaoAuditavel.getFuncao().getFunCodigo());
                    to.setAttribute(Columns.FUN_CODIGO, funcao.getFunCodigo());
                    to.setAttribute(Columns.FUN_DESCRICAO, funcao.getFunDescricao());
                    retorno.add(to);
                }

            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipoEntidade)) {
                final Collection<FuncaoAuditavelCsa> colecao = FuncaoAuditavelCsaHome.findByCsaCodigo(codigoEntidade);
                for (final FuncaoAuditavelCsa funcaoAuditavel : colecao) {
                    final TransferObject to = new CustomTransferObject();
                    final Funcao funcao = FuncaoHome.findByPrimaryKey(funcaoAuditavel.getFuncao().getFunCodigo());
                    to.setAttribute(Columns.FUN_CODIGO, funcao.getFunCodigo());
                    to.setAttribute(Columns.FUN_DESCRICAO, funcao.getFunDescricao());
                    retorno.add(to);
                }

            } else if (AcessoSistema.ENTIDADE_COR.equals(tipoEntidade)) {
                final Collection<FuncaoAuditavelCor> colecao = FuncaoAuditavelCorHome.findByCorCodigo(codigoEntidade);
                for (final FuncaoAuditavelCor funcaoAuditavel : colecao) {
                    final TransferObject to = new CustomTransferObject();
                    final Funcao funcao = FuncaoHome.findByPrimaryKey(funcaoAuditavel.getFuncao().getFunCodigo());
                    to.setAttribute(Columns.FUN_CODIGO, funcao.getFunCodigo());
                    to.setAttribute(Columns.FUN_DESCRICAO, funcao.getFunDescricao());
                    retorno.add(to);
                }

            } else if (AcessoSistema.ENTIDADE_ORG.equals(tipoEntidade)) {
                final Collection<FuncaoAuditavelOrg> colecao = FuncaoAuditavelOrgHome.findByOrgCodigo(codigoEntidade);
                for (final FuncaoAuditavelOrg funcaoAuditavel : colecao) {
                    final TransferObject to = new CustomTransferObject();
                    final Funcao funcao = FuncaoHome.findByPrimaryKey(funcaoAuditavel.getFuncao().getFunCodigo());
                    to.setAttribute(Columns.FUN_CODIGO, funcao.getFunCodigo());
                    to.setAttribute(Columns.FUN_DESCRICAO, funcao.getFunDescricao());
                    retorno.add(to);
                }

            } else if (AcessoSistema.ENTIDADE_SUP.equals(tipoEntidade)) {
                final Collection<FuncaoAuditavelSup> colecao = FuncaoAuditavelSupHome.findByCseCodigo(codigoEntidade);
                for (final FuncaoAuditavelSup funcaoAuditavel : colecao) {
                    final TransferObject to = new CustomTransferObject();
                    final Funcao funcao = FuncaoHome.findByPrimaryKey(funcaoAuditavel.getFuncao().getFunCodigo());
                    to.setAttribute(Columns.FUN_CODIGO, funcao.getFunCodigo());
                    to.setAttribute(Columns.FUN_DESCRICAO, funcao.getFunDescricao());
                    retorno.add(to);
                }

            }

            return retorno;
        } catch (final FindException e) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.recuperar.funcoes.auditaveis", responsavel);
        }
    }

    @Override
    public void bloqueiaUsuariosFimVigencia(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuarioFimVigenciaQuery query = new ListaUsuarioFimVigenciaQuery();
            final List<TransferObject> lista = query.executarDTO();

            for (final TransferObject to : lista) {
                final String usuCodigo = to.getAttribute(Columns.USU_CODIGO).toString();

                // Altera status do usuário para bloqueado automaticamente
                final UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
                usuario.setStuCodigo(CodedValues.STU_BLOQUEADO_AUTOMATICAMENTE_FIM_VIGENCIA);
                usuario.setUsuTipoBloq(ApplicationResourcesHelper.getMessage("mensagem.usuario.bloqueado.fim.vigencia", responsavel));

                // Grava ocorrência de bloqueio automático do usuário por fim de vigencia
                final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                ocorrencia.setUsuCodigo(usuCodigo);
                ocorrencia.setTocCodigo(CodedValues.TOC_BLOQUEIO_USUARIO_FIM_VIGENCIA);
                ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo() != null ? responsavel.getUsuCodigo() : AcessoSistema.getAcessoUsuarioSistema().getUsuCodigo());
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.bloqueio.automatico.usuario.por.fim.vig", responsavel));
                ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

                updateUsuario(usuario, ocorrencia, responsavel);
            }

        } catch (final HQueryException e) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.bloquear.usuarios.por.fim.vigencia", responsavel, e);
        } catch (final UsuarioControllerException e) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.bloquear.usuarios.por.fim.vigencia", responsavel, e);
        }
    }

    @Override
    public String gerarChaveSessaoUsuario(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final UsuarioChaveSessao usuToken = UsuarioChaveSessaoHome.findByPrimaryKey(usuCodigo);

            if (usuToken != null) {
                return UsuarioChaveSessaoHome.updateToken(usuCodigo);
            } else {
                final UsuarioChaveSessao novoToken = UsuarioChaveSessaoHome.create(usuCodigo);
                return novoToken.getUcsToken();
            }
        } catch (final FindException e) {
            UsuarioChaveSessao chaveDispositivo = null;
            try {
                chaveDispositivo = UsuarioChaveSessaoHome.create(usuCodigo);
            } catch (final CreateException e1) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException("mensagem.erro.token.usuario.criar", responsavel, e);
            }
            return chaveDispositivo.getUcsToken();
        } catch (CreateException | UpdateException e) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.token.usuario.criar", responsavel, e);
        }
    }

    @Override
    public void cadastroDeviceToken(String usuCodigo, String tdiCodigo, String deviceToken, AcessoSistema responsavel) throws UsuarioControllerException {
        UsuarioChaveDispositivo device;
        try {
            device = UsuarioChaveDispositivoHome.findByPrimaryKey(usuCodigo);
        } catch (final FindException e) {
            device = null;
        }

        try {
            if (device != null) {
                UsuarioChaveDispositivoHome.update(usuCodigo, tdiCodigo, deviceToken);
            } else {
                UsuarioChaveDispositivoHome.create(usuCodigo, tdiCodigo, deviceToken);
            }
        } catch (final UpdateException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.chave.dispositivo.atualizar", (AcessoSistema) null);
        } catch (final CreateException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.chave.dispositivo.criar", (AcessoSistema) null);
        }
    }

    @Override
    public String findDeviceToken(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final UsuarioChaveDispositivo device = UsuarioChaveDispositivoHome.findByPrimaryKey(usuCodigo);

            if (device != null) {
                return device.getUcdToken();
            }

        } catch (final FindException e) {
        }

        return null;
    }

    /**
     * Recupera um token de acesso
     * @param token
     * @return
     * @throws FindException Se não achou o token
     */
    @Override
    public UsuarioChaveSessao findUsuarioChaveSessao(String token) throws FindException {
        return UsuarioChaveSessaoHome.findByChaveSessao(token);
    }

    /**
     * Invalida/Apaga um token de acesso
     *
     * @param token
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public void deleteUsuarioChaveSessao(String usuCodigo) throws UsuarioControllerException {
        try {
            UsuarioChaveSessaoHome.delete(usuCodigo);
        } catch (final FindException e) {
            throw new UsuarioControllerException("mensagem.erro.token.usuario.invalidar", (AcessoSistema) null);
        } catch (final RemoveException e) {
            LOG.error(e.getMessage(), e);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.token.usuario.invalidar", (AcessoSistema) null);
        }
    }

    /**
     * Recupera o token e verifica se este já está expirado ou não. Se estiver expirado, apaga o token.
     * Qualquer exceção é para negar acesso.
     * @param token
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public UsuarioChaveSessao validateToken(String token) throws UsuarioControllerException {
        UsuarioChaveSessao chave;
        try {
            chave = this.findUsuarioChaveSessao(token);
        } catch (FindException e) {
            throw new UsuarioControllerException("mensagem.erro.token.expirado",
                    AcessoSistema.getAcessoUsuarioSistema());
        }

        if (isExpiredToken(chave)) {
            throw new UsuarioControllerException("mensagem.erro.token.expirado",
                    AcessoSistema.getAcessoUsuarioSistema());
        }
        
        return chave;
    }

    private boolean isExpiredToken(UsuarioChaveSessao chave) {
        Integer tempoExpiracaoToken = 600;
        String param = (String) ParamSist.getInstance().getParam(CodedValues.TPC_TEMPO_EXPIRACAO_TOKEN_ACESSO,
                AcessoSistema.getAcessoUsuarioSistema());
        
        if (!TextHelper.isNull(param)) {
            try {
                tempoExpiracaoToken = Integer.parseInt(param.toString());
            } catch (NumberFormatException e) {
            }
        }

        Calendar dataExpiracao = Calendar.getInstance();
        dataExpiracao.setTime(chave.getUcsDataCriacao());
        dataExpiracao.add(Calendar.SECOND, tempoExpiracaoToken);
        Calendar now = Calendar.getInstance();
        if (now.compareTo(dataExpiracao) > 0) {
            try {
                this.deleteUsuarioChaveSessao(chave.getUsuCodigo());
            } catch (UsuarioControllerException e) {
            }
            return true;
        }

        return false;
    }

    /**
     * Altera/Insere a imagem do perfil de um usuário
     * @throws UsuarioControllerException
     */
    @Override
    public void insereAlteraImagemUsuario(String usuCodigo, byte[] imagem, AcessoSistema responsavel) throws UsuarioControllerException {

        ArquivoUsuario arquivo;
        // Verifica o tamanho da imagem
        if (imagem.length > (5 * 1014 * 1024)) {
            throw new UsuarioControllerException("mensagem.erro.imagem.excede.tamanho.maximo", responsavel);
        }

        // Tenta recuperar a imagem corrente
        Collection<ArquivoUsuario> lstArqs = null;
        try {
            lstArqs = ArquivoUsuarioHome.findByUsuCodigoTipoArquivo(usuCodigo, TipoArquivoEnum.ARQUIVO_IMAGEM_PERFIL_USUARIO.getCodigo());
        } catch (final FindException e) {
        }
        if ((lstArqs != null) && (lstArqs.size() > 0)) {
            // Reutiliza o arquivo existente
            arquivo = (ArquivoUsuario) lstArqs.toArray()[0];
            arquivo.setAusConteudo(imagem);
            arquivo.setAusDataCriacao(new java.util.Date());
            try {
                AbstractEntityHome.update(arquivo);
            } catch (final UpdateException e) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException("mensagem.erro.gravar.imagem.usuario", responsavel);
            }
        } else {
            // Cria um novo arquivo
            try {
                arquivo = ArquivoUsuarioHome.create(TipoArquivoHome.findByPrimaryKey(TipoArquivoEnum.ARQUIVO_IMAGEM_PERFIL_USUARIO.getCodigo()), usuCodigo, imagem);
            } catch (CreateException | FindException e) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException("mensagem.erro.gravar.imagem.usuario", responsavel);
            }
        }

        // Cria ocorrência de usuário de alteração da imagem
        final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
        ocorrencia.setUsuCodigo(responsavel.getUsuCodigo());
        ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_USUARIO);
        ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
        ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.imagem", responsavel));
        ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
        createOcorrenciaUsuario(ocorrencia, responsavel);

    }

    @Override
    public Map<String, Object> primeiroAcesso(String id, String orgCodigo, String otp, AcessoSistema responsavel) throws UsuarioControllerException {
        // verifica se sistema valida primeiro acesso
        if (!ParamSist.getBoolParamSist(CodedValues.TPC_VALIDA_OTP_PRIMEIRO_ACESSO_USUARIO, responsavel)) {
            throw new UsuarioControllerException("mensagem.operacaoInvalida", responsavel);
        }

        if (TextHelper.isNull(id)) {
            throw new UsuarioControllerException("mensagem.informe.servidor.cpf", responsavel);
        }

        final boolean omiteCpf = ParamSist.getBoolParamSist(CodedValues.TPC_OMITE_CPF_SERVIDOR, responsavel);
        final Map<String, Object> retorno = new HashMap<>();
        String cpf = null;
        String serEmail = null;
        String serCelular = null;
        try {
            List<String> lstOrgId = null;
            if (!TextHelper.isNull(orgCodigo)) {
                lstOrgId = new ArrayList<>();
                lstOrgId.add(orgCodigo);
            }

            List<TransferObject> lstRegistroServidores = null;

            if (omiteCpf) {
                lstRegistroServidores = servidorController.lstRegistroServidorPorEmail(id, lstOrgId, AcessoSistema.getAcessoUsuarioSistema());
                cpf = servidorController.findServidorByRseCodigo(lstRegistroServidores.get(0).getAttribute(Columns.RSE_CODIGO).toString(), responsavel).getSerCpf();
            } else {
                lstRegistroServidores = servidorController.lstRegistroServidorPorCpf(id, lstOrgId, AcessoSistema.getAcessoUsuarioSistema());
                cpf = id;
            }

            if ((lstRegistroServidores != null) && !lstRegistroServidores.isEmpty()) {
                // inclusão de parâmetros de definição do tamanho da senha de servidor para serem usados na tela de primeiro acesso
                int tamMinSenhaServidor = 6;
                int tamMaxSenhaServidor = 8;
                try {
                    tamMinSenhaServidor = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MIN_SENHA_SERVIDOR, responsavel)) ? Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MIN_SENHA_SERVIDOR, responsavel).toString()) : 6;
                } catch (final Exception ex) {
                    tamMinSenhaServidor = 6;
                }
                try {
                    tamMaxSenhaServidor = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MAX_SENHA_SERVIDOR, responsavel)) ? Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MAX_SENHA_SERVIDOR, responsavel).toString()) : 8;
                } catch (final Exception ex) {
                    tamMaxSenhaServidor = 8;
                }
                retorno.put("tamMinSenhaServidor", tamMinSenhaServidor);
                retorno.put("tamMaxSenhaServidor", tamMaxSenhaServidor);
                if (!TextHelper.isNull(otp)) {
                    // se foi informado OTP, verifica se usuário possui permissão de cadastrar email e/ou celular
                    // para poder ser direcionado para interface de preenchimento destes dados.
                    try {
                        if (UsuarioHelper.primeiroAcessoSistema(cpf, lstRegistroServidores, null)) {
                            // verifica se usuário pode cadastrar email e/ou telefone
                            boolean usuPodeCadTelEmail = false;
                            boolean otpValido = false;
                            String usuCodigo = null;
                            outer: for (final TransferObject rse : lstRegistroServidores) {
                                final List<TransferObject> lstUsuResult = lstUsuariosSer(cpf, (String) rse.getAttribute(Columns.RSE_MATRICULA), (String) rse.getAttribute(Columns.EST_IDENTIFICADOR), (String) rse.getAttribute(Columns.ORG_IDENTIFICADOR), responsavel);
                                for (final TransferObject usuTO : lstUsuResult) {
                                    usuCodigo = (String) usuTO.getAttribute(Columns.USU_CODIGO);
                                    final String otpContraCheque = (String) usuTO.getAttribute(Columns.USU_NOVA_SENHA);
                                    if (TextHelper.isNull(otpContraCheque)) {
                                        continue;
                                    }

                                    // valida OTP do contracheque na base com o informado pelo usuário
                                    if (!JCrypt.verificaSenha(otp, otpContraCheque)) {
                                        // caso não tenha dado match, pode ser o otp de outra matrícula deste servidor. continua verificação então.
                                        continue;
                                    } else {
                                        otpValido = true;
                                        usuPodeCadTelEmail = usuarioTemPermissao(usuCodigo, CodedValues.FUN_EDT_SERVIDOR, AcessoSistema.ENTIDADE_SER, responsavel);
                                        final ServidorTransferObject serTO = servidorController.findServidor((String) rse.getAttribute(Columns.SER_CODIGO), responsavel);
                                        serEmail = serTO.getSerEmail();
                                        serCelular = serTO.getSerCelular();
                                        break outer;
                                    }
                                }

                            }

                            if (!otpValido) {
                                throw new UsuarioControllerException("mensagem.senha.servidor.otp.invalido", responsavel);
                            }

                            if (usuPodeCadTelEmail) {
                                retorno.put("usuCodigo", usuCodigo);
                                //Geração de token de fluxo de caso de uso a ser confirmado pela tela de retorno ao cliente
                                final String token = GeradorSenhaUtil.getPasswordNumber(CodedValues.TAM_OTP, responsavel);
                                retorno.put("token", token);

                                final UsuarioTransferObject usuTO = new UsuarioTransferObject(usuCodigo);
                                usuTO.setUsuOtpChaveSeguranca(token);
                                usuTO.setUsuCPF(cpf);
                                updateUsuario(usuTO, null, null, null, AcessoSistema.ENTIDADE_SER, null, null, responsavel);

                                retorno.put("email", serEmail);
                                retorno.put("telefone", serCelular);

                                return retorno;
                            } else {
                                throw new UsuarioControllerException("mensagem.erro.servidor.nao.autorizado", responsavel);
                            }

                        } else {
                            throw new UsuarioControllerException("mensagem.usuario.possui.cadastro.ativo", responsavel);
                        }
                    } catch (final ViewHelperException qex) {
                        LOG.error(qex.getMessage(), qex);
                        throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel);
                    }
                } else {
                    // se não foi informado otp, verifica se usuário possui email e/ou celular cadastrado
                    // para poder enviar um novo otp gerado.
                    boolean temCelular = false;
                    boolean temEmail = false;
                    TransferObject rseSelecionado = null;
                    for (final TransferObject rse : lstRegistroServidores) {
                        final RegistroServidorTO rseTO = servidorController.findRegistroServidor((String) rse.getAttribute(Columns.RSE_CODIGO), responsavel);
                        final ServidorTransferObject serTO = servidorController.findServidor(rseTO.getSerCodigo(), responsavel);
                        final List<TransferObject> lstUsuResult = lstUsuariosSer(cpf, (String) rse.getAttribute(Columns.RSE_MATRICULA), (String) rse.getAttribute(Columns.EST_IDENTIFICADOR), (String) rse.getAttribute(Columns.ORG_IDENTIFICADOR), responsavel);
                        if (!TextHelper.isNull(serTO.getSerCelular()) && !lstUsuResult.isEmpty()) {
                            temCelular = true;
                            rseSelecionado = rse;
                            serEmail = serTO.getSerEmail();
                            serCelular = serTO.getSerCelular();
                            break;
                        }
                        if (!TextHelper.isNull(serTO.getSerEmail()) && !lstUsuResult.isEmpty()) {
                            temEmail = true;
                            rseSelecionado = rse;
                            serEmail = serTO.getSerEmail();
                            serCelular = serTO.getSerCelular();
                            break;
                        }
                    }

                    if (!temCelular && !temEmail) {
                        throw new UsuarioControllerException("mensagem.senha.servidor.otp.erro.email.celular.invalido", responsavel);
                    }

                    try {
                        if (UsuarioHelper.primeiroAcessoSistema(cpf, lstRegistroServidores, null)) {
                            final List<TransferObject> lstUsuResult = lstUsuariosSer(cpf, (String) rseSelecionado.getAttribute(Columns.RSE_MATRICULA), (String) rseSelecionado.getAttribute(Columns.EST_IDENTIFICADOR), (String) rseSelecionado.getAttribute(Columns.ORG_IDENTIFICADOR), responsavel);
                            final String usuCodigo = (String) lstUsuResult.get(0).getAttribute(Columns.USU_CODIGO);
                            final String token = GeradorSenhaUtil.getPasswordNumber(CodedValues.TAM_OTP, responsavel);

                            final UsuarioTransferObject usuTO = new UsuarioTransferObject(usuCodigo);
                            usuTO.setUsuOtpChaveSeguranca(token);
                            usuTO.setUsuCPF(cpf);
                            updateUsuario(usuTO, null, null, null, AcessoSistema.ENTIDADE_SER, null, null, responsavel);

                            // Envia OTP para usuário
                            enviaOTPServidor(usuCodigo, token, null, null, AcessoSistema.getAcessoUsuarioSistema());
                            retorno.put("usuCodigo", usuCodigo);

                            retorno.put("token", token);
                            retorno.put("email", serEmail);
                            retorno.put("telefone", serCelular);

                            return retorno;
                        } else {
                            throw new UsuarioControllerException("mensagem.usuario.possui.cadastro.ativo", responsavel);
                        }
                    } catch (final ViewHelperException e) {
                        LOG.error(e.getMessage(), e);
                        throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel);
                    }
                }
            } else {
                throw new UsuarioControllerException("mensagem.erro.servidor.nao.encontrado", AcessoSistema.getAcessoUsuarioSistema());
            }
        } catch (final ServidorControllerException ex) {
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public void enviaOTPServidor(String usuCodigo, String chaveSenha, String emailOpcional, String telefoneOpcional, AcessoSistema responsavel) throws UsuarioControllerException {
        enviaOTPServidor(usuCodigo, chaveSenha, emailOpcional, telefoneOpcional, true, false, false, false, responsavel);
    }

    @Override
    public void enviaOTPServidor(String usuCodigo, String chaveSenha, String emailOpcional, String telefoneOpcional, boolean fluxoMobile, boolean fluxoAutoDesbloqueio, boolean enviaOtpEmail, boolean enviaOtpCelular, AcessoSistema responsavel) throws UsuarioControllerException {
        // Para uso do portal, não precisa validar primeiro acesso, visto que será acessado sempre usando OTP
        // ATENÇÂO: Fluxo do portal não valida alguns dados
        if (fluxoMobile) {
            final boolean primeiroAcessoOTP = ParamSist.getBoolParamSist(CodedValues.TPC_VALIDA_OTP_PRIMEIRO_ACESSO_USUARIO, responsavel);
            if (!primeiroAcessoOTP) {
                throw new UsuarioControllerException("mensagem.operacaoInvalida", responsavel);
            }
        }

        // Senha numérica com 6 dígitos
        final String otp = GeradorSenhaUtil.getPasswordNumber(CodedValues.TAM_OTP, responsavel);

        String email = emailOpcional;
        String telefone = telefoneOpcional;
        String serNome = "";

        // Buscar usuário através do usuCodigo passado
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        final Usuario usuarioBean = findUsuarioBean(usuario, AcessoSistema.ENTIDADE_SER);

        if (usuarioBean == null) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel);
        }

        try {
            final UsuarioSer usuarioSer = UsuarioSerHome.findByUsuCodigo(usuCodigo);
            final String serCodigo = usuarioSer.getServidor().getSerCodigo();
            final ServidorTransferObject servidor = servidorController.findServidor(serCodigo, responsavel);

            if (servidor == null) {
                throw new UsuarioControllerException("mensagem.erro.servidor.nao.encontrado", responsavel);
            }

            serNome = servidor.getSerNome();

            // Se possuir email cadastrado, utiliza cadastrado
            // ATENÇÂO: O portal não utiliza email
            if (fluxoMobile && !TextHelper.isNull(servidor.getSerEmail())) {
                email = servidor.getSerEmail();
            }
            // Se possuir telefone cadastrado, utiliza cadastrado
            if (!TextHelper.isNull(servidor.getSerCelular())) {
                telefone = servidor.getSerCelular();
            }

        } catch (ServidorControllerException | FindException e) {
            throw new UsuarioControllerException("mensagem.erro.servidor.nao.encontrado", responsavel);
        }

        // ATENÇÂO: Para uso do portal, não precisa validar primeiro acesso, visto que será acessado sempre usando OTP
        if (fluxoMobile) {

            // Valida se é primeiro acesso do usuário
            if (!TextHelper.isNull(usuarioBean.getUsuDataUltAcesso())) {
                throw new UsuarioControllerException("mensagem.usuario.possui.cadastro.ativo", responsavel);
            }

            // Valida se o REST primeiroAcesso (DESENV-6371) foi chamado anteriormente
            if (TextHelper.isNull(chaveSenha) || !chaveSenha.equalsIgnoreCase(usuarioBean.getUsuOtpChaveSeguranca())) {
                throw new UsuarioControllerException("mensagem.operacaoInvalida", responsavel);
            }
        }

        // Criptografa OTP antes de salvar no usuário
        final String otpCrypt = SenhaHelper.criptografarSenha(usuarioBean.getUsuLogin(), otp, true, responsavel);

        // Salva OTP gerado no campo provisório USU_CHAVE_VALIDACAO_TOTP
        usuario = this.findUsuario(usuario, AcessoSistema.ENTIDADE_SER, responsavel);
        usuario.setUsuOtpCodigo(otpCrypt);
        usuario.setUsuOtpDataCadastro(DateHelper.getSystemDatetime());

        // Cria ocorrência
        final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
        ocorrencia.setUsuCodigo(usuCodigo);
        ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
        ocorrencia.setTocCodigo(CodedValues.TOC_INCLUSAO_OTP_USUARIO);
        ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.inclusao.otp.usuario", responsavel));
        ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

        // Salva OTP no usuário
        updateUsuario(usuario, ocorrencia, responsavel);

        if (!fluxoAutoDesbloqueio) {
            if (!TextHelper.isNull(telefone)) {
                try {
                    EnviaSMSHelper.enviarSMSOTP(telefone, otp, responsavel);
                } catch (final ZetraException e) {
                    if (!TextHelper.isNull(email)) {
                        try {
                            EnviaEmailHelper.enviarEmailOTPServidor(serNome, email, otp, responsavel);
                        } catch (final ViewHelperException ex) {
                            throw new UsuarioControllerException("mensagem.erro.sms.ou.email.enviar", responsavel, ex);
                        }
                    } else {
                        throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, e);
                    }
                }
            } else if (!TextHelper.isNull(email)) {
                try {
                    EnviaEmailHelper.enviarEmailOTPServidor(serNome, email, otp, responsavel);
                } catch (final ViewHelperException e) {
                    throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel, e);
                }
            } else {
                throw new UsuarioControllerException("mensagem.operacaoInvalida", responsavel);
            }
        } else {
            final boolean recuperaSenhaSMS = ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_SERVIDOR, CodedValues.AUTO_DESBLOQUEIO_SERVIDOR_SMS, responsavel);
            final boolean recuperaSenhaSMSEmail = ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_SERVIDOR, CodedValues.AUTO_DESBLOQUEIO_SERVIDOR_EMAIL_SMS, responsavel);

            if (recuperaSenhaSMS) {
                if (!TextHelper.isNull(telefone)) {
                    try {
                        EnviaSMSHelper.enviarSMSOTP(telefone, otp, responsavel);
                    } catch (final ZetraException ex) {
                        throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, ex);
                    }
                }
            } else if (recuperaSenhaSMSEmail) {
                if (!TextHelper.isNull(telefone) && enviaOtpCelular) {
                    try {
                        EnviaSMSHelper.enviarSMSOTP(telefone, otp, responsavel);
                    } catch (final ZetraException ex) {
                        throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, ex);
                    }
                }

                if (!TextHelper.isNull(email) && enviaOtpEmail) {
                    try {
                        EnviaEmailHelper.enviarEmailOTPServidor(serNome, email, otp, responsavel);
                    } catch (final ViewHelperException e) {
                        throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel, e);
                    }
                }
            }
        }
    }

    /**
     * Realiza autenticação via OTP para o portal
     *
     * @param usuCodigo
     * @param otp
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public String validarOTPPortal(TransferObject usuario, String otp, AcessoSistema responsavel) throws UsuarioControllerException {
        if (isDataCadastroOptExpirado((java.util.Date) usuario.getAttribute(Columns.USU_OTP_DATA_CADASTRO), responsavel)) {
            throw new UsuarioControllerException("mensagem.senha.servidor.otp.expirado", responsavel);
        }

        // valida otp enviado via SMS ao usuário.
        if (TextHelper.isNull(usuario.getAttribute(Columns.USU_OTP_CODIGO)) || !JCrypt.verificaSenha(otp, (String) usuario.getAttribute(Columns.USU_OTP_CODIGO))) {
            return null;
        }

        return gerarChaveSessaoUsuario((String) usuario.getAttribute(Columns.USU_CODIGO), responsavel);

    }

    /**
     * Verifica se o OTP foi expirado
     *
     * @param responsavel
     * @param usuSer
     * @throws UsuarioControllerException
     */
    private boolean isDataCadastroOptExpirado(java.util.Date otpDataCadastro, AcessoSistema responsavel) throws UsuarioControllerException {
        // valida se o otp ainda é válido
        final int timeoutOtp = ParamSist.getIntParamSist(CodedValues.TPC_TEMPO_EXPIRACAO_OTP, 20, AcessoSistema.getAcessoUsuarioSistema());
        final java.util.Date dataAtual = new java.util.Date();
        // verifica se passou o limite do tempo em milisegundos
        if ((otpDataCadastro == null) || ((dataAtual.getTime() - otpDataCadastro.getTime()) > (timeoutOtp * (6 * Math.pow(10, 4))))) {
            return true;
        }

        return false;
    }

    /**
     * Valida OTP de primeiro acesso de servidor
     * @param usuCodigo - código do usuário servidor
     * @param novaSenha - senha digitada pelo usuário que será sua nova senha de acesso
     * @param senhaCriptografada - informa se senha está vindo criptografada ou não
     * @param otp - otp enviado por SMS ou e-mail para validação de primeiro acesso
     * @param emailOpcional
     * @param telefoneOpcional
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public List<TransferObject> validaOTPServidor(String usuCodigo, String novaSenha, boolean senhaCriptografada, String otp, String emailOpcional, String telefoneOpcional, boolean senhaApp, AcessoSistema responsavel) throws UsuarioControllerException {
        final AcessoSistema respValidacao = AcessoSistema.getAcessoUsuarioSistema();

        // verifica se sistema valida primeiro acesso
        if (!ParamSist.getBoolParamSist(CodedValues.TPC_VALIDA_OTP_PRIMEIRO_ACESSO_USUARIO, respValidacao)) {
            throw new UsuarioControllerException("mensagem.operacaoInvalida", respValidacao);
        }

        TransferObject usuSer = null;
        try {
            usuSer = pesquisarServidorController.buscaUsuarioServidor(usuCodigo, respValidacao);

            // Valida se é primeiro acesso do usuário
            if (!TextHelper.isNull(usuSer.getAttribute(Columns.USU_DATA_ULT_ACESSO))) {
                throw new UsuarioControllerException("mensagem.usuario.possui.cadastro.ativo", responsavel);
            }

            if (isDataCadastroOptExpirado((java.util.Date) usuSer.getAttribute(Columns.USU_OTP_DATA_CADASTRO), respValidacao)) {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.expirado", respValidacao);
            }

            // valida otp enviado via SMS ou email ao usuário.
            if (TextHelper.isNull(usuSer.getAttribute(Columns.USU_OTP_CODIGO)) || !JCrypt.verificaSenha(otp, (String) usuSer.getAttribute(Columns.USU_OTP_CODIGO))) {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.invalido", respValidacao);
            }

            if ((!TextHelper.isNull(emailOpcional) || !TextHelper.isNull(telefoneOpcional)) && !usuarioTemPermissao(usuCodigo, CodedValues.FUN_EDT_SERVIDOR, AcessoSistema.ENTIDADE_SER, respValidacao)) {
                throw new UsuarioControllerException("mensagem.erro.servidor.nao.autorizado", respValidacao);
            }

            // valida tamanho máximo e mínimo dos campos senha e confirmação de senha
            int tamMinSenhaServidor = 6;
            int tamMaxSenhaServidor = 8;
            try {
                tamMinSenhaServidor = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MIN_SENHA_SERVIDOR, responsavel)) ? Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MIN_SENHA_SERVIDOR, responsavel).toString()) : 6;
            } catch (final Exception ex) {
                tamMinSenhaServidor = 6;
            }
            try {
                tamMaxSenhaServidor = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MAX_SENHA_SERVIDOR, responsavel)) ? Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_TAMANHO_MAX_SENHA_SERVIDOR, responsavel).toString()) : 8;
            } catch (final Exception ex) {
                tamMaxSenhaServidor = 8;
            }
            if (TextHelper.isNull(novaSenha) || (novaSenha.length() < tamMinSenhaServidor)) {
                throw new UsuarioControllerException("mensagem.erro.cadastrar.senha.servidor.minimo", responsavel, String.valueOf(tamMinSenhaServidor));
            } else if (novaSenha.length() > tamMaxSenhaServidor) {
                throw new UsuarioControllerException("mensagem.erro.cadastrar.senha.servidor.maximo", responsavel, String.valueOf(tamMaxSenhaServidor));
            }

            // cria ocorrência de alteração de senha
            final String tocCodigoOcorrencia = CodedValues.TOC_ALTERACAO_SENHA_USUARIO;
            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setUsuCodigo(usuCodigo);
            ocorrencia.setTocCodigo(tocCodigoOcorrencia);
            ocorrencia.setOusUsuCodigo(CodedValues.USU_CODIGO_SISTEMA);
            ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.senha.usuario", respValidacao));

            //setar nova senha para todos usuários ligados a este CPF
            final List<TransferObject> lstTodosUsuarios = lstUsuariosSer((String) usuSer.getAttribute(Columns.SER_CPF), null, null, null, respValidacao);
            for (final TransferObject usuTO : lstTodosUsuarios) {
                alterarSenha((String) usuTO.getAttribute(Columns.USU_CODIGO), novaSenha, null, null, false, false, false, senhaCriptografada, null, null, false, senhaApp, null, responsavel);
            }

            if (!TextHelper.isNull(emailOpcional) || !TextHelper.isNull(telefoneOpcional)) {
                final ServidorTransferObject servidor = new ServidorTransferObject((String) usuSer.getAttribute(Columns.SER_CODIGO));
                servidor.setSerCpf((String) usuSer.getAttribute(Columns.SER_CPF));
                if (!TextHelper.isNull(emailOpcional) && TextHelper.isNull(servidor.getSerEmail())) {
                    servidor.setSerEmail(emailOpcional);
                }

                if (!TextHelper.isNull(telefoneOpcional) && TextHelper.isNull(servidor.getSerCelular())) {
                    servidor.setSerCelular(telefoneOpcional);
                }

                ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_USUARIO);
                servidorController.updateServidor(servidor, CodedValues.TOC_RSE_ALTERACAO_DADOS_CADASTRAIS, respValidacao);
            }

            // autentica usuário e retorna dados da autenticação para usuário
            return servidorController.lstRegistroServidorUsuarioSer((String) usuSer.getAttribute(Columns.USU_LOGIN), false, respValidacao);

        } catch (final ServidorControllerException e) {
            throw new UsuarioControllerException(e.getMessageKey(), respValidacao);
        }
    }


    /**
     * Envia OTP numérico de 6 dígitos para usuário por e-mail e/ou celular previamente cadastrados.
     * Os booleanos "enviarOtpEmail" e "enviarOtpCelular" indicam em qual meio o OTP deve ser enviado.
     * Por favor, não alterar o código e inserir parametrizações específicas de caso de uso. Este método
     * deve ser genérico para que seja utilizado por outras rotinas.
     * @param usuCodigo
     * @param enviarOtpEmail
     * @param enviarOtpCelular
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void enviarOtpUsuarioPorEmailOuCelular(String usuCodigo, boolean enviarOtpEmail, boolean enviarOtpCelular, AcessoSistema responsavel) throws UsuarioControllerException {
        if (!enviarOtpEmail && !enviarOtpCelular) {
            throw new UsuarioControllerException("mensagem.operacaoInvalida", responsavel);
        }

        // Buscar usuário através do usuCodigo passado
        final UsuarioTransferObject usuario = findUsuario(usuCodigo, responsavel);
        if (usuario == null) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel);
        }

        final String usuNome = usuario.getUsuNome();
        final String usuEmail = usuario.getUsuEmail();
        final String usuCelular = usuario.getUsuTel(); // TODO Criar campo para telefone celular

        // Se for para TOTP, validar se email ou telefone estão no campo USU_CHAVE_VALIDACAO_TOTP
        final String usuChaveValidacaoTotp = usuario.getUsuChaveValidacaoTotp();
        if (!TextHelper.isNull(usuChaveValidacaoTotp) && responsavel.getUsuCodigo().equals(usuCodigo)) {
            if (enviarOtpEmail) {
                if (!usuChaveValidacaoTotp.equals(TextHelper.md5(usuEmail))) {
                    throw new UsuarioControllerException("mensagem.erro.totp.chave.validacao.invalida", responsavel);
                }
            } else if (enviarOtpCelular) {
                if (!usuChaveValidacaoTotp.equals(TextHelper.md5(usuCelular))) {
                    throw new UsuarioControllerException("mensagem.erro.totp.chave.validacao.invalida", responsavel);
                }
            }
        }

        // Senha numérica com 6 dígitos
        final String otp = GeradorSenhaUtil.getPasswordNumber(CodedValues.TAM_OTP, responsavel);

        // Criptografa OTP antes de salvar no usuário
        final String otpCrypt = SenhaHelper.criptografarSenha(usuario.getUsuLogin(), otp, true, responsavel);

        // Salva OTP gerado no campo provisório USU_OTP_CODIGO
        usuario.setUsuOtpCodigo(otpCrypt);
        usuario.setUsuOtpDataCadastro(DateHelper.getSystemDatetime());

        // Cria ocorrência
        final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
        ocorrencia.setUsuCodigo(usuCodigo);
        ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
        ocorrencia.setTocCodigo(CodedValues.TOC_INCLUSAO_OTP_USUARIO);
        ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.inclusao.otp.usuario", responsavel));
        ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

        // Salva OTP no usuário
        updateUsuario(usuario, ocorrencia, responsavel);

        if (enviarOtpEmail && enviarOtpCelular) {
            if (!TextHelper.isNull(usuCelular)) {
                try {
                    EnviaSMSHelper.enviarSMSOTP(usuCelular, otp, responsavel);
                } catch (final ZetraException ex) {
                    if (!TextHelper.isNull(usuEmail)) {
                        try {
                            EnviaEmailHelper.enviarEmailOTP(usuNome, usuEmail, otp, responsavel);
                        } catch (final ViewHelperException ex2) {
                            throw new UsuarioControllerException("mensagem.erro.sms.ou.email.enviar", responsavel, ex);
                        }
                    } else {
                        throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, ex);
                    }
                }
            } else if (!TextHelper.isNull(usuEmail)) {
                try {
                    EnviaEmailHelper.enviarEmailOTP(usuNome, usuEmail, otp, responsavel);
                } catch (final ViewHelperException e) {
                    throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel, e);
                }
            } else {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.erro.email.celular.invalido", responsavel);
            }
        } else if (enviarOtpCelular) {
            if (!TextHelper.isNull(usuCelular)) {
                try {
                    EnviaSMSHelper.enviarSMSOTP(usuCelular, otp, responsavel);
                } catch (final ZetraException ex) {
                    throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, ex);
                }
            } else {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.erro.celular.invalido", responsavel);
            }
        } else if (enviarOtpEmail) {
            if (!TextHelper.isNull(usuEmail)) {
                try {
                    EnviaEmailHelper.enviarEmailOTPServidor(usuNome, usuEmail, otp, responsavel);
                } catch (final ViewHelperException e) {
                    throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel, e);
                }
            } else {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.erro.email.invalido", responsavel);
            }
        }
    }

    @Override
    public void validarOtpUsuarioEnviadoPorEmailOuCelular(String usuCodigo, String otp, AcessoSistema responsavel) throws UsuarioControllerException {
        final UsuarioTransferObject usuario = findUsuario(usuCodigo, responsavel);

        // Valida a data de expiração do otp
        if (isDataCadastroOptExpirado((java.util.Date) usuario.getAttribute(Columns.USU_OTP_DATA_CADASTRO), responsavel)) {
            throw new UsuarioControllerException("mensagem.erro.totp.informado.expirado", responsavel);
        }

        // valida otp enviado via SMS ou email ao usuário.
        if (TextHelper.isNull(usuario.getAttribute(Columns.USU_OTP_CODIGO)) || !JCrypt.verificaSenha(otp, (String) usuario.getAttribute(Columns.USU_OTP_CODIGO))) {
            throw new UsuarioControllerException("mensagem.erro.totp.informado.invalido", responsavel);
        }
    }

    /**
     * Envia OTP numérico de 6 dígitos para servidor por e-mail e/ou celular previamente cadastrados.
     * Os booleanos "enviarOtpEmail" e "enviarOtpCelular" indicam em qual meio o OTP deve ser enviado.
     * Por favor, não alterar o código e inserir parametrizações específicas de caso de uso. Este método
     * deve ser genérico para que seja utilizado por outras rotinas.
     * @param usuCodigo
     * @param enviarOtpEmail
     * @param enviarOtpCelular
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void enviarOtpServidorPorEmailOuCelular(String usuCodigo, boolean enviarOtpEmail, boolean enviarOtpCelular, AcessoSistema responsavel) throws UsuarioControllerException {
        if (!enviarOtpEmail && !enviarOtpCelular) {
            throw new UsuarioControllerException("mensagem.operacaoInvalida", responsavel);
        }

        final String serEmail;
        final String serCelular;
        final String serNome;

        // Buscar usuário através do usuCodigo passado
        UsuarioTransferObject usuario = new UsuarioTransferObject(usuCodigo);
        final Usuario usuarioBean = findUsuarioBean(usuario, AcessoSistema.ENTIDADE_SER);
        if (usuarioBean == null) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel);
        }

        try {
            final UsuarioSer usuarioSer = UsuarioSerHome.findByUsuCodigo(usuCodigo);
            final String serCodigo = usuarioSer.getServidor().getSerCodigo();
            final ServidorTransferObject servidor = servidorController.findServidor(serCodigo, responsavel);
            if (servidor == null) {
                throw new UsuarioControllerException("mensagem.erro.servidor.nao.encontrado", responsavel);
            }

            serNome = servidor.getSerNome();
            serEmail = servidor.getSerEmail();
            serCelular = servidor.getSerCelular();
        } catch (ServidorControllerException | FindException ex) {
            throw new UsuarioControllerException("mensagem.erro.servidor.nao.encontrado", responsavel, ex);
        }

        // Senha numérica com 6 dígitos
        final String otp = GeradorSenhaUtil.getPasswordNumber(CodedValues.TAM_OTP, responsavel);

        // Criptografa OTP antes de salvar no usuário
        final String otpCrypt = SenhaHelper.criptografarSenha(usuarioBean.getUsuLogin(), otp, true, responsavel);

        // Salva OTP gerado no campo provisório USU_CHAVE_VALIDACAO_TOTP
        usuario = this.findUsuario(usuario, AcessoSistema.ENTIDADE_SER, responsavel);
        usuario.setUsuOtpCodigo(otpCrypt);
        usuario.setUsuOtpDataCadastro(DateHelper.getSystemDatetime());

        // Cria ocorrência
        final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
        ocorrencia.setUsuCodigo(usuCodigo);
        ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
        ocorrencia.setTocCodigo(CodedValues.TOC_INCLUSAO_OTP_USUARIO);
        ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.inclusao.otp.usuario", responsavel));
        ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

        // Salva OTP no usuário
        updateUsuario(usuario, ocorrencia, responsavel);

        if (enviarOtpEmail && enviarOtpCelular) {
            if (!TextHelper.isNull(serCelular)) {
                try {
                    EnviaSMSHelper.enviarSMSOTP(serCelular, otp, responsavel);
                } catch (final ZetraException ex) {
                    if (!TextHelper.isNull(serEmail)) {
                        try {
                            EnviaEmailHelper.enviarEmailOTPServidor(serNome, serEmail, otp, responsavel);
                        } catch (final ViewHelperException ex2) {
                            throw new UsuarioControllerException("mensagem.erro.sms.ou.email.enviar", responsavel, ex);
                        }
                    } else {
                        throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, ex);
                    }
                }
            } else if (!TextHelper.isNull(serEmail)) {
                try {
                    EnviaEmailHelper.enviarEmailOTPServidor(serNome, serEmail, otp, responsavel);
                } catch (final ViewHelperException e) {
                    throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel, e);
                }
            } else {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.erro.email.celular.invalido", responsavel);
            }
        } else if (enviarOtpCelular) {
            if (!TextHelper.isNull(serCelular)) {
                try {
                    EnviaSMSHelper.enviarSMSOTP(serCelular, otp, responsavel);
                } catch (final ZetraException ex) {
                    throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel, ex);
                }
            } else {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.erro.celular.invalido", responsavel);
            }
        } else if (enviarOtpEmail) {
            if (!TextHelper.isNull(serEmail)) {
                try {
                    EnviaEmailHelper.enviarEmailOTPServidor(serNome, serEmail, otp, responsavel);
                } catch (final ViewHelperException e) {
                    throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel, e);
                }
            } else {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.erro.email.invalido", responsavel);
            }
        }
    }

    @Override
    public void validarOtpServidorEnviadoPorEmailOuCelular(String usuCodigo, String otp, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final TransferObject usuSer = pesquisarServidorController.buscaUsuarioServidor(usuCodigo, responsavel);

            // Valida a data de expiração do otp
            if (isDataCadastroOptExpirado((java.util.Date) usuSer.getAttribute(Columns.USU_OTP_DATA_CADASTRO), responsavel)) {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.expirado", responsavel);
            }

            // valida otp enviado via SMS ou email ao usuário.
            if (TextHelper.isNull(usuSer.getAttribute(Columns.USU_OTP_CODIGO)) || !JCrypt.verificaSenha(otp, (String) usuSer.getAttribute(Columns.USU_OTP_CODIGO))) {
                throw new UsuarioControllerException("mensagem.senha.servidor.otp.invalido", responsavel);
            }
        } catch (final ServidorControllerException ex) {
            throw new UsuarioControllerException("mensagem.erro.servidor.nao.encontrado", responsavel, ex);
        }
    }

    /**
     * Método para recuperar senha via Web.
     * @param usuCodigo : código do usuário
     * @param tipoEntidade : tipo de entidade do usuário, ex: AcessoSistema.ENTIDADE_SER
     * @param chaveRecuperarSenha : chave de recuperação de senha enviada no e-mail
     * @param senhaNova : nova senha informada pelo usuário
     * @param dicaSenha : dica da senha
     * @param autoDesbloqueio : TRUE se é operação de autodesbloqueio
     * @param responsavel : responsável pela operação
     * @throws UsuarioControllerException
     */
    @Override
    public void recuperarSenha(String usuCodigo, String tipoEntidade, String chaveRecuperarSenha, String senhaNova, String dicaSenha, boolean autoDesbloqueio, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            boolean isCodValido = false;

            if (autoDesbloqueio) {
                isCodValido = validarChaveRecupSenhaAutoDesbloqueio(usuCodigo, chaveRecuperarSenha, responsavel);
            } else {
                isCodValido = validarChaveRecupSenha(usuCodigo, chaveRecuperarSenha, responsavel);
            }

            // Retorno mensagem de erro se o codigo de recuperação de senha for invalido
            if (!isCodValido) {
                throw new UsuarioControllerException("mensagem.erro.servidor.recuperar.senha.codigo.nao.localizado", responsavel);
            }
            // Desbloqueia o servidor caso seja auto desbloqueio
            if (autoDesbloqueio) {
                bloquearDesbloquearUsuario(usuCodigo, CodedValues.STU_ATIVO, tipoEntidade, null, null, responsavel);
            }

            if (tipoEntidade.contentEquals(AcessoSistema.ENTIDADE_SER) && ParamSist.paramEquals(CodedValues.TPC_SENHA_CONS_SERVIDOR_SOMENTE_NUMERICA, CodedValues.TPC_SIM, responsavel) && !TextHelper.isNum(senhaNova)) {
                throw new UsuarioControllerException("mensagem.senha.servidor.consulta.deve.ser.numerica", responsavel);
            }

            // Altera a senha do usuário
            alterarSenha(usuCodigo, senhaNova, dicaSenha, false, false, false, null, responsavel);
        } catch (final UsuarioControllerException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw ex;
        }
    }

    /**
     * Método para recuperar senha via Web.
     * @param usuCodigos : Lista de códigos dos usuários que irão recuperar senha
     * @param tipoEntidade : tipo de entidade do usuário, ex: AcessoSistema.ENTIDADE_SER
     * @param chaveRecuperarSenha : chave de recuperação de senha enviada no e-mail
     * @param senhaNova : nova senha informada pelo usuário
     * @param dicaSenha : dica da senha
     * @param autoDesbloqueio : TRUE se é operação de autodesbloqueio
     * @param responsavel : responsável pela operação
     * @throws UsuarioControllerException
     */
    @Override
    public void recuperarSenha(Set<String> usuCodigos, String tipoEntidade, String chaveRecuperarSenha, String senhaNova, String dicaSenha, boolean autoDesbloqueio, AcessoSistema responsavel) throws UsuarioControllerException {
        for (final String usuCod : usuCodigos) {
            try {
                responsavel = AcessoSistema.recuperaAcessoSistema(usuCod, responsavel.getIpUsuario(), responsavel.getPortaLogicaUsuario());
            } catch (final ZetraException ex) {
                LOG.error(ex.getMessage(), ex);
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
            }

            recuperarSenha(usuCod, tipoEntidade, chaveRecuperarSenha, senhaNova, dicaSenha, autoDesbloqueio, responsavel);
        }
    }

    @Override
    public void recuperarSenha(String id, String login, List<String> orgCodigos, String otp, String senhaNova, boolean senhaApp, AcessoSistema responsavel) throws UsuarioControllerException {
        this.recuperarSenha(id, login, orgCodigos, otp, senhaNova, senhaApp, true, responsavel);
    }

    /** Método para recuperar senha via web.
     * Através do CPF informado, gera OTP e envia para celular ou email previamente cadastrados.
     * Ao receber, CPF, OTP e nova senha, valida OTP enviado anteriormente e cadastra nova senha.
     * Caso exista mais de um usuário vinculado ao CPF informado, OTP será enviado para todos os usuários e a nova senha também.
     *
     * @param id
     * @param login
     * @param orgCodigos
     * @param otp
     * @param senhaNova
     * @param responsavel
     * @throws UsuarioControllerException
      */
    @Override
    public UsuarioTransferObject recuperarSenha(String id, String login, List<String> orgCodigos, String otp, String senhaNova, boolean senhaApp, boolean isAcessoMobile, AcessoSistema responsavel) throws UsuarioControllerException {

        //Valida a máscara do código otp quando for preenchido
        if (!TextHelper.isNull(otp) && !TextHelper.validaMascara(otp, "#D6")) {
            throw new UsuarioControllerException("mensagem.senha.servidor.otp.invalido", responsavel);
        }

        // Verifica se o sistem permite recuperação de senha
        final Object paramRecuperacaoSenha = isAcessoMobile ? ParamSist.getInstance().getParam(CodedValues.TPC_METODO_ENVIO_OTP_RECUPERACAO_SENHA, responsavel) : AcessoSistema.ENTIDADE_SER.equals(responsavel.getTipoEntidade()) ? ParamSist.getInstance().getParam(CodedValues.TPC_ENVIA_OTP_RECUPERACAO_SENHA_SERVIDOR, responsavel)
                : ParamSist.getInstance().getParam(CodedValues.TPC_ENVIA_OTP_RECUPERACAO_SENHA_USU, responsavel);
        final String strParamRecuperaSenha = paramRecuperacaoSenha != null ? paramRecuperacaoSenha.toString() : CodedValues.ENVIA_OTP_DESABILITADO;

        if (TextHelper.isNull(paramRecuperacaoSenha) || CodedValues.ENVIA_OTP_DESABILITADO.equals(strParamRecuperaSenha)) {
            throw new UsuarioControllerException(isAcessoMobile ? "mensagem.erro.recuperacao.mobile.nao.disponivel" : "mensagem.erro.recuperacao.nao.disponivel", responsavel);
        }
        if (!CodedValues.ENVIA_OTP_SMS.equals(strParamRecuperaSenha) && !CodedValues.ENVIA_OTP_EMAIL.equals(strParamRecuperaSenha) && !CodedValues.ENVIA_OTP_SMS_OU_EMAIL.equals(strParamRecuperaSenha)) {
            throw new UsuarioControllerException("mensagem.operacaoInvalida", responsavel);
        }

        final boolean omiteCpf = ParamSist.getBoolParamSist(CodedValues.TPC_OMITE_CPF_SERVIDOR, responsavel);

        // Recupera tempo de expiração otp
        final ParamSist paramSist = ParamSist.getInstance();
        final String timeoutOtpString = (String) paramSist.getParam(CodedValues.TPC_TEMPO_EXPIRACAO_OTP, AcessoSistema.getAcessoUsuarioSistema());
        Integer timeoutOtp = TextHelper.isNull(timeoutOtpString) ? null : Integer.valueOf(timeoutOtpString);

        // Default 20 minutos
        if (timeoutOtp == null) {
            timeoutOtp = 20;
        }

        // Senha numérica com 6 dígitos - OTP gerado é único para todos usuários com mesmo CPF
        final String otpGerado = GeradorSenhaUtil.getPasswordNumber(CodedValues.TAM_OTP, responsavel);
        UsuarioTransferObject usuario = null;
        if (responsavel.isSer()) {
            List<TransferObject> lstRegistroServidores = null;
            try {
                if (omiteCpf) {
                    lstRegistroServidores = servidorController.lstRegistroServidorPorEmail(id, orgCodigos, AcessoSistema.getAcessoUsuarioSistema());
                } else {
                    lstRegistroServidores = servidorController.lstRegistroServidorPorCpf(id, orgCodigos, AcessoSistema.getAcessoUsuarioSistema());
                }

            } catch (final ServidorControllerException ex) {
                throw new UsuarioControllerException(ex);
            }

            if ((lstRegistroServidores == null) || lstRegistroServidores.isEmpty()) {
                throw new UsuarioControllerException("mensagem.erro.servidor.nao.encontrado", responsavel);
            }

            int serNaoEncontrado = 0;
            int usuOtpInvalido = 0;
            int usuOtpExpirado = 0;
            int usuErroGenerico = 0;
            int erroEnvioOtpSms = 0;
            int erroEnvioOtpEmail = 0;
            int erroEnvioOtpSmsEmail = 0;
            int erroGerarOtp = 0;
            int erroSemEmailCadastrado = 0;
            int erroSemTelCadastrado = 0;
            int totalErros = 0;
            ZetraException excecaoOrigem = null;
            String chaveErro = null;
            boolean notificacaoEnviada = false;

            for (final TransferObject rseTO : lstRegistroServidores) {
                CustomTransferObject usuTO = null;
                try {
                    // Busca o usuário pela chave primária
                    usuTO = pesquisarServidorController.buscaUsuarioServidor(null, null, (String) rseTO.getAttribute(Columns.RSE_MATRICULA), (String) rseTO.getAttribute(Columns.ORG_IDENTIFICADOR), (String) rseTO.getAttribute(Columns.EST_IDENTIFICADOR), responsavel);
                } catch (final ServidorControllerException ex) {
                    serNaoEncontrado++;
                    totalErros++;
                    excecaoOrigem = ex;
                }

                if (usuTO != null) {
                    final String usuCodigo = usuTO.getAttribute(Columns.USU_CODIGO).toString();
                    final String serCodigo = usuTO.getAttribute(Columns.SER_CODIGO).toString();

                    usuario = new UsuarioTransferObject(usuCodigo);
                    usuario = findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);

                    if (CodedValues.STU_ATIVO.equals(usuario.getStuCodigo()) || CodedValues.STU_AGUARD_APROVACAO_CADASTRO.equals(usuario.getStuCodigo())) {
                        if (!TextHelper.isNull(otp)) {
                            try {
                                // Valida se o otp expirou
                                final java.util.Date otpDataCadastro = usuTO.getAttribute(Columns.USU_OTP_DATA_CADASTRO) != null ? (java.util.Date) usuTO.getAttribute(Columns.USU_OTP_DATA_CADASTRO) : null;
                                final java.util.Date dataAtual = new java.util.Date();

                                // Verifica se otp é inválido ou se passou o limite do tempo em milisegundos
                                if (TextHelper.isNull(usuario.getUsuOtpCodigo()) || !JCrypt.verificaSenha(otp, usuario.getUsuOtpCodigo())) {
                                    usuOtpInvalido++;
                                    totalErros++;
                                    chaveErro = "mensagem.senha.servidor.otp.invalido";
                                } else if ((otpDataCadastro == null) || ((dataAtual.getTime() - otpDataCadastro.getTime()) > (timeoutOtp * (6 * Math.pow(10, 4))))) {
                                    usuOtpExpirado++;
                                    totalErros++;
                                    chaveErro = "mensagem.senha.servidor.otp.expirado";
                                } else {
                                    // Altera senha
                                    if (senhaApp) {
                                        alterarSenhaApp(usuCodigo, senhaNova, false, true, responsavel);
                                    } else {
                                        alterarSenha(usuCodigo, senhaNova, "", false, false, false, null, responsavel);
                                    }

                                    /*
                                     * Necessário fazer o reload das informações do usuário pois a senha foi alterada em outro método
                                     * e a variável local não é atualizada automaticamente.
                                     */
                                    usuario = findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);
                                    // Apaga a chave para recuperação de senha.
                                    usuario.setUsuOtpCodigo(null);
                                    usuario.setUsuDataRecSenha(null);
                                    usuario.setUsuOtpDataCadastro(null);

                                    // Determina parâmetros da ocorrência de usuário a ser gravada.
                                    final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                                    ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_SENHA_USUARIO);
                                    ocorrencia.setUsuCodigo(usuCodigo);
                                    ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                                    ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
                                    ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.invalida.otp.usuario", responsavel));

                                    // Invalida OTP
                                    updateUsuario(usuario, ocorrencia, responsavel);
                                }
                            } catch (final UsuarioControllerException ex) {
                                usuErroGenerico++;
                                totalErros++;
                                excecaoOrigem = ex;
                            }

                        } else {
                            try {
                                ServidorTransferObject servidor = null;
                                try {
                                    servidor = servidorController.findServidor(serCodigo, responsavel);
                                } catch (final ServidorControllerException ex) {
                                    serNaoEncontrado++;
                                    totalErros++;
                                    excecaoOrigem = ex;
                                }

                                if (servidor != null) {
                                    final String serNome = servidor.getSerNome();
                                    final String serEmail = servidor.getSerEmail();
                                    final String serCelular = servidor.getSerCelular();

                                    // Criptografa OTP antes de salvar no usuário
                                    final String otpCrypt = SenhaHelper.criptografarSenha(usuario.getUsuLogin(), otpGerado, true, responsavel);

                                    // Salva chave para recuperação de senha.
                                    final java.util.Date dataCadastro = DateHelper.getSystemDatetime();
                                    usuario.setUsuOtpCodigo(otpCrypt);
                                    usuario.setUsuDataRecSenha(dataCadastro);
                                    usuario.setUsuOtpDataCadastro(dataCadastro);

                                    // Determina parâmetros da ocorrência de usuário a ser gravada.
                                    final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                                    ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_SENHA_USUARIO);
                                    ocorrencia.setUsuCodigo(usuCodigo);
                                    ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                                    ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
                                    ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.inclusao.otp.usuario", responsavel));

                                    updateUsuario(usuario, ocorrencia, responsavel);

                                    if (!notificacaoEnviada) {
                                        if (CodedValues.ENVIA_OTP_SMS.equals(strParamRecuperaSenha) || CodedValues.ENVIA_OTP_SMS_OU_EMAIL.equals(strParamRecuperaSenha)) {
                                            try {
                                                EnviaSMSHelper.enviarSMSOTP(serCelular, otpGerado, responsavel);
                                                notificacaoEnviada = true;
                                            } catch (final ZetraException e) {
                                                if (CodedValues.ENVIA_OTP_SMS_OU_EMAIL.equals(strParamRecuperaSenha)) {
                                                    try {
                                                        EnviaEmailHelper.enviarEmailOTPServidor(serNome, serEmail, otpGerado, responsavel);
                                                        notificacaoEnviada = true;
                                                    } catch (final ViewHelperException ex) {
                                                        erroEnvioOtpSmsEmail++;
                                                        totalErros++;
                                                        excecaoOrigem = ex;
                                                        if (TextHelper.isNull(serEmail)) {
                                                            erroSemEmailCadastrado++;
                                                        }
                                                        if (TextHelper.isNull(serCelular)) {
                                                            erroSemTelCadastrado++;
                                                        }
                                                    }
                                                } else {
                                                    erroEnvioOtpSms++;
                                                    totalErros++;
                                                    excecaoOrigem = e;
                                                }
                                            }
                                        } else if (CodedValues.ENVIA_OTP_EMAIL.equals(strParamRecuperaSenha)) {
                                            try {
                                                EnviaEmailHelper.enviarEmailOTPServidor(serNome, serEmail, otpGerado, responsavel);
                                                notificacaoEnviada = true;
                                            } catch (final ViewHelperException ex) {
                                                erroEnvioOtpEmail++;
                                                totalErros++;
                                                excecaoOrigem = ex;
                                                if (TextHelper.isNull(serEmail)) {
                                                    erroSemEmailCadastrado++;
                                                }
                                            }
                                        }
                                    }
                                }

                            } catch (final UsuarioControllerException ex) {
                                erroGerarOtp++;
                                totalErros++;
                                excecaoOrigem = ex;
                            }
                        }
                    } else {
                        totalErros++;
                        chaveErro = "mensagem.erro.status.usuario.nao.permite.operacao";
                    }
                }
            }

            // Caso apresente o mesmo erro para todas as tentativas, retorna erro gerado

            if (serNaoEncontrado == lstRegistroServidores.size()) {
                chaveErro = "mensagem.erro.servidor.nao.encontrado";
            } else if (usuOtpInvalido == lstRegistroServidores.size()) {
                chaveErro = "mensagem.senha.servidor.otp.invalido";
            } else if (usuOtpExpirado == lstRegistroServidores.size()) {
                chaveErro = "mensagem.senha.servidor.otp.expirado";
            } else if (erroEnvioOtpSms == lstRegistroServidores.size()) {
                chaveErro = "mensagem.erro.sms.enviar";
            } else if ((erroSemEmailCadastrado == lstRegistroServidores.size()) && (erroSemTelCadastrado == lstRegistroServidores.size())) {
                chaveErro = "mensagem.erro.tel.email.ser.nao.cadastrado";
            } else if (erroSemEmailCadastrado == lstRegistroServidores.size()) {
                chaveErro = "mensagem.erro.email.ser.nao.cadastrado";
            } else if (erroSemTelCadastrado == lstRegistroServidores.size()) {
                chaveErro = "mensagem.erro.celular.ser.nao.cadastrado";
            } else if (erroEnvioOtpEmail == lstRegistroServidores.size()) {
                chaveErro = "mensagem.erro.email.enviar";
            } else if (erroEnvioOtpSmsEmail == lstRegistroServidores.size()) {
                chaveErro = "mensagem.erro.sms.ou.email.enviar";
            } else if (usuErroGenerico == lstRegistroServidores.size()) {
                if ((excecaoOrigem != null) && !TextHelper.isNull(excecaoOrigem.getMessageKey())) {
                    chaveErro = excecaoOrigem.getMessageKey();
                } else {
                    chaveErro = "mensagem.erro.alterar.chave.recuperacao.senha.usuario";
                }
            } else if (erroGerarOtp == lstRegistroServidores.size()) {
                chaveErro = "mensagem.erro.alterar.chave.recuperacao.senha.usuario";
            } else if (totalErros == lstRegistroServidores.size()) {
                if (TextHelper.isNull(chaveErro) && (excecaoOrigem != null) && !TextHelper.isNull(excecaoOrigem.getMessageKey())) {
                    chaveErro = excecaoOrigem.getMessageKey();
                } else if (TextHelper.isNull(chaveErro)) {
                    chaveErro = "mensagem.erro.alterar.chave.recuperacao.senha.usuario";
                }
            }
            if ((totalErros == lstRegistroServidores.size()) && !TextHelper.isNull(chaveErro)) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new UsuarioControllerException(chaveErro, responsavel, excecaoOrigem, excecaoOrigem != null ? excecaoOrigem.getMessageArgs() : null);
            }

        } else {
            final CustomTransferObject usuTO = findUsuarioByLogin(login, responsavel);
            final String usuCodigo = usuTO.getAttribute(Columns.USU_CODIGO).toString();
            usuario = new UsuarioTransferObject(usuCodigo);
            usuario = findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);

            if (CodedValues.STU_ATIVO.equals(usuario.getStuCodigo()) && (usuario.getUsuCPF() != null) && (id != null) && usuario.getUsuCPF().equals(id)) {
                if (!TextHelper.isNull(otp)) {
                    try {
                        // Valida se o otp expirou
                        final java.util.Date otpDataCadastro = usuario.getUsuOtpDataCadastro();
                        final java.util.Date dataAtual = new java.util.Date();

                        // Verifica se otp é inválido ou se passou o limite do tempo em milisegundos
                        if (TextHelper.isNull(usuario.getUsuOtpCodigo()) || !JCrypt.verificaSenha(otp, usuario.getUsuOtpCodigo())) {
                            throw new UsuarioControllerException("mensagem.erro.usuario.codigo.otp.invalido", responsavel);
                        } else if ((otpDataCadastro == null) || ((dataAtual.getTime() - otpDataCadastro.getTime()) > (timeoutOtp * (6 * Math.pow(10, 4))))) {
                            throw new UsuarioControllerException("mensagem.erro.usuario.codigo.otp.vencido", responsavel);
                        } else {
                            // Altera senha
                            if (senhaApp) {
                                alterarSenhaApp(usuCodigo, senhaNova, false, responsavel);
                            } else {
                                alterarSenha(usuCodigo, senhaNova, "", false, false, false, null, responsavel);
                            }

                            /*
                             * Necessário fazer o reload das informações do usuário pois a senha foi alterada em outro método
                             * e a variável local não é atualizada automaticamente.
                             */
                            usuario = findUsuario(usuario, AcessoSistema.ENTIDADE_USU, responsavel);
                            // Apaga a chave para recuperação de senha.
                            usuario.setUsuOtpCodigo(null);
                            usuario.setUsuDataRecSenha(null);
                            usuario.setUsuOtpDataCadastro(null);

                            // Determina parâmetros da ocorrência de usuário a ser gravada.
                            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                            ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_SENHA_USUARIO);
                            ocorrencia.setUsuCodigo(usuCodigo);
                            ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
                            ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.invalida.otp.usuario", responsavel));

                            // Invalida OTP
                            updateUsuario(usuario, ocorrencia, responsavel);
                        }
                    } catch (final UsuarioControllerException ex) {
                        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                        throw ex;
                    }
                } else {
                    try {
                        final String nome = usuario.getUsuNome();
                        final String usuEmail = usuario.getUsuEmail();
                        final String usuCelular = usuario.getUsuTel(); // TODO: usuario.getUsuCelular();

                        // Criptografa OTP antes de salvar no usuário
                        final String otpCrypt = SenhaHelper.criptografarSenha(usuario.getUsuLogin(), otpGerado, false, responsavel);

                        // Salva chave para recuperação de senha.
                        final java.util.Date dataCadastro = DateHelper.getSystemDatetime();
                        usuario.setUsuOtpCodigo(otpCrypt);
                        usuario.setUsuDataRecSenha(dataCadastro);
                        usuario.setUsuOtpDataCadastro(dataCadastro);

                        // Determina parâmetros da ocorrência de usuário a ser gravada.
                        final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                        ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_SENHA_USUARIO);
                        ocorrencia.setUsuCodigo(usuCodigo);
                        ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                        ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
                        ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.inclusao.otp.usuario", responsavel));

                        updateUsuario(usuario, ocorrencia, responsavel);

                        if (CodedValues.ENVIA_OTP_SMS.equals(strParamRecuperaSenha) || CodedValues.ENVIA_OTP_SMS_OU_EMAIL.equals(strParamRecuperaSenha)) {
                            try {
                                EnviaSMSHelper.enviarSMSOTP(usuCelular, otpGerado, responsavel);
                            } catch (final ZetraException e) {
                                if (CodedValues.ENVIA_OTP_SMS_OU_EMAIL.equals(strParamRecuperaSenha)) {
                                    try {
                                        EnviaEmailHelper.enviarEmailOTP(nome, usuEmail, otpGerado, responsavel);
                                    } catch (final ViewHelperException ex) {
                                        throw new UsuarioControllerException("mensagem.erro.sms.ou.email.enviar", responsavel);
                                    }
                                } else {
                                    throw new UsuarioControllerException("mensagem.erro.sms.enviar", responsavel);
                                }
                            }
                        } else if (CodedValues.ENVIA_OTP_EMAIL.equals(strParamRecuperaSenha)) {
                            try {
                                EnviaEmailHelper.enviarEmailOTP(nome, usuEmail, otpGerado, responsavel);
                            } catch (final ViewHelperException e) {
                                throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel);
                            }
                        }
                    } catch (final UsuarioControllerException ex) {
                        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                        throw new UsuarioControllerException("mensagem.erro.alterar.chave.recuperacao.senha.usuario", responsavel, ex);
                    }
                }
            }
        }
        return usuario;
    }

    @Override
    public TransferObject buscarUsuarioPorCodRecuperarSenha(String codRecuperar, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemPapelUsuarioQuery query = new ObtemPapelUsuarioQuery();
            query.usuChaveRecuperarSenha = codRecuperar;
            final List<TransferObject> resultado = query.executarDTO();
            if ((resultado != null) && !resultado.isEmpty()) {
                return resultado.get(0);
            }
            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public void atualizarUsuarioAutorizacaoEmailMarketing(UsuarioTransferObject usuario, String usuAutoriza, AcessoSistema responsavel) throws UsuarioControllerException {
        usuario.setUsuAutorizaEmailMarketing(CodedValues.TPC_SIM.equals(usuAutoriza) ? CodedValues.TPC_SIM : CodedValues.TPC_NAO);
        updateUsuario(usuario, null, responsavel);
    }

    /** NOME DE USUÁRIO (PARA LOGIN EM DUAS ETAPAS) ---------------------------------------------------------------------- **/

    @Override
    public int countNomeUsuario(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemNomeUsuarioQuery query = new ObtemNomeUsuarioQuery();
            query.count = true;
            return query.executarContador();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public TransferObject obtemNomeUsuario(String login, String usuCodigo, int offset, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ObtemNomeUsuarioQuery query = new ObtemNomeUsuarioQuery();
            query.usuLogin = login;
            query.usuCodigo = usuCodigo;
            if (offset != -1) {
                query.firstResult = offset;
            }
            query.maxResults = 1;
            final List<TransferObject> lista = query.executarDTO();
            if ((lista == null) || lista.isEmpty()) {
                throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel);
            }

            return lista.get(0);
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    /**
     * Método que retorna a lista de usuários a serem notificados por tempo de initividade
     * no sistema.
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     * @throws HQueryException
     */
    @Override
    public List<TransferObject> enviaNotificacaoUsuariosPorTempoInatividade(AcessoSistema responsavel) throws UsuarioControllerException {

        List<TransferObject> lista = null;

        try {
            final Integer diasSemAcessoCse = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_BLOQ_USU_CSE_SEM_ACESSO, responsavel)) ? Integer.valueOf(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_BLOQ_USU_CSE_SEM_ACESSO, responsavel).toString()) : 0;
            final Integer diasSemAcessoCsa = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_BLOQ_USU_CSA_SEM_ACESSO, responsavel)) ? Integer.valueOf(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_BLOQ_USU_CSA_SEM_ACESSO, responsavel).toString()) : 0;
            final Integer diasSemAcessoSer = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_BLOQ_USU_SER_SEM_ACESSO, responsavel)) ? Integer.valueOf(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_BLOQ_USU_SER_SEM_ACESSO, responsavel).toString()) : 0;
            final Integer qtdDiasAntesNotificacao = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_NOTIFICACAO_BLOQUEIO_INATIVIDADE, responsavel)) ? Integer.valueOf(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_DIAS_NOTIFICACAO_BLOQUEIO_INATIVIDADE, responsavel).toString()) : 0;

            // DESENV-14804 Quantidade de horas que o usuário tem de prazo para logar no sistema após o desbloqueio no sistema.
            Integer qtdeHorasPrazoLoginUsuario = !TextHelper.isNull(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_HORAS_USUARIO_LOGAR_APOS_DESBLOQUEIO, responsavel)) ? Integer.valueOf(ParamSist.getInstance().getParam(CodedValues.TPC_QTDE_HORAS_USUARIO_LOGAR_APOS_DESBLOQUEIO, responsavel).toString()) : 48;
            // Prazo máximo permitido será 10 (dez) dias, ou seja 240 horas.
            if (qtdeHorasPrazoLoginUsuario > 240) {
                qtdeHorasPrazoLoginUsuario = 240;
            }

            // Só executa se um dos parâmetros estiver setada a quantidade de dias sem acesso
            if (((diasSemAcessoCse.compareTo(0) > 0) || (diasSemAcessoCsa.compareTo(0) > 0) || (diasSemAcessoSer.compareTo(0) > 0)) && (qtdDiasAntesNotificacao.compareTo(0) > 0)) {

                final ListaUsuarioNotificacaoInatividadeQuery query = new ListaUsuarioNotificacaoInatividadeQuery();
                final Calendar data = Calendar.getInstance();
                data.add(Calendar.HOUR, -qtdeHorasPrazoLoginUsuario);
                query.dataLimiteBloqueio = data.getTime();
                lista = query.executarDTO();
            }
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.nao.foi.possivel.notificar.usuario.bloqueio.inatividade", responsavel, ex);
        }
        return lista;
    }

    @Override
    public void limparDadosOTP(TransferObject usuario, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final String usuCodigo = (String) usuario.getAttribute(Columns.USU_CODIGO);
            final Usuario usuarioBean = UsuarioHome.findByPrimaryKey(usuCodigo);

            usuarioBean.setUsuOtpCodigo(null);
            usuarioBean.setUsuOtpChaveSeguranca(null);
            usuarioBean.setUsuChaveValidacaoTotp(null);
            usuarioBean.setUsuOtpDataCadastro(null);

            AbstractEntityHome.update(usuarioBean);
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    /**
     * Método que gera o código de autorização a ser enviado ao Servidor via SMS.
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    private String gerarCodigoAutorizacaoSms(AcessoSistema responsavel) throws UsuarioControllerException {

        //Gera o código de autorização
        String codAut;
        try {
            codAut = GeradorSenhaUtil.getPasswordNumber(6, responsavel);
        } catch (final UsuarioControllerException e) {
            LOG.debug("Erro ao gerar o código de autorização: " + e.getMessage());
            return null;
        }

        //Salva o código na tabela de usuário
        UsuarioTransferObject usu = new UsuarioTransferObject();
        try {
            usu = findUsuario(responsavel.getUsuCodigo(), responsavel);

            final String codCriptografado = JCrypt.crypt(codAut);

            // registra dados no USU_OTP_CODIGO
            usu.setUsuOtpCodigo(codCriptografado);
            usu.setUsuOtpDataCadastro(DateHelper.getSystemDatetime());

            // Grava ocorrência de geração de OTP
            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setUsuCodigo(responsavel.getUsuCodigo());
            ocorrencia.setTocCodigo(CodedValues.TOC_INCLUSAO_OTP_USUARIO);
            ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo() != null ? responsavel.getUsuCodigo() : AcessoSistema.getAcessoUsuarioSistema().getUsuCodigo());
            ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.usuario", responsavel));
            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

            updateUsuario(usu, ocorrencia, null, null, AcessoSistema.ENTIDADE_SER, responsavel.getUsuCodigo(), null, responsavel);
        } catch (final UsuarioControllerException ex) {
            LOG.debug("Erro ao salvar o código de autorização: " + ex.getMessage());
            codAut = null;
            throw new UsuarioControllerException("mensagem.erro.interno.nao.possivel.gerar.codigo.autorizacao.solicitacao", responsavel, ex);
        }

        return codAut;
    }

    /**
     * Método que envia o código gerado, ao celular do Servidor, cadastrado na tb_servdor, campo "ser_celular".
     * @param rseCodigo
     * @param responsavel
     * @throws ServidorControllerException
     * @throws UsuarioControllerException
     */
    @Override
    public void enviarCodigoAutorizacaoSms(String rseCodigo, AcessoSistema responsavel) throws ServidorControllerException, UsuarioControllerException {

        if ((rseCodigo == null) || !validarCodigoAutorizacaoSmsExpirado(responsavel)) {
            return;
        }

        String celularDestinatario = null;

        // Busca mensagem a ser enviada
        String corpo = ApplicationResourcesHelper.getMessage("mensagem.sms.servidor.codigo.unico", responsavel);

        // Busca dados do servidor
        final ServidorTransferObject servidor = servidorController.findServidorByRseCodigo(rseCodigo, responsavel);

        if (servidor != null) {
            // Formata o telefone para o padrão do país
            celularDestinatario = !TextHelper.isNull(servidor.getSerCelular()) ? LocaleHelper.formataCelular(servidor.getSerCelular()) : null;
        }

        if (!TextHelper.isNull(celularDestinatario)) {
            // Envia o SMS.
            try {
                final String accountSid = ParamSist.getInstance().getParam(CodedValues.TPC_SID_CONTA_SMS, responsavel).toString();
                final String authToken = ParamSist.getInstance().getParam(CodedValues.TPC_TOKEN_AUTENTICACAO_SMS, responsavel).toString();
                final String fromNumber = ParamSist.getInstance().getParam(CodedValues.TPC_NUMERO_REMETENTE_SMS, responsavel).toString();

                final String codAut = gerarCodigoAutorizacaoSms(responsavel);

                if (TextHelper.isNull(codAut)) {
                    return;
                }

                corpo += codAut;
                new SMSHelper(accountSid, authToken, fromNumber).send(celularDestinatario, corpo);

            } catch (final ZetraException ex) {
                LOG.debug("Erro ao enviar o SMS: " + ex.getMessage());
                throw new UsuarioControllerException("mensagem.erro.interno.nao.possivel.gerar.codigo.autorizacao.solicitacao", responsavel, ex);
            }
        } else {
            throw new UsuarioControllerException("mensagem.erro.necessita.telefone.cadastrado", responsavel);
        }

    }

    /**
     * Método que valida o código enviado ao celular do Servidor, que foi informado na tela da interface web.
     * @param codAut
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public boolean validarCodigoAutorizacaoSms(String codAut, AcessoSistema responsavel) throws UsuarioControllerException {

        TransferObject usuario = null;

        try {
            usuario = pesquisarServidorController.buscaUsuarioServidor(responsavel.getUsuCodigo(), responsavel);
        } catch (final ServidorControllerException ex) {
            LOG.debug("Erro ao localizar o servidor: " + ex.getMessage());
            throw new UsuarioControllerException("mensagem.erro.localizar.servidor", responsavel, ex);
        }

        final ParamSist paramSist = ParamSist.getInstance();
        final String timeoutOtpString = (String) paramSist.getParam(CodedValues.TPC_TEMPO_EXPIRACAO_OTP, AcessoSistema.getAcessoUsuarioSistema());
        Integer timeoutOtp = TextHelper.isNull(timeoutOtpString) ? null : Integer.valueOf(timeoutOtpString);

        // default 20 minutos
        if (timeoutOtp == null) {
            timeoutOtp = 20;
        }

        // Valida se o otp expirou
        final java.util.Date otpDataCadastro = usuario.getAttribute(Columns.USU_OTP_DATA_CADASTRO) != null ? (java.util.Date) usuario.getAttribute(Columns.USU_OTP_DATA_CADASTRO) : null;
        final java.util.Date dataAtual = new java.util.Date();

        // Verifica se otp é inválido ou se passou o limite do tempo em milisegundos
        if (TextHelper.isNull(usuario.getAttribute(Columns.USU_OTP_CODIGO)) || !JCrypt.verificaSenha(codAut, usuario.getAttribute(Columns.USU_OTP_CODIGO).toString())) {
            throw new UsuarioControllerException("mensagem.erro.codigo.autorizacao.invalido", responsavel);
        } else if ((otpDataCadastro == null) || ((dataAtual.getTime() - otpDataCadastro.getTime()) > (timeoutOtp * 60000))) {
            throw new UsuarioControllerException("mensagem.erro.codigo.autorizacao.expirado", responsavel);
        }

        return true;
    }

    /**
     * Método que valida o tempo de expiração do código enviado ao celular do Servido.
     * @param codAut
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    private boolean validarCodigoAutorizacaoSmsExpirado(AcessoSistema responsavel) throws UsuarioControllerException {
        TransferObject usuario = null;

        try {
            usuario = pesquisarServidorController.buscaUsuarioServidor(responsavel.getUsuCodigo(), responsavel);
        } catch (final ServidorControllerException ex) {
            LOG.debug("Erro ao localizar o servidor: " + ex.getMessage());
            throw new UsuarioControllerException("mensagem.erro.localizar.servidor", responsavel, ex);
        }

        final ParamSist paramSist = ParamSist.getInstance();
        final String timeoutOtpString = (String) paramSist.getParam(CodedValues.TPC_TEMPO_EXPIRACAO_OTP, AcessoSistema.getAcessoUsuarioSistema());
        Integer timeoutOtp = TextHelper.isNull(timeoutOtpString) ? null : Integer.valueOf(timeoutOtpString);

        // default 20 minutos
        if (timeoutOtp == null) {
            timeoutOtp = 20;
        }

        // Valida se o otp expirou
        final java.util.Date otpDataCadastro = usuario.getAttribute(Columns.USU_OTP_DATA_CADASTRO) != null ? (java.util.Date) usuario.getAttribute(Columns.USU_OTP_DATA_CADASTRO) : null;
        final java.util.Date dataAtual = new java.util.Date();

        // Verifica se otp é inválido ou se passou o limite do tempo em milisegundos
        return (otpDataCadastro == null) || ((dataAtual.getTime() - otpDataCadastro.getTime()) > (timeoutOtp * 60000));
    }

    @Override
    public List<Papel> listarPapeis(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            return PapelHome.listarPapeis();
        } catch (final FindException e) {
            throw new UsuarioControllerException("mensagem.menu.papel.indefinido", responsavel);
        }
    }

    private Calendar calculaDataExpiracaoSenha(boolean senhaAutorizacaoServidor, UsuarioTransferObject usuario, boolean usuarioSer, AcessoSistema responsavel) throws UsuarioControllerException {
        final Calendar dataExpiracaoSenhaCalc = Calendar.getInstance();
        // Determina o prazo de expiração, de acordo com o tipo de usuário.
        String paramPrazoExpiracaoSenha;
        if (usuarioSer) {
            paramPrazoExpiracaoSenha = CodedValues.TPC_PRAZO_EXPIRACAO_SENHA_USU_SER;
        } else {
            final TransferObject tipoUsuario = obtemUsuarioTipo(usuario.getUsuCodigo(), usuario.getUsuLogin(), responsavel);
            final String tipo = (String) tipoUsuario.getAttribute("TIPO");
            if (tipo == null) {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.determinar.tipo.usuario", responsavel);
            }
            if (AcessoSistema.ENTIDADE_CSE.equals(tipo) || AcessoSistema.ENTIDADE_ORG.equals(tipo) || AcessoSistema.ENTIDADE_SUP.equals(tipo)) {
                paramPrazoExpiracaoSenha = CodedValues.TPC_PRAZO_EXPIRACAO_SENHA_USU_CSE_ORG;
            } else if (AcessoSistema.ENTIDADE_CSA.equals(tipo) || AcessoSistema.ENTIDADE_COR.equals(tipo)) {
                paramPrazoExpiracaoSenha = CodedValues.TPC_PRAZO_EXPIRACAO_SENHA_USU_CSA_COR;
            } else if (AcessoSistema.ENTIDADE_SER.equals(tipo)) {
                paramPrazoExpiracaoSenha = CodedValues.TPC_PRAZO_EXPIRACAO_SENHA_USU_SER;
            } else {
                throw new UsuarioControllerException("mensagem.erro.nao.possivel.determinar.tipo.usuario", responsavel);
            }
        }

        String prazo = (String) ParamSist.getInstance().getParam(paramPrazoExpiracaoSenha, responsavel);
        if (TextHelper.isNull(prazo)) {
            throw new UsuarioControllerException("mensagem.erro.nao.ha.prazo.expiracao.senha.definido", responsavel);
        }
        if (senhaAutorizacaoServidor) {
            // Se é senha de autorização de servidor e a senha possui validade em dias
            // determina a data de expiração de acordo com este parâmetro, e não com
            // o parâmetro de expiração de senha de servidor.
            final String prazoValidade = (String) ParamSist.getInstance().getParam(CodedValues.TPC_QTD_DIAS_VALIDADE_SENHA_AUTORIZACAO, responsavel);
            if (!TextHelper.isNull(prazoValidade) && (Integer.parseInt(prazoValidade) > 0)) {
                prazo = prazoValidade;
            }
        }
        dataExpiracaoSenhaCalc.add(Calendar.DATE, Integer.parseInt(prazo));

        return dataExpiracaoSenhaCalc;
    }

    /**
     * geração e envio de OTP exclusivamente para validação de e-mail
     * @param servidor
     * @param emailValidacao
     * @param responsavel
     * @throws UsuarioControllerException
     */
    @Override
    public void gerarOtpConfirmacaoEmail(Servidor servidor, String emailValidacao, AcessoSistema responsavel) throws UsuarioControllerException {
        if (TextHelper.isNull(emailValidacao)) {
            throw new UsuarioControllerException("mensagem.informe.servidor.email", responsavel);
        }

        final List<TransferObject> usuarios = lstUsuariosSer(servidor.getSerCpf(), null, null, null, responsavel);
        if ((usuarios == null) || usuarios.isEmpty()) {
            throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel);
        }

        // Senha numérica com 6 dígitos
        final String otp = GeradorSenhaUtil.getPasswordNumber(CodedValues.TAM_OTP, responsavel);

        try {
            if (TextHelper.isNull(servidor.getSerEmail()) || !servidor.getSerEmail().equals(emailValidacao)) {
                final ServidorTransferObject serTO = new ServidorTransferObject(servidor.getSerCodigo());
                serTO.setSerEmail(emailValidacao);
                serTO.setSerDataValidacaoEmail(null);
                servidorController.updateServidor(serTO, responsavel);
            }

            for (final TransferObject usuario : usuarios) {
                // Criptografa OTP antes de salvar no usuário
                final String otpCrypt = SenhaHelper.criptografarSenha((String) usuario.getAttribute(Columns.USU_CODIGO), otp, true, responsavel);

                // Salva OTP gerado no campo provisório USU_CHAVE_VALIDACAO_TOTP
                UsuarioTransferObject usuTo = new UsuarioTransferObject();
                usuTo.setAtributos(usuario.getAtributos());

                usuTo = findUsuario(usuTo, AcessoSistema.ENTIDADE_SER, responsavel);
                usuTo.setUsuOtpCodigo(otpCrypt);
                usuTo.setUsuOtpDataCadastro(DateHelper.getSystemDatetime());
                if (ParamSist.paramEquals(CodedValues.TPC_VALIDAR_KYC_FACESWEB_INTEGRACAO_SALARYPAY, CodedValues.TPC_SIM, responsavel)) {
                    usuTo.setStuCodigo(CodedValues.STU_AGUARD_APROVACAO_CADASTRO);
                }

                // Cria ocorrência
                final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                ocorrencia.setUsuCodigo((String) usuario.getAttribute(Columns.USU_CODIGO));
                ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                ocorrencia.setTocCodigo(CodedValues.TOC_INCLUSAO_OTP_USUARIO);
                ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.inclusao.otp.usuario", responsavel));
                ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

                // Salva OTP no usuário
                updateUsuario(usuTo, ocorrencia, responsavel);

                try {
                    EnviaEmailHelper.enviarEmailOTPServidor(servidor.getSerNome(), emailValidacao, otp, responsavel);
                } catch (final ViewHelperException e) {
                    throw new UsuarioControllerException("mensagem.erro.falha.enviar.email", responsavel, e);
                }
            }
        } catch (final ServidorControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    /** Altera a chave de validação de Email
     * @param dadosUsuario : UsuarioTransferObject
     * @param responsavel : Usuário que está realizando a validação de email
     * @throws UsuarioControllerException
     */
    @Override
    public void alteraChaveValidacaoEmail(UsuarioTransferObject dadosUsuario, String link, AcessoSistema responsavel) throws UsuarioControllerException {
        if (!CodedValues.STU_ATIVO.equals(dadosUsuario.getStuCodigo())) {
            throw new UsuarioControllerException("mensagem.usuarioBloqueado", responsavel);
        }

        try {
            // Determina parâmetros da ocorrência de usuário a ser gravada.
            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            ocorrencia.setTocCodigo(CodedValues.TOC_VALIDACAO_EMAIL_USUARIO);
            ocorrencia.setUsuCodigo(dadosUsuario.getUsuCodigo());
            ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
            ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
            ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.validacao.email.usuario", responsavel));

            updateUsuario(dadosUsuario, ocorrencia, responsavel);

            enviaLinkValidaEmailUsuario(dadosUsuario.getUsuEmail(), dadosUsuario.getUsuNome(), link, dadosUsuario.getUsuChaveValidacaoEmail(), responsavel);

        } catch (final UsuarioControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw ex;
        }
    }

    /**
     * Envia ao usuário link de verificação do email
     * @param usuCodigo
     * @param emailDestinatario
     * @param link - link a ser enviado no e-mail que direciona para a página de confirmação de email.
     * @param codigo - token de fluxo de acesso da URL
     * @param responsavel
     * @throws UsuarioControllerException
     */
    private void enviaLinkValidaEmailUsuario(String emailDestinatario, String usuNome, String link, String codSenha, AcessoSistema responsavel) throws UsuarioControllerException {
        link = link + "&codValidacao=" + codSenha;

        if (!TextHelper.isNull(emailDestinatario)) {
            try {
                EnviaEmailHelper.enviarEmailLinkValidarEmailusuario(emailDestinatario, usuNome, link, responsavel);
            } catch (final ViewHelperException e) {
                throw new UsuarioControllerException("mensagem.erro.falha.enviar.email", responsavel, e);
            }
        }
    }

    @Override
    public TransferObject buscarUsuarioPorCodValidaEmail(String codValidacaoEmail, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            if (!TextHelper.isNull(codValidacaoEmail)) {

                final ObtemPapelUsuarioQuery query = new ObtemPapelUsuarioQuery();
                query.usuChaveValidacaoEmail = codValidacaoEmail;
                final List<TransferObject> resultado = query.executarDTO();
                if ((resultado != null) && !resultado.isEmpty()) {
                    for (final TransferObject usuario : resultado) {
                        final String usuCodigo = usuario.getAttribute(Columns.USU_CODIGO).toString();
                        final UsuarioTransferObject dadosUsuario = findUsuario(usuCodigo, responsavel);
                        responsavel.setUsuCodigo(usuCodigo);
                        dadosUsuario.setUsuDataValidacaoEmail(DateHelper.getSystemDatetime());

                        final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
                        ocorrencia.setTocCodigo(CodedValues.TOC_CONFIRMACAO_EMAIL_USUARIO);
                        ocorrencia.setUsuCodigo(dadosUsuario.getUsuCodigo());
                        ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                        ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());
                        ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.confirmacao.email.usuario", responsavel));

                        updateUsuario(dadosUsuario, ocorrencia, responsavel);

                    }
                    return resultado.get(0);
                }
            }
            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    /**
     * valida OTP para uso exclusivo em validação de e-mail
     * @param codAut
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    @Override
    public boolean validarOtpConfirmacaoEmail(String otp, String serCpf, AcessoSistema responsavel) throws UsuarioControllerException {
        //TODO: tratar quando retornar mais de um servidor
        try {
            final List<Servidor> servidores = ServidorHome.findByCPF(serCpf);
            final List<TransferObject> usuSerTos = this.lstUsuariosSer(servidores.get(0).getSerCpf(), null, null, null, responsavel);

            if ((usuSerTos == null) || usuSerTos.isEmpty()) {
                throw new UsuarioControllerException("mensagem.erro.usuario.nao.encontrado", responsavel);
            }

            //TODO: tratar quando retornar mais de um usuário
            final TransferObject usuario = usuSerTos.get(0);

            final ParamSist paramSist = ParamSist.getInstance();
            final String timeoutOtpString = (String) paramSist.getParam(CodedValues.TPC_TEMPO_EXPIRACAO_OTP, AcessoSistema.getAcessoUsuarioSistema());
            Integer timeoutOtp = TextHelper.isNull(timeoutOtpString) ? null : Integer.valueOf(timeoutOtpString);

            // default 20 minutos
            if (timeoutOtp == null) {
                timeoutOtp = 20;
            }

            // Valida se o otp expirou
            final java.util.Date otpDataCadastro = usuario.getAttribute(Columns.USU_OTP_DATA_CADASTRO) != null ? (java.util.Date) usuario.getAttribute(Columns.USU_OTP_DATA_CADASTRO) : null;
            final java.util.Date dataAtual = new java.util.Date();

            // Verifica se otp é inválido ou se passou o limite do tempo em milisegundos
            if (TextHelper.isNull(usuario.getAttribute(Columns.USU_OTP_CODIGO)) || !JCrypt.verificaSenha(otp, usuario.getAttribute(Columns.USU_OTP_CODIGO).toString())) {
                throw new UsuarioControllerException("mensagem.erro.codigo.autorizacao.invalido", responsavel);
            } else if ((otpDataCadastro == null) || ((dataAtual.getTime() - otpDataCadastro.getTime()) > (timeoutOtp * 60000))) {
                throw new UsuarioControllerException("mensagem.erro.codigo.autorizacao.expirado", responsavel);
            } else {
                // atualiza os campos do servidor que informam que o e-mail está validado
                final Servidor servidor = servidores.get(0);
                final ServidorTransferObject serTO = new ServidorTransferObject(servidor.getSerCodigo());
                serTO.setSerDataValidacaoEmail(new Timestamp(DateHelper.getSystemDatetime().getTime()));
                servidorController.updateServidor(serTO, responsavel);
            }
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException("mensagem.erro.localizar.servidor", responsavel, ex);
        } catch (final ServidorControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }

        return true;
    }

    /**
     * Retorna TRUE caso exista outro usuário não excluído no sistema com o mesmo e-mail
     * @param usuEmail
     * @param usuCpfExceto
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */
    private boolean existeOutroUsuarioMesmoEmail(String usuEmail, String usuCpfExceto, AcessoSistema responsavel) throws UsuarioControllerException {
        boolean existeEmailCadastrado = false;
        try {
            if (ParamSist.paramEquals(CodedValues.TPC_IMPEDE_EMAIL_IGUAL_ENTRE_USU, CodedValues.TPC_SIM, responsavel)) {
                final ObtemTotalUsuariosPorEmailQuery query = new ObtemTotalUsuariosPorEmailQuery();
                query.usuEmail = usuEmail;
                query.usuCpfExceto = usuCpfExceto;
                existeEmailCadastrado = query.executarContador() > 0;
            }
            if (!existeEmailCadastrado && ParamSist.paramEquals(CodedValues.TPC_IMPEDE_EMAIL_IGUAL_ENTRE_USU_E_SER, CodedValues.TPC_SIM, responsavel)) {
                final ObtemTotalServidoresPorEmailCelularQuery query = new ObtemTotalServidoresPorEmailCelularQuery();
                query.serEmail = usuEmail;
                query.serCpfExceto = usuCpfExceto;
                existeEmailCadastrado = query.executarContador() > 0;
            }
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
        return existeEmailCadastrado;
    }

    private String criaOcorrenciaPerfil(String perCodigo, String tocCodigo, String oprObs, String tmoCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final String usuCodigo = responsavel != null ? responsavel.getUsuCodigo() : null;
            final OcorrenciaPerfil opr = OcorrenciaPerfilHome.create(perCodigo, tocCodigo, usuCodigo, oprObs, responsavel.getIpUsuario(), tmoCodigo);
            return opr.getOprCodigo();
        } catch (final CreateException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public int countOcorrenciaPerfil(String perCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaOcorrenciaPerfilQuery query = new ListaOcorrenciaPerfilQuery();
            query.count = true;
            query.perCodigo = perCodigo;
            return query.executarContador();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.contar.ocorrencias", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> lstOcorrenciaPerfil(String perCodigo, int offset, int count, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaOcorrenciaPerfilQuery query = new ListaOcorrenciaPerfilQuery();
            if (offset != -1) {
                query.firstResult = offset;
            }
            if (count != -1) {
                query.maxResults = count;
            }
            query.perCodigo = perCodigo;
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.listar.ocorrencias", responsavel, ex);
        }
    }

    private TransferObject obtemServidorPorUsuario(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        final ObtemUsuarioServidorQuery query = new ObtemUsuarioServidorQuery();
        query.usuCodigo = usuCodigo;

        TransferObject servidor = null;
        try {
            final List<TransferObject> servidores = query.executarDTO();
            if ((servidores != null) && (servidores.size() == 1)) {
                servidor = servidores.get(0);
            }
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
        }

        if (servidor == null) {
            throw new UsuarioControllerException("mensagem.erro.nao.possivel.encontrar.servidor", responsavel);
        }

        return servidor;
    }

    @Override
    public String[] matriculasUsuariosServidores(String usuCodigo, String senhaNovaCrypt, boolean alteraSenha, AcessoSistema responsavel) throws UsuarioControllerException {

        try {
            final OcorrenciaUsuarioTransferObject ocorrencia = new OcorrenciaUsuarioTransferObject();
            final List<Usuario> usuarios = UsuarioHome.listaUsuServidores(usuCodigo);
            final String[] usuLogin = new String[usuarios.size()];
            int posicaoUsu = 0;

            for (final Usuario usu : usuarios) {
                final String[] matriculasSer = usu.getUsuLogin().split("-");
                usuLogin[posicaoUsu] = matriculasSer[matriculasSer.length - 1];

                if (!usuCodigo.equals(usu.getUsuCodigo()) && alteraSenha) {
                    final UsuarioTransferObject usuTranferObject = new UsuarioTransferObject(usu.getUsuCodigo());
                    usuTranferObject.setUsuSenha(senhaNovaCrypt);

                    ocorrencia.setUsuCodigo(usu.getUsuCodigo());
                    ocorrencia.setTocCodigo(CodedValues.TOC_ALTERACAO_SENHA_USUARIO);
                    ocorrencia.setOusUsuCodigo(responsavel.getUsuCodigo());
                    ocorrencia.setOusObs(ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.ous.obs.alteracao.senhas.servidor", responsavel));
                    ocorrencia.setOusIpAcesso(responsavel.getIpUsuario());

                    updateUsuario(usuTranferObject, ocorrencia, responsavel);

                }
                posicaoUsu++;
            }
            return usuLogin;
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public void bloqueiaPerfilDataExpiracao(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            // Lista os perfils com data expirada
            final List<Perfil> lstPerfil = PerfilHome.findPerfilExpirado();

            if ((lstPerfil != null) && !lstPerfil.isEmpty()) {
                final Short status = CodedValues.STS_INATIVO;
                for (final Perfil perfil : lstPerfil) {
                    final String perCodigo = perfil.getPerCodigo();
                    //Iremos fazer o bloqueio para cada tipo de perfil CSE,ORG,CSA,COR,SUP,USU para que seja criado as ocorrêcia de bloqueio
                    final List<PerfilCse> lstPerfilCse = PerfilCseHome.findByPerCodigo(perCodigo);
                    final List<PerfilOrg> lstPerfilOrg = PerfilOrgHome.findByPerCodigo(perCodigo);
                    final List<PerfilCsa> lstPerfilCsa = PerfilCsaHome.findByPerCodigo(perCodigo);
                    final List<PerfilCor> lstPerfilCor = PerfilCorHome.findByPerCodigo(perCodigo);
                    final List<PerfilSup> lstPerfilSup = PerfilSupHome.findByPerCodigo(perCodigo);

                    if ((lstPerfilCse != null) && !lstPerfilCse.isEmpty()) {
                        final String tipoEntidade = AcessoSistema.ENTIDADE_CSE;
                        for (final PerfilCse perfilCse : lstPerfilCse) {
                            final String cseCodigo = perfilCse.getConsignante().getCseCodigo();
                            updatePerfil(tipoEntidade, cseCodigo, perCodigo, null, null, null, null, status, null,null, null, null, null, responsavel);
                        }
                    }

                    if ((lstPerfilOrg != null) && !lstPerfilOrg.isEmpty()) {
                        final String tipoEntidade = AcessoSistema.ENTIDADE_ORG;
                        for (final PerfilOrg perfilOrg : lstPerfilOrg) {
                            final String orgCodigo = perfilOrg.getOrgao().getOrgCodigo();
                            updatePerfil(tipoEntidade, orgCodigo, perCodigo, null, null, null, null, status, null, null, null, null, null, responsavel);
                        }
                    }

                    if ((lstPerfilCsa != null) && !lstPerfilCsa.isEmpty()) {
                        final String tipoEntidade = AcessoSistema.ENTIDADE_CSA;
                        for (final PerfilCsa perfilCsa : lstPerfilCsa) {
                            final String csaCodigo = perfilCsa.getConsignataria().getCsaCodigo();
                            updatePerfil(tipoEntidade, csaCodigo, perCodigo, null, null, null, null, status, null, null, null, null, null, responsavel);
                        }
                    }

                    if ((lstPerfilCor != null) && !lstPerfilCor.isEmpty()) {
                        final String tipoEntidade = AcessoSistema.ENTIDADE_COR;
                        for (final PerfilCor perfilCor : lstPerfilCor) {
                            final String corCodigo = perfilCor.getCorrespondente().getCorCodigo();
                            updatePerfil(tipoEntidade, corCodigo, perCodigo, null, null, null, null, status, null, null, null, null, null, responsavel);
                        }
                    }

                    if ((lstPerfilSup != null) && !lstPerfilSup.isEmpty()) {
                        final String tipoEntidade = AcessoSistema.ENTIDADE_SUP;
                        for (final PerfilSup perfilSup : lstPerfilSup) {
                            final String cseCodigo = perfilSup.getConsignante().getCseCodigo();
                            updatePerfil(tipoEntidade, cseCodigo, perCodigo, null, null, null, null, status, null, null, null, null, null, responsavel);
                        }
                    }
                }
            }
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    /**
     * Remove restrição do usuário por perfil.
     * @param responsavel
     * @return
     * @throws UsuarioControllerException
     */

    @Override
    public List<String> unidadesPermissaoEdtUsuario(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final List<String> unidades = new ArrayList<>();
            final List<UsuarioUnidade> usuUnidades = UsuarioUnidadeHome.listUniCodigosByUsuCodigo(usuCodigo);

            for (final UsuarioUnidade usu : usuUnidades) {
                unidades.add(usu.getUniCodigo());
            }
            return unidades;
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public void atribuirUnidadesUsuario(String usuCodigo, List<String> unidades, AcessoSistema responsavel) throws UsuarioControllerException {
        try {

            final List<UsuarioUnidade> usuUnidades = UsuarioUnidadeHome.listUniCodigosByUsuCodigo(usuCodigo);
            if ((usuUnidades != null) && !usuUnidades.isEmpty()) {
                UsuarioUnidadeHome.deleteByUsucodigo(usuCodigo);
            }

            for (final String unidade : unidades) {
                UsuarioUnidadeHome.create(usuCodigo, unidade);
            }
        } catch (CreateException | UpdateException | FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public void fixarCamposPesquisaAvancada(List<CampoUsuario> lstCampoUsuaio, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final String usuCodigo = responsavel.getUsuCodigo();
            final List<CampoUsuario> usuario = CampoUsuarioHome.findByUsuario(usuCodigo);
            if (!usuario.isEmpty()) {
                lstCampoUsuaio.forEach(campoUsuario -> {
                    try {
                        CampoUsuarioHome.updateCauValor(usuCodigo, campoUsuario.getCauChave(), campoUsuario.getCauValor());
                    } catch (final UpdateException ex) {
                        LOG.error(ex.getMessage(), ex);
                    }
                });
            } else {
                lstCampoUsuaio.forEach(campoUsuario -> {
                    try {
                        CampoUsuarioHome.create(usuCodigo, campoUsuario.getCauChave(), campoUsuario.getCauValor());
                    } catch (final CreateException ex) {
                        LOG.error(ex.getMessage(), ex);
                    }
                });
            }
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public List<CampoUsuario> buscarCamposPesquisaAvancada(AcessoSistema responsavel) throws UsuarioControllerException {
        List<CampoUsuario> usuario = null;
        try {
            usuario = CampoUsuarioHome.findByUsuario(responsavel.getUsuCodigo());

        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }

        return usuario;
    }

    @Override
    public List<TransferObject> listarUsuariosFuncaoEspecifica(String funCodigo, String tipoEntidade, String codigoEndidade, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuariosFuncaoEspecificaQuery lstUsuarios = new ListaUsuariosFuncaoEspecificaQuery();
            lstUsuarios.tipo = tipoEntidade;
            lstUsuarios.funCodigo = funCodigo;
            lstUsuarios.codigoEntidade = codigoEndidade;

            return lstUsuarios.executarDTO();
        } catch (final HQueryException e) {
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel);
        }
    }

    @Override
    public boolean findEmailExistenteCsaCseOrgCor(String emailUsuario, String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            List<TransferObject> listUsuEmailsRepeat = null;
            final FindEmailUsuarioRepeatQuery usuEmailRepeat = new FindEmailUsuarioRepeatQuery();
            boolean breakOperation = false;

            usuEmailRepeat.emailUsuario = emailUsuario;
            listUsuEmailsRepeat = usuEmailRepeat.executarDTO();

            for (final TransferObject usu : listUsuEmailsRepeat) {
                if ((!TextHelper.isNull(usu.getAttribute(Columns.UCE_CSE_CODIGO)) && !usuCodigo.equals(usu.getAttribute(Columns.USU_CODIGO))) || (!TextHelper.isNull(usu.getAttribute(Columns.UCA_CSA_CODIGO)) && !usuCodigo.equals(usu.getAttribute(Columns.USU_CODIGO)))) {
                    breakOperation = true;
                    break;
                } else if ((!TextHelper.isNull(usu.getAttribute(Columns.UCO_COR_CODIGO)) && !usuCodigo.equals(usu.getAttribute(Columns.USU_CODIGO))) || (!TextHelper.isNull(usu.getAttribute(Columns.UOR_ORG_CODIGO)) && !usuCodigo.equals(usu.getAttribute(Columns.USU_CODIGO)))) {
                    breakOperation = true;
                    break;
                } else if ((!TextHelper.isNull(usu.getAttribute(Columns.USP_CSE_CODIGO)) && !usuCodigo.equals(usu.getAttribute(Columns.USU_CODIGO))) || (!TextHelper.isNull(usu.getAttribute(Columns.USE_SER_CODIGO)) && !usuCodigo.equals(usu.getAttribute(Columns.USU_CODIGO)))) {
                    breakOperation = false;
                }
            }

            return breakOperation;
        } catch (final HQueryException e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public String consultarEmailServidor(boolean enviaEmail, String serCpf, String serEmail, String modoEntrega, AcessoSistema responsavel) throws UsuarioControllerException {
        String email = null;
        final String consultarEmailExternoClassName = (String) ParamSist.getInstance().getParam(CodedValues.TPC_CLASSE_BUSCA_EMAIL_SERVIDOR_API_EXTERNA, responsavel);

        //DESENV-21344
        if (enviaEmail && !TextHelper.isNull(consultarEmailExternoClassName) && (!CodedValues.ALTERACAO_SENHA_AUT_SER_EXIBE_TELA.equals(modoEntrega))) {
            try {
                final ConsultarEmailExternoServidor consultarEmailExternoServidor = ConsultarEmailExternoServidorFactory.getClasseConsultarEmailExternoServidor(consultarEmailExternoClassName);
                final CustomTransferObject resultadoConsultaAPIExterna = consultarEmailExternoServidor.consultarEmailExternoServidor(serCpf);

                if (HttpStatus.OK.equals(resultadoConsultaAPIExterna.getAttribute(ParamEmailExternoServidorEnum.RESULT_STATUS.getChave()))) {
                    email = (String) resultadoConsultaAPIExterna.getAttribute(ParamEmailExternoServidorEnum.RESULT_SUCCESS_DATA.getChave());
                } else if (!TextHelper.isNull(serEmail)) {
                    email = serEmail;
                } else {
                    throw UsuarioControllerException.byMessage((String) resultadoConsultaAPIExterna.getAttribute(ParamEmailExternoServidorEnum.RESULT_ERROR_DATA.getChave()));
                }
            } catch (final UsuarioControllerException ex) {
                LOG.error(ex.getMessage(), ex);
                throw UsuarioControllerException.byMessage(ex.getMessage());
            } catch (final ZetraException ex) {
            	LOG.error(ex.getMessage(), ex);
                throw new UsuarioControllerException("mensagem.erro.email.enviar", responsavel);
            }
        } else {
            email = serEmail;
        }

        return email;
    }

    @Override
    public Perfil findPerfilByUsuCodigo(String usuCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final String perCodigo = findUsuarioPerfil(usuCodigo, responsavel);
            if (perCodigo != null) {
                return PerfilHome.findByPrimaryKey(perCodigo);
            } else {
                throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, "");
            }
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException("mensagem.erro.arg0.nenhum.perfil.encontrado", responsavel, "");
        }
    }

    @Override
    public void removeRestricaoUsuarioPerfil(String perCodigo, AcessoSistema responsavel) throws UsuarioControllerException {
        try {

            final List<PerfilUsuario> lstUsuariosPerfil = PerfilUsuarioHome.findByPerfil(perCodigo);

            for (final PerfilUsuario usuarioPerfil : lstUsuariosPerfil) {

                final UsuarioTransferObject usuario = findUsuario(new UsuarioTransferObject(usuarioPerfil.getUsuCodigo()), AcessoSistema.ENTIDADE_USU, responsavel);
                usuario.setUsuIpAcesso(null);
                usuario.setUsuDDNSAcesso(null);
                updateUsuario(usuario, null, responsavel);

                final LogDelegate logDelegate = new LogDelegate(responsavel, Log.USUARIO, Log.UPDATE, Log.LOG_INFORMACAO);
                logDelegate.setUsuario(responsavel.getUsuCodigo());
                logDelegate.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.remocao.restricao.usuario.perfil", responsavel));
                logDelegate.write();

            }

        } catch (LogControllerException | FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(MENSAGEM_ERRO_INTERNO_SISTEMA, responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> listUsuariosAtivosComEmail(AcessoSistema responsavel) throws UsuarioControllerException {
        try {
            final ListaUsuarioAtivoComEmailQuery query = new ListaUsuarioAtivoComEmailQuery();
            return query.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new UsuarioControllerException(ex);
        }
    }

    @Override
    public void enviarNotificacaoPrazoExpiracaoSenha(String usuNome, String usuEmail, Integer qtdeDiasExpiracaoSenha, AcessoSistema responsavel) {
        try {
            EnviaEmailHelper.notificarUsuPrazoExpiracaoSenha(usuNome, usuEmail, qtdeDiasExpiracaoSenha, responsavel);
        } catch (ViewHelperException ex) {
            LOG.error(ex.getMessage(), ex);
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.email.enviar", responsavel));
        }
    }

    @Override
    public boolean usuarioPossuiPermissaoAutoDesbloqueio(TransferObject usuarioTO, String tipoEntidade, AcessoSistema responsavel) {

        boolean usuarioPossuiPermissao = true;

        if (AcessoSistema.ENTIDADE_CSE.equals(tipoEntidade) || AcessoSistema.ENTIDADE_ORG.equals(tipoEntidade)) {
            if (!ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_USUARIO_CSE_ORG, CodedValues.TPC_SIM, responsavel)) {
                usuarioPossuiPermissao = false;
            }
        } else if (AcessoSistema.ENTIDADE_CSA.equals(tipoEntidade)) {
            
            if (!ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_USUARIO_CSA, CodedValues.TPC_SIM, responsavel)) {
                usuarioPossuiPermissao = false;
            } else {
                usuarioPossuiPermissao = verificarSePerfilCsaPermiteAutoDesbloqueio(usuarioTO, responsavel);
            }
            
        } else if (AcessoSistema.ENTIDADE_COR.equals(tipoEntidade)) {
            if (!ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_USUARIO_COR, CodedValues.TPC_SIM, responsavel)) {
                usuarioPossuiPermissao = false;
            }
        } else if (AcessoSistema.ENTIDADE_SUP.equals(tipoEntidade)) {
            if (!ParamSist.paramEquals(CodedValues.TPC_AUTO_DESBLOQUEIO_USUARIO_SUP, CodedValues.TPC_SIM, responsavel)) {
                usuarioPossuiPermissao = false;
            }
        }

        return usuarioPossuiPermissao;
        
    }

    private boolean verificarSePerfilCsaPermiteAutoDesbloqueio(TransferObject usuarioTO, AcessoSistema responsavel) {
        
        try {

            boolean perfilPossuiPermissao = true;

            String tpaAutoDesbloqueio = buscarValorParametroConsignatariaAutoDesbloqueio(usuarioTO, responsavel);

            if (!TextHelper.isNull(tpaAutoDesbloqueio) && CodedValues.TPA_SIM.equals(tpaAutoDesbloqueio)) {

                String perCodigo = (String) usuarioTO.getAttribute(Columns.UPE_PER_CODIGO);

                if (perCodigo != null) {

                    Perfil perfil = findPerfil(perCodigo, responsavel);

                    if (perfil != null) {
                        
                        if (!TextHelper.isNull(perfil.getPerAutoDesbloqueio())) {
                            perfilPossuiPermissao = CodedValues.TPA_SIM.equals(perfil.getPerAutoDesbloqueio());
                        } else {
                            perfilPossuiPermissao = false;
                        }

                    }

                } 

            }

            return perfilPossuiPermissao;

        } catch (UsuarioControllerException | ParametroControllerException | CorrespondenteControllerException e) {
            LOG.error(e.getMessage(), e);
            return true;
        }

    }

    private String buscarValorParametroConsignatariaAutoDesbloqueio(TransferObject usuarioTO, AcessoSistema responsavel)
            throws CorrespondenteControllerException, ParametroControllerException {
        
        String csaCodigo = null;

        if (!TextHelper.isNull(usuarioTO.getAttribute(Columns.UCA_CSA_CODIGO))) {
            csaCodigo = (String) usuarioTO.getAttribute(Columns.UCA_CSA_CODIGO);
        } else if (!TextHelper.isNull(usuarioTO.getAttribute(Columns.UCO_COR_CODIGO))) {
            Correspondente cor = correspondenteController.findCorrespondenteByPrimaryKey((String) usuarioTO.getAttribute(Columns.UCO_COR_CODIGO), responsavel);
            csaCodigo = cor.getCsaCodigo();
        }
        
        String tpaAutoDesbloqueio = parametroController.getParamCsa(csaCodigo, CodedValues.TPA_AUTO_DESBLOQUEIO_USUARIO_CSA_COR, responsavel);

        return tpaAutoDesbloqueio;
        
    }
}

cannot find symbol



/////////////////////////////////////////////////////////

package com.zetra.econsig.service.consignacao;

import java.math.BigDecimal;
import java.sql.Date;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Iterator;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.interceptor.TransactionAspectSupport;

import com.zetra.econsig.delegate.LogDelegate;
import com.zetra.econsig.dto.CustomTransferObject;
import com.zetra.econsig.dto.TransferObject;
import com.zetra.econsig.dto.entidade.ParamSvcTO;
import com.zetra.econsig.dto.entidade.ServidorTransferObject;
import com.zetra.econsig.dto.parametros.AlterarConsignacaoParametros;
import com.zetra.econsig.dto.parametros.LiquidarConsignacaoParametros;
import com.zetra.econsig.exception.AutorizacaoControllerException;
import com.zetra.econsig.exception.FindException;
import com.zetra.econsig.exception.GerenciadorAutorizacaoException;
import com.zetra.econsig.exception.LogControllerException;
import com.zetra.econsig.exception.PeriodoException;
import com.zetra.econsig.exception.UpdateException;
import com.zetra.econsig.exception.ViewHelperException;
import com.zetra.econsig.exception.ZetraException;
import com.zetra.econsig.helper.consignacao.AutorizacaoHelper;
import com.zetra.econsig.helper.email.EnviaEmailHelper;
import com.zetra.econsig.helper.gerenciadorautorizacao.GerenciadorAutorizacao;
import com.zetra.econsig.helper.gerenciadorautorizacao.GerenciadorAutorizacaoFactory;
import com.zetra.econsig.helper.log.Log;
import com.zetra.econsig.helper.parametro.ParamSist;
import com.zetra.econsig.helper.periodo.PeriodoHelper;
import com.zetra.econsig.helper.seguranca.AcessoSistema;
import com.zetra.econsig.helper.servico.NaturezaRelSvc;
import com.zetra.econsig.helper.sms.SMSHelper;
import com.zetra.econsig.helper.texto.ApplicationResourcesHelper;
import com.zetra.econsig.helper.texto.DateHelper;
import com.zetra.econsig.helper.texto.LocaleHelper;
import com.zetra.econsig.helper.texto.TextHelper;
import com.zetra.econsig.job.process.ProcessaEnvioEmailEntidadesAltAde;
import com.zetra.econsig.persistence.entity.AbstractEntityHome;
import com.zetra.econsig.persistence.entity.AnexoAutorizacaoDescontoHome;
import com.zetra.econsig.persistence.entity.AutDesconto;
import com.zetra.econsig.persistence.entity.AutDescontoHome;
import com.zetra.econsig.persistence.entity.Consignataria;
import com.zetra.econsig.persistence.entity.Convenio;
import com.zetra.econsig.persistence.entity.ConvenioHome;
import com.zetra.econsig.persistence.entity.OcorrenciaAutorizacao;
import com.zetra.econsig.persistence.entity.OcorrenciaAutorizacaoHome;
import com.zetra.econsig.persistence.entity.RegistroServidor;
import com.zetra.econsig.persistence.entity.RegistroServidorHome;
import com.zetra.econsig.persistence.entity.RelacionamentoAutorizacao;
import com.zetra.econsig.persistence.entity.RelacionamentoAutorizacaoHome;
import com.zetra.econsig.persistence.entity.Servidor;
import com.zetra.econsig.persistence.entity.ServidorHome;
import com.zetra.econsig.persistence.entity.Usuario;
import com.zetra.econsig.persistence.entity.UsuarioHome;
import com.zetra.econsig.persistence.entity.VerbaConvenio;
import com.zetra.econsig.persistence.entity.VerbaConvenioHome;
import com.zetra.econsig.persistence.query.consignacao.ListaConsignacaoDeferAutomaticoQuery;
import com.zetra.econsig.persistence.query.consignataria.ObtemCsaBloqRelSvcRequerDeferimentoQuery;
import com.zetra.econsig.persistence.query.parametro.ListaRelacionamentosQuery;
import com.zetra.econsig.service.consignataria.ConsignatariaController;
import com.zetra.econsig.service.folha.PeriodoController;
import com.zetra.econsig.service.parametro.ParametroController;
import com.zetra.econsig.service.servidor.ServidorController;
import com.zetra.econsig.service.sistema.TipoMotivoOperacaoController;
import com.zetra.econsig.values.CodedValues;
import com.zetra.econsig.values.Columns;
import com.zetra.econsig.values.OperacaoEConsigEnum;

/**
 * <p>Title: DeferirConsignacaoControllerBean</p>
 * <p>Description: Session Bean para a operação de Deferimento/Indeferimento de Contrato.</p>
 * <p>Copyright: Copyright (c) 2007</p>
 * <p>Company: ZetraSoft Ltda.</p>
 * $Author$
 * $Revision$
 * $Date$
 */
@Service("deferirConsignacaoController")
@Transactional
public class DeferirConsignacaoControllerBean extends AutorizacaoControllerBean implements DeferirConsignacaoController {
    private static final org.apache.commons.logging.Log LOG = org.apache.commons.logging.LogFactory.getLog(DeferirConsignacaoControllerBean.class);

    @Autowired
    private LiquidarConsignacaoController liquidarConsignacaoController;

    @Autowired
    private ConsignatariaController consignatariaController;

    @Autowired
    private AlterarConsignacaoController alterarConsignacaoController;

    @Autowired
    private CancelarConsignacaoController cancelarConsignacaoController;

    @Autowired
    private ParametroController parametroController;

    @Autowired
    private PesquisarConsignacaoController pesquisarConsignacaoController;

    @Autowired
    private PeriodoController periodoController;

    @Autowired
    private EditarAnexoConsignacaoController editarAnexoConsignacaoController;

    @Autowired
    private ServidorController servidorController;

    @Autowired
    private TipoMotivoOperacaoController tipoMotivoOperacaoController;

    @Autowired
    private SuspenderConsignacaoController suspenderConsignacaoController;

    /**
     * Utilizado pelo caso de uso Deferir Consignação e pela Finalização de compra
     * @param adeCodigo
     * @param tipoMotivoOperacao
     * @param responsavel
     * @throws AutorizacaoControllerException
     */
    @Override
    public void deferir(String adeCodigo, CustomTransferObject tipoMotivoOperacao, AcessoSistema responsavel) throws AutorizacaoControllerException {
        try {
            final AutDesconto autdes = AutDescontoHome.findByPrimaryKeyForUpdate(adeCodigo);

            // Defere a reserva consumindo a senha autorização, caso ela exista.
            deferir(autdes, null, true, false, tipoMotivoOperacao, null, responsavel);

            // Gera o Log de auditoria
            final LogDelegate logDelegate = new LogDelegate(responsavel, Log.AUTORIZACAO, Log.DEFERIR_CONSIGNACAO, Log.LOG_INFORMACAO);
            logDelegate.setAutorizacaoDesconto(adeCodigo);
            logDelegate.write();

        } catch (final Exception ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            if (ex.getClass().equals(AutorizacaoControllerException.class)) {
                throw (AutorizacaoControllerException) ex;
            } else {
                throw new AutorizacaoControllerException("mensagem.erroInternoSistema", responsavel, ex);
            }
        }
    }

    /**
     * Utilizado pelo caso de uso Confirmar Reserva e pelo Autorizar Reserva
     * @param autdes
     * @param senhaUtilizada
     * @param responsavel
     * @return
     * @throws AutorizacaoControllerException
     */
    protected String deferir(AutDesconto autdes, String senhaUtilizada, AcessoSistema responsavel) throws AutorizacaoControllerException {
        return this.deferir(autdes, senhaUtilizada, true, true, null, null, responsavel);
    }

    /**
     * Defere a autorização de desconto
     * @param autdes : Autorização de desconto
     * @param senhaUtilizada : Senha utilizada na confirmação da operação
     * @param consumirSenhaAutorizacao : Indica se a senha de autorização deve ser consumida, caso o sistema possua essa funcionalidade.
     * @param exigirSenhaAutorizacaoCadastrada : Indica se, ao consumir a senha de autorização, é exigido que ela esteja cadastrada.
     * @param tipoMotivoOperacao : Dados do motivo de operação
     * @param responsavel Responsavel
     * @return
     * @throws AutorizacaoControllerException
     */
    @Override
    public String deferir(AutDesconto autdes, String senhaUtilizada, boolean consumirSenhaAutorizacao, boolean exigirSenhaAutorizacaoCadastrada, CustomTransferObject tipoMotivoOperacao, java.util.Date ocaPeriodo, AcessoSistema responsavel) throws AutorizacaoControllerException {
        final String sadCodigo = autdes.getStatusAutorizacaoDesconto().getSadCodigo().trim();
        if (!CodedValues.SAD_AGUARD_CONF.equals(sadCodigo) && !CodedValues.SAD_AGUARD_DEFER.equals(sadCodigo) && !CodedValues.SAD_SOLICITADO.equals(sadCodigo)) {
            throw new AutorizacaoControllerException("mensagem.erro.autorizacao.nao.pode.ser.deferida.situacao.atual.dela.nao.permite.operacao", responsavel);
        }

        try {
            final String adeCodigo = autdes.getAdeCodigo();
            final VerbaConvenio verbaConvenio = VerbaConvenioHome.findByPrimaryKey(autdes.getVerbaConvenio().getVcoCodigo());
            final Convenio convenio = ConvenioHome.findByPrimaryKey(verbaConvenio.getConvenio().getCnvCodigo());
            final String orgCodigo = convenio.getOrgao().getOrgCodigo();
            final String svcCodigo = convenio.getServico().getSvcCodigo();
            final String csaCodigo = convenio.getConsignataria().getCsaCodigo();
            final String rseCodigo = autdes.getRegistroServidor().getRseCodigo();
            final String srsCodigo = RegistroServidorHome.findByPrimaryKey(rseCodigo).getStatusRegistroServidor().getSrsCodigo();

            // Não permite deferir contratos de servidores com situação "Pendente"
            if (CodedValues.SRS_PENDENTE.equals(srsCodigo)) {
                throw new AutorizacaoControllerException("mensagem.erro.deferir.consignacao.servidor.pendente", responsavel);
            }

            final String ocaAlteracaoOrigInsereAltera = concluiInsereAlteraNaoAutomatico(autdes, svcCodigo, orgCodigo, responsavel);
            if (!TextHelper.isNull(ocaAlteracaoOrigInsereAltera)) {
                // se contrato a deferir é de relacionamento insere/altera não automático, retorna a ocorrência de alteração do contrato origem.
                return ocaAlteracaoOrigInsereAltera;
            }

            // Verifica se o sistem bloqueia deferimento caso exista um contrato mais antigo aguandando deferimento
            final boolean bloqueiaDeferimentoContratoSemPrioridade = ParamSist.paramEquals(CodedValues.TPC_BLOQUEIA_DEFERIMENTO_MANUAL_CONTRATO, CodedValues.TPC_SIM, responsavel);
            if (bloqueiaDeferimentoContratoSemPrioridade) {
                // Verifica se existe um contrato mais antigo que o contrato a ser deferido com o status Aguard. Deferimento
                // Os contratos mais antigos são prioritários
                final List<TransferObject> adeCodigosDeferManual = pesquisarConsignacaoController.pesquisarContratosDeferManualDataMenor(rseCodigo, autdes.getAdeData(), responsavel);
                if ((adeCodigosDeferManual != null) && !adeCodigosDeferManual.isEmpty()) {
                    throw new AutorizacaoControllerException("mensagem.erro.deferir.consignacao.existe.contrato.mais.antigo", responsavel);
                }
            }

            // Verifica Bloquear deferimento/indeferimento caso o CPF do gestor seja igual ao CPF do contrato (tpc 469)
            if (ParamSist.paramEquals(CodedValues.TPC_BLOQUEIA_DEFER_INDEFER_CPF_IGUAL, CodedValues.TPC_SIM, responsavel)) {
                final Usuario usuarioResponsavel = UsuarioHome.findByPrimaryKey(responsavel.getUsuCodigo());
                final RegistroServidor rseDonoContrato = RegistroServidorHome.findByPrimaryKey(rseCodigo);
                final Servidor servidorDonoContrato = ServidorHome.findByPrimaryKey(rseDonoContrato.getServidor().getSerCodigo());
                if (!TextHelper.isNull(usuarioResponsavel.getUsuCpf()) && !TextHelper.isNull(servidorDonoContrato.getSerCpf()) && usuarioResponsavel.getUsuCpf().equals(servidorDonoContrato.getSerCpf())) {
                    throw new AutorizacaoControllerException("mensagem.erro.autorizacao.nao.pode.ser.deferida.cpf.gestor.igual.contrato", responsavel);
                }
            }

            // Caso o contrato seja deferimento, origem de uma reativação por parcela rejeitada, precisamos relançar o contrato e modificar a situção
            final boolean deferirReativacaoRejeitadoFolha = ParamSist.getBoolParamSist(CodedValues.TPC_REATIVAR_CONTRATO_SUSP_PRD_REJEITADA_EXIGE_CONF_GESTOR, responsavel) &&
                                                            ParamSist.getBoolParamSist(CodedValues.TPC_SUSPENDER_CONTRATO_PARCELA_REJEITADA_RETORNO, responsavel) && suspenderConsignacaoController.contratoSuspensoPrdRejeitadaReativado(adeCodigo, responsavel);

            // Somente o Gestor ou suporte podem reativar este tipo de contrato
            if (deferirReativacaoRejeitadoFolha && !responsavel.isCseSup()) {
                throw new AutorizacaoControllerException("mensagem.erro.autorizacao.so.pode.ser.deferido.gestor.suporte", responsavel);
            }

            // Busca o parâmetro de incidência de margem do serviço
            final ParamSvcTO paramSvcCse = parametroController.getParamSvcCseTO(svcCodigo, responsavel);
            final Short adeIncMargem = paramSvcCse.getTpsIncideMargem();
            final int diasCancelamentoRenegociacao = !TextHelper.isNull(paramSvcCse.getTpsPrazoDiasCancelamentoRenegociacao()) ? Integer.parseInt(paramSvcCse.getTpsPrazoDiasCancelamentoRenegociacao()) : 0;

            boolean podeConfirmarLiquidacao = true;
            boolean podeConfirmarRenegociacao = false;
            List<AutDesconto> adeRenegociadas = null;
            List<AutDesconto> adeCompradas = null;

            // Verifica se o contrato a ser deferido é fruto de uma compra, para que possamos
            // conferir se todos os contratos comprados já estão liquidados.
            final List<RelacionamentoAutorizacao> radCompra = RelacionamentoAutorizacaoHome.findByDestino(adeCodigo, CodedValues.TNT_CONTROLE_COMPRA);
            if ((radCompra != null) && !radCompra.isEmpty()) {
                adeCompradas = new ArrayList<>();
                for (final RelacionamentoAutorizacao radCompraBean : radCompra) {
                    final String adeCodigoComprada = radCompraBean.getAutDescontoByAdeCodigoOrigem().getAdeCodigo();
                    final AutDesconto adeCompradaBean = AutDescontoHome.findByPrimaryKey(adeCodigoComprada);
                    // Guarda as ades envolvidas na negociação de compra
                    // para evitar ter que busca-las novamente.
                    adeCompradas.add(adeCompradaBean);
                    if (!responsavel.isCseSup()) {
                        final VerbaConvenio vcoCompradaBean = VerbaConvenioHome.findByPrimaryKey(adeCompradaBean.getVerbaConvenio().getVcoCodigo());
                        final Convenio cnvCompradaBean = ConvenioHome.findByPrimaryKey(vcoCompradaBean.getConvenio().getCnvCodigo());
                        final String csaCodigoComprada = cnvCompradaBean.getConsignataria().getCsaCodigo();
                        final String sadCodigoRe = adeCompradaBean.getStatusAutorizacaoDesconto().getSadCodigo().trim();
                        if (!csaCodigoComprada.equals(csaCodigo) && !CodedValues.SAD_LIQUIDADA.equals(sadCodigoRe) && !CodedValues.SAD_CONCLUIDO.equals(sadCodigoRe)) {
                            throw new AutorizacaoControllerException("mensagem.erro.autorizacao.nao.pode.ser.deferida.situacao.atual.algum.contrato.envolvido.transacao.nao.permite.operacao", responsavel);
                        }
                    }
                }
                // Verifica se pode confirmar a liquidação de todas as consignações envolvidas na compra
                podeConfirmarLiquidacao = usuarioPodeConfirmarLiquidacao(adeCompradas, false, false, responsavel);

            } else {
                // Verifica se o contrato a ser deferido é fruto de uma renegociação, para que possamos
                // conferir se todos os contratos renegociados podem ser liquidados
                final List<RelacionamentoAutorizacao> radRenegociacao = RelacionamentoAutorizacaoHome.findByDestino(adeCodigo, CodedValues.TNT_CONTROLE_RENEGOCIACAO);
                if ((radRenegociacao != null) && !radRenegociacao.isEmpty()) {
                    adeRenegociadas = new ArrayList<>();

                    BigDecimal vlrTotalRenegociacao = new BigDecimal("0.00");
                    for (final RelacionamentoAutorizacao radRenegociacaoBean : radRenegociacao) {
                        final String adeCodigoRenegociada = radRenegociacaoBean.getAutDescontoByAdeCodigoOrigem().getAdeCodigo();
                        final AutDesconto adeRenegociadaBean = AutDescontoHome.findByPrimaryKey(adeCodigoRenegociada);
                        adeRenegociadas.add(adeRenegociadaBean);

                        if (AutorizacaoHelper.valorMargemDisponivelRenegociacao(adeIncMargem, adeRenegociadaBean.getAdeIncMargem(), responsavel)) {
                            vlrTotalRenegociacao = vlrTotalRenegociacao.add(adeRenegociadaBean.getAdeVlr());
                        }
                    }

                    // Se é uma renegociação, verifica se esta pode ser confirmada sem uma segunda operação
                    podeConfirmarRenegociacao = podeConfirmarRenegociacao(autdes.getAdeVlr(), svcCodigo, csaCodigo, vlrTotalRenegociacao, responsavel);

                    // Verifica se pode confirmar a liquidação de todas as consignações envolvidas na renegociação
                    podeConfirmarLiquidacao = usuarioPodeConfirmarLiquidacao(adeRenegociadas, true, podeConfirmarRenegociacao, responsavel);
                }
            }

            String ocaCodigo = null;

            if (!podeConfirmarLiquidacao) {
                if (!CodedValues.SAD_AGUARD_CONF.equals(sadCodigo)) {
                    // Altera o status da autorização para SAD_AGUARD_CONF caso não esteja nesta situação
                    ocaCodigo = modificaSituacaoADE(autdes, CodedValues.SAD_AGUARD_CONF, responsavel);

                    if ((ocaCodigo != null) && (tipoMotivoOperacao != null)) {
                        // grava motivo da operacao
                        tipoMotivoOperacao.setAttribute(Columns.OCA_CODIGO, ocaCodigo);
                        tipoMotivoOperacaoController.gravarMotivoOperacaoConsignacao(tipoMotivoOperacao, responsavel);
                    }
                }

                // Registra ocorrência de confirmação de liquidação nas operações renegociadas/compradas
                if (responsavel.temPermissao(CodedValues.FUN_CONF_LIQUIDACAO_COMPRA) && (adeCompradas != null) && !adeCompradas.isEmpty()) {
                    for (final AutDesconto adeComprada : adeCompradas) {
                        criaOcorrenciaADE(adeComprada.getAdeCodigo(), CodedValues.TOC_CONFIRMACAO_LIQUIDACAO_ADE, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.autorizacao.confirmacao.liquidacao", responsavel), responsavel);
                    }
                } else if (responsavel.temPermissao(CodedValues.FUN_CONFIRMAR_RENEGOCIACAO) && (adeRenegociadas != null) && !adeRenegociadas.isEmpty()) {
                    for (final AutDesconto adeRenegociadaBean : adeRenegociadas) {
                        criaOcorrenciaADE(adeRenegociadaBean.getAdeCodigo(), CodedValues.TOC_CONFIRMACAO_LIQUIDACAO_ADE, ApplicationResourcesHelper.getMessage("mensagem.ocorrencia.autorizacao.confirmacao.liquidacao", responsavel), responsavel);
                    }
                }

            } else {
                // Calcula data inicial do período atual
                Date dataInicial = PeriodoHelper.getInstance().getPeriodoAtual(orgCodigo, responsavel);
                Date adeAnoMesIni = DateHelper.toSQLDate(autdes.getAdeAnoMesIni());

                boolean ocorrenciaInformacaoDataInicioMargem = false;
                // Se o contrato deferido for destino de renegociação, verifica se o período de liquidação do(s) contrato(s) origem
                // confere com o período atual. Caso o período de liquidação seja maior que o período atual, ajustar o período
                // do contrato novo (que está sendo deferido) para o mesmo período de liquidação do(s) contrato(s) renegociado(s)
                // para evitar que sejam realizados dois descontos no mesmo período.
                Date ocaPeriodoRenegociacao = dataInicial;
                Date ocaPeriodoDeferimento = dataInicial;
                if ((adeRenegociadas != null) && !adeRenegociadas.isEmpty()) {
                    // recupera o período em que deve ser criada a ocorrência de liquidação do contrato renegociado
                    ocaPeriodoRenegociacao = (Date) AutorizacaoHelper.recuperarPeriodoOcorrenciaLiquidacao(orgCodigo, csaCodigo, svcCodigo, autdes.getAdeData(), autdes.getAdeAnoMesIni(), responsavel);
                    // se a data inicial do contrato deferido for menor que a data da liquidação do contrato renegociado, altera a data inicial
                    if (ocaPeriodoDeferimento.compareTo(ocaPeriodoRenegociacao) < 0) {
                        ocaPeriodoDeferimento = ocaPeriodoRenegociacao;
                    }
                }

                Date dataInicioFimAde = calcularDataIniFimMargemExtra(rseCodigo, ocaPeriodoDeferimento, adeIncMargem, true, false, responsavel);
                if ((dataInicioFimAde != null) && (dataInicioFimAde.compareTo(ocaPeriodoDeferimento) > 0)) {
                    alterarPeriodoInclusao(autdes, dataInicioFimAde, orgCodigo, responsavel);
                    ocorrenciaInformacaoDataInicioMargem = true;
                }

                boolean alteraDataInicial = true;

                // Verifica se mantem a data inicial do contrato deferido pós-corte e pré-exportação
                final boolean mantemDataIniDeferidaPosCorte = ParamSist.paramEquals(CodedValues.TPC_MANTEM_DATA_INI_ADE_DEFERIDA_POS_CORTE, CodedValues.TPC_SIM, responsavel);
                if (mantemDataIniDeferidaPosCorte) {
                    final java.util.Date ultPeriodoExportado = periodoController.obtemUltimoPeriodoExportado(Arrays.asList(orgCodigo), null, false, null, responsavel);
                    alteraDataInicial = (ultPeriodoExportado != null) && (ultPeriodoExportado.compareTo(adeAnoMesIni) >= 0);
                }

                // Se adeAnoMesIni é menor que a dataInicial do período, ou uma
                // data inicial foi passada, então altera a data incial da autorização
                if (alteraDataInicial && (adeAnoMesIni.compareTo(dataInicial) < 0)) {
                    // Valida o período inicial calculado
                    dataInicial = PeriodoHelper.getInstance().validarAdeAnoMesIni(orgCodigo, dataInicial, responsavel);
                    // Redefine os valores da data inicial e inicial ref
                    adeAnoMesIni = dataInicial;

                    dataInicioFimAde = calcularDataIniFimMargemExtra(rseCodigo, adeAnoMesIni, adeIncMargem, true, false, responsavel);
                    if ((dataInicioFimAde != null) && (dataInicioFimAde.compareTo(adeAnoMesIni) > 0)) {
                        adeAnoMesIni = dataInicioFimAde;
                        ocorrenciaInformacaoDataInicioMargem = true;
                    }
                    alterarPeriodoInclusao(autdes, adeAnoMesIni, orgCodigo, responsavel);
                }

                // Altera o status da autorização
                ocaCodigo = modificaSituacaoADE(autdes, CodedValues.SAD_DEFERIDA, responsavel);

                String msgOcaDeferimento = ApplicationResourcesHelper.getMessage("mensagem.informacao.contrato.deferido", responsavel);

                if (deferirReativacaoRejeitadoFolha) {
                    msgOcaDeferimento = ApplicationResourcesHelper.getMessage("mensagem.informacao.contrato.deferido.parcela.rejeitada", responsavel);

                    if (ParamSist.getBoolParamSist(CodedValues.TPC_EXPORTACAO_APENAS_INICIAL, responsavel)) {
                        criaOcorrenciaADE(adeCodigo, CodedValues.TOC_RELANCAMENTO, ApplicationResourcesHelper.getMessage("mensagem.informacao.contrato.relancamento.parcela.rejeitada", responsavel), ocaPeriodoDeferimento, responsavel);
                    }
                }

                // Insere ocorrência de deferimento.
                criaOcorrenciaADE(adeCodigo, CodedValues.TOC_DEFERIMENTO_CONTRATO, msgOcaDeferimento, ocaPeriodoDeferimento, responsavel);

                if ((ocaCodigo != null) && (tipoMotivoOperacao != null)) {
                    // grava motivo da operacao
                    tipoMotivoOperacao.setAttribute(Columns.OCA_CODIGO, ocaCodigo);
                    tipoMotivoOperacaoController.gravarMotivoOperacaoConsignacao(tipoMotivoOperacao, responsavel);
                }

                if (consumirSenhaAutorizacao) {
                    // Consome a senha de autorização utilizada para reserva.
                    consumirSenhaDeAutorizacao(adeCodigo, CodedValues.SAD_DEFERIDA, rseCodigo, svcCodigo, csaCodigo, senhaUtilizada, exigirSenhaAutorizacaoCadastrada, false, CodedValues.SAD_SOLICITADO.equals(sadCodigo), false, responsavel);
                }

                if ((adeCompradas != null) && !adeCompradas.isEmpty()) {
                    for (final AutDesconto adeComprada : adeCompradas) {
                        final String adeCodigoComprada = adeComprada.getAdeCodigo();
                        // Se o contrato esta aguardando liquidação de compra
                        if (CodedValues.SAD_AGUARD_LIQUI_COMPRA.equals(adeComprada.getStatusAutorizacaoDesconto().getSadCodigo())) {
                            liquidarConsignacaoController.liquidar(adeCodigoComprada, null, null, responsavel);
                        }
                    }

                    // Atualiza a incidência de margem, apesar do método finalizar compra já o fazer
                    // pois o objeto "autdes" carregado neste método local ainda está com adeIncMargem
                    // incorreto, e o update ao final deste mesmo método poderia sobrepor o valor correto.
                    // Esta situação só ocorre quando o confirmar/deferir é chamado sem que todos os
                    // contratos antigos estejam liquidados.
                    if (!adeIncMargem.equals(CodedValues.INCIDE_MARGEM_NAO)) {
                        autdes.setAdeIncMargem(adeIncMargem);
                    }
                } else if ((adeRenegociadas != null) && !adeRenegociadas.isEmpty()) {
                    // Calcula a carência mínima do novo contrato de acordo com os parâmetros de serviço
                    Integer adeCarenciaMin = AutorizacaoHelper.calcularCarenciaContratoDestinoRenegociacao(orgCodigo, csaCodigo, svcCodigo, autdes.getAdeCarencia(), ocaPeriodoRenegociacao, responsavel);
                    if (adeCarenciaMin.intValue() > autdes.getAdeCarencia().intValue()) {
                        // Redefine os valores da data inicial e inicial ref
                        adeCarenciaMin = parametroController.calcularAdeCarenciaDiaCorteCsa(adeCarenciaMin, csaCodigo, orgCodigo, responsavel);
                        autdes.setAdeCarencia(adeCarenciaMin);
                        adeAnoMesIni = PeriodoHelper.getInstance().calcularAdeAnoMesIni(orgCodigo, DateHelper.toSQLDate(autdes.getAdeAnoMesIni()), adeCarenciaMin, autdes.getAdePeriodicidade(), responsavel);

                        dataInicioFimAde = calcularDataIniFimMargemExtra(rseCodigo, adeAnoMesIni, adeIncMargem, true, false, responsavel);

                        if ((dataInicioFimAde != null) && (dataInicioFimAde.compareTo(adeAnoMesIni) > 0)) {
                            adeAnoMesIni = dataInicioFimAde;
                            ocorrenciaInformacaoDataInicioMargem = true;
                        }
                        alterarPeriodoInclusao(autdes, adeAnoMesIni, orgCodigo, responsavel);
                    }

                    // Pega código da autorização que foi renegociada e que está
                    // aguardando a confirmação/deferimento desta autorização para ser liquidada
                    BigDecimal totalRenegociado = BigDecimal.ZERO;
                    for (final AutDesconto adeRenegociadaBean : adeRenegociadas) {
                        final String adeCodigoRenegociada = adeRenegociadaBean.getAdeCodigo();

                        final LiquidarConsignacaoParametros parametros = new LiquidarConsignacaoParametros();
                        parametros.setRenegociacao(true);
                        parametros.setPodeConfirmarRenegociacao(podeConfirmarRenegociacao);
                        parametros.setOcaPeriodo(ocaPeriodoRenegociacao);

                        // Verifica se as ADEs renegociadas possuem ocorrência para manutenção da data de encerramento igual à
                        // data de inclusão da nova consignação, e em caso positivo, usa a adeAnoMesIni calculada anteriormente
                        // como período das ocorrências de liquidação
                        final List<OcorrenciaAutorizacao> ocorrenciasManutencaoDtEncerramento = OcorrenciaAutorizacaoHome.findByAdeTocCodigo(adeCodigoRenegociada, CodedValues.TOC_RENEGOCIACAO_ALTERACAO_DT_ENCERRAMENTO);
                        if ((ocorrenciasManutencaoDtEncerramento != null) && !ocorrenciasManutencaoDtEncerramento.isEmpty()) {
                            parametros.setOcaPeriodo(autdes.getAdeAnoMesIni());
                        }

                        // Executa a rotina de liquidação da consignação renegociada
                        liquidarConsignacaoController.liquidar(adeCodigoRenegociada, null, parametros, responsavel);

                        // Soma o valor de todas as ade's renegociadas
                        totalRenegociado = totalRenegociado.add(adeRenegociadaBean.getAdeVlr());
                    }

                    // Se incide margem desta consignação liquidada é igual a sim,
                    // então altera este parâmetro na nova autorização que está
                    // sendo deferida, e atualiza a margem do servidor de acordo
                    // com o valor da nova autrização
                    if (!adeIncMargem.equals(CodedValues.INCIDE_MARGEM_NAO)) {
                        /**
                         * Recupera o parametro que indica se o sistema permite ou não a confirmação de contratos
                         * quando o servidor não possui mais margem. Isso acontece com processos de renegociações
                         * que se prolongaram além da carga de margem, onde o servidor pode ter sofrido uma redução
                         * de margem.
                         */
                        final boolean podeConfirmarMN = ParamSist.paramEquals(CodedValues.TPC_CONFIRMA_ADE_SEM_MARGEM, CodedValues.TPC_SIM, responsavel);
                        // atualiza o valor da variavel que indica se a margem deve ou não ser validada.
                        boolean validaMargem = !podeConfirmarMN;
                        // Antes de confirmar a reserva verifica o relacionamento entre servicos
                        // Se o serviço do contrato é origem de um relacionamento de alongamento, então não valida a margem do servidor
                        final boolean temAlongamento = ParamSist.paramEquals(CodedValues.TPC_TEM_ALONGAMENTO_CONTRATO, CodedValues.TPC_SIM, responsavel);
                        if (temAlongamento) {
                            final ListaRelacionamentosQuery queryRel = new ListaRelacionamentosQuery();
                            queryRel.tntCodigo = CodedValues.TNT_ALONGAMENTO;
                            queryRel.svcCodigoOrigem = svcCodigo;
                            queryRel.svcCodigoDestino = null;
                            final List<TransferObject> relacionamentoAlongamento = queryRel.executarDTO();
                            if ((relacionamentoAlongamento != null) && !relacionamentoAlongamento.isEmpty()) {
                                validaMargem = false;
                            }
                        }

                        // Atualiza a incidência de margem
                        autdes.setAdeIncMargem(adeIncMargem);
                        boolean prendeMargemRenegociacaoMenor = false;
                        String ocaCodigoPrendeMargemReneg = null;

                        if (ParamSist.getBoolParamSist(CodedValues.TPC_PRENDER_MARGEM_RENEG_CONTRATRO_NOVO_MENOR_ANTIGOS, responsavel) && (diasCancelamentoRenegociacao > 0) && (totalRenegociado.subtract(autdes.getAdeVlr()).signum() == 1)) {
                            prendeMargemRenegociacaoMenor = true;
                            ocaCodigoPrendeMargemReneg = criaOcorrenciaADE(autdes.getAdeCodigo(), CodedValues.TOC_RETENCAO_MARGEM_DENTRO_PRAZO_RENEGOCIACAO, ApplicationResourcesHelper.getMessage("mensagem.info.ocorrencia.margem.preza.renegociacao", responsavel), totalRenegociado, autdes.getAdeVlr(), responsavel);
                        }

                        // Se o valor da nova autorização é maior do que o da antiga
                        // prende da margem apenas o valor da antiga, pois a diferença
                        // de valor já está presa OU prende a margem quando o valor da renegociação é menor que o
                        // contrato novo, até que o prazo de cancelamento tenha sido cumprido, predemos o valor total da renegocição que é o que ele já tinha
                        // na margem
                        try {
                            if ((autdes.getAdeVlr().compareTo(totalRenegociado) == 1) || prendeMargemRenegociacaoMenor) {
                                atualizaMargem(rseCodigo, adeIncMargem, totalRenegociado, validaMargem, true, true, TextHelper.isNull(ocaCodigoPrendeMargemReneg) ? ocaCodigo : ocaCodigoPrendeMargemReneg, csaCodigo, svcCodigo, null, responsavel);
                            } else {
                                atualizaMargem(rseCodigo, adeIncMargem, autdes.getAdeVlr(), validaMargem, true, true, ocaCodigo, csaCodigo, svcCodigo, null, responsavel);
                            }
                        } catch (final AutorizacaoControllerException ex) {
                            BigDecimal limite = new BigDecimal("0.00");
                            final CustomTransferObject param = getParametroSvc(CodedValues.TPS_VLR_LIMITE_ADE_SEM_MARGEM, svcCodigo, BigDecimal.ZERO, false, null);
                            if ((param != null) && (param.getAttribute(Columns.PSE_VLR) != null)) {
                                try {
                                    limite = new BigDecimal(param.getAttribute(Columns.PSE_VLR).toString());
                                } catch (final NumberFormatException nfex) {
                                    LOG.debug("Valor do parametro de limite de ade sem margem invalido: " + param.getAttribute(Columns.PSE_VLR));
                                }
                            }
                            /*
                             * Se não foi possível reservar todo o valor, verifica se o serviço tem
                             * limite para autorizações sem margem. Verifica também se não é um compulsório,
                             * e caso positivo, pesquisa o vlr total dos contratos que podem ser estocados
                             * liberando assim vlr de margem para a inclusão
                             */
                            // DESENV-14240 - Ao deferir um consigação feita com usuário sem permissão de confirmar é necessário validar o limite.
                            atualizaMargemCompulsorios(rseCodigo, svcCodigo, csaCodigo, autdes.getAdeCodigo(), null, autdes.getAdeVlr(), limite, adeIncMargem, null, true, true, false, responsavel);
                        }
                    }
                }

                if (ocorrenciaInformacaoDataInicioMargem) {
                    criaOcorrenciaADE(autdes.getAdeCodigo(), CodedValues.TOC_INFORMACAO, ApplicationResourcesHelper.getMessage("mensagem.info.calcular.data.inicio.fim.margem.extra.rse.data.margem.maior", responsavel), responsavel);
                }

                // Executa a atualização do contrato
                AbstractEntityHome.update(autdes);

                // Defere os contratos de correção de saldo relacionados a este contrato
                final List<RelacionamentoAutorizacao> radCorrecao = RelacionamentoAutorizacaoHome.findByOrigem(adeCodigo, CodedValues.TNT_CORRECAO_SALDO);
                if ((radCorrecao != null) && !radCorrecao.isEmpty()) {
                    for (final RelacionamentoAutorizacao radCorrecaoBean : radCorrecao) {
                        final String adeCodigoCorrecao = radCorrecaoBean.getAutDescontoByAdeCodigoDestino().getAdeCodigo();
                        final AutDesconto adeCorrecao = AutDescontoHome.findByPrimaryKeyForUpdate(adeCodigoCorrecao);
                        this.deferir(adeCorrecao, senhaUtilizada, false, false, tipoMotivoOperacao, ocaPeriodo, responsavel);
                    }
                }

                // Finaliza o processo de deferimento do contrato.
                finalizarDeferimentoConsignacao(adeCodigo, svcCodigo, responsavel);

                // DESENV-8933: se responsável pela operação tiver seu papel configurado para disparar e-mail de alerta de alteração na ade
                // para entidades relacionadas a este, também configuradas na tabela tb_destinatario_email
                final ProcessaEnvioEmailEntidadesAltAde processoEmail = new ProcessaEnvioEmailEntidadesAltAde(OperacaoEConsigEnum.DEFERIR_CONSIGNACAO, adeCodigo, null, tipoMotivoOperacao, responsavel);
                processoEmail.start();

                // Envia mensagem de deferimento da consignação para o servidor
                if (ParamSist.paramEquals(CodedValues.TPC_HABILITA_ENVIO_DE_SMS_EMAIL_APOS_DEFERIMENTO_CONSIGNACAO, CodedValues.TPC_SIM, AcessoSistema.getAcessoUsuarioSistema())) {
                    enviaMensagem(autdes.getAdeNumero(), svcCodigo, convenio.getConsignataria(), rseCodigo, responsavel);
                }
            }

            return ocaCodigo;
        } catch (final Exception ex) {
            LOG.error(ex.getMessage(), ex);
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            if (ex.getClass().equals(AutorizacaoControllerException.class) || ex.getClass().equals(GerenciadorAutorizacaoException.class) || ex.getClass().equals(PeriodoException.class)) {
                throw new AutorizacaoControllerException(ex);
            } else {
                throw new AutorizacaoControllerException("mensagem.erroInternoSistema", responsavel, ex);
            }
        }
    }

    private void alterarPeriodoInclusao(AutDesconto autdes, Date adeAnoMesIni, String orgCodigo, AcessoSistema responsavel) throws PeriodoException, FindException, UpdateException, AutorizacaoControllerException {
        // Atualiza data inicial e data inicial de referência
        autdes.setAdeAnoMesIni(adeAnoMesIni);
        autdes.setAdeAnoMesIniRef(adeAnoMesIni);

        // Se a consignação tem prazo definido, atualiza também a data final
        if (autdes.getAdePrazo() != null) {
            final Date adeAnoMesFim = PeriodoHelper.getInstance().calcularAdeAnoMesFim(orgCodigo, adeAnoMesIni, autdes.getAdePrazo(), autdes.getAdePeriodicidade(), responsavel);

            calcularDataIniFimMargemExtra(autdes.getRseCodigo(), adeAnoMesFim, autdes.getAdeIncMargem(), false, true, responsavel);
            autdes.setAdeAnoMesFim(adeAnoMesFim);
            autdes.setAdeAnoMesFimRef(adeAnoMesFim);
        }

        // Pesquisa ocorrência de inclusão para atualização do período
        final List<OcorrenciaAutorizacao> ocorrencias = OcorrenciaAutorizacaoHome.findByAdeTocCodigo(autdes.getAdeCodigo(), CodedValues.TOC_TARIF_RESERVA);
        if ((ocorrencias != null) && !ocorrencias.isEmpty()) {
            for (final OcorrenciaAutorizacao ocorrencia : ocorrencias) {
                ocorrencia.setOcaPeriodo(adeAnoMesIni);
                AbstractEntityHome.update(ocorrencia);
            }
        }

        // Atualiza o período dos anexos que a consignação eventualmente possua, de acordo com o período de lançamento no momento do deferimento.
        final CustomTransferObject criterio = new CustomTransferObject();
        criterio.setAttribute(Columns.AAD_ADE_CODIGO, autdes.getAdeCodigo());

        try {
            final List<TransferObject> anexos = editarAnexoConsignacaoController.lstAnexoAutorizacaoDesconto(criterio, -1, -1, responsavel);
            for (final TransferObject anexo : anexos) {
                AnexoAutorizacaoDescontoHome.updateDataPeriodo(autdes.getAdeCodigo(), anexo.getAttribute(Columns.AAD_NOME).toString(), adeAnoMesIni);
            }
        } catch (final AutorizacaoControllerException ex) {
            LOG.error(ex.getMessage(), ex);
        }
    }

    @Override
    public void indeferir(String adeCodigo, CustomTransferObject tipoMotivoOperacao, AcessoSistema responsavel) throws AutorizacaoControllerException {
        try {
            final AutDesconto adeBean = AutDescontoHome.findByPrimaryKeyForUpdate(adeCodigo);
            if (!CodedValues.SAD_AGUARD_DEFER.equals(adeBean.getStatusAutorizacaoDesconto().getSadCodigo())) {
                throw new AutorizacaoControllerException("mensagem.erro.autorizacao.nao.pode.ser.indeferida.situacao.atual.dela.nao.permite.operacao", responsavel, adeBean.getStatusAutorizacaoDesconto().getSadDescricao());
            }

            final VerbaConvenio verbaConvenio = VerbaConvenioHome.findByPrimaryKey(adeBean.getVerbaConvenio().getVcoCodigo());
            final Convenio convenio = ConvenioHome.findByPrimaryKey(verbaConvenio.getConvenio().getCnvCodigo());
            final String csaCodigo = convenio.getConsignataria().getCsaCodigo();
            final String svcCodigo = convenio.getServico().getSvcCodigo();

            //verifica Bloquear deferimento/indeferimento caso o CPF do gestor seja igual ao CPF do contrato (tpc 469)
            if (ParamSist.paramEquals(CodedValues.TPC_BLOQUEIA_DEFER_INDEFER_CPF_IGUAL, CodedValues.TPC_SIM, responsavel)) {
                final Usuario usuarioResponsavel = UsuarioHome.findByPrimaryKey(responsavel.getUsuCodigo());
                final RegistroServidor rseDonoContrato = RegistroServidorHome.findByPrimaryKey(adeBean.getRegistroServidor().getRseCodigo());
                final Servidor servidorDonoContrato = ServidorHome.findByPrimaryKey(rseDonoContrato.getServidor().getSerCodigo());
                if (!TextHelper.isNull(usuarioResponsavel.getUsuCpf()) && !TextHelper.isNull(servidorDonoContrato.getSerCpf()) && usuarioResponsavel.getUsuCpf().equals(servidorDonoContrato.getSerCpf())) {
                    throw new AutorizacaoControllerException("mensagem.erro.autorizacao.nao.pode.ser.indeferida.cpf.gestor.igual.contrato", responsavel);
                }
            }

            final String ocaCodigo = modificaSituacaoADE(adeBean, CodedValues.SAD_INDEFERIDA, responsavel);

            // Insere ocorrência de deferimento.
            criaOcorrenciaADE(adeCodigo, CodedValues.TOC_INDEFERIMENTO_CONTRATO, ApplicationResourcesHelper.getMessage("mensagem.informacao.contrato.indeferido", responsavel).toUpperCase(), responsavel);

            // Volta a situação da autorização que foi renegociada para esta ade que está sendo cancelada.
            // Pega código da autorização que foi renegociada e que está
            // aguardando a confirmação/deferimento desta autorização para ser liquidada
            final List<RelacionamentoAutorizacao> radRenegociacao = RelacionamentoAutorizacaoHome.findByDestino(adeCodigo, CodedValues.TNT_CONTROLE_RENEGOCIACAO);
            if ((radRenegociacao != null) && !radRenegociacao.isEmpty()) {
                BigDecimal totalRenegociado = BigDecimal.ZERO;
                Short adeIncMargem = CodedValues.INCIDE_MARGEM_SIM;
                for (final RelacionamentoAutorizacao radBean : radRenegociacao) {
                    final String adeCodigoRenegociada = radBean.getAutDescontoByAdeCodigoOrigem().getAdeCodigo();

                    final AutDesconto adeRenegociadaBean = AutDescontoHome.findByPrimaryKeyForUpdate(adeCodigoRenegociada);

                    // Somente modifica a ADE que está aguardando liquidação. (DESENV-7630)
                    if (CodedValues.SAD_AGUARD_LIQUIDACAO.equals(adeRenegociadaBean.getStatusAutorizacaoDesconto().getSadCodigo())) {
                        final String sadNovo = ((adeRenegociadaBean.getAdePrdPagas() != null) && (adeRenegociadaBean.getAdePrdPagas().intValue() > 0)) ? CodedValues.SAD_EMANDAMENTO : CodedValues.SAD_DEFERIDA;
                        modificaSituacaoADE(adeRenegociadaBean, sadNovo, responsavel);
                    }

                    totalRenegociado = totalRenegociado.add(adeRenegociadaBean.getAdeVlr());
                    adeIncMargem = (adeRenegociadaBean.getAdeIncMargem() != null) ? adeRenegociadaBean.getAdeIncMargem() : CodedValues.INCIDE_MARGEM_SIM;
                }
                if (!adeIncMargem.equals(CodedValues.INCIDE_MARGEM_NAO)) {
                    // Se o valor da autorização nova é maior do que a renegociada, libera
                    // a diferença de valores presa na renegociação
                    final BigDecimal diff = adeBean.getAdeVlr().subtract(totalRenegociado);
                    if (diff.signum() == 1) {
                        /*
                         * Passa false para validação de margem, pois estamos liberando margem
                         * e não prendendo.
                         */
                        atualizaMargem(adeBean.getRegistroServidor().getRseCodigo(), adeIncMargem, diff.negate(), false, true, true, ocaCodigo, csaCodigo, svcCodigo, null, responsavel);
                    }
                }
            }

            // grava motivo da operacao
            if ((ocaCodigo != null) && (tipoMotivoOperacao != null)) {
                tipoMotivoOperacao.setAttribute(Columns.OCA_CODIGO, ocaCodigo);
                tipoMotivoOperacaoController.gravarMotivoOperacaoConsignacao(tipoMotivoOperacao, responsavel);
            }

            // DESENV-8933: se responsável pela operação tiver seu papel configurado para disparar e-mail de alerta de alteração na ade
            // para entidades relacionadas a este, também configuradas na tabela tb_destinatario_email
            final ProcessaEnvioEmailEntidadesAltAde processoEmail = new ProcessaEnvioEmailEntidadesAltAde(OperacaoEConsigEnum.INDEFERIR_CONSIGNACAO, adeCodigo, null, tipoMotivoOperacao, responsavel);
            processoEmail.start();

            // Gera o Log de auditoria
            final LogDelegate logDelegate = new LogDelegate(responsavel, Log.AUTORIZACAO, Log.INDEFERIR_CONSIGNACAO, Log.LOG_INFORMACAO);
            logDelegate.setAutorizacaoDesconto(adeCodigo);
            logDelegate.write();

        } catch (final Exception ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            if (ex.getClass().equals(AutorizacaoControllerException.class)) {
                throw new AutorizacaoControllerException(ex);
            } else {
                throw new AutorizacaoControllerException("mensagem.erroInternoSistema", responsavel, ex);
            }
        }
    }

    /**
     * Realiza a finalização do processo de deferimento de consignação.
     * @param adeCodigo Contrato sendo deferido.
     * @param svcCodigo Código do serviço da consignação
     * @param responsavel
     * @throws GerenciadorAutorizacaoException
     */
    private void finalizarDeferimentoConsignacao(String adeCodigo, String svcCodigo, AcessoSistema responsavel) throws GerenciadorAutorizacaoException {
        try {
            // Classe de especialização das operações de autorização por serviço.
            GerenciadorAutorizacao gerenciadorAutorizacaoServico = null;

            // Verifica se há classe específica de manutenção de autorização para o serviço.
            final CustomTransferObject paramClasseGerenciadorAutorizacao = getParametroSvc(CodedValues.TPS_CLASSE_GERENCIADOR_AUTORIZACAO, svcCodigo, "", false, null);
            if ((paramClasseGerenciadorAutorizacao != null) && !TextHelper.isNull(paramClasseGerenciadorAutorizacao.getAttribute(Columns.PSE_VLR))) {
                final String nomeClasseGerenciadorAutorizacao = (String) paramClasseGerenciadorAutorizacao.getAttribute(Columns.PSE_VLR);
                gerenciadorAutorizacaoServico = GerenciadorAutorizacaoFactory.getGerenciadorAutorizacao(nomeClasseGerenciadorAutorizacao);
            }

            // Se há classe específica de manutençao das autorizações do serviço.
            if (gerenciadorAutorizacaoServico != null) {
                final long horaInicioFinalizacao = java.util.Calendar.getInstance().getTimeInMillis();
                gerenciadorAutorizacaoServico.finalizarDeferimentoConsignacao(adeCodigo);
                LOG.debug("TOTAL FINALIZACAO DEFERIMENTO CONSIGNACAO (" + responsavel.getUsuCodigo() + ") = " + (java.util.Calendar.getInstance().getTimeInMillis() - horaInicioFinalizacao) + " ms");
            }
        } catch (final AutorizacaoControllerException ex) {
            throw new GerenciadorAutorizacaoException("mensagem.erro.finalizar.deferimento.consignacao", responsavel, ex);
        }
    }

    /**
     * confere se o contrato a ser confirmado é destino de um relacionamento insere/altera.
     * Se sim, este contrato é cancelado e o contrato origem é alterado de acordo com as regras de insere/altera
     * @param autdesDestino - adeCodigo do contrato candidato a ser destino de relacionamento insere/altera
     * @param svcCodigo
     * @param responsavel
     * @return
     * @throws AutorizacaoControllerException
     */
    private String concluiInsereAlteraNaoAutomatico(AutDesconto autdesDestino, String svcCodigo, String orgCodigo, AcessoSistema responsavel) throws AutorizacaoControllerException {
        List<RelacionamentoAutorizacao> lstRel = null;
        try {
            lstRel = RelacionamentoAutorizacaoHome.findByDestino(autdesDestino.getAdeCodigo(), CodedValues.TNT_CONTRATO_GERADO_INSERE_ALTERA);
        } catch (final FindException e) {
            return null;
        }

        if ((lstRel != null) && !lstRel.isEmpty()) {
            final Integer adePrazoDestino = autdesDestino.getAdePrazo();

            final RelacionamentoAutorizacao relInsereAltera = lstRel.iterator().next();

            final String adeCodigoOrigem = relInsereAltera.getAdeCodigoOrigem();
            AutDesconto autdesOrigem = null;
            try {
                autdesOrigem = AutDescontoHome.findByPrimaryKey(adeCodigoOrigem);
            } catch (final FindException ex) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new AutorizacaoControllerException("mensagem.erro.contrato.nao.encontrado", responsavel, ex);
            }

            //caso a ADE pai esteja suspensa não faz o deferimento
            if (CodedValues.SAD_CODIGOS_SUSPENSOS.contains(autdesOrigem.getStatusAutorizacaoDesconto().getSadCodigo())) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw new AutorizacaoControllerException("mensagem.erro.insere.altera.ade.situacao.nao.permitida", responsavel);
            }

            BigDecimal adeVlr = autdesOrigem.getAdeVlr();
            BigDecimal adeVlrTac = autdesOrigem.getAdeVlrTac();
            BigDecimal adeVlrIof = autdesOrigem.getAdeVlrIof();
            BigDecimal adeVlrLiquido = autdesOrigem.getAdeVlrLiquido();
            BigDecimal adeVlrMensVinc = autdesOrigem.getAdeVlrMensVinc();

            final BigDecimal ocaAdeVlrAnt = adeVlr;
            adeVlr = adeVlr.add(autdesDestino.getAdeVlr());

            if ((adeVlrTac != null) && (autdesDestino.getAdeVlrTac() != null)) {
                adeVlrTac = adeVlrTac.add(autdesDestino.getAdeVlrTac());
            }
            if ((adeVlrIof != null) && (autdesDestino.getAdeVlrIof() != null)) {
                adeVlrIof = adeVlrIof.add(autdesDestino.getAdeVlrIof());
            }
            if ((adeVlrLiquido != null) && (autdesDestino.getAdeVlrLiquido() != null)) {
                adeVlrLiquido = adeVlrLiquido.add(autdesDestino.getAdeVlrLiquido());
            }
            if ((adeVlrMensVinc != null) && (autdesDestino.getAdeVlrMensVinc() != null)) {
                adeVlrMensVinc = adeVlrMensVinc.add(autdesDestino.getAdeVlrMensVinc());
            }

            // insereAlteraUsandoMaiorPrazo : True, se o serviço é do tipo Insere/Altera independente do período
            final CustomTransferObject paramIncAltUsaMaiorPrazo = getParametroSvc(CodedValues.TPS_OP_INSERE_ALTERA_USA_MAIOR_PRAZO, svcCodigo, Boolean.FALSE, false, null);
            final boolean insereAlteraUsandoMaiorPrazo = ((paramIncAltUsaMaiorPrazo != null) && (paramIncAltUsaMaiorPrazo.getAttribute(Columns.PSE_VLR) != null) && ((Boolean) paramIncAltUsaMaiorPrazo.getAttribute(Columns.PSE_VLR)).booleanValue());

            final Integer adePrazoAtual = autdesOrigem.getAdePrazo();
            final Integer adePrdPagas = autdesOrigem.getAdePrdPagas() != null ? autdesOrigem.getAdePrdPagas() : 0;
            java.util.Date adeAnoMesFimFinal = null;
            Integer adePrazoFinal = null;
            if ((adePrazoDestino != null) && insereAlteraUsandoMaiorPrazo) {
                adeAnoMesFimFinal = ((adePrazoAtual - adePrdPagas) > adePrazoDestino) ? ((autdesOrigem.getAdeAnoMesFim() != null) ? autdesOrigem.getAdeAnoMesFim() : autdesOrigem.getAdeAnoMesFimRef()) : ((autdesDestino.getAdeAnoMesFim() != null) ? autdesDestino.getAdeAnoMesFim() : autdesDestino.getAdeAnoMesFimRef());
                final java.util.Date adeAnoMesIniFinal = ((autdesOrigem.getAdeAnoMesIni() != null) ? autdesOrigem.getAdeAnoMesIni() : autdesOrigem.getAdeAnoMesIniRef());
                try {
                    adePrazoFinal = PeriodoHelper.getInstance().calcularPrazo(orgCodigo, adeAnoMesIniFinal, adeAnoMesFimFinal, autdesOrigem.getAdePeriodicidade(), responsavel);
                } catch (final PeriodoException ex) {
                    TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                    throw new AutorizacaoControllerException("mensagem.erroInternoSistema", responsavel, ex);
                }
            } else {
                adeAnoMesFimFinal = (autdesOrigem.getAdeAnoMesFim() != null) ? autdesOrigem.getAdeAnoMesFim() : autdesOrigem.getAdeAnoMesFimRef();
                adePrazoFinal = adePrazoAtual;
            }

            try {
                final String adeCodigo = autdesOrigem.getAdeCodigo();
                LOG.debug("Insere/Altera AdeCodigo: " + adeCodigo);

                // Executa a alteração do contrato original
                final AlterarConsignacaoParametros alterarParam = new AlterarConsignacaoParametros(adeCodigo, adeVlr, adePrazoFinal, autdesOrigem.getAdeIdentificador(), false, autdesOrigem.getAdeIndice(), adeVlrTac, adeVlrIof, adeVlrLiquido, adeVlrMensVinc, autdesOrigem.getAdeTaxaJuros(), adeAnoMesFimFinal, null, null, true, true, true, true, true, true, true, true, (Integer) null, (String) null, (String) null, false);
                alterarParam.setAdePeriodicidade(autdesOrigem.getAdePeriodicidade());
                alterarConsignacaoController.alterar(alterarParam, responsavel);

                // Cancela o contrato destino do relacionamento
                // Insere ocorrencia de Insere/Altera
                final String ocaCodigo = criaOcorrenciaADE(adeCodigo, CodedValues.TOC_ALTERACAO_INCLUSAO_CONTRATO, ApplicationResourcesHelper.getMessage("mensagem.informacao.alteracao.inclusao.contrato", responsavel), ocaAdeVlrAnt, adeVlr, responsavel);

                cancelarConsignacaoController.cancelar(autdesDestino.getAdeCodigo(), responsavel);

                return ocaCodigo;
            } catch (final AutorizacaoControllerException ex) {
                TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
                throw ex;
            }
        }

        return null;
    }

    @Override
    public void executarDeferimentoAutomatico(AcessoSistema responsavel) throws AutorizacaoControllerException {
        try {
            // Busca os contratos para deferimento automático
            final ListaConsignacaoDeferAutomaticoQuery lstConsigQuery = new ListaConsignacaoDeferAutomaticoQuery();
            final List<String> adeCodigos = lstConsigQuery.executarLista();
            if ((adeCodigos != null) && !adeCodigos.isEmpty()) {
                for (final String adeCodigo : adeCodigos) {
                    // Executa rotina de deferimento
                    deferir(adeCodigo, null, responsavel);

                    // Cria ocorrência de aviso de deferimento automático
                    criaOcorrenciaADE(adeCodigo, CodedValues.TOC_AVISO, ApplicationResourcesHelper.getMessage("mensagem.informacao.deferimento.automatico.consignacao.singular", responsavel), responsavel);
                }

                // Se o sistema permite deferimento pelas consignatárias, verifica quais
                // consignatárias estão relacionadas aos contratos que foram automaticamente
                // deferidos, através do relacionamento de serviço que exige deferimento manual
                if (ParamSist.paramEquals(CodedValues.TPC_PERMITE_DEFERIMENTO_TERCEIROS_PELA_CSA, CodedValues.TPC_SIM, responsavel) && NaturezaRelSvc.getInstance().exists(CodedValues.TNT_CONTRATO_PREEXISTENTE_REQUER_DEFERIMENTO)) {
                    final ObtemCsaBloqRelSvcRequerDeferimentoQuery query = new ObtemCsaBloqRelSvcRequerDeferimentoQuery();
                    query.adeCodigos = adeCodigos;
                    final List<String> csaCodigos = query.executarLista();
                    if ((csaCodigos != null) && !csaCodigos.isEmpty()) {
                        // Executa desbloqueio, caso existam consignatárias a serem bloqueadas
                        consignatariaController.bloquearConsignatarias(csaCodigos, ApplicationResourcesHelper.getMessage("mensagem.informacao.bloqueio.automatico.consignataria.por.nao.deferir.contratos.dentro.prazo", responsavel), CodedValues.TOC_BLOQUEIA_CONSIGNATARIA, responsavel);
                    }
                }

                // Grava log da operação de deferimento automático
                final LogDelegate log = new LogDelegate(responsavel, Log.AUTORIZACAO, Log.UPDATE, Log.LOG_INFORMACAO);
                log.add(ApplicationResourcesHelper.getMessage("mensagem.informacao.deferimento.automatico.consignacao.plural", responsavel));
                log.write();
            }
        } catch (final LogControllerException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new AutorizacaoControllerException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final Exception ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new AutorizacaoControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    private void enviaMensagem(Long adeNumero, String svcCodigo, Consignataria csa, String rseCodigo, AcessoSistema responsavel) throws ZetraException {
        String emailDestinatario = null;
        String celularDestinatario = null;
        String corpo = null;

        // Busca mensagem a ser enviada
        final List<String> tpsCodigo = new ArrayList<>();
        tpsCodigo.add(CodedValues.TPS_MENSAGEM_PARA_SERVIDOR_APOS_SOLICITACAO_DEFERIDA);

        final List<TransferObject> parametros = parametroController.selectParamSvcCsa(svcCodigo, csa.getCsaCodigo(), tpsCodigo, false, responsavel);

        final Iterator<TransferObject> it = parametros.iterator();
        CustomTransferObject next = null;
        while (it.hasNext()) {
            next = (CustomTransferObject) it.next();
            if (CodedValues.TPS_MENSAGEM_PARA_SERVIDOR_APOS_SOLICITACAO_DEFERIDA.equals(next.getAttribute(Columns.TPS_CODIGO))) {
                corpo = next.getAttribute(Columns.PSC_VLR).toString();
            }
        }

        // Busca dados do servidor
        final ServidorTransferObject servidor = servidorController.findServidorByRseCodigo(rseCodigo, responsavel);

        if (servidor != null) {
            // Formata o telefone para o padrão do país
            celularDestinatario = !TextHelper.isNull(servidor.getSerCelular()) ? LocaleHelper.formataCelular(servidor.getSerCelular()) : null;
            emailDestinatario = servidor.getSerEmail();
        }

        if (!TextHelper.isNull(celularDestinatario)) {
            // Envia o SMS.
            try {
                final String accountSid = ParamSist.getInstance().getParam(CodedValues.TPC_SID_CONTA_SMS, responsavel).toString();
                final String authToken = ParamSist.getInstance().getParam(CodedValues.TPC_TOKEN_AUTENTICACAO_SMS, responsavel).toString();
                final String fromNumber = ParamSist.getInstance().getParam(CodedValues.TPC_NUMERO_REMETENTE_SMS, responsavel).toString();

                // Se a CSA não cadastrou uma mensagem, envia a mensagem padrão.
                if (TextHelper.isNull(corpo)) {
                    corpo = ApplicationResourcesHelper.getMessage("mensagem.sms.consignacao.aprovada", responsavel, adeNumero.toString(), csa.getCsaNome());
                    new SMSHelper(accountSid, authToken, fromNumber).send(celularDestinatario, corpo);
                }
            } catch (final ZetraException e) {
                throw new ViewHelperException("mensagem.erro.sms.enviar", responsavel, e);
            }
        } else if (!TextHelper.isNull(emailDestinatario)) {
            // Envia o e-mail caso o telefone não tenha sido informado
            EnviaEmailHelper.enviaEmailNotificacaoConsignacaoDeferida(csa.getCsaNome(), emailDestinatario, adeNumero.toString(), corpo, responsavel);
        }
    }
}

cannot find symbol


package com.zetra.econsig.service.comunicacao;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.jsoup.Jsoup;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.interceptor.TransactionAspectSupport;

import com.zetra.econsig.delegate.LogDelegate;
import com.zetra.econsig.dto.CustomTransferObject;
import com.zetra.econsig.dto.TransferObject;
import com.zetra.econsig.dto.entidade.ConsignatariaTransferObject;
import com.zetra.econsig.exception.ConsignanteControllerException;
import com.zetra.econsig.exception.ConsignatariaControllerException;
import com.zetra.econsig.exception.CreateException;
import com.zetra.econsig.exception.FindException;
import com.zetra.econsig.exception.HQueryException;
import com.zetra.econsig.exception.ParametroControllerException;
import com.zetra.econsig.exception.RemoveException;
import com.zetra.econsig.exception.UpdateException;
import com.zetra.econsig.exception.ViewHelperException;
import com.zetra.econsig.exception.ZetraException;
import com.zetra.econsig.helper.arquivo.FileHelper;
import com.zetra.econsig.helper.log.Log;
import com.zetra.econsig.helper.parametro.ParamSist;
import com.zetra.econsig.helper.seguranca.AcessoSistema;
import com.zetra.econsig.helper.sms.SMSHelper;
import com.zetra.econsig.helper.texto.ApplicationResourcesHelper;
import com.zetra.econsig.helper.texto.DateHelper;
import com.zetra.econsig.helper.texto.LocaleHelper;
import com.zetra.econsig.helper.texto.TextHelper;
import com.zetra.econsig.job.process.comunicacao.ProcessaEmailAlertaNovaComunicacao;
import com.zetra.econsig.job.process.comunicacao.ProcessaEnvioEmailCmnMsgPendente;
import com.zetra.econsig.persistence.entity.AbstractEntityHome;
import com.zetra.econsig.persistence.entity.Comunicacao;
import com.zetra.econsig.persistence.entity.ComunicacaoCsaHome;
import com.zetra.econsig.persistence.entity.ComunicacaoCseHome;
import com.zetra.econsig.persistence.entity.ComunicacaoHome;
import com.zetra.econsig.persistence.entity.ComunicacaoOrgHome;
import com.zetra.econsig.persistence.entity.ComunicacaoPermitida;
import com.zetra.econsig.persistence.entity.ComunicacaoPermitidaHome;
import com.zetra.econsig.persistence.entity.ComunicacaoSerHome;
import com.zetra.econsig.persistence.entity.Consignante;
import com.zetra.econsig.persistence.entity.ConsignanteHome;
import com.zetra.econsig.persistence.entity.Consignataria;
import com.zetra.econsig.persistence.entity.ConsignatariaHome;
import com.zetra.econsig.persistence.entity.LeituraComunicacaoUsuario;
import com.zetra.econsig.persistence.entity.LeituraComunicacaoUsuarioHome;
import com.zetra.econsig.persistence.entity.LeituraComunicacaoUsuarioId;
import com.zetra.econsig.persistence.entity.Orgao;
import com.zetra.econsig.persistence.entity.OrgaoHome;
import com.zetra.econsig.persistence.entity.Servidor;
import com.zetra.econsig.persistence.entity.ServidorHome;
import com.zetra.econsig.persistence.entity.Usuario;
import com.zetra.econsig.persistence.query.comunicacao.ListaComunicacaoQuery;
import com.zetra.econsig.persistence.query.comunicacao.ListaComunicacoesNaoLidasCsaQuery;
import com.zetra.econsig.persistence.query.comunicacao.ListaComunicacoesNaoLidasCseQuery;
import com.zetra.econsig.persistence.query.comunicacao.ListaComunicacoesNaoLidasOrgQuery;
import com.zetra.econsig.persistence.query.comunicacao.ListaComunicacoesNaoLidasSerQuery;
import com.zetra.econsig.persistence.query.comunicacao.ListaUsuariosComunicacoesPendentesCsaQuery;
import com.zetra.econsig.persistence.query.comunicacao.ListarAssuntoComunicacaoQuery;
import com.zetra.econsig.persistence.query.comunicacao.ListarComunicacoesQuery;
import com.zetra.econsig.persistence.query.comunicacao.ObtemResponsavelComunicacaoQuery;
import com.zetra.econsig.persistence.query.consignataria.ListaConsignatariaCmnPendenteAlemPrazoQuery;
import com.zetra.econsig.persistence.query.consignataria.ListaConsignatariaConvenioNseCodigoQuery;
import com.zetra.econsig.service.consignataria.ConsignatariaController;
import com.zetra.econsig.service.parametro.ParametroController;
import com.zetra.econsig.service.servidor.ServidorController;
import com.zetra.econsig.service.usuario.UsuarioController;
import com.zetra.econsig.values.CodedValues;
import com.zetra.econsig.values.Columns;

/**
 * <p>Title: ComunicacaoControllerBean</p>
 * <p>Description: session façade do módulo de Comunicação.</p>
 * <p>Copyright: Copyright (c) 2010</p>
 * <p>Company: ZetraSoft Ltda.</p>
 * $Author$
 * $Revision$
 * $Date$
 */
@Service
@Transactional
public class ComunicacaoControllerBean implements ComunicacaoController {
    private static final org.apache.commons.logging.Log LOG = org.apache.commons.logging.LogFactory.getLog(ComunicacaoControllerBean.class);

    @Autowired
    private ConsignatariaController consignatariaController;

    @Autowired
    private ParametroController parametroController;

    @Autowired
    private UsuarioController usuarioController;

    @Autowired
    private EditarAnexoComunicacaoController editarAnexoComunicacaoController;

    @Autowired
    private ServidorController servidorController;

    @Override
    public int countComunicacoes(TransferObject criterio, AcessoSistema responsavel) throws ZetraException {
        final ListarComunicacoesQuery lstComunicacoes = new ListarComunicacoesQuery();

        lstComunicacoes.count = true;
        lstComunicacoes.responsavel = responsavel;
        lstComunicacoes.setCriterios(criterio);

        try {
            return lstComunicacoes.executarContador();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException(ex);

        }
    }

    @Override
    public List<TransferObject> listaAssuntoComunicacao(AcessoSistema responsavel) throws ZetraException {
        final ListarAssuntoComunicacaoQuery lstAssuntoComunicacao = new ListarAssuntoComunicacaoQuery();

        try {
            return lstAssuntoComunicacao.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException(ex);
        }
    }

    @Override
    public List<TransferObject> listComunicacoes(TransferObject criterio, AcessoSistema responsavel) throws ZetraException {
        return listComunicacoes(criterio, -1, -1, responsavel);
    }

    @Override
    public List<TransferObject> listComunicacoes(TransferObject criterio, int offset, int count, AcessoSistema responsavel) throws ZetraException {
        return listComunicacoes(criterio, true, offset, count, responsavel);
    }

    @Override
    public List<TransferObject> listComunicacoes(TransferObject criterio, boolean ordenacaoDesc, int offset, int count, AcessoSistema responsavel) throws ZetraException {
        final ListarComunicacoesQuery lstComunicacoes = new ListarComunicacoesQuery();

        if (offset != -1) {
            lstComunicacoes.firstResult = offset;
        }

        if (count != -1) {
            lstComunicacoes.maxResults = count;
        }

        lstComunicacoes.setCriterios(criterio);
        lstComunicacoes.responsavel = responsavel;

        try {
            return lstComunicacoes.executarDTO();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException(ex);
        }
    }

    private TransferObject buscaComunicacao(String cmnCodigo, AcessoSistema responsavel) throws ZetraException {
        final ListaComunicacaoQuery query = new ListaComunicacaoQuery();
        query.cmnCodigo = cmnCodigo;
        query.responsavel = responsavel;

        try {
            final List<TransferObject> lista = query.executarDTO();
            if ((lista == null) || lista.isEmpty()) {
                throw new ZetraException("mensagem.erro.comunicacao.nao.encontrada", responsavel);
            }

            return lista.get(0);
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException(ex);
        }
    }

    @Override
    public String createComunicacao(TransferObject comunicacao, AcessoSistema responsavel) throws ZetraException {
        return this.createComunicacao(comunicacao, null, responsavel);
    }

    @Override
    public String createComunicacao(TransferObject comunicacao, File anexoComunicacao, AcessoSistema responsavel) throws ZetraException {
        String cmnCodigo = null;
        final List<String> cmnCodigos = new ArrayList<>();
        File dirFinal = null;
        final boolean enviaCopiaComunicacaoUsuario = ParamSist.getBoolParamSist(CodedValues.TPC_ENVIAR_COMUNICACAO_CRIADA_EMAIL_USUARIO, responsavel);

        try {
            // Verifica se a categoria do assunto esta presente
            final String cmnAscCodigo = comunicacao.getAttribute(Columns.CMN_ASC_CODIGO).toString();
            final String adeCodigo = (String) comunicacao.getAttribute(Columns.CMN_ADE_CODIGO);
            if (TextHelper.isNull(cmnAscCodigo)) {
                throw new ZetraException("mensagem.erro.categoria.assunto.comunicacao.nao.informado", responsavel);
            }

            if (TextHelper.isNull(comunicacao.getAttribute(Columns.PAP_CODIGO).toString())) {
                throw new ZetraException("mensagem.erro.papel.destino.comunicacao.nao.informado", responsavel);
            }

            if (TextHelper.isNull(comunicacao.getAttribute(Columns.CSE_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.ORG_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.CSA_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.SER_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.RSE_CODIGO))) {
                throw new ZetraException("mensagem.erro.entidade.destino.comunicacao.nao.informada", responsavel);
            }

            final String cmnTexto = validarTextoComunicacao(comunicacao, responsavel);
            final String papCodigoDestinatario = comunicacao.getAttribute(Columns.PAP_CODIGO).toString();

            final boolean cmnPendencia = definirComunicacaoPendente(papCodigoDestinatario, responsavel);
            final boolean enviarAlertaEmail = ((comunicacao.getAttribute(Columns.CMN_ALERTA_EMAIL) != null) && "1".equals(comunicacao.getAttribute(Columns.CMN_ALERTA_EMAIL).toString()));
            final boolean enviarCopiaEmail = ((comunicacao.getAttribute(Columns.CMN_COPIA_EMAIL_SMS) != null) && "1".equals(comunicacao.getAttribute(Columns.CMN_COPIA_EMAIL_SMS).toString()));
            final String ipAcesso = (String) comunicacao.getAttribute(Columns.CMN_IP_ACESSO);

            Comunicacao cmnBean = null;

            final boolean csaBuscaSer = comunicacao.getAttribute(CodedValues.ENVIA_CSA_CONTRATOS_SERVIDOR) != null;

            // Insere a comunicação de acordo com a entidade remetente e destino
            if(!csaBuscaSer && !CodedValues.PAP_SERVIDOR.equals(papCodigoDestinatario)) {
                cmnBean = ComunicacaoHome.create(responsavel.getUsuCodigo(), null, cmnPendencia, cmnTexto, null, ipAcesso, enviarAlertaEmail, enviarCopiaEmail, cmnAscCodigo, adeCodigo);
                cmnCodigo = cmnBean.getCmnCodigo();
                insereComunicacaoEntidade(cmnCodigo, papCodigoDestinatario, comunicacao, responsavel);
                cmnCodigos.add(cmnCodigo);
            }

            // Código da CSA de destino, ou NULL caso o destino seja outro tipo de entidade
            final String csaCodigo = (String) comunicacao.getAttribute(Columns.CSA_CODIGO);
            if (!TextHelper.isNull(csaCodigo) && !CodedValues.PAP_SERVIDOR.equals(papCodigoDestinatario)) {
                comunicaCsa(csaCodigo, comunicacao, responsavel);
            }

            final String orgCodigo = (String) comunicacao.getAttribute(Columns.ORG_CODIGO);
            final String cseCodigo = (String) comunicacao.getAttribute(Columns.CSE_CODIGO);

            if (CodedValues.PAP_SERVIDOR.equals(papCodigoDestinatario)) {
                final String verbaBuscaSer = comunicacao.getAttribute(CodedValues.ENVIA_CSA_CNV_CONTRATOS_SERVIDOR) != null ? (String) comunicacao.getAttribute(CodedValues.ENVIA_CSA_CNV_CONTRATOS_SERVIDOR) : null;
                if(responsavel.isCseSup() && csaBuscaSer) {
                    final List<TransferObject> servidores = servidorController.listaServidorPorCsaVerba(csaCodigo, verbaBuscaSer, responsavel);

                    for(final TransferObject servidor : servidores) {
                        final String serCodigo = (String) servidor.getAttribute(Columns.SER_CODIGO);
                        final String rseCodigo = (String) servidor.getAttribute(Columns.RSE_CODIGO);
                        final String serNome = (String) servidor.getAttribute(Columns.SER_NOME);


                        comunicacao.setAttribute(Columns.SER_CODIGO, serCodigo);

                        comunicacao.setAttribute(Columns.RSE_CODIGO, rseCodigo);
                        cmnBean = ComunicacaoHome.create(responsavel.getUsuCodigo(), null, cmnPendencia, cmnTexto, null, ipAcesso, enviarAlertaEmail, enviarCopiaEmail, cmnAscCodigo, adeCodigo);
                        cmnCodigo = cmnBean.getCmnCodigo();

                        cmnCodigos.add(cmnCodigo);
                        insereComunicacaoEntidade(cmnCodigo, papCodigoDestinatario, comunicacao, responsavel);

                        if (enviarCopiaEmail || enviaCopiaComunicacaoUsuario) {
                            try {
                                enviarCopiaComunicacaoEmailSMS(comunicacao, responsavel);
                            } catch (final ViewHelperException ex1) {
                                LOG.error(ApplicationResourcesHelper.getMessage("mensagem.comunicacao.nao.criada.servidor.erro", responsavel, serNome));
                                LOG.error(ex1.getMessage(), ex1);
                            }
                        }
                    }
                } else if(!csaBuscaSer) {
                    cmnBean = ComunicacaoHome.create(responsavel.getUsuCodigo(), null, cmnPendencia, cmnTexto, null, ipAcesso, enviarAlertaEmail, enviarCopiaEmail, cmnAscCodigo, adeCodigo);
                    cmnCodigo = cmnBean.getCmnCodigo();
                    cmnCodigos.add(cmnCodigo);

                    insereComunicacaoEntidade(cmnCodigo, papCodigoDestinatario, comunicacao, responsavel);

                    if (enviarCopiaEmail || enviaCopiaComunicacaoUsuario) {
                        enviarCopiaComunicacaoEmailSMS(comunicacao, responsavel);
                    }
                }
            } else if (enviarCopiaEmail && CodedValues.PAP_ORGAO.equals(papCodigoDestinatario) && !TextHelper.isNull(orgCodigo)) {
                comunicaOrg(orgCodigo, comunicacao, responsavel);
            } else if (enviarCopiaEmail && CodedValues.PAP_CONSIGNANTE.equals(papCodigoDestinatario) && !TextHelper.isNull(cseCodigo)) {
                comunicaCse(cseCodigo, comunicacao, responsavel);
            }

            if (anexoComunicacao != null) {
                final String diretorioRaizArquivos = ParamSist.getDiretorioRaizArquivos();
                final File dirComunicacao = new File(diretorioRaizArquivos + File.separatorChar + "comunicacao");

                if (dirComunicacao.exists() || dirComunicacao.mkdir()) {
                    for(final String cmnCodigoAnexo : cmnCodigos) {
                        dirFinal = new File(dirComunicacao.getCanonicalPath() + File.separatorChar + DateHelper.format(DateHelper.getSystemDatetime(), "yyyyMMdd") + File.separatorChar + cmnCodigoAnexo);
                        if (dirFinal.exists() || ((dirFinal.getParentFile().exists() || dirFinal.getParentFile().mkdir()) && (dirFinal.exists() || dirFinal.mkdir()))) {
                            Files.copy(anexoComunicacao.toPath(), new File(dirFinal.getCanonicalPath() + File.separatorChar + anexoComunicacao.getName()).toPath());
                        }
                        editarAnexoComunicacaoController.createAnexoComunicacao(cmnCodigoAnexo, anexoComunicacao.getName(), anexoComunicacao.getName(), null, cmnCodigoAnexo, responsavel);
                    }
                }
            }

            if(csaBuscaSer) {
                final CustomTransferObject comunicacaoNova = new CustomTransferObject();
                for (final Entry<String, Object> entry : comunicacao.getAtributos().entrySet()) {
                    if(!CodedValues.ENVIA_CSA_CNV_CONTRATOS_SERVIDOR.equals(entry.getKey()) && !CodedValues.ENVIA_CSA_CONTRATOS_SERVIDOR.equals(entry.getKey())) {
                        comunicacaoNova.setAttribute(entry.getKey(), entry.getValue());
                    }
                }
                comunicacao = comunicacaoNova;
            }
            for(final String cmnCodigoAtual : cmnCodigos) {
                final LogDelegate log = new LogDelegate(responsavel, Log.COMUNICACAO, Log.CREATE, Log.LOG_INFORMACAO);
                log.setComunicacao(cmnCodigoAtual);
                log.setUsuario(responsavel.getUsuCodigo());
                log.getUpdatedFields(comunicacao.getAtributos(), null);
                log.write();
            }
        } catch (CreateException | IOException ex) {
            if (anexoComunicacao != null) {
                anexoComunicacao.delete();
            }

            try {
                if ((dirFinal != null) && dirFinal.exists()) {
                    FileHelper.deleteDir(dirFinal.getCanonicalPath());
                }
            } catch (final IOException ex1) {
                LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erroInternoSistema", responsavel, ex1.getMessage()));
            }

            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.comunicacao.nao.criada", responsavel, ex.getMessage()));
            throw new ZetraException("mensagem.erro.comunicacao.nao.criada", responsavel, ex, ex.getMessage());
        }

        if (enviaCopiaComunicacaoUsuario) {
            enviaCopiaUsuEmail(comunicacao, responsavel);
        }
        return cmnCodigo;
    }

    @Override
    public List<String> createComunicacaoNseCodigo(TransferObject comunicacao, AcessoSistema responsavel) throws ZetraException {
        return this.createComunicacaoNseCodigo(comunicacao, null, responsavel);
    }

    @Override
    public List<String> createComunicacaoNseCodigo(TransferObject comunicacao, File anexoComunicacao, AcessoSistema responsavel) throws ZetraException {
        final List<String> cmnCodigos = new ArrayList<>();
        String cmnCodigo;
        File dirFinal = null;
        final List<File> dirFinals = new ArrayList<>();
        final boolean enviaCopiaComunicacaoUsuario = ParamSist.getBoolParamSist(CodedValues.TPC_ENVIAR_COMUNICACAO_CRIADA_EMAIL_USUARIO, responsavel);

        try {
            // Verifica se a categoria do assunto esta presente
            final String cmnAscCodigo = comunicacao.getAttribute(Columns.CMN_ASC_CODIGO).toString();
            final String adeCodigo = (String) comunicacao.getAttribute(Columns.CMN_ADE_CODIGO);
            if (TextHelper.isNull(cmnAscCodigo)) {
                throw new ZetraException("mensagem.erro.categoria.assunto.comunicacao.nao.informado", responsavel);
            }

            if (TextHelper.isNull(comunicacao.getAttribute(Columns.PAP_CODIGO).toString())) {
                throw new ZetraException("mensagem.erro.papel.destino.comunicacao.nao.informado", responsavel);
            }

            if (TextHelper.isNull(comunicacao.getAttribute(Columns.CSE_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.ORG_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.CSA_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.NSE_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.SER_CODIGO)) &&
                    TextHelper.isNull(comunicacao.getAttribute(Columns.RSE_CODIGO))) {
                throw new ZetraException("mensagem.erro.entidade.destino.comunicacao.nao.informada", responsavel);
            }

            final String cmnTexto = validarTextoComunicacao(comunicacao, responsavel);
            final String papCodigoDestinatario = comunicacao.getAttribute(Columns.PAP_CODIGO).toString();

            final boolean cmnPendencia = definirComunicacaoPendente(papCodigoDestinatario, responsavel);
            final boolean enviarAlertaEmail = ((comunicacao.getAttribute(Columns.CMN_ALERTA_EMAIL) != null) && "1".equals(comunicacao.getAttribute(Columns.CMN_ALERTA_EMAIL)));
            final boolean enviarCopiaEmail = ((comunicacao.getAttribute(Columns.CMN_COPIA_EMAIL_SMS) != null) && "1".equals(comunicacao.getAttribute(Columns.CMN_COPIA_EMAIL_SMS)));
            final String ipAcesso = (String) comunicacao.getAttribute(Columns.CMN_IP_ACESSO);
            final String nseCodigo = (String) comunicacao.getAttribute(Columns.NSE_CODIGO);

            final List<String> csaCodigos = listaCsaCodigos(nseCodigo, responsavel);
            for (final String codigo : csaCodigos) {

                // Cria uma comunicaçao para cada CSA_CODIGO
                final Comunicacao cmnBean = ComunicacaoHome.create(responsavel.getUsuCodigo(), null, cmnPendencia, cmnTexto, null, ipAcesso, enviarAlertaEmail, enviarCopiaEmail, cmnAscCodigo, adeCodigo);
                cmnCodigo = cmnBean.getCmnCodigo();
                cmnCodigos.add(cmnCodigo);

                //Update CSA_CODIGO na comunicacao para utilizaçao nos demais processos.
                comunicacao.setAttribute(Columns.CSA_CODIGO, codigo);

                insereComunicacaoEntidade(cmnCodigo, papCodigoDestinatario, comunicacao, responsavel);
                comunicaCsa(codigo, comunicacao, responsavel);

                if ((enviarCopiaEmail || enviaCopiaComunicacaoUsuario) && CodedValues.PAP_SERVIDOR.equals(papCodigoDestinatario)) {
                    enviarCopiaComunicacaoEmailSMS(comunicacao, responsavel);
                }

                if (anexoComunicacao != null) {
                    final String diretorioRaizArquivos = ParamSist.getDiretorioRaizArquivos();
                    final File dirComunicacao = new File(diretorioRaizArquivos + File.separatorChar + "comunicacao");

                    if (dirComunicacao.exists() || dirComunicacao.mkdir()) {
                        dirFinal = new File(dirComunicacao.getCanonicalPath() + File.separatorChar + DateHelper.format(DateHelper.getSystemDatetime(), "yyyyMMdd") + File.separatorChar + cmnCodigo);
                        if (dirFinal.exists() || ((dirFinal.getParentFile().exists() || dirFinal.getParentFile().mkdir()) && (dirFinal.exists() || dirFinal.mkdir()))) {
                            dirFinals.add(dirFinal);
                            Files.copy(anexoComunicacao.toPath(), new File(dirFinal.getCanonicalPath() + File.separatorChar + anexoComunicacao.getName()).toPath());
                        }

                        editarAnexoComunicacaoController.createAnexoComunicacao(cmnCodigo, anexoComunicacao.getName(), anexoComunicacao.getName(), null, cmnCodigo, responsavel);
                    }
                }

                final LogDelegate log = new LogDelegate(responsavel, Log.COMUNICACAO, Log.CREATE, Log.LOG_INFORMACAO);
                log.setComunicacao(cmnCodigo);
                log.setUsuario(responsavel.getUsuCodigo());
                log.getUpdatedFields(comunicacao.getAtributos(), null);
                log.write();
            }
        } catch (CreateException | IOException ex) {
            if (anexoComunicacao != null) {
                anexoComunicacao.delete();
            }

            if (!dirFinals.isEmpty()) {
                for (final File finals: dirFinals) {
                    if ((finals != null) && finals.exists()) {
                        try {
                            FileHelper.deleteDir(finals.getCanonicalPath());
                        } catch (final IOException ex1) {
                            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erroInternoSistema", responsavel, ex1.getMessage()));
                        }
                    }
                }
            }

            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ApplicationResourcesHelper.getMessage("mensagem.erro.comunicacao.nao.criada", responsavel, ex.getMessage()));
            throw new ZetraException("mensagem.erro.comunicacao.nao.criada", responsavel, ex, ex.getMessage());
        }

        if (ParamSist.getBoolParamSist(CodedValues.TPC_ENVIAR_COMUNICACAO_CRIADA_EMAIL_USUARIO, responsavel)) {
            enviaCopiaUsuEmail(comunicacao, responsavel);
        }

        return cmnCodigos;
    }

    private String validarTextoComunicacao(TransferObject comunicacao, AcessoSistema responsavel) throws ZetraException {
        String cmnTexto = Jsoup.parse((String) comunicacao.getAttribute(Columns.CMN_TEXTO)).text();

        // Verifica se a mensagem foi preenchida
        if (TextHelper.isNull(cmnTexto)) {
            throw new ZetraException("mensagem.erro.texto.comunicacao.nao.informado", responsavel);
        }
        cmnTexto = cmnTexto.trim();

        final String msgSemQuebraDeLinha = cmnTexto.replaceAll("\\r\\n|\\r|\\n", " ");

        // Verifica quantidade de caracteres informados na mensagem
        if (msgSemQuebraDeLinha.length() < 10) {
            throw new ZetraException("mensagem.erro.comunicacao.texto.minimo", responsavel);
        }

        // Verifica se existe pelo menos uma letra na mensagem
        final String regex = "^.*[a-zA-Z]+.*$";
        if (!msgSemQuebraDeLinha.matches(regex)) {
            throw new ZetraException("mensagem.erro.comunicacao.texto.invalido", responsavel);
        }

        int tamMaxMsg = 0;
        try {
            tamMaxMsg = Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_TAM_MAX_MSG_COMUNICACAO, responsavel).toString());
        } catch (final Exception ex) {
            tamMaxMsg = 0;
        }
        // mensagem não pode ser maior do que o definido no parâmetro de sistema 354. Valor 0 deste significa que não há limite
        // para o tamanho da mensagem.
        if ((tamMaxMsg > 0) && (cmnTexto.length() > tamMaxMsg)) {
            throw new ZetraException("mensagem.erro.comunicacao.texto.maximo", responsavel);
        }

        return cmnTexto;
    }

    private void enviarCopiaComunicacaoEmailSMS(TransferObject comunicacao, AcessoSistema responsavel) throws ViewHelperException {
        String serEmail = null;
        String serCelular = null;

        try {
            final Servidor servidor = ServidorHome.findByPrimaryKey((String) comunicacao.getAttribute(Columns.SER_CODIGO));
            serEmail = servidor.getSerEmail();
            serCelular = servidor.getSerCelular();
        } catch (final FindException ex) {
            throw new ViewHelperException("mensagem.nenhumServidorEncontrado", responsavel, ex, ex.getMessage());
        }

        if (!TextHelper.isNull(serEmail)) {
            final ProcessaEmailAlertaNovaComunicacao emailNovaCmn = new ProcessaEmailAlertaNovaComunicacao(responsavel.getUsuCodigo(), serEmail, comunicacao, responsavel);
            emailNovaCmn.start();
        }
        if (!TextHelper.isNull(serCelular)) {
            try {
                // Credenciais para envio do SMS
                final String accountSid = ParamSist.getInstance().getParam(CodedValues.TPC_SID_CONTA_SMS, responsavel).toString();
                final String authToken = ParamSist.getInstance().getParam(CodedValues.TPC_TOKEN_AUTENTICACAO_SMS, responsavel).toString();
                final String fromNumber = ParamSist.getInstance().getParam(CodedValues.TPC_NUMERO_REMETENTE_SMS, responsavel).toString();

                if (TextHelper.isNull(accountSid) || TextHelper.isNull(authToken) || TextHelper.isNull(fromNumber)) {
                    LOG.warn("Necessário habilitar os parâmetros de sistema " + CodedValues.TPC_SID_CONTA_SMS + ", " + CodedValues.TPC_TOKEN_AUTENTICACAO_SMS + ", " + CodedValues.TPC_NUMERO_REMETENTE_SMS + " para envio de SMS.");

                } else {
                    final String celularDestinatario = LocaleHelper.formataCelular(serCelular);
                    if (!TextHelper.isNull(celularDestinatario)) {
                        String corpo = (String) comunicacao.getAttribute(Columns.CMN_TEXTO);

                        if (corpo.length() > 100) {
                            corpo = corpo.substring(0, 50) + ApplicationResourcesHelper.getMessage("mensagem.visualizar.mensagem.completa.sms", responsavel);
                        }

                        new SMSHelper(accountSid, authToken, fromNumber).send(celularDestinatario, TextHelper.removeAccent(corpo));
                    }
                }
            } catch (final ZetraException ex) {
                throw new ViewHelperException("mensagem.erro.sms.enviar", responsavel, ex);
            }
        }
    }

    /**
     * Insere a comunicação de acordo com a entidade para o remetente e para o destino.
     *
     * @param cmnCodigo Código da comunicação.
     * @param papCodigoDestinatario Tipo do destinatario
     * @param comunicacao Dados da comunicação.
     * @param responsavel Responsável pela comunicação.
     * @throws CreateException
     */
    private void insereComunicacaoEntidade(String cmnCodigo, String papCodigoDestinatario, TransferObject comunicacao, AcessoSistema responsavel) throws CreateException {
        // Destinatário
        if (CodedValues.PAP_CONSIGNANTE.equals(papCodigoDestinatario)) {
            ComunicacaoCseHome.create(cmnCodigo, (String) comunicacao.getAttribute(Columns.CSE_CODIGO), CodedValues.TPC_SIM);
        } else if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigoDestinatario)) {
            ComunicacaoCsaHome.create(cmnCodigo, (String) comunicacao.getAttribute(Columns.CSA_CODIGO), CodedValues.TPC_SIM);
        } else if (CodedValues.PAP_ORGAO.equals(papCodigoDestinatario)) {
            ComunicacaoOrgHome.create(cmnCodigo, (String) comunicacao.getAttribute(Columns.ORG_CODIGO), CodedValues.TPC_SIM);
        } else if (CodedValues.PAP_SERVIDOR.equals(papCodigoDestinatario)) {
            ComunicacaoSerHome.create(cmnCodigo, (String) comunicacao.getAttribute(Columns.SER_CODIGO), (String) comunicacao.getAttribute(Columns.RSE_CODIGO), CodedValues.TPC_SIM);
        }

        // Remetente
        if (responsavel.isCse()) {
            ComunicacaoCseHome.create(cmnCodigo, responsavel.getCodigoEntidade(), CodedValues.TPC_NAO);
        } else if (responsavel.isCsa()) {
            ComunicacaoCsaHome.create(cmnCodigo, responsavel.getCodigoEntidade(), CodedValues.TPC_NAO);
        } else if (responsavel.isOrg()) {
            ComunicacaoOrgHome.create(cmnCodigo, responsavel.getCodigoEntidade(), CodedValues.TPC_NAO);
        } else if (responsavel.isSer()) {
            ComunicacaoSerHome.create(cmnCodigo, responsavel.getSerCodigo(), responsavel.getRseCodigo(), CodedValues.TPC_NAO);
        }
    }

    /**
     * se o sistema estiver configurado para bloquear CSA segundo número máximo de comunicações para servidores distintos pendentes
     * @param csaCodigo consignatária alvo da comunicação
     * @param responsavel
     * @throws HQueryException
     * @throws ConsignatariaControllerException
     */
    private void verificaBloqueioNumCmnPendentes(String csaCodigo, AcessoSistema responsavel) throws HQueryException, FindException, ConsignatariaControllerException {
        final Consignataria csa = ConsignatariaHome.findByPrimaryKey(csaCodigo);
        if ((csa.getCsaAtivo().shortValue() == CodedValues.STS_ATIVO.shortValue()) && temNumMaxUsuComCmnPendentes(csaCodigo, responsavel)) {
            final ConsignatariaTransferObject csaTO = new ConsignatariaTransferObject(csaCodigo);
            final List<TransferObject> csaList = new ArrayList<>();
            csaList.add(csaTO);

            consignatariaController.bloquearConsignatariasContratos(csaList, ApplicationResourcesHelper.getMessage("mensagem.bloqueio.maximo.comunicacoes.pendentes", responsavel), CodedValues.TOC_BLOQUEIA_CONSIGNATARIA, AcessoSistema.getAcessoUsuarioSistema());

            // Inclui as ocorrências específicas
            if (ParamSist.paramEquals(CodedValues.TPC_DESBL_AUTOMATICO_CSA_CONTROLE_COMPRA, CodedValues.TPC_SIM, responsavel) && (csaList.size() > 0)) {
                final List<String> csaCodigoList = new ArrayList<>();
                csaCodigoList.add(csaCodigo);
                consignatariaController.incluirOcorrenciaConsignatarias(csaCodigoList, CodedValues.TOC_CONSIGNATARIA_COM_CMN_PENDENTE, ApplicationResourcesHelper.getMessage("mensagem.informacao.csa.possui.comunicacoes.pendentes", responsavel), responsavel);
            }
        }
    }

    /**
     * returna verdadeiro se o número de comunicações pendentes por servidores distintos para consignatária tiver alcançado
     * o número máximo permitido, definido pelo parâmetro de sistema 355
     * @param csaCodigo consignatária alvo da comunicação
     * @param responsavel
     * @return
     * @throws HQueryException
     * @throws ConsignatariaControllerException
     */
    private boolean temNumMaxUsuComCmnPendentes(String csaCodigo, AcessoSistema responsavel) throws HQueryException, ConsignatariaControllerException {
        int numMaxCmnPendente = 0;
        try {
            numMaxCmnPendente = Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_NUM_MAX_CMN_PENDENTE_POR_CSA, responsavel).toString());
        } catch (final Exception ex) {
            numMaxCmnPendente = 0;
        }

        if (numMaxCmnPendente > 0) {
            // lista de usuários distintos que tem comunicação pendente com para a CSA.
            final ListaUsuariosComunicacoesPendentesCsaQuery usuQuery = new ListaUsuariosComunicacoesPendentesCsaQuery();
            usuQuery.csaCodigo = csaCodigo;

            final List<TransferObject> usuList = usuQuery.executarDTO();

            //bloqueia a consignatária se o número de comunicações pendentes é maior que o limite fixado pelo parâmetro 355
            if (!usuList.isEmpty() && (usuList.size() >= numMaxCmnPendente)) {
                return true;
            }
        }
        return false;
    }

    /**
     * gera uma comunicação de resposta a outra enviada pelo servidor, representado pelo parâmetro comnCodigoPai
     * @param comunicacao - dados da nova comunicação
     * @param cmnCodigoPai - código da comunicação para a qual está sendo gerada a resposta
     * @param responsavel - usuário logado responsável pela resposta
     * @return
     * @throws ZetraException
     */
    @Override
    public String geraComunicacaoResposta(TransferObject comunicacao, String cmnCodigoPai, AcessoSistema responsavel) throws ZetraException {
        if (TextHelper.isNull(cmnCodigoPai)) {
            throw new ZetraException("mensagem.erro.comunicacao.pai.nao.informada", responsavel);
        }

        // Busca o destinatário da comunicação pai
        final TransferObject destinatarios = buscaComunicacao(cmnCodigoPai, responsavel);
        final String csaCodigo = (String) destinatarios.getAttribute(Columns.CSA_CODIGO);

        final String papCodigoRemetente = destinatarios.getAttribute("PAP_CODIGO_REMETENTE").toString();
        final String papCodigoDestinatario = destinatarios.getAttribute("PAP_CODIGO_DESTINATARIO").toString();
        final String papCodigoRelacionamento = responsavel.getPapCodigo().equals(papCodigoRemetente) ? papCodigoDestinatario : papCodigoRemetente;

        String cmnCodigo = null;
        final String cmnTexto = validarTextoComunicacao(comunicacao, responsavel);
        final boolean cmnPendencia = definirComunicacaoPendente(papCodigoDestinatario, responsavel);

        try {
            final Comunicacao cmnPai = ComunicacaoHome.findByPrimaryKey(cmnCodigoPai);

            // Cria comunicação de resposta pendente ou não de acordo com as configurações do sistema e as entidades envolvidas
            final Comunicacao cmnBean = ComunicacaoHome.create(responsavel.getUsuCodigo(), cmnPai.getCmnNumero(),
                    cmnPendencia, cmnTexto,
                    (String) comunicacao.getAttribute(Columns.CMN_CODIGO_PAI),
                    (String) comunicacao.getAttribute(Columns.CMN_IP_ACESSO), false, cmnPai.getCmnCopiaEmailSms(), null, (String) comunicacao.getAttribute(Columns.CMN_ADE_CODIGO));
            cmnCodigo = cmnBean.getCmnCodigo();

            // Insere a comunicação de resposta de acordo com a entidade remetente e o responsável
            insereComunicacaoEntidade(cmnCodigo, papCodigoRelacionamento, destinatarios, responsavel);

            // Se a comunicação resposta será criada como pendente, então altera a comunicação pai para pendente
            if (cmnPendencia) {
                if (!cmnPai.getCmnPendencia()) {
                    cmnPai.setCmnPendencia(true);
                    AbstractEntityHome.update(cmnPai);
                }

                // Se a comunicação é destinada uma consignatária, verifica bloqueios por número de comunicações pendentes
                if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigoDestinatario) && !TextHelper.isNull(csaCodigo)) {
                    verificaBloqueioNumCmnPendentes(csaCodigo, responsavel);

                    if (responsavel.isSer()) {
                        // Verifica se tem configuração de número máximo de mensagens pendentes para a comunicação pai.
                        // Caso sim e tenha alcançado o limite, envia e-mail de alerta para o gestor.
                        int numMaxMsgPendenteCmn = 0;
                        try {
                            numMaxMsgPendenteCmn = Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_MAX_MSG_PENDENTE_POR_CMN, responsavel).toString());
                        } catch (final Exception ex) {
                            numMaxMsgPendenteCmn = 0;
                        }

                        if (numMaxMsgPendenteCmn > 0) {
                            final Collection<Comunicacao> msgPendentes = ComunicacaoHome.findComunicacaoPendenteSerRemetenteCsaDestinatario(cmnPai.getCmnCodigo());
                            if ((msgPendentes != null) && (msgPendentes.size() >= numMaxMsgPendenteCmn)) {
                                final ProcessaEnvioEmailCmnMsgPendente sendMailMsgPendenteThread = new ProcessaEnvioEmailCmnMsgPendente(cmnPai.getCmnTexto(), cmnPai.getCmnData(), cmnPai.getCmnNumero(), responsavel.getUsuCodigo(), csaCodigo, responsavel);
                                sendMailMsgPendenteThread.start();
                            }
                        }
                    }
                }

            } else {
                // Se a comunicação de resposta não reabre a pendência, verifica pelo tipo de entidade
                // se pode marcar a pendência como resolvida, e caso sim, atualiza as comunicações filhas
                if (papCodigoDestinatario.equals(responsavel.getPapCodigo())) {
                    // Se a comunicação tem como destinatário o tipo de entidade do usuário, então pode marcar como resolvida
                    cmnPai.setCmnPendencia(false);
                    AbstractEntityHome.update(cmnPai);

                    // Atualiza as comunicações filhas pendentes como resolvidas
                    final Collection<Comunicacao> comunicoesPendentes = ComunicacaoHome.findByCmnCodigoPai(cmnCodigoPai, true);
                    for (final Comunicacao cmnPendente : comunicoesPendentes) {
                        if (!cmnPendente.getCmnCodigo().equals(cmnCodigo)) {
                            cmnPendente.setCmnPendencia(false);
                            AbstractEntityHome.update(cmnPendente);
                        }
                    }

                    // Se a comunicação pai foi dada como resolvida, então caso o destinatário seja CSA
                    // verifica se precisa desbloquear automaticamente
                    if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigoDestinatario) && !TextHelper.isNull(csaCodigo)) {
                        final Consignataria csaTarget = ConsignatariaHome.findByPrimaryKey(csaCodigo);

                        // se consignatária não estiver ativa
                        if (csaTarget.getCsaAtivo().shortValue() != CodedValues.STS_ATIVO.shortValue()) {
                            int numMaxCmnPendente = 0;
                            try {
                                numMaxCmnPendente = Integer.parseInt(ParamSist.getInstance().getParam(CodedValues.TPC_NUM_MAX_CMN_PENDENTE_POR_CSA, responsavel).toString());
                            } catch (final Exception ex) {
                                numMaxCmnPendente = 0;
                            }

                            boolean podeValidarDesbloqAut = true;
                            if (numMaxCmnPendente > 0) {
                                // lista de usuários distintos que tem comunicação pendente com para a CSA.
                                final ListaUsuariosComunicacoesPendentesCsaQuery usuQuery = new ListaUsuariosComunicacoesPendentesCsaQuery();
                                usuQuery.csaCodigo = csaCodigo;

                                // Permite o desbloqueio apenas se não houver mais comunicações pendentes para o caso do parâmetro 355 for maior que 0.
                                podeValidarDesbloqAut = usuQuery.executarDTO().isEmpty();
                            }
                            if (podeValidarDesbloqAut) {
                                consignatariaController.verificarDesbloqueioAutomaticoConsignataria(csaCodigo, responsavel);
                            }
                        }
                    }
                }

                // Como é uma resposta de um outro usuário, envia email de alerta de que a cmn original foi respondida,
                // caso o usuário que gerou a comunicação original assim tenha solicitado.
                final boolean enviaCopiaComunicacaoUsuario = ParamSist.getBoolParamSist(CodedValues.TPC_ENVIAR_COMUNICACAO_CRIADA_EMAIL_USUARIO, responsavel);
                if ((cmnPai.getCmnAlertaEmail() || enviaCopiaComunicacaoUsuario) && !responsavel.getUsuCodigo().equals(cmnPai.getUsuario().getUsuCodigo())) {
                    final CustomTransferObject remetente = usuarioController.findTipoUsuarioByCodigo(cmnPai.getUsuario().getUsuCodigo(), responsavel);
                    String usuEmail = (String) remetente.getAttribute(Columns.USU_EMAIL);
                    // Se for servidor, o e-mail estará cadastrado na tb_servidor.ser_email
                    if (!TextHelper.isNull(remetente.getAttribute(Columns.USE_SER_CODIGO))) {
                        final Servidor servidor = ServidorHome.findByPrimaryKey((String) remetente.getAttribute(Columns.USE_SER_CODIGO));
                        usuEmail = servidor.getSerEmail();
                    }

                    if (!TextHelper.isNull(usuEmail)) {
                        final ProcessaEmailAlertaNovaComunicacao emailNovaCmn = new ProcessaEmailAlertaNovaComunicacao(responsavel.getUsuCodigo(), usuEmail, comunicacao, responsavel);
                        emailNovaCmn.start();
                    }

                    // Se a comunicação pai está informando que deve enviar cópia por email/sms ao servidor e a comunicação
                    // de resposta não é do servidor, então envia a comunicação por e-mail/sms
                    if ((cmnPai.getCmnCopiaEmailSms() || enviaCopiaComunicacaoUsuario) && !responsavel.isSer() && !TextHelper.isNull(comunicacao.getAttribute(Columns.SER_CODIGO))) {
                        enviarCopiaComunicacaoEmailSMS(comunicacao, responsavel);
                    }
                }
            }

            // Marca comunicação pai com não lida para demais usuários diferentes do usuário atual
            final List<LeituraComunicacaoUsuario> leiturasCmn = LeituraComunicacaoUsuarioHome.findByCmnCodigo(cmnCodigoPai);
            if ((leiturasCmn != null) && !leiturasCmn.isEmpty()) {
                for (final LeituraComunicacaoUsuario lcm : leiturasCmn) {
                    if (!lcm.getUsuCodigo().equals(responsavel.getUsuCodigo())) {
                        AbstractEntityHome.remove(lcm);
                    }
                }
            }

            // Verifica se CSA destinatária deve ser alertada via e-mail da criação desta comunicação.
            if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigoDestinatario) && !TextHelper.isNull(csaCodigo) && !responsavel.isCsa()) {
                final List<TransferObject> paramCsa = parametroController.selectParamCsa(csaCodigo, CodedValues.TPA_RECEBE_EMAIL_ALERTA_COMUNICACAO, null, null, null, responsavel);
                if ((paramCsa != null) && (paramCsa.size() > 0) && (paramCsa.get(0) != null)) {
                    final String emailAlertaNovaCmn = (String) paramCsa.get(0).getAttribute(Columns.PCS_VLR);

                    // Envia e-mail para o endereço especificado para esta consignatária no parâmetro de consignatária.
                    if (!TextHelper.isNull(emailAlertaNovaCmn)) {
                        final ProcessaEmailAlertaNovaComunicacao emailNovaCmn = new ProcessaEmailAlertaNovaComunicacao(responsavel.getUsuCodigo(), emailAlertaNovaCmn, comunicacao, responsavel);
                        emailNovaCmn.start();
                    }
                }
            }

            final LogDelegate log = new LogDelegate(responsavel, Log.COMUNICACAO, Log.CREATE, Log.LOG_INFORMACAO);
            log.setComunicacao(cmnCodigo);
            log.getUpdatedFields(comunicacao.getAtributos(), null);
            log.write();
        } catch (final CreateException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException("mensagem.erro.comunicacao.nao.criada", responsavel, ex.getMessage());
        } catch (final FindException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException("mensagem.erro.comunicacao.originaria.nao.encontrada", responsavel);
        } catch (final UpdateException uex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(uex.getMessage(), uex);
            throw new ZetraException("mensagem.erro.comunicacao.nao.atualizada", responsavel);
        } catch (final RemoveException e) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error("Erro ao atualizar comunicação.", e);
        }
        return cmnCodigo;
    }

    @Override
    public Comunicacao findComunicacaoByPK(String cmnCodigo, AcessoSistema responsavel) throws ZetraException {
        try {
            return ComunicacaoHome.findByPrimaryKey(cmnCodigo);
        } catch (final FindException e) {
            throw new ZetraException("mensagem.erro.comunicacao.nao.encontrada", responsavel);
        }
    }

    /**
     * gera entrada de leitura de uma comunicação pelo usuário de csa e/ou gestor
     * @param cmnCodigo
     * @param responsavel
     * @throws ZetraException
     */
    @Override
    public void logLeituraComunicacao(String cmnCodigo, AcessoSistema responsavel) throws ZetraException {
        try {
            final LeituraComunicacaoUsuario leituraNoBanco = LeituraComunicacaoUsuarioHome.findLeituraComunicacaoUsuByPK(new LeituraComunicacaoUsuarioId(cmnCodigo, responsavel.getUsuCodigo()));
            if (leituraNoBanco == null) {
                LeituraComunicacaoUsuarioHome.create(cmnCodigo, responsavel.getUsuCodigo());

                final Map<String, Object> mapAtributos = new HashMap<>();
                mapAtributos.put(Columns.CMN_CODIGO, cmnCodigo);
                mapAtributos.put(Columns.USU_CODIGO, responsavel.getCodigoEntidade());
                final LogDelegate log = new LogDelegate(responsavel, Log.LEITURA_COMUNICACAO, Log.CREATE, Log.LOG_INFORMACAO);
                log.setComunicacao(cmnCodigo);
                log.setUsuario(responsavel.getUsuCodigo());
                log.getUpdatedFields(mapAtributos, null);
                log.write();
            }
        } catch (final CreateException e) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            throw new ZetraException("mensagem.erro.criar.log.leitura.comunicacao", responsavel);
        } catch (final FindException e) {
            throw new ZetraException("mensagem.erro.criar.log.leitura.comunicacao", responsavel);
        }
    }

    @Override
    public Usuario findResponsavelCmn(String cmnCodigo, AcessoSistema responsavel) throws ZetraException {
        final ObtemResponsavelComunicacaoQuery ownerSQL = new ObtemResponsavelComunicacaoQuery();
        ownerSQL.cmnCodigo = cmnCodigo;
        try {
            final List<TransferObject> ownerList = ownerSQL.executarDTO();
            if (!ownerList.isEmpty()) {
                final TransferObject usuTO = ownerList.get(0);
                final Usuario usuario = new Usuario();
                usuario.setUsuCodigo((String) usuTO.getAttribute(Columns.USU_CODIGO));
                usuario.setUsuNome((String) usuTO.getAttribute(Columns.USU_NOME));
                usuario.setUsuLogin((String) usuTO.getAttribute(Columns.USU_LOGIN));

                return usuario;
            } else {
                return null;
            }
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException(ex);

        }
    }

    @Override
    public void bloqueiaCsaPorCmnPendente(AcessoSistema responsavel) throws ZetraException {
        final int diasParaBloqueioCmnEnviadaSer = getDiasParaBloqueioPorCmnPendente(CodedValues.TPC_QTDE_DIAS_BLOQ_CSA_CMN_SEM_RESPOSTA_SER, responsavel);
        final int diasParaBloqueioCmnEnviadaCseOrg = getDiasParaBloqueioPorCmnPendente(CodedValues.TPC_QTDE_DIAS_BLOQ_CSA_CMN_SEM_RESPOSTA_CSE_ORG, responsavel);

        // quantidade de dias = 0 significa que não há regra de bloqueio por comunicação pendente
        if ((diasParaBloqueioCmnEnviadaSer == 0) && (diasParaBloqueioCmnEnviadaCseOrg == 0)) {
            return;
        }

        try {
            final ListaConsignatariaCmnPendenteAlemPrazoQuery pendenciaQuery = new ListaConsignatariaCmnPendenteAlemPrazoQuery();
            pendenciaQuery.diasParaBloqueioCmnSer = diasParaBloqueioCmnEnviadaSer;
            pendenciaQuery.diasParaBloqueioCmnCseOrg = diasParaBloqueioCmnEnviadaCseOrg;

            final List<TransferObject> csaList = pendenciaQuery.executarDTO();
            if (!csaList.isEmpty()) {
                // Extrai os códigos das consignatárias da lista que devem ser bloqueadas
                final List<String> csaCodigos = new ArrayList<>();

                for (final TransferObject csaTO : csaList) {
                    final int qtdPendenciaSer = Integer.parseInt(csaTO.getAttribute("QTD_PENDENCIA_SER").toString());
                    final int qtdPendenciaCse = Integer.parseInt(csaTO.getAttribute("QTD_PENDENCIA_CSE").toString());
                    final int qtdPendenciaOrg = Integer.parseInt(csaTO.getAttribute("QTD_PENDENCIA_ORG").toString());

                    if (((diasParaBloqueioCmnEnviadaSer > 0) && (qtdPendenciaSer > 0)) ||
                            ((diasParaBloqueioCmnEnviadaCseOrg > 0) && ((qtdPendenciaCse > 0) || (qtdPendenciaOrg > 0)))) {
                        csaCodigos.add((String) csaTO.getAttribute(Columns.CSA_CODIGO));
                    }
                }

                if (!csaCodigos.isEmpty()) {
                    // Executa o bloqueio das consignatárias
                    consignatariaController.bloquearConsignatarias(csaCodigos, ApplicationResourcesHelper.getMessage("mensagem.bloqueio.comunicacoes.pendentes.expiradas", responsavel), CodedValues.TOC_BLOQUEIA_CONSIGNATARIA, responsavel);

                    // incluí ocorrência específica de comunicação pendente caso tenha desbloqueio automático configurado no sistema.
                    if (ParamSist.paramEquals(CodedValues.TPC_DESBLOQ_AUT_CSA_CMN_SEM_RESPOSTA, CodedValues.TPC_SIM, responsavel)) {
                        consignatariaController.incluirOcorrenciaConsignatarias(csaCodigos, CodedValues.TOC_CONSIGNATARIA_COM_CMN_PENDENTE, ApplicationResourcesHelper.getMessage("mensagem.informacao.csa.possui.comunicacoes.pendentes", responsavel), responsavel);
                    }
                }
            }
        } catch (final HQueryException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException("mensagem.erroInternoSistema", responsavel, ex);
        } catch (final ZetraException ex) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
            LOG.error(ex.getMessage(), ex);
            throw ex;
        }
    }

    @Override
    public boolean temComunicacoesParaBloqueioCsa(String csaCodigo, AcessoSistema responsavel) throws ZetraException {
        final int diasParaBloqueioCmnEnviadaSer = getDiasParaBloqueioPorCmnPendente(CodedValues.TPC_QTDE_DIAS_BLOQ_CSA_CMN_SEM_RESPOSTA_SER, responsavel);
        final int diasParaBloqueioCmnEnviadaCseOrg = getDiasParaBloqueioPorCmnPendente(CodedValues.TPC_QTDE_DIAS_BLOQ_CSA_CMN_SEM_RESPOSTA_CSE_ORG, responsavel);

        // quantidade de dias = 0 significa que não há regra de bloqueio por comunicação pendente
        if ((diasParaBloqueioCmnEnviadaSer == 0) && (diasParaBloqueioCmnEnviadaCseOrg == 0)) {
            return false;
        }

        try {
            final ListaConsignatariaCmnPendenteAlemPrazoQuery pendenciaQuery = new ListaConsignatariaCmnPendenteAlemPrazoQuery();
            pendenciaQuery.csaCodigo = csaCodigo;
            pendenciaQuery.diasParaBloqueioCmnSer = diasParaBloqueioCmnEnviadaSer;
            pendenciaQuery.diasParaBloqueioCmnCseOrg = diasParaBloqueioCmnEnviadaCseOrg;

            final List<TransferObject> csaList = pendenciaQuery.executarDTO();
            if (!csaList.isEmpty()) {
                for (final TransferObject csaTO : csaList) {
                    final int qtdPendenciaSer = Integer.parseInt(csaTO.getAttribute("QTD_PENDENCIA_SER").toString());
                    final int qtdPendenciaCse = Integer.parseInt(csaTO.getAttribute("QTD_PENDENCIA_CSE").toString());
                    final int qtdPendenciaOrg = Integer.parseInt(csaTO.getAttribute("QTD_PENDENCIA_ORG").toString());

                    if (((diasParaBloqueioCmnEnviadaSer > 0) && (qtdPendenciaSer > 0)) ||
                            ((diasParaBloqueioCmnEnviadaCseOrg > 0) && ((qtdPendenciaCse > 0) || (qtdPendenciaOrg > 0)))) {
                        return true;
                    }
                }
            }

            return false;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    private int getDiasParaBloqueioPorCmnPendente(String tpcCodigo, AcessoSistema responsavel) {
        int diasParaBloqueio = 0;

        try {
            final Object paramValue = ParamSist.getInstance().getParam(tpcCodigo, responsavel);
            diasParaBloqueio = TextHelper.isNum(paramValue) ? Integer.parseInt(paramValue.toString()) : 0;
        } catch (final NumberFormatException nex) {
            diasParaBloqueio = 0;
        }
        return diasParaBloqueio;
    }

    /**
     * Comunicação enviada por um usuário SER ou CSE/ORG com destino para uma consignatária será criada como pendente,
     * caso haja bloqueio de consignatária nas comunicações não respondidas no prazo
     * @param papCodigoDestinatario
     * @param responsavel
     * @return
     */
    private boolean definirComunicacaoPendente(String papCodigoDestinatario, AcessoSistema responsavel) {
        final int diasParaBloqueioCmnEnviadaSer = getDiasParaBloqueioPorCmnPendente(CodedValues.TPC_QTDE_DIAS_BLOQ_CSA_CMN_SEM_RESPOSTA_SER, responsavel);
        final int diasParaBloqueioCmnEnviadaCseOrg = getDiasParaBloqueioPorCmnPendente(CodedValues.TPC_QTDE_DIAS_BLOQ_CSA_CMN_SEM_RESPOSTA_CSE_ORG, responsavel);

        if (CodedValues.PAP_CONSIGNATARIA.equals(papCodigoDestinatario) &&
                (((diasParaBloqueioCmnEnviadaSer > 0) && responsavel.isSer()) || ((diasParaBloqueioCmnEnviadaCseOrg > 0) && responsavel.isCseOrg()))) {
            return true;
        }

        return false;
    }

    @Override
    public List<ComunicacaoPermitida> listaComunicacaoPermitida(AcessoSistema responsavel) throws ZetraException {
        try {
            return ComunicacaoPermitidaHome.listaComunicacaoPermitida();
        } catch (final FindException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ZetraException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    @Override
    public List<TransferObject> listarComunicacaoNaoLida(int diasAposEnvio, String papel, AcessoSistema responsavel) throws ZetraException {
        try {
            if (CodedValues.PAP_CONSIGNANTE.equals(papel)) {
                final ListaComunicacoesNaoLidasCseQuery query = new ListaComunicacoesNaoLidasCseQuery();
                query.diasAposEnvio = diasAposEnvio;
                return query.executarDTO();
            } else if (CodedValues.PAP_CONSIGNATARIA.equals(papel)) {
                final ListaComunicacoesNaoLidasCsaQuery query = new ListaComunicacoesNaoLidasCsaQuery();
                query.diasAposEnvio = diasAposEnvio;
                return query.executarDTO();
            } else if (CodedValues.PAP_ORGAO.equals(papel)) {
                final ListaComunicacoesNaoLidasOrgQuery query = new ListaComunicacoesNaoLidasOrgQuery();
                query.diasAposEnvio = diasAposEnvio;
                return query.executarDTO();
            } else if (CodedValues.PAP_SERVIDOR.equals(papel)) {
                final ListaComunicacoesNaoLidasSerQuery query = new ListaComunicacoesNaoLidasSerQuery();
                query.diasAposEnvio = diasAposEnvio;
                return query.executarDTO();
            }

            return null;
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            throw new ConsignanteControllerException("mensagem.erroInternoSistema", responsavel, ex);
        }
    }

    private List<String> listaCsaCodigos(String nseCodigo, AcessoSistema responsavel) {
        try {
            final ListaConsignatariaConvenioNseCodigoQuery query = new ListaConsignatariaConvenioNseCodigoQuery();
            query.nseCodigo = nseCodigo;
            query.responsavel = responsavel;
            return query.executarLista();
        } catch (final HQueryException ex) {
            LOG.error(ex.getMessage(), ex);
            return new ArrayList<>();
        }
    }

    private void comunicaCsa(String csaCodigo, TransferObject comunicacao, AcessoSistema responsavel) throws HQueryException, FindException, ConsignatariaControllerException, ParametroControllerException {
        verificaBloqueioNumCmnPendentes(csaCodigo, responsavel);

        // Verifica se CSA destinatária deve ser alertada via e-mail da criação desta comunicação.
        final List<TransferObject> paramCsa = parametroController.selectParamCsa(csaCodigo, CodedValues.TPA_RECEBE_EMAIL_ALERTA_COMUNICACAO, null, null, null, responsavel);
        if ((paramCsa != null) && (paramCsa.size() > 0) && (paramCsa.get(0) != null)) {
            final String emailAlertaNovaCmn = (String) paramCsa.get(0).getAttribute(Columns.PCS_VLR);

            // envia e-mail para o endereço especificado para esta consignatária no parâmetro de consignatária.
            if (!TextHelper.isNull(emailAlertaNovaCmn)) {
                final ProcessaEmailAlertaNovaComunicacao emailNovaCmn = new ProcessaEmailAlertaNovaComunicacao(responsavel.getUsuCodigo(), emailAlertaNovaCmn, comunicacao, responsavel);
                emailNovaCmn.start();
            }
        }
    }

    private void comunicaOrg(String orgCodigo, TransferObject comunicacao, AcessoSistema responsavel) throws HQueryException, FindException, ConsignatariaControllerException, ParametroControllerException {
        final Orgao orgao = OrgaoHome.findByPrimaryKey(orgCodigo);
        if (!TextHelper.isNull(orgao.getOrgEmail())) {
            final ProcessaEmailAlertaNovaComunicacao emailNovaCmn = new ProcessaEmailAlertaNovaComunicacao(responsavel.getUsuCodigo(), orgao.getOrgEmail(), comunicacao, responsavel);
            emailNovaCmn.start();
        }
    }

    private void comunicaCse(String cseCodigo, TransferObject comunicacao, AcessoSistema responsavel) throws HQueryException, FindException, ConsignatariaControllerException, ParametroControllerException {
        final Consignante cse = ConsignanteHome.findByPrimaryKey(cseCodigo);
        if (!TextHelper.isNull(cse.getCseEmail())) {
            final ProcessaEmailAlertaNovaComunicacao emailNovaCmn = new ProcessaEmailAlertaNovaComunicacao(responsavel.getUsuCodigo(), cse.getCseEmail(), comunicacao, responsavel);
            emailNovaCmn.start();
        }
    }

    private void enviaCopiaUsuEmail(TransferObject comunicacao, AcessoSistema responsavel) {
        final String email = !responsavel.isSer() ? responsavel.getUsuEmail() : responsavel.getSerEmail();
        if (!TextHelper.isNull(email)) {
            final ProcessaEmailAlertaNovaComunicacao emailNovaCmn = new ProcessaEmailAlertaNovaComunicacao(responsavel.getUsuCodigo(), email, comunicacao, responsavel);
            emailNovaCmn.start();
        }
    }
}

cannot find symbol

////////////////////
package com.zetra.econsig.web.controller.consignacao;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;

import com.zetra.econsig.delegate.LogDelegate;
import com.zetra.econsig.dto.CustomTransferObject;
import com.zetra.econsig.exception.LogControllerException;
import com.zetra.econsig.exception.ViewHelperException;
import com.zetra.econsig.exception.ZetraException;
import com.zetra.econsig.helper.email.EnviaEmailHelper;
import com.zetra.econsig.helper.log.Log;
import com.zetra.econsig.helper.parametro.ParamSist;
import com.zetra.econsig.helper.seguranca.AcessoSistema;
import com.zetra.econsig.helper.seguranca.SynchronizerToken;
import com.zetra.econsig.helper.sms.SMSHelper;
import com.zetra.econsig.helper.texto.ApplicationResourcesHelper;
import com.zetra.econsig.helper.texto.LocaleHelper;
import com.zetra.econsig.helper.texto.TextHelper;
import com.zetra.econsig.helper.texto.TransferObjectHelper;
import com.zetra.econsig.helper.web.JspHelper;
import com.zetra.econsig.helper.web.ParamSession;
import com.zetra.econsig.service.consignacao.AutorizacaoController;
import com.zetra.econsig.service.consignacao.PesquisarConsignacaoController;
import com.zetra.econsig.values.CodedValues;
import com.zetra.econsig.values.Columns;
import com.zetra.econsig.web.controller.AbstractWebController;

/**
 * <p>Title: EnviarResumoAdeParaServidorWebController</p>
 * <p>Description: Controlador Web para o caso de uso Enviar Resumo de Consignação para o Servidor.</p>
 * <p>Copyright: Copyright (c) 2002-2019</p>
 * <p>Company: ZetraSoft</p>
 * $Author$
 * $Revision$
 * $Date$
 */
@Controller
@RequestMapping(method = { RequestMethod.POST }, value = { "/v3/enviarResumoAdeParaServidor" })
public class EnviarResumoAdeParaServidorWebController extends AbstractWebController {
    private static final org.apache.commons.logging.Log LOG = org.apache.commons.logging.LogFactory.getLog(EnviarResumoAdeParaServidorWebController.class);

    @Autowired
    @Qualifier("autorizacaoController")
    private AutorizacaoController autorizacaoController;

    @Autowired
    private PesquisarConsignacaoController pesquisarConsignacaoController;

    @RequestMapping(params = { "acao=enviar" })
    public String enviar(@RequestParam(value = "ADE_CODIGO", required = true, defaultValue = "") String adeCodigo, HttpServletRequest request, HttpServletResponse response, HttpSession session, Model model) {
        AcessoSistema responsavel = JspHelper.getAcessoSistema(request);

        // Valida o token de sessão para evitar a chamada direta à operação
        if (!SynchronizerToken.isTokenValid(request)) {
            session.setAttribute(CodedValues.MSG_ERRO, ApplicationResourcesHelper.getMessage("mensagem.erro.interno.contate.administrador", responsavel));
            return viewRedirect("jsp/visualizarPaginaErro/visualizarMensagem", request, session, model, responsavel);
        }
        SynchronizerToken.saveToken(request);

        try {
            // Obtém os dados da ADE
            CustomTransferObject autdes = TransferObjectHelper.mascararUsuarioHistorico(pesquisarConsignacaoController.buscaAutorizacao(adeCodigo, responsavel), null, responsavel);
            String adeNumero = autdes.getAttribute(Columns.ADE_NUMERO).toString();
            String sadDescricao = autdes.getAttribute(Columns.SAD_DESCRICAO) != null ? autdes.getAttribute(Columns.SAD_DESCRICAO).toString() : "";
            String csaNome = (String) autdes.getAttribute(Columns.CSA_NOME_ABREV);
            if (TextHelper.isNull(csaNome)) {
                csaNome = (String) autdes.getAttribute(Columns.CSA_NOME);
            }
            if (csaNome.length() > 50) {
                csaNome = csaNome.substring(0, 47) + "...";
            }

            // Obtém os dados do servidor, para verificar se possui e-mail ou celular cadastrados
            String serEmail = (String) autdes.getAttribute(Columns.SER_EMAIL);
            String serCelular = (String) autdes.getAttribute(Columns.SER_CELULAR);

            boolean resumoEnviadoEmail = false;
            boolean resumoEnviadoSMS = false;

            // Enviar o resumo da ADE por e-mail
            if (!TextHelper.isNull(serEmail)) {
                EnviaEmailHelper.enviarEmailResumoConsignacao(serEmail, autdes, responsavel);
                resumoEnviadoEmail = true;
            }

            // Enviar o resumo da ADE por SMS
            if (!TextHelper.isNull(serCelular)) {
                // Credenciais para envio do SMS
                String accountSid = ParamSist.getInstance().getParam(CodedValues.TPC_SID_CONTA_SMS, responsavel).toString();
                String authToken = ParamSist.getInstance().getParam(CodedValues.TPC_TOKEN_AUTENTICACAO_SMS, responsavel).toString();
                String fromNumber = ParamSist.getInstance().getParam(CodedValues.TPC_NUMERO_REMETENTE_SMS, responsavel).toString();

                if (TextHelper.isNull(accountSid) || TextHelper.isNull(authToken) || TextHelper.isNull(fromNumber)) {
                    LOG.warn("Necessário habilitar os parâmetros de sistema " + CodedValues.TPC_SID_CONTA_SMS + ", " + CodedValues.TPC_TOKEN_AUTENTICACAO_SMS + ", " + CodedValues.TPC_NUMERO_REMETENTE_SMS + " para envio de SMS.");
                    throw new ViewHelperException("mensagem.erro.sms.enviar", responsavel);

                } else {
                    String celularDestinatario = LocaleHelper.formataCelular(serCelular);
                    if (!TextHelper.isNull(celularDestinatario)) {
                        String corpo = ApplicationResourcesHelper.getMessage("mensagem.sms.resumo.consignacao", responsavel, adeNumero, csaNome, sadDescricao);
                        new SMSHelper(accountSid, authToken, fromNumber).send(celularDestinatario, TextHelper.removeAccent(corpo));
                        resumoEnviadoSMS = true;
                    }
                }
            }

            if (resumoEnviadoEmail || resumoEnviadoSMS) {
                // Registra log de auditoria
                try {
                    LogDelegate log = new LogDelegate(responsavel, Log.AUTORIZACAO, Log.ENVIAR_RESUMO_CONSIGNACAO, Log.LOG_INFORMACAO);
                    log.setAutorizacaoDesconto(adeCodigo);
                    if (!TextHelper.isNull(serEmail)) {
                        log.addChangedField(Columns.SER_EMAIL, serEmail);
                    }
                    if (!TextHelper.isNull(serCelular)) {
                        log.addChangedField(Columns.SER_CELULAR, serCelular);
                    }
                    log.write();
                } catch (LogControllerException ex) {
                    LOG.error(ex.getMessage(), ex);
                }

                // Envia mensagem de sucesso
                if (resumoEnviadoEmail && resumoEnviadoSMS) {
                    session.setAttribute(CodedValues.MSG_INFO, ApplicationResourcesHelper.getMessage("mensagem.sucesso.enviar.resumo.consignacao.servidor.ambos", responsavel));
                } else if (resumoEnviadoEmail) {
                    session.setAttribute(CodedValues.MSG_INFO, ApplicationResourcesHelper.getMessage("mensagem.sucesso.enviar.resumo.consignacao.servidor.email", responsavel));
                } else if (resumoEnviadoSMS) {
                    session.setAttribute(CodedValues.MSG_INFO, ApplicationResourcesHelper.getMessage("mensagem.sucesso.enviar.resumo.consignacao.servidor.sms", responsavel));
                }
            } else {
                // Envia mensagem de erro
                session.setAttribute(CodedValues.MSG_ERRO, ApplicationResourcesHelper.getMessage("mensagem.erro.enviar.resumo.consignacao.servidor", responsavel));
            }

            // Volta à operação anterior
            ParamSession paramSession = ParamSession.getParamSession(session);
            request.setAttribute("url64", TextHelper.encode64(SynchronizerToken.updateTokenInURL(paramSession.getLastHistory(), request)));
            return "jsp/redirecionador/redirecionar";
        } catch (ZetraException ex) {
            session.setAttribute(CodedValues.MSG_ERRO, ex.getMessage());
            return viewRedirect("jsp/visualizarPaginaErro/visualizarMensagem", request, session, model, responsavel);
        }
    }
}

