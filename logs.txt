package com.zetra.econsig.helper.sms;

import com.zetra.econsig.context.ApplicationContextProvider;
import com.zetra.econsig.exception.ZetraException;
import com.zetra.econsig.helper.parametro.ParamSist;
import com.zetra.econsig.helper.seguranca.AcessoSistema;
import com.zetra.econsig.persistence.entity.DadosConsignante;
import com.zetra.econsig.persistence.entity.DadosConsignanteHome;
import com.zetra.econsig.persistence.entity.DadosConsignanteId;
import com.zetra.econsig.values.CodedValues;

import org.springframework.boot.SpringApplication;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.core.env.Environment;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Scanner;

/**
 * TESTE DE INTEGRAÃ‡ÃƒO COM CLASSES REAIS DO SISTEMA ECONSIG
 * 
 * Este teste utiliza as classes REAIS do sistema:
 * - SMSHelper: Envio de SMS via Zenvia + verificaÃ§Ã£o de limites
 * - MailHelper: Envio de emails de alerta
 * - ModeloEmailHome: Busca templates de email
 * - DadosConsignanteHome: Controle de contadores
 * - ParamSist: Leitura de parÃ¢metros de sistema
 * 
 * PRÃ‰-REQUISITOS:
 * 1. Banco de dados configurado e acessÃ­vel
 * 2. ParÃ¢metros TPC 1016 e 1017 cadastrados para o consignante de teste
 * 3. Modelos de email 260 e 261 cadastrados
 * 4. ParÃ¢metro TPC 207 com email de suporte configurado
 * 5. application.properties com configuraÃ§Ãµes Zenvia:
 *    - zenvia.sms.api.url
 *    - zenvia.sms.api.token
 *    - zenvia.sms.from
 * 
 * COMO EXECUTAR:
 * 1. Configure as constantes TELEFONE_TESTE e CSE_CODIGO abaixo
 * 2. Execute via Maven:
 *    mvn exec:java -Dexec.mainClass="com.zetra.econsig.helper.sms.SMSIntegrationRealTest"
 * 3. Ou execute diretamente no IntelliJ/Eclipse como classe main
 */
public class SMSIntegrationRealTest {

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURAÃ‡Ã•ES DE TESTE - EDITE AQUI
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    private static final String TELEFONE_TESTE = "+5521992755726";  // <-- EDITE COM SEU NÃšMERO
    private static final String CSE_CODIGO = "1";  // <-- CÃ“DIGO DO CONSIGNANTE PARA TESTE
    
    // Classe de aplicaÃ§Ã£o Spring Boot (ajuste se necessÃ¡rio)
    private static final String SPRING_BOOT_APP_CLASS = "com.zetra.econsig.Application";
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private ConfigurableApplicationContext springContext;
    private SMSHelper smsHelper;
    private AcessoSistema acessoSistema;

    public static void main(String[] args) {
        System.out.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘    TESTE DE INTEGRAÃ‡ÃƒO SMS ZENVIA - CLASSES REAIS            â•‘");
        System.out.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
        System.out.println("â•‘ Este teste usa as classes REAIS do eConsig:                  â•‘");
        System.out.println("â•‘ - SMSHelper (envio SMS + verificaÃ§Ã£o de limites)             â•‘");
        System.out.println("â•‘ - MailHelper (envio de emails de alerta)                     â•‘");
        System.out.println("â•‘ - ModeloEmailHome (templates de email)                       â•‘");
        System.out.println("â•‘ - DadosConsignanteHome (contadores TDA 96/97/98/99)          â•‘");
        System.out.println("â•‘ - ParamSist (parÃ¢metros TPC 1016/1017/207)                   â•‘");
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        System.out.println();

        SMSIntegrationRealTest test = new SMSIntegrationRealTest();
        Scanner scanner = new Scanner(System.in);

        try {
            test.inicializarSpringContext();
            test.configurarSMSHelper();
            test.configurarAcessoSistema();
            test.mostrarConfiguracoes();
            test.mostrarMenu(scanner);
        } catch (Exception e) {
            System.err.println("âŒ ERRO: " + e.getMessage());
            e.printStackTrace();
        } finally {
            test.fecharSpringContext();
            scanner.close();
        }
    }

    /**
     * Inicializa o contexto Spring Boot completo.
     */
    private void inicializarSpringContext() {
        System.out.println("ğŸ”Œ Inicializando contexto Spring Boot...");
        try {
            Class<?> appClass = Class.forName(SPRING_BOOT_APP_CLASS);
            springContext = SpringApplication.run(appClass, new String[]{});
            System.out.println("   âœ… Contexto Spring inicializado!");
        } catch (ClassNotFoundException e) {
            System.err.println("   âš ï¸ Classe de aplicaÃ§Ã£o nÃ£o encontrada: " + SPRING_BOOT_APP_CLASS);
            System.err.println("   âš ï¸ Tentando inicializar sem Spring Boot completo...");
            // O teste pode funcionar se o ApplicationContextProvider jÃ¡ estiver configurado
        }
    }

    /**
     * Configura o SMSHelper usando as propriedades do application.properties.
     */
    private void configurarSMSHelper() {
        System.out.println("\nğŸ“± Configurando SMSHelper...");
        
        Environment env = ApplicationContextProvider.getApplicationContext().getEnvironment();
        
        String apiUrl = env.getProperty(CodedValues.PROP_ZENVIA_API_URL);
        String apiToken = env.getProperty(CodedValues.PROP_ZENVIA_API_TOKEN);
        String fromId = env.getProperty(CodedValues.PROP_ZENVIA_FROM);

        if (apiUrl == null || apiToken == null || fromId == null) {
            throw new RuntimeException("ConfiguraÃ§Ãµes Zenvia nÃ£o encontradas no application.properties!\n" +
                    "Verifique: zenvia.sms.api.url, zenvia.sms.api.token, zenvia.sms.from");
        }

        smsHelper = new SMSHelper(apiUrl, apiToken, fromId);
        System.out.println("   âœ… SMSHelper configurado!");
        System.out.println("      URL: " + apiUrl);
        System.out.println("      From: " + fromId);
    }

    /**
     * Configura o AcessoSistema para simular um usuÃ¡rio consignante.
     */
    private void configurarAcessoSistema() {
        System.out.println("\nğŸ‘¤ Configurando AcessoSistema...");
        
        acessoSistema = new AcessoSistema();
        acessoSistema.setTipoEntidade(AcessoSistema.ENTIDADE_CSE);
        acessoSistema.setCodigoEntidade(CSE_CODIGO);
        acessoSistema.setUsuCodigo("999");
        acessoSistema.setUsuNome("Usuario Teste SMS");
        acessoSistema.setUsuEmail("teste@econsig.com.br");
        acessoSistema.setIpUsuario("127.0.0.1");
        
        System.out.println("   âœ… AcessoSistema configurado!");
        System.out.println("      Tipo: " + acessoSistema.getTipoEntidade());
        System.out.println("      CSE: " + acessoSistema.getCseCodigo());
    }

    /**
     * Mostra as configuraÃ§Ãµes atuais (limites, email, contadores).
     */
    private void mostrarConfiguracoes() {
        System.out.println("\nğŸ“‹ CONFIGURAÃ‡Ã•ES ATUAIS:");
        
        try {
            // Limites
            Object limInf = ParamSist.getInstance().getParam(CodedValues.TPC_LIMITE_INFERIOR_ENVIO_SMS_MES, acessoSistema);
            Object limSup = ParamSist.getInstance().getParam(CodedValues.TPC_LIMITE_SUPERIOR_ENVIO_SMS_MES, acessoSistema);
            Object emailSuporte = ParamSist.getInstance().getParam(CodedValues.TPC_EMAIL_SUPORTE_ZETRASOFT, acessoSistema);
            
            System.out.println("   Limite Inferior (TPC 1016): " + (limInf != null ? limInf : "NÃƒO CONFIGURADO"));
            System.out.println("   Limite Superior (TPC 1017): " + (limSup != null ? limSup : "NÃƒO CONFIGURADO"));
            System.out.println("   Email Suporte (TPC 207): " + (emailSuporte != null ? emailSuporte : "NÃƒO CONFIGURADO"));
            
            // Contador atual
            int contador = smsHelper.getQuantidadeSmsNoMes(CSE_CODIGO);
            System.out.println("   Contador SMS atual: " + contador);
            
            // Flags de alerta
            DadosConsignante flagInf = findDadoAdicional(CSE_CODIGO, CodedValues.TDA_ALERTA_LIMITE_INF_SMS);
            DadosConsignante flagSup = findDadoAdicional(CSE_CODIGO, CodedValues.TDA_ALERTA_LIMITE_SUP_SMS);
            
            System.out.println("   Flag Alerta Inferior (TDA 98): " + (flagInf != null ? flagInf.getDacValor() : "NÃƒO ENVIADO"));
            System.out.println("   Flag Alerta Superior (TDA 99): " + (flagSup != null ? flagSup.getDacValor() : "NÃƒO ENVIADO"));
            
        } catch (Exception e) {
            System.err.println("   âš ï¸ Erro ao obter configuraÃ§Ãµes: " + e.getMessage());
        }
    }

    private void mostrarMenu(Scanner scanner) throws Exception {
        while (true) {
            System.out.println("\nğŸ“‹ MENU:");
            System.out.println("1. Executar fluxo completo de testes (envia SMS e emails reais)");
            System.out.println("2. Enviar 1 SMS (com verificaÃ§Ã£o de limites)");
            System.out.println("3. Ver estado atual (contador, flags, limites)");
            System.out.println("4. Limpar dados de teste (TDA 96/97/98/99)");
            System.out.println("5. Enviar SMS direto (sem limites - teste bÃ¡sico)");
            System.out.println("0. Sair");
            System.out.print("\nEscolha: ");
            
            String opcao = scanner.nextLine().trim();
            
            switch (opcao) {
                case "1": executarFluxoCompleto(); break;
                case "2": enviarSmsComLimites(); break;
                case "3": mostrarConfiguracoes(); break;
                case "4": limparDadosTeste(); break;
                case "5": enviarSmsDireto(); break;
                case "0": return;
                default: System.out.println("OpÃ§Ã£o invÃ¡lida!");
            }
        }
    }

    /**
     * Executa o fluxo completo de testes usando as classes reais.
     */
    private void executarFluxoCompleto() throws Exception {
        System.out.println("\n" + "â•".repeat(63));
        System.out.println("EXECUTANDO FLUXO COMPLETO COM CLASSES REAIS");
        System.out.println("â•".repeat(63));
        
        // Busca limites
        Object limInfObj = ParamSist.getInstance().getParam(CodedValues.TPC_LIMITE_INFERIOR_ENVIO_SMS_MES, acessoSistema);
        Object limSupObj = ParamSist.getInstance().getParam(CodedValues.TPC_LIMITE_SUPERIOR_ENVIO_SMS_MES, acessoSistema);
        
        int limiteInferior = limInfObj != null ? Integer.parseInt(limInfObj.toString()) : 2;
        int limiteSuperior = limSupObj != null ? Integer.parseInt(limSupObj.toString()) : 5;
        
        System.out.println("ğŸ“‹ ConfiguraÃ§Ã£o:");
        System.out.println("   Limite Inferior (TPC 1016): " + limiteInferior);
        System.out.println("   Limite Superior (TPC 1017): " + limiteSuperior);
        System.out.println("   Telefone: " + TELEFONE_TESTE);
        System.out.println("   Consignante: " + CSE_CODIGO);
        
        // Limpa dados
        System.out.println("\nğŸ“‹ PREPARAÃ‡ÃƒO:");
        limparDadosTeste();
        
        int testesOk = 0;
        int testesFalha = 0;

        // Envia SMS atÃ© atingir o limite superior
        for (int i = 1; i <= limiteSuperior; i++) {
            System.out.println("\n" + "â”€".repeat(63));
            
            if (i < limiteInferior) {
                System.out.println("CT-0" + i + ": Enviar " + i + "Âº SMS (abaixo do limite inferior)");
            } else if (i == limiteInferior) {
                System.out.println("CT-0" + i + ": Enviar " + i + "Âº SMS (atinge limite inferior - EMAIL DE ALERTA!)");
            } else if (i < limiteSuperior) {
                System.out.println("CT-0" + i + ": Enviar " + i + "Âº SMS (intermediÃ¡rio)");
            } else {
                System.out.println("CT-0" + i + ": Enviar " + i + "Âº SMS (Ãºltimo permitido - atinge limite superior)");
            }
            
            System.out.println("â”€".repeat(63));
            
            try {
                String mensagem = "Teste CT-" + String.format("%02d", i) + " - " + new SimpleDateFormat("HH:mm:ss").format(new Date());
                smsHelper.send(TELEFONE_TESTE, mensagem, acessoSistema);
                
                System.out.println("   âœ… SMS enviado com sucesso!");
                int contador = smsHelper.getQuantidadeSmsNoMes(CSE_CODIGO);
                System.out.println("   ğŸ“Š Novo contador: " + contador);
                
                // Verifica se deveria ter enviado email de alerta
                if (contador == limiteInferior) {
                    DadosConsignante flagInf = findDadoAdicional(CSE_CODIGO, CodedValues.TDA_ALERTA_LIMITE_INF_SMS);
                    if (flagInf != null) {
                        System.out.println("   ğŸ“§ EMAIL de alerta INFERIOR enviado! (TDA 98 = " + flagInf.getDacValor() + ")");
                    }
                }
                
                if (contador == limiteSuperior) {
                    DadosConsignante flagSup = findDadoAdicional(CSE_CODIGO, CodedValues.TDA_ALERTA_LIMITE_SUP_SMS);
                    if (flagSup != null) {
                        System.out.println("   ğŸ“§ EMAIL de alerta SUPERIOR enviado! (TDA 99 = " + flagSup.getDacValor() + ")");
                    }
                }
                
                testesOk++;
                
            } catch (ZetraException e) {
                if (e.getMessage().contains("Limite superior")) {
                    System.out.println("   ğŸš« SMS BLOQUEADO: " + e.getMessage());
                    // Se for o Ãºltimo, Ã© esperado ser bloqueado? Na verdade nÃ£o deveria ser bloqueado atÃ© atingir o limite
                    testesFalha++;
                } else {
                    System.out.println("   âŒ ERRO: " + e.getMessage());
                    testesFalha++;
                }
            }
        }
        
        // Tenta enviar mais um (deve ser bloqueado)
        System.out.println("\n" + "â”€".repeat(63));
        System.out.println("CT-0" + (limiteSuperior + 1) + ": Enviar " + (limiteSuperior + 1) + "Âº SMS (deve ser BLOQUEADO)");
        System.out.println("â”€".repeat(63));
        
        try {
            String mensagem = "Teste BLOQUEIO - " + new SimpleDateFormat("HH:mm:ss").format(new Date());
            smsHelper.send(TELEFONE_TESTE, mensagem, acessoSistema);
            System.out.println("   âŒ ERRO: Deveria ter sido bloqueado, mas foi enviado!");
            testesFalha++;
        } catch (ZetraException e) {
            if (e.getMessage().contains("Limite superior")) {
                System.out.println("   ğŸš« SMS BLOQUEADO corretamente!");
                System.out.println("   âœ… Comportamento esperado!");
                testesOk++;
            } else {
                System.out.println("   âŒ ERRO inesperado: " + e.getMessage());
                testesFalha++;
            }
        }
        
        // Mostra estado final
        System.out.println("\n" + "â”€".repeat(63));
        System.out.println("CT-FINAL: VerificaÃ§Ã£o do estado final");
        System.out.println("â”€".repeat(63));
        mostrarConfiguracoes();
        
        // Resumo
        System.out.println("\n" + "â•".repeat(63));
        System.out.println("ğŸ“Š RESULTADO FINAL");
        System.out.println("â•".repeat(63));
        System.out.println("   âœ… Testes OK: " + testesOk);
        System.out.println("   âŒ Testes com falha: " + testesFalha);
        
        if (testesFalha == 0) {
            System.out.println("\nğŸ‰ TODOS OS TESTES PASSARAM!");
        } else {
            System.out.println("\nâš ï¸ Alguns testes falharam. Verifique os logs acima.");
        }
        
        System.out.println("\nğŸ“§ VERIFICAÃ‡ÃƒO DE EMAILS:");
        System.out.println("   Verifique a caixa de entrada do email configurado em TPC 207");
        System.out.println("   Devem ter chegado 2 emails:");
        System.out.println("   1. Alerta de limite INFERIOR atingido");
        System.out.println("   2. Alerta de limite SUPERIOR atingido (bloqueio)");
    }

    /**
     * Envia um SMS usando o mÃ©todo real com verificaÃ§Ã£o de limites.
     */
    private void enviarSmsComLimites() {
        System.out.println("\nğŸ“¤ Enviando SMS com verificaÃ§Ã£o de limites...");
        
        try {
            int contadorAntes = smsHelper.getQuantidadeSmsNoMes(CSE_CODIGO);
            System.out.println("   Contador antes: " + contadorAntes);
            
            String mensagem = "Teste manual - " + new SimpleDateFormat("HH:mm:ss").format(new Date());
            smsHelper.send(TELEFONE_TESTE, mensagem, acessoSistema);
            
            int contadorDepois = smsHelper.getQuantidadeSmsNoMes(CSE_CODIGO);
            System.out.println("   âœ… SMS enviado com sucesso!");
            System.out.println("   ğŸ“Š Novo contador: " + contadorDepois);
            System.out.println("   ğŸ“± Verifique o celular: " + TELEFONE_TESTE);
            
        } catch (ZetraException e) {
            System.out.println("   ğŸš« " + e.getMessage());
        } catch (Exception e) {
            System.out.println("   âŒ ERRO: " + e.getMessage());
        }
    }

    /**
     * Envia um SMS diretamente sem verificaÃ§Ã£o de limites (teste bÃ¡sico).
     */
    private void enviarSmsDireto() {
        System.out.println("\nğŸ“¤ Enviando SMS diretamente (sem verificaÃ§Ã£o de limites)...");
        
        try {
            // Cria um AcessoSistema sem cseCodigo para bypassar a verificaÃ§Ã£o de limites
            AcessoSistema acessoSemCse = new AcessoSistema();
            acessoSemCse.setUsuCodigo("999");
            acessoSemCse.setUsuNome("Usuario Teste Direto");
            // NÃ£o seta tipoEntidade nem codigoEntidade
            
            String mensagem = "Teste direto - " + new SimpleDateFormat("HH:mm:ss").format(new Date());
            smsHelper.send(TELEFONE_TESTE, mensagem, acessoSemCse);
            
            System.out.println("   âœ… SMS enviado com sucesso!");
            System.out.println("   ğŸ“± Verifique o celular: " + TELEFONE_TESTE);
            
        } catch (Exception e) {
            System.out.println("   âŒ ERRO: " + e.getMessage());
        }
    }

    /**
     * Limpa os dados de teste (TDA 96, 97, 98, 99).
     */
    private void limparDadosTeste() {
        System.out.println("   ğŸ§¹ Limpando dados de teste...");
        
        try {
            deleteDadoAdicional(CSE_CODIGO, CodedValues.TDA_DATA_MES_ENVIO_SMS);
            deleteDadoAdicional(CSE_CODIGO, CodedValues.TDA_QTD_ENVIOS_SMS_MES);
            deleteDadoAdicional(CSE_CODIGO, CodedValues.TDA_ALERTA_LIMITE_INF_SMS);
            deleteDadoAdicional(CSE_CODIGO, CodedValues.TDA_ALERTA_LIMITE_SUP_SMS);
            
            System.out.println("   âœ… Dados limpos!");
            
        } catch (Exception e) {
            System.out.println("   âš ï¸ Erro ao limpar dados: " + e.getMessage());
        }
    }

    private DadosConsignante findDadoAdicional(String cseCodigo, String tdaCodigo) {
        try {
            DadosConsignanteId id = new DadosConsignanteId(cseCodigo, tdaCodigo);
            return DadosConsignanteHome.findByPrimaryKey(id);
        } catch (Exception e) {
            return null;
        }
    }

    private void deleteDadoAdicional(String cseCodigo, String tdaCodigo) {
        try {
            DadosConsignante dado = findDadoAdicional(cseCodigo, tdaCodigo);
            if (dado != null) {
                DadosConsignanteHome.delete(dado);
            }
        } catch (Exception e) {
            // Ignora se nÃ£o existir
        }
    }

    private void fecharSpringContext() {
        if (springContext != null) {
            System.out.println("\nğŸ”Œ Fechando contexto Spring...");
            springContext.close();
        }
    }
}
