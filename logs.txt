package com.zetra.econsig.debug;

import com.zetra.econsig.exception.ZetraException;
import com.zetra.econsig.helper.sms.SMSHelper;
import com.zetra.econsig.model.acesso.AcessoSistema;
import com.zetra.econsig.persistence.dao.AcessoSistemaDAO;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Profile;
import org.springframework.stereotype.Component;

@Component
@Profile("dev_mysql") // s칩 roda nesse profile
public class SmsFluxoCommandLineRunner implements CommandLineRunner {

    private final SMSHelper smsHelper;
    private final AcessoSistemaDAO acessoSistemaDAO;

    public SmsFluxoCommandLineRunner(
            SMSHelper smsHelper,
            AcessoSistemaDAO acessoSistemaDAO
    ) {
        this.smsHelper = smsHelper;
        this.acessoSistemaDAO = acessoSistemaDAO;
    }

    @Override
    public void run(String... args) throws Exception {

        System.out.println("===== INICIANDO TESTE ISOLADO DE SMS =====");

        // 游댳 Usu치rio REAL do banco
        Long usuCodigo = 111111L;   // ajuste se necess치rio

        AcessoSistema acesso = acessoSistemaDAO.buscarPorUsuario(usuCodigo);

        if (acesso == null) {
            throw new RuntimeException("AcessoSistema n칚o encontrado para usuCodigo=" + usuCodigo);
        }

        System.out.println("Usu치rio carregado:");
        System.out.println("usuCodigo = " + acesso.getUsuCodigo());
        System.out.println("cseCodigo = " + acesso.getCseCodigo());

        String telefone = "+55XXXXXXXXXXX"; // SEU telefone real
        String mensagem = "Teste de SMS - fluxo completo eConsig";

        try {
            smsHelper.send(
                    telefone,
                    mensagem,
                    acesso
            );
            System.out.println("SMS enviado com sucesso");
        } catch (ZetraException ex) {
            System.out.println("ZetraException capturada:");
            System.out.println(ex.getMessage());
        }

        System.out.println("===== FIM DO TESTE ISOLADO =====");
    }
}
